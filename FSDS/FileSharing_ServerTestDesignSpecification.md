| File Sharing                                             
                                                           
 Protocol Family                                           
                                                           
 Server Test Design Specification                          |
|----------------------------------------------------------|
| *Windows is built to be the most interoperable platform* |
| ![](./media/image1.png)                                  |

<span id="_Toc427488118" class="anchor"></span>

1.  Test Environment
    ================

    1.  Windows Test Environment
        ------------------------

Below environment topology is used to demonstrate how Windows uses MS-SMB2 protocol to access files which are hosted in remote shares. To simplify the environment, all objects are created under Hyper-V manager and use VMs instead of physical machines.

**Operating System Used**

| **Operating System**   | **Virtual Machines**            |
|------------------------|---------------------------------|
| Windows Server 2012 R2 | DC01, Node01, Node02, Storage01 |
| Windows 8.1            | Client01                        |

**Network Overview**

Partner Test Environment
------------------------

There are 2 options for partner to reuse above test environment:

-   Replace the whole cluster and the storage.

-   Replace only the storage in the cluster.

There are 2 parts to modify if only replace storage:

-   Replace the Storage01 using partner’s storage.

-   Replace the storage in ScaleoutFS and GeneralFS.

**Network Overview**

1.  Test Scope
    ==========

    1.  Test Target
        -----------

> This test suite will test the server endpoint of MS-FSRVP, MS-SMB2, MS-SWN, MS-RSVD, MS-DFSC, and test suite acts as client role.

Test Protocols
--------------

> This test suite includes test cases of following File Sharing protocols:

1.  MS-FSRVP

2.  MS-SMB2

3.  MS-SWN

4.  MS-RSVD

5.  MS-DFSC

    1.  Restrictions
        ------------

<!-- -->

1.  Named pipes and printer files are not tested.

2.  ServerStatistics is not tested.

    1.  Dependencies
        ------------

        1.  ### Transport

MS-FSRVP scenario VSSOperateShadowCopySet in test suite utilizes MS-RPCE SDK which uses SMB and SMB2 as transport. When test FSRVP server (i.e. test suite act as synthetic client), the underlying MS-RPCE SDK code on synthetic client side will first select SMB2 as transport to communicate with server, if the server side doesn’t implement/support SMB2 as transport, the client side will use SMB as transport to communicate with server.

Test Suite Design
=================

Test scenarios are categorized as below table and will be described in following sections.

| Category                 | Test Cases | Comments                                                                                                          |
|--------------------------|------------|-------------------------------------------------------------------------------------------------------------------|
| SMB2 BVT                 | 53         | SMB2 common scenarios.                                                                                            |
| SMB2 Feature Test        | 2548       | This test is divided by features.                                                                                 
                                                                                                                                                            
                                         It contains both Model-Based test cases and traditional cases.                                                     
                                                                                                                                                            
                                         The traditional cases are used to cover the statements which are not suitable to cover by Model-Based test cases.  
                                                                                                                                                            
                                         About Model-Based Testing, please see [Spec Explorer](http://msdn.microsoft.com/en-us/library/ee620411.aspx)       |
| SMB2 Feature Combination | 12         | Extended test with more complex message sequence for new features in SMB 3.0 dialect and later.                   |
| FSRVP Test               | 9          | Test for MS-FSRVP                                                                                                 |
| Server Failover Test     | 38         | Test server failover for MS-SMB2, MS-SWN and MS-FSRVP                                                             |
| RSVD Test                | 19         | Test for MS-RSVD                                                                                                  |
| DFSC Test                | 43         | Test for MS-DFSC                                                                                                  |

<span id="_Toc358294737" class="anchor"><span id="_Toc358299104" class="anchor"><span id="_Toc358294758" class="anchor"><span id="_Toc358299125" class="anchor"><span id="_Toc358294779" class="anchor"><span id="_Toc358299146" class="anchor"><span id="_Toc358294800" class="anchor"><span id="_Toc358299167" class="anchor"><span id="_Toc358294821" class="anchor"><span id="_Toc358299188" class="anchor"><span id="_Toc358294822" class="anchor"><span id="_Toc358299189" class="anchor"><span id="_Toc358294843" class="anchor"><span id="_Toc358299210" class="anchor"><span id="_Toc358294844" class="anchor"><span id="_Toc358299211" class="anchor"><span id="_Toc358294854" class="anchor"><span id="_Toc358299221" class="anchor"><span id="_Toc358294855" class="anchor"><span id="_Toc358299222" class="anchor"><span id="_Toc358294866" class="anchor"><span id="_Toc358299233" class="anchor"><span id="_Toc358294867" class="anchor"><span id="_Toc358299234" class="anchor"><span id="_Toc358294879" class="anchor"><span id="_Toc358299246" class="anchor"><span id="_Toc427488128" class="anchor"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>SMB2 BVT
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

> This is used to test SMB2 common user scenarios.

1.  ### SMB2Basic\_QueryDir\_WriteFlush\_ChangeNotify\_Read

    1.  #### Scenario

| **Description**               | This tests common query, write, flush, change-notify operations.                                                                                                       |
|-------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Message Sequence**          | **From client1 query information on an open of a directory then open the sub directory according to the queried info and register change notify on the sub directory** 
                                                                                                                                                                                                         
                                 NEGOTIATE                                                                                                                                                               
                                                                                                                                                                                                         
                                 ECHO                                                                                                                                                                    
                                                                                                                                                                                                         
                                 SESSION\_SETUP                                                                                                                                                          
                                                                                                                                                                                                         
                                 TREE\_CONNECT                                                                                                                                                           
                                                                                                                                                                                                         
                                 CREATE                                                                                                                                                                  
                                                                                                                                                                                                         
                                 QUERY\_DIRECTORY                                                                                                                                                        
                                                                                                                                                                                                         
                                 CLOSE                                                                                                                                                                   
                                                                                                                                                                                                         
                                 CREATE (Directory, e.g. *dir1* get from QUERY\_DIRECTORY response)                                                                                                      
                                                                                                                                                                                                         
                                 CHANGE\_NOTIFY (with SMB2\_WATCH\_TREE for Flags AND FILE\_NOTIFY\_CHANGE\_LAST\_WRITE for CompletionFilter)                                                            
                                                                                                                                                                                                         
                                 **From client2 create a new file in the sub directory where client1 registered change notify**                                                                          
                                                                                                                                                                                                         
                                 NEGOTIATE                                                                                                                                                               
                                                                                                                                                                                                         
                                 SESSION\_SETUP                                                                                                                                                          
                                                                                                                                                                                                         
                                 TREE\_CONNECT                                                                                                                                                           
                                                                                                                                                                                                         
                                 CREATE (File: new file in *dir1*)                                                                                                                                       
                                                                                                                                                                                                         
                                 WRITE                                                                                                                                                                   
                                                                                                                                                                                                         
                                 **From client1 to expect a CHANGE\_NOTIFY response then read what client2 wrote**                                                                                       
                                                                                                                                                                                                         
                                 Expect to receive CHANGE\_NOTIFY response                                                                                                                               
                                                                                                                                                                                                         
                                 CLOSE                                                                                                                                                                   
                                                                                                                                                                                                         
                                 CREATE(File: the new file created by client2 in dir1)                                                                                                                   
                                                                                                                                                                                                         
                                 READ                                                                                                                                                                    
                                                                                                                                                                                                         
                                 CLOSE                                                                                                                                                                   
                                                                                                                                                                                                         
                                 **From client2 requests to flush data**                                                                                                                                 
                                                                                                                                                                                                         
                                 FLUSH                                                                                                                                                                   
                                                                                                                                                                                                         
                                 CLOSE                                                                                                                                                                   
                                                                                                                                                                                                         
                                 TREE\_DISCONNECT                                                                                                                                                        
                                                                                                                                                                                                         
                                 LOGOFF                                                                                                                                                                  
                                                                                                                                                                                                         
                                 **From client1 open the new file created by client2**                                                                                                                   
                                                                                                                                                                                                         
                                 CREATE(File: the new file created by client2 in dir1)                                                                                                                   
                                                                                                                                                                                                         
                                 READ                                                                                                                                                                    
                                                                                                                                                                                                         
                                 CLOSE                                                                                                                                                                   
                                                                                                                                                                                                         
                                 TREE\_DISCONNECT                                                                                                                                                        
                                                                                                                                                                                                         
                                 LOGOFF                                                                                                                                                                  |
| **Cluster Involved Scenario** | **NO**                                                                                                                                                                 |

#### Test Case

|                          |                                                                                                                                                                    |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_SMB2Basic\_QueryDir\_WriteFlush\_ChangeNotify\_Read                                                                                                           |
| **Description **         | This test case is designed to test whether server can handle common QUERY, WRITE, FLUSH, CHANGE\_NOTIFY operations.                                                |
| **Prerequisites**        |                                                                                                                                                                    |
| **Test Execution Steps** | From client1 query information on an open of a directory then open the sub directory according to the queried info and register change notify on the sub directory 
                                                                                                                                                                                                
                            NEGOTIATE                                                                                                                                                           
                                                                                                                                                                                                
                            ECHO                                                                                                                                                                
                                                                                                                                                                                                
                            SESSION\_SETUP                                                                                                                                                      
                                                                                                                                                                                                
                            TREE\_CONNECT                                                                                                                                                       
                                                                                                                                                                                                
                            CREATE                                                                                                                                                              
                                                                                                                                                                                                
                            QUERY\_DIRECTORY                                                                                                                                                    
                                                                                                                                                                                                
                            CLOSE                                                                                                                                                               
                                                                                                                                                                                                
                            CREATE (Directory, e.g. dir1 get from QUERY\_DIRECTORY response)                                                                                                    
                                                                                                                                                                                                
                            CHANGE\_NOTIFY (with SMB2\_WATCH\_TREE for Flags AND FILE\_NOTIFY\_CHANGE\_LAST\_WRITE for CompletionFilter)                                                        
                                                                                                                                                                                                
                            From client2 create a new file in the sub directory where client1 registered change notify                                                                          
                                                                                                                                                                                                
                            NEGOTIATE                                                                                                                                                           
                                                                                                                                                                                                
                            SESSION\_SETUP                                                                                                                                                      
                                                                                                                                                                                                
                            TREE\_CONNECT                                                                                                                                                       
                                                                                                                                                                                                
                            CREATE (File: new file in dir1)                                                                                                                                     
                                                                                                                                                                                                
                            WRITE                                                                                                                                                               
                                                                                                                                                                                                
                            FLUSH                                                                                                                                                               
                                                                                                                                                                                                
                            From client1 to expect a CHANGE\_NOTIFY response                                                                                                                    
                                                                                                                                                                                                
                            Expect to receive CHANGE\_NOTIFY response                                                                                                                           
                                                                                                                                                                                                
                            CLOSE                                                                                                                                                               
                                                                                                                                                                                                
                            From client2 close the new created file                                                                                                                             
                                                                                                                                                                                                
                            CLOSE                                                                                                                                                               
                                                                                                                                                                                                
                            TREE\_DISCONNECT                                                                                                                                                    
                                                                                                                                                                                                
                            LOGOFF                                                                                                                                                              
                                                                                                                                                                                                
                            From client1 open the new file created by client2                                                                                                                   
                                                                                                                                                                                                
                            CREATE(File: the new file created by client2 in dir1)                                                                                                               
                                                                                                                                                                                                
                            READ                                                                                                                                                                
                                                                                                                                                                                                
                            CLOSE                                                                                                                                                               
                                                                                                                                                                                                
                            TREE\_DISCONNECT                                                                                                                                                    
                                                                                                                                                                                                
                            LOGOFF                                                                                                                                                              |
| **Cleanup**              |                                                                                                                                                                    |

1.  ### SMB2Basic\_CanncelRegisteredChangeNotify

    1.  #### Scenario

| **Description**               | Verify that CANCEL request cancels CHANGE\_NOTIFY request when there’s no CHANGE\_NOTIFY response from server                       |
|-------------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| **Message Sequence**          | 1.  Start a client to create a file by sending the following requests: 1. NEGOTIATE; 2. SESSION\_SETUP; 3. TREE\_CONNECT; 4. CREATE 
                                                                                                                                                                      
                                 2.  Client starts to register CHANGE\_NOTIFY on directory.                                                                           
                                                                                                                                                                      
                                 3.  Client starts to cancel the registered CHANGE\_NOTIFY on directory.                                                              
                                                                                                                                                                      
                                 4.  Tear down the client by sending the following requests: 1. CLOSE; 2. TREE\_DISCONNECT; 3. LOG\_OFF                               |
| **Cluster Involved Scenario** | **NO**                                                                                                                              |

#### Test Case

|                          |                                                                                                                                              |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_SMB2Basic\_CancelRegisteredChangeNotify                                                                                                 |
| **Description **         | This test case is designed to verify that CANCEL request cancels CHANGE\_NOTIFY request when there's no CHANGE\_NOTIFY response from server. |
| **Prerequisites**        |                                                                                                                                              |
| **Test Execution Steps** | NEGOTIATE                                                                                                                                    
                                                                                                                                                                          
                            SESSION\_SETUP                                                                                                                                
                                                                                                                                                                          
                            TREE\_CONNECT                                                                                                                                 
                                                                                                                                                                          
                            CREATE (Directory)                                                                                                                            
                                                                                                                                                                          
                            CHANGE\_NOTIFY (FILE\_NOTIFY\_CHANGE\_LAST\_WRITE for CompletionFilter)                                                                       
                                                                                                                                                                          
                            CANCEL                                                                                                                                        
                                                                                                                                                                          
                            Expect STATUS\_CANCELLED in CHANGE\_NOTIFY response                                                                                           
                                                                                                                                                                          
                            CLOSE                                                                                                                                         
                                                                                                                                                                          
                            TREE\_DISCONNECT                                                                                                                              
                                                                                                                                                                          
                            LOGOFF                                                                                                                                        |
| **Cleanup**              |                                                                                                                                              |

1.  ### SMB2Basic\_QueryAndSet\_FileInfo

    1.  #### Scenario

| **Description**               | Query and set the info for a file                                                                             |
|-------------------------------|---------------------------------------------------------------------------------------------------------------|
| **Message Sequence**          | 1.  Starts a client by sending the following requests: 1. NEGOTIATE; 2. SESSION\_SETUP; 3. TREE\_CONNECT.     
                                                                                                                                                
                                 2.  Client sends CREATE request with desired access set to CENERIC\_READ and CENERIC\_WRITE to create a file.  
                                                                                                                                                
                                 3.  Client sends QUERY\_INFO request to query file attributes.                                                 
                                                                                                                                                
                                 4.  Convert file basic information                                                                             
                                                                                                                                                
                                 5.  Client sends SetFileAttributes request to set LastAccessTime for the file                                  
                                                                                                                                                
                                 6.  Client sends QUERY request to query file attributes.                                                       
                                                                                                                                                
                                 7.  Convert lastAccessTime in QUERY\_INFO response after SET\_INFO.                                            
                                                                                                                                                
                                 8.  Tear down the client by sending the following requests: 1. CLOSE; 2. TREE\_DISCONNECT; 3. LOG\_OFF"        |
| **Cluster Involved Scenario** | NO                                                                                                            |

#### Test Case

|                          |                                                                                                                            |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_SMB2Basic\_QueryAndSet\_FileInfo                                                                                      |
| **Description **         | Query and set the info for a file                                                                                          |
| **Prerequisites**        |                                                                                                                            |
| **Test Execution Steps** | NEGOTIATE                                                                                                                  
                                                                                                                                                        
                            SESSION\_SETUP                                                                                                              
                                                                                                                                                        
                            TREE\_CONNECT                                                                                                               
                                                                                                                                                        
                            CREATE (File, with desired access GENERIC\_WRITE and GENERIC\_READ)                                                         
                                                                                                                                                        
                            Parse FileBasicInformation from CREATE response                                                                             
                                                                                                                                                        
                            QUERY\_INFO (with SMB2\_0\_INFO\_FILE for InfoType and FileBasicInformation for FileInfoClass)                              
                                                                                                                                                        
                            SET\_INFO (with SMB2\_0\_INFO\_FILE for InfoType and FileBasicInformation.LastAccessTime)                                   
                                                                                                                                                        
                            QUERY\_INFO (with SMB2\_0\_INFO\_FILE for InfoType and FileBasicInformation for FileInfoClass) to verify if set info works  
                                                                                                                                                        
                            CLOSE                                                                                                                       
                                                                                                                                                        
                            TREE\_DISCONNECT                                                                                                            
                                                                                                                                                        
                            LOGOFF                                                                                                                      |
| **Cleanup**              |                                                                                                                            |

1.  ### SMB2Basic\_LockAndUnLock

    1.  #### Scenario

| **Description**               | This test case is designed to test whether server can handle WRITE of locking content correctly. |
|-------------------------------|--------------------------------------------------------------------------------------------------|
| **Message Sequence**          | **From client1 open a file and lock a specific range**                                           
                                                                                                                                   
                                 NEGOTIATE                                                                                         
                                                                                                                                   
                                 SESSION\_SETUP                                                                                    
                                                                                                                                   
                                 TREE\_CONNECT                                                                                     
                                                                                                                                   
                                 CREATE (File)                                                                                     
                                                                                                                                   
                                 LOCK (with SMB2\_LOCKFLAG\_SHARED\_LOCK in SMB2\_LOCK\_ELEMENT)                                   
                                                                                                                                   
                                 WRITE                                                                                             
                                                                                                                                   
                                 **From client2 open the same file and try to read and write the locking range**                   
                                                                                                                                   
                                 NEGOTIATE                                                                                         
                                                                                                                                   
                                 SESSION\_SETUP                                                                                    
                                                                                                                                   
                                 TREE\_CONNECT                                                                                     
                                                                                                                                   
                                 CREATE (File)                                                                                     
                                                                                                                                   
                                 READ (the locking range, expect success)                                                          
                                                                                                                                   
                                 WRITE (the locking range, expect fail)                                                            
                                                                                                                                   
                                 **From client1 unlock the range**                                                                 
                                                                                                                                   
                                 LOCK (with SMB2\_LOCKFLAG\_UNLOCK in SMB2\_LOCK\_ELEMENT)                                         
                                 CLOSE                                                                                             
                                                                                                                                   
                                 TREE\_DISCONNECT                                                                                  
                                                                                                                                   
                                 LOGOFF                                                                                            
                                                                                                                                   
                                 **From client2 try to write the range**                                                           
                                                                                                                                   
                                 WRITE (the locking range, expect success)                                                         
                                                                                                                                   
                                 CLOSE                                                                                             
                                                                                                                                   
                                 TREE\_DISCONNECT                                                                                  
                                                                                                                                   
                                 LOGOFF                                                                                            |
| **Cluster Involved Scenario** | **NO**                                                                                           |

#### Test Case

|                          |                                                                                       |
|--------------------------|---------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_SMB2Basic\_LockAndUnLock                                                         |
| **Description **         | Verify locking range could not be written and after unlock the range could be written |
| **Prerequisites**        |                                                                                       |
| **Test Execution Steps** | **From client1 open a file and lock a specific range**                                
                                                                                                                   
                            NEGOTIATE                                                                              
                                                                                                                   
                            SESSION\_SETUP                                                                         
                                                                                                                   
                            TREE\_CONNECT                                                                          
                                                                                                                   
                            CREATE (File)                                                                          
                                                                                                                   
                            LOCK (with SMB2\_LOCKFLAG\_SHARED\_LOCK in SMB2\_LOCK\_ELEMENT)                        
                                                                                                                   
                            WRITE                                                                                  
                                                                                                                   
                            **From client2 open the same file and try to read and write the locking range**        
                                                                                                                   
                            NEGOTIATE                                                                              
                                                                                                                   
                            SESSION\_SETUP                                                                         
                                                                                                                   
                            TREE\_CONNECT                                                                          
                                                                                                                   
                            CREATE (File)                                                                          
                                                                                                                   
                            READ (the locking range, expect success)                                               
                                                                                                                   
                            WRITE (the locking range, expect fail)                                                 
                                                                                                                   
                            **From client1 unlock the range**                                                      
                                                                                                                   
                            LOCK (with SMB2\_LOCKFLAG\_UNLOCK in SMB2\_LOCK\_ELEMENT)                              
                            CLOSE                                                                                  
                                                                                                                   
                            TREE\_DISCONNECT                                                                       
                                                                                                                   
                            LOGOFF                                                                                 
                                                                                                                   
                            **From client2 try to write the range**                                                
                                                                                                                   
                            WRITE (the locking range, expect success)                                              
                                                                                                                   
                            CLOSE                                                                                  
                                                                                                                   
                            TREE\_DISCONNECT                                                                       
                                                                                                                   
                            LOGOFF                                                                                 |
| **Cleanup**              |                                                                                       |

1.  ### MultiCredit

    1.  #### Scenario

| **Description**               | Send request which consume more than 1 credit              |
|-------------------------------|------------------------------------------------------------|
| **Message Sequence**          | NEGOTIATE                                                  
                                                                                             
                                 SESSION\_SETUP                                              
                                                                                             
                                 TREE\_CONNECT                                               
                                                                                             
                                 CREATE (File and request multiple credit at the same time)  
                                                                                             
                                 Send request which consumes more than 1 credit              
                                                                                             
                                 CLOSE                                                       
                                                                                             
                                 TREE\_DISCONNECT                                            
                                                                                             
                                 LOGOFF                                                      |
| **Cluster Involved Scenario** | NO                                                         |

#### Test Case

|                          |                                                                                                               |
|--------------------------|---------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_MultiCredit\_OneRequestWithMultiCredit                                                                   |
| **Description **         | This test case is designed to test whether server can handle one request which consumes more than one credit. |
| **Prerequisites**        |                                                                                                               |
| **Test Execution Steps** | NEGOTIATE                                                                                                     
                                                                                                                                           
                            SESSION\_SETUP                                                                                                 
                                                                                                                                           
                            TREE\_CONNECT                                                                                                  
                                                                                                                                           
                            CREATE (File and request multiple credit at the same time)                                                     
                                                                                                                                           
                            WRITE request which consumes more than 1 credits                                                               
                                                                                                                                           
                            READ request which consumes more than 1 credits                                                                
                                                                                                                                           
                            CLOSE                                                                                                          
                                                                                                                                           
                            TREE\_DISCONNECT                                                                                               
                                                                                                                                           
                            LOGOFF                                                                                                         |
| **Cleanup**              |                                                                                                               |

1.  ### <span id="_Negotiation" class="anchor"><span id="_Toc427488134" class="anchor"></span></span>Negotiation

    1.  #### Scenario

|                               |                                                                   |
|-------------------------------|-------------------------------------------------------------------|
| **Description**               | SMB 3 protocol negotiation, this is non-cluster involved scenario |
| **Message Sequence**          | SMB\_COM\_NEGOTIATE (Optional)                                    
                                                                                                    
                                 NEGOTIATE                                                          |
| **Cluster Involved Scenario** | NO                                                                |

#### Test Case

|                          |                                                                                                    |
|--------------------------|----------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Negotiate\_Compatible\_Wildcard                                                               |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Smb2 dialect wildcard. |
| **Prerequisites**        |                                                                                                    |
| **Test Execution Steps** | 1.  Client sends SMB\_COM\_NEGOTIATE containing SMB2.??? Dialect and SMB2.002                      
                                                                                                                                
                            2.  Server returns SMB2 NEGOTIATE response with SMB2.FF dialect                                     
                                                                                                                                
                            3.  Client sends SMB2 NEGOTIATE request containing SMB2.002, SMB2.1, SMB3 dialects                  
                                                                                                                                
                            4.  Server returns SMB2 NEGOTIATE response with SMB3 dialect                                        |
| **Cleanup**              |                                                                                                    |

|                          |                                                                  |
|--------------------------|------------------------------------------------------------------|
| **Test ID**              | BVT\_Negotiate\_Compatible\_2002                                 |
| **Description **         | Ensure server could handle compatible negotiate                  |
| **Prerequisites**        |                                                                  |
| **Test Execution Steps** | 1.  Client sends SMB\_COM\_NEGOTIATE containing SMB2.002         
                                                                                              
                            2.  Server returns SMB2 NEGOTIATE response with SMB2.002 dialect  |
| **Cleanup**              |                                                                  |

|                          |                                                                                                |
|--------------------------|------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Negotiate\_SMB2002                                                                        |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Smb 2.002 dialect. |
| **Prerequisites**        |                                                                                                |
| **Test Execution Steps** | 1.  Client sends SMB2 NEGOTIATE containing SMB2.002                                            
                                                                                                                            
                            2.  Server returns SMB2 NEGOTIATE response with SMB2.002 dialect                                |
| **Cleanup**              |                                                                                                |

|                          |                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Negotiate\_SMB21                                                                            |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Smb 2.1 dialect.     |
| **Prerequisites**        |                                                                                                  |
| **Test Execution Steps** | 1.  Client sends SMB2 NEGOTIATE containing SMB2.002 and SMB2.1                                   
                                                                                                                              
                            2.  Server returns SMB2 NEGOTIATE response with the max common dialect client and server support  |
| **Cleanup**              |                                                                                                  |

|                          |                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Negotiate\_SMB30                                                                            |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Smb 3.0 dialect.     |
| **Prerequisites**        |                                                                                                  |
| **Test Execution Steps** | 1.  Client sends SMB2 NEGOTIATE containing SMB2.002, SMB2.1 and SMB3.0                           
                                                                                                                              
                            2.  Server returns SMB2 NEGOTIATE response with the max common dialect client and server support  |
| **Cleanup**              |                                                                                                  |

|                          |                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Negotiate\_SMB302                                                                           |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Smb 3.02 dialect.    |
| **Prerequisites**        |                                                                                                  |
| **Test Execution Steps** | 1.  Client sends SMB2 NEGOTIATE containing SMB2.002, SMB2.1, SMB3.0 and SMB3.02                  
                                                                                                                              
                            2.  Server returns SMB2 NEGOTIATE response with the max common dialect client and server support  |
| **Cleanup**              |                                                                                                  |

|                          |                                                                                                    |
|--------------------------|----------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Negotiate\_SigningEnabled                                                                     |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Signing Enabled.       |
| **Prerequisites**        |                                                                                                    |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request containing SMB2.002, SMB2.1, SMB3 dialects with signing enabled 
                                                                                                                                
                            2.  Server returns NEGOTIATE response with SMB3 dialect                                             |
| **Cleanup**              |                                                                                                    |

|                          |                                                                                                                                                                            |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Negotiate\_SMB311                                                                                                                                                     |
| **Description **         | This test case is designed to test whether server (including the server doesn't implement dialect 3.11) can handle NEGOTIATE with Smb 3.11 dialect and Negotiate Contexts. |
| **Prerequisites**        |                                                                                                                                                                            |
| **Test Execution Steps** | 1.  Client send Negotiate request with dialect SMB 3.11, SMB2\_PREAUTH\_INTEGRITY\_CAPABILITIES context and SMB2\_ENCRYPTION\_CAPABILITIES context.                        
                                                                                                                                                                                                        
                            2.  Server returns correct SMB2 NEGOTIATE response according to their supported dialect.                                                                                    |
| **Cleanup**              |                                                                                                                                                                            |

|                          |                                                                                                                                                       |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Negotiate\_SMB311\_Preauthentication                                                                                                             |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Smb 3.11 dialect and SMB2\_PREAUTH\_INTEGRITY\_CAPABILITIES context only. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                                   |
| **Test Execution Steps** | 1.  Client send Negotiate request with dialect SMB 3.11, SMB2\_PREAUTH\_INTEGRITY\_CAPABILITIES context.                                              
                                                                                                                                                                                   
                            2.  Server returns SMB2 NEGOTIATE response with dialect 3.11 and the correct SMB2\_PREAUTH\_INTEGRITY\_CAPABILITIES context.                           |
| **Cleanup**              |                                                                                                                                                       |

|                          |                                                                                                                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Negotiate\_SMB311\_Preauthentication\_Encryption\_CCM                                                                                                                                                             |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Smb 3.11 dialect and SMB2\_PREAUTH\_INTEGRITY\_CAPABILITIES context and SMB2\_ENCRYPTION\_CAPABILITIES context with AES-128-CCM preferred. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                                                                                                    |
| **Test Execution Steps** | 1.  Client send Negotiate request with dialect SMB 3.11, SMB2\_PREAUTH\_INTEGRITY\_CAPABILITIES context and SMB2\_ENCRYPTION\_CAPABILITIES context with AES-128-CCM preferred.                                         
                                                                                                                                                                                                                                                    
                            2.  Server returns SMB2 NEGOTIATE response with dialect 3.11 and the correct Ciphers in SMB2\_ENCRYPTION\_CAPABILITIES context.                                                                                         |
| **Cleanup**              |                                                                                                                                                                                                                        |

|                          |                                                                                                                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Negotiate\_SMB311\_Preauthentication\_Encryption\_GCM                                                                                                                                                             |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Smb 3.11 dialect and SMB2\_PREAUTH\_INTEGRITY\_CAPABILITIES context and SMB2\_ENCRYPTION\_CAPABILITIES context with AES-128-GCM preferred. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                                                                                                    |
| **Test Execution Steps** | 1.  Client send Negotiate request with dialect SMB 3.11, SMB2\_PREAUTH\_INTEGRITY\_CAPABILITIES context and SMB2\_ENCRYPTION\_CAPABILITIES context with AES-128-GCM preferred.                                         
                                                                                                                                                                                                                                                    
                            2.  Server returns SMB2 NEGOTIATE response with dialect 3.11 and the correct Ciphers in SMB2\_ENCRYPTION\_CAPABILITIES context.                                                                                         |
| **Cleanup**              |                                                                                                                                                                                                                        |

1.  ### MultipleChannel

    1.  #### Scenario

|                               |                                                |
|-------------------------------|------------------------------------------------|
| **Description**               | Bind session to multiple connections           |
| **Message Sequence**          | **Create main channel**                        
                                                                                 
                                 NEGOTIATE                                       
                                                                                 
                                 SESSION\_SETUP                                  
                                                                                 
                                 TREE\_CONNECT (IPC$)                            
                                                                                 
                                 IOCTL (FSCTL\_QUERY\_NETWORK\_INTERFACE\_INFO)  
                                                                                 
                                 TREE\_CONNECT                                   
                                                                                 
                                 CREATE                                          
                                                                                 
                                 WRITE                                           
                                                                                 
                                 **Create alterative channel**                   
                                                                                 
                                 NEGOTIATE                                       
                                                                                 
                                 SESSION\_SETUP (SMB2\_SESSION\_FLAG\_BINDING)   
                                                                                 
                                 READ                                            
                                                                                 
                                 CLOSE                                           
                                                                                 
                                 TREE\_DISCONNECT                                
                                                                                 
                                 LOGOFF                                          |
| **Cluster Involved Scenario** | **NO**                                         |

#### Test Case

|                          |                                                                                                                                     |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_MultipleChannel\_NicRedundantOnBoth                                                                                            |
| **Description **         | This test case is designed to test the basic functionality of Multiple Channel, assuming that both client and server have two NICs. |
| **Prerequisites**        |                                                                                                                                     |
| **Test Execution Steps** | SETUP\_CONNECTION from client NIC\_1 to SUT NIC\_1                                                                                  
                                                                                                                                                                 
                            NEGOTIATE                                                                                                                            
                                                                                                                                                                 
                            SESSION\_SETUP                                                                                                                       
                                                                                                                                                                 
                            TREE\_CONNECT                                                                                                                        
                                                                                                                                                                 
                            CREATE                                                                                                                               
                                                                                                                                                                 
                            WRITE                                                                                                                                
                                                                                                                                                                 
                            SETUP\_CONNECTION from client NIC\_2 to SUT NIC\_2                                                                                   
                                                                                                                                                                 
                            NEGOTIATE                                                                                                                            
                                                                                                                                                                 
                            SESSION\_SETUP binding to the previous one                                                                                           
                                                                                                                                                                 
                            TREE\_CONNECT                                                                                                                        
                                                                                                                                                                 
                            CREATE                                                                                                                               
                                                                                                                                                                 
                            READ                                                                                                                                 
                                                                                                                                                                 
                            Verify WRITE and READ data should be identical                                                                                       |
| **Cleanup**              |                                                                                                                                     |

1.  ### CopyOffLoad

    1.  #### Scenario

|                               |                                                           |
|-------------------------------|-----------------------------------------------------------|
| **Description**               | Offload the copy operation to intelligent storage devices |
| **Message Sequence**          | NEGOTIATE                                                 
                                                                                            
                                 SESSION\_SETUP                                             
                                                                                            
                                 TREE\_CONNECT                                              
                                                                                            
                                 CREATE                                                     
                                                                                            
                                 IOCtl with FSCTL\_OFFLOAD\_READ                            
                                                                                            
                                 IOCtl with FSCTL\_OFFLOAD\_WRITE                           
                                                                                            
                                 READ                                                       
                                                                                            
                                 CLOSE                                                      
                                                                                            
                                 TREE\_DISCONNECT                                           
                                                                                            
                                 LOGOFF                                                     |
| **Cluster Involved Scenario** | NO                                                        |

#### Test Case

|                          |                                                                                                                               |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_CopyOffload                                                                                                              |
| **Description **         | This test case is designed to test whether server can handle offload copy correctly when copy content between two files.      |
| **Prerequisites**        |                                                                                                                               |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request                                                                                            
                                                                                                                                                           
                            2.  Server sends NEGOTIATE response                                                                                            
                                                                                                                                                           
                            3.  Client sends SESSION\_SETUP request                                                                                        
                                                                                                                                                           
                            4.  Server sends SESSION\_SETUP response                                                                                       
                                                                                                                                                           
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed                           
                                                                                                                                                           
                            6.  Client sends TREE\_CONNECT request                                                                                         
                                                                                                                                                           
                            7.  Server sends TREE\_CONNECT response                                                                                        
                                                                                                                                                           
                            8.  Client sends CREATE request to create a test file as source of offload copy.                                               
                                                                                                                                                           
                            9.  Server sends CREATE response                                                                                               
                                                                                                                                                           
                            10. Client sends WRITE request to prepare content test file.                                                                   
                                                                                                                                                           
                            11. Server sends WRITE response.                                                                                               
                                                                                                                                                           
                            12. Client sends FLUSH request to make sure the content is written to backend storage.                                         
                                                                                                                                                           
                            13. Server sends FLUSH response.                                                                                               
                                                                                                                                                           
                            14. Client sends IOCTL request with FSCTL\_OFFLOAD\_READ to ask server to generate the token of the content for offload copy.  
                                                                                                                                                           
                            15. Server sends IOCTL response                                                                                                
                                                                                                                                                           
                            16. Client sends CREATE request to create another file as destination of offload copy.                                         
                                                                                                                                                           
                            17. Server sends CREATE response.                                                                                              
                                                                                                                                                           
                            18. Client sends IOCTL request with FSCTL\_OFFLOAD\_WRITE to ask server to copy the content from source to destination.        
                                                                                                                                                           
                            19. Server sends IOCTL response                                                                                                
                                                                                                                                                           
                            20. Client sends READ request                                                                                                  
                                                                                                                                                           
                            21. Server sends READ response                                                                                                 
                                                                                                                                                           
                            22. Compare the read content is identical to written content.                                                                  
                                                                                                                                                           
                            23. Client sends CLOSE request                                                                                                 
                                                                                                                                                           
                            24. Server sends CLOSE response                                                                                                
                                                                                                                                                           
                            25. Client sends TREE\_DISCONNECT request                                                                                      
                                                                                                                                                           
                            26. Server sends TREE\_DISCONNECT response                                                                                     
                                                                                                                                                           
                            27. Client sends LOGOFF request                                                                                                
                                                                                                                                                           
                            28. Server sends LOGOFF response                                                                                               |
| **Cleanup**              |                                                                                                                               |

1.  ### FileLevelTrim

    1.  #### Scenario

| **Description**               | Trim a range of a file, then read that range again |
|-------------------------------|----------------------------------------------------|
| **Message Sequence**          | NEGOTIATE                                          
                                                                                     
                                 SESSION\_SETUP                                      
                                                                                     
                                 TREE\_CONNECT                                       
                                                                                     
                                 CREATE                                              
                                                                                     
                                 WRITE                                               
                                                                                     
                                 CREATE                                              
                                                                                     
                                 IOCTL (with FSCTL\_FILE\_LEVEL\_TRIM)               
                                                                                     
                                 CREATE                                              
                                                                                     
                                 READ                                                
                                                                                     
                                 CLOSE                                               
                                                                                     
                                 TREE\_DISCONNECT                                    
                                                                                     
                                 LOGOFF                                              |
| **Cluster Involved Scenario** | NO                                                 |

#### Test Case

|                          |                                                                                     |
|--------------------------|-------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_FileLevelTrim                                                                  |
| **Description **         | This test case is designed to test basic functionality of FSCTL\_FILE\_LEVEL\_TRIM. |
| **Prerequisites**        |                                                                                     |
| **Test Execution Steps** | NEGOTIATE                                                                           
                                                                                                                 
                            SESSION\_SETUP                                                                       
                                                                                                                 
                            TREE\_CONNECT                                                                        
                                                                                                                 
                            CREATE                                                                               
                                                                                                                 
                            WRITE                                                                                
                                                                                                                 
                            CREATE                                                                               
                                                                                                                 
                            IOCTL (with FSCTL\_FILE\_LEVEL\_TRIM)                                                
                                                                                                                 
                            CREATE                                                                               
                                                                                                                 
                            READ                                                                                 
                                                                                                                 
                            CLOSE                                                                                
                                                                                                                 
                            TREE\_DISCONNECT                                                                     
                                                                                                                 
                            LOGOFF                                                                               |
| **Cleanup**              |                                                                                     |

1.  ### IntegrityInfo

    1.  #### Scenario

| **Description**               | Underlying ReFS format is required              |
|-------------------------------|-------------------------------------------------|
| **Message Sequence**          | NEGOTIATE                                       
                                                                                  
                                 SESSION\_SETUP                                   
                                                                                  
                                 TREE\_CONNECT                                    
                                                                                  
                                 CREATE (File)                                    
                                                                                  
                                 IOCTL (with FSCTL\_GET\_INTEGRITY\_INFORMATION)  
                                                                                  
                                 IOCTL (with FSCTL\_SET\_INTEGRITY\_INFORMATION)  
                                                                                  
                                 IOCTL (with FSCTL\_GET\_INTEGRITY\_INFORMATION)  
                                                                                  
                                 CLOSE                                            
                                                                                  
                                 TREE\_DISCONNECT                                 
                                                                                  
                                 LOGOFF                                           |
| **Cluster Involved Scenario** | NO                                              |

#### Test Case

|                          |                                                                                                                                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_SetGetIntegrityInfo                                                                                                                                                                             |
| **Description **         | This test case is designed to test whether server can handle IOCTL FSCTL\_GET\_INTEGRITY\_INFORMATION and FSCTL\_SET\_INTEGRITY\_INFORMATION.                                                        |
| **Prerequisites**        |                                                                                                                                                                                                      |
| **Test Execution Steps** | 1.  Client creates a file by sending the following requests: 1. NEGOTIATE; 2. SESSION\_SETUP; 3. TREE\_CONNECT; 4. CREATE                                                                            
                                                                                                                                                                                                                                  
                            2.  Client sends IOCTL request with FSCTL\_GET\_INTEGRITY\_INFORMATION.                                                                                                                               
                                                                                                                                                                                                                                  
                            3.  Client sends IOCTL request with FSCTL\_SET\_INTEGRITY\_INFORMATION after changed the value of the following fields in FSCTL\_SET\_INTEGRIY\_INFO\_INPUT: ChecksumAlgorithm, Flags, and Reserved.  
                                                                                                                                                                                                                                  
                            4.  Client sends IOCTL request with FSCTL\_GET\_INTEGRITY\_INFORMATION.                                                                                                                               
                                                                                                                                                                                                                                  
                            5.  Tear down the client by sending the following requests: 1. CLOSE; 2. TREE\_DISCONNECT; 3. LOG\_OFF                                                                                                |
| **Cleanup**              |                                                                                                                                                                                                      |

1.  ### <span id="_DirectoryLeasing" class="anchor"><span id="_Toc427488139" class="anchor"></span></span>DirectoryLeasing

    1.  #### Basic

        1.  ##### Scenario

|                               |                                                           |
|-------------------------------|-----------------------------------------------------------|
| **Description**               | Obtain lease for directory (with lease request v2)        |
| **Message Sequence**          | NEGOTIATE                                                 
                                                                                            
                                 SESSION\_SETUP                                             
                                                                                            
                                 TREE\_CONNECT                                              
                                                                                            
                                 CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2)  
                                                                                            
                                 LEASE\_BREAK                                               
                                                                                            
                                 CLOSE                                                      
                                                                                            
                                 TREE\_DISCONNECT                                           
                                                                                            
                                 LOGOFF                                                     |
| **Cluster Involved Scenario** | NO                                                        |

##### Test Case

|                          |                                                                                                                                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_DirectoryLeasing\_ReadWriteHandleCaching                                                                                                                                                        |
| **Description **         | This test case is designed to test whether server can handle READ|WRITE|HANDLE leasing on a directory correctly.                                                                                     |
| **Prerequisites**        |                                                                                                                                                                                                      |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request                                                                                                                                                                   
                                                                                                                                                                                                                                  
                            2.  Server sends NEGOTIATE response                                                                                                                                                                   
                                                                                                                                                                                                                                  
                            3.  Client sends SESSION\_SETUP request                                                                                                                                                               
                                                                                                                                                                                                                                  
                            4.  Server sends SESSION\_SETUP response                                                                                                                                                              
                                                                                                                                                                                                                                  
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed                                                                                                  
                                                                                                                                                                                                                                  
                            6.  Client sends TREE\_CONNECT request                                                                                                                                                                
                                                                                                                                                                                                                                  
                            7.  Server sends TREE\_CONNECT response                                                                                                                                                               
                                                                                                                                                                                                                                  
                            8.  Client sends CREATE request for a directory with SMB2\_CREATE\_REQUEST\_LEASE\_V2, LeaseState setting to SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_WRITE\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING  
                                                                                                                                                                                                                                  
                            9.  Server sends CREATE response                                                                                                                                                                      
                                                                                                                                                                                                                                  
                            10. Server sends LEASE\_BREAK notification                                                                                                                                                            
                                                                                                                                                                                                                                  
                            11. Client sends LEASE\_BREAK acknowledgement                                                                                                                                                         
                                                                                                                                                                                                                                  
                            12. Server sends LEASE\_BREAK response                                                                                                                                                                
                                                                                                                                                                                                                                  
                            13. Client sends CLOSE request                                                                                                                                                                        
                                                                                                                                                                                                                                  
                            14. Server sends CLOSE response                                                                                                                                                                       
                                                                                                                                                                                                                                  
                            15. Client sends TREE\_DISCONNECT request                                                                                                                                                             
                                                                                                                                                                                                                                  
                            16. Server sends TREE\_DISCONNECT response                                                                                                                                                            
                                                                                                                                                                                                                                  
                            17. Client sends LOGOFF request                                                                                                                                                                       
                                                                                                                                                                                                                                  
                            18. Server sends LOGOFF response                                                                                                                                                                      |
| **Cleanup**              |                                                                                                                                                                                                      |

1.  #### DirectoryLeasing\_LeaseBreakOnMultiClients

    1.  ##### Scenario

| **Description**               | This tests lease break notification when multiple clients request caching lease                                                     |
|-------------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| **Message Sequence**          | **From client1**                                                                                                                    
                                                                                                                                                                      
                                 NEGOTIATE                                                                                                                            
                                                                                                                                                                      
                                 SESSION\_SETUP                                                                                                                       
                                                                                                                                                                      
                                 TREE\_CONNECT                                                                                                                        
                                                                                                                                                                      
                                 CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING)  
                                                                                                                                                                      
                                 **From client2 to access same directory to trigger leasing break**                                                                   
                                                                                                                                                                      
                                 NEGOTIATE                                                                                                                            
                                                                                                                                                                      
                                 SESSION\_SETUP                                                                                                                       
                                                                                                                                                                      
                                 TREE\_CONNECT                                                                                                                        
                                                                                                                                                                      
                                 CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING)  
                                                                                                                                                                      
                                 **From client3 to access same directory to trigger leasing break**                                                                   
                                                                                                                                                                      
                                 NEGOTIATE                                                                                                                            
                                                                                                                                                                      
                                 SESSION\_SETUP                                                                                                                       
                                                                                                                                                                      
                                 TREE\_CONNECT                                                                                                                        
                                                                                                                                                                      
                                 CREATE (with DELETE)                                                                                                                 
                                                                                                                                                                      
                                 **From client1 and client2**                                                                                                         
                                                                                                                                                                      
                                 Receive LEASE\_BREAK                                                                                                                 
                                                                                                                                                                      
                                 Send LEASE\_BREAK\_ACK                                                                                                               
                                                                                                                                                                      
                                 CLOSE                                                                                                                                
                                                                                                                                                                      
                                 TREE\_DISCONNECT                                                                                                                     
                                                                                                                                                                      
                                 LOGOFF                                                                                                                               |
| **Cluster Involved Scenario** | **NO**                                                                                                                              |

##### Test Case

|                          |                                                                                                                                     |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_DirectoryLeasing\_LeaseBreakOnMultiClients                                                                                     |
| **Description **         | Test whether server can handle lease break notification when multiple clients request caching lease.                                |
| **Prerequisites**        |                                                                                                                                     |
| **Test Execution Steps** | **From client1**                                                                                                                    
                                                                                                                                                                 
                            NEGOTIATE                                                                                                                            
                                                                                                                                                                 
                            SESSION\_SETUP                                                                                                                       
                                                                                                                                                                 
                            TREE\_CONNECT                                                                                                                        
                                                                                                                                                                 
                            CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING)  
                                                                                                                                                                 
                            **From client2 to access same directory to trigger leasing break**                                                                   
                                                                                                                                                                 
                            NEGOTIATE                                                                                                                            
                                                                                                                                                                 
                            SESSION\_SETUP                                                                                                                       
                                                                                                                                                                 
                            TREE\_CONNECT                                                                                                                        
                                                                                                                                                                 
                            CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING)  
                                                                                                                                                                 
                            **From client3 to access same directory to trigger leasing break**                                                                   
                                                                                                                                                                 
                            NEGOTIATE                                                                                                                            
                                                                                                                                                                 
                            SESSION\_SETUP                                                                                                                       
                                                                                                                                                                 
                            TREE\_CONNECT                                                                                                                        
                                                                                                                                                                 
                            CREATE (with DELETE)                                                                                                                 
                                                                                                                                                                 
                            **From client1 and client2**                                                                                                         
                                                                                                                                                                 
                            Receive LEASE\_BREAK                                                                                                                 
                                                                                                                                                                 
                            Send LEASE\_BREAK\_ACK                                                                                                               
                                                                                                                                                                 
                            CLOSE                                                                                                                                
                                                                                                                                                                 
                            TREE\_DISCONNECT                                                                                                                     
                                                                                                                                                                 
                            LOGOFF                                                                                                                               |
| **Cleanup**              |                                                                                                                                     |

1.  ### <span id="_Encryption" class="anchor"><span id="_Toc427488140" class="anchor"></span></span>Encryption

    1.  #### Scenario

|                               |                                                       |
|-------------------------------|-------------------------------------------------------|
| **Description**               | Send and receive commands with encryption enabled     |
| **Message Sequence**          | NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)        
                                                                                        
                                 SESSION\_SETUP                                         
                                                                                        
                                 TREE\_CONNECT (expect SMB2\_SHAREFLAG\_ENCRYPT\_DATA)  
                                                                                        
                                 CREATE                                                 
                                                                                        
                                 WRITE                                                  
                                                                                        
                                 READ                                                   
                                                                                        
                                 CLOSE                                                  
                                                                                        
                                 TREE\_DISCONNECT                                       
                                                                                        
                                 LOGOFF                                                 |
| **Cluster Involved Scenario** | NO                                                    |

#### Test Case

|                          |                                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Encryption\_GlobalEncryptionEnabled                                                             |
| **Description **         | Ensure server could handle encrypted requests correctly while global encryption is enabled           |
| **Prerequisites**        |                                                                                                      |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request with SMB2\_GLOBAL\_CAP\_ENCRYPTION                                
                                                                                                                                  
                            2.  Server sends NEGOTIATE response with SMB2\_GLOBAL\_CAP\_ENCRYPTION                                
                                                                                                                                  
                            3.  Client sends SESSION\_SETUP request                                                               
                                                                                                                                  
                            4.  Server sends SESSION\_SETUP response                                                              
                                                                                                                                  
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed  
                                                                                                                                  
                            6.  Client sends encrypted TREE\_CONNECT request                                                      
                                                                                                                                  
                            7.  Server sends TREE\_CONNECT response with SMB2\_SHAREFLAG\_ENCRYPT\_DATA                           
                                                                                                                                  
                            8.  Client sends encrypted CREATE request                                                             
                                                                                                                                  
                            9.  Server sends encrypted CREATE response                                                            
                                                                                                                                  
                            10. Client sends encrypted WRITE request                                                              
                                                                                                                                  
                            11. Server sends encrypted WRITE response                                                             
                                                                                                                                  
                            12. Client sends encrypted READ request to read the content written in previous message.              
                                                                                                                                  
                            13. Server sends encrypted READ response                                                              
                                                                                                                                  
                            14. Client check whether the decrypted content is consistent with the original one.                   
                                                                                                                                  
                            15. Client sends encrypted CLOSE request                                                              
                                                                                                                                  
                            16. Server sends encrypted CLOSE response                                                             
                                                                                                                                  
                            17. Client sends encrypted TREE\_DISCONNECT request                                                   
                                                                                                                                  
                            18. Server sends encrypted TREE\_DISCONNECT response                                                  
                                                                                                                                  
                            19. Client sends LOGOFF request                                                                       
                                                                                                                                  
                            20. Server sends LOGOFF response                                                                      |
| **Cleanup**              |                                                                                                      |

|                          |                                                                                                              |
|--------------------------|--------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Encryption\_PerShareEncryptionEnabled                                                                   |
| **Description **         | Ensure server could handle encrypted requests correctly while client requests to connect to encrypted share. |
| **Prerequisites**        |                                                                                                              |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request with SMB2\_GLOBAL\_CAP\_ENCRYPTION                                        
                                                                                                                                          
                            2.  Server sends NEGOTIATE response with SMB2\_GLOBAL\_CAP\_ENCRYPTION                                        
                                                                                                                                          
                            3.  Client sends SESSION\_SETUP request                                                                       
                                                                                                                                          
                            4.  Server sends SESSION\_SETUP response                                                                      
                                                                                                                                          
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed          
                                                                                                                                          
                            6.  Client sends TREE\_CONNECT request to connect an encrypted share                                          
                                                                                                                                          
                            7.  Server sends TREE\_CONNECT response with SMB2\_SHAREFLAG\_ENCRYPT\_DATA                                   
                                                                                                                                          
                            8.  Client sends encrypted CREATE request                                                                     
                                                                                                                                          
                            9.  Server sends encrypted CREATE response                                                                    
                                                                                                                                          
                            10. Client sends encrypted WRITE request                                                                      
                                                                                                                                          
                            11. Server sends encrypted WRITE response                                                                     
                                                                                                                                          
                            12. Client sends encrypted READ request to read the content written in previous message                       
                                                                                                                                          
                            13. Server sends encrypted READ response                                                                      
                                                                                                                                          
                            14. Client check whether the decrypted content is consistent with the original one                            
                                                                                                                                          
                            15. Client sends encrypted CLOSE request                                                                      
                                                                                                                                          
                            16. Server sends encrypted CLOSE response                                                                     
                                                                                                                                          
                            17. Client sends encrypted TREE\_DISCONNECT request                                                           
                                                                                                                                          
                            18. Server sends encrypted TREE\_DISCONNECT response                                                          
                                                                                                                                          
                            19. Client sends LOGOFF request                                                                               
                                                                                                                                          
                            20. Server sends LOGOFF response                                                                              |
| **Cleanup**              |                                                                                                              |

|                          |                                                                                                                                                                                                                                                                                       |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Encryption\_SMB311\_CCM                                                                                                                                                                                                                                                          |
| **Description **         | This case is to ensure server could handle encrypted requests correctly with dialect 3.11, SMB2\_ENCRYPTION\_CAPABILITIES context and AES-128-CCM as encryption algorithm.                                                                                                            |
| **Prerequisites**        | The server implement dialect 3.11.                                                                                                                                                                                                                                                    |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request with dialect 3.11, SMB2\_ENCRYPTION\_CAPABILITIES context. AES-128-CCM is as the preferred cipher algorithm. Server should reply NEGOTIATE response with dialect 3.11, SMB2\_ENCRYPTION\_CAPABILITIES context and AES-128-CCM as cipher algorithm. 
                                                                                                                                                                                                                                                                                                                   
                            2.  Client sends SESSION\_SETUP request and gets response.                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                   
                            3.  Client sends encrypted TREE\_CONNECT, Create, Write, Read, Close, TREE\_DISCONNECT and Logoff request and gets successful responses.                                                                                                                                               |
| **Cleanup**              |                                                                                                                                                                                                                                                                                       |

|                          |                                                                                                                                                                                                                                                                                       |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Encryption\_SMB311\_GCM                                                                                                                                                                                                                                                          |
| **Description **         | This case is to ensure server could handle encrypted requests correctly with dialect 3.11, SMB2\_ENCRYPTION\_CAPABILITIES context and AES-128-GCM as encryption algorithm.                                                                                                            |
| **Prerequisites**        | The server implement dialect 3.11.                                                                                                                                                                                                                                                    |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request with dialect 3.11, SMB2\_ENCRYPTION\_CAPABILITIES context. AES-128-GCM is as the preferred cipher algorithm. Server should reply NEGOTIATE response with dialect 3.11, SMB2\_ENCRYPTION\_CAPABILITIES context and AES-128-GCM as cipher algorithm. 
                                                                                                                                                                                                                                                                                                                   
                            2.  Client sends SESSION\_SETUP request and gets response.                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                   
                            3.  Client sends encrypted TREE\_CONNECT, Create, Write, Read, Close, TREE\_DISCONNECT and Logoff request, and gets successful responses.                                                                                                                                              |
| **Cleanup**              |                                                                                                                                                                                                                                                                                       |

1.  ### AppInstanceId

    1.  #### Scenario

|                               |                                          |
|-------------------------------|------------------------------------------|
| **Description**               | Client cluster failover                  |
| **Message Sequence**          | ***Based on NIC1, create Client1:***     
                                                                           
                                 NEGOTIATE                                 
                                                                           
                                 SESSION\_SETUP                            
                                                                           
                                 TREE\_CONNECT                             
                                                                           
                                 CREATE (With AppID)                       
                                                                           
                                 WRITE                                     
                                                                           
                                 ***Switch to NIC2 and create Client2:***  
                                                                           
                                 NEGOTIATE                                 
                                                                           
                                 SESSION\_SETUP                            
                                                                           
                                 TREE\_CONNECT                             
                                                                           
                                 CREATE (With the same AppID)              
                                                                           
                                 READ                                      
                                                                           
                                 CLOSE                                     
                                                                           
                                 TREE\_DISCONNECT                          
                                                                           
                                 LOGOFF                                    |
| **Cluster Involved Scenario** | **NO**                                   |

#### Test Case

|                          |                                                                                                                                  |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_AppInstanceId                                                                                                               |
| **Description **         | Check when client fails over to a new client, the previous opened file can be reopened with the same AppInstanceId.              |
| **Prerequisites**        |                                                                                                                                  |
| **Test Execution Steps** | Via NIC1                                                                                                                         
                                                                                                                                                              
                            1.  Start the first client by sending the following requests: NEGOTIATE; SESSION\_SETUP; TREE\_CONNECT                            
                                                                                                                                                              
                            2.  The first client sends CREATE request for exclusive open with SMB2\_CREATE\_APP\_INSTANCE\_ID create context.                 
                                                                                                                                                              
                            3.  The first client sends WRITE request.                                                                                         
                                                                                                                                                              
                            Via NIC2                                                                                                                          
                                                                                                                                                              
                            1.  Start the second client by sending the following requests: NEGOTIATE; SESSIONSETUP; TREE\_CONNECT                             
                                                                                                                                                              
                            2.  The second client sends CREATE request for exclusive open with the same SMB2\_CREATE\_APP\_INSTANCE\_ID of the first client.  
                                                                                                                                                              
                            3.  The second client sends READ request.                                                                                         
                                                                                                                                                              
                            Via NIC1                                                                                                                          
                                                                                                                                                              
                            1.  The first client sends another WRITE request.                                                                                 
                                                                                                                                                              
                            Via NIC2                                                                                                                          
                                                                                                                                                              
                            1.  Tear down the second client by sending the following requests: CLOSE; TREE\_DISCONNECT; LOG\_OFF; DISCONNECT                  |
| **Cleanup**              |                                                                                                                                  |

1.  ### AppInstanceVersion

    1.  #### Scenario

|                               |                                                                               |
|-------------------------------|-------------------------------------------------------------------------------|
| **Description**               | Client cluster failover v2                                                    |
| **Message Sequence**          | ***Client1:***                                                                
                                                                                                                
                                 NEGOTIATE                                                                      
                                                                                                                
                                 SESSION\_SETUP                                                                 
                                                                                                                
                                 TREE\_CONNECT                                                                  
                                                                                                                
                                 CREATE (With AppInstanceID and AppInstanceVersion)                             
                                                                                                                
                                 ***Client2:***                                                                 
                                                                                                                
                                 NEGOTIATE                                                                      
                                                                                                                
                                 SESSION\_SETUP                                                                 
                                                                                                                
                                 TREE\_CONNECT                                                                  
                                                                                                                
                                 CREATE (With the same AppInstanceID and same or different AppInstanceVersion)  
                                                                                                                
                                 ***Client1:***                                                                 
                                                                                                                
                                 Write and check the result                                                     |
| **Cluster Involved Scenario** | **NO**                                                                        |

#### Test Case

|                          |                                                                                                                           |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_AppInstanceVersion\_SMB311\_GreaterVersion                                                                           |
| **Description **         | Check when client fails over to a new client, the previous opened file can be reopened with a greater AppInstanceVersion. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                       |
| **Test Execution Steps** | 1.  Start the first client by sending the following requests: NEGOTIATE; SESSION\_SETUP; TREE\_CONNECT.                   
                                                                                                                                                       
                            2.  The first client sends CREATE request with AppInstanceVersionHigh = 1, AppInstanceVersionLow = 0.                      
                                                                                                                                                       
                            3.  Start the second client by sending the following requests: NEGOTIATE; SESSIONSETUP; TREE\_CONNECT.                     
                                                                                                                                                       
                            4.  The second client sends CREATE request with AppInstanceVersionHigh = 2, AppInstanceVersionLow = 1 and succeeds.        
                                                                                                                                                       
                            5.  Client1 sends another WRITE request.                                                                                   
                                                                                                                                                       
                            6.  The first client sends another WRITE request and failed since the open is closed.                                      
                                                                                                                                                       
                            7.  Tear down the two clients by sending the following requests: CLOSE; TREE\_DISCONNECT; LOG\_OFF; DISCONNECT             |
| **Cleanup**              |                                                                                                                           |

|                          |                                                                                                                              |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_AppInstanceVersion\_SMB311\_SameVersion                                                                                 |
| **Description **         | Check when client fails over to a new client, the previous opened file can NOT be reopened with the same AppInstanceVersion. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                          |
| **Test Execution Steps** | 1.  Start the first client by sending the following requests: NEGOTIATE; SESSION\_SETUP; TREE\_CONNECT.                      
                                                                                                                                                          
                            2.  The first client sends CREATE request with AppInstanceVersionHigh = 1, AppInstanceVersionLow = 0.                         
                                                                                                                                                          
                            3.  Start the second client by sending the following requests: NEGOTIATE; SESSIONSETUP; TREE\_CONNECT.                        
                                                                                                                                                          
                            4.  The second client sends CREATE request with AppInstanceVersionHigh = 2, AppInstanceVersionLow = 0 and succeeds.           
                                                                                                                                                          
                            5.  Client1 sends another WRITE request and failed since the open is closed.                                                  
                                                                                                                                                          
                            6.  Client1 sends another CREATE request with same AppInstanceVersion as Client2 and gets STATUS\_FILE\_FORCED\_CLOSED.       
                                                                                                                                                          
                            7.  Tear down the two clients by sending the following requests: CLOSE; TREE\_DISCONNECT; LOG\_OFF; DISCONNECT                |
| **Cleanup**              |                                                                                                                              |

|                          |                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_AppInstanceVersion\_SMB311\_LowerAppInstanceVersionHigh                                                                                     |
| **Description **         | Check when client fails over to a new client, the previous opened file can NOT be reopened with lower AppInstanceVersion.AppInstanceVersionHigh. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                              |
| **Test Execution Steps** | 1.  Start the first client by sending the following requests: NEGOTIATE; SESSION\_SETUP; TREE\_CONNECT.                                          
                                                                                                                                                                              
                            2.  The first client sends CREATE request with AppInstanceVersionHigh = 2, AppInstanceVersionLow = 0.                                             
                                                                                                                                                                              
                            3.  Start the second client by sending the following requests: NEGOTIATE; SESSIONSETUP; TREE\_CONNECT.                                            
                                                                                                                                                                              
                            4.  The second client sends CREATE request with AppInstanceVersionHigh = 1, AppInstanceVersionLow = 0 and gets failure.                           
                                                                                                                                                                              
                            5.  Client1 sends another WRITE request and succeeds since the open is not closed.                                                                
                                                                                                                                                                              
                            6.  Tear down the two clients by sending the following requests: CLOSE; TREE\_DISCONNECT; LOG\_OFF; DISCONNECT                                    |
| **Cleanup**              |                                                                                                                                                  |

|                          |                                                                                                                                                 |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_AppInstanceVersion\_SMB311\_LowerAppInstanceVersionLow                                                                                     |
| **Description **         | Check when client fails over to a new client, the previous opened file can NOT be reopened with lower AppInstanceVersion.AppInstanceVersionLow. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                             |
| **Test Execution Steps** | 1.  Start the first client by sending the following requests: NEGOTIATE; SESSION\_SETUP; TREE\_CONNECT.                                         
                                                                                                                                                                             
                            2.  The first client sends CREATE request with AppInstanceVersionHigh = 1, AppInstanceVersionLow = 2.                                            
                                                                                                                                                                             
                            3.  Start the second client by sending the following requests: NEGOTIATE; SESSIONSETUP; TREE\_CONNECT.                                           
                                                                                                                                                                             
                            4.  The second client sends CREATE request with AppInstanceVersionHigh = 1, AppInstanceVersionLow = 1 and gets failure.                          
                                                                                                                                                                             
                            5.  Client1 sends another WRITE request and succeeds since the open is not closed.                                                               
                                                                                                                                                                             
                            6.  Tear down the two clients by sending the following requests: CLOSE; TREE\_DISCONNECT; LOG\_OFF; DISCONNECT                                   |
| **Cleanup**              |                                                                                                                                                 |

1.  ### <span id="_Toc419731481" class="anchor"><span id="_Toc419796109" class="anchor"><span id="_Toc419970283" class="anchor"><span id="_Toc427488143" class="anchor"></span></span></span></span>DurableHandle

    1.  #### Scenario

|                               |                                      |
|-------------------------------|--------------------------------------|
| **Description**               | DurableHandle                        |
| **Message Sequence**          | NEGOTIATE                            
                                                                       
                                 SESSION\_SETUP                        
                                                                       
                                 TREE\_CONNECT                         
                                                                       
                                 CREATE (With DurableHandleRequest)    
                                                                       
                                 WRITE                                 
                                                                       
                                 NEGOTIATE                             
                                                                       
                                 SESSION\_SETUP                        
                                                                       
                                 TREE\_CONNECT                         
                                                                       
                                 CREATE (With DurableHandleReconnect)  
                                                                       
                                 READ                                  
                                                                       
                                 CLOSE                                 
                                                                       
                                 TREE\_DISCONNECT                      
                                                                       
                                 LOGOFF                                |
| **Cluster Involved Scenario** | **NO**                               |

#### Test Case

|                          |                                                                                                             |
|--------------------------|-------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_DurableHandleV1\_Reconnect\_WithBatchOplock                                                            |
| **Description **         | This test case is designed to test whether server can create a durable open v1 with batch oplock correctly. |
| **Prerequisites**        |                                                                                                             |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request                                                                          
                                                                                                                                         
                            2.  Server sends NEGOTIATE response                                                                          
                                                                                                                                         
                            3.  Client sends SESSION\_SETUP request                                                                      
                                                                                                                                         
                            4.  Server sends SESSION\_SETUP response                                                                     
                                                                                                                                         
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed         
                                                                                                                                         
                            6.  Client sends TREE\_CONNECT request                                                                       
                                                                                                                                         
                            7.  Server sends TREE\_CONNECT response                                                                      
                                                                                                                                         
                            8.  Client sends CREATE request for exclusive open with DurableHandleV1 create context and BatchOpLock       
                                                                                                                                         
                            9.  Server sends CREATE response                                                                             
                                                                                                                                         
                            10. Client sends WRITE request                                                                               
                                                                                                                                         
                            11. Server sends WRITE response                                                                              
                                                                                                                                         
                            12. Client disconnect                                                                                        
                                                                                                                                         
                            13. Create another client and the following requests are sent via this client                                
                                                                                                                                         
                            14. Client sends NEGOTIATE request                                                                           
                                                                                                                                         
                            15. Server sends NEGOTIATE response                                                                          
                                                                                                                                         
                            16. Client sends SESSION\_SETUP request                                                                      
                                                                                                                                         
                            17. Server sends SESSION\_SETUP response                                                                     
                                                                                                                                         
                            18. According to the status code of last step, client may send more SESSION\_SETUP request as needed         
                                                                                                                                         
                            19. Client sends CREATE request for exclusive open with DurableHandleReconnectV1 and BatchOpLock             
                                                                                                                                         
                            20. Server sends CREATE response                                                                             
                                                                                                                                         
                            21. Client sends READ request                                                                                
                                                                                                                                         
                            22. Server sends READ response                                                                               
                                                                                                                                         
                            23. Client sends CLOSE request                                                                               
                                                                                                                                         
                            24. Server sends CLOSE response                                                                              
                                                                                                                                         
                            25. Client sends TREE\_DISCONNECT request                                                                    
                                                                                                                                         
                            26. Server sends TREE\_DISCONNECT response                                                                   
                                                                                                                                         
                            27. Client sends LOGOFF request                                                                              
                                                                                                                                         
                            28. Server sends LOGOFF response                                                                             |
| **Cleanup**              |                                                                                                             |

|                          |                                                                                                             |
|--------------------------|-------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_DurableHandleV1\_Reconnect\_WithLeaseV1                                                                |
| **Description **         | Test reconnect with DurableHandleV1 and LeaseV1 context.                                                    |
| **Prerequisites**        |                                                                                                             |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request                                                                          
                                                                                                                                         
                            2.  Server sends NEGOTIATE response                                                                          
                                                                                                                                         
                            3.  Client sends SESSION\_SETUP request                                                                      
                                                                                                                                         
                            4.  Server sends SESSION\_SETUP response                                                                     
                                                                                                                                         
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed         
                                                                                                                                         
                            6.  Client sends TREE\_CONNECT request                                                                       
                                                                                                                                         
                            7.  Server sends TREE\_CONNECT response                                                                      
                                                                                                                                         
                            8.  Client sends CREATE request for exclusive open with DurableHandleV1 and LeaseV1 create context           
                                                                                                                                         
                            9.  Server sends CREATE response                                                                             
                                                                                                                                         
                            10. Client sends WRITE request                                                                               
                                                                                                                                         
                            11. Server sends WRITE response                                                                              
                                                                                                                                         
                            12. Client disconnect                                                                                        
                                                                                                                                         
                            13. Create another client and the following requests are sent via this client                                
                                                                                                                                         
                            14. Client sends NEGOTIATE request                                                                           
                                                                                                                                         
                            15. Server sends NEGOTIATE response                                                                          
                                                                                                                                         
                            16. Client sends SESSION\_SETUP request                                                                      
                                                                                                                                         
                            17. Server sends SESSION\_SETUP response                                                                     
                                                                                                                                         
                            18. According to the status code of last step, client may send more SESSION\_SETUP request as needed         
                                                                                                                                         
                            19. Client sends CREATE request for exclusive open with DurableHandleReconnectV1 and LeaseV1 create context  
                                                                                                                                         
                            20. Server sends CREATE response                                                                             
                                                                                                                                         
                            21. Client sends READ request                                                                                
                                                                                                                                         
                            22. Server sends READ response                                                                               
                                                                                                                                         
                            23. Client sends CLOSE request                                                                               
                                                                                                                                         
                            24. Server sends CLOSE response                                                                              
                                                                                                                                         
                            25. Client sends TREE\_DISCONNECT request                                                                    
                                                                                                                                         
                            26. Server sends TREE\_DISCONNECT response                                                                   
                                                                                                                                         
                            27. Client sends LOGOFF request                                                                              
                                                                                                                                         
                            28. Server sends LOGOFF response                                                                             |
| **Cleanup**              |                                                                                                             |

|                          |                                                                                                        |
|--------------------------|--------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_DurableHandleV2\_Reconnect\_WithBatchOplock                                                       |
| **Description **         | Test reconnect with DurableHandleV2 and BatchOplock.                                                   |
| **Prerequisites**        |                                                                                                        |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request                                                                     
                                                                                                                                    
                            2.  Server sends NEGOTIATE response                                                                     
                                                                                                                                    
                            3.  Client sends SESSION\_SETUP request                                                                 
                                                                                                                                    
                            4.  Server sends SESSION\_SETUP response                                                                
                                                                                                                                    
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed    
                                                                                                                                    
                            6.  Client sends TREE\_CONNECT request                                                                  
                                                                                                                                    
                            7.  Server sends TREE\_CONNECT response                                                                 
                                                                                                                                    
                            8.  Client sends CREATE request for exclusive open with DurableHandleV2 create context and BatchOpLock  
                                                                                                                                    
                            9.  Server sends CREATE response                                                                        
                                                                                                                                    
                            10. Client sends WRITE request                                                                          
                                                                                                                                    
                            11. Server sends WRITE response                                                                         
                                                                                                                                    
                            12. Client disconnect                                                                                   
                                                                                                                                    
                            13. Create another client and the following requests are sent via this client                           
                                                                                                                                    
                            14. Client sends NEGOTIATE request                                                                      
                                                                                                                                    
                            15. Server sends NEGOTIATE response                                                                     
                                                                                                                                    
                            16. Client sends SESSION\_SETUP request                                                                 
                                                                                                                                    
                            17. Server sends SESSION\_SETUP response                                                                
                                                                                                                                    
                            18. According to the status code of last step, client may send more SESSION\_SETUP request as needed    
                                                                                                                                    
                            19. Client sends CREATE request for exclusive open with DurableHandleReconnectV1 and BatchOpLock        
                                                                                                                                    
                            20. Server sends CREATE response                                                                        
                                                                                                                                    
                            21. Client sends READ request                                                                           
                                                                                                                                    
                            22. Server sends READ response                                                                          
                                                                                                                                    
                            23. Client sends CLOSE request                                                                          
                                                                                                                                    
                            24. Server sends CLOSE response                                                                         
                                                                                                                                    
                            25. Client sends TREE\_DISCONNECT request                                                               
                                                                                                                                    
                            26. Server sends TREE\_DISCONNECT response                                                              
                                                                                                                                    
                            27. Client sends LOGOFF request                                                                         
                                                                                                                                    
                            28. Server sends LOGOFF response                                                                        |
| **Cleanup**              |                                                                                                        |

|                          |                                                                                                             |
|--------------------------|-------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_DurableHandleV2\_Reconnect\_WithLeaseV1                                                                |
| **Description **         | Test reconnect with DurableHandleV2 and LeaseV1 context.                                                    |
| **Prerequisites**        |                                                                                                             |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request                                                                          
                                                                                                                                         
                            2.  Server sends NEGOTIATE response                                                                          
                                                                                                                                         
                            3.  Client sends SESSION\_SETUP request                                                                      
                                                                                                                                         
                            4.  Server sends SESSION\_SETUP response                                                                     
                                                                                                                                         
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed         
                                                                                                                                         
                            6.  Client sends TREE\_CONNECT request                                                                       
                                                                                                                                         
                            7.  Server sends TREE\_CONNECT response                                                                      
                                                                                                                                         
                            8.  Client sends CREATE request for exclusive open with DurableHandleV2 and LeaseV1 create context           
                                                                                                                                         
                            9.  Server sends CREATE response                                                                             
                                                                                                                                         
                            10. Client sends WRITE request                                                                               
                                                                                                                                         
                            11. Server sends WRITE response                                                                              
                                                                                                                                         
                            12. Client disconnect                                                                                        
                                                                                                                                         
                            13. Create another client and the following requests are sent via this client                                
                                                                                                                                         
                            14. Client sends NEGOTIATE request                                                                           
                                                                                                                                         
                            15. Server sends NEGOTIATE response                                                                          
                                                                                                                                         
                            16. Client sends SESSION\_SETUP request                                                                      
                                                                                                                                         
                            17. Server sends SESSION\_SETUP response                                                                     
                                                                                                                                         
                            18. According to the status code of last step, client may send more SESSION\_SETUP request as needed         
                                                                                                                                         
                            19. Client sends CREATE request for exclusive open with DurableHandleReconnectV2 and LeaseV1 create context  
                                                                                                                                         
                            20. Server sends CREATE response                                                                             
                                                                                                                                         
                            21. Client sends READ request                                                                                
                                                                                                                                         
                            22. Server sends READ response                                                                               
                                                                                                                                         
                            23. Client sends CLOSE request                                                                               
                                                                                                                                         
                            24. Server sends CLOSE response                                                                              
                                                                                                                                         
                            25. Client sends TREE\_DISCONNECT request                                                                    
                                                                                                                                         
                            26. Server sends TREE\_DISCONNECT response                                                                   
                                                                                                                                         
                            27. Client sends LOGOFF request                                                                              
                                                                                                                                         
                            28. Server sends LOGOFF response                                                                             |
| **Cleanup**              |                                                                                                             |

|                          |                                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------|
| **Test ID**              | <span id="OLE_LINK1" class="anchor"></span>BVT\_PersistentHandle\_Reconnect                          |
| **Description **         | Test reconnect with persistent handle                                                                |
| **Prerequisites**        |                                                                                                      |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request                                                                   
                                                                                                                                  
                            2.  Server sends NEGOTIATE response                                                                   
                                                                                                                                  
                            3.  Client sends SESSION\_SETUP request                                                               
                                                                                                                                  
                            4.  Server sends SESSION\_SETUP response                                                              
                                                                                                                                  
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed  
                                                                                                                                  
                            6.  Client sends TREE\_CONNECT request                                                                
                                                                                                                                  
                            7.  Server sends TREE\_CONNECT response                                                               
                                                                                                                                  
                            8.  Client sends CREATE request for exclusive open with PersistentHandle create context               
                                                                                                                                  
                            9.  Server sends CREATE response                                                                      
                                                                                                                                  
                            10. Client sends WRITE request                                                                        
                                                                                                                                  
                            11. Server sends WRITE response                                                                       
                                                                                                                                  
                            12. Client disconnect                                                                                 
                                                                                                                                  
                            13. Create another client and the following requests are sent via this client                         
                                                                                                                                  
                            14. Client sends NEGOTIATE request                                                                    
                                                                                                                                  
                            15. Server sends NEGOTIATE response                                                                   
                                                                                                                                  
                            16. Client sends SESSION\_SETUP request                                                               
                                                                                                                                  
                            17. Server sends SESSION\_SETUP response                                                              
                                                                                                                                  
                            18. According to the status code of last step, client may send more SESSION\_SETUP request as needed  
                                                                                                                                  
                            19. Client sends CREATE request for exclusive open with PersistentHandle                              
                                                                                                                                  
                            20. Server sends CREATE response                                                                      
                                                                                                                                  
                            21. Client sends READ request                                                                         
                                                                                                                                  
                            22. Server sends READ response                                                                        
                                                                                                                                  
                            23. Client sends CLOSE request                                                                        
                                                                                                                                  
                            24. Server sends CLOSE response                                                                       
                                                                                                                                  
                            25. Client sends TREE\_DISCONNECT request                                                             
                                                                                                                                  
                            26. Server sends TREE\_DISCONNECT response                                                            
                                                                                                                                  
                            27. Client sends LOGOFF request                                                                       
                                                                                                                                  
                            28. Server sends LOGOFF response                                                                      |
| **Cleanup**              |                                                                                                      |

1.  ### Oplock

    1.  #### Scenario

|                               |                                                                            |
|-------------------------------|----------------------------------------------------------------------------|
| **Description**               | This scenario is to test whether server can handle Oplock break correctly. |
| **Message Sequence**          | ***Based on NIC1, create Client1:***                                       
                                                                                                             
                                 NEGOTIATE                                                                   
                                                                                                             
                                 SESSION\_SETUP                                                              
                                                                                                             
                                 TREE\_CONNECT                                                               
                                                                                                             
                                 CREATE (With BatchOplock)                                                   
                                                                                                             
                                 WRITE                                                                       
                                                                                                             
                                 ***Switch to NIC2 and create Client2:***                                    
                                                                                                             
                                 NEGOTIATE                                                                   
                                                                                                             
                                 SESSION\_SETUP                                                              
                                                                                                             
                                 TREE\_CONNECT                                                               
                                                                                                             
                                 CREATE                                                                      
                                                                                                             
                                 ***Switch to NIC1 and Client1:***                                           
                                                                                                             
                                 OplockBreakNotification                                                     
                                                                                                             
                                 OpLockBreakAcknowlegement                                                   |
| **Cluster Involved Scenario** | **NO**                                                                     |

#### Test Case

|                          |                                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_OpLockBreak                                                                                     |
| **Description **         | This test case is designed to test whether sever can handle OplockBreak correctly.                   |
| **Prerequisites**        |                                                                                                      |
| **Test Execution Steps** | Via NIC1                                                                                             
                                                                                                                                  
                            1.  Client sends NEGOTIATE request                                                                    
                                                                                                                                  
                            2.  Server sends NEGOTIATE response                                                                   
                                                                                                                                  
                            3.  Client sends SESSION\_SETUP request                                                               
                                                                                                                                  
                            4.  Server sends SESSION\_SETUP response                                                              
                                                                                                                                  
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed  
                                                                                                                                  
                            6.  Client sends TREE\_CONNECT request                                                                
                                                                                                                                  
                            7.  Server sends TREE\_CONNECT response                                                               
                                                                                                                                  
                            8.  Client sends CREATE request with BatchOpLock                                                      
                                                                                                                                  
                            9.  Server sends CREATE response                                                                      
                                                                                                                                  
                            Via NIC2                                                                                              
                                                                                                                                  
                            1.  Create another client and the following requests are sent via this client                         
                                                                                                                                  
                            2.  Client sends NEGOTIATE request                                                                    
                                                                                                                                  
                            3.  Server sends NEGOTIATE response                                                                   
                                                                                                                                  
                            4.  Client sends SESSION\_SETUP request                                                               
                                                                                                                                  
                            5.  Server sends SESSION\_SETUP response                                                              
                                                                                                                                  
                            6.  According to the status code of last step, client may send more SESSION\_SETUP request as needed  
                                                                                                                                  
                            7.  Client sends CREATE request on the same file                                                      
                                                                                                                                  
                            Via NIC1                                                                                              
                                                                                                                                  
                            1.  Server sends OPLOCK\_BREAK\_NOTIFICATION response                                                 
                                                                                                                                  
                            2.  Client sends OPLOCK\_BREAK\_ACKNOWLEDGEMENT request                                               
                                                                                                                                  
                            3.  Server sends OPLOCK\_BREAK\_RESPONSE response                                                     
                                                                                                                                  
                            Via NIC2                                                                                              
                                                                                                                                  
                            1.  Server sends CREATE response                                                                      
                                                                                                                                  
                            Via NIC1                                                                                              
                                                                                                                                  
                            1.  Tear down the client by sending CLOSE, TREE\_DISCONNECT and LOG\_OFF.                             
                                                                                                                                  
                            Via NIC2                                                                                              
                                                                                                                                  
                            1.  Tear down the client by sending CLOSE, TREE-CONNECT and LOG\_OFF.                                 |
| **Cleanup**              |                                                                                                      |

1.  ### <span id="_FileLeasing" class="anchor"><span id="_Toc427488145" class="anchor"></span></span>FileLeasing

    1.  #### Scenario

|                               |                                                                     |
|-------------------------------|---------------------------------------------------------------------|
| **Description**               | This scenario is to test whether server can handle lease correctly. |
| **Message Sequence**          | ***Based on NIC1, create Client1:***                                
                                                                                                      
                                 NEGOTIATE                                                            
                                                                                                      
                                 SESSION\_SETUP                                                       
                                                                                                      
                                 TREE\_CONNECT                                                        
                                                                                                      
                                 CREATE (With Lease context)                                          
                                                                                                      
                                 WRITE                                                                
                                                                                                      
                                 ***Switch to NIC2 and create Client2:***                             
                                                                                                      
                                 NEGOTIATE                                                            
                                                                                                      
                                 SESSION\_SETUP                                                       
                                                                                                      
                                 TREE\_CONNECT                                                        
                                                                                                      
                                 CREATE                                                               
                                                                                                      
                                 ***Switch to NIC1 and Client1:***                                    
                                                                                                      
                                 LeaseBreakNotification                                               
                                                                                                      
                                 LeaseBreakAcknowlegement                                             |
| **Cluster Involved Scenario** | **NO**                                                              |

#### Test Case

|                          |                                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Leasing\_FileLeasingV1                                                                          |
| **Description **         | This test case is designed to test whether server can handle LeaseV1 context correctly on a file.    |
| **Prerequisites**        |                                                                                                      |
| **Test Execution Steps** | Via NIC1                                                                                             
                                                                                                                                  
                            1.  Client sends NEGOTIATE request                                                                    
                                                                                                                                  
                            2.  Server sends NEGOTIATE response                                                                   
                                                                                                                                  
                            3.  Client sends SESSION\_SETUP request                                                               
                                                                                                                                  
                            4.  Server sends SESSION\_SETUP response                                                              
                                                                                                                                  
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed  
                                                                                                                                  
                            6.  Client sends TREE\_CONNECT request                                                                
                                                                                                                                  
                            7.  Server sends TREE\_CONNECT response                                                               
                                                                                                                                  
                            8.  Client sends CREATE request with LeaseV1                                                          
                                                                                                                                  
                            9.  Server sends CREATE response                                                                      
                                                                                                                                  
                            Via NIC2                                                                                              
                                                                                                                                  
                            1.  Create another client and the following requests are sent via this client                         
                                                                                                                                  
                            2.  Client sends NEGOTIATE request                                                                    
                                                                                                                                  
                            3.  Server sends NEGOTIATE response                                                                   
                                                                                                                                  
                            4.  Client sends SESSION\_SETUP request                                                               
                                                                                                                                  
                            5.  Server sends SESSION\_SETUP response                                                              
                                                                                                                                  
                            6.  According to the status code of last step, client may send more SESSION\_SETUP request as needed  
                                                                                                                                  
                            7.  Client sends CREATE request on the same file                                                      
                                                                                                                                  
                            Via NIC1                                                                                              
                                                                                                                                  
                            1.  Server sends LEASE\_BREAK\_NOTIFICATION response                                                  
                                                                                                                                  
                            2.  Client sends Lease\_BREAK\_ACKNOWLEDGEMENT request, breaking Lease to RH                          
                                                                                                                                  
                            3.  Server sends Lease\_BREAK\_RESPONSE response                                                      
                                                                                                                                  
                            Via NIC2                                                                                              
                                                                                                                                  
                            1.  Server sends CREATE response                                                                      
                                                                                                                                  
                            2.  Client sends Write request                                                                        
                                                                                                                                  
                            Via NIC1                                                                                              
                                                                                                                                  
                            1.  Server sends LEASE\_BREAK\_NOTIFICATION response                                                  
                                                                                                                                  
                            2.  Client sends Lease\_BREAK\_ACKNOWLEDGEMENT request, breaking Lease to None                        
                                                                                                                                  
                            3.  Server sends Lease\_BREAK\_RESPONSE response                                                      
                                                                                                                                  
                            Via NIC2                                                                                              
                                                                                                                                  
                            1.  Server sends WRITE response                                                                       
                                                                                                                                  
                            Via NIC1                                                                                              
                                                                                                                                  
                            1.  Client sends CLOSE request                                                                        
                                                                                                                                  
                            2.  Server sends CLOSE response                                                                       
                                                                                                                                  
                            3.  Client sends TREE\_DISCONNECT request                                                             
                                                                                                                                  
                            4.  Server sends TREE\_DISCONNECT response                                                            
                                                                                                                                  
                            5.  Client sends LOGOFF request                                                                       
                                                                                                                                  
                            6.  Server sends LOGOFF response                                                                      
                                                                                                                                  
                            Via NIC2                                                                                              
                                                                                                                                  
                            1.  Client sends CLOSE request                                                                        
                                                                                                                                  
                            2.  Server sends CLOSE response                                                                       
                                                                                                                                  
                            3.  Client sends TREE\_DISCONNECT request                                                             
                                                                                                                                  
                            4.  Server sends TREE\_DISCONNECT response                                                            
                                                                                                                                  
                            5.  Client sends LOGOFF request                                                                       
                                                                                                                                  
                            6.  Server sends LOGOFF response                                                                      |
| **Cleanup**              |                                                                                                      |

|                          |                                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Leasing\_FileLeasingV2                                                                          |
| **Description **         | This test case is designed to test whether server can handle LeaseV2 context correctly on a file.    |
| **Prerequisites**        |                                                                                                      |
| **Test Execution Steps** | Via NIC1                                                                                             
                                                                                                                                  
                            1.  Client sends NEGOTIATE request                                                                    
                                                                                                                                  
                            2.  Server sends NEGOTIATE response                                                                   
                                                                                                                                  
                            3.  Client sends SESSION\_SETUP request                                                               
                                                                                                                                  
                            4.  Server sends SESSION\_SETUP response                                                              
                                                                                                                                  
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed  
                                                                                                                                  
                            6.  Client sends TREE\_CONNECT request                                                                
                                                                                                                                  
                            7.  Server sends TREE\_CONNECT response                                                               
                                                                                                                                  
                            8.  Client sends CREATE request with LeaseV2                                                          
                                                                                                                                  
                            9.  Server sends CREATE response                                                                      
                                                                                                                                  
                            Via NIC2                                                                                              
                                                                                                                                  
                            1.  Create another client and the following requests are sent via this client                         
                                                                                                                                  
                            2.  Client sends NEGOTIATE request                                                                    
                                                                                                                                  
                            3.  Server sends NEGOTIATE response                                                                   
                                                                                                                                  
                            4.  Client sends SESSION\_SETUP request                                                               
                                                                                                                                  
                            5.  Server sends SESSION\_SETUP response                                                              
                                                                                                                                  
                            6.  According to the status code of last step, client may send more SESSION\_SETUP request as needed  
                                                                                                                                  
                            7.  Client sends CREATE request on the same file                                                      
                                                                                                                                  
                            Via NIC1                                                                                              
                                                                                                                                  
                            1.  Server sends LEASE\_BREAK\_NOTIFICATION response                                                  
                                                                                                                                  
                            2.  Client sends Lease\_BREAK\_ACKNOWLEDGEMENT request, breaking Lease to RH                          
                                                                                                                                  
                            3.  Server sends Lease\_BREAK\_RESPONSE response                                                      
                                                                                                                                  
                            Via NIC2                                                                                              
                                                                                                                                  
                            1.  Server sends CREATE response                                                                      
                                                                                                                                  
                            2.  Client sends Write request                                                                        
                                                                                                                                  
                            Via NIC1                                                                                              
                                                                                                                                  
                            1.  Server sends LEASE\_BREAK\_NOTIFICATION response                                                  
                                                                                                                                  
                            2.  Client sends Lease\_BREAK\_ACKNOWLEDGEMENT request, breaking Lease to None                        
                                                                                                                                  
                            3.  Server sends Lease\_BREAK\_RESPONSE response                                                      
                                                                                                                                  
                            Via NIC2                                                                                              
                                                                                                                                  
                            1.  Server sends WRITE response                                                                       
                                                                                                                                  
                            Via NIC1                                                                                              
                                                                                                                                  
                            1.  Client sends CLOSE request                                                                        
                                                                                                                                  
                            2.  Server sends CLOSE response                                                                       
                                                                                                                                  
                            3.  Client sends TREE\_DISCONNECT request                                                             
                                                                                                                                  
                            4.  Server sends TREE\_DISCONNECT response                                                            
                                                                                                                                  
                            5.  Client sends LOGOFF request                                                                       
                                                                                                                                  
                            6.  Server sends LOGOFF response                                                                      
                                                                                                                                  
                            Via NIC2                                                                                              
                                                                                                                                  
                            1.  Client sends CLOSE request                                                                        
                                                                                                                                  
                            2.  Server sends CLOSE response                                                                       
                                                                                                                                  
                            3.  Client sends TREE\_DISCONNECT request                                                             
                                                                                                                                  
                            4.  Server sends TREE\_DISCONNECT response                                                            
                                                                                                                                  
                            5.  Client sends LOGOFF request                                                                       
                                                                                                                                  
                            6.  Server sends LOGOFF response                                                                      |
| **Cleanup**              |                                                                                                      |

1.  ### <span id="_Replay" class="anchor"><span id="_Toc427488146" class="anchor"></span></span>Replay

    1.  #### Test Case

|                          |                                                                                                                                       |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Replay\_WriteWithInvalidChannelSequence                                                                                          |
| **Description **         | This test case is designed to test whether server can handle the Replay request with invalid channel sequence correctly.              |
| **Prerequisites**        |                                                                                                                                       |
| **Test Execution Steps** | Via NIC1                                                                                                                              
                                                                                                                                                                   
                            1.  Start a client from main channel by sending the following requests: 1. NEGOTIATE; 2. SESSION\_SETUP; 3. TREE\_CONNECT; 4. CREATE.  
                                                                                                                                                                   
                            Via NIC2                                                                                                                               
                                                                                                                                                                   
                            1.  Start a client from alternative channel by sending NEGOTIATE request.                                                              
                                                                                                                                                                   
                            2.  The alternative client sends SESSION\_SETUP request binding by the previous session created by the main channel client.            
                                                                                                                                                                   
                            > Via NIC1                                                                                                                             
                                                                                                                                                                   
                            1.  The main channel client sends WRITE request to write content to file                                                               
                                                                                                                                                                   
                            > Via NIC1                                                                                                                             
                                                                                                                                                                   
                            1.  The main channel client sends WRITE request to write content to file.                                                              
                                                                                                                                                                   
                            2.  Tear down the main channel client by sending DISCONNECT request.                                                                   
                                                                                                                                                                   
                            > Via NIC2                                                                                                                             
                                                                                                                                                                   
                            1.  Set the channel sequence of the alternative channel client to an invalid value.                                                    
                                                                                                                                                                   
                            2.  The alternative client sends WRITE request to write content to the file created by the main channel client.                        
                                                                                                                                                                   
                            3.  Tear down the alternative channel client by sending TREE\_DISCONNECT and LOG\_OFF requests.                                        |
| **Cleanup**              |                                                                                                                                       |

|                          |                                                                                                                  |
|--------------------------|------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Replay\_ReplayCreate                                                                                        |
| **Description **         | This test case is designed to test whether server can handle Replay operation correctly.                         |
| **Prerequisites**        |                                                                                                                  |
| **Test Execution Steps** | Via NIC1                                                                                                         
                                                                                                                                              
                            Start a client from main channel, and send NEGOTIATE and SESSION\_SETUP requests via NIC2                         
                                                                                                                                              
                            Start another client from alternative channel, and send NEGOTIATE and SESSION\_SETUP requests.                    
                                                                                                                                              
                            Via NIC1                                                                                                          
                                                                                                                                              
                            1.  The main channel client sends TREE\_CONNECT request.                                                          
                                                                                                                                              
                            2.  The main channel client sends CREATE request with SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 create context.  
                                                                                                                                              
                            3.  Tear down the main channel client by sending DISCONNECT request                                               
                                                                                                                                              
                            Via NIC2                                                                                                          
                                                                                                                                              
                            Tear the alternative channel client by sending TREE\_DISCONNECT and LOG\_OFF requests.                            |
| **Cleanup**              |                                                                                                                  |

1.  ### ResilientHandle

    1.  #### Test Case

|                          |                                                                                                                                                            |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_ResilientHandle\_Reconnect                                                                                                                            |
| **Description **         | Test whether server can request a durable open when receiving FSCTL\_LMR\_REQUEST\_RESILLIENNCY successfully.                                              |
| **Prerequisites**        |                                                                                                                                                            |
| **Test Execution Steps** | 1.  Start the first client to create a file by sending the following requests: 1. NEGOTIATE; 2. SESSION\_SETUP; 3. TREE\_CONNECT                           
                                                                                                                                                                                        
                            2.  The first client sends an IOCTL FSCTL\_LMR\_REQUEST\_RESILLIENCY request.                                                                               
                                                                                                                                                                                        
                            3.  Tear down the first client by sending DISCONNECT request.                                                                                               
                                                                                                                                                                                        
                            4.  Start a second client by sending the following requests: 1. NEGOTIATE; 2. SESSION\_SETUP; 3. TREE\_CONNECT                                              
                                                                                                                                                                                        
                            5.  The second client sends CREATE request with SMB2\_CREATE\_DURABLE\_HANDLE\_RECONNECT create context to open the same file created by the first client.  
                                                                                                                                                                                        
                            6.  Tear down the second client by sending the following requests: 1. CLOSE; 2. TREE\_DISCONNECT; 3. LOG\_OFF                                               |
| **Cleanup**              |                                                                                                                                                            |

|                          |                                                                                                                                                                                                                                                 |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_ResilientHandle\_LockSequence                                                                                                                                                                                                              |
| **Description **         | This test case is designed to test whether server can handle Lock request with specified LockSequence.                                                                                                                                          |
| **Prerequisites**        |                                                                                                                                                                                                                                                 |
| **Test Execution Steps** | 1.  Start the first client to create a file by sending the following requests: 1. NEGOTIATE; 2. SESSION\_SETUP; 3. TREE\_CONNECT; 4. CREATE. The first client sends an IOCTL FSCTL\_LMR\_REQUEST\_RESILLIENCY request                           
                                                                                                                                                                                                                                                                             
                            2.  The first client sends WRITE request.                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                             
                            3.  The first client sends Flush request.                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                             
                            4.  The first client sends LOCK request with LockSequence set to (BucketNumber&lt;&lt; 4) + BucketSequence"                                                                                                                                      
                                                                                                                                                                                                                                                                             
                            5.  Start the second client to reconnect to the file created by the first client by sending the following requests: 1. NEGOTIATE; 2. SESSION\_SETUP; 3. TREE\_CONNECT; 4.CREATE (with SMB2\_CREATE\_DURABLE\_HANDLE\_RECONNECT Create Context).  
                                                                                                                                                                                                                                                                             
                            6.  The second client sends LOCK request with the same LockSequence with the first client.                                                                                                                                                       
                                                                                                                                                                                                                                                                             
                            7.  Tear down the second client by sending the following requests: 1. CLOSE; 2. TREE\_DISCONNECT; 3. LOG\_OFF                                                                                                                                    |
| **Cleanup**              |                                                                                                                                                                                                                                                 |

1.  ### <span id="_Signing" class="anchor"><span id="_Toc427488148" class="anchor"></span></span>Signing

    1.  #### Test Case

|                          |                                                                                                                                           |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Signing                                                                                                                              |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE and SESSION\_SETUP requests with NEGOTIATE\_SIGNING\_REQUIRED set. |
| **Prerequisites**        |                                                                                                                                           |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request with NEGOTIATE\_SIGNING\_REQUIRED flag set                                                             
                                                                                                                                                                       
                            2.  Server sends NEGOTIATE response                                                                                                        
                                                                                                                                                                       
                            3.  Client sends SESSION\_SETUP request NEGOTIATE\_SIGNING\_REQUIRED flag set                                                              
                                                                                                                                                                       
                            4.  Server sends SESSION\_SETUP response                                                                                                   
                                                                                                                                                                       
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed                                       |
| **Cleanup**              |                                                                                                                                           |

1.  ### TreeMgmt

    1.  #### Test Case

|                          |                                                                                                                     |
|--------------------------|---------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_TreeMgmt\_TreeConnectAndDisconnect                                                                             |
| **Description **         | This test case is designed to test whether server can handle TREE\_CONNECT and TREE\_DISCONNECT requests correctly. |
| **Prerequisites**        |                                                                                                                     |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request with NEGOTIATE\_SIGNING\_REQUIRED flag set                                       
                                                                                                                                                 
                            2.  Server sends NEGOTIATE response                                                                                  
                                                                                                                                                 
                            3.  Client sends SESSION\_SETUP request NEGOTIATE\_SIGNING\_REQUIRED flag set                                        
                                                                                                                                                 
                            4.  Server sends SESSION\_SETUP response                                                                             
                                                                                                                                                 
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed                 
                                                                                                                                                 
                            6.  Client sends TREE\_CONNECT request                                                                               
                                                                                                                                                 
                            7.  Server sends TREE\_CONNECT response                                                                              
                                                                                                                                                 
                            8.  Client sends TREE\_DISCONNECT request                                                                            
                                                                                                                                                 
                            9.  Server sends TREE\_DISCONNECT response                                                                           |
| **Cleanup**              |                                                                                                                     |

|                          |                                                                                                                                                                              |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_TreeMgmt\_SMB311\_Disconnect\_NoSignedNoEncryptedTreeConnect                                                                                                            |
| **Description **         | This test case is designed to test whether server can disconnect the connection when Connection.Dialect is 3.1.1 and the TreeConnect request is not signed or not encrypted. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request without NEGOTIATE\_SIGNING\_REQUIRED and GLOBAL\_CAP\_ENCRYPTION set and gets response.                                                   
                                                                                                                                                                                                          
                            2.  Client sends SESSION\_SETUP request without NEGOTIATE\_SIGNING\_REQUIRED flag set and gets response.                                                                      
                                                                                                                                                                                                          
                            3.  Client sends TREE\_CONNECT request which is not signed or not encrypted and expects server disconnects the connection.                                                    |
| **Cleanup**              |                                                                                                                                                                              |

1.  ### <span id="_SessionMgmt" class="anchor"><span id="_Toc427488150" class="anchor"></span></span>SessionMgmt

    1.  #### Test Case

|                          |                                                                             |
|--------------------------|-----------------------------------------------------------------------------|
| **Test ID**              | BVT\_SessionMgmt\_NewSession                                                |
| **Description **         | This test case is designed to test whether server can handle a new session. |
| **Prerequisites**        |                                                                             |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request                                          
                                                                                                         
                            2.  Server sends NEGOTIATE response                                          
                                                                                                         
                            3.  Client sends SESSION\_SETUP request with sessionid set zero              
                                                                                                         
                            4.  Server sends SESSION\_SETUP response                                     |
| **Cleanup**              |                                                                             |

|                          |                                                                                                                     |
|--------------------------|---------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_SessionMgmt\_ReconnectSessionSetup                                                                             |
| **Description **         | This test case is designed to test whether server can handle authentication after disconnection                     |
| **Prerequisites**        |                                                                                                                     |
| **Test Execution Steps** | 1.  Client1 sends NEGOTIATE request                                                                                 
                                                                                                                                                 
                            2.  Server sends NEGOTIATE response                                                                                  
                                                                                                                                                 
                            3.  Client1 sends SESSION\_SETUP request with sessionid set zero                                                     
                                                                                                                                                 
                            4.  Server sends SESSION\_SETUP response                                                                             
                                                                                                                                                 
                            5.  Client1 disconnect.                                                                                              
                                                                                                                                                 
                            6.  Client2 sends NEGOTIATE request                                                                                  
                                                                                                                                                 
                            7.  Server sends NEGOTIATE response                                                                                  
                                                                                                                                                 
                            8.  Client2 sends SESSION\_SETUP request with SESSION\_ID set to the value in the previous SESSION\_SETUP response.  
                                                                                                                                                 
                            9.  Client2 disconnect.                                                                                              |
| **Cleanup**              |                                                                                                                     |

| **Test ID**               | BVT\_SessionMgmt\_Reauthentication                                                                            |
|---------------------------|---------------------------------------------------------------------------------------------------------------|
| **Description**           | This test case is designed to test whether server can handle reauthentication successfully.                   |
| **Test Execution Steps ** | Client sends NEGOTIATE request.                                                                               
                                                                                                                                            
                             Client sends SESSION\_SETUP request with SESSION\_ID set to ZERO.                                              
                                                                                                                                            
                             Client sends SESSION-SETUP request with SESSION\_ID set to the value in the previous SESSION\_SETUP response.  
                                                                                                                                            
                             Check server response.                                                                                         |
| **Cleanup**               |                                                                                                               |

1.  ### <span id="_KerberosAuthentication" class="anchor"><span id="_Toc387924530" class="anchor"><span id="_Toc387924717" class="anchor"><span id="_Toc387924531" class="anchor"><span id="_Toc387924718" class="anchor"><span id="_Toc387924558" class="anchor"><span id="_Toc387924745" class="anchor"><span id="_Toc358299326" class="anchor"><span id="_Toc358299327" class="anchor"><span id="_Toc358299328" class="anchor"><span id="_Toc358294958" class="anchor"><span id="_Toc358299329" class="anchor"><span id="_Toc358294973" class="anchor"><span id="_Toc358299344" class="anchor"><span id="_Toc358294974" class="anchor"><span id="_Toc358299345" class="anchor"><span id="_Toc358294992" class="anchor"><span id="_Toc358299363" class="anchor"><span id="_Toc358299371" class="anchor"><span id="_Toc358317490" class="anchor"><span id="_Toc325716434" class="anchor"><span id="_Toc325719157" class="anchor"><span id="_Toc325719623" class="anchor"><span id="_Toc325719931" class="anchor"><span id="_Toc325720239" class="anchor"><span id="_CreateClose" class="anchor"><span id="_Toc427488151" class="anchor"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>CreateClose

    1.  #### Test Case

|                      |                                                                                                           |
|----------------------|-----------------------------------------------------------------------------------------------------------|
| **Test ID**          | BVT\_CreateClose\_CreateAndCloseFile                                                                      |
| **Description**      | This case is designed to test whether server can handle Create and Delete operations on file correctly.   |
| **Message Sequence** | NEGOTIATE                                                                                                 
                                                                                                                                   
                        SESSION\_SETUP                                                                                             
                                                                                                                                   
                        TREE\_CONNECT                                                                                              
                                                                                                                                   
                        CREATE (CreateOption: FILE\_NON\_DIRECTORY\_FILE; CreateDisposition: FILE\_CREATE)                         
                                                                                                                                   
                        CLOSE                                                                                                      
                                                                                                                                   
                        TREE\_DISCONNECT                                                                                           
                                                                                                                                   
                        LOGOFF                                                                                                     
                                                                                                                                   
                        NEGOTIATE                                                                                                  
                                                                                                                                   
                        SESSION\_SETUP                                                                                             
                                                                                                                                   
                        TREE\_CONNECT                                                                                              
                                                                                                                                   
                        CREATE (CreateOption: FILE\_NON\_DIRECTORY\_FILE| FILE\_DELETE\_ON\_CLOSE; CreateDisposition: FILE\_OPEN)  
                                                                                                                                   
                        CLOSE                                                                                                      
                                                                                                                                   
                        TREE\_DISCONNECT                                                                                           
                                                                                                                                   
                        LOGOFF                                                                                                     |

|                      |                                                                                                              |
|----------------------|--------------------------------------------------------------------------------------------------------------|
| **Test ID**          | BVT\_CreateClose\_CreateAndCloseDirectory                                                                    |
| **Description**      | This case is designed to test whether server can handle Create and Delete operations on directory correctly. |
| **Message Sequence** | NEGOTIATE                                                                                                    
                                                                                                                                      
                        SESSION\_SETUP                                                                                                
                                                                                                                                      
                        TREE\_CONNECT                                                                                                 
                                                                                                                                      
                        CREATE (CreateOption: FILE\_DIRECTORY\_FILE; CreateDisposition: FILE\_CREATE)                                 
                                                                                                                                      
                        CLOSE                                                                                                         
                                                                                                                                      
                        TREE\_DISCONNECT                                                                                              
                                                                                                                                      
                        LOGOFF                                                                                                        
                                                                                                                                      
                        NEGOTIATE                                                                                                     
                                                                                                                                      
                        SESSION\_SETUP                                                                                                
                                                                                                                                      
                        TREE\_CONNECT                                                                                                 
                                                                                                                                      
                        CREATE (CreateOption: FILE\_DIRECTORY\_FILE| FILE\_DELETE\_ON\_CLOSE; CreateDisposition: FILE\_OPEN)          
                                                                                                                                      
                        CLOSE                                                                                                         
                                                                                                                                      
                        TREE\_DISCONNECT                                                                                              
                                                                                                                                      
                        LOGOFF                                                                                                        |

1.  ### Compound

    1.  #### Test Case

|                      |                                                                    |
|----------------------|--------------------------------------------------------------------|
| **Test ID**          | BVT\_Compound\_RelatedRequests                                     |
| **Message Sequence** | NEGOTIATE                                                          
                                                                                            
                        SESSION\_SETUP                                                      
                                                                                            
                        TREE\_CONNECT                                                       
                                                                                            
                        COMPOUND related request (CREATE, WRITE, and CLOSE to a same file)  
                                                                                            
                        Verify COMPOUND response                                            
                                                                                            
                        TREEDISCONNECT                                                      
                                                                                            
                        LOGOFF                                                              |

|                      |                                                                         |
|----------------------|-------------------------------------------------------------------------|
| **Test ID**          | BVT\_Compound\_UnrelatedRequests                                        |
| **Message Sequence** | NEGOTIATE                                                               
                                                                                                 
                        SESSION\_SETUP                                                           
                                                                                                 
                        TREE\_CONNECT                                                            
                                                                                                 
                        COMPOUND unrelated request (two CREATE requests to two different files)  
                                                                                                 
                        Verify responses to the COMPOUND request                                 
                                                                                                 
                        TREEDISCONNECT                                                           
                                                                                                 
                        LOGOFF                                                                   |

1.  ### ValidateNegotiateInfo

    1.  #### Scenario

|                               |                                                 |
|-------------------------------|-------------------------------------------------|
| **Description**               | Request validation of a previous SMB2 NEGOTIATE |
| **Message Sequence**          | NEGOTIATE                                       
                                                                                  
                                 SESSION\_SETUP                                   
                                                                                  
                                 TREE\_CONNECT                                    
                                                                                  
                                 IOCTL: FSCTL\_VALIDATE\_NEGOTIATE\_INFO          
                                                                                  
                                 Expect success or disconnection                  
                                                                                  
                                 TREE\_DISCONNECT (optional)                      
                                                                                  
                                 LOGOFF (optional)                                |
| **Cluster Involved Scenario** | **NO**                                          |

#### Test Case

|                          |                                                                        |
|--------------------------|------------------------------------------------------------------------|
| **Test ID**              | BVT\_ValidateNegotiateInfo                                             |
| **Description **         | Test whether server can handle IOCTL FSCTL\_VALIDATE\_NEGOTIATE\_INFO. |
| **Prerequisites**        |                                                                        |
| **Test Execution Steps** | NEGOTIATE                                                              
                                                                                                    
                            SESSION\_SETUP                                                          
                                                                                                    
                            TREE\_CONNECT                                                           
                                                                                                    
                            IOCTL (with valid FSCTL\_VALIDATE\_NEGOTIATE\_INFO)                     
                                                                                                    
                            Expected success in IOCTL response                                      
                                                                                                    
                            TREE\_DISCONNECT                                                        
                                                                                                    
                            LOGOFF                                                                  |
| **Cleanup**              |                                                                        |

SMB2 Feature Test
-----------------

Test scenarios are prioritized and designed based on customer interests and SMB3 new features.

### <span id="_Toc365033851" class="anchor"><span id="_Toc427488155" class="anchor"></span></span>AppInstanceId

Allow an application to failover on a new client and open a file that was previously opened using an application instance identifier.

1.  #### Model

    1.  ##### Coverage

**AppInstanceId** Model covers all statements of the following sections:

-   3.3.5.9.13 Handling the SMB2\_CREATE\_APP\_INSTANCE\_ID Create Context

-   2.2.13.2.13 SMB2\_CREATE\_APP\_INSTANCE\_ID

    1.  ##### Assumptions/Restrictions

N/A

##### Scenario Design 

| **Scenario Name** | AppInstanceId                                                                                                            |
|-------------------|--------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Basic scenario:                                                                                                          
                                                                                                                                               
                     Create an open first with/without AppInstanceId, then send create request again to see if the open can be closed or not.  |
| **Machine**       | ReadConfig;                                                                                                              
                                                                                                                                               
                     PrepareOpen;                                                                                                              
                                                                                                                                               
                     OpenRequest;                                                                                                              
                                                                                                                                               
                     OpenResponse;                                                                                                             |

#### Traditional Case

Scenario see [section 3.1.15.1](#scenario-13)

|                          |                                                                                                     |
|--------------------------|-----------------------------------------------------------------------------------------------------|
| **Test ID**              | Negative\_AppInstanceId\_DifferentAppInstanceIdAfterFailover                                        |
| **Description **         | Open a file with a different AppInstanceId after failover so that server treat the open differently |
| **Prerequisites**        |                                                                                                     |
| **Test Execution Steps** | Based on NIC1, create Client1:                                                                      
                                                                                                                                 
                            NEGOTIATE                                                                                            
                                                                                                                                 
                            SESSION\_SETUP                                                                                       
                                                                                                                                 
                            TREE\_CONNECT                                                                                        
                                                                                                                                 
                            CREATE (With AppInstanaceID)                                                                         
                                                                                                                                 
                            WRITE                                                                                                
                                                                                                                                 
                            Disable NIC1                                                                                         
                                                                                                                                 
                            Switch to NIC2 and create Client2:                                                                   
                                                                                                                                 
                            NEGOTIATE                                                                                            
                                                                                                                                 
                            SESSION\_SETUP                                                                                       
                                                                                                                                 
                            TREE\_CONNECT                                                                                        
                                                                                                                                 
                            CREATE (With a different AppInstanceID)                                                              
                                                                                                                                 
                            Expect error in CREATE response                                                                      
                                                                                                                                 
                            TREE\_DISCONNECT                                                                                     
                                                                                                                                 
                            LOGOFF                                                                                               |
| **Cleanup**              | Enable NIC1                                                                                         |

|                          |                                                                                                                                                                   |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AppInstanceId\_Negative\_DifferentAppInstanceIdInReopen                                                                                                           |
| **Description **         | This test case is designed to check that if a client fails over to a new client, whether the previously opened file can be reopened with different AppInstanceId. |
| **Prerequisites**        |                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Client1 sends the following requests: NEGOTIATE; SESSION\_SETUP; TREE\_CONNECT                                                                                
                                                                                                                                                                                               
                            2.  Server responses successfully.                                                                                                                                 
                                                                                                                                                                                               
                            3.  Client1 sends CREATE request with the contexts of SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 and SMB2\_CREATE\_APP\_INSTANCE\_ID.                              
                                                                                                                                                                                               
                            4.  Server responses successfully.                                                                                                                                 
                                                                                                                                                                                               
                            5.  Client2 sends the following requests:                                                                                                                          
                                                                                                                                                                                               
                            > NEGOTIATE; SESSION\_SETUP; TREE\_CONNECT                                                                                                                         
                                                                                                                                                                                               
                            1.  Server responses successfully.                                                                                                                                 
                                                                                                                                                                                               
                            2.  Client2 sends CREATE request to the same file with client1, and with SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 and different AppInstanceId.                   
                                                                                                                                                                                               
                            3.  Client1 sends WRITE request to write content.                                                                                                                  
                                                                                                                                                                                               
                            4.  Server responses successfully.                                                                                                                                 
                                                                                                                                                                                               
                            5.  Tear down client1.                                                                                                                                             
                                                                                                                                                                                               
                            6.  Tear down client2.                                                                                                                                             |
| **Cleanup**              | Enable NIC1                                                                                                                                                       |

|                          |                                                                                                                                                                                                                                                       |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AppInstanceId\_Smb311                                                                                                                                                                                                                                 |
| **Description **         | The case is designed to test if the server implements dialect 3.11, and when client fails over to a new client, the previous open can be closed by the new client with the same AppInstanceId. AppInstanceId should work without DH2Q create context. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Client1 sends NEGOTIATE request with dialect 3.11 and gets NEGOTIATE response also with dialect 3.11.                                                                                                                                             
                                                                                                                                                                                                                                                                                   
                            2.  Client1 sends the following requests: SESSION\_SETUP; TREE\_CONNECT.                                                                                                                                                                               
                                                                                                                                                                                                                                                                                   
                            3.  Server responses successfully.                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                   
                            4.  Client1 sends CREATE request with the context SMB2\_CREATE\_APP\_INSTANCE\_ID, without DH2Q create context.                                                                                                                                        
                                                                                                                                                                                                                                                                                   
                            5.  Server responses successfully.                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                   
                            6.  Client2 sends the following requests:                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                   
                            > NEGOTIATE; SESSION\_SETUP; TREE\_CONNECT.                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                   
                            1.  Server responses successfully.                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                   
                            2.  Client2 sends CREATE request to the same file with client1, and same AppInstanceId, and without DH2Q create context. Client2 should create the open successfully.                                                                                  
                                                                                                                                                                                                                                                                                   
                            3.  The first client sends another WRITE request and gets failure because the open is closed.                                                                                                                                                          
                                                                                                                                                                                                                                                                                   
                            4.  Tear down client1.                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                   
                            5.  Tear down client2.                                                                                                                                                                                                                                 |
| **Cleanup**              |                                                                                                                                                                                                                                                       |

1.  ### <span id="_Toc427488156" class="anchor"><span id="_Toc365033852" class="anchor"></span></span>AppInstanceVersion

    1.  #### Scenario

See section [3.1.14.1](#scenario-14).

#### Test Case

|                          |                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Negative\_AppInstanceVersion\_SMB311\_NoVersion                                                                        |
| **Description **         | Check when client fails over to a new client, the previous opened file can NOT be reopened with no AppInstanceVersion. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                    |
| **Test Execution Steps** | 1.  Start the first client by sending the following requests: NEGOTIATE; SESSION\_SETUP; TREE\_CONNECT.                
                                                                                                                                                    
                            2.  The first client sends CREATE request with AppInstanceVersionHigh = 1, AppInstanceVersionLow = 0.                   
                                                                                                                                                    
                            3.  Start the second client by sending the following requests: NEGOTIATE; SESSIONSETUP; TREE\_CONNECT.                  
                                                                                                                                                    
                            4.  The second client sends CREATE request without AppInstanceVersion and gets failure.                                 
                                                                                                                                                    
                            5.  Client1 sends another WRITE request and succeeds since the open is not closed.                                      
                                                                                                                                                    
                            6.  Tear down the two clients by sending the following requests: CLOSE; TREE\_DISCONNECT; LOG\_OFF; DISCONNECT          |
| **Cleanup**              |                                                                                                                        |

|                          |                                                                                                                                          |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AppInstanceVersion\_SMB311\_SMB302                                                                                                       |
| **Description **         | Check if server can fail the create request if the second client send a create request with dialect302 and AppInstanceID create context. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                      |
| **Test Execution Steps** | 1.  Start the first client by sending the following requests: NEGOTIATE with dialect 3.11; SESSION\_SETUP; TREE\_CONNECT.                
                                                                                                                                                                      
                            2.  The first client sends CREATE request with AppInstanceVersionHigh = 1, AppInstanceVersionLow = 0.                                     
                                                                                                                                                                      
                            3.  Start the second client by sending the following requests: NEGOTIATE with dialect 3.02; SESSIONSETUP; TREE\_CONNECT.                  
                                                                                                                                                                      
                            4.  The second client sends CREATE request with a valid AppInstanceId, but no AppInstanceVersion, and gets failure.                       
                                                                                                                                                                      
                            5.  Client1 sends another WRITE request and succeeds since the open is not closed.                                                        
                                                                                                                                                                      
                            6.  Tear down the two clients by sending the following requests: CLOSE; TREE\_DISCONNECT; LOG\_OFF; DISCONNECT                            |
| **Cleanup**              |                                                                                                                                          |

|                          |                                                                                                                                                                                                                       |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AppInstanceVersion\_SMB302\_SMB311                                                                                                                                                                                    |
| **Description **         | Check when the first client negotiates dialect 3.02, the second client negotiates dialect 3.11, the create request with SMB2\_CREATE\_APP\_INSTANCE\_VERSION create context sent by the second client should succeed. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Start the first client by sending the following requests: NEGOTIATE with dialect 3.02; SESSION\_SETUP; TREE\_CONNECT.                                                                                             
                                                                                                                                                                                                                                                   
                            2.  The first client sends CREATE request with an AppInstanceId context.                                                                                                                                               
                                                                                                                                                                                                                                                   
                            3.  Start the second client by sending the following requests: NEGOTIATE with dialect 3.11; SESSIONSETUP; TREE\_CONNECT.                                                                                               
                                                                                                                                                                                                                                                   
                            4.  The second client sends CREATE request with a valid AppInstanceId and AppInstanceVersion and succeeds.                                                                                                             
                                                                                                                                                                                                                                                   
                            5.  Client1 sends another WRITE request and gets failure since the open is closed.                                                                                                                                     
                                                                                                                                                                                                                                                   
                            6.  Tear down the two clients by sending the following requests: CLOSE; TREE\_DISCONNECT; LOG\_OFF; DISCONNECT                                                                                                         |
| **Cleanup**              |                                                                                                                                                                                                                       |

### CreateClose

Client uses create operation to request either creation or access to a file, and uses close to close a file that was opened previously with a successful create.

The feature has 34 model-based test cases and several traditional test cases.

1.  ####  Model

    1.  ##### Coverage

**CreateClose** Model covers all statements (except which are mentioned in “Assumptions/Restrictions”) of the following sections:

-   3.3.5.9 Receiving an SMB2 CREATE Request

-   3.3.5.10 Receiving an SMB2 CLOSE Request

-   2.2.13 SMB2 CREATE Request

-   2.2.14 SMB2 CREATE Response

-   2.2.15 SMB2 CLOSE Request

-   2.2.16 SMB2 CLOSE Response

    1.  ##### Assumptions/Restrictions

<!-- -->

-   This model doesn’t test all the flag combination of fields FileAttributes/ShareAccess/CreateDisposition/CreateOptions of CREATE Request. It picks the ones mentioned in “section 3.3.5.9 Receiving an SMB2 CREATE Request”.

-   This model doesn’t test create contexts. The create contexts are tested in individual Feature Tests.

    1.  ##### Scenario Design

| **Scenario Name** | CreateClose                                                                     |
|-------------------|---------------------------------------------------------------------------------|
| **Description**   | Basic scenario to test how the server handles CREATE Request and CLOSE Request. |
| **Machine**       |  ReadConfig;                                                                    
                                                                                                      
                      SetupConnection; //Negotiate, Session Setup, Tree Connect                       
                                                                                                      
                      CreateRequest;                                                                  
                                                                                                      
                      CreateResponse;                                                                 
                                                                                                      
                      (                                                                               
                                                                                                      
                          CloseRequest;                                                               
                                                                                                      
                          CloseResponse;                                                              
                                                                                                      
                      )\*;                                                                            |

#### Traditional Case

Scenario see [section 3.1.23](#_Toc387924530)

|                      |                                                                                                                                |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**          | CreateClose\_SymbolicLinkInMiddle                                                                                              |
| **Description**      | This case is designed to test whether server can handle Create operation with symbolic link in middle of file path.            |
| **Message Sequence** | NEGOTIATE                                                                                                                      
                                                                                                                                                        
                        SESSION\_SETUP                                                                                                                  
                                                                                                                                                        
                        TREE\_CONNECT                                                                                                                   
                                                                                                                                                        
                        CREATE (CreateOption: FILE\_DIRECTORY\_FILE; CreateDisposition: FILE\_CREATE, file name contains symbolic link in the middle.)  
                                                                                                                                                        
                        Expect server failed with STATUS\_STOPPED\_ON\_SYMLINK.                                                                         
                                                                                                                                                        
                        CLOSE                                                                                                                           
                                                                                                                                                        
                        TREE\_DISCONNECT                                                                                                                
                                                                                                                                                        
                        LOGOFF                                                                                                                          |

|                      |                                                                                                                                           |
|----------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**          | CreateClose\_SymbolicLinkAtLast                                                                                                           |
| **Description**      | This case is designed to test whether server can handle Create operation with symbolic link at last of file path.                         |
| **Message Sequence** | NEGOTIATE                                                                                                                                 
                                                                                                                                                                   
                        SESSION\_SETUP                                                                                                                             
                                                                                                                                                                   
                        TREE\_CONNECT                                                                                                                              
                                                                                                                                                                   
                        CREATE (CreateOption: FILE\_DIRECTORY\_FILE; CreateDisposition: FILE\_CREATE, file name contains symbolic link in the last of file path.)  
                                                                                                                                                                   
                        Expect server failed with STATUS\_STOPPED\_ON\_SYMLINK.                                                                                    
                                                                                                                                                                   
                        CLOSE                                                                                                                                      
                                                                                                                                                                   
                        TREE\_DISCONNECT                                                                                                                           
                                                                                                                                                                   
                        LOGOFF                                                                                                                                     |

|                      |                                                                                                                                |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**          | CreateClose\_InvalidSymbolicLink                                                                                               |
| **Description**      | This case is designed to test whether server can handle Create operation with other invalid symbolic link.                     |
| **Message Sequence** | NEGOTIATE                                                                                                                      
                                                                                                                                                        
                        SESSION\_SETUP                                                                                                                  
                                                                                                                                                        
                        TREE\_CONNECT                                                                                                                   
                                                                                                                                                        
                        CREATE (CreateOption: FILE\_DIRECTORY\_FILE; CreateDisposition: FILE\_CREATE, file name contains symbolic link in the middle.)  
                                                                                                                                                        
                        Expect server failed with STATUS\_STOPPED\_ON\_SYMLINK.                                                                         
                                                                                                                                                        
                        CLOSE                                                                                                                           
                                                                                                                                                        
                        TREE\_DISCONNECT                                                                                                                
                                                                                                                                                        
                        LOGOFF                                                                                                                          |

|                      |                                                                                                                                          |
|----------------------|------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**          | CreateClose\_DeleteFile\_DesiredAccessNotIncludeDeleteOrGenericAll                                                                       |
| **Description**      | This case is designed to test whether server can handle delete file request when desired access does not include DELETE or GENERIC\_ALL. |
| **Message Sequence** | NEGOTIATE                                                                                                                                
                                                                                                                                                                  
                        SESSION\_SETUP                                                                                                                            
                                                                                                                                                                  
                        TREE\_CONNECT                                                                                                                             
                                                                                                                                                                  
                        CREATE (CreateOption: FILE\_DIRECTORY\_FILE; CreateDisposition: FILE\_CREATE, file name contains symbolic link in the middle.)            
                                                                                                                                                                  
                        Expect server failed with specific error code according to server’s implementation.                                                       
                                                                                                                                                                  
                        CLOSE                                                                                                                                     
                                                                                                                                                                  
                        TREE\_DISCONNECT                                                                                                                          
                                                                                                                                                                  
                        LOGOFF                                                                                                                                    |

|                      |                                                                                        |
|----------------------|----------------------------------------------------------------------------------------|
| **Test ID**          | InvalidCreateRequestStructureSize                                                      |
| **Description**      | Test the server response when it receives an invalid structure size of CREATE request. |
| **Message Sequence** | NEGOTIATE                                                                              
                                                                                                                
                        SESSION\_SETUP                                                                          
                                                                                                                
                        TREE\_CONNECT                                                                           
                                                                                                                
                        CREATE with invalid structure size.                                                     
                                                                                                                
                        Expect server sends error response STATUS\_INVALID\_PARAMETER.                          
                                                                                                                
                        CLOSE                                                                                   
                                                                                                                
                        TREE\_DISCONNECT                                                                        
                                                                                                                
                        LOGOFF                                                                                  |

### <span id="_Toc365033853" class="anchor"><span id="_Toc427488158" class="anchor"></span></span>CreditMgmt

**CreditMgmt** model verify that server handles the request correctly when client sends READ (for response payload verification)/WRITE (for request payload verification) requests with different MessageId, CreditCharge, CreditRequest and payload length.

This feature contains 49 model-based test cases.

1.  #### Model

    1.  ##### Coverage

**CreditMgmt** model covers the statements in following sections with exceptions mentioned in Assumptions/Restrictions section

-   3.3.1.1 Algorithm for Handling Available Message Sequence Numbers by the Server

-   3.3.1.2 Algorithm for the Granting of Credits

-   3.3.4.1.2 Granting Credits to the Client

-   3.3.5.2.3 Verifying the Sequence Number

-   3.3.5.2.5 Verifying the Credit Charge and the Payload Size

    1.  ##### Assumptions/Restrictions

<!-- -->

-   The model assumes the situation that the underlying connection supports multi-credit request (i.e. no NetBIOS transport used)

-   The model does not cover credit verification for async/compounded/cancel requests

    1.  ##### Scenario Design

| **Scenario Name** | CreditMgmt                                                                                                                                                         |
|-------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | This scenario covers basic message sequence with various MessageId, CreditCharge, CreditRequest and payload length to test server behavior of credit verification. |
| **Machine**       | ReadConfig;                                                                                                                                                        
                                                                                                                                                                                         
                     SetupConnection; //Negotiate,SessionSetup,TreeConnect,Create                                                                                                        
                                                                                                                                                                                         
                     (                                                                                                                                                                   
                                                                                                                                                                                         
                         CreditOperationRequest;                                                                                                                                         
                                                                                                                                                                                         
                         CreditOperationResponse?; ExpectDisconnect?;                                                                                                                    
                                                                                                                                                                                         
                     );                                                                                                                                                                  |

1.  ### <span id="_Toc387924611" class="anchor"><span id="_Toc387924798" class="anchor"><span id="_Toc358294893" class="anchor"><span id="_Toc358299260" class="anchor"><span id="_Toc358294907" class="anchor"><span id="_Toc358299274" class="anchor"><span id="_Toc358294913" class="anchor"><span id="_Toc358299280" class="anchor"><span id="_Toc358294914" class="anchor"><span id="_Toc358299281" class="anchor"><span id="_Toc358294915" class="anchor"><span id="_Toc358299282" class="anchor"><span id="_Toc358294916" class="anchor"><span id="_Toc358299283" class="anchor"><span id="_Toc358294919" class="anchor"><span id="_Toc358299286" class="anchor"><span id="_Toc358294934" class="anchor"><span id="_Toc358299301" class="anchor"><span id="_Toc358294935" class="anchor"><span id="_Toc358299302" class="anchor"><span id="_Toc358294953" class="anchor"><span id="_Toc358299320" class="anchor"><span id="_Toc387924612" class="anchor"><span id="_Toc387924799" class="anchor"><span id="_Toc365033854" class="anchor"><span id="_Toc427488159" class="anchor"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>DirectoryLeasing

    1.  #### Basic

        1.  ##### Scenario

See [section 3.1.13.1.1](#scenario-10)

##### Test Case

|                          |                                                                                                                                         |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_ReadCaching                                                                                                           |
| **Description **         | Ensure server could handle read directory leasing correctly                                                                             |
| **Prerequisites**        |                                                                                                                                         |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request                                                                                                      
                                                                                                                                                                     
                            2.  Server sends NEGOTIATE response                                                                                                      
                                                                                                                                                                     
                            3.  Client sends SESSION\_SETUP request                                                                                                  
                                                                                                                                                                     
                            4.  Server sends SESSION\_SETUP response                                                                                                 
                                                                                                                                                                     
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed                                     
                                                                                                                                                                     
                            6.  Client sends TREE\_CONNECT request                                                                                                   
                                                                                                                                                                     
                            7.  Server sends TREE\_CONNECT response                                                                                                  
                                                                                                                                                                     
                            8.  Client sends CREATE request for a directory with SMB2\_CREATE\_REQUEST\_LEASE\_V2, LeaseState setting to SMB2\_LEASE\_READ\_CACHING  
                                                                                                                                                                     
                            9.  Server sends CREATE response                                                                                                         
                                                                                                                                                                     
                            10. Write to the directory with another client                                                                                           
                                                                                                                                                                     
                            11. Server sends LEASE\_BREAK notification                                                                                               
                                                                                                                                                                     
                            12. Client sends LEASE\_BREAK acknowledgement                                                                                            
                                                                                                                                                                     
                            13. Server sends LEASE\_BREAK response                                                                                                   
                                                                                                                                                                     
                            14. Client sends CLOSE request                                                                                                           
                                                                                                                                                                     
                            15. Server sends CLOSE response                                                                                                          
                                                                                                                                                                     
                            16. Client sends TREE\_DISCONNECT request                                                                                                
                                                                                                                                                                     
                            17. Server sends TREE\_DISCONNECT response                                                                                               
                                                                                                                                                                     
                            18. Client sends LOGOFF request                                                                                                          
                                                                                                                                                                     
                            19. Server sends LOGOFF response                                                                                                         |
| **Cleanup**              |                                                                                                                                         |

|                          |                                                                                                                                                                       |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_ReadWriteCaching                                                                                                                                    |
| **Description **         | Ensure server could handle READ\_WRITE directory leasing correctly                                                                                                    |
| **Prerequisites**        |                                                                                                                                                                       |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request                                                                                                                                    
                                                                                                                                                                                                   
                            2.  Server sends NEGOTIATE response                                                                                                                                    
                                                                                                                                                                                                   
                            3.  Client sends SESSION\_SETUP request                                                                                                                                
                                                                                                                                                                                                   
                            4.  Server sends SESSION\_SETUP response                                                                                                                               
                                                                                                                                                                                                   
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed                                                                   
                                                                                                                                                                                                   
                            6.  Client sends TREE\_CONNECT request                                                                                                                                 
                                                                                                                                                                                                   
                            7.  Server sends TREE\_CONNECT response                                                                                                                                
                                                                                                                                                                                                   
                            8.  Client sends CREATE request for a directory with SMB2\_CREATE\_REQUEST\_LEASE\_V2, LeaseState setting to SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_WRITE\_CACHING  
                                                                                                                                                                                                   
                            9.  Server sends CREATE response                                                                                                                                       
                                                                                                                                                                                                   
                            10. Read the directory content with another client                                                                                                                     
                                                                                                                                                                                                   
                            11. Server sends LEASE\_BREAK notification                                                                                                                             
                                                                                                                                                                                                   
                            12. Client sends LEASE\_BREAK acknowledgement                                                                                                                          
                                                                                                                                                                                                   
                            13. Server sends LEASE\_BREAK response                                                                                                                                 
                                                                                                                                                                                                   
                            14. Client sends CLOSE request                                                                                                                                         
                                                                                                                                                                                                   
                            15. Server sends CLOSE response                                                                                                                                        
                                                                                                                                                                                                   
                            16. Client sends TREE\_DISCONNECT request                                                                                                                              
                                                                                                                                                                                                   
                            17. Server sends TREE\_DISCONNECT response                                                                                                                             
                                                                                                                                                                                                   
                            18. Client sends LOGOFF request                                                                                                                                        
                                                                                                                                                                                                   
                            19. Server sends LOGOFF response                                                                                                                                       |
| **Cleanup**              |                                                                                                                                                                       |

|                          |                                                                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_ReadHandleCaching                                                                                                                                    |
| **Description **         | Ensure server could handle READ\_HANDLE directory leasing correctly                                                                                                    |
| **Prerequisites**        |                                                                                                                                                                        |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request                                                                                                                                     
                                                                                                                                                                                                    
                            2.  Server sends NEGOTIATE response                                                                                                                                     
                                                                                                                                                                                                    
                            3.  Client sends SESSION\_SETUP request                                                                                                                                 
                                                                                                                                                                                                    
                            4.  Server sends SESSION\_SETUP response                                                                                                                                
                                                                                                                                                                                                    
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed                                                                    
                                                                                                                                                                                                    
                            6.  Client sends TREE\_CONNECT request                                                                                                                                  
                                                                                                                                                                                                    
                            7.  Server sends TREE\_CONNECT response                                                                                                                                 
                                                                                                                                                                                                    
                            8.  Client sends CREATE request for a directory with SMB2\_CREATE\_REQUEST\_LEASE\_V2, LeaseState setting to SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING  
                                                                                                                                                                                                    
                            9.  Server sends CREATE response                                                                                                                                        
                                                                                                                                                                                                    
                            10. Delete the directory with another client                                                                                                                            
                                                                                                                                                                                                    
                            11. Server sends LEASE\_BREAK notification                                                                                                                              
                                                                                                                                                                                                    
                            12. Client sends LEASE\_BREAK acknowledgement                                                                                                                           
                                                                                                                                                                                                    
                            13. Server sends LEASE\_BREAK response                                                                                                                                  
                                                                                                                                                                                                    
                            14. Client sends CLOSE request                                                                                                                                          
                                                                                                                                                                                                    
                            15. Server sends CLOSE response                                                                                                                                         
                                                                                                                                                                                                    
                            16. Client sends TREE\_DISCONNECT request                                                                                                                               
                                                                                                                                                                                                    
                            17. Server sends TREE\_DISCONNECT response                                                                                                                              
                                                                                                                                                                                                    
                            18. Client sends LOGOFF request                                                                                                                                         
                                                                                                                                                                                                    
                            19. Server sends LOGOFF response                                                                                                                                        |
| **Cleanup**              |                                                                                                                                                                        |

|                          |                                                                                                                                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Negative\_DirectoryLeasing\_SMB21                                                                                                                                                                    |
| **Description **         | Negative test case to test SMB3 directory leasing feature using SMB2.1 dialect.                                                                                                                      |
| **Prerequisites**        |                                                                                                                                                                                                      |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request with dialect SMB2.002 and SMB2.1.                                                                                                                                 
                                                                                                                                                                                                                                  
                            2.  Server sends NEGOTIATE response with dialect SMB2.1                                                                                                                                               
                                                                                                                                                                                                                                  
                            3.  Client sends SESSION\_SETUP request                                                                                                                                                               
                                                                                                                                                                                                                                  
                            4.  Server sends SESSION\_SETUP response                                                                                                                                                              
                                                                                                                                                                                                                                  
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed                                                                                                  
                                                                                                                                                                                                                                  
                            6.  Client sends TREE\_CONNECT request                                                                                                                                                                
                                                                                                                                                                                                                                  
                            7.  Server sends TREE\_CONNECT response                                                                                                                                                               
                                                                                                                                                                                                                                  
                            8.  Client sends CREATE request for a directory with SMB2\_CREATE\_REQUEST\_LEASE\_V2, LeaseState setting to SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_WRITE\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING  
                                                                                                                                                                                                                                  
                            9.  Server sends CREATE response                                                                                                                                                                      
                                                                                                                                                                                                                                  
                            10. Write to the directory with another client                                                                                                                                                        
                                                                                                                                                                                                                                  
                            11. Server sends LEASE\_BREAK notification                                                                                                                                                            
                                                                                                                                                                                                                                  
                            12. Client sends LEASE\_BREAK acknowledgement                                                                                                                                                         
                                                                                                                                                                                                                                  
                            13. Server sends LEASE\_BREAK response                                                                                                                                                                
                                                                                                                                                                                                                                  
                            14. Client sends CLOSE request                                                                                                                                                                        
                                                                                                                                                                                                                                  
                            15. Server sends CLOSE response                                                                                                                                                                       
                                                                                                                                                                                                                                  
                            16. Client sends TREE\_DISCONNECT request                                                                                                                                                             
                                                                                                                                                                                                                                  
                            17. Server sends TREE\_DISCONNECT response                                                                                                                                                            
                                                                                                                                                                                                                                  
                            18. Client sends LOGOFF request                                                                                                                                                                       
                                                                                                                                                                                                                                  
                            19. Server sends LOGOFF response                                                                                                                                                                      |
| **Cleanup**              |                                                                                                                                                                                                      |

|                          |                                                                                                                                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Negative\_DirectoryLeasing\_SMB2002                                                                                                                                                                  |
| **Description **         | Negative test case to test SMB3 directory leasing feature using SMB2.002 dialect.                                                                                                                    |
| **Prerequisites**        |                                                                                                                                                                                                      |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request with only SMB2.002 dialect.                                                                                                                                       
                                                                                                                                                                                                                                  
                            2.  Server sends NEGOTIATE response with dialect SMB2.002                                                                                                                                             
                                                                                                                                                                                                                                  
                            3.  Client sends SESSION\_SETUP request                                                                                                                                                               
                                                                                                                                                                                                                                  
                            4.  Server sends SESSION\_SETUP response                                                                                                                                                              
                                                                                                                                                                                                                                  
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed                                                                                                  
                                                                                                                                                                                                                                  
                            6.  Client sends TREE\_CONNECT request                                                                                                                                                                
                                                                                                                                                                                                                                  
                            7.  Server sends TREE\_CONNECT response                                                                                                                                                               
                                                                                                                                                                                                                                  
                            8.  Client sends CREATE request for a directory with SMB2\_CREATE\_REQUEST\_LEASE\_V2, LeaseState setting to SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_WRITE\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING  
                                                                                                                                                                                                                                  
                            9.  Server sends CREATE response                                                                                                                                                                      
                                                                                                                                                                                                                                  
                            10. Write to the directory with another client                                                                                                                                                        
                                                                                                                                                                                                                                  
                            11. Server sends LEASE\_BREAK notification                                                                                                                                                            
                                                                                                                                                                                                                                  
                            12. Client sends LEASE\_BREAK acknowledgement                                                                                                                                                         
                                                                                                                                                                                                                                  
                            13. Server sends LEASE\_BREAK response                                                                                                                                                                
                                                                                                                                                                                                                                  
                            14. Client sends CLOSE request                                                                                                                                                                        
                                                                                                                                                                                                                                  
                            15. Server sends CLOSE response                                                                                                                                                                       
                                                                                                                                                                                                                                  
                            16. Client sends TREE\_DISCONNECT request                                                                                                                                                             
                                                                                                                                                                                                                                  
                            17. Server sends TREE\_DISCONNECT response                                                                                                                                                            
                                                                                                                                                                                                                                  
                            18. Client sends LOGOFF request                                                                                                                                                                       
                                                                                                                                                                                                                                  
                            19. Server sends LOGOFF response                                                                                                                                                                      |
| **Cleanup**              |                                                                                                                                                                                                      |

|                          |                                                                                                                                     |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_InvalidClientGuidInLeaseBreakAck                                                                                  |
| **Description **         | The LEASE\_BREAK\_ACK for open which is already closed                                                                              |
| **Prerequisites**        |                                                                                                                                     |
| **Test Execution Steps** | Test preparation                                                                                                                    
                                                                                                                                                                 
                            Create a directory on a share                                                                                                        
                                                                                                                                                                 
                            From client1                                                                                                                         
                                                                                                                                                                 
                            NEGOTIATE                                                                                                                            
                                                                                                                                                                 
                            SESSION\_SETUP                                                                                                                       
                                                                                                                                                                 
                            TREE\_CONNECT                                                                                                                        
                                                                                                                                                                 
                            CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING)  
                                                                                                                                                                 
                            From SUT adapter to access same directory to trigger leasing break                                                                   
                                                                                                                                                                 
                            From client1                                                                                                                         
                                                                                                                                                                 
                            Receive LEASE\_BREAK                                                                                                                 
                                                                                                                                                                 
                            CLOSE                                                                                                                                
                                                                                                                                                                 
                            Send LEASE\_BREAK\_ACK                                                                                                               
                                                                                                                                                                 
                            Expect error in response                                                                                                             
                                                                                                                                                                 
                            TREE\_DISCONNECT                                                                                                                     
                                                                                                                                                                 
                            LOGOFF                                                                                                                               |
| **Cleanup**              |                                                                                                                                     |

|                          |                                                                                                                                     |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_InvalidLeaseStateInLeaseBreakAck                                                                                  |
| **Description **         | The info in LEASE\_BREAK\_ACK contains invalid LeaseState                                                                           |
| **Prerequisites**        |                                                                                                                                     |
| **Test Execution Steps** | Test preparation                                                                                                                    
                                                                                                                                                                 
                            Create a directory on a share                                                                                                        
                                                                                                                                                                 
                            From client1                                                                                                                         
                                                                                                                                                                 
                            NEGOTIATE                                                                                                                            
                                                                                                                                                                 
                            SESSION\_SETUP                                                                                                                       
                                                                                                                                                                 
                            TREE\_CONNECT                                                                                                                        
                                                                                                                                                                 
                            CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING)  
                                                                                                                                                                 
                            From SUT adapter to access same directory to trigger leasing break                                                                   
                                                                                                                                                                 
                            From client1                                                                                                                         
                                                                                                                                                                 
                            Receive LEASE\_BREAK                                                                                                                 
                                                                                                                                                                 
                            Send LEASE\_BREAK\_ACK (with invalid LeaseState)                                                                                     
                                                                                                                                                                 
                            Expect error in response                                                                                                             
                                                                                                                                                                 
                            CLOSE                                                                                                                                
                                                                                                                                                                 
                            TREE\_DISCONNECT                                                                                                                     
                                                                                                                                                                 
                            LOGOFF                                                                                                                               |
| **Cleanup**              |                                                                                                                                     |

|                          |                                                                                                                                     |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_Invalid LeaseKeyInLeaseBreakAck                                                                                   |
| **Description **         | The info in LEASE\_BREAK\_ACK contains invalid LeaseKey                                                                             |
| **Prerequisites**        |                                                                                                                                     |
| **Test Execution Steps** | Test preparation                                                                                                                    
                                                                                                                                                                 
                            Create a directory on a share                                                                                                        
                                                                                                                                                                 
                            From client1                                                                                                                         
                                                                                                                                                                 
                            NEGOTIATE                                                                                                                            
                                                                                                                                                                 
                            SESSION\_SETUP                                                                                                                       
                                                                                                                                                                 
                            TREE\_CONNECT                                                                                                                        
                                                                                                                                                                 
                            CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING)  
                                                                                                                                                                 
                            From SUT adapter to access same directory to trigger leasing break                                                                   
                                                                                                                                                                 
                            From client1                                                                                                                         
                                                                                                                                                                 
                            Receive LEASE\_BREAK                                                                                                                 
                                                                                                                                                                 
                            Send LEASE\_BREAK\_ACK (with invalid LeaseKey)                                                                                       
                                                                                                                                                                 
                            Expect error in response                                                                                                             
                                                                                                                                                                 
                            CLOSE                                                                                                                                
                                                                                                                                                                 
                            TREE\_DISCONNECT                                                                                                                     
                                                                                                                                                                 
                            LOGOFF                                                                                                                               |
| **Cleanup**              |                                                                                                                                     |

#### DirectoryLeasing\_BreakByAccurateOperation

| RequestLeaseStateFromClient1 | BreakOperationByClient2 |
|------------------------------|-------------------------|
| R                            | ChildRenamed            |
| R                            | ChildDeleted            |
| R                            | ChildModified           |
| RH                           | ConflictOpen            |
| RH                           | ParentDeleted           |
| RH                           | ParentRenamed           |

##### Scenario

| **Description**               | Trigger the lease break by specific operations                |
|-------------------------------|---------------------------------------------------------------|
| **Message Sequence**          | **Test preparation**                                          
                                                                                                
                                 Create a directory on a share                                  
                                                                                                
                                 **From client1**                                               
                                                                                                
                                 NEGOTIATE                                                      
                                                                                                
                                 SESSION\_SETUP                                                 
                                                                                                
                                 TREE\_CONNECT                                                  
                                                                                                
                                 CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2)      
                                                                                                
                                 **From client2 to trigger lease break by specific operation**  
                                                                                                
                                 **From client1**                                               
                                                                                                
                                 Receive LEASE\_BREAK if expect one                             
                                                                                                
                                 Send LEASE\_BREAK\_ACK if there’s LEASE\_BREAK                 
                                                                                                
                                 CLOSE                                                          
                                                                                                
                                 TREE\_DISCONNECT                                               
                                                                                                
                                 LOGOFF                                                         
                                                                                                
                                 **From client2**                                               
                                                                                                
                                 CLOSE                                                          
                                                                                                
                                 TREE\_DISCONNECT                                               
                                                                                                
                                 LOGOFF                                                         |
| **Cluster Involved Scenario** | **NO**                                                        |

##### Test Case

|                          |                                                                                                               |
|--------------------------|---------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_BreakReadCachingByChildRenamed                                                              |
| **Description **         | Test whether server can handle READ lease break notification triggered by renaming child item on a directory. |
| **Prerequisites**        |                                                                                                               |
| **Test Execution Steps** | **Test preparation**                                                                                          
                                                                                                                                           
                            Create a directory on a share                                                                                  
                                                                                                                                           
                            Create a file in the directory                                                                                 
                                                                                                                                           
                            **From client1**                                                                                               
                                                                                                                                           
                            NEGOTIATE                                                                                                      
                                                                                                                                           
                            SESSION\_SETUP                                                                                                 
                                                                                                                                           
                            TREE\_CONNECT                                                                                                  
                                                                                                                                           
                            CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 with LeaseState SMB2\_LEASE\_READ\_CACHING)           
                                                                                                                                           
                            **From client2 to trigger lease break by renaming the child item**                                             
                                                                                                                                           
                            NEGOTIATE                                                                                                      
                                                                                                                                           
                            SESSION\_SETUP                                                                                                 
                                                                                                                                           
                            TREE\_CONNECT                                                                                                  
                                                                                                                                           
                            CREATE (File in the directory with DELETE access mask)                                                         
                                                                                                                                           
                            SetInfo with FileRenameInformation to rename the file                                                          
                                                                                                                                           
                            **From client1**                                                                                               
                                                                                                                                           
                            Receive LEASE\_BREAK                                                                                           
                                                                                                                                           
                            Send LEASE\_BREAK\_ACK if server requires                                                                      
                                                                                                                                           
                            CLOSE                                                                                                          
                                                                                                                                           
                            TREE\_DISCONNECT                                                                                               
                                                                                                                                           
                            LOGOFF                                                                                                         
                                                                                                                                           
                            **From client2**                                                                                               
                                                                                                                                           
                            CLOSE                                                                                                          
                                                                                                                                           
                            TREE\_DISCONNECT                                                                                               
                                                                                                                                           
                            LOGOFF                                                                                                         |
| **Cleanup**              |                                                                                                               |

|                          |                                                                                                               |
|--------------------------|---------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_BreakReadCachingByChildDeleted                                                              |
| **Description **         | Test whether server can handle READ lease break notification triggered by deleting child item on a directory. |
| **Prerequisites**        |                                                                                                               |
| **Test Execution Steps** | **Test preparation**                                                                                          
                                                                                                                                           
                            Create a directory on a share                                                                                  
                                                                                                                                           
                            Create a file in the directory                                                                                 
                                                                                                                                           
                            **From client1**                                                                                               
                                                                                                                                           
                            NEGOTIATE                                                                                                      
                                                                                                                                           
                            SESSION\_SETUP                                                                                                 
                                                                                                                                           
                            TREE\_CONNECT                                                                                                  
                                                                                                                                           
                            CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 with LeaseState SMB2\_LEASE\_READ\_CACHING)           
                                                                                                                                           
                            **From client2 to trigger lease break by deleting the child item**                                             
                                                                                                                                           
                            NEGOTIATE                                                                                                      
                                                                                                                                           
                            SESSION\_SETUP                                                                                                 
                                                                                                                                           
                            TREE\_CONNECT                                                                                                  
                                                                                                                                           
                            CREATE (File in the directory, with DELETE access mask and FILE\_DELETE\_ON\_CLOSE create option)              
                                                                                                                                           
                            CLOSE to commit the delete                                                                                     
                                                                                                                                           
                            **From client1**                                                                                               
                                                                                                                                           
                            Receive LEASE\_BREAK                                                                                           
                                                                                                                                           
                            Send LEASE\_BREAK\_ACK if server requires                                                                      
                                                                                                                                           
                            CLOSE                                                                                                          
                                                                                                                                           
                            TREE\_DISCONNECT                                                                                               
                                                                                                                                           
                            LOGOFF                                                                                                         
                                                                                                                                           
                            **From client2**                                                                                               
                                                                                                                                           
                            TREE\_DISCONNECT                                                                                               
                                                                                                                                           
                            LOGOFF                                                                                                         |
| **Cleanup**              |                                                                                                               |

|                          |                                                                                                                |
|--------------------------|----------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_BreakReadCachingByChildModified                                                              |
| **Description **         | Test whether server can handle READ lease break notification triggered by modifying child item on a directory. |
| **Prerequisites**        |                                                                                                                |
| **Test Execution Steps** | **Test preparation**                                                                                           
                                                                                                                                            
                            Create a directory on a share                                                                                   
                                                                                                                                            
                            Create a file in the directory                                                                                  
                                                                                                                                            
                            **From client1**                                                                                                
                                                                                                                                            
                            NEGOTIATE                                                                                                       
                                                                                                                                            
                            SESSION\_SETUP                                                                                                  
                                                                                                                                            
                            TREE\_CONNECT                                                                                                   
                                                                                                                                            
                            CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 with LeaseState SMB2\_LEASE\_READ\_CACHING)            
                                                                                                                                            
                            **From client2 to trigger lease break by modifying the child item**                                             
                                                                                                                                            
                            NEGOTIATE                                                                                                       
                                                                                                                                            
                            SESSION\_SETUP                                                                                                  
                                                                                                                                            
                            TREE\_CONNECT                                                                                                   
                                                                                                                                            
                            CREATE (File in the directory, with WRITE access mask)                                                          
                                                                                                                                            
                            WRITE content to the file                                                                                       
                                                                                                                                            
                            CLOSE to commit the write                                                                                       
                                                                                                                                            
                            **From client1**                                                                                                
                                                                                                                                            
                            Receive LEASE\_BREAK                                                                                            
                                                                                                                                            
                            Send LEASE\_BREAK\_ACK if server requires                                                                       
                                                                                                                                            
                            CLOSE                                                                                                           
                                                                                                                                            
                            TREE\_DISCONNECT                                                                                                
                                                                                                                                            
                            LOGOFF                                                                                                          
                                                                                                                                            
                            **From client2**                                                                                                
                                                                                                                                            
                            TREE\_DISCONNECT                                                                                                
                                                                                                                                            
                            LOGOFF                                                                                                          |
| **Cleanup**              |                                                                                                                |

|                          |                                                                                                                                                              |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_BreakHandleCachingByConflictOpen                                                                                                           |
| **Description **         | Test whether server can handle HANDLE lease break notification triggered by a conflict open.                                                                 |
| **Prerequisites**        |                                                                                                                                                              |
| **Test Execution Steps** | **Test preparation**                                                                                                                                         
                                                                                                                                                                                          
                            Create a directory on a share                                                                                                                                 
                                                                                                                                                                                          
                            **From client1**                                                                                                                                              
                                                                                                                                                                                          
                            NEGOTIATE                                                                                                                                                     
                                                                                                                                                                                          
                            SESSION\_SETUP                                                                                                                                                
                                                                                                                                                                                          
                            TREE\_CONNECT                                                                                                                                                 
                                                                                                                                                                                          
                            CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 with LeaseState SMB2\_LEASE\_HANDLE\_CACHING | SMB2\_LEASE\_READ\_CACHING and with NO share access)  
                                                                                                                                                                                          
                            **From client2 to trigger lease break by sharing\_violate access**                                                                                            
                                                                                                                                                                                          
                            NEGOTIATE                                                                                                                                                     
                                                                                                                                                                                          
                            SESSION\_SETUP                                                                                                                                                
                                                                                                                                                                                          
                            TREE\_CONNECT                                                                                                                                                 
                                                                                                                                                                                          
                            CREATE (File in the directory, with WRITE access mask)                                                                                                        
                                                                                                                                                                                          
                            **From client1**                                                                                                                                              
                                                                                                                                                                                          
                            Receive LEASE\_BREAK                                                                                                                                          
                                                                                                                                                                                          
                            Send LEASE\_BREAK\_ACK if server requires                                                                                                                     
                                                                                                                                                                                          
                            CLOSE                                                                                                                                                         
                                                                                                                                                                                          
                            TREE\_DISCONNECT                                                                                                                                              
                                                                                                                                                                                          
                            LOGOFF                                                                                                                                                        
                                                                                                                                                                                          
                            **From client2**                                                                                                                                              
                                                                                                                                                                                          
                            TREE\_DISCONNECT                                                                                                                                              
                                                                                                                                                                                          
                            LOGOFF                                                                                                                                                        |
| **Cleanup**              |                                                                                                                                                              |

|                          |                                                                                                                                             |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_BreakHandleCachingByParentDeleted                                                                                         |
| **Description **         | Test whether server can handle HANDLE lease break notification triggered by deleting parent directory.                                      |
| **Prerequisites**        |                                                                                                                                             |
| **Test Execution Steps** | **Test preparation**                                                                                                                        
                                                                                                                                                                         
                            Create a parent directory on a share                                                                                                         
                                                                                                                                                                         
                            Create a test directory in the parent directory                                                                                              
                                                                                                                                                                         
                            **From client1**                                                                                                                             
                                                                                                                                                                         
                            NEGOTIATE                                                                                                                                    
                                                                                                                                                                         
                            SESSION\_SETUP                                                                                                                               
                                                                                                                                                                         
                            TREE\_CONNECT                                                                                                                                
                                                                                                                                                                         
                            CREATE (on test directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 with LeaseState SMB2\_LEASE\_HANDLE\_CACHING | SMB2\_LEASE\_READ\_CACHING)  
                                                                                                                                                                         
                            **From client2 to trigger lease break by deleting the parent directory**                                                                     
                                                                                                                                                                         
                            NEGOTIATE                                                                                                                                    
                                                                                                                                                                         
                            SESSION\_SETUP                                                                                                                               
                                                                                                                                                                         
                            TREE\_CONNECT                                                                                                                                
                                                                                                                                                                         
                            CREATE (on the parent directory, with DELETE access mask and FILE\_DELETE\_ON\_CLOSE create option)                                          
                                                                                                                                                                         
                            SetInfo (FileDispositionInformation with DeletePending = 1)                                                                                  
                                                                                                                                                                         
                            CLOSE to commit the delete                                                                                                                   
                                                                                                                                                                         
                            // Additional CREATE to open the parent directory to trigger the lease break                                                                 
                                                                                                                                                                         
                            // It’s the same way for Windows attempt to delete the parent directory when //child is opened by others                                     
                                                                                                                                                                         
                            CREATE (on the parent directory, with DELETE access mask and FILE\_DELETE\_ON\_CLOSE create option)                                          
                                                                                                                                                                         
                            **From client1**                                                                                                                             
                                                                                                                                                                         
                            Receive LEASE\_BREAK                                                                                                                         
                                                                                                                                                                         
                            Send LEASE\_BREAK\_ACK if server requires                                                                                                    
                                                                                                                                                                         
                            CLOSE                                                                                                                                        
                                                                                                                                                                         
                            TREE\_DISCONNECT                                                                                                                             
                                                                                                                                                                         
                            LOGOFF                                                                                                                                       
                                                                                                                                                                         
                            **From client2**                                                                                                                             
                                                                                                                                                                         
                            TREE\_DISCONNECT                                                                                                                             
                                                                                                                                                                         
                            LOGOFF                                                                                                                                       |
| **Cleanup**              |                                                                                                                                             |

|                          |                                                                                                                                                 |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_BreakHandleCachingByParentRenamed                                                                                             |
| **Description **         | Test whether server can handle HANDLE lease break notification triggered by renaming parent directory.                                          |
| **Prerequisites**        |                                                                                                                                                 |
| **Test Execution Steps** | **Test preparation**                                                                                                                            
                                                                                                                                                                             
                            Create a parent directory on a share                                                                                                             
                                                                                                                                                                             
                            Create a test directory in the parent directory                                                                                                  
                                                                                                                                                                             
                            **From client1**                                                                                                                                 
                                                                                                                                                                             
                            NEGOTIATE                                                                                                                                        
                                                                                                                                                                             
                            SESSION\_SETUP                                                                                                                                   
                                                                                                                                                                             
                            TREE\_CONNECT                                                                                                                                    
                                                                                                                                                                             
                            CREATE (on the test directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 with LeaseState SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING)  
                                                                                                                                                                             
                            **From client2 to trigger lease break by renaming the parent directory**                                                                         
                                                                                                                                                                             
                            NEGOTIATE                                                                                                                                        
                                                                                                                                                                             
                            SESSION\_SETUP                                                                                                                                   
                                                                                                                                                                             
                            TREE\_CONNECT                                                                                                                                    
                                                                                                                                                                             
                            CREATE (on the parent directory, with DELETE access mask and FILE\_DELETE\_ON\_CLOSE create option)                                              
                                                                                                                                                                             
                            SetInfo ( with FileRenameInformation to rename the file)                                                                                         
                                                                                                                                                                             
                            **From client1**                                                                                                                                 
                                                                                                                                                                             
                            Receive LEASE\_BREAK                                                                                                                             
                                                                                                                                                                             
                            Send LEASE\_BREAK\_ACK if server requires                                                                                                        
                                                                                                                                                                             
                            CLOSE                                                                                                                                            
                                                                                                                                                                             
                            TREE\_DISCONNECT                                                                                                                                 
                                                                                                                                                                             
                            LOGOFF                                                                                                                                           
                                                                                                                                                                             
                            **From client2**                                                                                                                                 
                                                                                                                                                                             
                            TREE\_DISCONNECT                                                                                                                                 
                                                                                                                                                                             
                            LOGOFF                                                                                                                                           |
| **Cleanup**              |                                                                                                                                                 |

1.  #### DirectoryLeasing\_WriteCachingCleared

    1.  ##### Scenario

| **Description**               | Verify WRITE caching is cleared when server grants lease  |
|-------------------------------|-----------------------------------------------------------|
| **Message Sequence**          | **Test preparation**                                      
                                                                                            
                                 Create a directory on a share                              
                                                                                            
                                 **From client1**                                           
                                                                                            
                                 NEGOTIATE                                                  
                                                                                            
                                 SESSION\_SETUP                                             
                                                                                            
                                 TREE\_CONNECT                                              
                                                                                            
                                 CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2)  
                                                                                            
                                 Verify no WRITE caching is granted by server               
                                                                                            
                                 CLOSE                                                      
                                                                                            
                                 TREE\_DISCONNECT                                           
                                                                                            
                                 LOGOFF                                                     |
| **Cluster Involved Scenario** | **NO**                                                    |

##### Test Case

|                          |                                                                                                                                   |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_RWGrantedAsR                                                                                                    |
| **Description **         | Verify only SMB2\_LEASE\_READ\_CACHING granted when client request SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_WRITE\_CACHING       |
| **Prerequisites**        |                                                                                                                                   |
| **Test Execution Steps** | **Test preparation**                                                                                                              
                                                                                                                                                               
                            Create a directory on a share                                                                                                      
                                                                                                                                                               
                            **From client1**                                                                                                                   
                                                                                                                                                               
                            NEGOTIATE                                                                                                                          
                                                                                                                                                               
                            SESSION\_SETUP                                                                                                                     
                                                                                                                                                               
                            TREE\_CONNECT                                                                                                                      
                                                                                                                                                               
                            CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 and LeaseState SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_WRITE\_CACHING)  
                                                                                                                                                               
                            Verify server only granted SMB2\_LEASE\_READ\_CACHING in response                                                                  
                                                                                                                                                               
                            CLOSE                                                                                                                              
                                                                                                                                                               
                            TREE\_DISCONNECT                                                                                                                   
                                                                                                                                                               
                            LOGOFF                                                                                                                             |
| **Cleanup**              |                                                                                                                                   |

|                          |                                                                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DirectoryLeasing\_RWHGrantedAsRH                                                                                                                                                                 |
| **Description **         | Verify only SMB2\_ SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING granted when client request SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_WRITE\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING |
| **Prerequisites**        |                                                                                                                                                                                                  |
| **Test Execution Steps** | **Test preparation**                                                                                                                                                                             
                                                                                                                                                                                                                              
                            Create a directory on a share                                                                                                                                                                     
                                                                                                                                                                                                                              
                            **From client1**                                                                                                                                                                                  
                                                                                                                                                                                                                              
                            NEGOTIATE                                                                                                                                                                                         
                                                                                                                                                                                                                              
                            SESSION\_SETUP                                                                                                                                                                                    
                                                                                                                                                                                                                              
                            TREE\_CONNECT                                                                                                                                                                                     
                                                                                                                                                                                                                              
                            CREATE (Directory, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 and LeaseState SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_WRITE\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING)                                  
                                                                                                                                                                                                                              
                            Verify server only granted SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING in response                                                                                                  
                                                                                                                                                                                                                              
                            CLOSE                                                                                                                                                                                             
                                                                                                                                                                                                                              
                            TREE\_DISCONNECT                                                                                                                                                                                  
                                                                                                                                                                                                                              
                            LOGOFF                                                                                                                                                                                            |
| **Cleanup**              |                                                                                                                                                                                                  |

1.  ### <span id="_Toc365033855" class="anchor"><span id="_Toc427488160" class="anchor"></span></span>Encryption

    1.  #### Model

**Encryption** Model is to test whether the server can handle encryption functionality correctly according to client request and server configuration.

The feature has 90 Model-Based test cases and 5 traditional test case.

##### Coverage

**Encryption** Model covers all statements (except which are mentioned in “Assumptions/Restrictions”) of the following sections:

3.1.4.3 Encrypting the Message

3.2.5.1.3 Verifying the Signature

3.2.5.3.1 Handling a New Authentication

3.2.5.5 Receiving an SMB2 TREE\_CONNECT Response

##### Assumptions/Restrictions

This model doesn’t test the specific algorithm mentioned in section 2.2.41, which will be covered with traditional test cases.

This model doesn’t test TRANSFORM\_HEADER message type, which will be covered with traditional test cases

##### Scenario Design

This model has one scenario:

| **Scenario Name** | Encryption                                                                                                     |
|-------------------|----------------------------------------------------------------------------------------------------------------|
| **Description**   | It’s a basic scenario to test how the server handles encryption request under different situation.             |
| **Machine**       |  ReadConfig;                                                                                                   
                                                                                                                                     
                      SetupConnection; //Negotiate                                                                                   
                                                                                                                                     
                      (                                                                                                              
                                                                                                                                     
                     SessionSetupRequest;                                                                                            
                                                                                                                                     
                     SessionSetupResponse;                                                                                           
                                                                                                                                     
                     TreeConnectRequest;                                                                                             
                                                                                                                                     
                     (TreeConnectResponse|ExpectDisconnect);                                                                         
                                                                                                                                     
                     (                                                                                                               
                                                                                                                                     
                     FileOperationVerifyEncryptionRequest; //Write, Read                                                             
                                                                                                                                     
                     (FileOperationVerifyEncryptionResponse|ExpectDisconnect);                                                       
                                                                                                                                     
                     //If the server which does not support encryption receive encrypted message, it will disconnect the connection  
                                                                                                                                     
                     )?;                                                                                                             
                                                                                                                                     
                     );                                                                                                              |

#### Traditional case

For traditional encryption BVT test cases, refer to section [3.1.12](#_Encryption).

#### For other traditional encryption test cases, refer to section [3.4.5](#_FileServerFailover_Encryption).

1.  ### Handle

    1.  #### Model

        1.  ##### Coverage

**Handle** Model covers all statements (except which are mentioned in “Assumptions/Restrictions”) of the following sections:

-   3.3.5.6 Receiving an SMB2 LOGOFF Request

-   3.3.5.9 Receiving an SMB2 CREATE Request.

-   3.3.5.9.6 Handling the SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST Create Context

-   3.3.5.9.7 Handling the SMB2\_CREATE\_DURABLE\_HANDLE\_RECONNECT Create Context

-   3.3.5.9.10 Handling the SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 Create Context

-   3.3.5.9.12 Handling the SMB2\_CREATE\_DURABLE\_HANDLE\_RECONNECT\_V2 Create Context

    1.  ##### Assumptions/Restrictions

<!-- -->

-   All lease state used in this model is SMB2\_LEASE\_HANDLE\_CACHING | SMB2\_LEASE\_READ\_CACHING

-   The model does not cover the scenario that the file name in ReconnectOpenRequest is different from PrepareOpen.

-   Open in this model is an open to a non-directory file.

-   The model does not cover the scenario that the dialect negotiated in ReconnectOpenRequest is different from PrepareOpen.

    1.  ##### Scenario Design

This model has 10 scenarios:

| **Scenario Name** | RequestDurableHandleV1BatchOplock                                                                          |
|-------------------|------------------------------------------------------------------------------------------------------------|
| **Description**   | Basic scenario to test create durable handle v1 with batch oplock                                          |
| **Machine**       | ReadConfig;                                                                                                
                                                                                                                                 
                     OpenRequest(                                                                                                
                                                                                                                                 
                     {ModelDialectRevision.Smb21, ModelDialectRevision.Smb30, ModelDialectRevision.Smb302}, // clientMaxDialect  
                                                                                                                                 
                     PersistentBitType.PersistentBitNotSet,                                                                      
                                                                                                                                 
                     CAShareType.NonCAShare,                                                                                     
                                                                                                                                 
                     {OplockLeaseType.BatchOplock, OplockLeaseType.NoOplockOrLease},                                             
                                                                                                                                 
                     \_, // durableV1RequestContext                                                                              
                                                                                                                                 
                     DurableV2RequestContext.DurableV2RequestContextNotExist,                                                    
                                                                                                                                 
                     \_, // durableV1ReconnectContext                                                                            
                                                                                                                                 
                     DurableV2ReconnectContext.DurableV2ReconnectContextNotExist);                                               
                                                                                                                                 
                     OpenResponse;                                                                                               |

| **Scenario Name** | RequestDurableHandleV1LeaseV1                                                                              |
|-------------------|------------------------------------------------------------------------------------------------------------|
| **Description**   | Basic scenario to test create durable handle v1 with lease v1                                              |
| **Machine**       | ReadConfig;                                                                                                
                                                                                                                                 
                     OpenRequest(                                                                                                
                                                                                                                                 
                     {ModelDialectRevision.Smb21, ModelDialectRevision.Smb30, ModelDialectRevision.Smb302}, // clientMaxDialect  
                                                                                                                                 
                     PersistentBitType.PersistentBitNotSet,                                                                      
                                                                                                                                 
                     CAShareType.NonCAShare,                                                                                     
                                                                                                                                 
                     {OplockLeaseType.LeaseV1, OplockLeaseType.NoOplockOrLease},                                                 
                                                                                                                                 
                     \_, // durableV1RequestContext                                                                              
                                                                                                                                 
                     DurableV2RequestContext.DurableV2RequestContextNotExist,                                                    
                                                                                                                                 
                     \_, // durableV1ReconnectContext                                                                            
                                                                                                                                 
                     DurableV2ReconnectContext.DurableV2ReconnectContextNotExist);                                               
                                                                                                                                 
                     OpenResponse;                                                                                               |

| **Scenario Name** | RequestDurableHandleV2BatchOplock                                                                                                          |
|-------------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Basic scenario to test create durable handle v2 with batch oplock                                                                          |
| **Machine**       | ReadConfig;                                                                                                                                
                                                                                                                                                                 
                     OpenRequest(                                                                                                                                
                                                                                                                                                                 
                     {ModelDialectRevision.Smb30, ModelDialectRevision.Smb302}, // clientMaxDialect                                                              
                                                                                                                                                                 
                     PersistentBitType.PersistentBitNotSet,                                                                                                      
                                                                                                                                                                 
                     CAShareType.NonCAShare,                                                                                                                     
                                                                                                                                                                 
                     {OplockLeaseType.BatchOplock, OplockLeaseType.NoOplockOrLease},                                                                             
                                                                                                                                                                 
                     DurableV1RequestContext.DurableV1RequestContextNotExist,                                                                                    
                                                                                                                                                                 
                     {DurableV2RequestContext.DurableV2RequestContextExistWithoutPersistent, DurableV2RequestContext.DurableV2RequestContextNotExist},           
                                                                                                                                                                 
                     DurableV1ReconnectContext.DurableV1ReconnectContextNotExist,                                                                                
                                                                                                                                                                 
                     {DurableV2ReconnectContext.DurableV2ReconnectContextExistWithoutPersistent, DurableV2ReconnectContext.DurableV2ReconnectContextNotExist});  
                                                                                                                                                                 
                     OpenResponse;                                                                                                                               |

| **Scenario Name** | RequestDurableHandleV2LeaseV1                                                                                                              |
|-------------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Basic scenario to test create durable handle v2 with lease v1                                                                              |
| **Machine**       | ReadConfig;                                                                                                                                
                                                                                                                                                                 
                     OpenRequest(                                                                                                                                
                                                                                                                                                                 
                     {ModelDialectRevision.Smb30, ModelDialectRevision.Smb302}, // clientMaxDialect                                                              
                                                                                                                                                                 
                     PersistentBitType.PersistentBitNotSet,                                                                                                      
                                                                                                                                                                 
                     CAShareType.NonCAShare,                                                                                                                     
                                                                                                                                                                 
                     {OplockLeaseType.LeaseV1, OplockLeaseType.NoOplockOrLease},                                                                                 
                                                                                                                                                                 
                     DurableV1RequestContext.DurableV1RequestContextNotExist,                                                                                    
                                                                                                                                                                 
                     {DurableV2RequestContext.DurableV2RequestContextExistWithoutPersistent, DurableV2RequestContext.DurableV2RequestContextNotExist},           
                                                                                                                                                                 
                     DurableV1ReconnectContext.DurableV1ReconnectContextNotExist,                                                                                
                                                                                                                                                                 
                     {DurableV2ReconnectContext.DurableV2ReconnectContextExistWithoutPersistent, DurableV2ReconnectContext.DurableV2ReconnectContextNotExist});  
                                                                                                                                                                 
                     OpenResponse;                                                                                                                               |

| **Scenario Name** | RequestDurableHandleV2LeaseV2                                                                                                              |
|-------------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Basic scenario to test create durable handle v2 with lease v2                                                                              |
| **Machine**       | ReadConfig;                                                                                                                                
                                                                                                                                                                 
                     OpenRequest(                                                                                                                                
                                                                                                                                                                 
                     {ModelDialectRevision.Smb30, ModelDialectRevision.Smb302}, // clientMaxDialect                                                              
                                                                                                                                                                 
                     PersistentBitType.PersistentBitNotSet,                                                                                                      
                                                                                                                                                                 
                     CAShareType.NonCAShare,                                                                                                                     
                                                                                                                                                                 
                     {OplockLeaseType.LeaseV1, OplockLeaseType.NoOplockOrLease},                                                                                 
                                                                                                                                                                 
                     DurableV1RequestContext.DurableV1RequestContextNotExist,                                                                                    
                                                                                                                                                                 
                     {DurableV2RequestContext.DurableV2RequestContextExistWithoutPersistent, DurableV2RequestContext.DurableV2RequestContextNotExist},           
                                                                                                                                                                 
                     DurableV1ReconnectContext.DurableV1ReconnectContextNotExist,                                                                                
                                                                                                                                                                 
                     {DurableV2ReconnectContext.DurableV2ReconnectContextExistWithoutPersistent, DurableV2ReconnectContext.DurableV2ReconnectContextNotExist});  
                                                                                                                                                                 
                     OpenResponse;                                                                                                                               |

| **Scenario Name** | RequestPersistentHandle                                                                                                                 |
|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Basic scenario to test create persistent handle                                                                                         |
| **Machine**       | ReadConfig;                                                                                                                             
                                                                                                                                                              
                     OpenRequest(                                                                                                                             
                                                                                                                                                              
                     {ModelDialectRevision.Smb30, ModelDialectRevision.Smb302}, // clientMaxDialect                                                           
                                                                                                                                                              
                     \_, // persistentBit                                                                                                                     
                                                                                                                                                              
                     \_, // connectToCAShare                                                                                                                  
                                                                                                                                                              
                     OplockLeaseType.NoOplockOrLease,                                                                                                         
                                                                                                                                                              
                     DurableV1RequestContext.DurableV1RequestContextNotExist,                                                                                 
                                                                                                                                                              
                     {DurableV2RequestContext.DurableV2RequestContextExistWithPersistent, DurableV2RequestContext.DurableV2RequestContextNotExist},           
                                                                                                                                                              
                     DurableV1ReconnectContext.DurableV1ReconnectContextNotExist,                                                                             
                                                                                                                                                              
                     {DurableV2ReconnectContext.DurableV2ReconnectContextExistWithPersistent, DurableV2ReconnectContext.DurableV2ReconnectContextNotExist});  
                                                                                                                                                              
                     OpenResponse;                                                                                                                            |

| **Scenario Name** | DurableHandleV1PreparedWithBatchOplockReconnect                                                            |
|-------------------|------------------------------------------------------------------------------------------------------------|
| **Description**   | Test reconnect durable handle                                                                              
                                                                                                                                 
                     The durablev1 open is created with batch lock                                                               
                                                                                                                                 
                     Client does Logoff/Disconnect/Nothing.                                                                      
                                                                                                                                 
                     Client reconnects the open.                                                                                 |
| **Machine**       | ReadConfig;                                                                                                
                                                                                                                                 
                     PrepareOpen(                                                                                                
                                                                                                                                 
                     {ModelDialectRevision.Smb21, ModelDialectRevision.Smb30, ModelDialectRevision.Smb302}, // clientMaxDialect  
                                                                                                                                 
                     PersistentBitType.PersistentBitNotSet,                                                                      
                                                                                                                                 
                     CAShareType.NonCAShare,                                                                                     
                                                                                                                                 
                     ModelHandleType.DurableHandleV1,                                                                            
                                                                                                                                 
                     OplockLeaseType.BatchOplock);                                                                               
                                                                                                                                 
                     (LogOff|Disconnect)?;                                                                                       
                                                                                                                                 
                     ReconnectOpenRequest(                                                                                       
                                                                                                                                 
                     \_, // durableV1ReconnectContext                                                                            
                                                                                                                                 
                     DurableV2ReconnectContext.DurableV2ReconnectContextNotExist,                                                
                                                                                                                                 
                     {OplockLeaseType.BatchOplock, OplockLeaseType.NoOplockOrLease},                                             
                                                                                                                                 
                     \_, // leaseKeyDifferentialType                                                                             
                                                                                                                                 
                     \_, // clientIdType                                                                                         
                                                                                                                                 
                     \_);// createGuidType                                                                                       
                                                                                                                                 
                     OpenResponse;                                                                                               |

| **Scenario Name** | DurableHandleV1PreparedWithLeaseV1Reconnect                                            |
|-------------------|----------------------------------------------------------------------------------------|
| **Description**   | Test reconnect durable handle                                                          
                                                                                                             
                     The durablev1 open is created with lease v1                                             
                                                                                                             
                     Client does Logoff/Disconnect/Nothing.                                                  
                                                                                                             
                     Client reconnects the open.                                                             |
| **Machine**       | ReadConfig;                                                                            
                                                                                                             
                     PrepareOpen(                                                                            
                                                                                                             
                     {ModelDialectRevision.Smb21, ModelDialectRevision.Smb30, ModelDialectRevision.Smb302},  
                                                                                                             
                     PersistentBitType.PersistentBitNotSet,                                                  
                                                                                                             
                     CAShareType.NonCAShare,                                                                 
                                                                                                             
                     ModelHandleType.DurableHandleV1,                                                        
                                                                                                             
                     OplockLeaseType.LeaseV1);                                                               
                                                                                                             
                     (LogOff|Disconnect)?;                                                                   
                                                                                                             
                     ReconnectOpenRequest(                                                                   
                                                                                                             
                     \_, // durableV1ReconnectContext                                                        
                                                                                                             
                     DurableV2ReconnectContext.DurableV2ReconnectContextNotExist,                            
                                                                                                             
                     {OplockLeaseType.LeaseV1, OplockLeaseType.NoOplockOrLease},                             
                                                                                                             
                     \_, // leaseKeyDifferentialType                                                         
                                                                                                             
                     \_, // clientIdType                                                                     
                                                                                                             
                     \_);// createGuidType                                                                   
                                                                                                             
                     OpenResponse;                                                                           |

| **Scenario Name** | DurableHandleV2PreparedWithBatchOplockReconnect                                                                                           |
|-------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Test reconnect durable handle                                                                                                             
                                                                                                                                                                
                     The durablev2 open is created with batch oplock                                                                                            
                                                                                                                                                                
                     Client does Logoff/Disconnect/Nothing.                                                                                                     
                                                                                                                                                                
                     Client reconnects the open.                                                                                                                
                                                                                                                                                                
                     The cases are only applied for Dialect 3.0 or later.                                                                                       |
| **Machine**       | ReadConfig;                                                                                                                               
                                                                                                                                                                
                     PrepareOpen(                                                                                                                               
                                                                                                                                                                
                     {ModelDialectRevision.Smb30, ModelDialectRevision.Smb302},                                                                                 
                                                                                                                                                                
                     PersistentBitType.PersistentBitNotSet,                                                                                                     
                                                                                                                                                                
                     CAShareType.NonCAShare,                                                                                                                    
                                                                                                                                                                
                     ModelHandleType.DurableHandleV2,                                                                                                           
                                                                                                                                                                
                     OplockLeaseType.BatchOplock);                                                                                                              
                                                                                                                                                                
                     (LogOff|Disconnect)?;                                                                                                                      
                                                                                                                                                                
                     ReconnectOpenRequest(                                                                                                                      
                                                                                                                                                                
                     DurableV1ReconnectContext.DurableV1ReconnectContextNotExist,                                                                               
                                                                                                                                                                
                     {DurableV2ReconnectContext.DurableV2ReconnectContextExistWithoutPersistent, DurableV2ReconnectContext.DurableV2ReconnectContextNotExist},  
                                                                                                                                                                
                     {OplockLeaseType.BatchOplock, OplockLeaseType.NoOplockOrLease},                                                                            
                                                                                                                                                                
                     \_, // leaseKeyDifferentialType                                                                                                            
                                                                                                                                                                
                     \_, // clientIdType                                                                                                                        
                                                                                                                                                                
                     \_);// createGuidType                                                                                                                      
                                                                                                                                                                
                     OpenResponse;                                                                                                                              |

| **Scenario Name** | DurableHandleV2PreparedWithLeaseV1Reconnect                                                                                               |
|-------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Test reconnect durable handle                                                                                                             
                                                                                                                                                                
                     The durablev2 open is created with lease v1                                                                                                
                                                                                                                                                                
                     Client does Logoff/Disconnect/Nothing.                                                                                                     
                                                                                                                                                                
                     Client reconnects the open.                                                                                                                
                                                                                                                                                                
                     The cases are only applied for Dialect 3.0 or later.                                                                                       |
| **Machine**       | ReadConfig;                                                                                                                               
                                                                                                                                                                
                     PrepareOpen(                                                                                                                               
                                                                                                                                                                
                     {ModelDialectRevision.Smb30, ModelDialectRevision.Smb302},                                                                                 
                                                                                                                                                                
                     PersistentBitType.PersistentBitNotSet,                                                                                                     
                                                                                                                                                                
                     CAShareType.NonCAShare,                                                                                                                    
                                                                                                                                                                
                     ModelHandleType.DurableHandleV2,                                                                                                           
                                                                                                                                                                
                     OplockLeaseType.LeaseV1);                                                                                                                  
                                                                                                                                                                
                     (LogOff|Disconnect)?;                                                                                                                      
                                                                                                                                                                
                     ReconnectOpenRequest(                                                                                                                      
                                                                                                                                                                
                     DurableV1ReconnectContext.DurableV1ReconnectContextNotExist,                                                                               
                                                                                                                                                                
                     {DurableV2ReconnectContext.DurableV2ReconnectContextExistWithoutPersistent, DurableV2ReconnectContext.DurableV2ReconnectContextNotExist},  
                                                                                                                                                                
                     {OplockLeaseType.LeaseV1, OplockLeaseType.NoOplockOrLease},                                                                                
                                                                                                                                                                
                     \_, // leaseKeyDifferentialType                                                                                                            
                                                                                                                                                                
                     \_, // clientIdType                                                                                                                        
                                                                                                                                                                
                     \_);// createGuidType                                                                                                                      
                                                                                                                                                                
                     OpenResponse;                                                                                                                              |

| **Scenario Name** | DurableHandleV2PreparedWithLeaseV2Reconnect                                                                                               |
|-------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Test reconnect durable handle                                                                                                             
                                                                                                                                                                
                     The durablev2 open is created with lease v2                                                                                                
                                                                                                                                                                
                     Client does Logoff/Disconnect/Nothing.                                                                                                     
                                                                                                                                                                
                     Client reconnects the open.                                                                                                                
                                                                                                                                                                
                     The cases are only applied for Dialect 3.0 or later.                                                                                       |
| **Machine**       | ReadConfig;                                                                                                                               
                                                                                                                                                                
                     PrepareOpen(                                                                                                                               
                                                                                                                                                                
                     {ModelDialectRevision.Smb30, ModelDialectRevision.Smb302},                                                                                 
                                                                                                                                                                
                     PersistentBitType.PersistentBitNotSet,                                                                                                     
                                                                                                                                                                
                     CAShareType.NonCAShare,                                                                                                                    
                                                                                                                                                                
                     ModelHandleType.DurableHandleV2,                                                                                                           
                                                                                                                                                                
                     OplockLeaseType.LeaseV2);                                                                                                                  
                                                                                                                                                                
                     (LogOff|Disconnect)?;                                                                                                                      
                                                                                                                                                                
                     ReconnectOpenRequest(                                                                                                                      
                                                                                                                                                                
                     DurableV1ReconnectContext.DurableV1ReconnectContextNotExist,                                                                               
                                                                                                                                                                
                     {DurableV2ReconnectContext.DurableV2ReconnectContextExistWithoutPersistent, DurableV2ReconnectContext.DurableV2ReconnectContextNotExist},  
                                                                                                                                                                
                     {OplockLeaseType.LeaseV2, OplockLeaseType.NoOplockOrLease},                                                                                
                                                                                                                                                                
                     \_, // leaseKeyDifferentialType                                                                                                            
                                                                                                                                                                
                     \_, // clientIdType                                                                                                                        
                                                                                                                                                                
                     \_);// createGuidType                                                                                                                      
                                                                                                                                                                
                     OpenResponse;                                                                                                                              |

| **Scenario Name** | PersistentHandleReconnect                                    |
|-------------------|--------------------------------------------------------------|
| **Description**   | Test reconnect persistent handle                             
                                                                                   
                     The persistent open is created.                               
                                                                                   
                     Client does Logoff/Disconnect.                                
                                                                                   
                     Client reconnects to the open.                                
                                                                                   
                     The cases are only applied for Dialect 3.0 or later.          |
| **Machine**       | ReadConfig;                                                  
                                                                                   
                     PrepareOpen(                                                  
                                                                                   
                     {ModelDialectRevision.Smb30, ModelDialectRevision.Smb302},    
                                                                                   
                     \_, // persistentBit                                          
                                                                                   
                     CAShareType.CAShare, // connectToCAShare                      
                                                                                   
                     ModelHandleType.PersistentHandle,                             
                                                                                   
                     OplockLeaseType.NoOplockOrLease);                             
                                                                                   
                     (LogOff|Disconnect);                                          
                                                                                   
                     ReconnectOpenRequest(                                         
                                                                                   
                     DurableV1ReconnectContext.DurableV1ReconnectContextNotExist,  
                                                                                   
                     \_, // durableV2ReconnectContext                              
                                                                                   
                     OplockLeaseType.NoOplockOrLease,                              
                                                                                   
                     \_, // leaseKeyDifferentialType                               
                                                                                   
                     \_, // clientIdType                                           
                                                                                   
                     \_);// createGuidType                                         
                                                                                   
                     OpenResponse;                                                 |

#### Traditional case

The traditional test case is used to cover the below statement in section 3.3.5.9.7:

If the user represented by SessionSecurityContext is not the same user denoted by Open.DurableOwner, the server MUST fail the request with STATUS\_ACCESS\_DENIED. 

If the server disconnect the connection, the reconnect will be successful.

| **Test ID**                   | DurableHandleV2\_Reconnection\_WithDifferentDurableOwner                          |
|-------------------------------|-----------------------------------------------------------------------------------|
| **Description**               | Test reconnect with different durable owner will fail with STATUS\_ACCESS\_DENIED |
| **Message Sequence**          | **Open a file and request durable handle v2 then write content to file**          
                                                                                                                    
                                 NEGOTIATE                                                                          
                                                                                                                    
                                 SESSION\_SETUP                                                                     
                                                                                                                    
                                 TREE\_CONNECT                                                                      
                                                                                                                    
                                 CREATE (with CREATE\_DURABLE\_HANDLE\_REQUEST\_V2)                                 
                                                                                                                    
                                 WRITE                                                                              
                                                                                                                    
                                 **Disconnect/Reconnect the network to simulate network failure**                   
                                                                                                                    
                                 **Reconnect previous durable handle v2 and read content from file**                
                                                                                                                    
                                 NEGOTIATE                                                                          
                                                                                                                    
                                 SESSION\_SETUP (Reconnect using different account credential)                      
                                                                                                                    
                                 TREE\_CONNECT                                                                      
                                                                                                                    
                                 CREATE (with CREATE\_DURABLE\_HANDLE\_RECONNECT\_V2)                               
                                                                                                                    
                                 CLOSE                                                                              
                                                                                                                    
                                 TREE\_DISCONNECT                                                                   
                                                                                                                    
                                 LOGOFF                                                                             |
| **Cluster Involved Scenario** | **NO**                                                                            |

| **Test ID**                   | DurableHandleV1\_Reconnect\_WithoutLogoffOrDisconnect\_WithPreviousSessionIdSet                  |
|-------------------------------|--------------------------------------------------------------------------------------------------|
| **Description**               | Test reconnect with DurableHandleV1, without log off or disconnect but with previous session id. |
| **Message Sequence**          | **Open a file and request durable handle v1 then write content to file**                         
                                                                                                                                   
                                 NEGOTIATE                                                                                         
                                                                                                                                   
                                 SESSION\_SETUP                                                                                    
                                                                                                                                   
                                 TREE\_CONNECT                                                                                     
                                                                                                                                   
                                 CREATE (with CREATE\_DURABLE\_HANDLE\_REQUEST\_V1)                                                
                                                                                                                                   
                                 WRITE                                                                                             
                                                                                                                                   
                                 **Reconnect previous durable handle v2 and read content from file**                               
                                                                                                                                   
                                 NEGOTIATE                                                                                         
                                                                                                                                   
                                 SESSION\_SETUP (Reconnect using SessionId in above step as PreviousSessionId)                     
                                                                                                                                   
                                 TREE\_CONNECT                                                                                     
                                                                                                                                   
                                 CREATE (with CREATE\_DURABLE\_HANDLE\_RECONNECT\_V1)                                              
                                                                                                                                   
                                 CLOSE                                                                                             
                                                                                                                                   
                                 TREE\_DISCONNECT                                                                                  
                                                                                                                                   
                                 LOGOFF                                                                                            |
| **Cluster Involved Scenario** | **NO**                                                                                           |

| **Test ID**                   | DurableHandleV1\_Reconnect\_WithoutLogoffOrDisconnect\_WithoutPreviousSessionIdSet                  |
|-------------------------------|-----------------------------------------------------------------------------------------------------|
| **Description**               | Test reconnect with DurableHandleV1, without log off or disconnect but without previous session id. |
| **Message Sequence**          | **Open a file and request durable handle v1 then write content to file**                            
                                                                                                                                      
                                 NEGOTIATE                                                                                            
                                                                                                                                      
                                 SESSION\_SETUP                                                                                       
                                                                                                                                      
                                 TREE\_CONNECT                                                                                        
                                                                                                                                      
                                 CREATE (with CREATE\_DURABLE\_HANDLE\_REQUEST\_V1)                                                   
                                                                                                                                      
                                 WRITE                                                                                                
                                                                                                                                      
                                 **Reconnect previous durable handle v2 and read content from file**                                  
                                                                                                                                      
                                 NEGOTIATE                                                                                            
                                                                                                                                      
                                 SESSION\_SETUP (Reconnect not using SessionId in above step as PreviousSessionId)                    
                                                                                                                                      
                                 TREE\_CONNECT                                                                                        
                                                                                                                                      
                                 CREATE (with CREATE\_DURABLE\_HANDLE\_RECONNECT\_V1)                                                 
                                                                                                                                      
                                 CLOSE                                                                                                
                                                                                                                                      
                                 TREE\_DISCONNECT                                                                                     
                                                                                                                                      
                                 LOGOFF                                                                                               |
| **Cluster Involved Scenario** | **NO**                                                                                              |

| **Test ID**                   | DurableHandleV1\_Reconnect\_AfterServerDisconnect                             |
|-------------------------------|-------------------------------------------------------------------------------|
| **Description**               | Test reconnect with durable handle V1 with server disconnect                  |
| **Message Sequence**          | **Open a file and request durable handle v2 then write content to file**      
                                                                                                                
                                 NEGOTIATE                                                                      
                                                                                                                
                                 SESSION\_SETUP                                                                 
                                                                                                                
                                 TREE\_CONNECT                                                                  
                                                                                                                
                                 CREATE (with CREATE\_DURABLE\_HANDLE\_REQUEST\_V1)                             
                                                                                                                
                                 WRITE                                                                          
                                                                                                                
                                 **Send Negotiate after create to make server disconnect the connection**       
                                                                                                                
                                 **Reconnect previous durable handle v1**                                       
                                                                                                                
                                 NEGOTIATE                                                                      
                                                                                                                
                                 SESSION\_SETUP (Reconnect using SessionId in above step as PreviousSessionId)  
                                                                                                                
                                 TREE\_CONNECT                                                                  
                                                                                                                
                                 CREATE (with CREATE\_DURABLE\_HANDLE\_RECONNECT\_V1)                           
                                                                                                                
                                 CLOSE                                                                          
                                                                                                                
                                 TREE\_DISCONNECT                                                               
                                                                                                                
                                 LOGOFF                                                                         |
| **Cluster Involved Scenario** | **NO**                                                                        |

|                          |                                                                                                            |
|--------------------------|------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DurableHandleV2\_NoPersistenceGrantedOnNonCAShare                                                          |
| **Description **         | Test no persistent handle is granted by the server when the share doesn’t have CA capability               |
| **Prerequisites**        |                                                                                                            |
| **Test Execution Steps** | Client sends NEGOTIATE request                                                                             
                                                                                                                                        
                            Server sends NEGOTIATE response                                                                             
                                                                                                                                        
                            Client sends SESSION\_SETUP request                                                                         
                                                                                                                                        
                            Server sends SESSION\_SETUP response                                                                        
                                                                                                                                        
                            According to the status code of last step, client may send more SESSION\_SETUP request as needed            
                                                                                                                                        
                            Client sends TREE\_CONNECT request to connect share without CA capability                                   
                                                                                                                                        
                            Server sends TREE\_CONNECT response (no SMB2\_SHARE\_CAP\_CONTINUOUS\_AVAILABILITY flag set in Capability)  
                                                                                                                                        
                            Client sends CREATE request with CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 create context                        
                                                                                                                                        
                            Server sends CREATE response (server should not grant persistent handle in response)                        |
| **Cleanup**              |                                                                                                            |

|                          |                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------|
| **Test ID**              | DurableHandleV2\_Reconnection\_WithoutPersistence                                                |
| **Description **         | Test durable handle V2 without persistence could be reconnected                                  |
| **Prerequisites**        |                                                                                                  |
| **Test Execution Steps** | Client sends NEGOTIATE request                                                                   
                                                                                                                              
                            Server sends NEGOTIATE response                                                                   
                                                                                                                              
                            Client sends SESSION\_SETUP request                                                               
                                                                                                                              
                            Server sends SESSION\_SETUP response                                                              
                                                                                                                              
                            According to the status code of last step, client may send more SESSION\_SETUP request as needed  
                                                                                                                              
                            Client sends TREE\_CONNECT request                                                                
                                                                                                                              
                            Server sends TREE\_CONNECT response                                                               
                                                                                                                              
                            Client sends CREATE request with CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 create context              
                                                                                                                              
                            Client sends WRITE request                                                                        
                                                                                                                              
                            Server sends WRITE response                                                                       
                                                                                                                              
                            **Disconnect the client to simulate network failure**                                             
                                                                                                                              
                            Client sends NEGOTIATE request                                                                    
                                                                                                                              
                            Server sends NEGOTIATE response                                                                   
                                                                                                                              
                            Client sends SESSION\_SETUP request                                                               
                                                                                                                              
                            Server sends SESSION\_SETUP response                                                              
                                                                                                                              
                            According to the status code of last step, client may send more SESSION\_SETUP request as needed  
                                                                                                                              
                            Client sends TREE\_CONNECT request                                                                
                                                                                                                              
                            Server sends TREE\_CONNECT response                                                               
                                                                                                                              
                            Client sends CREATE request (with CREATE\_DURABLE\_HANDLE\_RECONNECT\_V2)                         
                                                                                                                              
                            Server sends CREATE response                                                                      
                                                                                                                              
                            Client sends READ request                                                                         
                                                                                                                              
                            Server sends READ response                                                                        
                                                                                                                              
                            Client sends CLOSE request                                                                        
                                                                                                                              
                            Server sends CLOSE response                                                                       
                                                                                                                              
                            Client sends TREE\_DISCONNECT request                                                             
                                                                                                                              
                            Server sends TREE\_DISCONNECT response                                                            
                                                                                                                              
                            Client sends LOGOFF request                                                                       
                                                                                                                              
                            Server sends LOGOFF response                                                                      |
| **Cleanup**              |                                                                                                  |

### <span id="_Toc387924616" class="anchor"><span id="_Toc387924803" class="anchor"><span id="_Toc387924617" class="anchor"><span id="_Toc387924804" class="anchor"><span id="_Toc365033857" class="anchor"><span id="_Toc427488162" class="anchor"></span></span></span></span></span></span>Leasing

**Leasing** means the client can cache specified data in local. There are three different capabilities within a lease: READ, WRITE and HANDLE.

-   READ caching permits the SMB2 client to cache data read from the object.

-   WRITE caching permits the SMB2 client to cache writes and byte-range locks on an object.

-   HANDLE caching permits one or more SMB2 clients to delay closing handles it holds open, or to defer sending opens.

The feature has 379 Model-Based test cases and 2 traditional test case.

For traditional BVT test cases, please refer to section [3.1.11](#_DirectoryLeasing) and [3.1.16](#_FileLeasing)

1.  #### Model

    1.  ##### Coverage

This model covers all statements (except which are mentioned in “Assumptions/Restrictions”) of the following sections:

-   2.2.13.2.8 SMB2\_CREATE\_REQUEST\_LEASE

-   2.2.13.2.10 SMB2\_CREATE\_REQUEST\_LEASE\_V2

-   2.2.23.2 Lease Break Notification

-   2.2.24.2 Lease Break Acknowledgment

-   2.2.25.2 Lease Break Response

-   3.3.1.4 Algorithm for Leasing in an Object Store

-   3.3.4.7 Object Store Indicates a Lease Break

-   3.3.5.9 Receiving an SMB2 CREATE Request

-   3.3.5.9.8 Handling the SMB2\_CREATE\_REQUEST\_LEASE Create Context

-   3.3.5.9.11 Handling the SMB2\_CREATE\_REQUEST\_LEASE\_V2 Create Context

-   3.3.5.22.2 Processing a Lease Acknowledgment

    1.  ##### Assumptions/Restrictions

1.  This model only covers the lease on a file and does not cover the lease on a directory.

2.  This model does not cover the statements in section “3.3.6.1 Oplock Break Acknowledgment Timer Event”.

    1.  ##### Scenario Design

This model has 4 scenarios.

1.  BreakReadLeasingV1

| **Description** | It’s a scenario to test how the server handles read leasing for LeaseV1                                                                                                                                                                      |
|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     | ReadConfig;                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                 
                   SetupConnection;                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                 
                   CreateRequest(ConnectTargetType.ConnectToNonDirectory, LeaseContextType.LeaseV1, LeaseKeyType.ValidLeaseKey, 1,                                                                                                                               
                                                                                                                                                                                                                                                                 
                   \_, \_);                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                 
                   CreateResponse;                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                 
                   (                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);  
                                                                                                                                                                                                                                                                 
                   // 1 R -&gt; None                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                 
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                   
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   )?;                                                                                                                                                                                                                                           |

1.  BreakReadLeasingV2

| **Description** | It’s a scenario to test how the server handles read leasing for LeaseV2.                                                                                                                                                                     |
|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     |   ReadConfig;                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                 
                   SetupConnection({ModelDialectRevision.Smb30, ModelDialectRevision.Smb302}, \_);                                                                                                                                                               
                                                                                                                                                                                                                                                                 
                   CreateRequest(ConnectTargetType.ConnectToNonDirectory, LeaseContextType.LeaseV2, LeaseKeyType.ValidLeaseKey, 1,                                                                                                                               
                                                                                                                                                                                                                                                                 
                   \_, \_);                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                 
                   CreateResponse;                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                 
                   (                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);  
                                                                                                                                                                                                                                                                 
                   // 1 R -&gt; None                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                 
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                   
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   )?;                                                                                                                                                                                                                                           |

1.  BreakReadWriteLeasingV1

| **Description** | It’s a scenario to test how the server handles Read&Write leasing for LeaseV1                                                                                                                                                                |
|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     | ReadConfig;                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                 
                   SetupConnection;                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                 
                   CreateRequest(ConnectTargetType.ConnectToNonDirectory, LeaseContextType.LeaseV1, LeaseKeyType.ValidLeaseKey, 5,                                                                                                                               
                                                                                                                                                                                                                                                                 
                   LeaseFlagsValues.SMB2\_LEASE\_FLAG\_PARENT\_LEASE\_KEY\_SET, ParentLeaseKeyType.ValidParentLeaseKey);                                                                                                                                         
                                                                                                                                                                                                                                                                 
                   CreateResponse;                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                 
                   (                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_WITHOUT\_OVERWRITE}, OperatorType.SameClientId, \_, out \_);                                                                                                                            
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   (                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                 
                   (                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseRequest(FileOperation.OPEN\_OVERWRITE, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                                       
                                                                                                                                                                                                                                                                 
                   // 1 RW -&gt; None                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 5, 0);                                                                                                        
                                                                                                                                                                                                                                                                 
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                          
                                                                                                                                                                                                                                                                 
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                       
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   ) | (                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_WITHOUT\_OVERWRITE}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                            
                                                                                                                                                                                                                                                                 
                   ((                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   // 2 RW -&gt; R                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                 
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 5, 1);                                                                                                        
                                                                                                                                                                                                                                                                 
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                          
                                                                                                                                                                                                                                                                 
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                       
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);  
                                                                                                                                                                                                                                                                 
                   // 2.1 R -&gt; None                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                 
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                   
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   ) | (                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                 
                   // 3 RW -&gt; None                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 5, 0);                                                                                                        
                                                                                                                                                                                                                                                                 
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                          
                                                                                                                                                                                                                                                                 
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                       
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   ))                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   )                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                 
                   );                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   )?;                                                                                                                                                                                                                                           |

1.  BreakReadWriteLeasingV2

| **Description** | It’s a scenario to test how the server handles Read&Write leasing for LeaseV2                                                                                                                                                                |
|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     | ReadConfig;                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                 
                   SetupConnection({ModelDialectRevision.Smb30, ModelDialectRevision.Smb302}, \_);                                                                                                                                                               
                                                                                                                                                                                                                                                                 
                   CreateRequest(ConnectTargetType.ConnectToNonDirectory, LeaseContextType.LeaseV2, LeaseKeyType.ValidLeaseKey, 5,                                                                                                                               
                                                                                                                                                                                                                                                                 
                   LeaseFlagsValues.SMB2\_LEASE\_FLAG\_PARENT\_LEASE\_KEY\_SET, ParentLeaseKeyType.ValidParentLeaseKey);                                                                                                                                         
                                                                                                                                                                                                                                                                 
                   CreateResponse;                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                 
                   (                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_WITHOUT\_OVERWRITE}, OperatorType.SameClientId, \_, out \_);                                                                                                                            
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   (                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                 
                   (                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseRequest(FileOperation.OPEN\_OVERWRITE, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                                       
                                                                                                                                                                                                                                                                 
                   // 1 RW -&gt; None                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 5, 0);                                                                                                        
                                                                                                                                                                                                                                                                 
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                          
                                                                                                                                                                                                                                                                 
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                       
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   ) | (                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_WITHOUT\_OVERWRITE}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                            
                                                                                                                                                                                                                                                                 
                   ((                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   // 2 RW -&gt; R                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                 
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 5, 1);                                                                                                        
                                                                                                                                                                                                                                                                 
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                          
                                                                                                                                                                                                                                                                 
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                       
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);  
                                                                                                                                                                                                                                                                 
                   // 2.1 R -&gt; None                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                 
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                   
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   ) | (                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                 
                   // 3 RW -&gt; None                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 5, 0);                                                                                                        
                                                                                                                                                                                                                                                                 
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                          
                                                                                                                                                                                                                                                                 
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                       
                                                                                                                                                                                                                                                                 
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   ))                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   )                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                 
                   );                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                 
                   )?;                                                                                                                                                                                                                                           |

1.  BreakReadHandleLeasingV1

| **Description** | It’s a scenario to test how the server handles Read&Handle leasing for LeaseV1                                                                                                                                                                      |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     | ReadConfig;                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                        
                   SetupConnection;                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                        
                   CreateRequest(ConnectTargetType.ConnectToNonDirectory, LeaseContextType.LeaseV1, LeaseKeyType.ValidLeaseKey, 3,                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   LeaseFlagsValues.SMB2\_LEASE\_FLAG\_PARENT\_LEASE\_KEY\_SET, ParentLeaseKeyType.ValidParentLeaseKey);                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   CreateResponse;                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   (                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_SHARING\_VIOLATION, FileOperation.OPEN\_SHARING\_VIOLATION\_WITH\_OVERWRITE, FileOperation.RENAMEED}, OperatorType.SameClientId, \_, out \_);                                                  
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest(FileOperation.DELETED, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                                                      
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 1 RH -&gt; R, and no other operation after delete                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 2 RH -&gt; None                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 3 RH -&gt; RH, and no other operation after delete                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest(FileOperation.DELETED, OperatorType.SameClientId, \_, out \_);                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_SHARING\_VIOLATION, FileOperation.OPEN\_SHARING\_VIOLATION\_WITH\_OVERWRITE, FileOperation.RENAMEED}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);  
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 4 RH -&gt; R                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);         
                                                                                                                                                                                                                                                                        
                   // 4.1 R -&gt; None                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                          
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 5 RH -&gt; None                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.PARENT\_DIR\_RENAMED}, \_, \_, out \_);                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 6 RH -&gt; R                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);         
                                                                                                                                                                                                                                                                        
                   // 6.1 R -&gt; None                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                          
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 7 RH -&gt; None                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ));                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   )?;                                                                                                                                                                                                                                                  |

1.  BreakReadHandleLeasingV2

| **Description** | It’s a scenario to test how the server handles Read&Handle leasing for LeaseV2                                                                                                                                                                      |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     | ReadConfig;                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                        
                   SetupConnection({ModelDialectRevision.Smb30, ModelDialectRevision.Smb302}, \_);                                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   CreateRequest(ConnectTargetType.ConnectToNonDirectory, LeaseContextType.LeaseV2, LeaseKeyType.ValidLeaseKey, 3,                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   LeaseFlagsValues.SMB2\_LEASE\_FLAG\_PARENT\_LEASE\_KEY\_SET, ParentLeaseKeyType.ValidParentLeaseKey);                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   CreateResponse;                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   (                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_SHARING\_VIOLATION, FileOperation.OPEN\_SHARING\_VIOLATION\_WITH\_OVERWRITE, FileOperation.RENAMEED}, OperatorType.SameClientId, \_, out \_);                                                  
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest(FileOperation.DELETED, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                                                      
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 1 RH -&gt; R, and no other operation after delete                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 2 RH -&gt; None                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 3 RH -&gt; RH, and no other operation after delete                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest(FileOperation.DELETED, OperatorType.SameClientId, \_, out \_);                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_SHARING\_VIOLATION, FileOperation.OPEN\_SHARING\_VIOLATION\_WITH\_OVERWRITE, FileOperation.RENAMEED}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);  
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 4 RH -&gt; R                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);         
                                                                                                                                                                                                                                                                        
                   // 4.1 R -&gt; None                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                          
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 5 RH -&gt; None                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.PARENT\_DIR\_RENAMED}, \_, \_, out \_);                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 6 RH -&gt; R                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);         
                                                                                                                                                                                                                                                                        
                   // 6.1 R -&gt; None                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                          
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 7 RH -&gt; None                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ));                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   )?;                                                                                                                                                                                                                                                  |

1.  BreakReadWriteHandleLeasingV1

| **Description** | It’s a scenario to test how the server handles Read&Write&Handle leasing for LeaseV1.                                                                                                                                                               |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     |   ReadConfig;                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                        
                   SetupConnection;                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                        
                   CreateRequest(ConnectTargetType.ConnectToNonDirectory, LeaseContextType.LeaseV1, LeaseKeyType.ValidLeaseKey, 7,                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   LeaseFlagsValues.SMB2\_LEASE\_FLAG\_PARENT\_LEASE\_KEY\_SET, ParentLeaseKeyType.ValidParentLeaseKey);                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   CreateResponse;                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   (                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   (                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   (                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_SHARING\_VIOLATION, FileOperation.OPEN\_SHARING\_VIOLATION\_WITH\_OVERWRITE}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_)                           
                                                                                                                                                                                                                                                                        
                   |                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest(FileOperation.PARENT\_DIR\_RENAMED, \_, \_, out \_)                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   );                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 1 RWH -&gt; RW                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 7, 5);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 5);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 5);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   (                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   (                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest(FileOperation.OPEN\_OVERWRITE, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                                              
                                                                                                                                                                                                                                                                        
                   // 1.1 RW -&gt; None                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 5, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_WITHOUT\_OVERWRITE}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                                   
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 1.2 RW -&gt; R                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 5, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);         
                                                                                                                                                                                                                                                                        
                   // 1.2.1 R -&gt; None                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                          
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 1.3 RW -&gt; None                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 5, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   )                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   );                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 2 RWH -&gt; None                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 7, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ));                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_WITHOUT\_OVERWRITE}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                                   
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 3 RWH -&gt; RH                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 7, 3);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 3);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 3);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest(FileOperation.DELETED, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                                                      
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 3.1 RH -&gt; R, and no other operation after delete                                                                                                                                                                                               
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 3.2 RH -&gt; None                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 3.3 RH -&gt; RH, and no other operation after delete                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest(FileOperation.DELETED, OperatorType.SameClientId, \_, out \_);                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_SHARING\_VIOLATION, FileOperation.OPEN\_SHARING\_VIOLATION\_WITH\_OVERWRITE, FileOperation.RENAMEED}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);  
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 3.4 RH -&gt; R                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);         
                                                                                                                                                                                                                                                                        
                   // 3.4.1 R -&gt; None                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                          
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 3.5 RH -&gt; None                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.PARENT\_DIR\_RENAMED}, \_, \_, out \_);                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 3.6 RH -&gt; R                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);         
                                                                                                                                                                                                                                                                        
                   // 3.6.1 R -&gt; None                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                          
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 3.7 RH -&gt; None                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ));                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 4 RWH -&gt; None                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 7, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   )                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   )?;                                                                                                                                                                                                                                                  |

1.  BreakReadWriteHandleLeasingV2

| **Description** | It’s a scenario to test how the server handles Read&Write&Handle leasing for LeaseV2.                                                                                                                                                               |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     |   ReadConfig;                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                        
                   SetupConnection({ModelDialectRevision.Smb30, ModelDialectRevision.Smb302}, \_);                                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   CreateRequest(ConnectTargetType.ConnectToNonDirectory, LeaseContextType.LeaseV2, LeaseKeyType.ValidLeaseKey, 7,                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   LeaseFlagsValues.SMB2\_LEASE\_FLAG\_PARENT\_LEASE\_KEY\_SET, ParentLeaseKeyType.ValidParentLeaseKey);                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   CreateResponse;                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   (                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   (                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   (                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_SHARING\_VIOLATION, FileOperation.OPEN\_SHARING\_VIOLATION\_WITH\_OVERWRITE}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_)                           
                                                                                                                                                                                                                                                                        
                   |                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest(FileOperation.PARENT\_DIR\_RENAMED, \_, \_, out \_)                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   );                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 1 RWH -&gt; RW                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 7, 5);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 5);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 5);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   (                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   (                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest(FileOperation.OPEN\_OVERWRITE, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                                              
                                                                                                                                                                                                                                                                        
                   // 1.1 RW -&gt; None                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 5, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_WITHOUT\_OVERWRITE}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                                   
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 1.2 RW -&gt; R                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 5, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);         
                                                                                                                                                                                                                                                                        
                   // 1.2.1 R -&gt; None                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                          
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 1.3 RW -&gt; None                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 5, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   )                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   );                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 2 RWH -&gt; None                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 7, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ));                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_WITHOUT\_OVERWRITE}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                                   
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 3 RWH -&gt; RH                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 7, 3);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 3);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 3);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest(FileOperation.DELETED, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);                                                                                                      
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 3.1 RH -&gt; R, and no other operation after delete                                                                                                                                                                                               
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 3.2 RH -&gt; None                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 3.3 RH -&gt; RH, and no other operation after delete                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest(FileOperation.DELETED, OperatorType.SameClientId, \_, out \_);                                                                                                                                                      
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_SHARING\_VIOLATION, FileOperation.OPEN\_SHARING\_VIOLATION\_WITH\_OVERWRITE, FileOperation.RENAMEED}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);  
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 3.4 RH -&gt; R                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);         
                                                                                                                                                                                                                                                                        
                   // 3.4.1 R -&gt; None                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                          
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 3.5 RH -&gt; None                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.PARENT\_DIR\_RENAMED}, \_, \_, out \_);                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   ((                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   // 3.6 RH -&gt; R                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 1);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 1);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 1);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseRequest({FileOperation.OPEN\_OVERWRITE, FileOperation.WRITE\_DATA, FileOperation.SIZE\_CHANGED, FileOperation.RANGE\_LOCK}, {OperatorType.SameClientGuidDifferentLeaseKey, OperatorType.SecondClient}, \_, out \_);         
                                                                                                                                                                                                                                                                        
                   // 3.6.1 R -&gt; None                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.None, 1, 0);                                                                                                                                                          
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 3.7 RH -&gt; None                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 3, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ));                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   ) | (                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        
                   // 4 RWH -&gt; None                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                        
                   OnLeaseBreakNotification(\_, LEASE\_BREAK\_Notification\_Packet\_Flags\_Values.SMB2\_NOTIFY\_BREAK\_LEASE\_FLAG\_ACK\_REQUIRED, 7, 0);                                                                                                               
                                                                                                                                                                                                                                                                        
                   LeaseBreakAcknowledgmentRequest(ModelLeaseKeyType.ValidLeaseKey, 0);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                        
                   LeaseBreakResponse(ModelSmb2Status.STATUS\_SUCCESS, 0);                                                                                                                                                                                              
                                                                                                                                                                                                                                                                        
                   FileOperationToBreakLeaseResponse;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   ))                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                        
                   )                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        
                   )?;                                                                                                                                                                                                                                                  |

### <span id="_Toc365033858" class="anchor"><span id="_Toc427488163" class="anchor"></span></span>Negotiate

**Negotiate** means the client can exchange the capabilities with the server.

The feature has 94 Model-Based test cases and 7 traditional test case.

For traditional test cases, please refer to section [3.1.6.](#_Negotiation)

1.  #### Model

    1.  ##### Coverage

This Model covers all statements (except which are mentioned in “Assumptions/Restrictions”) of the following sections:

-   2.2.3 SMB2 NEGOTIATE Request

-   2.2.4 SMB2 NEGOTIATE Response

-   3.3.5.2.2 Verifying the Connection State

-   3.3.5.2.3 Verifying the Sequence Number

-   3.3.5.3 Receiving an SMB\_COM\_NEGOTIATE

-   3.3.5.3.1 SMB 2.1 or SMB 3.0 Support

-   3.3.5.3.2 SMB 2.002 Support

-   3.3.5.4 Receiving an SMB2 NEGOTIATE Request

    1.  ##### Assumptions/Restrictions

1.  This model does not test all flags combination of fields in section 2.2.3 and 2.2.4.

2.  This model focuses on different dialects and different sequences.

    1.  ##### Scenario Design

This model has 1 scenario.

| **Description** | It’s a basic scenario to test how the server handles Negotiate Request and ComNegotiate Request with different dialects and different sequences. |
|-----------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     |  ReadConfig;                                                                                                                                     
                                                                                                                                                                     
                    SetupConnection;                                                                                                                                 
                                                                                                                                                                     
                     (                                                                                                                                               
                                                                                                                                                                     
                        (ComNegotiateRequest | NegotiateRequest);                                                                                                    
                                                                                                                                                                     
                   (NegotiateResponse | ExpectDisconnect)                                                                                                            
                                                                                                                                                                     
                    )+;                                                                                                                                              |

#### Traditional Case

Scenario see section [3.1.6.1](#scenario-5).

|                          |                                                                                                                                  |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Negotiate\_SMB311\_WithoutAnyContexts                                                                                            |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Smb 3.11 dialect and without any Negotiate Contexts. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                              |
| **Test Execution Steps** | 1.  Client send Negotiate request with dialect SMB 3.11, and without any Negotiate Contexts.                                     
                                                                                                                                                              
                            2.  Verify server fails the negotiate request with STATUS\_INVALID\_PARAMETER.                                                    |
| **Cleanup**              |                                                                                                                                  |

|                          |                                                                                                                                                                                                       |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Negotiate\_SMB311\_WithEncryptionContextWithoutIntegrityContext                                                                                                                                       |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Smb 3.11 dialect, with SMB2\_ENCRYPTION\_CAPABILITIES Context and without SMB2\_PREAUTH\_INTEGRITY\_CAPABILITIES Context. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Send Negotiate request with dialect SMB 3.11, with SMB2\_ENCRYPTION\_CAPABILITIES context, without SMB2\_PREAUTH\_INTEGRITY\_CAPABILITIES context.                                                
                                                                                                                                                                                                                                   
                            2.  Verify server fails the negotiate request with STATUS\_INVALID\_PARAMETER.                                                                                                                         |
| **Cleanup**              |                                                                                                                                                                                                       |

|                          |                                                                                                                                                                                   |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Negotiate\_SMB311\_InvalidHashAlgorithm                                                                                                                                           |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Smb 3.11 dialect and with an invalid HashAlgorithm in SMB2\_PREAUTH\_INTEGRITY\_CAPABILITIES Context. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                                                               |
| **Test Execution Steps** | 1.  Client send Negotiate request with dialect SMB 3.11, SMB2\_PREAUTH\_INTEGRITY\_CAPABILITIES context and set HashAlgorithm to an invalid value: 0xFFFF.                        
                                                                                                                                                                                                               
                            2.  Verify server fails the negotiate request with STATUS\_SMB\_NO\_PREAUTH\_INTEGRITY\_HASH\_OVERLAP.                                                                             |
| **Cleanup**              |                                                                                                                                                                                   |

|                          |                                                                                                                                                                    |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Negotiate\_SMB311\_InvalidCipher                                                                                                                                   |
| **Description **         | This test case is designed to test whether server can handle NEGOTIATE with Smb 3.11 dialect and with an invalid Cihper in SMB2\_ENCRYPTION\_CAPABILITIES Context. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                                                |
| **Test Execution Steps** | 1.  Client Send Negotiate request with dialect SMB 3.11, SMB2\_ENCRYPTION\_CAPABILITIES context and set Cipher to an invalid value: 0xFFFF.                        
                                                                                                                                                                                                
                            2.  Verify that server sets Connection.CipherId to 0 from the response.                                                                                             |
| **Cleanup**              |                                                                                                                                                                    |

### <span id="_Toc365033859" class="anchor"><span id="_Toc427488164" class="anchor"></span></span>Oplock

**Oplock** model verifies that server handles Oplock request and acknowledgement correctly when client requests different Oplock levels on various types of shares with a follow-up request break previous Oplock.

The feature contains 336 model-based test cases in 4 scenarios.

1.  #### Model

    1.  ##### Coverage

**Oplock** model covers the statements in following sections with exceptions mentioned in Assumptions/Restrictions section

-   3.3.4.6 Object Store Indicates an Oplock Break

-   3.3.5.9 Receiving an SMB2 CREATE Request (“Oplock Acquisition:”) (By default, covered by CreateClose Model)

-   3.3.5.22.1 Processing an Oplock Acknowledgment

    1.  ##### Assumption/Restriction

<!-- -->

-   The model does not cover Oplock requested on a directory which is not supported.

    1.  ##### Scenario Design

| **Scenario Name** | OplockOnShareWithoutForceLevel2OrSOFS                                                                                                                          |
|-------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Scenario for Share.ForceLevel2Oplock is FALSE and Share.Type does not includes STYPE\_CLUSTER\_SOFS                                                            |
| **Machine**       | ReadConfig;                                                                                                                                                    
                                                                                                                                                                                     
                     SetupConnection(\_, ModelShareFlag.NO\_SMB2\_SHAREFLAG\_FORCE\_LEVELII\_OPLOCK, ModelShareType.NO\_STYPE\_CLUSTER\_SOFS); //Negotiate,SessionSetup,TreeConnect  
                                                                                                                                                                                     
                     RequestOplockAndOperateFileRequest(\_, \_, out \_, out \_);//Request Oplock and do another operation on same file to attempt to trigger Oplock break            
                                                                                                                                                                                     
                     OplockBreakNotification?; // If no notification arrival, ack on non-breaking oplock will be tested                                                              
                                                                                                                                                                                     
                     OplockBreakAcknowledgementRequest;                                                                                                                              
                                                                                                                                                                                     
                     OplockBreakResponse;                                                                                                                                            |

| **Scenario Name** | OplockOnShareWithoutForceLevel2WithSOFS                                                                                                                    |
|-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Scenario for Share.ForceLevel2Oplock is FALSE and Share.Type includes STYPE\_CLUSTER\_SOFS                                                                 |
| **Machine**       | ReadConfig;                                                                                                                                                
                                                                                                                                                                                 
                     SetupConnection(\_, ModelShareFlag.NO\_SMB2\_SHAREFLAG\_FORCE\_LEVELII\_OPLOCK, ModelShareType.STYPE\_CLUSTER\_SOFS); //Negotiate,SessionSetup,TreeConnect  
                                                                                                                                                                                 
                     RequestOplockAndOperateFileRequest(\_, \_, out \_, out \_);//Request Oplock and do another operation on same file to attempt to trigger Oplock break        
                                                                                                                                                                                 
                     OplockBreakNotification?; // If no notification arrival, ack on non-breaking oplock will be tested                                                          
                                                                                                                                                                                 
                     OplockBreakAcknowledgementRequest;                                                                                                                          
                                                                                                                                                                                 
                     OplockBreakResponse;                                                                                                                                        |

| **Scenario Name** | OplockOnShareWithForceLevel2WithoutSOFS                                                                                                                    |
|-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Scenario for Share.ForceLevel2Oplock is TRUE and Share.Type does not includes STYPE\_CLUSTER\_SOFS                                                         |
| **Machine**       | ReadConfig;                                                                                                                                                
                                                                                                                                                                                 
                     SetupConnection(\_, ModelShareFlag.SMB2\_SHAREFLAG\_FORCE\_LEVELII\_OPLOCK, ModelShareType.NO\_STYPE\_CLUSTER\_SOFS); //Negotiate,SessionSetup,TreeConnect  
                                                                                                                                                                                 
                     RequestOplockAndOperateFileRequest(\_, \_, out \_, out \_);//Request Oplock and do another operation on same file to attempt to trigger Oplock break        
                                                                                                                                                                                 
                     OplockBreakNotification?; // If no notification arrival, ack on non-breaking oplock will be tested                                                          
                                                                                                                                                                                 
                     OplockBreakAcknowledgementRequest;                                                                                                                          
                                                                                                                                                                                 
                     OplockBreakResponse;                                                                                                                                        |

| **Scenario Name** | OplockOnShareWithForceLevel2AndSOFS                                                                                                                    |
|-------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Scenario for Share.ForceLevel2Oplock is TRUE and Share.Type includes STYPE\_CLUSTER\_SOFS                                                              |
| **Machine**       | ReadConfig;                                                                                                                                            
                                                                                                                                                                             
                     SetupConnection(\_, ModelShareFlag.SMB2\_SHAREFLAG\_FORCE\_LEVELII\_OPLOCK, ModelShareType.STYPE\_CLUSTER\_SOFS); //Negotiate,SessionSetup,TreeConnect  
                                                                                                                                                                             
                     RequestOplockAndOperateFileRequest(\_, \_, out \_, out \_); //Request Oplock and do another operation on same file to attempt to trigger Oplock break   
                                                                                                                                                                             
                     OplockBreakNotification?; // If no notification arrival, ack on non-breaking oplock will be tested                                                      
                                                                                                                                                                             
                     OplockBreakAcknowledgementRequest;                                                                                                                      
                                                                                                                                                                             
                     OplockBreakResponse;                                                                                                                                    |

### <span id="_Toc365033860" class="anchor"><span id="_Toc427488165" class="anchor"></span></span>Replay

**Replay** means the client can resend the request to the server and receive the same response.

The feature has 555 Model-Based test cases and 2 traditional test case.

For traditional test cases, please refer to section [3.1.17](#_Replay)

1.  #### Model

    1.  ##### Coverage

This model covers part of statements of the following sections which are related with replay:

-   2.2.1.1 SMB2 Packet Header - ASYNC

-   2.2.1.2 SMB2 Packet Header - SYNC

-   2.2.13.2.3 SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST

-   2.2.13.2.8 SMB2\_CREATE\_REQUEST\_LEASE

-   2.2.13.2.10 SMB2\_CREATE\_REQUEST\_LEASE\_V2

-   2.2.13.2.11 SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST\_V2

-   2.2.14.2.3 SMB2\_CREATE\_DURABLE\_HANDLE\_RESPONSE

-   2.2.14.2.10 SMB2\_CREATE\_RESPONSE\_LEASE

-   2.2.14.2.11 SMB2\_CREATE\_RESPONSE\_LEASE\_V2

-   2.2.14.2.12 SMB2\_CREATE\_DURABLE\_HANDLE\_RESPONSE\_V2

-   2.2.31.3 NETWORK\_RESILIENCY\_REQUEST Request

-   2.2.32 SMB2 IOCTL Response

-   2.2.39 SMB2 SET\_INFO Request

-   2.2.40 SMB2 SET\_INFO Response

-   3.3.5.9.6 Handling the SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST Create Context

-   3.3.5.9.8 Handling the SMB2\_CREATE\_REQUEST\_LEASE Create Context

-   3.3.5.9.11 Handling the SMB2\_CREATE\_REQUEST\_LEASE\_V2 Create Context

-   3.3.5.15.9 Handling a Resiliency Request

-   3.3.5.21.1 Handling SMB2\_0\_INFO\_FILE

-   3.3.7.1 Handling Loss of a Connection

This model covers all statements (except which are mentioned in “Assumptions/Restrictions” of the following sections:

-   3.3.4.1 Sending Any Outgoing Message

-   3.3.5.2.10 Verifying the Channel Sequence Number

-   3.3.5.9.10 Handling the SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 Create Context

    1.  ##### Assumptions/Restrictions

1.  This model focuses on the flag SMB2\_FLAGS\_REPLAY\_OPERATION and ChannelSequence in the SMB2 header.

2.  This model focuses on how to handle the Handling the SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 Create Context.

3.  This model also involves multi channels and leasing but only cover those behaviors related with replay operations.

4.  This model select READ as negative operation. Both the flag SMB2\_FLAGS\_REPLAY\_OPERATION and ChannelSequence should not impact the response.

5.  This model selects NETWORK\_RESILIENCY\_REQUEST Request to test IOCtl operation.

    1.  ##### Scenario Design

This model has 6 scenarios.

1.  ReplayCreateWithoutHandle

| **Description** | It’s a scenario to test how the server handles a create request with/without replay flag and valid/invalid channel sequence when no handle is created. |
|-----------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     | ReadConfig;                                                                                                                                            
                                                                                                                                                                           
                   CreateRequest(                                                                                                                                          
                                                                                                                                                                           
                   {ModelDialectRevision.Smb30, ModelDialectRevision.Smb302},                                                                                              
                                                                                                                                                                           
                   \_, // ReplayModelShareType                                                                                                                             
                                                                                                                                                                           
                   \_, // ReplayModelClientSupportPersistent                                                                                                               
                                                                                                                                                                           
                   ReplayModelSwitchChannelType.MainChannel,                                                                                                               
                                                                                                                                                                           
                   \_, // ReplayModelChannelSequenceType                                                                                                                   
                                                                                                                                                                           
                   \_, // ReplayModelSetReplayFlag                                                                                                                         
                                                                                                                                                                           
                   \_, // ReplayModelDurableHandle                                                                                                                         
                                                                                                                                                                           
                   \_, // ReplayModelRequestedOplockLevel                                                                                                                  
                                                                                                                                                                           
                   \_, // ReplayModelLeaseState                                                                                                                            
                                                                                                                                                                           
                   ReplayModelFileName.DefaultFileName,                                                                                                                    
                                                                                                                                                                           
                   ReplayModelCreateGuid.DefaultCreateGuid,                                                                                                                
                                                                                                                                                                           
                   ReplayModelFileAttributes.DefaultFileAttributes,                                                                                                        
                                                                                                                                                                           
                   ReplayModelCreateDisposition.DefaultCreateDisposition,                                                                                                  
                                                                                                                                                                           
                   ReplayModelLeaseKey.DefaultLeaseKey);                                                                                                                   
                                                                                                                                                                           
                   CreateResponse;                                                                                                                                         |

1.  ReplayCreateNormalHandle

| **Description** | It’s a scenario to test how the server handles a create request with/without replay flag and valid/invalid channel sequence when a normal handle is created. |
|-----------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     | ReadConfig;                                                                                                                                                  
                                                                                                                                                                                 
                   PrepareCreate(                                                                                                                                                
                                                                                                                                                                                 
                   \_,                                                                                                                                                           
                                                                                                                                                                                 
                   ReplayModelClientSupportPersistent.ClientNotSupportPersistent,                                                                                                
                                                                                                                                                                                 
                   ReplayModelDurableHandle.NormalHandle,                                                                                                                        
                                                                                                                                                                                 
                   ReplayModelShareType.NonCAShare,                                                                                                                              
                                                                                                                                                                                 
                   ReplayModelRequestedOplockLevel.OplockLevelNone,                                                                                                              
                                                                                                                                                                                 
                   ReplayModelLeaseState.LeaseStateIsNone);                                                                                                                      
                                                                                                                                                                                 
                   CreateRequest;                                                                                                                                                
                                                                                                                                                                                 
                   CreateResponse;                                                                                                                                               |

1.  ReplayCreateDurableHandleV1

| **Description** | It’s a scenario to test how the server handles a create request with/without replay flag and valid/invalid channel sequence when a durableV1 handle is created. |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     | ReadConfig;                                                                                                                                                     
                                                                                                                                                                                    
                   PrepareCreate(                                                                                                                                                   
                                                                                                                                                                                    
                   \_,                                                                                                                                                              
                                                                                                                                                                                    
                   ReplayModelClientSupportPersistent.ClientNotSupportPersistent,                                                                                                   
                                                                                                                                                                                    
                   ReplayModelDurableHandle.DurableHandleV1,                                                                                                                        
                                                                                                                                                                                    
                   ReplayModelShareType.NonCAShare,                                                                                                                                 
                                                                                                                                                                                    
                   ReplayModelRequestedOplockLevel.OplockLevelBatch,                                                                                                                
                                                                                                                                                                                    
                   {ReplayModelLeaseState.LeaseStateIsNone});                                                                                                                       
                                                                                                                                                                                    
                   CreateRequest;                                                                                                                                                   
                                                                                                                                                                                    
                   CreateResponse;                                                                                                                                                  |

1.  ReplayCreateDurableHandleV2

| **Description** | It’s a scenario to test how the server handles a create request with/without replay flag and valid/invalid channel sequence when a durableV2 handle (Non persistent) is created. |
|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     | ReadConfig;                                                                                                                                                                      
                                                                                                                                                                                                     
                   PrepareCreate(                                                                                                                                                                    
                                                                                                                                                                                                     
                   \_,                                                                                                                                                                               
                                                                                                                                                                                                     
                   ReplayModelClientSupportPersistent.ClientNotSupportPersistent,                                                                                                                    
                                                                                                                                                                                                     
                   ReplayModelDurableHandle.DurableHandleV2,                                                                                                                                         
                                                                                                                                                                                                     
                   ReplayModelShareType.NonCAShare,                                                                                                                                                  
                                                                                                                                                                                                     
                   {ReplayModelRequestedOplockLevel.OplockLevelLeaseV1, ReplayModelRequestedOplockLevel.OplockLevelLeaseV2},                                                                         
                                                                                                                                                                                                     
                   {ReplayModelLeaseState.LeaseStateIncludeH});                                                                                                                                      
                                                                                                                                                                                                     
                   CreateRequest;                                                                                                                                                                    
                                                                                                                                                                                                     
                   CreateResponse;                                                                                                                                                                   |

1.  ReplayCreateDurableHandleV2Persistent

| **Description** | It’s a scenario to test how the server handles a create request with/without replay flag and valid/invalid channel sequence when a persistent handle is created. |
|-----------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     | ReadConfig;                                                                                                                                                      
                                                                                                                                                                                     
                   PrepareCreate(                                                                                                                                                    
                                                                                                                                                                                     
                   \_,                                                                                                                                                               
                                                                                                                                                                                     
                   ReplayModelClientSupportPersistent.ClientSupportPersistent,                                                                                                       
                                                                                                                                                                                     
                   ReplayModelDurableHandle.DurableHandleV2Persistent,                                                                                                               
                                                                                                                                                                                     
                   ReplayModelShareType.CAShare,                                                                                                                                     
                                                                                                                                                                                     
                   {ReplayModelRequestedOplockLevel.OplockLevelLeaseV1, ReplayModelRequestedOplockLevel.OplockLevelLeaseV2},                                                         
                                                                                                                                                                                     
                   {ReplayModelLeaseState.LeaseStateIncludeH});                                                                                                                      
                                                                                                                                                                                     
                   CreateRequest;                                                                                                                                                    
                                                                                                                                                                                     
                   CreateResponse;                                                                                                                                                   |

1.  ReplayFileOperation

| **Description** | It’s a scenario to test how the server handles a READ/WRITE/IOCTL/SET\_INFO request with/without replay flag and valid/invalid channel sequence. |
|-----------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| **Machine**     | ReadConfig;                                                                                                                                      
                                                                                                                                                                     
                   PrepareFileOperation({ModelDialectRevision.Smb30, ModelDialectRevision.Smb302}, requestCommand)?;                                                 
                                                                                                                                                                     
                   FileOperationRequest(\_, \_, requestCommand, \_, \_, \_);                                                                                         
                                                                                                                                                                     
                   FileOperationResponse;                                                                                                                            |

### <span id="_Toc365033861" class="anchor"><span id="_Toc427488166" class="anchor"></span></span>ResilientHandle

**ResilientHandle** provides the capability to preserve the open even if there is intermittent losses in the network connectivity.

1.  #### Model

    1.  ##### Coverage

**ResilientHandle** Model covers all statements (except which are mentioned in “Assumptions/Restrictions”) of section 3.3.5.15.9 in \[MS-SMB2\]. And also ResilientHandle Model covers the statements related to Resilient Handle when Log Off or Loss Connection.

##### Assumptions/Restrictions

-   This model does not cover the logic related to Lock/Unlock, which will be cover in Lock/Unlock Model.

-   This model does not cover the logic related to Durable Handle, which is covered in Handle Model.

-   This model does not cover the logic related to Resilient Scavenger Timer, which is covered in traditional test case.

-   This model does not cover logic related to feature combination of Resilient Handle and Lease/OpLock Break, which will be covered in future Model for feature combination.

-   This model does not cover logic related to feature combination of Persistent Handle and Resilient Handle, which will be covered in traditional test case.

-   Do not cover common logic related to Receiving IoCtl Request, which will be in scope of IoCtrl Model.

    1.  ##### Scenario Design

| **Scenario ID** | ResilientHandleBasic                                                                                                    |
|-----------------|-------------------------------------------------------------------------------------------------------------------------|
| **Description** | Basic scenario to test how the server handles Resiliency Request and Resilient Handle when Log Off and Loss Connection. |
| **Machine**     | ReadConfig;                                                                                                             
                                                                                                                                            
                   // Negotiate, SessionSetup, TreeConnect, Create with no durable handle request                                           
                                                                                                                                            
                   PrepareOpen(\_, DurableHandle.NoDurableHandle);                                                                          
                                                                                                                                            
                   IoCtlResiliencyRequest; IoCtlResiliencyResponse;                                                                         
                                                                                                                                            
                   ( LogOff; | Disconnect; );                                                                                               
                                                                                                                                            
                   // Re-Establish a Resilient Open according to the section 3.2.4.4 in \[MS-SMB2\]                                         
                                                                                                                                            
                   ReEstablishResilientOpenRequest;                                                                                         
                                                                                                                                            
                   ReEstablishResilientOpenResponse;                                                                                        |

| **Scenario ID** | ResilientHandleDurable                                                                                                  |
|-----------------|-------------------------------------------------------------------------------------------------------------------------|
| **Description** | Test how the server handles Resiliency Request on durable handle and Resilient Handle when Log Off and Loss Connection. |
| **Machine**     | ReadConfig;                                                                                                             
                                                                                                                                            
                   // Negotiate, SessionSetup, TreeConnect, Create with durable handle request V1                                           
                                                                                                                                            
                   PrepareOpen(\_, DurableHandle.DurableHandle);                                                                            
                                                                                                                                            
                   IoCtlResiliencyRequest; IoCtlResiliencyResponse;                                                                         
                                                                                                                                            
                   ( LogOff; | Disconnect; );                                                                                               
                                                                                                                                            
                   // Re-Establish a Resilient Open according to the section 3.2.4.4 in \[MS-SMB2\]                                         
                                                                                                                                            
                   ReEstablishResilientOpenRequest;                                                                                         
                                                                                                                                            
                   ReEstablishResilientOpenResponse;                                                                                        |

#### Traditional Case

The traditional case is used to cover the below statement in section 3.3.5.9:

The server MUST verify the request size. If the size of the SMB2 CREATE Request (excluding the SMB2 header) is less than specified in the StructureSize field, then the request MUST be failed with STATUS\_ INVALID\_PARAMETER.

1.  ##### Resilient Handle with Persistent Handle

    1.  ###### Scenario

|                               |                                                                                                                                                                                                                                                                                                                                                                                                         |
|-------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**               | Request Resilient Handle on Persistent Handle.                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                 It covers the below statement in section 3.3.5.9:                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                 If Connection.Dialect is "3.000" and the request does not contain SMB2\_CREATE\_DURABLE\_HANDLE\_RECONNECT Create Context                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                 or SMB2\_CREATE\_DURABLE\_HANDLE\_RECONNECT\_V2 Create Context, the server MUST look up an existing open in the GlobalOpenTable where Open.FileName matches the file name in the Buffer field of the request. If an Open entry is found, if Open.IsPersistent is TRUE, \*Open.IsResilient is TRUE\* and if Open.Connection is NULL, the server MUST fail the request with STATUS\_FILE\_NOT\_AVAILABLE.  |
| **Message Sequence**          | Open Persistent Handle with lease                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                 Send Resiliency Request                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                 Disconnect                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                 Open the same file from different client (Different client guid)                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                 Verify the OPEN is created successfully                                                                                                                                                                                                                                                                                                                                                                  |
| **Cluster Involved Scenario** | **NO**                                                                                                                                                                                                                                                                                                                                                                                                  |

###### Test Case

|                          |                                                                                                                                                            |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ResilientWithPersistentHandle\_OpenFromDiffClient                                                                                                          |
| **Description **         | Verify that whether Open.IsResilient will impact persistent handle.                                                                                        
                                                                                                                                                                                        
                            Without resilient handle, server will return STATUS\_FILE\_NOT\_AVAILABLE when open the same file when Open.IsPersistent is True and Open is disconnected.  |
| **Prerequisites**        |                                                                                                                                                            |
| **Test Execution Steps** | 1.  SMB2 Negotiate with SUT                                                                                                                                
                                                                                                                                                                                        
                            2.  SMB2 Session Setup                                                                                                                                      
                                                                                                                                                                                        
                            3.  SMB2 Tree Connect to Share                                                                                                                              
                                                                                                                                                                                        
                            4.  SMB2 Create with no create context                                                                                                                      
                                                                                                                                                                                        
                            5.  SMB2 Resiliency Request                                                                                                                                 
                                                                                                                                                                                        
                            6.  Disconnect                                                                                                                                              
                                                                                                                                                                                        
                            7.  SMB2 Negotiate with SUT using new Client Guid                                                                                                           
                                                                                                                                                                                        
                            8.  SMB2 Session Setup                                                                                                                                      
                                                                                                                                                                                        
                            9.  SMB2 Tree Connect to the same Share                                                                                                                     
                                                                                                                                                                                        
                            10. SMB2 Create with same file name                                                                                                                         
                                                                                                                                                                                        
                            11. Verify the Create Response with Status SUCCESS                                                                                                          |

1.  ##### Resilient Open Scavenger Timer

    1.  ###### Scenario

|                               |                                                     |
|-------------------------------|-----------------------------------------------------|
| **Description**               | Resilient Open Scavenger Timer                      |
| **Message Sequence**          | Open File                                           
                                                                                      
                                 Send Resiliency Request with specific Timeout value  
                                                                                      
                                 Disconnect                                           
                                                                                      
                                 Wait for period time                                 
                                                                                      
                                 Verify the OPEN is terminated or not.                |
| **Cluster Involved Scenario** | **NO**                                              |

###### Test Case 

|                          |                                                                                          |
|--------------------------|------------------------------------------------------------------------------------------|
| **Test ID**              | ResilientOpenScavengerTimer\_ReconnectAfterTimeout                                       |
| **Description **         | Verify that the Open will be terminated after Resilient Open Scavenger Timer is expired. |
| **Prerequisites**        |                                                                                          |
| **Test Execution Steps** | 1.  SMB2 Negotiate with SUT                                                              
                                                                                                                      
                            2.  SMB2 Session Setup                                                                    
                                                                                                                      
                            3.  SMB2 Tree Connect to Share                                                            
                                                                                                                      
                            4.  SMB2 Create with no create context                                                    
                                                                                                                      
                            5.  SMB2 Resiliency Request with Timeout = 150 seconds                                    
                                                                                                                      
                            6.  Disconnect                                                                            
                                                                                                                      
                            7.  Wait for (150 + 10) seconds                                                           
                                                                                                                      
                            8.  Re-Establish Resilient Open as section 3.2.4.4 \[MS-SMB2\]                            
                                                                                                                      
                            9.  Verify the returned status is STATUS\_OBJECT\_NAME\_NOT\_FOUND.                       |

|                          |                                                                                          |
|--------------------------|------------------------------------------------------------------------------------------|
| **Test ID**              | ResilientOpenScavengerTimer\_ReconnectBeforeTimeout                                      |
| **Description **         | Verify that the Open will be preserved before Resilient Open Scavenger Timer is expired. |
| **Prerequisites**        |                                                                                          |
| **Test Execution Steps** | 1.  SMB2 Negotiate with SUT                                                              
                                                                                                                      
                            2.  SMB2 Session Setup                                                                    
                                                                                                                      
                            3.  SMB2 Tree Connect to Share                                                            
                                                                                                                      
                            4.  SMB2 Create with no create context                                                    
                                                                                                                      
                            5.  SMB2 Resiliency Request with Timeout = 150 seconds                                    
                                                                                                                      
                            6.  Disconnect                                                                            
                                                                                                                      
                            7.  Wait for (150 – 1) seconds                                                            
                                                                                                                      
                            8.  Re-Establish Resilient Open as section 3.2.4.4 \[MS-SMB2\]                            
                                                                                                                      
                            9.  Verify the returned status is STATUS\_SUCCESS.                                        |

|                          |                                                                                                                       |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ResilientOpenScavengerTimer\_ReconnectBeforeTimeout\_Zero                                                             |
| **Description **         | Verify that the Open will be preserved before Resilient Open Scavenger Timer is expired.                              |
| **Prerequisites**        |                                                                                                                       |
| **Test Execution Steps** | 1.  SMB2 Negotiate with SUT                                                                                           
                                                                                                                                                   
                            2.  SMB2 Session Setup                                                                                                 
                                                                                                                                                   
                            3.  SMB2 Tree Connect to Share                                                                                         
                                                                                                                                                   
                            4.  SMB2 Create with no create context                                                                                 
                                                                                                                                                   
                            5.  SMB2 Resiliency Request with Timeout = 0 seconds, Server should set the timeout to the default value 300 seconds.  
                                                                                                                                                   
                            6.  Disconnect                                                                                                         
                                                                                                                                                   
                            7.  Wait for (300 – 1) seconds                                                                                         
                                                                                                                                                   
                            8.  Re-Establish Resilient Open as section 3.2.4.4 \[MS-SMB2\]                                                         
                                                                                                                                                   
                            9.  Verify the returned status is STATUS\_SUCCESS.                                                                     |

### <span id="_Toc365033862" class="anchor"><span id="_Toc427488167" class="anchor"></span></span>SessionMgmt

**SessionMgmt** includes setup a session and logoff.

The feature has 251 Model-Based test cases and 3 traditional test cases.

For traditional test cases, please refer to section [3.1.21](#_SessionMgmt)

1.  #### Model

    1.  ##### Coverage

**SessionMgmt** model covers all statements of the following sections:

-   2.2.5 SMB2 SESSION\_SETUP Request

-   2.2.6 SMB2 SESSION\_SETUP Response

-   2.2.7 SMB2 LOGOFF Request

-   2.2.8 SMB2 LOGOFF Request

-   3.3.5.5 Receiving an SMB2 SESSION\_SETUP Request

-   3.3.5.6 Receiving an SMB2 LOGOFF Request

    1.  #####  Assumptions/Restrictions

NA

##### Scenario Design

This model has five scenarios:

| **Scenario Name** | SessionMgmtNewSession                                                                                                                          |
|-------------------|------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | It’s a basic scenario to test how the server handles SESSION\_SETUP Request and LOGOFF Request. Reconnection and binding is excluded.          |
| **Machine**       |   ReadConfig;                                                                                                                                  
                                                                                                                                                                     
                     (                                                                                                                                               
                                                                                                                                                                     
                     SetupConnection(ModelConnectionId.MainConnection,\_);                                                                                           
                                                                                                                                                                     
                     (                                                                                                                                               
                                                                                                                                                                     
                     SessionSetupRequest(ModelConnectionId.MainConnection,\_,\_,ModelSigned.SignFlagNotSet,\_,\_,ModelAllowReauthentication.AllowReauthentication);  
                                                                                                                                                                     
                     SessionSetupResponse;                                                                                                                           
                                                                                                                                                                     
                     )+;                                                                                                                                             
                                                                                                                                                                     
                     (                                                                                                                                               
                                                                                                                                                                     
                     (                                                                                                                                               
                                                                                                                                                                     
                     LogOffRequest(ModelConnectionId.MainConnection,\_);                                                                                             
                                                                                                                                                                     
                     (LogOffResponse|ExpectDisconnect(ModelConnectionId.MainConnection,\_));                                                                         
                                                                                                                                                                     
                     )                                                                                                                                               
                                                                                                                                                                     
                     )\*;                                                                                                                                            
                                                                                                                                                                     
                     )                                                                                                                                               |

| **Scenario Name** | SessionMgmtReconnectSession                                                                                                                                                                                                                                                                                            |
|-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | This scenario is to test session reconnection.                                                                                                                                                                                                                                                                         |
| **Machine**       | ReadConfig;                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                             
                     (                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                             
                     SetupConnection(ModelConnectionId.MainConnection,\_);                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                             
                     SessionSetupRequest(ModelConnectionId.MainConnection,ModelSessionId.ZeroSessionId,ModelSessionId.ZeroSessionId,ModelSigned.SignFlagNotSet,ModelFlags.NotBinding,ModelUser.DefaultUser,ModelAllowReauthentication.AllowReauthentication);                                                                                
                                                                                                                                                                                                                                                                                                                                             
                     SessionSetupResponse;                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                             
                     (                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                             
                     TerminateConnection(ModelConnectionId.MainConnection);                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                             
                     )?;                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                             
                     SetupConnection(ModelConnectionId.AlternativeConnection,\_);                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                             
                     SessionSetupRequest(ModelConnectionId.AlternativeConnection, ModelSessionId.ZeroSessionId, {ModelSessionId.MainSessionId, ModelSessionId.ZeroSessionId, ModelSessionId.AlternativeSessionId},ModelSigned.SignFlagNotSet,ModelFlags.NotBinding,ModelUser.DefaultUser,ModelAllowReauthentication.AllowReauthentication);  
                                                                                                                                                                                                                                                                                                                                             
                     SessionSetupResponse;                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                             
                     )                                                                                                                                                                                                                                                                                                                       |
|                   |                                                                                                                                                                                                                                                                                                                        |

| **Scenario Name** | SessionMgmtBindSession                                                                                                                                                                                                                                                                                                                                               |
|-------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | This scenario is to test session binding.                                                                                                                                                                                                                                                                                                                            |
| **Machine**       | ReadConfig;                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                           
                     (                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                           
                     SetupConnection(ModelConnectionId.MainConnection,\_);                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                           
                     SessionSetupRequest(ModelConnectionId.MainConnection,ModelSessionId.ZeroSessionId,ModelSessionId.ZeroSessionId,ModelSigned.SignFlagNotSet,ModelFlags.NotBinding,ModelUser.DefaultUser,ModelAllowReauthentication.NotAllowReauthentication);                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                           
                     SessionSetupResponse;                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                           
                     SetupConnection(ModelConnectionId.AlternativeConnection,\_);                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                           
                     SessionSetupRequest(ModelConnectionId.AlternativeConnection,{ModelSessionId.MainSessionId, ModelSessionId.ZeroSessionId, ModelSessionId.AlternativeSessionId /\*ModelSessionId.AlternativeSessionId has same effect as ModelSessionId.InvalidSessionId \*/},ModelSessionId.ZeroSessionId,\_,ModelFlags.Binding,\_,ModelAllowReauthentication.AllowReauthentication);  
                                                                                                                                                                                                                                                                                                                                                                                           
                     SessionSetupResponse;                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                           
                     )                                                                                                                                                                                                                                                                                                                                                                     |
|                   |                                                                                                                                                                                                                                                                                                                                                                      |

| **Scenario Name** | SessionMgmtBindSessionAfterLogOff                                                                                                                                                                                                                                                                                                                                    |
|-------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | This scenario is to test session binding after logoff.                                                                                                                                                                                                                                                                                                               |
| **Machine**       | ReadConfig;                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                           
                     (                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                           
                     SetupConnection(ModelConnectionId.MainConnection,\_);                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                           
                     SessionSetupRequest(ModelConnectionId.MainConnection,ModelSessionId.ZeroSessionId,ModelSessionId.ZeroSessionId,ModelSigned.SignFlagNotSet,ModelFlags.NotBinding,ModelUser.DefaultUser,ModelAllowReauthentication.AllowReauthentication);                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                           
                     SessionSetupResponse;                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                           
                     (                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                           
                     LogOffRequest(ModelConnectionId.MainConnection,ModelSessionId.MainSessionId);                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                           
                     (LogOffResponse|ExpectDisconnect(ModelConnectionId.MainConnection,\_));                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                           
                     );                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                           
                     SetupConnection(ModelConnectionId.AlternativeConnection,\_);                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                           
                     SessionSetupRequest(ModelConnectionId.AlternativeConnection,{ModelSessionId.MainSessionId, ModelSessionId.ZeroSessionId, ModelSessionId.AlternativeSessionId /\*ModelSessionId.AlternativeSessionId has same effect as ModelSessionId.InvalidSessionId \*/},ModelSessionId.ZeroSessionId,\_,ModelFlags.Binding,\_,ModelAllowReauthentication.AllowReauthentication);  
                                                                                                                                                                                                                                                                                                                                                                                           
                     SessionSetupResponse;                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                           
                     )                                                                                                                                                                                                                                                                                                                                                                     |
|                   |                                                                                                                                                                                                                                                                                                                                                                      |

| **Scenario Name** | SessionMgmtBindSessionAfterDisconnection                                                                                                                                                                                                                                                                                                                             |
|-------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | This scenario is to test session binding after disconnection.                                                                                                                                                                                                                                                                                                        |
| **Machine**       | ReadConfig;                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                           
                     (                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                           
                     SetupConnection(ModelConnectionId.MainConnection,\_);                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                           
                     SessionSetupRequest(ModelConnectionId.MainConnection,ModelSessionId.ZeroSessionId,ModelSessionId.ZeroSessionId,ModelSigned.SignFlagNotSet,ModelFlags.NotBinding,ModelUser.DefaultUser,ModelAllowReauthentication.AllowReauthentication);                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                           
                     SessionSetupResponse;                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                           
                     (                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                           
                     TerminateConnection(ModelConnectionId.MainConnection);                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                           
                     );                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                           
                     SetupConnection(ModelConnectionId.AlternativeConnection,\_);                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                           
                     SessionSetupRequest(ModelConnectionId.AlternativeConnection,{ModelSessionId.MainSessionId, ModelSessionId.ZeroSessionId, ModelSessionId.AlternativeSessionId /\*ModelSessionId.AlternativeSessionId has same effect as ModelSessionId.InvalidSessionId \*/},ModelSessionId.ZeroSessionId,\_,ModelFlags.Binding,\_,ModelAllowReauthentication.AllowReauthentication);  
                                                                                                                                                                                                                                                                                                                                                                                           
                     SessionSetupResponse;                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                           
                     )                                                                                                                                                                                                                                                                                                                                                                     |
|                   |                                                                                                                                                                                                                                                                                                                                                                      |

#### Traditional Case

Scenario see [section 3.1.22](#_SessionMgmt)

| **Test ID**                   | SessionMgmt\_ReconnectWithDifferentDialect                                                                          |
|-------------------------------|---------------------------------------------------------------------------------------------------------------------|
| **Description**               | This test case is designed to test whether server can handle reconnect with different dialect.                      |
| **Message Sequence**          | 1.  Client1 sends NEGOTIATE request                                                                                 
                                                                                                                                                      
                                 2.  Server sends NEGOTIATE response                                                                                  
                                                                                                                                                      
                                 3.  Client1 sends SESSION\_SETUP request with sessionid set zero                                                     
                                                                                                                                                      
                                 4.  Server sends SESSION\_SETUP response                                                                             
                                                                                                                                                      
                                 5.  Client1 disconnect.                                                                                              
                                                                                                                                                      
                                 6.  Client2 sends NEGOTIATE request, with different dialect from the one used by Client1.                            
                                                                                                                                                      
                                 7.  Server sends NEGOTIATE response                                                                                  
                                                                                                                                                      
                                 8.  Client2 sends SESSION\_SETUP request with SESSION\_ID set to the value in the previous SESSION\_SETUP response.  
                                                                                                                                                      
                                 9.  Expect server sends response with STATUS\_USER\_SESSION\_DELETED.                                                
                                                                                                                                                      
                                     Client2 disconnect.                                                                                              |
| **Cluster Involved Scenario** | NO                                                                                                                  |

1.  ### MultipleChannel

    1.  #### Traditional Case

Scenario see [section 3.1.7.1](#scenario-6)

| **Test ID**                   | MultipleChannel\_NicRedundantOnClient                 |
|-------------------------------|-------------------------------------------------------|
| **Description**               | Operate file via multi-channel with 2 Nics on client. |
| **Message Sequence**          | SETUP\_CONNECTION from client NIC\_1 to SUT NIC\_1    
                                                                                        
                                 NEGOTIATE                                              
                                                                                        
                                 SESSION\_SETUP                                         
                                                                                        
                                 TREE\_CONNECT                                          
                                                                                        
                                 CREATE                                                 
                                                                                        
                                 WRITE                                                  
                                                                                        
                                 SETUP\_CONNECTION from client NIC\_2 to SUT NIC\_1     
                                                                                        
                                 NEGOTIATE                                              
                                                                                        
                                 SESSION\_SETUP binding to the previous one             
                                                                                        
                                 TREE\_CONNECT                                          
                                                                                        
                                 CREATE                                                 
                                                                                        
                                 READ                                                   
                                                                                        
                                 Verify WRITE and READ data should be identical         |
| **Cluster Involved Scenario** | NO                                                    |

| **Test ID**                   | MultipleChannel\_NicRedundantOnServer                 |
|-------------------------------|-------------------------------------------------------|
| **Description**               | Operate file via multi-channel with 2 Nics on server. |
| **Message Sequence**          | SETUP\_CONNECTION from client NIC\_1 to SUT NIC\_1    
                                                                                        
                                 NEGOTIATE                                              
                                                                                        
                                 SESSION\_SETUP                                         
                                                                                        
                                 TREE\_CONNECT                                          
                                                                                        
                                 CREATE                                                 
                                                                                        
                                 WRITE                                                  
                                                                                        
                                 SETUP\_CONNECTION from client NIC\_1 to SUT NIC\_2     
                                                                                        
                                 NEGOTIATE                                              
                                                                                        
                                 SESSION\_SETUP binding to the previous one             
                                                                                        
                                 TREE\_CONNECT                                          
                                                                                        
                                 CREATE                                                 
                                                                                        
                                 READ                                                   
                                                                                        
                                 Verify WRITE and READ data should be identical         |
| **Cluster Involved Scenario** | NO                                                    |

| **Test ID**                   | MultipleChannel\_MultiChannelOnSameNic             |
|-------------------------------|----------------------------------------------------|
| **Description**               | Operate file via multi-channel on same Nic.        |
| **Message Sequence**          | SETUP\_CONNECTION from client NIC\_1 to SUT NIC\_1 
                                                                                     
                                 NEGOTIATE                                           
                                                                                     
                                 SESSION\_SETUP                                      
                                                                                     
                                 TREE\_CONNECT                                       
                                                                                     
                                 CREATE                                              
                                                                                     
                                 WRITE                                               
                                                                                     
                                 SETUP\_CONNECTION from client NIC\_1 to SUT NIC\_1  
                                                                                     
                                 NEGOTIATE                                           
                                                                                     
                                 SESSION\_SETUP binding to the previous one          
                                                                                     
                                 TREE\_CONNECT                                       
                                                                                     
                                 CREATE                                              
                                                                                     
                                 READ                                                
                                                                                     
                                 Verify WRITE and READ data should be identical      |
| **Cluster Involved Scenario** | NO                                                 |

| **Test ID**                   | Negative\_MultipleChannel\_SMB21                                                                                  |
|-------------------------------|-------------------------------------------------------------------------------------------------------------------|
| **Description**               | Operate file via multi-channel with SMB21 dialect, expect failure with error code STATUS\_REQUEST\_NOT\_ACCEPTED. |
| **Message Sequence**          | SETUP\_CONNECTION from client NIC\_1 to SUT NIC\_1                                                                
                                                                                                                                                    
                                 NEGOTIATE with dialect SMB2.1                                                                                      
                                                                                                                                                    
                                 SESSION\_SETUP                                                                                                     
                                                                                                                                                    
                                 TREE\_CONNECT                                                                                                      
                                                                                                                                                    
                                 CREATE                                                                                                             
                                                                                                                                                    
                                 WRITE                                                                                                              
                                                                                                                                                    
                                 SETUP\_CONNECTION from client NIC\_1 to SUT NIC\_2                                                                 
                                                                                                                                                    
                                 NEGOTIATE with dialect SMB2.1                                                                                      
                                                                                                                                                    
                                 SESSION\_SETUP binding to the previous one                                                                         
                                                                                                                                                    
                                 TREE\_CONNECT                                                                                                      
                                                                                                                                                    
                                 CREATE                                                                                                             
                                                                                                                                                    
                                 READ                                                                                                               
                                                                                                                                                    
                                 Expect failure with error code STATUS\_REQUEST\_NOT\_ACCEPTED                                                      |
| **Cluster Involved Scenario** | NO                                                                                                                |

| **Test ID**                   | Negative\_MultipleChannel\_SMB2002                                                                                  |
|-------------------------------|---------------------------------------------------------------------------------------------------------------------|
| **Description**               | Operate file via multi-channel with SMB2002 dialect, expect failure with error code STATUS\_REQUEST\_NOT\_ACCEPTED. |
| **Message Sequence**          | SETUP\_CONNECTION from client NIC\_1 to SUT NIC\_1                                                                  
                                                                                                                                                      
                                 NEGOTIATE with dialect SMB2.1                                                                                        
                                                                                                                                                      
                                 SESSION\_SETUP                                                                                                       
                                                                                                                                                      
                                 TREE\_CONNECT                                                                                                        
                                                                                                                                                      
                                 CREATE                                                                                                               
                                                                                                                                                      
                                 WRITE                                                                                                                
                                                                                                                                                      
                                 SETUP\_CONNECTION from client NIC\_1 to SUT NIC\_2                                                                   
                                                                                                                                                      
                                 NEGOTIATE with dialect SMB2.002                                                                                      
                                                                                                                                                      
                                 SESSION\_SETUP binding to the previous one                                                                           
                                                                                                                                                      
                                 TREE\_CONNECT                                                                                                        
                                                                                                                                                      
                                 CREATE                                                                                                               
                                                                                                                                                      
                                 READ                                                                                                                 
                                                                                                                                                      
                                 Expect failure with error code STATUS\_REQUEST\_NOT\_ACCEPTED                                                        |
| **Cluster Involved Scenario** | NO                                                                                                                  |

### <span id="_Toc365033863" class="anchor"><span id="_Toc427488169" class="anchor"></span></span>Signing

**Signing** Model is designed to test the server can handle signing according to client request and server configuration.

The feature has 95 Model-Based test cases, 1 traditional test case

For traditional test case, please refer to section [3.1.19.](#_Signing)

1.  #### Model

    1.  ##### Coverage

**Signing** Model covers all statements (except which are mentioned in “Assumptions/Restrictions”) of the following sections:

-   2.2.3 SMB2 NEGOTIATE Request

-   2.2.4 SMB2 NEGOTIATE Response

-   2.2.5 SMB2 SESSION\_SETUP Request

-   3.1.4.1 Signing An Outgoing Message

-   3.2.5.1.3 Verifying the Signature

-   3.2.5.3.1 Handling a New Authentication

-   3.2.5.3.2 Handling a Reauthentication

    1.  ##### Assumptions/Restrictions

<!-- -->

-   This model doesn’t test the algorithm of calculating the signature, for which will be covered with traditional test cases.

    1.  ##### Scenario Design

This model has one scenario:

| **Scenario Name** | Signing                                                       |
|-------------------|---------------------------------------------------------------|
| **Description**   | It’s a basic scenario to test how the server handles signing. |
| **Machine**       |  ReadConfig;                                                  
                                                                                    
                      (                                                             
                                                                                    
                     NegotiateRequest;                                              
                                                                                    
                     NegotiateResponse;                                             
                                                                                    
                     (                                                              
                                                                                    
                     SessionSetupRequest;                                           
                                                                                    
                     SessionSetupResponse;                                          
                                                                                    
                     (                                                              
                                                                                    
                     TreeConnectRequest;                                            
                                                                                    
                     TreeConnectResponse;                                           
                                                                                    
                     )?;                                                            
                                                                                    
                     )?;                                                            
                                                                                    
                     );                                                             |

### <span id="_Toc365033864" class="anchor"><span id="_Toc427488170" class="anchor"></span></span>TreeMgmt

**TreeMgmt** test the server behavior of receiving TreeConnect and TreeDisconnect.

1.  #### Model

    1.  ##### Coverage

**TreeMgmt** Model covers all statements (except which are mentioned in “Assumptions/Restrictions”) of the following sections:

-   3.3.5.7 Receiving an SMB2 TREE\_CONNECT Request

-   3.3.5.8 Receiving an SMB2 TREE\_DISCONNECT Request

-   2.2.9 SMB2 TREE\_CONNECT Request

-   2.2.10 SMB2 TREE\_CONNECT Response

-   2.2.11 SMB2 TREE\_DISCONNECT Request

-   2.2.12 SMB2 TREE\_DISCONNECT Response

    1.  ##### Assumptions/Restrictions

<!-- -->

-   This model only contains single session with single tree connect.

-   Does not cover encryption related logic which has been covered in Encryption model.

-   Does not cover session related logic which has been covered in Session Management model.

-   Does not cover validation of Negotiate logic which has been covered in Validate Negotiate Info model.

-   Does not cover signing related logic which will be covered in Signing model.

-   Does not cover Share Flags SMB2\_SHAREFLAG\_DFS and SMB2\_SHAREFLAG\_DFS\_ROOT and Capability SMB2\_SHARE\_CAP\_DFS in TREE\_CONNECT response, which is in the scope of DFS test suite.

-   Does not cover Capabilities SMB2\_SHARE\_CAP\_SCALEOUT, SMB2\_SHARE\_CAP\_CLUSTER and SMB2\_SHARE\_CAP\_CONTINUOUS\_AVAILABILITY in TREE\_CONNECT response, which is in the scope of Cluster test suite.

-   Does not cover Share Flag SMB2\_SHAREFLAG\_ENABLE\_HASH in TREE\_CONNECT response, which is in the scope of BranchCache test suite.

-   Does not cover Share Flag SMB2\_SHAREFLAG\_FORCE\_LEVELII\_OPLOCK in TREE\_CONNECT response, which is in the scope of Leasing model and OpLock model.

-   Does not cover Share Flag SMB2\_SHAREFLAG\_ACCESS\_BASED\_DIRECTORY\_ENUM in TREE\_CONNECT response, which is in the scope of Set/Query Info model.

-   Does not cover Share Flags SMB2\_SHAREFLAG\_RESTRICT\_EXCLUSIVE\_OPENS and SMB2\_SHAREFLAG\_FORCE\_SHARED\_DELETE and MaximalAccess in TREE\_CONNECT response, which is in the scope of Create/Close Model.

-   Does not cover Offline. It costs much effort to change the SUT control adapter for one not important feature.

-   Only cover ShareType.Disk. Currently Share Type "Pipe" and "Print" is not in the scope of FileSharing Test Suite Family.

-   Does not cover detail test of Share Path (example, server name is NetBIOS, FQDN or IP address) in TreeConnect request, which is in the scope of MS-SRVS.

    1.  ##### Scenario Design

| **Scenario Name** | ResilientHandleBasic                               |
|-------------------|----------------------------------------------------|
| **Description**   | TreeMgmt Model basic                               |
| **Machine**       | ReadConfig;                                        
                                                                         
                     // Negotiate, SessionSetup                          
                                                                         
                     SetupConnection;                                    
                                                                         
                     (TreeConnectRequest; TreeConnectResponse;)?;        
                                                                         
                     (TreeDisconnectRequest; TreeDisconnectResponse;)+;  |

#### Traditional Case

|                          |                                                                                                                                                                             |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | TreeMgmt\_SMB311\_CLUSTER\_RECONNECT                                                                                                                                        |
| **Description **         | Once a client has successfully connected to a clustered share it must set the CLUSTER\_RECONNECT flag on all subsequent clustered tree connect requests to the same server. 
                                                                                                                                                                                                         
                            This test case is designed to test server can handle a TreeConnect request with flag SMB2\_SHAREFLAG\_CLUSTER\_RECONNECT successfully.                                       |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                                                         |
| **Test Execution Steps** | 1.  Start a client by sending the following requests: NEGOTIATE (dialect 3.11); SESSION\_SETUP.                                                                             
                                                                                                                                                                                                         
                            2.  Client sends TREE\_CONNECT request with flag SMB2\_SHAREFLAG\_CLUSTER\_RECONNECT and expects STATUS\_SUCCESS.                                                            
                                                                                                                                                                                                         
                            3.  Tear down the client.                                                                                                                                                    |
| **Cleanup**              |                                                                                                                                                                             |

### <span id="_Toc365033865" class="anchor"><span id="_Toc427488171" class="anchor"></span></span>ValidateNegotiateInfo

Client uses an SMB2 IOCTL Request FSCTL\_VALIDATE\_NEGOTIATE\_INFO to request validation of a previous SMB2 NEGOTIATE.

1.  #### Model

    1.  ##### Coverage

**ValidateNegotiateInfo** Model covers all statements of the following sections:

-   3.3.5.15.12 Handling a Validate Negotiate Info Request

-   2.2.31.4 VALIDATE\_NEGOTIATE\_INFO Request

-   2.2.32.6 VALIDATE\_NEGOTIATE\_INFO Response

    1.  ##### Assumptions/Restrictions

<!-- -->

-   This model doesn’t cover all the parameters’ combination of Negotiate request.

    1.  ##### Scenario Design

| **Scenario Name** | ValidateNegotiateInfo                                                       |
|-------------------|-----------------------------------------------------------------------------|
| **Description**   | Basic scenario to test how the server handles ValidateNegotiateInfo Request |
| **Machine**       | ReadConfig;                                                                 
                                                                                                  
                     SetupConnection; // Negotiate, Session Setup, Tree Connect                   
                                                                                                  
                     ValidateNegotiateInfoRequest;                                                
                                                                                                  
                     (ValidateNegotiateInfoResponse | TerminateConnection);                       |

#### Traditional Case

Scenario see section [3.1.26.1](#scenario-18)

|                          |                                                                                                                                                                                                                |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ValidateNegotiateInfo\_Negative\_InvalidGuid                                                                                                                                                                   |
| **Description **         | Test whether the server terminates the transport connection and free the Connection object, if the Guid received in the VALIDATE\_NEGOTIATE\_INFO request structure is not equal to the Connection.ClientGuid. |
| **Prerequisites**        | The server implements dialect 3.0.                                                                                                                                                                             |
| **Test Execution Steps** | NEGOTIATE                                                                                                                                                                                                      
                                                                                                                                                                                                                                            
                            SESSION\_SETUP                                                                                                                                                                                                  
                                                                                                                                                                                                                                            
                            TREE\_CONNECT                                                                                                                                                                                                   
                                                                                                                                                                                                                                            
                            IOCTL (with FSCTL\_VALIDATE\_NEGOTIATE\_INFO having Guid not equal to original ClientGuid)                                                                                                                      
                                                                                                                                                                                                                                            
                            Expected server disconnects the connection                                                                                                                                                                      |
| **Cleanup**              |                                                                                                                                                                                                                |

|                          |                                                                                                                                                                                                                                                            |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ValidateNegotiateInfo\_Negative\_InvalidDialects\_NoCommonDialect                                                                                                                                                                                          |
| **Description **         | Test whether server terminates the transport connection and free the connection object if no dialect is matched when determine the greatest common dialect between the dialects it implements and the dialects array of VALIDATE\_NEGOTIATE\_INFO request. |
| **Prerequisites**        | The server implements dialect 3.0.                                                                                                                                                                                                                         |
| **Test Execution Steps** | NEGOTIATE with dialect larger or equal to 3.0                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                        
                            SESSION\_SETUP                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                        
                            TREE\_CONNECT                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                        
                            IOCTL (with FSCTL\_VALIDATE\_NEGOTIATE\_INFO having Dialect set to an unknown value)                                                                                                                                                                        
                                                                                                                                                                                                                                                                                        
                            Expected server disconnects the connection                                                                                                                                                                                                                  |
| **Cleanup**              |                                                                                                                                                                                                                                                            |

|                          |                                                                                                                                                                                                                                                                                            |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ValidateNegotiateInfo\_Negative\_InvalidDialects\_CommonDialectNotExpected                                                                                                                                                                                                                 |
| **Description **         | Test whether the server terminates the transport connection and free the Connection object, if the value is not equal to Connection.Dialect when determine the greatest common dialect between the dialects it implements and the Dialects array of the VALIDATE\_NEGOTIATE\_INFO request. |
| **Prerequisites**        | The server implements dialect 3.0.                                                                                                                                                                                                                                                         |
| **Test Execution Steps** | NEGOTIATE with dialect larger or equal to 3.0                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                            SESSION\_SETUP                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                            TREE\_CONNECT                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                        
                            IOCTL (with FSCTL\_VALIDATE\_NEGOTIATE\_INFO having Dialects set to {smb 2.002, smb 2.1})                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                        
                            Expected server disconnects the connection                                                                                                                                                                                                                                                  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                            |

|                          |                                                                                                                                                                                                                |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ValidateNegotiateInfo\_Negative\_InvalidGuid                                                                                                                                                                   |
| **Description **         | Test whether the server terminates the transport connection and free the Connection object, if the Guid received in the VALIDATE\_NEGOTIATE\_INFO request structure is not equal to the Connection.ClientGuid. |
| **Prerequisites**        | The server implements dialect 3.0.                                                                                                                                                                             |
| **Test Execution Steps** | NEGOTIATE                                                                                                                                                                                                      
                                                                                                                                                                                                                                            
                            SESSION\_SETUP                                                                                                                                                                                                  
                                                                                                                                                                                                                                            
                            TREE\_CONNECT                                                                                                                                                                                                   
                                                                                                                                                                                                                                            
                            IOCTL (with FSCTL\_VALIDATE\_NEGOTIATE\_INFO having Guid field different from the ClientGuid in Negotiate)                                                                                                      
                                                                                                                                                                                                                                            
                            Expected server disconnects the connection                                                                                                                                                                      |
| **Cleanup**              |                                                                                                                                                                                                                |

|                          |                                                                                                                                                                                                                            |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ValidateNegotiateInfo\_Negative\_InvalidSecurityMode                                                                                                                                                                       |
| **Description **         | Test whether the server terminates the transport connection and free the Connection object, if the SecurityMode received in the VALIDATE\_NEGOTIATE\_INFO request structure is not equal to Connection.ClientSecurityMode. |
| **Prerequisites**        | The server implements dialect 3.0.                                                                                                                                                                                         |
| **Test Execution Steps** | NEGOTIATE                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                        
                            SESSION\_SETUP                                                                                                                                                                                                              
                                                                                                                                                                                                                                                        
                            TREE\_CONNECT                                                                                                                                                                                                               
                                                                                                                                                                                                                                                        
                            IOCTL (with FSCTL\_VALIDATE\_NEGOTIATE\_INFO having SecurityMode field different from the one in Negotiate)                                                                                                                 
                                                                                                                                                                                                                                                        
                            Expected server disconnects the connection                                                                                                                                                                                  |
| **Cleanup**              |                                                                                                                                                                                                                            |

|                          |                                                                                                                                                                                                                            |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ValidateNegotiateInfo\_Negative\_InvalidCapabilities                                                                                                                                                                       |
| **Description **         | Test whether the server terminates the transport connection and free the Connection object, if Connection.ClientCapabilities is not equal to the Capabilities received in the VALIDATE\_NEGOTIATE\_INFO request structure. |
| **Prerequisites**        | The server implements dialect 3.0.                                                                                                                                                                                         |
| **Test Execution Steps** | NEGOTIATE                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                        
                            SESSION\_SETUP                                                                                                                                                                                                              
                                                                                                                                                                                                                                                        
                            TREE\_CONNECT                                                                                                                                                                                                               
                                                                                                                                                                                                                                                        
                            IOCTL (with FSCTL\_VALIDATE\_NEGOTIATE\_INFO having ClientCapabilities field different from the one in Negotiate)                                                                                                           
                                                                                                                                                                                                                                                        
                            Expected server disconnects the connection                                                                                                                                                                                  |
| **Cleanup**              |                                                                                                                                                                                                                            |

|                          |                                                                                                                                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ValidateNegotiateInfo\_Negative\_InvalidMaxOutputResponse                                                                                                                                            |
| **Description **         | Test whether the server terminates the transport connection and free the Connection object, if MaxOutputResponse in the IOCTL request is less than the size of a VALIDATE\_NEGOTIATE\_INFO Response. |
| **Prerequisites**        | The server implements dialect 3.0.                                                                                                                                                                   |
| **Test Execution Steps** | NEGOTIATE                                                                                                                                                                                            
                                                                                                                                                                                                                                  
                            SESSION\_SETUP                                                                                                                                                                                        
                                                                                                                                                                                                                                  
                            TREE\_CONNECT                                                                                                                                                                                         
                                                                                                                                                                                                                                  
                            IOCTL (with FSCTL\_VALIDATE\_NEGOTIATE\_INFO having MaxOutputResponse field less than the size of a VALIDATE\_NEGOTIATE\_INFO Response)                                                               
                                                                                                                                                                                                                                  
                            Expected server disconnects the connection                                                                                                                                                            |
| **Cleanup**              |                                                                                                                                                                                                      |

|                          |                                                                                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ValidateNegotiateInfo\_Negative\_SMB311                                                                                                              |
| **Description **         | Test whether the server can terminate the transport connection when receiving a VALIDATE\_NEGOTIATE\_INFO request if the negotiated dialect is 3.11. |
| **Prerequisites**        | The server implements dialect 3.11.                                                                                                                  |
| **Test Execution Steps** | NEGOTIATE with dialect 3.11                                                                                                                          
                                                                                                                                                                                  
                            SESSION\_SETUP                                                                                                                                        
                                                                                                                                                                                  
                            TREE\_CONNECT                                                                                                                                         
                                                                                                                                                                                  
                            IOCTL (with valid FSCTL\_VALIDATE\_NEGOTIATE\_INFO)                                                                                                   
                                                                                                                                                                                  
                            Expected server disconnects the connection                                                                                                            |
| **Cleanup**              |                                                                                                                                                      |

### FileLevelTrim

This feature is to call IOCTL request with FSCTL\_FILE\_LEVEL\_TRIM to trim unused space of a file.

#### Model

Will not cover this feature in model.

#### Traditional Case

Scenario see [section 3.1.9.1](#scenario-8)

|                          |                                                                                                           |
|--------------------------|-----------------------------------------------------------------------------------------------------------|
| **Test ID**              | FileLevelTrim\_Negative\_NonZeroKeyInRequest                                                              |
| **Description **         | Test the server response when non-zero value is set to the Key field of FSCTL\_FILE\_LEVEL\_TRIM request. |
| **Prerequisites**        |                                                                                                           |
| **Test Execution Steps** | NEGOTIATE                                                                                                 
                                                                                                                                       
                            SESSION\_SETUP                                                                                             
                                                                                                                                       
                            TREE\_CONNECT                                                                                              
                                                                                                                                       
                            CREATE                                                                                                     
                                                                                                                                       
                            WRITE                                                                                                      
                                                                                                                                       
                            CREATE                                                                                                     
                                                                                                                                       
                            IOCTL (with FSCTL\_FILE\_LEVEL\_TRIM, Key field is set to a non-zero random value)                         
                                                                                                                                       
                            Expect to get error response with “STATUS\_INVALID\_PARAMETER”.                                            
                                                                                                                                       
                            CLOSE                                                                                                      
                                                                                                                                       
                            TREE\_DISCONNECT                                                                                           
                                                                                                                                       
                            LOGOFF                                                                                                     |
| **Cleanup**              |                                                                                                           |

### CopyOfflaod

This feature is call IOCTL request with FSCTL\_OFFLOAD\_READ and FSCTL\_OFFLOAD\_WRITE to copy file content.

#### Model

Will not cover this feature in model.

#### Traditional Case

Scenario see section [3.1.8.1](#scenario-7)

|                          |                                                                                                                                                                       |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | CopyOffload\_CopyContentWithinSameFile                                                                                                                                |
| **Description **         | This test case is designed to test whether server can handle offload copy correctly when copy content in the same file.                                               |
| **Prerequisites**        |                                                                                                                                                                       |
| **Test Execution Steps** | 1.  Client sends NEGOTIATE request                                                                                                                                    
                                                                                                                                                                                                   
                            2.  Server sends NEGOTIATE response                                                                                                                                    
                                                                                                                                                                                                   
                            3.  Client sends SESSION\_SETUP request                                                                                                                                
                                                                                                                                                                                                   
                            4.  Server sends SESSION\_SETUP response                                                                                                                               
                                                                                                                                                                                                   
                            5.  According to the status code of last step, client may send more SESSION\_SETUP request as needed                                                                   
                                                                                                                                                                                                   
                            6.  Client sends TREE\_CONNECT request                                                                                                                                 
                                                                                                                                                                                                   
                            7.  Server sends TREE\_CONNECT response                                                                                                                                
                                                                                                                                                                                                   
                            8.  Client sends CREATE request to create a test file.                                                                                                                 
                                                                                                                                                                                                   
                            9.  Server sends CREATE response                                                                                                                                       
                                                                                                                                                                                                   
                            10. Client sends WRITE request to prepare content test file.                                                                                                           
                                                                                                                                                                                                   
                            11. Server sends WRITE response.                                                                                                                                       
                                                                                                                                                                                                   
                            12. Client sends FLUSH request to make sure the content is written to backend storage.                                                                                 
                                                                                                                                                                                                   
                            13. Server sends FLUSH response.                                                                                                                                       
                                                                                                                                                                                                   
                            14. Client sends IOCTL request with FSCTL\_OFFLOAD\_READ to ask server to generate the token of the 1<sup>st</sup> half of file content in the file for offload copy.  
                                                                                                                                                                                                   
                            15. Server sends IOCTL response                                                                                                                                        
                                                                                                                                                                                                   
                            16. Client sends IOCTL request with FSCTL\_OFFLOAD\_WRITE to ask server to copy the content to 2<sup>nd</sup> half in the file.                                        
                                                                                                                                                                                                   
                            17. Server sends IOCTL response                                                                                                                                        
                                                                                                                                                                                                   
                            18. Client sends READ request to read content of 2<sup>nd</sup> half in the file.                                                                                      
                                                                                                                                                                                                   
                            19. Server sends READ response                                                                                                                                         
                                                                                                                                                                                                   
                            20. Compare the read content is identical to the content of 1<sup>st</sup> half in the file.                                                                           
                                                                                                                                                                                                   
                            21. Client sends CLOSE request                                                                                                                                         
                                                                                                                                                                                                   
                            22. Server sends CLOSE response                                                                                                                                        
                                                                                                                                                                                                   
                            23. Client sends TREE\_DISCONNECT request                                                                                                                              
                                                                                                                                                                                                   
                            24. Server sends TREE\_DISCONNECT response                                                                                                                             
                                                                                                                                                                                                   
                            25. Client sends LOGOFF request                                                                                                                                        
                                                                                                                                                                                                   
                            26. Server sends LOGOFF response                                                                                                                                       |
| **Cleanup**              |                                                                                                                                                                       |

1.  ### <span id="_Toc394493036" class="anchor"><span id="_Toc394493037" class="anchor"><span id="_Toc394493038" class="anchor"><span id="_Toc394493039" class="anchor"><span id="_Toc394493040" class="anchor"><span id="_Toc394493041" class="anchor"><span id="_Toc394493042" class="anchor"><span id="_Toc394493079" class="anchor"><span id="_Toc394493116" class="anchor"><span id="_Toc394493153" class="anchor"><span id="_Toc394493190" class="anchor"><span id="_Toc394424078" class="anchor"><span id="_Toc394493191" class="anchor"><span id="_Toc394424079" class="anchor"><span id="_Toc394493192" class="anchor"><span id="_Toc394424104" class="anchor"><span id="_Toc394493217" class="anchor"><span id="_Toc427488174" class="anchor"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>OperateOneFileFromTwoNodes

    1.  #### Model

        1.  ##### Coverage

This model is designed to test the conflicting scenario:

Two clients do file operations to the same file by connecting to two Nodes of the scaleout file server. The file operations may have conflict.

This model covers part of the below sections:

-   2.2.26 SMB2 LOCK Request

-   3.3.5.14 Receiving an SMB2 LOCK Request

-   2.2.13 SMB2 CREATE Request

-   2.2.19 SMB2 READ Request

-   2.2.21 SMB2 WRITE Request

-   2.2.15 SMB2 CLOSE Request

    1.  ##### Assumptions/Restrictions

N/A

##### Scenario Design

| **Scenario Name** | Conflict                                                                                  |
|-------------------|-------------------------------------------------------------------------------------------|
| **Description**   | 1. Prepare a test file and initialize two clients.                                        
                                                                                                                
                     2. The first client does some file operation from one node to the test file successfully.  
                                                                                                                
                     3. The second client does some file operation from another node to the same test file.     
                                                                                                                
                     4. Verify the response to step 3.                                                          |
| **Machine**       | Preparation;                                                                              
                                                                                                                
                     ConflictRequest;                                                                           
                                                                                                                
                     ConflictResponse;                                                                          |

1.  ### MixedOplockLease

    1.  #### Model

        1.  ##### Coverage

This model is designed to test the below scenario:

One client requests Oplock, and another client requests Lease.

The model will verify if there should be an oplock or lease break, and if the granted OplockLevel or LeaseState is correct. (Note: the verification is based on Windows behavior)

This model covers part of the below sections:

-   3.3.4.7 Object Store Indicates a Lease Break

-   3.3.4.6 Object Store Indicates an Oplock Break

    1.  ##### Assumptions/Restrictions

N/A

##### Scenario Design

| **Scenario Name** | OplockLeaseScenario                                                            |
|-------------------|--------------------------------------------------------------------------------|
| **Description**   | 1. Initialize two clients.                                                     
                                                                                                     
                     2. The first client requests Oplock                                             
                                                                                                     
                     3. The second client requests Lease                                             
                                                                                                     
                     4. Verify if there's an oplock break and if the granted LeaseState is correct.  |
| **Machine**       | Preparation;                                                                   
                                                                                                     
                     RequestOplock;                                                                  
                                                                                                     
                     RequestLease;                                                                   
                                                                                                     
                     Verification;                                                                   |

| **Scenario Name** | LeaseOplockScenario                                                           |
|-------------------|-------------------------------------------------------------------------------|
| **Description**   | 1. Initialize two clients.                                                    
                                                                                                    
                     2. The first client requests Lease                                             
                                                                                                    
                     3. The second client requests Oplock                                           
                                                                                                    
                     4. Verify if there's a lease break and if the granted OplockLevel is correct.  |
| **Machine**       | Preparation;                                                                  
                                                                                                    
                     RequestLease;                                                                  
                                                                                                    
                     RequestOplock;                                                                 
                                                                                                    
                     Verification;                                                                  |

#### Traditional Case

No traditional cases for this feature.

SMB2 Feature Combination
------------------------

> Following scenarios extend “SMB2 Feature Test” by adding more complex message sequence in test.

1.  ### MultipleChannelWithReplay

    1.  #### Scenario

|                               |                                                                                                          |
|-------------------------------|----------------------------------------------------------------------------------------------------------|
| **Description**               | Replay the request via alternative channel when main channel connection lost                             |
| **Message Sequence**          | **Create main channel via connection1**                                                                  
                                                                                                                                           
                                 NEGOTIATE                                                                                                 
                                                                                                                                           
                                 SESSION\_SETUP                                                                                            
                                                                                                                                           
                                 TREE\_CONNECT                                                                                             
                                                                                                                                           
                                 **Create alterative channel via connection2**                                                             
                                                                                                                                           
                                 NEGOTIATE                                                                                                 
                                                                                                                                           
                                 SESSION\_SETUP (SMB2\_SESSION\_FLAG\_BINDING)                                                             
                                                                                                                                           
                                 **Send CREATE request via main channel**                                                                  
                                                                                                                                           
                                 CREATE (with no share access so that same CREATE without SMB2\_FLAGS\_REPLAY\_OPERATION flag would fail)  
                                                                                                                                           
                                 **Disconnect connection1**                                                                                
                                                                                                                                           
                                 **Replay the CREATE request via alternative channel**                                                     
                                                                                                                                           
                                 CREATE (with *SMB2\_FLAGS\_REPLAY\_OPERATION flag in header*)                                             
                                                                                                                                           
                                 CLOSE                                                                                                     
                                                                                                                                           
                                 TREE\_DISCONNECT                                                                                          
                                                                                                                                           
                                 LOGOFF                                                                                                    |
| **Cluster Involved Scenario** | **NO**                                                                                                   |

#### Test Case

|                          |                                                                                                                               |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------|
| **Test Id**              | MultipleChannel\_CreateReplay                                                                                                 |
| **Description**          | Replay the request via alternative channel when main channel connection lost                                                  |
| **Prerequisites**        |                                                                                                                               |
| **Test Execution Steps** | **Create main channel via connection1**                                                                                       
                                                                                                                                                           
                            Client sends NEGOTIATE request                                                                                                 
                                                                                                                                                           
                            Server sends NEGOTIATE response                                                                                                
                                                                                                                                                           
                            Client sends SESSION\_SETUP request                                                                                            
                                                                                                                                                           
                            Server sends SESSION\_SETUP response                                                                                           
                                                                                                                                                           
                            According to the status code of last step, client may send more SESSION\_SETUP request as needed                               
                                                                                                                                                           
                            Client sends TREE\_CONNECT request                                                                                             
                                                                                                                                                           
                            Server sends TREE\_CONNECT response                                                                                            
                                                                                                                                                           
                            **Create alterative channel via connection2**                                                                                  
                                                                                                                                                           
                            Client sends NEGOTIATE request                                                                                                 
                                                                                                                                                           
                            Server sends NEGOTIATE response                                                                                                
                                                                                                                                                           
                            Client sends SESSION\_SETUP request (SMB2\_SESSION\_FLAG\_BINDING)                                                             
                                                                                                                                                           
                            Server sends SESSION\_SETUP response                                                                                           
                                                                                                                                                           
                            **Send CREATE request via main channel**                                                                                       
                                                                                                                                                           
                            Client sends CREATE request (with no share access so that same CREATE without SMB2\_FLAGS\_REPLAY\_OPERATION flag would fail)  
                                                                                                                                                           
                            Server sends CREATE response                                                                                                   
                                                                                                                                                           
                            **Disconnect connection1**                                                                                                     
                                                                                                                                                           
                            **Replay the CREATE request via alternative channel**                                                                          
                                                                                                                                                           
                            Client sends same CREATE request (with *SMB2\_FLAGS\_REPLAY\_OPERATION flag in header*)                                        
                                                                                                                                                           
                            Server sends CREATE response                                                                                                   
                                                                                                                                                           
                            Client sends CLOSE request                                                                                                     
                                                                                                                                                           
                            Server sends CLOSE response                                                                                                    
                                                                                                                                                           
                            Client sends TREE\_DISCONNECT request                                                                                          
                                                                                                                                                           
                            Server sends TREE\_DISCONNECT response                                                                                         
                                                                                                                                                           
                            Client sends LOGOFF request                                                                                                    
                                                                                                                                                           
                            Server sends LOGOFF response                                                                                                   |
| **Cleanup**              |                                                                                                                               |

1.  ### MultipleChannelWithEncryption

    1.  #### Scenario

| **Description**               | Operate file via multi-channel with/without encryption on one channel or both channels |
|-------------------------------|----------------------------------------------------------------------------------------|
| **Message Sequence**          | **Create main channel**                                                                
                                                                                                                         
                                 NEGOTIATE (with/without SMB2\_GLOBAL\_CAP\_ENCRYPTION)                                  
                                                                                                                         
                                 SESSION\_SETUP                                                                          
                                                                                                                         
                                 TREE\_CONNECT (IPC$)                                                                    
                                                                                                                         
                                 IOCTL (FSCTL\_QUERY\_NETWORK\_INTERFACE\_INFO)                                          
                                                                                                                         
                                 TREE\_CONNECT                                                                           
                                                                                                                         
                                 CREATE (File)                                                                           
                                                                                                                         
                                 WRITE                                                                                   
                                                                                                                         
                                 **Create alterative channel**                                                           
                                                                                                                         
                                 NEGOTIATE (with/without SMB2\_GLOBAL\_CAP\_ENCRYPTION)                                  
                                                                                                                         
                                 SESSION\_SETUP (SMB2\_SESSION\_FLAG\_BINDING)                                           
                                                                                                                         
                                 READ                                                                                    
                                                                                                                         
                                 CLOSE                                                                                   
                                                                                                                         
                                 TREE\_DISCONNECT                                                                        
                                                                                                                         
                                 LOGOFF                                                                                  |
| **Cluster Involved Scenario** | **NO**                                                                                 |

#### Test Case

|                          |                                                                  |
|--------------------------|------------------------------------------------------------------|
| **Test ID**              | MultipleChannel\_EncryptionOnBothChannels                        |
| **Description **         | Operate file via multi-channel with encryption on both channels. |
| **Prerequisites**        |                                                                  |
| **Test Execution Steps** | Create main channel                                              
                                                                                              
                            NEGOTIATE (with/without SMB2\_GLOBAL\_CAP\_ENCRYPTION)            
                                                                                              
                            SESSION\_SETUP                                                    
                                                                                              
                            TREE\_CONNECT (IPC$)                                              
                                                                                              
                            IOCTL (FSCTL\_QUERY\_NETWORK\_INTERFACE\_INFO)                    
                                                                                              
                            TREE\_CONNECT                                                     
                                                                                              
                            CREATE (File)                                                     
                                                                                              
                            WRITE                                                             
                                                                                              
                            Create alterative channel                                         
                                                                                              
                            NEGOTIATE (with/without SMB2\_GLOBAL\_CAP\_ENCRYPTION)            
                                                                                              
                            SESSION\_SETUP (SMB2\_SESSION\_FLAG\_BINDING)                     
                                                                                              
                            READ                                                              
                                                                                              
                            CLOSE                                                             
                                                                                              
                            TREE\_DISCONNECT                                                  
                                                                                              
                            LOGOFF                                                            |
| **Cleanup**              |                                                                  |

|                          |                                                                      |
|--------------------------|----------------------------------------------------------------------|
| **Test ID**              | MultipleChannel\_Negative\_EncryptionOnMainChannel                   |
| **Description **         | Operate file via multi-channel only with encryption on main channel. |
| **Prerequisites**        |                                                                      |
| **Test Execution Steps** | Create main channel                                                  
                                                                                                  
                            NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)                        
                                                                                                  
                            SESSION\_SETUP                                                        
                                                                                                  
                            TREE\_CONNECT (IPC$)                                                  
                                                                                                  
                            IOCTL (FSCTL\_QUERY\_NETWORK\_INTERFACE\_INFO)                        
                                                                                                  
                            TREE\_CONNECT                                                         
                                                                                                  
                            CREATE (File)                                                         
                                                                                                  
                            WRITE                                                                 
                                                                                                  
                            Create alterative channel                                             
                                                                                                  
                            NEGOTIATE (without SMB2\_GLOBAL\_CAP\_ENCRYPTION)                     
                                                                                                  
                            SESSION\_SETUP (SMB2\_SESSION\_FLAG\_BINDING)                         
                                                                                                  
                            READ                                                                  
                                                                                                  
                            CLOSE                                                                 
                                                                                                  
                            TREE\_DISCONNECT                                                      
                                                                                                  
                            LOGOFF                                                                |
| **Cleanup**              |                                                                      |

|                          |                                                                            |
|--------------------------|----------------------------------------------------------------------------|
| **Test ID**              | MultipleChannel\_Negative\_EncryptionOnAlternativeChannel                  |
| **Description **         | Operate file via multi-channel only with encryption on alternative channel |
| **Prerequisites**        |                                                                            |
| **Test Execution Steps** | Create main channel                                                        
                                                                                                        
                            NEGOTIATE (without SMB2\_GLOBAL\_CAP\_ENCRYPTION)                           
                                                                                                        
                            SESSION\_SETUP                                                              
                                                                                                        
                            TREE\_CONNECT (IPC$)                                                        
                                                                                                        
                            IOCTL (FSCTL\_QUERY\_NETWORK\_INTERFACE\_INFO)                              
                                                                                                        
                            TREE\_CONNECT                                                               
                                                                                                        
                            CREATE (File)                                                               
                                                                                                        
                            WRITE                                                                       
                                                                                                        
                            Create alterative channel                                                   
                                                                                                        
                            NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)                              
                                                                                                        
                            SESSION\_SETUP (SMB2\_SESSION\_FLAG\_BINDING)                               
                                                                                                        
                            READ                                                                        
                                                                                                        
                            CLOSE                                                                       
                                                                                                        
                            TREE\_DISCONNECT                                                            
                                                                                                        
                            LOGOFF                                                                      |
| **Cleanup**              |                                                                            |

1.  ### MultipleChannelWithLease

    1.  #### Scenario

| **Description**               | Operate file via multi-channel with file lease and the lease break is expected from main channel |
|-------------------------------|--------------------------------------------------------------------------------------------------|
| **Message Sequence**          | **Create main channel via connection1**                                                          
                                                                                                                                   
                                 NEGOTIATE                                                                                         
                                                                                                                                   
                                 SESSION\_SETUP                                                                                    
                                                                                                                                   
                                 TREE\_CONNECT (IPC$)                                                                              
                                                                                                                                   
                                 IOCTL (FSCTL\_QUERY\_NETWORK\_INTERFACE\_INFO)                                                    
                                                                                                                                   
                                 TREE\_CONNECT                                                                                     
                                                                                                                                   
                                 CREATE (File, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state)                              
                                                                                                                                   
                                 WRITE                                                                                             
                                                                                                                                   
                                 **Create alterative channel via connection2**                                                     
                                                                                                                                   
                                 NEGOTIATE                                                                                         
                                                                                                                                   
                                 SESSION\_SETUP (SMB2\_SESSION\_FLAG\_BINDING)                                                     
                                                                                                                                   
                                 READ                                                                                              
                                                                                                                                   
                                 **From 3<sup>rd</sup> client to access the same file to trigger lease break**                     
                                                                                                                                   
                                 NEGOTIATE                                                                                         
                                                                                                                                   
                                 SESSION\_SETUP                                                                                    
                                                                                                                                   
                                 TREE\_CONNECT                                                                                     
                                                                                                                                   
                                 CREATE (with specific create flag)                                                                
                                                                                                                                   
                                 **From main channel via connection1**                                                             
                                                                                                                                   
                                 Expected to receive LEASE\_BREAK                                                                  
                                                                                                                                   
                                 Send LEASE\_BREAK\_ACK                                                                            
                                                                                                                                   
                                 TREE\_DISCONNECT                                                                                  
                                                                                                                                   
                                 LOGOFF                                                                                            |
| **Cluster Involved Scenario** | **NO**                                                                                           |

#### Test Case

|                          |                                                                                                   |
|--------------------------|---------------------------------------------------------------------------------------------------|
| **Test ID**              | MultipleChannel\_FileLease                                                                        |
| **Description **         | Operate file via multi-channel with file lease and the lease break is expected from main channel. |
| **Prerequisites**        |                                                                                                   |
| **Test Execution Steps** | **Create main channel via connection1**                                                           
                                                                                                                               
                            NEGOTIATE                                                                                          
                                                                                                                               
                            SESSION\_SETUP                                                                                     
                                                                                                                               
                            TREE\_CONNECT (IPC$)                                                                               
                                                                                                                               
                            IOCTL (FSCTL\_QUERY\_NETWORK\_INTERFACE\_INFO)                                                     
                                                                                                                               
                            TREE\_CONNECT                                                                                      
                                                                                                                               
                            CREATE (File, with SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state)                               
                                                                                                                               
                            WRITE                                                                                              
                                                                                                                               
                            **Create alterative channel via connection2**                                                      
                                                                                                                               
                            NEGOTIATE                                                                                          
                                                                                                                               
                            SESSION\_SETUP (SMB2\_SESSION\_FLAG\_BINDING)                                                      
                                                                                                                               
                            READ                                                                                               
                                                                                                                               
                            **From 3<sup>rd</sup> client to access the same file to trigger lease break**                      
                                                                                                                               
                            NEGOTIATE                                                                                          
                                                                                                                               
                            SESSION\_SETUP                                                                                     
                                                                                                                               
                            TREE\_CONNECT                                                                                      
                                                                                                                               
                            CREATE (with specific create flag)                                                                 
                                                                                                                               
                            **From main channel via connection1**                                                              
                                                                                                                               
                            Expected to receive LEASE\_BREAK                                                                   
                                                                                                                               
                            Send LEASE\_BREAK\_ACK                                                                             
                                                                                                                               
                            TREE\_DISCONNECT                                                                                   
                                                                                                                               
                            LOGOFF                                                                                             |
| **Cleanup**              |                                                                                                   |

1.  ### MultipleChannelWithLock

    1.  #### Scenario

| **Description**               | Operate file via multi-channel with lock operation on same/different channel    |
|-------------------------------|---------------------------------------------------------------------------------|
| **Message Sequence**          | **Create main channel**                                                         
                                                                                                                  
                                 NEGOTIATE                                                                        
                                                                                                                  
                                 SESSION\_SETUP                                                                   
                                                                                                                  
                                 TREE\_CONNECT (IPC$)                                                             
                                                                                                                  
                                 IOCTL (FSCTL\_QUERY\_NETWORK\_INTERFACE\_INFO)                                   
                                                                                                                  
                                 TREE\_CONNECT                                                                    
                                                                                                                  
                                 CREATE (File)                                                                    
                                                                                                                  
                                 LOCK (with SMB2\_LOCKFLAG\_SHARED\_LOCK in SMB2\_LOCK\_ELEMENT)                  
                                                                                                                  
                                 WRITE                                                                            
                                                                                                                  
                                 **Create alterative channel**                                                    
                                                                                                                  
                                 NEGOTIATE                                                                        
                                                                                                                  
                                 SESSION\_SETUP (SMB2\_SESSION\_FLAG\_BINDING)                                    
                                                                                                                  
                                 READ (the locking range, expect success)                                         
                                                                                                                  
                                 WRITE (the locking range, expect success)                                        
                                                                                                                  
                                 **From client3 open the same file and try to read and write the locking range**  
                                                                                                                  
                                 NEGOTIATE                                                                        
                                                                                                                  
                                 SESSION\_SETUP                                                                   
                                                                                                                  
                                 TREE\_CONNECT                                                                    
                                                                                                                  
                                 CREATE (File)                                                                    
                                                                                                                  
                                 READ (the locking range, expect success)                                         
                                                                                                                  
                                 WRITE (the locking range, expect fail)                                           
                                                                                                                  
                                 **From main/alternative channel to unlock the range**                            
                                                                                                                  
                                 LOCK (with SMB2\_LOCKFLAG\_UNLOCK in SMB2\_LOCK\_ELEMENT)                        
                                 CLOSE                                                                            
                                                                                                                  
                                 TREE\_DISCONNECT                                                                 
                                                                                                                  
                                 LOGOFF                                                                           
                                                                                                                  
                                 **From client3 try to write the range**                                          
                                                                                                                  
                                 WRITE (the locking range, expect success)                                        
                                                                                                                  
                                 CLOSE                                                                            
                                                                                                                  
                                 TREE\_DISCONNECT                                                                 
                                                                                                                  
                                 LOGOFF                                                                           |
| **Cluster Involved Scenario** | **NO**                                                                          |

#### Test Case

|                          |                                                                                 |
|--------------------------|---------------------------------------------------------------------------------|
| **Test ID**              | MultipleChannel\_LockUnlockOnSameChannel                                        |
| **Description **         | Operate file via multi-channel with lock operation on same channel.             |
| **Prerequisites**        |                                                                                 |
| **Test Execution Steps** | **Create main channel**                                                         
                                                                                                             
                            NEGOTIATE                                                                        
                                                                                                             
                            SESSION\_SETUP                                                                   
                                                                                                             
                            TREE\_CONNECT (IPC$)                                                             
                                                                                                             
                            IOCTL (FSCTL\_QUERY\_NETWORK\_INTERFACE\_INFO)                                   
                                                                                                             
                            TREE\_CONNECT                                                                    
                                                                                                             
                            CREATE (File)                                                                    
                                                                                                             
                            LOCK (with SMB2\_LOCKFLAG\_SHARED\_LOCK in SMB2\_LOCK\_ELEMENT)                  
                                                                                                             
                            WRITE                                                                            
                                                                                                             
                            **Create alterative channel**                                                    
                                                                                                             
                            NEGOTIATE                                                                        
                                                                                                             
                            SESSION\_SETUP (SMB2\_SESSION\_FLAG\_BINDING)                                    
                                                                                                             
                            READ (the locking range, expect success)                                         
                                                                                                             
                            WRITE (the locking range, expect failed)                                         
                                                                                                             
                            **From client3 open the same file and try to read and write the locking range**  
                                                                                                             
                            NEGOTIATE                                                                        
                                                                                                             
                            SESSION\_SETUP                                                                   
                                                                                                             
                            TREE\_CONNECT                                                                    
                                                                                                             
                            CREATE (File)                                                                    
                                                                                                             
                            READ (the locking range, expect success)                                         
                                                                                                             
                            WRITE (the locking range, expect fail)                                           
                                                                                                             
                            **From main channel unlock the range**                                           
                                                                                                             
                            LOCK (with SMB2\_LOCKFLAG\_UNLOCK in SMB2\_LOCK\_ELEMENT)                        
                            CLOSE                                                                            
                                                                                                             
                            TREE\_DISCONNECT                                                                 
                                                                                                             
                            LOGOFF                                                                           
                                                                                                             
                            **From client3 try to write the range**                                          
                                                                                                             
                            WRITE (the locking range, expect success)                                        
                                                                                                             
                            CLOSE                                                                            
                                                                                                             
                            TREE\_DISCONNECT                                                                 
                                                                                                             
                            LOGOFF                                                                           |
| **Cleanup**              |                                                                                 |

|                          |                                                                                 |
|--------------------------|---------------------------------------------------------------------------------|
| **Test ID**              | MultipleChannel\_LockUnlockOnDiffChannel                                        |
| **Description **         | Operate file via multi-channel with lock operation on different channels.       |
| **Prerequisites**        |                                                                                 |
| **Test Execution Steps** | **Create main channel**                                                         
                                                                                                             
                            NEGOTIATE                                                                        
                                                                                                             
                            SESSION\_SETUP                                                                   
                                                                                                             
                            TREE\_CONNECT (IPC$)                                                             
                                                                                                             
                            IOCTL (FSCTL\_QUERY\_NETWORK\_INTERFACE\_INFO)                                   
                                                                                                             
                            TREE\_CONNECT                                                                    
                                                                                                             
                            CREATE (File)                                                                    
                                                                                                             
                            LOCK (with SMB2\_LOCKFLAG\_SHARED\_LOCK in SMB2\_LOCK\_ELEMENT)                  
                                                                                                             
                            WRITE                                                                            
                                                                                                             
                            **Create alterative channel**                                                    
                                                                                                             
                            NEGOTIATE                                                                        
                                                                                                             
                            SESSION\_SETUP (SMB2\_SESSION\_FLAG\_BINDING)                                    
                                                                                                             
                            READ (the locking range, expect success)                                         
                                                                                                             
                            WRITE (the locking range, expect failed)                                         
                                                                                                             
                            **From client3 open the same file and try to read and write the locking range**  
                                                                                                             
                            NEGOTIATE                                                                        
                                                                                                             
                            SESSION\_SETUP                                                                   
                                                                                                             
                            TREE\_CONNECT                                                                    
                                                                                                             
                            CREATE (File)                                                                    
                                                                                                             
                            READ (the locking range, expect success)                                         
                                                                                                             
                            WRITE (the locking range, expect fail)                                           
                                                                                                             
                            **From alternative channel unlock the range**                                    
                                                                                                             
                            LOCK (with SMB2\_LOCKFLAG\_UNLOCK in SMB2\_LOCK\_ELEMENT)                        
                            CLOSE                                                                            
                                                                                                             
                            TREE\_DISCONNECT                                                                 
                                                                                                             
                            LOGOFF                                                                           
                                                                                                             
                            **From client3 try to write the range**                                          
                                                                                                             
                            WRITE (the locking range, expect success)                                        
                                                                                                             
                            CLOSE                                                                            
                                                                                                             
                            TREE\_DISCONNECT                                                                 
                                                                                                             
                            LOGOFF                                                                           |
| **Cleanup**              |                                                                                 |

1.  ### AppInstanceWithEncryption

    1.  #### Scenario

| **Description**               | Operate files with/without encryption before client failover or after failover |
|-------------------------------|--------------------------------------------------------------------------------|
| **Message Sequence**          | ***Based on NIC1, create client1:***                                           
                                                                                                                 
                                 NEGOTIATE (with/without SMB2\_GLOBAL\_CAP\_ENCRYPTION)                          
                                                                                                                 
                                 SESSION\_SETUP                                                                  
                                                                                                                 
                                 TREE\_CONNECT                                                                   
                                                                                                                 
                                 CREATE (With AppInstanceId)                                                     
                                                                                                                 
                                 WRITE                                                                           
                                                                                                                 
                                 *Disable NIC1*                                                                  
                                                                                                                 
                                 ***Switch to NIC2 and create Client2:***                                        
                                                                                                                 
                                 NEGOTIATE (with/without SMB2\_GLOBAL\_CAP\_ENCRYPTION)                          
                                                                                                                 
                                 SESSION\_SETUP                                                                  
                                                                                                                 
                                 TREE\_CONNECT                                                                   
                                                                                                                 
                                 CREATE (With the same AppInstanceId)                                            
                                                                                                                 
                                 READ                                                                            
                                                                                                                 
                                 CLOSE                                                                           
                                                                                                                 
                                 TREE\_DISCONNECT                                                                
                                                                                                                 
                                 LOGOFF                                                                          |
| **Cluster Involved Scenario** | **NO**                                                                         |

#### Test Case

| **Test ID**              | AppInstanceId\_Encryption                                             |
|--------------------------|-----------------------------------------------------------------------|
| **Description **         | Operate files with encrypted message before and after client failover |
| **Prerequisites**        |                                                                       |
| **Test Execution Steps** | ***Based on NIC1, create client1:***                                  
                                                                                                   
                            NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)                         
                                                                                                   
                            SESSION\_SETUP                                                         
                                                                                                   
                            TREE\_CONNECT (EncryptedShare)                                         
                                                                                                   
                            Send following messages encrypted                                      
                                                                                                   
                            CREATE (With AppID, exclusive open)                                    
                                                                                                   
                            WRITE                                                                  
                                                                                                   
                            Disable NIC1                                                           
                                                                                                   
                            ***Switch to NIC2 and create Client2:***                               
                                                                                                   
                            NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)                         
                                                                                                   
                            SESSION\_SETUP                                                         
                                                                                                   
                            TREE\_CONNECT (EncryptedShare)                                         
                                                                                                   
                            Send following messages encrypted                                      
                                                                                                   
                            CREATE (With the same AppID)                                           
                                                                                                   
                            READ                                                                   
                                                                                                   
                            CLOSE                                                                  
                                                                                                   
                            TREE\_DISCONNECT                                                       
                                                                                                   
                            LOGOFF                                                                 |
| **Cleanup**              |                                                                       |

| **Test ID**              | AppInstanceId\_Negative\_NoEncryptionInInitialOpen\_EncryptionInReOpen                                  |
|--------------------------|---------------------------------------------------------------------------------------------------------|
| **Description **         | Operate files with encrypted message before client failover but with unencrypted message after failover |
| **Prerequisites**        |                                                                                                         |
| **Test Execution Steps** | ***Based on NIC1, create client1:***                                                                    
                                                                                                                                     
                            NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)                                                           
                                                                                                                                     
                            SESSION\_SETUP                                                                                           
                                                                                                                                     
                            TREE\_CONNECT (EncryptedShare)                                                                           
                                                                                                                                     
                            Send following messages encrypted                                                                        
                                                                                                                                     
                            CREATE (With AppID, exclusive open)                                                                      
                                                                                                                                     
                            WRITE                                                                                                    
                                                                                                                                     
                            Disable NIC1                                                                                             
                                                                                                                                     
                            ***Switch to NIC2 and create Client2:***                                                                 
                                                                                                                                     
                            NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)                                                           
                                                                                                                                     
                            SESSION\_SETUP                                                                                           
                                                                                                                                     
                            TREE\_CONNECT (EncryptedShare)                                                                           
                                                                                                                                     
                            Send following messages unencrypted                                                                      
                                                                                                                                     
                            CREATE (With the same AppID)                                                                             
                                                                                                                                     
                            Expect error STATUS\_ACCESS\_DENIED in response                                                          
                                                                                                                                     
                            TREE\_DISCONNECT                                                                                         
                                                                                                                                     
                            Expect error STATUS\_ACCESS\_DENIED in response                                                          
                                                                                                                                     
                            LOGOFF                                                                                                   |
| **Cleanup**              |                                                                                                         |

| **Test ID**              | AppInstanceId\_Negative\_EncryptionInInitialOpen\_NoEncryptionInReOpen                           |
|--------------------------|--------------------------------------------------------------------------------------------------|
| **Description **         | Operate files with encrypted message before failover but with unencrypted message after failover |
| **Prerequisites**        |                                                                                                  |
| **Test Execution Steps** | ***Based on NIC1, create client1:***                                                             
                                                                                                                              
                            NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)                                                    
                                                                                                                              
                            SESSION\_SETUP                                                                                    
                                                                                                                              
                            TREE\_CONNECT (EncryptedShare)                                                                    
                                                                                                                              
                            Send following messages encrypted                                                                 
                                                                                                                              
                            CREATE (With AppID, exclusive open)                                                               
                                                                                                                              
                            Expect error STATUS\_ACCESS\_DENIED in response                                                   
                                                                                                                              
                            Disable NIC1                                                                                      
                                                                                                                              
                            ***Switch to NIC2 and create Client2:***                                                          
                                                                                                                              
                            NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)                                                    
                                                                                                                              
                            SESSION\_SETUP                                                                                    
                                                                                                                              
                            TREE\_CONNECT (EncryptedShare)                                                                    
                                                                                                                              
                            Send following messages encrypted                                                                 
                                                                                                                              
                            CREATE (With the same AppID)                                                                      
                                                                                                                              
                            CLOSE                                                                                             
                                                                                                                              
                            TREE\_DISCONNECT                                                                                  
                                                                                                                              
                            LOGOFF                                                                                            |
| **Cleanup**              |                                                                                                  |

1.  ### AppInstanceWithLease

    1.  #### Scenario

| **Description**               | Operate file/directory with lease before client failover and expect no lease state is maintained after client failover |
|-------------------------------|------------------------------------------------------------------------------------------------------------------------|
| **Message Sequence**          | ***Based on NIC1, create client1:***                                                                                   
                                                                                                                                                         
                                 NEGOTIATE                                                                                                               
                                                                                                                                                         
                                 SESSION\_SETUP                                                                                                          
                                                                                                                                                         
                                 TREE\_CONNECT                                                                                                           
                                                                                                                                                         
                                 CREATE (File/Directory, with AppInstanceId, SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state request)                   
                                                                                                                                                         
                                 WRITE                                                                                                                   
                                                                                                                                                         
                                 *Disable NIC1*                                                                                                          
                                                                                                                                                         
                                 ***Switch to NIC2 and create client2:***                                                                                
                                                                                                                                                         
                                 NEGOTIATE                                                                                                               
                                                                                                                                                         
                                 SESSION\_SETUP                                                                                                          
                                                                                                                                                         
                                 TREE\_CONNECT                                                                                                           
                                                                                                                                                         
                                 CREATE (File/Directory, with the same AppInstanceId with no lease state)                                                
                                                                                                                                                         
                                 READ                                                                                                                    
                                                                                                                                                         
                                 **From client3 on NIC2**                                                                                                
                                                                                                                                                         
                                 NEGOTIATE                                                                                                               
                                                                                                                                                         
                                 SESSION\_SETUP                                                                                                          
                                                                                                                                                         
                                 TREE\_CONNECT                                                                                                           
                                                                                                                                                         
                                 CREATE (with WRITE)                                                                                                     
                                                                                                                                                         
                                 Receive the CREATE response (no lease state kept on server after client failover)                                       
                                                                                                                                                         
                                 CLOSE                                                                                                                   
                                                                                                                                                         
                                 TREE\_DISCONNECT                                                                                                        
                                                                                                                                                         
                                 LOGOFF                                                                                                                  
                                                                                                                                                         
                                 **From client2 no lease break notification received**                                                                   
                                                                                                                                                         
                                 CLOSE                                                                                                                   
                                                                                                                                                         
                                 TREE\_DISCONNECT                                                                                                        
                                                                                                                                                         
                                 LOGOFF                                                                                                                  |
| **Cluster Involved Scenario** | **NO**                                                                                                                 |

#### Test Case

|                          |                                                                                                              |
|--------------------------|--------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AppInstanceId\_FileLeasing\_NoLeaseInReOpen                                                                  |
| **Description **         | Operate file with lease before client failover and expect no lease state is maintained after client failover |
| **Prerequisites**        |                                                                                                              |
| **Test Execution Steps** | ***Based on NIC1, create client1:***                                                                         
                                                                                                                                          
                            NEGOTIATE                                                                                                     
                                                                                                                                          
                            SESSION\_SETUP                                                                                                
                                                                                                                                          
                            TREE\_CONNECT                                                                                                 
                                                                                                                                          
                            CREATE (File, with AppInstanceId, SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state request)                   
                                                                                                                                          
                            WRITE                                                                                                         
                                                                                                                                          
                            *Disable NIC1*                                                                                                
                                                                                                                                          
                            ***Switch to NIC2 and create client2:***                                                                      
                                                                                                                                          
                            NEGOTIATE                                                                                                     
                                                                                                                                          
                            SESSION\_SETUP                                                                                                
                                                                                                                                          
                            TREE\_CONNECT                                                                                                 
                                                                                                                                          
                            CREATE (File, with the same AppInstanceId with no lease state)                                                
                                                                                                                                          
                            READ                                                                                                          
                                                                                                                                          
                            **From client3 on NIC2**                                                                                      
                                                                                                                                          
                            NEGOTIATE                                                                                                     
                                                                                                                                          
                            SESSION\_SETUP                                                                                                
                                                                                                                                          
                            TREE\_CONNECT                                                                                                 
                                                                                                                                          
                            CREATE (with WRITE)                                                                                           
                                                                                                                                          
                            Receive the CREATE response (no lease state kept on server after client failover)                             
                                                                                                                                          
                            CLOSE                                                                                                         
                                                                                                                                          
                            TREE\_DISCONNECT                                                                                              
                                                                                                                                          
                            LOGOFF                                                                                                        
                                                                                                                                          
                            **From client2 no lease break notification received**                                                         
                                                                                                                                          
                            CLOSE                                                                                                         
                                                                                                                                          
                            TREE\_DISCONNECT                                                                                              
                                                                                                                                          
                            LOGOFF                                                                                                        |
| **Cleanup**              |                                                                                                              |

|                          |                                                                                                              |
|--------------------------|--------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AppInstanceId\_DirectoryLeasing\_NoLeaseInReOpen                                                             |
| **Description **         | Operate file with lease before client failover and expect no lease state is maintained after client failover |
| **Prerequisites**        |                                                                                                              |
| **Test Execution Steps** | ***Based on NIC1, create client1:***                                                                         
                                                                                                                                          
                            NEGOTIATE                                                                                                     
                                                                                                                                          
                            SESSION\_SETUP                                                                                                
                                                                                                                                          
                            TREE\_CONNECT                                                                                                 
                                                                                                                                          
                            CREATE (Directory, with AppInstanceId, SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state request)              
                                                                                                                                          
                            *Disable NIC1*                                                                                                
                                                                                                                                          
                            ***Switch to NIC2 and create client2:***                                                                      
                                                                                                                                          
                            NEGOTIATE                                                                                                     
                                                                                                                                          
                            SESSION\_SETUP                                                                                                
                                                                                                                                          
                            TREE\_CONNECT                                                                                                 
                                                                                                                                          
                            CREATE (Directory, with the same AppInstanceId with no lease state)                                           
                                                                                                                                          
                            **From client3 on NIC2**                                                                                      
                                                                                                                                          
                            NEGOTIATE                                                                                                     
                                                                                                                                          
                            SESSION\_SETUP                                                                                                
                                                                                                                                          
                            TREE\_CONNECT                                                                                                 
                                                                                                                                          
                            CREATE (with WRITE)                                                                                           
                                                                                                                                          
                            Receive the CREATE response (no lease state kept on server after client failover)                             
                                                                                                                                          
                            CLOSE                                                                                                         
                                                                                                                                          
                            TREE\_DISCONNECT                                                                                              
                                                                                                                                          
                            LOGOFF                                                                                                        
                                                                                                                                          
                            **From client2 no lease break notification received**                                                         
                                                                                                                                          
                            CLOSE                                                                                                         
                                                                                                                                          
                            TREE\_DISCONNECT                                                                                              
                                                                                                                                          
                            LOGOFF                                                                                                        |
| **Cleanup**              |                                                                                                              |

1.  ### AppInstanceWithLock

    1.  #### Scenario

| **Description**               | Operate file with lock during client failover and expect no lock is maintained after failover |
|-------------------------------|-----------------------------------------------------------------------------------------------|
| **Message Sequence**          | ***Based on NIC1, create client1:***                                                          
                                                                                                                                
                                 NEGOTIATE                                                                                      
                                                                                                                                
                                 SESSION\_SETUP                                                                                 
                                                                                                                                
                                 TREE\_CONNECT                                                                                  
                                                                                                                                
                                 CREATE (File, with AppInstanceId)                                                              
                                                                                                                                
                                 WRITE                                                                                          
                                                                                                                                
                                 LOCK (with SMB2\_LOCKFLAG\_SHARED\_LOCK in SMB2\_LOCK\_ELEMENT)                                
                                                                                                                                
                                 *Disable NIC1*                                                                                 
                                                                                                                                
                                 ***Switch to NIC2 and create client2:***                                                       
                                                                                                                                
                                 NEGOTIATE                                                                                      
                                                                                                                                
                                 SESSION\_SETUP                                                                                 
                                                                                                                                
                                 TREE\_CONNECT                                                                                  
                                                                                                                                
                                 CREATE (File, with the same AppInstanceId)                                                     
                                                                                                                                
                                 READ (the locking range, expect success)                                                       
                                                                                                                                
                                 **From client3 on NIC2 **                                                                      
                                                                                                                                
                                 NEGOTIATE                                                                                      
                                                                                                                                
                                 SESSION\_SETUP                                                                                 
                                                                                                                                
                                 TREE\_CONNECT                                                                                  
                                                                                                                                
                                 CREATE (with WRITE)                                                                            
                                                                                                                                
                                 READ (the locking range, expect success)                                                       
                                                                                                                                
                                 WRITE (the locking range, expect success)                                                      
                                                                                                                                
                                 CLOSE                                                                                          
                                                                                                                                
                                 TREE\_DISCONNECT                                                                               
                                                                                                                                
                                 LOGOFF                                                                                         |
| **Cluster Involved Scenario** | **NO**                                                                                        |

#### Test Case

|                          |                                                                                               |
|--------------------------|-----------------------------------------------------------------------------------------------|
| **Test ID**              | AppInstanceId\_Lock\_ExpectNoLockInReOpen                                                     |
| **Description **         | Operate file with lock during client failover and expect no lock is maintained after failover |
| **Prerequisites**        |                                                                                               |
| **Test Execution Steps** | ***Based on NIC1, create client1:***                                                          
                                                                                                                           
                            NEGOTIATE                                                                                      
                                                                                                                           
                            SESSION\_SETUP                                                                                 
                                                                                                                           
                            TREE\_CONNECT                                                                                  
                                                                                                                           
                            CREATE (File, with AppInstanceId)                                                              
                                                                                                                           
                            WRITE                                                                                          
                                                                                                                           
                            LOCK (with SMB2\_LOCKFLAG\_SHARED\_LOCK in SMB2\_LOCK\_ELEMENT)                                
                                                                                                                           
                            *Disable NIC1*                                                                                 
                                                                                                                           
                            ***Switch to NIC2 and create client2:***                                                       
                                                                                                                           
                            NEGOTIATE                                                                                      
                                                                                                                           
                            SESSION\_SETUP                                                                                 
                                                                                                                           
                            TREE\_CONNECT                                                                                  
                                                                                                                           
                            CREATE (File, with the same AppInstanceId)                                                     
                                                                                                                           
                            READ (the locking range, expect success)                                                       
                                                                                                                           
                            **From client3 on NIC2 **                                                                      
                                                                                                                           
                            NEGOTIATE                                                                                      
                                                                                                                           
                            SESSION\_SETUP                                                                                 
                                                                                                                           
                            TREE\_CONNECT                                                                                  
                                                                                                                           
                            CREATE (with WRITE)                                                                            
                                                                                                                           
                            READ (the locking range, expect success)                                                       
                                                                                                                           
                            WRITE (the locking range, expect success)                                                      
                                                                                                                           
                            CLOSE                                                                                          
                                                                                                                           
                            TREE\_DISCONNECT                                                                               
                                                                                                                           
                            LOGOFF                                                                                         |
| **Cleanup**              |                                                                                               |

1.  ### CompoundWithEncryption

    1.  #### Scenario

| **Description**               | Send encrypted and compounded requests to SUT and verify response |
|-------------------------------|-------------------------------------------------------------------|
| **Message Sequence**          | NEGOTIATE                                                         
                                                                                                    
                                 SESSION\_SETUP                                                     
                                                                                                    
                                 TREE\_CONNECT                                                      
                                                                                                    
                                 Encrypted COMPOUND request                                         
                                                                                                    
                                 Verify COMPOUND response                                           
                                                                                                    
                                 TREEDISCONNECT                                                     
                                                                                                    
                                 LOGOFF                                                             |
| **Cluster Involved Scenario** | **NO**                                                            |

#### Test Case

|                      |                                                                                                                  |
|----------------------|------------------------------------------------------------------------------------------------------------------|
| **Test ID**          | Compound\_Encrypt\_RelatedRequests                                                                               |
| **Description**      | Send encrypted and compounded related requests (Create, Write and Close a same file) to SUT and verify response. |
| **Message Sequence** | NEGOTIATE                                                                                                        
                                                                                                                                          
                        SESSION\_SETUP                                                                                                    
                                                                                                                                          
                        TREE\_CONNECT                                                                                                     
                                                                                                                                          
                        Encrypted COMPOUND related request (CREATE, WRITE, and CLOSE to a same file)                                      
                                                                                                                                          
                        Verify COMPOUND response                                                                                          
                                                                                                                                          
                        TREEDISCONNECT                                                                                                    
                                                                                                                                          
                        LOGOFF                                                                                                            |

|                      |                                                                                                                       |
|----------------------|-----------------------------------------------------------------------------------------------------------------------|
| **Test ID**          | Compound\_Encrypt\_UnrelatedRequests                                                                                  |
| **Description**      | Send encrypted and compounded unrelated requests (two Creates request to different files) to SUT and verify response. |
| **Message Sequence** | NEGOTIATE                                                                                                             
                                                                                                                                               
                        SESSION\_SETUP                                                                                                         
                                                                                                                                               
                        TREE\_CONNECT                                                                                                          
                                                                                                                                               
                        Encrypted COMPOUND unrelated request (two Create requests to two different files)                                      
                                                                                                                                               
                        Verify COMPOUND response                                                                                               
                                                                                                                                               
                        TREEDISCONNECT                                                                                                         
                                                                                                                                               
                        LOGOFF                                                                                                                 |

<span id="_Toc358295208" class="anchor"><span id="_Toc358299581" class="anchor"><span id="_Toc358295241" class="anchor"><span id="_Toc358299614" class="anchor"><span id="_Toc358295307" class="anchor"><span id="_Toc358299680" class="anchor"><span id="_Toc358295334" class="anchor"><span id="_Toc358299707" class="anchor"><span id="_Toc358295335" class="anchor"><span id="_Toc358299708" class="anchor"><span id="_Toc358295336" class="anchor"><span id="_Toc358299709" class="anchor"><span id="_Toc358295337" class="anchor"><span id="_Toc358299710" class="anchor"><span id="_Toc427488185" class="anchor"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>Server Failover Test
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

|                                         |                |                               |                                 |
|-----------------------------------------|----------------|-------------------------------|---------------------------------|
| **Scenario**                            | **Test Cases** | **SMB 3.0 New Feature**       | **Hyper-V Scenario Importance** |
| **SWNGetInterfaceList**                 | 2              | **Yes**                       | Optional                        |
| **SWNRegistration**                     | 9              | **Yes**                       | Optional                        |
| **SWNAsyncNotification**                | 8              | **Yes**                       | **Critical**                    |
| **AsmmetricShare**                      | 4              | **No (SMB 3.02 new feature)** | **Critical**                    |
| **FileServerFailover**                  | 5              | **Yes**                       | **Critical**                    |
| **FileServerFailover\_Encryption**      | 3              | **Yes**                       | Optional                        |
| **FileServerFailover\_Lease**           | 2              | **Yes**                       | **Critical**                    |
| **FileServerFailover\_Lock**            | 1              | **Yes**                       | **Critical**                    |
| **FileServerFailover\_DurableHandleV2** | 1              | **Yes**                       | **Critical**                    |

1.  ### SWNGetInterfaceList

    1.  #### Scenario

| **Description**               | Get SWN interface list.  |
|-------------------------------|--------------------------|
| **Call Sequence**             | WitnessrGetInterfaceList |
| **Cluster Involved Scenario** | **YES**                  |

#### Test Case

|                          |                                                                                                          |
|--------------------------|----------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_SWNGetInterfaceList\_ClusterSingleNode                                                              |
| **Description **         | Ensure that the cluster does not response the interface list correctly until there is an available node. |
| **Prerequisites**        | Only Node1 provides the service. Node2 is disabled.                                                      |
| **Test Execution Steps** | 1.  Bind to cluster server                                                                               
                                                                                                                                      
                            2.  Invoke WitnessrGetInterfaceList                                                                       
                                                                                                                                      
                            3.  Client expects timeout                                                                                
                                                                                                                                      
                            4.  Enable Node2                                                                                          
                                                                                                                                      
                            5.  Invoke WitnessrGetInterfaceList                                                                       
                                                                                                                                      
                            6.  Client expects Status = **ERROR\_SUCCESS**, InterfaceList contains interface with                     
                                                                                                                                      
                                -   InterfaceGroupName = **Node2**                                                                    
                                                                                                                                      
                                -   State = **AVAILABLE**                                                                             
                                                                                                                                      
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                                                
                                                                                                                                      
                            > and contains interface with                                                                             
                                                                                                                                      
                            -   InterfaceGroupName = **Node1**                                                                        
                                                                                                                                      
                            -   State = **AVAILABLE**                                                                                 
                                                                                                                                      
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                                                   
                                                                                                                                      
                            1.  Unbind                                                                                                |
| **Cleanup**              | DeleteShareMapping                                                                                       |

| **Test ID**              | BVT\_SWNGetInterfaceList\_ScaleOutSingleNode                                                             |
|--------------------------|----------------------------------------------------------------------------------------------------------|
| **Description **         | Ensure that single node does not response the interface list correctly until there is an available node. |
| **Prerequisites**        | Only Node1 provides the service. Node2 is disabled.                                                      |
| **Test Execution Steps** | 1.  Bind to Node1                                                                                        
                                                                                                                                      
                            2.  Invoke WitnessrGetInterfaceList                                                                       
                                                                                                                                      
                            3.  Client expects timeout                                                                                
                                                                                                                                      
                            4.  Enable Node2                                                                                          
                                                                                                                                      
                            5.  Invoke WitnessrGetInterfaceList                                                                       
                                                                                                                                      
                            6.  Client expects Status = **ERROR\_SUCCESS**, InterfaceList contains interface with                     
                                                                                                                                      
                                -   InterfaceGroupName = **Node2**                                                                    
                                                                                                                                      
                                -   State = **AVAILABLE**                                                                             
                                                                                                                                      
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                                                
                                                                                                                                      
                            > and contains interface with                                                                             
                                                                                                                                      
                            -   InterfaceGroupName = **Node1**                                                                        
                                                                                                                                      
                            -   State = **AVAILABLE**                                                                                 
                                                                                                                                      
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                                                   
                                                                                                                                      
                            1.  Unbind                                                                                                |
| **Cleanup**              |                                                                                                          |

1.  ### SWNRegistration

    1.  #### Scenario

| **Description**               | Register and unregister the client. |
|-------------------------------|-------------------------------------|
| **Call Sequence**             | WitnessrRegister                    
                                                                      
                                 WitnessUnRegister                    |
| **Cluster Involved Scenario** | **YES**                             |

#### Test Case

| **Test ID**              | SWNRegistration\_InvalidNetName                                                   |
|--------------------------|-----------------------------------------------------------------------------------|
| **Description **         | Register with WitnessrRegister and invalid netname.                               |
| **Prerequisites**        |                                                                                   |
| **Test Execution Steps** | 1.  GetClusterResourceOwner                                                       
                                                                                                               
                            2.  Bind to cluster server                                                         
                                                                                                               
                            3.  Invoke WitnessrGetInterfaceList                                                
                                                                                                               
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with  
                                                                                                               
                                -   InterfaceGroupName != **ClusterResourceOwner**                             
                                                                                                               
                                -   State = **AVAILABLE**                                                      
                                                                                                               
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                         
                                                                                                               
                            > and contains interface with                                                      
                                                                                                               
                            -   InterfaceGroupName = **ClusterResourceOwner**                                  
                                                                                                               
                            -   State = **AVAILABLE**                                                          
                                                                                                               
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                            
                                                                                                               
                            1.  Unbind                                                                         
                                                                                                               
                            2.  Bind to **valid node**                                                         
                                                                                                               
                            3.  Invoke WitnessrRegister with **invalid NetName**                               
                                                                                                               
                            4.  Client expect Status = **ERROR\_INVALID\_PARAMETER**, Context is **EMPTY**.    
                                                                                                               
                            5.  Unbind                                                                         |
| **Cleanup**              |                                                                                   |

| **Test ID**              | SWNRegistration\_InvalidVersion                                                   |
|--------------------------|-----------------------------------------------------------------------------------|
| **Description **         | Register with WitnessrRegister and invalid version.                               |
| **Prerequisites**        |                                                                                   |
| **Test Execution Steps** | 1.  GetClusterResourceOwner                                                       
                                                                                                               
                            2.  Bind to cluster server                                                         
                                                                                                               
                            3.  Invoke WitnessrGetInterfaceList                                                
                                                                                                               
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with  
                                                                                                               
                                -   InterfaceGroupName != **ClusterResourceOwner**                             
                                                                                                               
                                -   State = **AVAILABLE**                                                      
                                                                                                               
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                         
                                                                                                               
                            > and contains interface with                                                      
                                                                                                               
                            -   InterfaceGroupName = **ClusterResourceOwner**                                  
                                                                                                               
                            -   State = **AVAILABLE**                                                          
                                                                                                               
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                            
                                                                                                               
                            1.  Unbind                                                                         
                                                                                                               
                            2.  Bind to **valid node**                                                         
                                                                                                               
                            3.  Invoke WitnessrRegister with **invalid Version**                               
                                                                                                               
                            4.  Client expect Status = **ERROR\_INVALID\_PARAMETER**, Context is **EMPTY**.    
                                                                                                               
                            5.  Unbind                                                                         |
| **Cleanup**              |                                                                                   |

| **Test ID**              | SWNRegistration\_InvalidIpAddress                                                  |
|--------------------------|------------------------------------------------------------------------------------|
| **Description **         | Register with WitnessrRegister and invalid IpAddress.                              |
| **Prerequisites**        |                                                                                    |
| **Test Execution Steps** | 1.  GetClusterResourceOwner                                                        
                                                                                                                
                            2.  Bind to cluster server                                                          
                                                                                                                
                            3.  Invoke WitnessrGetInterfaceList                                                 
                                                                                                                
                            4.  Client expects  Status = ERROR\_SUCCESS, InterfaceList contains interface with  
                                                                                                                
                                -   InterfaceGroupName != **ClusterResourceOwner**                              
                                                                                                                
                                -   State = **AVAILABLE**                                                       
                                                                                                                
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                          
                                                                                                                
                            > and contains interface with                                                       
                                                                                                                
                            -   InterfaceGroupName = **ClusterResourceOwner**                                   
                                                                                                                
                            -   State = **AVAILABLE**                                                           
                                                                                                                
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                             
                                                                                                                
                            1.  Unbind                                                                          
                                                                                                                
                            2.  Bind to **valid node**                                                          
                                                                                                                
                            3.  Invoke WitnessrRegister with **invalid IpAddress**                              
                                                                                                                
                            4.  Client expect Status =  **ERROR\_INVALID\_STATE**, Context is **EMPTY**.        
                                                                                                                
                            5.  Unbind                                                                          |
| **Cleanup**              |                                                                                    |

| **Test ID**              | SWNRegistration\_InvalidUnRegister                                                |
|--------------------------|-----------------------------------------------------------------------------------|
| **Description **         | Register with WitnessrRegister and Unregister the client twice.                   |
| **Prerequisites**        |                                                                                   |
| **Test Execution Steps** | 1.  GetClusterResourceOwner                                                       
                                                                                                               
                            2.  Bind to cluster server                                                         
                                                                                                               
                            3.  Invoke WitnessrGetInterfaceList                                                
                                                                                                               
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with  
                                                                                                               
                                -   InterfaceGroupName != **ClusterResourceOwner**                             
                                                                                                               
                                -   State = **AVAILABLE**                                                      
                                                                                                               
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                         
                                                                                                               
                            > and contains interface with                                                      
                                                                                                               
                            -   InterfaceGroupName = **ClusterResourceOwner**                                  
                                                                                                               
                            -   State = **AVAILABLE**                                                          
                                                                                                               
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                            
                                                                                                               
                            1.  Unbind                                                                         
                                                                                                               
                            2.  Bind **valid node**                                                            
                                                                                                               
                            3.  Invoke WitnessrRegister                                                        
                                                                                                               
                            4.  Invoke WitnessrUnRegister twice                                                
                                                                                                               
                            5.  Client expects Status != **ERROR\_NOT\_FOUND**                                 
                                                                                                               
                            6.  Unbind                                                                         |
| **Cleanup**              |                                                                                   |

| **Test ID**              | SWNRegistrationEx\_InvalidNetName                                                 |
|--------------------------|-----------------------------------------------------------------------------------|
| **Description **         | Register with WitnessrRegisterEx and invalid NetName.                             |
| **Prerequisites**        |                                                                                   |
| **Test Execution Steps** | 1.  GetClusterResourceOwner                                                       
                                                                                                               
                            2.  Bind to cluster server                                                         
                                                                                                               
                            3.  Invoke WitnessrGetInterfaceList                                                
                                                                                                               
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with  
                                                                                                               
                                -   InterfaceGroupName != **ClusterResourceOwner**                             
                                                                                                               
                                -   State = **AVAILABLE**                                                      
                                                                                                               
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                         
                                                                                                               
                            > and contains interface with                                                      
                                                                                                               
                            -   InterfaceGroupName = **ClusterResourceOwner**                                  
                                                                                                               
                            -   State = **AVAILABLE**                                                          
                                                                                                               
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                            
                                                                                                               
                            1.  Unbind                                                                         
                                                                                                               
                            2.  Bind to **valid node**                                                         
                                                                                                               
                            3.  Invoke WitnessrRegisterEx with **invalid NetName**                             
                                                                                                               
                            4.  Client expect Status = **ERROR\_INVALID\_PARAMETER**, Context is **EMPTY**.    
                                                                                                               
                            5.  Unbind                                                                         |
| **Cleanup**              |                                                                                   |

| **Test ID**              | SWNRegistrationEx\_InvalidVersion                                                 |
|--------------------------|-----------------------------------------------------------------------------------|
| **Description **         | Register with WitnessrRegisterEx and invalid version.                             |
| **Prerequisites**        |                                                                                   |
| **Test Execution Steps** | 1.  GetClusterResourceOwner                                                       
                                                                                                               
                            2.  Bind to cluster server                                                         
                                                                                                               
                            3.  Invoke WitnessrGetInterfaceList                                                
                                                                                                               
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with  
                                                                                                               
                                -   InterfaceGroupName != **ClusterResourceOwner**                             
                                                                                                               
                                -   State = **AVAILABLE**                                                      
                                                                                                               
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                         
                                                                                                               
                            > and contains interface with                                                      
                                                                                                               
                            -   InterfaceGroupName = **ClusterResourceOwner**                                  
                                                                                                               
                            -   State = **AVAILABLE**                                                          
                                                                                                               
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                            
                                                                                                               
                            1.  Unbind                                                                         
                                                                                                               
                            2.  Bind to **valid node**                                                         
                                                                                                               
                            3.  Invoke WitnessrRegisterEx with **invalid Version**                             
                                                                                                               
                            4.  Client expect Status = **ERROR\_INVALID\_PARAMETER**, Context is **EMPTY**.    
                                                                                                               
                            5.  Unbind                                                                         |

| **Test ID**              | SWNRegistrationEx\_InvalidIpAddress                                                |
|--------------------------|------------------------------------------------------------------------------------|
| **Description **         | Register with WitnessrRegisterEx and invalid IpAddress.                            |
| **Prerequisites**        |                                                                                    |
| **Test Execution Steps** | 1.  GetClusterResourceOwner                                                        
                                                                                                                
                            2.  Bind to cluster server                                                          
                                                                                                                
                            3.  Invoke WitnessrGetInterfaceList                                                 
                                                                                                                
                            4.  Client expects  Status = ERROR\_SUCCESS, InterfaceList contains interface with  
                                                                                                                
                                -   InterfaceGroupName != **ClusterResourceOwner**                              
                                                                                                                
                                -   State = **AVAILABLE**                                                       
                                                                                                                
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                          
                                                                                                                
                            > and contains interface with                                                       
                                                                                                                
                            -   InterfaceGroupName = **ClusterResourceOwner**                                   
                                                                                                                
                            -   State = **AVAILABLE**                                                           
                                                                                                                
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                             
                                                                                                                
                            1.  Unbind                                                                          
                                                                                                                
                            2.  Bind to **valid node**                                                          
                                                                                                                
                            3.  Invoke WitnessrRegisterEx with **invalid IpAddress**                            
                                                                                                                
                            4.  Client expect Status =  **ERROR\_INVALID\_STATE**, Context is **EMPTY**.        
                                                                                                                
                            5.  Unbind                                                                          |
| **Cleanup**              |                                                                                    |

| **Test ID**              | SWNRegistrationEx\_InvalidUnRegister                                              |
|--------------------------|-----------------------------------------------------------------------------------|
| **Description **         | Register with WitnessrRegisterEx and Unregister the client twice.                 |
| **Prerequisites**        |                                                                                   |
| **Test Execution Steps** | 1.  GetClusterResourceOwner                                                       
                                                                                                               
                            2.  Bind to cluster server                                                         
                                                                                                               
                            3.  Invoke WitnessrGetInterfaceList                                                
                                                                                                               
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with  
                                                                                                               
                                -   InterfaceGroupName != **ClusterResourceOwner**                             
                                                                                                               
                                -   State = **AVAILABLE**                                                      
                                                                                                               
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                         
                                                                                                               
                            > and contains interface with                                                      
                                                                                                               
                            -   InterfaceGroupName = **ClusterResourceOwner**                                  
                                                                                                               
                            -   State = **AVAILABLE**                                                          
                                                                                                               
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                            
                                                                                                               
                            1.  Unbind                                                                         
                                                                                                               
                            2.  Bind **valid node**                                                            
                                                                                                               
                            3.  Invoke WitnessrRegisterEx                                                      
                                                                                                               
                            4.  Invoke WitnessrUnRegister twice                                                
                                                                                                               
                            5.  Client expects Status != **ERROR\_NOT\_FOUND**                                 
                                                                                                               
                            6.  Unbind                                                                         |
| **Cleanup**              |                                                                                   |

| **Test ID**              | SWNRegistrationEx\_InvalidShareName                                               |
|--------------------------|-----------------------------------------------------------------------------------|
| **Description **         | Register with invalid sharename.                                                  |
| **Prerequisites**        |                                                                                   |
| **Test Execution Steps** | 1.  GetClusterResourceOwner                                                       
                                                                                                               
                            2.  Bind to cluster server                                                         
                                                                                                               
                            3.  Invoke WitnessrGetInterfaceList                                                
                                                                                                               
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with  
                                                                                                               
                                -   InterfaceGroupName != **ClusterResourceOwner**                             
                                                                                                               
                                -   State = **AVAILABLE**                                                      
                                                                                                               
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                         
                                                                                                               
                            > and contains interface with                                                      
                                                                                                               
                            -   InterfaceGroupName = **ClusterResourceOwner**                                  
                                                                                                               
                            -   State = **AVAILABLE**                                                          
                                                                                                               
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                            
                                                                                                               
                            1.  Unbind                                                                         
                                                                                                               
                            2.  Bind **valid node**                                                            
                                                                                                               
                            3.  Invoke WitnessrRegisterEx with invalid **ShareName**                           
                                                                                                               
                            4.  Invoke WitnessrUnRegister twice                                                
                                                                                                               
                            5.  Client expects Status != **ERROR\_INVALID\_STATE**                             
                                                                                                               
                            6.  Unbind                                                                         |
| **Cleanup**              |                                                                                   |

1.  ### SWNAsyncNotification

    1.  #### Scenario

| **Description**               | Get the asynchronous notification. |
|-------------------------------|------------------------------------|
| **Call Sequence**             | WitnessrRegister                   
                                                                     
                                 WitnessrAsyncNotify                 
                                                                     
                                 WitnessUnRegister                   |
| **Cluster Involved Scenario** | **YES**                            |

#### Test Case

| **Test ID**              | BVT\_WitnessrRegister\_SWNAsyncNotification\_ClientMove                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Register with WitnessrRegister and Get CLIENT\_MOVE\_NOTIFICATION on scaleout cluster server.                            |
| **Prerequisites**        |                                                                                                                          |
| **Test Execution Steps** | 1.  Get the address(Node01) of ScaleOutFs                                                                                
                                                                                                                                                      
                            2.  Bind to Node01                                                                                                        
                                                                                                                                                      
                            3.  Invoke WitnessrGetInterfaceList                                                                                       
                                                                                                                                                      
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with                                         
                                                                                                                                                      
                                -   InterfaceGroupName = **Node02**                                                                                   
                                                                                                                                                      
                                -   State = **AVAILABLE**                                                                                             
                                                                                                                                                      
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                                                                
                                                                                                                                                      
                            > and contains interface with                                                                                             
                                                                                                                                                      
                            -   InterfaceGroupName = **Node01**                                                                                       
                                                                                                                                                      
                            -   State = **AVAILABLE**                                                                                                 
                                                                                                                                                      
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                                                                   
                                                                                                                                                      
                            1.  Unbind                                                                                                                
                                                                                                                                                      
                            2.  Bind to **NODE02**                                                                                                    
                                                                                                                                                      
                            3.  Invoke **WitnessrRegister**                                                                                           
                                                                                                                                                      
                            4.  Client expect Status = **ERROR\_SUCCESS**, Context is not **EMPTY**.                                                  
                                                                                                                                                      
                            5.  Invoke WitnessrAsyncNotify with **valid context**                                                                     
                                                                                                                                                      
                            6.  Create a file on ScaleOutFs (Node01) and write buffer through SMB2.                                                   
                                                                                                                                                      
                            7.  Call Move-SmbWitnessClient –ClientName X –DestinationName NODE02 on NODE01.                                           
                                                                                                                                                      
                            8.  Client expects Status = **ERROR\_SUCCESS**, **RESP\_ASYNC\_NOTIFY with MessageType( CLIENT\_MOVE\_NOTIFICATION 2) **  
                                                                                                                                                      
                            9.  Invoke WitnessrUnRegister with **valid context**                                                                      
                                                                                                                                                      
                            10. Client expects Status = **ERROR\_SUCCESS**                                                                            
                                                                                                                                                      
                            11. Unbind                                                                                                                
                                                                                                                                                      
                            12. Read buffer and close the file on ScaleOutFs (Node02) through SMB2.                                                   |
| **Cleanup**              |                                                                                                                          |

| **Test ID**              | BVT\_WitnessrRegisterEx\_SWNAsyncNotification\_ClientMove                                                                |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Register with WitnessrRegisterEx and Get CLIENT\_MOVE\_NOTIFICATION on scaleout cluster server.                          |
| **Prerequisites**        |                                                                                                                          |
| **Test Execution Steps** | 1.  Get the address (Node01) of ScaleOutFs                                                                               
                                                                                                                                                      
                            2.  Bind to Node01                                                                                                        
                                                                                                                                                      
                            3.  Invoke WitnessrGetInterfaceList                                                                                       
                                                                                                                                                      
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with                                         
                                                                                                                                                      
                                -   InterfaceGroupName = **Node02**                                                                                   
                                                                                                                                                      
                                -   State = **AVAILABLE**                                                                                             
                                                                                                                                                      
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                                                                
                                                                                                                                                      
                            > and contains interface with                                                                                             
                                                                                                                                                      
                            -   InterfaceGroupName = **Node01**                                                                                       
                                                                                                                                                      
                            -   State = **AVAILABLE**                                                                                                 
                                                                                                                                                      
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                                                                   
                                                                                                                                                      
                            1.  Unbind                                                                                                                
                                                                                                                                                      
                            2.  Bind to **NODE02**                                                                                                    
                                                                                                                                                      
                            3.  Invoke **WitnessrRegisterEx**                                                                                         
                                                                                                                                                      
                            4.  Client expect Status = **ERROR\_SUCCESS**, Context is not **EMPTY**.                                                  
                                                                                                                                                      
                            5.  Invoke WitnessrAsyncNotify with **valid context**                                                                     
                                                                                                                                                      
                            6.  Create a file on ScaleOutFs (Node01) and write buffer through SMB2.                                                   
                                                                                                                                                      
                            7.  Call Move-SmbWitnessClient –ClientName X –DestinationName NODE02 on NODE01.                                           
                                                                                                                                                      
                            8.  Client expects Status = **ERROR\_SUCCESS**, **RESP\_ASYNC\_NOTIFY with MessageType( CLIENT\_MOVE\_NOTIFICATION 2) **  
                                                                                                                                                      
                            9.  Invoke WitnessrUnRegister with **valid context**                                                                      
                                                                                                                                                      
                            10. Client expects Status = **ERROR\_SUCCESS**                                                                            
                                                                                                                                                      
                            11. Unbind                                                                                                                
                                                                                                                                                      
                            12. Read buffer and close the file on ScaleOutFs (Node02) through SMB2.                                                   |
| **Cleanup**              |                                                                                                                          |

| **Test ID**              | SWNAsyncNotification\_InvalidRequest                                              |
|--------------------------|-----------------------------------------------------------------------------------|
| **Description **         | Assure that server responses correctly with invalid context.                      |
| **Prerequisites**        |                                                                                   |
| **Test Execution Steps** | 1.  GetClusterResourceOwner                                                       
                                                                                                               
                            2.  Bind to cluster server(GeneralFS)                                              
                                                                                                               
                            3.  Invoke WitnessrGetInterfaceList                                                
                                                                                                               
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with  
                                                                                                               
                                -   InterfaceGroupName != **ClusterResourceOwner**                             
                                                                                                               
                                -   State = **AVAILABLE**                                                      
                                                                                                               
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                         
                                                                                                               
                            > and contains interface with                                                      
                                                                                                               
                            -   InterfaceGroupName = **ClusterResourceOwner**                                  
                                                                                                               
                            -   State = **AVAILABLE**                                                          
                                                                                                               
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                            
                                                                                                               
                            1.  Unbind                                                                         
                                                                                                               
                            2.  Bind to **valid node**                                                         
                                                                                                               
                            3.  Invoke WitnessrAsyncNotify with **invalid context**                            
                                                                                                               
                            4.  Client expects Status = **ERROR\_NOT\_FOUND**                                  
                                                                                                               
                            5.  Unbind                                                                         |
| **Cleanup**              |                                                                                   |

| **Test ID**              | <span id="OLE_LINK2" class="anchor"><span id="OLE_LINK3" class="anchor"></span></span>WitnessrRegisterEx\_SWNAsyncNotification\_Timeout |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Get Timeout notification on scaleout cluster server.                                                                                    |
| **Prerequisites**        |                                                                                                                                         |
| **Test Execution Steps** | 1.  Get the address(Node01) of ScaleOutFs                                                                                               
                                                                                                                                                                     
                            2.  Bind to Node01                                                                                                                       
                                                                                                                                                                     
                            3.  Invoke WitnessrGetInterfaceList                                                                                                      
                                                                                                                                                                     
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with                                                        
                                                                                                                                                                     
                                -   InterfaceGroupName = **Node02**                                                                                                  
                                                                                                                                                                     
                                -   State = **AVAILABLE**                                                                                                            
                                                                                                                                                                     
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                                                                               
                                                                                                                                                                     
                            > and contains interface with                                                                                                            
                                                                                                                                                                     
                            -   InterfaceGroupName = **Node01**                                                                                                      
                                                                                                                                                                     
                            -   State = **AVAILABLE**                                                                                                                
                                                                                                                                                                     
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                                                                                  
                                                                                                                                                                     
                            1.  Unbind                                                                                                                               
                                                                                                                                                                     
                            2.  Bind to **NODE02**                                                                                                                   
                                                                                                                                                                     
                            3.  Invoke WitnessrRegisterEx with KeepAliveTimout(10s)                                                                                  
                                                                                                                                                                     
                            4.  Client expect Status = **ERROR\_SUCCESS**, Context is not **EMPTY**.                                                                 
                                                                                                                                                                     
                            5.  Invoke WitnessrAsyncNotify with **valid context**                                                                                    
                                                                                                                                                                     
                            6.  Client expects Status = **ERROR\_TIMEOUT**                                                                                           
                                                                                                                                                                     
                            7.  Invoke WitnessrUnRegister with **valid context**                                                                                     
                                                                                                                                                                     
                            8.  Client expects Status = **ERROR\_SUCCESS**                                                                                           
                                                                                                                                                                     
                            9.  Unbind                                                                                                                               |
| **Cleanup**              |                                                                                                                                         |

| **Test ID**              | BVT\_WitnessrRegisterEx\_SWNAsyncNotification\_ShareMove                                                                |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Get SHARE\_MOVE\_NOTIFICATION on scaleout cluster server.                                                               |
| **Prerequisites**        |                                                                                                                         |
| **Test Execution Steps** | 1.  Get the address(Node01) of ScaleOutFs                                                                               
                                                                                                                                                     
                            2.  Bind to Node01                                                                                                       
                                                                                                                                                     
                            3.  Invoke WitnessrGetInterfaceList                                                                                      
                                                                                                                                                     
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with                                        
                                                                                                                                                     
                                1.  InterfaceGroupName = **Node02**                                                                                  
                                                                                                                                                     
                                2.  State = **AVAILABLE**                                                                                            
                                                                                                                                                     
                                3.  Flags & **INTERFACE\_WITNESS(0x00000004) == true**                                                               
                                                                                                                                                     
                            > and contains interface with                                                                                            
                                                                                                                                                     
                            1.  InterfaceGroupName = **Node01**                                                                                      
                                                                                                                                                     
                            2.  State = **AVAILABLE**                                                                                                
                                                                                                                                                     
                            3.  Flags & **INTERFACE\_WITNESS(0x00000004) == false**                                                                  
                                                                                                                                                     
                            <!-- -->                                                                                                                 
                                                                                                                                                     
                            1.  Unbind                                                                                                               
                                                                                                                                                     
                            2.  Bind to **NODE02**                                                                                                   
                                                                                                                                                     
                            3.  Invoke WitnessrRegisterEx with **ShareName(**“**SMBClustered”)**                                                     
                                                                                                                                                     
                            4.  Client expect Status = **ERROR\_SUCCESS**, Context is not **EMPTY**.                                                 
                                                                                                                                                     
                            5.  Invoke WitnessrAsyncNotify with **valid context**                                                                    
                                                                                                                                                     
                            6.  Call Move-ClusterSharedVolume -Name “SMBScaleOutDisk” on scaleout cluster.                                           
                                                                                                                                                     
                            7.  Client expects Status = **ERROR\_SUCCESS**, **RESP\_ASYNC\_NOTIFY with MessageType( SHARE\_MOVE\_NOTIFICATION 3) **  
                                                                                                                                                     
                            8.  Invoke WitnessrUnRegister with **valid context**                                                                     
                                                                                                                                                     
                            9.  Client expects Status = **ERROR\_SUCCESS**                                                                           
                                                                                                                                                     
                            10. Unbind                                                                                                               |
| **Cleanup**              |                                                                                                                         |

| **Test ID**              | BVT\_WitnessrRegisterEx\_SWNAsyncNotification\_IPChange                                                               |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------|
| **Description **         | Get IP\_CHANGE\_NOTIFICATION on scaleout cluster server.                                                              |
| **Prerequisites**        |                                                                                                                       |
| **Test Execution Steps** | 1.  Get the address(Node01) of ScaleOutFs                                                                             
                                                                                                                                                   
                            2.  Bind to Node01                                                                                                     
                                                                                                                                                   
                            3.  Invoke WitnessrGetInterfaceList                                                                                    
                                                                                                                                                   
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with                                      
                                                                                                                                                   
                                1.  InterfaceGroupName = **Node02**                                                                                
                                                                                                                                                   
                                2.  State = **AVAILABLE**                                                                                          
                                                                                                                                                   
                                3.  Flags & **INTERFACE\_WITNESS(0x00000004) == true**                                                             
                                                                                                                                                   
                            > and contains interface with                                                                                          
                                                                                                                                                   
                            1.  InterfaceGroupName = **Node01**                                                                                    
                                                                                                                                                   
                            2.  State = **AVAILABLE**                                                                                              
                                                                                                                                                   
                            3.  Flags & **INTERFACE\_WITNESS(0x00000004) == false**                                                                
                                                                                                                                                   
                            <!-- -->                                                                                                               
                                                                                                                                                   
                            1.  Unbind                                                                                                             
                                                                                                                                                   
                            2.  Bind to **NODE02**                                                                                                 
                                                                                                                                                   
                            3.  Invoke WitnessrRegisterEx with **Flags**(**WITNESS\_REGISTER\_IP\_NOTIFICATION 0x00000001)**                       
                                                                                                                                                   
                            4.  Client expect Status = **ERROR\_SUCCESS**, Context is not **EMPTY**.                                               
                                                                                                                                                   
                            5.  Invoke WitnessrAsyncNotify with **valid context** and                                                              
                                                                                                                                                   
                            6.  Disable and enable network adapter for Node01.                                                                     
                                                                                                                                                   
                            7.  Client expects Status = **ERROR\_SUCCESS**, **RESP\_ASYNC\_NOTIFY with MessageType( IP\_CHANGE\_NOTIFICATION 4)**  
                                                                                                                                                   
                            8.  Invoke WitnessrUnRegister with **valid context**                                                                   
                                                                                                                                                   
                            9.  Client expects Status = **ERROR\_SUCCESS**                                                                         
                                                                                                                                                   
                            10. Unbind                                                                                                             |
| **Cleanup**              |                                                                                                                       |

### 
AsmmetricShare

In dialect 3.02, a new flag SMB2\_SHARE\_CAP\_ASYMMETRIC 0x00000080 is introduced in TREE\_CONNECT.Response.Capabilities. This flag indicates the share is an asymmetric share and the client needs to register SWN witness notification to the server. If the server finds that the client didn’t connect the optimum node, the owner node of the asymmetric share, the server will send an IP\_CHANGE\_NOTIFICATION to the client, and the client should reconnect to the optimum node.

#### Scenario

| **Description**               | Test the server behavior when client connect to asymmetric share. |
|-------------------------------|-------------------------------------------------------------------|
| **Call Sequence**             | Connect to asymmetric share                                       
                                                                                                    
                                 Register SWN witness notification to the server                    |
| **Cluster Involved Scenario** | **YES**                                                           |

#### Test Case

Scenario see [section 3.1.25.1](#scenario-5)

|                          |                                                                                                                               |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AsymmetricShare\_OnNonOptimumNode                                                                                             |
| **Description **         | This test case is designed to test asymmetric share when the client connects to the asymmetric share on the non-optimum node. |
| **Prerequisites**        |                                                                                                                               |
| **Test Execution Steps** | NEGOTIATE                                                                                                                     
                                                                                                                                                           
                            SESSION\_SETUP                                                                                                                 
                                                                                                                                                           
                            TREE\_CONNECT                                                                                                                  
                                                                                                                                                           
                            CREATE                                                                                                                         
                                                                                                                                                           
                            WRITE                                                                                                                          
                                                                                                                                                           
                            READ                                                                                                                           
                                                                                                                                                           
                            WitnessrGetInterfaceList                                                                                                       
                                                                                                                                                           
                            WitnessrRegisterEx                                                                                                             
                                                                                                                                                           
                            WitnessrAsyncNotify                                                                                                            
                                                                                                                                                           
                            WitnessrUnRegister                                                                                                             
                                                                                                                                                           
                            NEGOTIATE                                                                                                                      
                                                                                                                                                           
                            SESSION\_SETUP                                                                                                                 
                                                                                                                                                           
                            TREE\_CONNECT                                                                                                                  
                                                                                                                                                           
                            CREATE                                                                                                                         
                                                                                                                                                           
                            WRITE                                                                                                                          
                                                                                                                                                           
                            READ                                                                                                                           
                                                                                                                                                           
                            CLOSE                                                                                                                          
                                                                                                                                                           
                            TREE\_DISCONNECT                                                                                                               
                                                                                                                                                           
                            LOGOFF                                                                                                                         |
| **Cleanup**              |                                                                                                                               |

|                          |                                                                                                                           |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AsymmetricShare\_OnOptimumNode                                                                                            |
| **Description **         | This test case is designed to test asymmetric share when the client connects to the asymmetric share on the optimum node. |
| **Prerequisites**        |                                                                                                                           |
| **Test Execution Steps** | NEGOTIATE                                                                                                                 
                                                                                                                                                       
                            SESSION\_SETUP                                                                                                             
                                                                                                                                                       
                            TREE\_CONNECT                                                                                                              
                                                                                                                                                       
                            CREATE                                                                                                                     
                                                                                                                                                       
                            WRITE                                                                                                                      
                                                                                                                                                       
                            READ                                                                                                                       
                                                                                                                                                       
                            WitnessrGetInterfaceList                                                                                                   
                                                                                                                                                       
                            WitnessrRegisterEx                                                                                                         
                                                                                                                                                       
                            WitnessrAsyncNotify                                                                                                        
                                                                                                                                                       
                            WitnessrUnRegister                                                                                                         
                                                                                                                                                       
                            NEGOTIATE                                                                                                                  
                                                                                                                                                       
                            SESSION\_SETUP                                                                                                             
                                                                                                                                                       
                            TREE\_CONNECT                                                                                                              
                                                                                                                                                       
                            CREATE                                                                                                                     
                                                                                                                                                       
                            WRITE                                                                                                                      
                                                                                                                                                       
                            READ                                                                                                                       
                                                                                                                                                       
                            CLOSE                                                                                                                      
                                                                                                                                                       
                            TREE\_DISCONNECT                                                                                                           
                                                                                                                                                       
                            LOGOFF                                                                                                                     |
| **Cleanup**              |                                                                                                                           |

|                          |                                                                                                         |
|--------------------------|---------------------------------------------------------------------------------------------------------|
| **Test ID**              | AsymmetricShare\_OnNonScaleOutShare                                                                     |
| **Description **         | This test case is designed to test asymmetric share when the client connects to the non scaleout share. |
| **Prerequisites**        |                                                                                                         |
| **Test Execution Steps** | NEGOTIATE                                                                                               
                                                                                                                                     
                            SESSION\_SETUP                                                                                           
                                                                                                                                     
                            TREE\_CONNECT                                                                                            
                                                                                                                                     
                            CREATE                                                                                                   
                                                                                                                                     
                            WRITE                                                                                                    
                                                                                                                                     
                            READ                                                                                                     
                                                                                                                                     
                            WitnessrGetInterfaceList                                                                                 
                                                                                                                                     
                            WitnessrRegisterEx                                                                                       
                                                                                                                                     
                            WitnessrAsyncNotify                                                                                      
                                                                                                                                     
                            WitnessrUnRegister                                                                                       
                                                                                                                                     
                            NEGOTIATE                                                                                                
                                                                                                                                     
                            SESSION\_SETUP                                                                                           
                                                                                                                                     
                            TREE\_CONNECT                                                                                            
                                                                                                                                     
                            CREATE                                                                                                   
                                                                                                                                     
                            WRITE                                                                                                    
                                                                                                                                     
                            READ                                                                                                     
                                                                                                                                     
                            CLOSE                                                                                                    
                                                                                                                                     
                            TREE\_DISCONNECT                                                                                         
                                                                                                                                     
                            LOGOFF                                                                                                   |
| **Cleanup**              |                                                                                                         |

|                          |                                                                                                                          |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AsymmetricShare\_OnSmb30                                                                                                 |
| **Description **         | This test case is designed to test asymmetric share when the client connects to the non-optimum node with Smb30 dialect. |
| **Prerequisites**        |                                                                                                                          |
| **Test Execution Steps** | NEGOTIATE                                                                                                                
                                                                                                                                                      
                            SESSION\_SETUP                                                                                                            
                                                                                                                                                      
                            TREE\_CONNECT                                                                                                             
                                                                                                                                                      
                            CREATE                                                                                                                    
                                                                                                                                                      
                            WRITE                                                                                                                     
                                                                                                                                                      
                            READ                                                                                                                      
                                                                                                                                                      
                            WitnessrGetInterfaceList                                                                                                  
                                                                                                                                                      
                            WitnessrRegisterEx                                                                                                        
                                                                                                                                                      
                            WitnessrAsyncNotify                                                                                                       
                                                                                                                                                      
                            WitnessrUnRegister                                                                                                        
                                                                                                                                                      
                            NEGOTIATE                                                                                                                 
                                                                                                                                                      
                            SESSION\_SETUP                                                                                                            
                                                                                                                                                      
                            TREE\_CONNECT                                                                                                             
                                                                                                                                                      
                            CREATE                                                                                                                    
                                                                                                                                                      
                            WRITE                                                                                                                     
                                                                                                                                                      
                            READ                                                                                                                      
                                                                                                                                                      
                            CLOSE                                                                                                                     
                                                                                                                                                      
                            TREE\_DISCONNECT                                                                                                          
                                                                                                                                                      
                            LOGOFF                                                                                                                    |
| **Cleanup**              |                                                                                                                          |

1.  ### FileServerFailover

    1.  #### Scenario

|                               |                                                                 |
|-------------------------------|-----------------------------------------------------------------|
| **Description**               | File sharing cluster failover                                   |
| **Message Sequence**          | NEGOTIATE                                                       
                                                                                                  
                                 SESSION\_SETUP                                                   
                                                                                                  
                                 TREE\_CONNECT                                                    
                                                                                                  
                                 CREATE (with durable handle request)                             
                                                                                                  
                                 WRITE                                                            
                                                                                                  
                                 *Disable current node of the Cluster which owns the connection*  
                                                                                                  
                                 NEGOTIATE                                                        
                                                                                                  
                                 SESSION\_SETUP                                                   
                                                                                                  
                                 TREE\_CONNECT                                                    
                                                                                                  
                                 CREATE (With durable handle reconnect)                           
                                                                                                  
                                 READ                                                             
                                                                                                  
                                 CLOSE                                                            
                                                                                                  
                                 TREE\_DISCONNECT                                                 
                                                                                                  
                                 LOGOFF                                                           |
| **Cluster Involved Scenario** | YES                                                             |

#### Test Case

|                          |                                                                                                                                                        |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | FileServerFailover\_FileServer                                                                                                                         |
| **Description **         | This test case is designed to test whether server can handle failover to another node of continuous available file servers.                            |
| **Prerequisites**        |                                                                                                                                                        |
| **Test Execution Steps** | 1.  Start a client by sending the following requests: NEGOTIATE; SESSION\_SETUP; TREE\_CONNECT to GeneralFileServer.                                   
                                                                                                                                                                                    
                            2.  Client sends CREATE request with SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 with PERSISTENT flag set.                                               
                                                                                                                                                                                    
                            3.  Client sends WRITE request to write content to the file.                                                                                            
                                                                                                                                                                                    
                            4.  Client sends FLUSH request.                                                                                                                         
                                                                                                                                                                                    
                            5.  Disable owner node for general file server or the node currently provides the access for scale-out file server.                                     
                                                                                                                                                                                    
                            6.  Wait for available server.                                                                                                                          
                                                                                                                                                                                    
                            7.  Client sends NEGOTIATE request with the same clientguid of previous client.                                                                         
                                                                                                                                                                                    
                            8.  Client sends SESSION\_SETUP request with the same SESSION\_ID of previous client.                                                                   
                                                                                                                                                                                    
                            9.  Client retries TREE\_CONNECT until succeed or timeout because network path may not be available immediately.                                        
                                                                                                                                                                                    
                            10. Client retries to send CREATE request with SMB2\_CREATE\_DURABLE\_HANDLE\_RECONNECT\_V2 context with PERSISTENT flag set until succeed or timeout.  
                                                                                                                                                                                    
                            11. Client sends READ request to read content.                                                                                                          
                                                                                                                                                                                    
                            12. Tear down the client by sending the following requests: CLOSE; TREE\_DISCONNECT; LOG\_OFF                                                           |
| **Cleanup**              | Enable Node1                                                                                                                                           |

|                          |                                                                                                                                                        |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | FileServerFailover\_ScaleOutFileServer                                                                                                                 |
| **Description **         | This test case is designed to test whether server can handle failover to another node of continuous available scale out file servers.                  |
| **Prerequisites**        |                                                                                                                                                        |
| **Test Execution Steps** | 1.  Start a client by sending the following requests: NEGOTIATE; SESSION\_SETUP; TREE\_CONNECT to ScaleOutFileServer.                                  
                                                                                                                                                                                    
                            2.  Client sends CREATE request with SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 with PERSISTENT flag set.                                               
                                                                                                                                                                                    
                            3.  Client sends WRITE request to write content to the file.                                                                                            
                                                                                                                                                                                    
                            4.  Client sends FLUSH request.                                                                                                                         
                                                                                                                                                                                    
                            5.  Disable owner node for general file server or the node currently provides the access for scale-out file server.                                     
                                                                                                                                                                                    
                            6.  Wait for available server.                                                                                                                          
                                                                                                                                                                                    
                            7.  Client sends NEGOTIATE request with the same clientguid of previous client.                                                                         
                                                                                                                                                                                    
                            8.  Client sends SESSION\_SETUP request with the same SESSION\_ID of previous client.                                                                   
                                                                                                                                                                                    
                            9.  Client retries TREE\_CONNECT until succeed or timeout because network path may not be available immediately.                                        
                                                                                                                                                                                    
                            10. Client retries to send CREATE request with SMB2\_CREATE\_DURABLE\_HANDLE\_RECONNECT\_V2 context with PERSISTENT flag set until succeed or timeout.  
                                                                                                                                                                                    
                            11. Client sends READ request to read content.                                                                                                          
                                                                                                                                                                                    
                            12. Tear down the client by sending the following requests: CLOSE; TREE\_DISCONNECT; LOG\_OFF                                                           |
| **Cleanup**              | Enable Node1                                                                                                                                           |

|                          |                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------|
| **Test ID**              | FileServerFailover\_ScaleOutFileServer\_ReconnectWithoutFailover                                 |
| **Description **         | Ensure persistent handle could be re-connected via connection with another node without failover |
| **Prerequisites**        |                                                                                                  |
| **Test Execution Steps** | **Establish connection to node01**                                                               
                                                                                                                              
                            Client sends NEGOTIATE request                                                                    
                                                                                                                              
                            Server sends NEGOTIATE response                                                                   
                                                                                                                              
                            Client sends SESSION\_SETUP request                                                               
                                                                                                                              
                            Server sends SESSION\_SETUP response                                                              
                                                                                                                              
                            According to the status code of last step, client may send more SESSION\_SETUP request as needed  
                                                                                                                              
                            Client sends TREE\_CONNECT request                                                                
                                                                                                                              
                            Server sends TREE\_CONNECT response                                                               
                                                                                                                              
                            Client sends CREATE request with CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 create context              
                                                                                                                              
                            Server sends CREATE response                                                                      
                                                                                                                              
                            Client sends WRITE request                                                                        
                                                                                                                              
                            Server sends WRITE response                                                                       
                                                                                                                              
                            **Establish connection to node02**                                                                
                                                                                                                              
                            Repeat step 1 to 7                                                                                
                                                                                                                              
                            Client sends CREATE request with  SMB2\_CREATE\_DURABLE\_HANDLE\_RECONNECT\_V2                    
                                                                                                                              
                            Server sends CREATE response                                                                      
                                                                                                                              
                            Client sends READ request                                                                         
                                                                                                                              
                            Server sends READ response                                                                        
                                                                                                                              
                            Client sends CLOSE request                                                                        
                                                                                                                              
                            Server sends CLOSE response                                                                       
                                                                                                                              
                            Client sends TREE\_DISCONNECT request                                                             
                                                                                                                              
                            Server sends TREE\_DISCONNECT response                                                            
                                                                                                                              
                            Client sends LOGOFF request                                                                       
                                                                                                                              
                            Server sends LOGOFF response                                                                      |
| **Cleanup**              |                                                                                                  |

| **Test ID**              | SWNFileServerFailover\_FileServer                                                 |
|--------------------------|-----------------------------------------------------------------------------------|
| **Description **         | Get WitnessrAsyncNotify notification on cluster server.                           |
| **Prerequisites**        |                                                                                   |
| **Test Execution Steps** | 1.  GetClusterResourceOwner                                                       
                                                                                                               
                            2.  Bind to cluster server(GeneralFS)                                              
                                                                                                               
                            3.  Invoke WitnessrGetInterfaceList                                                
                                                                                                               
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with  
                                                                                                               
                                -   InterfaceGroupName != **ClusterResourceOwner**                             
                                                                                                               
                                -   State = **AVAILABLE**                                                      
                                                                                                               
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                         
                                                                                                               
                            > and contains interface with                                                      
                                                                                                               
                            -   InterfaceGroupName = **ClusterResourceOwner**                                  
                                                                                                               
                            -   State = **AVAILABLE**                                                          
                                                                                                               
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                            
                                                                                                               
                            1.  Unbind                                                                         
                                                                                                               
                            2.  Bind to **valid node**                                                         
                                                                                                               
                            3.  Invoke WitnessrRegister                                                        
                                                                                                               
                            4.  Client expect Status = **ERROR\_SUCCESS**, Context is not **EMPTY**.           
                                                                                                               
                            5.  Invoke WitnessrAsyncNotify with **valid context**                              
                                                                                                               
                            6.  Create a file on cluster (GeneralFS) and write buffer through SMB2.            
                                                                                                               
                            7.  Disable **ClusSvc** on **ClusterResourceOwner**                                
                                                                                                               
                            8.  Client expects Status = **ERROR\_SUCCESS**, **RESOURCE\_CHANGE**               
                                                                                                               
                                -   ChangeType = **0xFFFFFFFF**                                                
                                                                                                               
                                -   ResourceName = **ClusterResourceOwner**                                    
                                                                                                               
                            9.  Invoke WitnessrAsyncNotify with **valid context**                              
                                                                                                               
                            10. Client expects Status = **ERROR\_SUCCESS**, **RESOURCE\_CHANGE**               
                                                                                                               
                                -   ChangeType = **0x00000001**                                                
                                                                                                               
                                -   ResourceName = **NewNode**                                                 
                                                                                                               
                            11. Invoke WitnessrUnRegister with **valid context**                               
                                                                                                               
                            12. Client expects Status = **ERROR\_SUCCESS**                                     
                                                                                                               
                            13. Unbind                                                                         
                                                                                                               
                            14. Read buffer and close the file on cluster (GeneralFS) through SMB2.            |
| **Cleanup**              |                                                                                   |

| **Test ID**              | SWNFileServerFailover\_ScaleOutFileServer                                         |
|--------------------------|-----------------------------------------------------------------------------------|
| **Description **         | Get WitnessrAsyncNotify notification on scaleout cluster server.                  |
| **Prerequisites**        |                                                                                   |
| **Test Execution Steps** | 1.  Get the address(Node01) of ScaleOutFs                                         
                                                                                                               
                            2.  Bind to Node01                                                                 
                                                                                                               
                            3.  Invoke WitnessrGetInterfaceList                                                
                                                                                                               
                            4.  Client expects Status = ERROR\_SUCCESS, InterfaceList contains interface with  
                                                                                                               
                                -   InterfaceGroupName = **Node02**                                            
                                                                                                               
                                -   State = **AVAILABLE**                                                      
                                                                                                               
                                -   Flags & **INTERFACE\_WITNESS(0x00000004) == true**                         
                                                                                                               
                            > and contains interface with                                                      
                                                                                                               
                            -   InterfaceGroupName = **Node01**                                                
                                                                                                               
                            -   State = **AVAILABLE**                                                          
                                                                                                               
                            -   Flags & **INTERFACE\_WITNESS(0x00000004) == false**                            
                                                                                                               
                            1.  Unbind                                                                         
                                                                                                               
                            2.  Bind to **NODE02**                                                             
                                                                                                               
                            3.  Invoke WitnessrRegister                                                        
                                                                                                               
                            4.  Client expect Status = **ERROR\_SUCCESS**, Context is not **EMPTY**.           
                                                                                                               
                            5.  Invoke WitnessrAsyncNotify with **valid context**                              
                                                                                                               
                            6.  Create a file on ScaleOutFs (Node01) and write buffer through SMB2.            
                                                                                                               
                            7.  Disable **ClusSvc** on **ClusterResourceOwner**                                
                                                                                                               
                            8.  Client expects Status = **ERROR\_SUCCESS**, **RESOURCE\_CHANGE**               
                                                                                                               
                                -   ChangeType = **0xFFFFFFFF**                                                
                                                                                                               
                                -   ResourceName = **Node01**                                                  
                                                                                                               
                            9.  Invoke WitnessrAsyncNotify with **valid context**                              
                                                                                                               
                            10. Client expects Status = **ERROR\_SUCCESS**, **RESOURCE\_CHANGE**               
                                                                                                               
                                -   ChangeType = **0x00000001**                                                
                                                                                                               
                                -   ResourceName = **Node02**                                                  
                                                                                                               
                            11. Invoke WitnessrUnRegister with **valid context**                               
                                                                                                               
                            12. Client expects Status = **ERROR\_SUCCESS**                                     
                                                                                                               
                            13. Unbind                                                                         
                                                                                                               
                            14. Read buffer and close the file on ScaleOutFs (Node02) through SMB2.            |
| **Cleanup**              |                                                                                   |

1.  ### <span id="_FileServerFailover_Encryption" class="anchor"><span id="_Toc427488191" class="anchor"></span></span>FileServerFailover\_Encryption

    1.  #### Scenario

| **Description**               | Operate files with/without encryption before/after server failover and after failover |
|-------------------------------|---------------------------------------------------------------------------------------|
| **Message Sequence**          | **From client1**                                                                      
                                                                                                                        
                                 NEGOTIATE (with/without SMB2\_GLOBAL\_CAP\_ENCRYPTION)                                 
                                                                                                                        
                                 SESSION\_SETUP                                                                         
                                                                                                                        
                                 TREE\_CONNECT                                                                          
                                                                                                                        
                                 CREATE (with durable handle request)                                                   
                                                                                                                        
                                 WRITE                                                                                  
                                                                                                                        
                                 *Disable current node of the Cluster which owns the connection*                        
                                                                                                                        
                                 **From client2**                                                                       
                                                                                                                        
                                 NEGOTIATE (with/without SMB2\_GLOBAL\_CAP\_ENCRYPTION)                                 
                                                                                                                        
                                 SESSION\_SETUP                                                                         
                                                                                                                        
                                 TREE\_CONNECT                                                                          
                                                                                                                        
                                 CREATE (With durable handle reconnect)                                                 
                                                                                                                        
                                 READ                                                                                   
                                                                                                                        
                                 CLOSE                                                                                  
                                                                                                                        
                                 TREE\_DISCONNECT                                                                       
                                                                                                                        
                                 LOGOFF                                                                                 |
| **Cluster Involved Scenario** | **YES**                                                                               |

#### Test Case

|                          |                                                                         |
|--------------------------|-------------------------------------------------------------------------|
| **Test ID**              | FileServerFailover\_Encryption                                          |
| **Description **         | Operate files with encryption before server failover and after failover |
| **Prerequisites**        |                                                                         |
| **Test Execution Steps** | **From client1**                                                        
                                                                                                     
                            NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)                           
                                                                                                     
                            SESSION\_SETUP                                                           
                                                                                                     
                            TREE\_CONNECT                                                            
                                                                                                     
                            CREATE (with durable handle request)                                     
                                                                                                     
                            WRITE                                                                    
                                                                                                     
                            *Disable current node of the Cluster which owns the connection*          
                                                                                                     
                            **From client2**                                                         
                                                                                                     
                            NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)                           
                                                                                                     
                            SESSION\_SETUP                                                           
                                                                                                     
                            TREE\_CONNECT                                                            
                                                                                                     
                            CREATE (With durable handle reconnect)                                   
                                                                                                     
                            READ                                                                     
                                                                                                     
                            CLOSE                                                                    
                                                                                                     
                            TREE\_DISCONNECT                                                         
                                                                                                     
                            LOGOFF                                                                   |
| **Cleanup**              |                                                                         |

|                          |                                                                                            |
|--------------------------|--------------------------------------------------------------------------------------------|
| **Test ID**              | FileServerFailover\_Negative\_EncryptionBeforeFailover\_NoEncryptionAfterFailover          |
| **Description **         | Operate files with encryption before server failover but without encryption after failover |
| **Prerequisites**        |                                                                                            |
| **Test Execution Steps** | **From client1**                                                                           
                                                                                                                        
                            NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)                                              
                                                                                                                        
                            SESSION\_SETUP                                                                              
                                                                                                                        
                            TREE\_CONNECT                                                                               
                                                                                                                        
                            CREATE (with durable handle request)                                                        
                                                                                                                        
                            WRITE                                                                                       
                                                                                                                        
                            *Disable current node of the Cluster which owns the connection*                             
                                                                                                                        
                            **From client2**                                                                            
                                                                                                                        
                            NEGOTIATE (without SMB2\_GLOBAL\_CAP\_ENCRYPTION)                                           
                                                                                                                        
                            SESSION\_SETUP                                                                              
                                                                                                                        
                            TREE\_CONNECT                                                                               
                                                                                                                        
                            CREATE (With durable handle reconnect)                                                      
                                                                                                                        
                            Expect error STATUS\_ACCESS\_DENIED                                                         
                                                                                                                        
                            in response                                                                                 
                                                                                                                        
                            TREE\_DISCONNECT                                                                            
                                                                                                                        
                            Expect error STATUS\_ACCESS\_DENIED                                                         
                                                                                                                        
                            in response                                                                                 
                                                                                                                        
                            LOGOFF                                                                                      |
| **Cleanup**              |                                                                                            |

|                          |                                                                                     |
|--------------------------|-------------------------------------------------------------------------------------|
| **Test ID**              | FileServerFailover\_Negative\_NoEncryptionBeforeFailover\_EncrytpionAfterFailover   |
| **Description **         | Operate files without encryption before failover but with encryption after failover |
| **Prerequisites**        |                                                                                     |
| **Test Execution Steps** | **From client1**                                                                    
                                                                                                                 
                            NEGOTIATE (without SMB2\_GLOBAL\_CAP\_ENCRYPTION)                                    
                                                                                                                 
                            SESSION\_SETUP                                                                       
                                                                                                                 
                            TREE\_CONNECT                                                                        
                                                                                                                 
                            CREATE (with durable handle request)                                                 
                                                                                                                 
                            Expect error STATUS\_ACCESS\_DENIED in response                                      
                                                                                                                 
                            *Disable current node of the Cluster which owns the connection*                      
                                                                                                                 
                            **From client2**                                                                     
                                                                                                                 
                            NEGOTIATE (with SMB2\_GLOBAL\_CAP\_ENCRYPTION)                                       
                                                                                                                 
                            SESSION\_SETUP                                                                       
                                                                                                                 
                            TREE\_CONNECT                                                                        
                                                                                                                 
                            CREATE (With durable handle reconnect)                                               
                                                                                                                 
                            Expect error STATUS\_OBJECT\_NAME\_NOT\_FOUND                                        
                                                                                                                 
                            in response                                                                          
                                                                                                                 
                            TREE\_DISCONNECT                                                                     
                                                                                                                 
                            LOGOFF                                                                               |
| **Cleanup**              |                                                                                     |

1.  ### FileServerFailover\_Lease

    1.  #### Scenario

| **Description**               | Operate file/directory with lease and durable handle before server failover and expect lease break notification |
|-------------------------------|-----------------------------------------------------------------------------------------------------------------|
| **Message Sequence**          | **From client1 **                                                                                               
                                                                                                                                                  
                                 NEGOTIATE                                                                                                        
                                                                                                                                                  
                                 SESSION\_SETUP                                                                                                   
                                                                                                                                                  
                                 TREE\_CONNECT                                                                                                    
                                                                                                                                                  
                                 CREATE (File, with durable handle and SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state)                          
                                                                                                                                                  
                                 *Disable current node of the Cluster which owns the connection*                                                  
                                                                                                                                                  
                                 **From client2**                                                                                                 
                                                                                                                                                  
                                 NEGOTIATE                                                                                                        
                                                                                                                                                  
                                 SESSION\_SETUP                                                                                                   
                                                                                                                                                  
                                 TREE\_CONNECT                                                                                                    
                                                                                                                                                  
                                 CREATE (File, durable handle request with same lease state)                                                      
                                                                                                                                                  
                                 **From client3 to access same file to trigger leasing break**                                                    
                                                                                                                                                  
                                 NEGOTIATE                                                                                                        
                                                                                                                                                  
                                 SESSION\_SETUP                                                                                                   
                                                                                                                                                  
                                 TREE\_CONNECT                                                                                                    
                                                                                                                                                  
                                 CREATE (with WRITE)                                                                                              
                                                                                                                                                  
                                 **From client2**                                                                                                 
                                                                                                                                                  
                                 Receive LEASE\_BREAK                                                                                             
                                                                                                                                                  
                                 Send LEASE\_BREAK\_ACK                                                                                           
                                                                                                                                                  
                                 CLOSE                                                                                                            
                                                                                                                                                  
                                 TREE\_DISCONNECT                                                                                                 
                                                                                                                                                  
                                 LOGOFF                                                                                                           
                                                                                                                                                  
                                 From client3                                                                                                     
                                                                                                                                                  
                                 CLOSE                                                                                                            
                                                                                                                                                  
                                 TREE\_DISCONNECT                                                                                                 
                                                                                                                                                  
                                 LOGOFF                                                                                                           |
| **Cluster Involved Scenario** | **YES**                                                                                                         |

#### Test Case

|                          |                                                                                                                                                        |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | FileServerFailover\_DirectoryLeasing                                                                                                                   |
| **Description **         | Operate directory with lease and durable handle before server failover and expect lease break notification                                             |
| **Prerequisites**        |                                                                                                                                                        |
| **Test Execution Steps** | **From client1 **                                                                                                                                      
                                                                                                                                                                                    
                            NEGOTIATE                                                                                                                                               
                                                                                                                                                                                    
                            SESSION\_SETUP                                                                                                                                          
                                                                                                                                                                                    
                            TREE\_CONNECT                                                                                                                                           
                                                                                                                                                                                    
                            CREATE (directory, with durable handle and SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING)  
                                                                                                                                                                                    
                            *Disable current node of the Cluster which owns the connection*                                                                                         
                                                                                                                                                                                    
                            **From client2**                                                                                                                                        
                                                                                                                                                                                    
                            NEGOTIATE                                                                                                                                               
                                                                                                                                                                                    
                            SESSION\_SETUP                                                                                                                                          
                                                                                                                                                                                    
                            TREE\_CONNECT                                                                                                                                           
                                                                                                                                                                                    
                            CREATE (directory, durable handle request with same lease state SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING)                              
                                                                                                                                                                                    
                            **From client3 to access same file to trigger leasing break**                                                                                           
                                                                                                                                                                                    
                            NEGOTIATE                                                                                                                                               
                                                                                                                                                                                    
                            SESSION\_SETUP                                                                                                                                          
                                                                                                                                                                                    
                            TREE\_CONNECT                                                                                                                                           
                                                                                                                                                                                    
                            CREATE (with DELETE)                                                                                                                                    
                                                                                                                                                                                    
                            **From client2**                                                                                                                                        
                                                                                                                                                                                    
                            Receive LEASE\_BREAK                                                                                                                                    
                                                                                                                                                                                    
                            Send LEASE\_BREAK\_ACK                                                                                                                                  
                                                                                                                                                                                    
                            CLOSE                                                                                                                                                   
                                                                                                                                                                                    
                            TREE\_DISCONNECT                                                                                                                                        
                                                                                                                                                                                    
                            LOGOFF                                                                                                                                                  
                                                                                                                                                                                    
                            From client3                                                                                                                                            
                                                                                                                                                                                    
                            CLOSE                                                                                                                                                   
                                                                                                                                                                                    
                            TREE\_DISCONNECT                                                                                                                                        
                                                                                                                                                                                    
                            LOGOFF                                                                                                                                                  |
| **Cleanup**              |                                                                                                                                                        |

|                          |                                                                                                                                                                                  |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | FileServerFailover\_FileLeasing                                                                                                                                                  |
| **Description **         | Operate file with lease and durable handle before server failover and expect lease break notification                                                                            |
| **Prerequisites**        |                                                                                                                                                                                  |
| **Test Execution Steps** | **From client1 **                                                                                                                                                                
                                                                                                                                                                                                              
                            NEGOTIATE                                                                                                                                                                         
                                                                                                                                                                                                              
                            SESSION\_SETUP                                                                                                                                                                    
                                                                                                                                                                                                              
                            TREE\_CONNECT                                                                                                                                                                     
                                                                                                                                                                                                              
                            CREATE (File, with durable handle and SMB2\_CREATE\_REQUEST\_LEASE\_V2 and lease state SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING | SMB2\_LEASE\_WRITE\_CACHING )  
                                                                                                                                                                                                              
                            *Disable current node of the Cluster which owns the connection*                                                                                                                   
                                                                                                                                                                                                              
                            **From client2**                                                                                                                                                                  
                                                                                                                                                                                                              
                            NEGOTIATE                                                                                                                                                                         
                                                                                                                                                                                                              
                            SESSION\_SETUP                                                                                                                                                                    
                                                                                                                                                                                                              
                            TREE\_CONNECT                                                                                                                                                                     
                                                                                                                                                                                                              
                            CREATE (File, durable handle request with same lease state SMB2\_LEASE\_READ\_CACHING | SMB2\_LEASE\_HANDLE\_CACHING | SMB2\_LEASE\_WRITE\_CACHING)                               
                                                                                                                                                                                                              
                            **From client3 to access same file to trigger leasing break**                                                                                                                     
                                                                                                                                                                                                              
                            NEGOTIATE                                                                                                                                                                         
                                                                                                                                                                                                              
                            SESSION\_SETUP                                                                                                                                                                    
                                                                                                                                                                                                              
                            TREE\_CONNECT                                                                                                                                                                     
                                                                                                                                                                                                              
                            CREATE (with WRITE)                                                                                                                                                               
                                                                                                                                                                                                              
                            **From client2**                                                                                                                                                                  
                                                                                                                                                                                                              
                            Receive LEASE\_BREAK                                                                                                                                                              
                                                                                                                                                                                                              
                            Send LEASE\_BREAK\_ACK                                                                                                                                                            
                                                                                                                                                                                                              
                            CLOSE                                                                                                                                                                             
                                                                                                                                                                                                              
                            TREE\_DISCONNECT                                                                                                                                                                  
                                                                                                                                                                                                              
                            LOGOFF                                                                                                                                                                            
                                                                                                                                                                                                              
                            From client3                                                                                                                                                                      
                                                                                                                                                                                                              
                            CLOSE                                                                                                                                                                             
                                                                                                                                                                                                              
                            TREE\_DISCONNECT                                                                                                                                                                  
                                                                                                                                                                                                              
                            LOGOFF                                                                                                                                                                            |
| **Cleanup**              |                                                                                                                                                                                  |

1.  ### FileServerFailover\_Lock

    1.  #### Scenario

| **Test case**                 | FileServer\_Filover\_Lock                                                                |
|-------------------------------|------------------------------------------------------------------------------------------|
| **Description**               | Operate files with lock during failover and expect the lock is maintained after failover |
| **Message Sequence**          | **From client1 open a file and lock a specific range**                                   
                                                                                                                           
                                 NEGOTIATE                                                                                 
                                                                                                                           
                                 SESSION\_SETUP                                                                            
                                                                                                                           
                                 TREE\_CONNECT                                                                             
                                                                                                                           
                                 CREATE (File, with durable handle request)                                                
                                                                                                                           
                                 WRITE                                                                                     
                                                                                                                           
                                 LOCK (with SMB2\_LOCKFLAG\_SHARED\_LOCK in SMB2\_LOCK\_ELEMENT)                           
                                                                                                                           
                                 *Disable current node of the Cluster which owns the connection*                           
                                                                                                                           
                                 **From client2**                                                                          
                                                                                                                           
                                 NEGOTIATE                                                                                 
                                                                                                                           
                                 SESSION\_SETUP                                                                            
                                                                                                                           
                                 TREE\_CONNECT                                                                             
                                                                                                                           
                                 CREATE (with durable handle reconnect)                                                    
                                                                                                                           
                                 READ (the locking range, expect success)                                                  
                                                                                                                           
                                 WRITE (the locking range, expect success)                                                 
                                                                                                                           
                                 **From client3 open the same file and try to read and write the locking range**           
                                                                                                                           
                                 NEGOTIATE                                                                                 
                                                                                                                           
                                 SESSION\_SETUP                                                                            
                                                                                                                           
                                 TREE\_CONNECT                                                                             
                                                                                                                           
                                 CREATE (File)                                                                             
                                                                                                                           
                                 READ (the locking range, expect success)                                                  
                                                                                                                           
                                 WRITE (the locking range, expect fail)                                                    
                                                                                                                           
                                 **From client2 unlock the range**                                                         
                                                                                                                           
                                 LOCK (with SMB2\_LOCKFLAG\_UNLOCK in SMB2\_LOCK\_ELEMENT)                                 
                                 CLOSE                                                                                     
                                                                                                                           
                                 TREE\_DISCONNECT                                                                          
                                                                                                                           
                                 LOGOFF                                                                                    
                                                                                                                           
                                 **From client3 try to write the range**                                                   
                                                                                                                           
                                 WRITE (the locking range, expect success)                                                 
                                                                                                                           
                                 CLOSE                                                                                     
                                                                                                                           
                                 TREE\_DISCONNECT                                                                          
                                                                                                                           
                                 LOGOFF                                                                                    |
| **Cluster Involved Scenario** | **YES**                                                                                  |

#### Test Case

|                          |                                                                                          |
|--------------------------|------------------------------------------------------------------------------------------|
| **Test ID**              | FileServerFailover\_Lock                                                                 |
| **Description **         | Operate files with lock during failover and expect the lock is maintained after failover |
| **Prerequisites**        |                                                                                          |
| **Test Execution Steps** | **From client1 open a file and lock a specific range**                                   
                                                                                                                      
                            NEGOTIATE                                                                                 
                                                                                                                      
                            SESSION\_SETUP                                                                            
                                                                                                                      
                            TREE\_CONNECT                                                                             
                                                                                                                      
                            CREATE (File, with durable handle request)                                                
                                                                                                                      
                            WRITE                                                                                     
                                                                                                                      
                            LOCK (with SMB2\_LOCKFLAG\_SHARED\_LOCK in SMB2\_LOCK\_ELEMENT)                           
                                                                                                                      
                            *Disable current node of the Cluster which owns the connection*                           
                                                                                                                      
                            **From client2**                                                                          
                                                                                                                      
                            NEGOTIATE                                                                                 
                                                                                                                      
                            SESSION\_SETUP                                                                            
                                                                                                                      
                            TREE\_CONNECT                                                                             
                                                                                                                      
                            CREATE (with durable handle reconnect)                                                    
                                                                                                                      
                            READ (the locking range, expect success)                                                  
                                                                                                                      
                            WRITE (the locking range, expect success)                                                 
                                                                                                                      
                            **From client3 open the same file and try to read and write the locking range**           
                                                                                                                      
                            NEGOTIATE                                                                                 
                                                                                                                      
                            SESSION\_SETUP                                                                            
                                                                                                                      
                            TREE\_CONNECT                                                                             
                                                                                                                      
                            CREATE (File)                                                                             
                                                                                                                      
                            READ (the locking range, expect success)                                                  
                                                                                                                      
                            WRITE (the locking range, expect fail)                                                    
                                                                                                                      
                            **From client2 unlock the range**                                                         
                                                                                                                      
                            LOCK (with SMB2\_LOCKFLAG\_UNLOCK in SMB2\_LOCK\_ELEMENT)                                 
                            CLOSE                                                                                     
                                                                                                                      
                            TREE\_DISCONNECT                                                                          
                                                                                                                      
                            LOGOFF                                                                                    
                                                                                                                      
                            **From client3 try to write the range**                                                   
                                                                                                                      
                            WRITE (the locking range, expect success)                                                 
                                                                                                                      
                            CLOSE                                                                                     
                                                                                                                      
                            TREE\_DISCONNECT                                                                          
                                                                                                                      
                            LOGOFF                                                                                    |
| **Cleanup**              |                                                                                          |

<span id="_Toc358295461" class="anchor"><span id="_Toc358299834" class="anchor"></span></span>

1.  ### FileServerFailover\_DurableHandleV2

    1.  #### Scenario

| **Description**               | Test the CREATE request from different client could not success after failover when persistent handle is requested |
|-------------------------------|--------------------------------------------------------------------------------------------------------------------|
| **Message Sequence**          | **From one client open a file and request persistent handle**                                                      
                                                                                                                                                     
                                 NEGOTIATE                                                                                                           
                                                                                                                                                     
                                 SESSION\_SETUP                                                                                                      
                                                                                                                                                     
                                 TREE\_CONNECT                                                                                                       
                                                                                                                                                     
                                 CREATE(with CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 create context)                                                    
                                                                                                                                                     
                                 **Disable Node1to simulate failover**                                                                               
                                                                                                                                                     
                                 **From different client try to open the same file**                                                                 
                                                                                                                                                     
                                 Repeat step 1 to 3                                                                                                  
                                                                                                                                                     
                                 CREATE (Incompatible share access with previous CREATE request and will result violation)                           
                                                                                                                                                     
                                 Expect error in response from server                                                                                
                                                                                                                                                     
                                 TREE\_DISCONNECT                                                                                                    
                                                                                                                                                     
                                 LOGOFF                                                                                                              |
| **Cluster Involved Scenario** | **YES**                                                                                                            |

#### Test Case

|                          |                                                                                                                |
|--------------------------|----------------------------------------------------------------------------------------------------------------|
| **Test ID**              | FileServerFailover\_BlockCreateFromDifferentClient                                                             |
| **Description **         | Test the CREATE request from different client could succeed after failover when persistent handle is requested |
| **Prerequisites**        |                                                                                                                |
| **Test Execution Steps** | **From one client open a file and request persistent handle**                                                  
                                                                                                                                            
                            Client sends NEGOTIATE request                                                                                  
                                                                                                                                            
                            Server sends NEGOTIATE response                                                                                 
                                                                                                                                            
                            Client sends SESSION\_SETUP request                                                                             
                                                                                                                                            
                            Server sends SESSION\_SETUP response                                                                            
                                                                                                                                            
                            According to the status code of last step, client may send more SESSION\_SETUP request as needed                
                                                                                                                                            
                            Client sends TREE\_CONNECT request                                                                              
                                                                                                                                            
                            Server sends TREE\_CONNECT response                                                                             
                                                                                                                                            
                            Client sends CREATE request with CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 create context                            
                                                                                                                                            
                            Server sends CREATE response                                                                                    
                                                                                                                                            
                            **Disable Node1to simulate failover**                                                                           
                                                                                                                                            
                            **From different client try to open the same file**                                                             
                                                                                                                                            
                            Repeat step 1 to 7                                                                                              
                                                                                                                                            
                            Client sends CREATE request                                                                                     
                                                                                                                                            
                            Expect error in response from server                                                                            
                                                                                                                                            
                            Client sends TREE\_DISCONNECT request                                                                           
                                                                                                                                            
                            Server sends TREE\_DISCONNECT response                                                                          
                                                                                                                                            
                            Client sends LOGOFF request                                                                                     
                                                                                                                                            
                            Server sends LOGOFF response                                                                                    |
| **Cleanup**              |                                                                                                                |

FSRVP Test
----------

|                             |                |                         |                                 |
|-----------------------------|----------------|-------------------------|---------------------------------|
| **Scenario**                | **Test Cases** | **SMB 3.0 New Feature** | **Hyper-V Scenario Importance** |
| **VSSOperateShadowCopySet** | 6              | **Yes**                 | **Critical**                    |
| **VSSSetContext**           | 5              | **Yes**                 | **Critical**                    |
| **VSSAbortShadowCopySet**   | 3              | **Yes**                 | **Critical**                    |

1.  ### VSSOperateShadowCopySet

    1.  #### Scenario

|                               |                               |
|-------------------------------|-------------------------------|
| **Description**               | Operate a shadow copy set.    |
| **Call Sequence**             | IsPathSupported               
                                                                
                                 GetSupportedVersion            
                                                                
                                 SetContext                     
                                                                
                                 StartShadowCopySet             
                                                                
                                 AddToShadowCopySet             
                                                                
                                 PrepareShadowCopySet           
                                                                
                                 CommitShadowCopySet            
                                                                
                                 ExposeShadowCopySet            
                                                                
                                 GetShareMapping                
                                                                
                                 RecoveryCompleteShadowCopySet  
                                                                
                                 IsPathShadowCopied             
                                                                
                                 DeleteShareMapping             |
| **Cluster Involved Scenario** | YES                           |

#### Test Case

|                          |                                                                                                            |
|--------------------------|------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_VSSOperateShadowCopySet\_WritableSnapshot\_GeneralFileServer                                          |
| **Description **         | Check if the general file server supports the VSS provider to create a writable snapshot for remote files. |
| **Prerequisites**        |                                                                                                            |
| **Test Execution Steps** | 1.  IsPathSupported("\\\\GeneralFS.contoso.com\\SMBBasic")                                                 
                                                                                                                                        
                            2.  GetSupportedVersion                                                                                     
                                                                                                                                        
                            3.  SetContext(0x00400000)                                                                                  
                                                                                                                                        
                            4.  StartShadowCopySet                                                                                      
                                                                                                                                        
                            5.  AddToShadowCopySet                                                                                      
                                                                                                                                        
                            6.  PrepareShadowCopySet                                                                                    
                                                                                                                                        
                            7.  CommitShadowCopySet                                                                                     
                                                                                                                                        
                            8.  ExposeShadowCopySet                                                                                     
                                                                                                                                        
                            9.  GetShareMapping                                                                                         
                                                                                                                                        
                            10. Create a file in the exposed share and expect the success.                                              
                                                                                                                                        
                            11. RecoveryCompleteShadowCopySet                                                                           
                                                                                                                                        
                            12. IsPathShadowCopied                                                                                      
                                                                                                                                        
                            13. DeleteShareMapping                                                                                      |
| **Cleanup**              | AbortShadowCopySet                                                                                         
                                                                                                                                        
                            DeleteShareMapping                                                                                          |

|                          |                                                                                                             |
|--------------------------|-------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_VSSOperateShadowCopySet\_WritableSnapshot\_ScaleoutFileServer                                          |
| **Description **         | Check if the scaleout file server supports the VSS provider to create a writable snapshot for remote files. |
| **Prerequisites**        |                                                                                                             |
| **Test Execution Steps** | 1.  IsPathSupported("\\\\ScaleOutFS.contoso.com\\SMBBasic")                                                 
                                                                                                                                         
                            2.  GetSupportedVersion                                                                                      
                                                                                                                                         
                            3.  SetContext(0x00400000)                                                                                   
                                                                                                                                         
                            4.  StartShadowCopySet                                                                                       
                                                                                                                                         
                            5.  AddToShadowCopySet                                                                                       
                                                                                                                                         
                            6.  PrepareShadowCopySet                                                                                     
                                                                                                                                         
                            7.  CommitShadowCopySet                                                                                      
                                                                                                                                         
                            8.  ExposeShadowCopySet                                                                                      
                                                                                                                                         
                            9.  GetShareMapping                                                                                          
                                                                                                                                         
                            10. Create a file in the exposed share and expect the success.                                               
                                                                                                                                         
                            11. RecoveryCompleteShadowCopySet                                                                            
                                                                                                                                         
                            12. IsPathShadowCopied                                                                                       
                                                                                                                                         
                            13. DeleteShareMapping                                                                                       |
| **Cleanup**              | AbortShadowCopySet                                                                                          
                                                                                                                                         
                            DeleteShareMapping                                                                                           |

|                          |                                                                                               |
|--------------------------|-----------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_VSSOperateShadowCopySet\_WritableSnapshot\_SingleNode                                    |
| **Description **         | Check if the server supports the VSS provider to create a writable snapshot for remote files. |
| **Prerequisites**        |                                                                                               |
| **Test Execution Steps** | 1.  IsPathSupported("\\\\Node01\\SMBBasic")                                                   
                                                                                                                           
                            2.  GetSupportedVersion                                                                        
                                                                                                                           
                            3.  SetContext(0x00400000)                                                                     
                                                                                                                           
                            4.  StartShadowCopySet                                                                         
                                                                                                                           
                            5.  AddToShadowCopySet                                                                         
                                                                                                                           
                            6.  PrepareShadowCopySet                                                                       
                                                                                                                           
                            7.  CommitShadowCopySet                                                                        
                                                                                                                           
                            8.  ExposeShadowCopySet                                                                        
                                                                                                                           
                            9.  GetShareMapping                                                                            
                                                                                                                           
                            10. Create a file in the exposed share and expect the success.                                 
                                                                                                                           
                            11. RecoveryCompleteShadowCopySet                                                              
                                                                                                                           
                            12. IsPathShadowCopied                                                                         
                                                                                                                           
                            13. DeleteShareMapping                                                                         |
| **Cleanup**              | AbortShadowCopySet                                                                            
                                                                                                                           
                            DeleteShareMapping                                                                             |

|                          |                                                                                                            |
|--------------------------|------------------------------------------------------------------------------------------------------------|
| **Test ID**              | VSSOperateShadowCopySet\_DifferentNodeSharePath                                                            |
| **Description **         | Check if the server returns correctly when adding different sharePath on multi nodes to a shadow copy set. |
| **Prerequisites**        |                                                                                                            |
| **Test Execution Steps** | 1.  IsPathSupported("\\\\Node01\\SMBBasic")                                                                
                                                                                                                                        
                            2.  GetSupportedVersion                                                                                     
                                                                                                                                        
                            3.  SetContext(0x00400000)                                                                                  
                                                                                                                                        
                            4.  StartShadowCopySet                                                                                      
                                                                                                                                        
                            5.  AddToShadowCopySet("\\\\Node01\\SMBBasic")                                                              
                                                                                                                                        
                            6.  AddToShadowCopySet("\\\\Node02\\SMBBasic")                                                              
                                                                                                                                        
                            7.  Expect the server returns an error code E\_INVALIDARG (0x80070057).                                     |
| **Cleanup**              | AbortShadowCopySet                                                                                         
                                                                                                                                        
                            DeleteShareMapping                                                                                          |

|                          |                                                                                                                               |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_VSSOperateShadowCopySet\_ClusterSharePath\_OwnerNode                                                                     |
| **Description **         | Check if the server returns correctly when adding different sharePath on the cluster and the owner node to a shadow copy set. |
| **Prerequisites**        |                                                                                                                               |
| **Test Execution Steps** | 1.  Get the owner of cluster resource “GeneralFS”                                                                             
                                                                                                                                                           
                            2.  IsPathSupported("\\\\GeneralFS\\SMBClustered")                                                                             
                                                                                                                                                           
                            3.  GetSupportedVersion                                                                                                        
                                                                                                                                                           
                            4.  SetContext(0x00400000)                                                                                                     
                                                                                                                                                           
                            5.  StartShadowCopySet                                                                                                         
                                                                                                                                                           
                            6.  AddToShadowCopySet("\\\\GeneralFS\\SMBClustered")                                                                          
                                                                                                                                                           
                            7.  AddToShadowCopySet("\\\\Owner\\SMBBasic")                                                                                  
                                                                                                                                                           
                            8.  PrepareShadowCopySet                                                                                                       
                                                                                                                                                           
                            9.  CommitShadowCopySet                                                                                                        
                                                                                                                                                           
                            10. ExposeShadowCopySet                                                                                                        
                                                                                                                                                           
                            11. GetShareMapping                                                                                                            
                                                                                                                                                           
                            12. Create a file in the exposed share and expect the success.                                                                 
                                                                                                                                                           
                            13. RecoveryCompleteShadowCopySet                                                                                              
                                                                                                                                                           
                            14. IsPathShadowCopied                                                                                                         
                                                                                                                                                           
                            15. DeleteShareMapping                                                                                                         |
| **Cleanup**              | AbortShadowCopySet                                                                                                            
                                                                                                                                                           
                            DeleteShareMapping                                                                                                             |

|                          |                                                                                                                                   |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_VSSOperateShadowCopySet\_ClusterSharePath\_NonOwnerNode                                                                      |
| **Description **         | Check if the server returns correctly when adding different sharePath on the cluster and the non-owner node to a shadow copy set. |
| **Prerequisites**        |                                                                                                                                   |
| **Test Execution Steps** | 1.  Get the owner of cluster resource “GeneralFS”                                                                                 
                                                                                                                                                               
                            2.  IsPathSupported("\\\\GeneralFS\\SMBClustered")                                                                                 
                                                                                                                                                               
                            3.  GetSupportedVersion                                                                                                            
                                                                                                                                                               
                            4.  SetContext(0x00400000)                                                                                                         
                                                                                                                                                               
                            5.  StartShadowCopySet                                                                                                             
                                                                                                                                                               
                            6.  AddToShadowCopySet("\\\\GeneralFS\\SMBClustered")                                                                              
                                                                                                                                                               
                            7.  AddToShadowCopySet("\\\\NonOwner\\SMBBasic")                                                                                   
                                                                                                                                                               
                            8.  Expect the server returns an error code E\_INVALIDARG (0x80070057).                                                            |
| **Cleanup**              | AbortShadowCopySet                                                                                                                
                                                                                                                                                               
                            DeleteShareMapping                                                                                                                 |

1.  ### VSSSetContext

    1.  #### Scenario

|                               |                               |
|-------------------------------|-------------------------------|
| **Description**               | Test important context.       |
| **Call Sequence**             | IsPathSupported               
                                                                
                                 GetSupportedVersion            
                                                                
                                 SetContext                     
                                                                
                                 StartShadowCopySet             
                                                                
                                 AddToShadowCopySet             
                                                                
                                 PrepareShadowCopySet           
                                                                
                                 CommitShadowCopySet            
                                                                
                                 ExposeShadowCopySet            
                                                                
                                 GetShareMapping                
                                                                
                                 RecoveryCompleteShadowCopySet  
                                                                
                                 IsPathShadowCopied             
                                                                
                                 DeleteShareMapping             |
| **Cluster Involved Scenario** | NO                            |

#### Test Case

|                          |                                                                                                                                            |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_VSSSetContext\_ReadonlySnapshot\_BACKUP                                                                                               |
| **Description **         | Check if the server supports FsrvpContextValues.FSRVP\_CTX\_BACKUP|FsrvpShadowCopyAttributes.FSRVP\_ATTR\_NO\_AUTO\_RECOVERY (0x00000002). |
| **Prerequisites**        |                                                                                                                                            |
| **Test Execution Steps** | 1.  IsPathSupported                                                                                                                        
                                                                                                                                                                        
                            2.  GetSupportedVersion                                                                                                                     
                                                                                                                                                                        
                            3.  SetContext(0x00000002)                                                                                                                  
                                                                                                                                                                        
                            4.  StartShadowCopySet                                                                                                                      
                                                                                                                                                                        
                            5.  AddToShadowCopySet                                                                                                                      
                                                                                                                                                                        
                            6.  PrepareShadowCopySet                                                                                                                    
                                                                                                                                                                        
                            7.  CommitShadowCopySet                                                                                                                     
                                                                                                                                                                        
                            8.  ExposeShadowCopySet                                                                                                                     
                                                                                                                                                                        
                            9.  GetShareMapping                                                                                                                         
                                                                                                                                                                        
                            10. Create a file in the exposed share and expect the failure.                                                                              
                                                                                                                                                                        
                            11. RecoveryCompleteShadowCopySet                                                                                                           
                                                                                                                                                                        
                            12. IsPathShadowCopied                                                                                                                      
                                                                                                                                                                        
                            13. DeleteShareMapping                                                                                                                      |
| **Cleanup**              | AbortShadowCopySet                                                                                                                         
                                                                                                                                                                        
                            DeleteShareMapping                                                                                                                          |

|                          |                                                                                                                                                   |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | VSSSetContext\_ReadonlySnapshot\_APP\_ROLLBACK                                                                                                    |
| **Description **         | Check if the server supports FsrvpContextValues.FSRVP\_CTX\_APP\_ROLLBACK|FsrvpShadowCopyAttributes.FSRVP\_ATTR\_NO\_AUTO\_RECOVERY (0x0000000B). |
| **Prerequisites**        |                                                                                                                                                   |
| **Test Execution Steps** | 1.  IsPathSupported                                                                                                                               
                                                                                                                                                                               
                            2.  GetSupportedVersion                                                                                                                            
                                                                                                                                                                               
                            3.  SetContext(0x0000000B)                                                                                                                         
                                                                                                                                                                               
                            4.  StartShadowCopySet                                                                                                                             
                                                                                                                                                                               
                            5.  AddToShadowCopySet                                                                                                                             
                                                                                                                                                                               
                            6.  PrepareShadowCopySet                                                                                                                           
                                                                                                                                                                               
                            7.  CommitShadowCopySet                                                                                                                            
                                                                                                                                                                               
                            8.  ExposeShadowCopySet                                                                                                                            
                                                                                                                                                                               
                            9.  GetShareMapping                                                                                                                                
                                                                                                                                                                               
                            10. Create a file in the exposed share and expect the failure.                                                                                     
                                                                                                                                                                               
                            11. RecoveryCompleteShadowCopySet                                                                                                                  
                                                                                                                                                                               
                            12. IsPathShadowCopied                                                                                                                             
                                                                                                                                                                               
                            13. DeleteShareMapping                                                                                                                             |
| **Cleanup**              | AbortShadowCopySet                                                                                                                                
                                                                                                                                                                               
                            DeleteShareMapping                                                                                                                                 |

|                          |                                                                                         |
|--------------------------|-----------------------------------------------------------------------------------------|
| **Test ID**              | VSSSetContext\_ReadonlySnapshot\_NAS\_ROLLBACK                                          |
| **Description **         | Check if the server supports FsrvpContextValues.FSRVP\_CTX\_NAS\_ROLLBACK (0x00000010). |
| **Prerequisites**        |                                                                                         |
| **Test Execution Steps** | 1.  IsPathSupported                                                                     
                                                                                                                     
                            2.  GetSupportedVersion                                                                  
                                                                                                                     
                            3.  SetContext(0x00000010)                                                               
                                                                                                                     
                            4.  StartShadowCopySet                                                                   
                                                                                                                     
                            5.  AddToShadowCopySet                                                                   
                                                                                                                     
                            6.  PrepareShadowCopySet                                                                 
                                                                                                                     
                            7.  CommitShadowCopySet                                                                  
                                                                                                                     
                            8.  ExposeShadowCopySet                                                                  
                                                                                                                     
                            9.  GetShareMapping                                                                      
                                                                                                                     
                            10. Create a file in the exposed share and expect the failure.                           
                                                                                                                     
                            11. RecoveryCompleteShadowCopySet                                                        
                                                                                                                     
                            12. IsPathShadowCopied                                                                   
                                                                                                                     
                            13. DeleteShareMapping                                                                   |
| **Cleanup**              | AbortShadowCopySet                                                                      
                                                                                                                     
                            DeleteShareMapping                                                                       |

|                          |                                                                                               |
|--------------------------|-----------------------------------------------------------------------------------------------|
| **Test ID**              | VSSSetContext\_ReadonlySnapshot\_FILE\_SHARE\_BACKUP                                          |
| **Description **         | Check if the server supports FsrvpContextValues.FSRVP\_CTX\_FILE\_SHARE\_BACKUP (0x00000019). |
| **Prerequisites**        |                                                                                               |
| **Test Execution Steps** | 1.  IsPathSupported                                                                           
                                                                                                                           
                            2.  GetSupportedVersion                                                                        
                                                                                                                           
                            3.  SetContext(0x00000019)                                                                     
                                                                                                                           
                            4.  StartShadowCopySet                                                                         
                                                                                                                           
                            5.  AddToShadowCopySet                                                                         
                                                                                                                           
                            6.  PrepareShadowCopySet                                                                       
                                                                                                                           
                            7.  CommitShadowCopySet                                                                        
                                                                                                                           
                            8.  ExposeShadowCopySet                                                                        
                                                                                                                           
                            9.  GetShareMapping                                                                            
                                                                                                                           
                            10. Create a file in the exposed share and expect the failure.                                 
                                                                                                                           
                            11. RecoveryCompleteShadowCopySet                                                              
                                                                                                                           
                            12. IsPathShadowCopied                                                                         
                                                                                                                           
                            13. DeleteShareMapping                                                                         |
| **Cleanup**              | AbortShadowCopySet                                                                            
                                                                                                                           
                            DeleteShareMapping                                                                             |

|                          |                                                                                                                                                                    |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | VSSSetContext\_Invalid                                                                                                                                             |
| **Description **         | Check if the server does not support FsrvpShadowCopyAttributes.FSRVP\_ATTR\_NO\_AUTO\_RECOVERY|FsrvpShadowCopyAttributes.FSRVP\_ATTR\_AUTO\_RECOVERY (0x00400002). |
| **Prerequisites**        |                                                                                                                                                                    |
| **Test Execution Steps** | 1.  IsPathSupported                                                                                                                                                
                                                                                                                                                                                                
                            2.  GetSupportedVersion                                                                                                                                             
                                                                                                                                                                                                
                            3.  SetContext(0x00400002)                                                                                                                                          
                                                                                                                                                                                                
                            4.  Expect the server returns an error code FSRVP\_E\_UNSUPPORTED\_CONTEXT (0x8004231B).                                                                            |
| **Cleanup**              | AbortShadowCopySet                                                                                                                                                 
                                                                                                                                                                                                
                            DeleteShareMapping                                                                                                                                                  |

1.  ### VSSAbortShadowCopySet

    1.  #### Scenario

|                               |                                                    |
|-------------------------------|----------------------------------------------------|
| **Description**               | Test to abort a shadow copy set in specific state. |
| **Call Sequence**             | IsPathSupported                                    
                                                                                     
                                 GetSupportedVersion                                 
                                                                                     
                                 SetContext                                          
                                                                                     
                                 StartShadowCopySet (AbortShadowCopySet)             
                                                                                     
                                 AddToShadowCopySet (AbortShadowCopySet)             
                                                                                     
                                 PrepareShadowCopySet                                
                                                                                     
                                 CommitShadowCopySet                                 
                                                                                     
                                 ExposeShadowCopySet                                 
                                                                                     
                                 GetShareMapping                                     
                                                                                     
                                 RecoveryCompleteShadowCopySet (AbortShadowCopySet)  
                                                                                     
                                 IsPathShadowCopied                                  
                                                                                     
                                 DeleteShareMapping                                  |
| **Cluster Involved Scenario** | NO                                                 |

#### Test Case

|                          |                                                                                   |
|--------------------------|-----------------------------------------------------------------------------------|
| **Test ID**              | VSSAbortShadowCopySet\_Started                                                    |
| **Description **         | Check if the server supports AbortShadowCopySet after calling StartShadowCopySet. |
| **Prerequisites**        |                                                                                   |
| **Test Execution Steps** | 1.  IsPathSupported                                                               
                                                                                                               
                            2.  GetSupportedVersion                                                            
                                                                                                               
                            3.  SetContext(0x00000000)                                                         
                                                                                                               
                            4.  StartShadowCopySet                                                             
                                                                                                               
                            5.  AbortShadowCopySet                                                             
                                                                                                               
                            6.  Expect the server returns SUCCESS(0x00000000)                                  |
| **Cleanup**              | AbortShadowCopySet                                                                
                                                                                                               
                            DeleteShareMapping                                                                 |

|                          |                                                                                 |
|--------------------------|---------------------------------------------------------------------------------|
| **Test ID**              | VSSAbortShadowCopySet\_Added                                                    |
| **Description **         | Check if the server supports AbortShadowCopySet after calling AddShadowCopySet. |
| **Prerequisites**        |                                                                                 |
| **Test Execution Steps** | 1.  IsPathSupported                                                             
                                                                                                             
                            2.  GetSupportedVersion                                                          
                                                                                                             
                            3.  SetContext(0x00000000)                                                       
                                                                                                             
                            4.  StartShadowCopySet                                                           
                                                                                                             
                            5.  AddShadowCopySet                                                             
                                                                                                             
                            6.  AbortShadowCopySet                                                           
                                                                                                             
                            7.  Expect the server returns SUCCESS(0x00000000)                                |
| **Cleanup**              | AbortShadowCopySet                                                              
                                                                                                             
                            DeleteShareMapping                                                               |

|                          |                                                                                                                                     |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | VSSAbortShadowCopySet\_Recovered                                                                                                    |
| **Description **         | Check if the server responses with FSRVP\_E\_BAD\_STATE when calling AbortShadowCopySet after called RecoveryCompleteShadowCopySet. |
| **Prerequisites**        |                                                                                                                                     |
| **Test Execution Steps** | 1.  IsPathSupported                                                                                                                 
                                                                                                                                                                 
                            2.  GetSupportedVersion                                                                                                              
                                                                                                                                                                 
                            3.  SetContext(0x00000000)                                                                                                           
                                                                                                                                                                 
                            4.  StartShadowCopySet                                                                                                               
                                                                                                                                                                 
                            5.  AddShadowCopySet                                                                                                                 
                                                                                                                                                                 
                            6.  PrepareShadowCopySet                                                                                                             
                                                                                                                                                                 
                            7.  CommitShadowCopySet                                                                                                              
                                                                                                                                                                 
                            8.  ExposeShadowCopySet                                                                                                              
                                                                                                                                                                 
                            9.  RecoveryCompleteShadowCopySet                                                                                                    
                                                                                                                                                                 
                            10. AbortShadowCopySet                                                                                                               
                                                                                                                                                                 
                            11. Expect the server returns an error code FSRVP\_E\_BAD\_STATE(0x80042301)                                                         |
| **Cleanup**              | AbortShadowCopySet                                                                                                                  
                                                                                                                                                                 
                            DeleteShareMapping                                                                                                                   |

|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------|
| <span id="_Toc358295877" class="anchor"><span id="_Toc358295878" class="anchor"><span id="_Toc358295910" class="anchor"><span id="_Toc358295942" class="anchor"><span id="_Toc325719674" class="anchor"><span id="_Toc325719982" class="anchor"><span id="_Toc358295943" class="anchor"><span id="_Toc358295977" class="anchor"><span id="_Toc358296011" class="anchor"><span id="_Toc358296045" class="anchor"><span id="_Toc358296046" class="anchor"><span id="_Toc358296080" class="anchor"><span id="_Toc358296127" class="anchor"><span id="_Toc358296174" class="anchor"><span id="_Toc358296175" class="anchor"><span id="_Toc358296216" class="anchor"><span id="_Toc358296217" class="anchor"><span id="_Toc358296251" class="anchor"><span id="_Toc358296252" class="anchor"><span id="_Toc358296274" class="anchor"><span id="_Toc358296294" class="anchor"><span id="_Toc358296314" class="anchor"><span id="_Toc358296334" class="anchor"><span id="_Toc358296335" class="anchor"><span id="_Toc358296389" class="anchor"><span id="_Toc358296390" class="anchor"><span id="_Toc358296419" class="anchor"><span id="_Toc358296420" class="anchor"><span id="_Toc358296449" class="anchor"><span id="_Toc358296450" class="anchor"><span id="_Toc358296494" class="anchor"><span id="_Toc358296495" class="anchor"><span id="_Toc358296522" class="anchor"><span id="_Toc358296554" class="anchor"><span id="_Toc358296556" class="anchor"><span id="_Toc358296604" class="anchor"><span id="_Toc358296639" class="anchor"><span id="_Toc358296640" class="anchor"><span id="_Toc358296679" class="anchor"><span id="_Toc358296680" class="anchor"><span id="_Toc358296681" class="anchor"><span id="_Toc358296682" class="anchor"><span id="_Toc358296719" class="anchor"><span id="_Toc358296756" class="anchor"><span id="_Toc358296793" class="anchor"><span id="_Toc358296830" class="anchor"><span id="_Toc358296867" class="anchor"><span id="_Toc358296904" class="anchor"><span id="_Toc358296940" class="anchor"><span id="_Toc358296976" class="anchor"><span id="_Toc358297012" class="anchor"><span id="_Toc358297013" class="anchor"><span id="_Toc358297014" class="anchor"><span id="_Toc358297036" class="anchor"><span id="_Toc358297082" class="anchor"><span id="_Toc358297127" class="anchor"><span id="_Toc358297173" class="anchor"><span id="_Toc358297216" class="anchor"><span id="_Toc358297267" class="anchor"><span id="_Toc358297312" class="anchor"><span id="_Toc358297313" class="anchor"><span id="_Toc358297344" class="anchor"><span id="_Toc358297375" class="anchor"><span id="_Toc358297376" class="anchor"><span id="_Toc358297419" class="anchor"><span id="_Toc325719223" class="anchor"><span id="_Toc325719690" class="anchor"><span id="_Toc325719998" class="anchor"><span id="_Toc325720304" class="anchor"><span id="_Toc325719260" class="anchor"><span id="_Toc325719727" class="anchor"><span id="_Toc325720035" class="anchor"><span id="_Toc325720341" class="anchor"><span id="_Toc325719297" class="anchor"><span id="_Toc325719764" class="anchor"><span id="_Toc325720072" class="anchor"><span id="_Toc325720378" class="anchor"><span id="_Toc325719334" class="anchor"><span id="_Toc325719801" class="anchor"><span id="_Toc325720109" class="anchor"><span id="_Toc325720415" class="anchor"><span id="_Toc325719371" class="anchor"><span id="_Toc325719838" class="anchor"><span id="_Toc325720146" class="anchor"><span id="_Toc325720452" class="anchor"><span id="_Toc325719373" class="anchor"><span id="_Toc325719840" class="anchor"><span id="_Toc325720148" class="anchor"><span id="_Toc325720454" class="anchor"><span id="_Toc325719443" class="anchor"><span id="_Test_Suite_Design_1" class="anchor"><span id="_Test_Cases_Design" class="anchor"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>**Scenario** | **Test Cases** |
| **OpenCloseSharedVHD**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | 1              |
| **TunnelOperationToSharedVHD**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 6              |
| **ReadWriteSharedVHD**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | 2              |
| **QuerySharedVirtualDiskSupport**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 1              |
| **TwoClientsAccessSameSharedVHD**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 2              |
| **ReconnectVHDWithoutDeviceContext**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 1              |
| **QueryVHDSetFileInfo**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 2              |
| **ConvertVHDtoVHDSet**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | 1              |
| **CreateDeleteCheckpoint**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 1              |
| **ExtractVHDSet**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 1              |

1.  <span id="_Toc394424127" class="anchor"><span id="_Toc394493241" class="anchor"><span id="_Toc398111927" class="anchor"><span id="_Toc419731539" class="anchor"><span id="_Toc419796167" class="anchor"><span id="_Toc419970342" class="anchor"><span id="_Toc420069672" class="anchor"><span id="_Toc420071822" class="anchor"><span id="_Toc420661898" class="anchor"><span id="_Toc420669150" class="anchor"><span id="_Toc420669769" class="anchor"><span id="_Toc427488200" class="anchor"></span></span></span></span></span></span></span></span></span></span></span></span>

    1.  ### OpenCloseSharedVHD

        1.  #### Scenario

|                               |                                                                                         |
|-------------------------------|-----------------------------------------------------------------------------------------|
| **Description**               | Check if server handles the request to open/close a shared virtual disk file correctly. |
| **Message Sequence**          | OpenSharedVirtualDisk                                                                   
                                                                                                                          
                                 CloseSharedVirtualDisk                                                                   |
| **Cluster Involved Scenario** | YES                                                                                     |

#### Test Case

|                          |                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_OpenCloseSharedVHD                                                                                                |
| **Description **         | Check if the server supports opening/closing a shared virtual disk file.                                               |
| **Prerequisites**        |                                                                                                                        |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk file with SMB2 create context SVHDX\_OPEN\_DEVICE\_CONTEXT and expects success. 
                                                                                                                                                    
                            2.  Client closes the file and expect success.                                                                          |
| **Cleanup**              | N/A                                                                                                                    |

<span id="_Toc381628262" class="anchor"><span id="_Toc381628531" class="anchor"><span id="_Toc381628279" class="anchor"><span id="_Toc381628548" class="anchor"><span id="_Toc381628296" class="anchor"><span id="_Toc381628565" class="anchor"><span id="_Toc381628313" class="anchor"><span id="_Toc381628582" class="anchor"><span id="_Toc381628330" class="anchor"><span id="_Toc381628599" class="anchor"><span id="_Toc381628347" class="anchor"><span id="_Toc381628616" class="anchor"></span></span></span></span></span></span></span></span></span></span></span></span>

|                          |                                                                                                                                                                            |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ReconnectSharedVHDWithoutDeviceContext                                                                                                                                     |
| **Description **         | Check if the client can reconnect the persistent handle to the shared virtual disk file without carrying device context.                                                   |
| **Prerequisites**        |                                                                                                                                                                            |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk file with SMB2 create contexts SVHDX\_OPEN\_DEVICE\_CONTEXT and SMB2\_CREATE\_DURABLE\_HANDLE\_REQUEST\_V2 (persistent bit is set). 
                                                                                                                                                                                                        
                            2.  Client disconnects from the server.                                                                                                                                     
                                                                                                                                                                                                        
                            3.  Client reconnects the persistent handle without create context SVHDX\_OPEN\_DEVICE\_CONTEXT and expects success.                                                        |
| **Cleanup**              | N/A                                                                                                                                                                        |

1.  ### TunnelOperationToSharedVHD

    1.  #### Scenario

|                               |                                                                                               |
|-------------------------------|-----------------------------------------------------------------------------------------------|
| **Description**               | Check if server handles the tunnel operation request to a shared virtual disk file correctly. |
| **Message Sequence**          | OpenSharedVirtualDisk                                                                         
                                                                                                                                
                                 TunnelOperation                                                                                
                                                                                                                                
                                 CloseSharedVirtualDisk                                                                         |
| **Cluster Involved Scenario** | YES                                                                                           |

#### Test Case

|                          |                                                                                                           |
|--------------------------|-----------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_TunnelGetFileInfoToSharedVHD                                                                         |
| **Description **         | Check if server supports handling tunnel operation RSVD\_TUNNEL\_GET\_FILE\_INFO\_OPERATION.              |
| **Prerequisites**        |                                                                                                           |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk file successfully.                                                 
                                                                                                                                       
                            2.  Client sends tunnel operation RSVD\_TUNNEL\_GET\_FILE\_INFO\_OPERATION to server and expects success.  
                                                                                                                                       
                            3.  Client closes the file.                                                                                |
| **Cleanup**              | N/A                                                                                                       |

|                          |                                                                                                |
|--------------------------|------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_TunnelSCSIToSharedVHD                                                                     |
| **Description **         | Check if server supports handling tunnel operation RSVD\_TUNNEL\_SCSI\_OPERATION.              |
| **Prerequisites**        |                                                                                                |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk file successfully.                                      
                                                                                                                            
                            2.  Client sends tunnel operation RSVD\_TUNNEL\_SCSI\_OPERATION to server and expects success.  
                                                                                                                            
                            3.  Client closes the file.                                                                     |
| **Cleanup**              | N/A                                                                                            |

|                          |                                                                                                                     |
|--------------------------|---------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_TunnelCheckConnectionStatusToSharedVHD                                                                         |
| **Description **         | Check if server supports handling tunnel operation RSVD\_TUNNEL\_CHECK\_CONNECTION\_STATUS\_OPERATION.              |
| **Prerequisites**        |                                                                                                                     |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk file successfully.                                                           
                                                                                                                                                 
                            2.  Client sends tunnel operation RSVD\_TUNNEL\_CHECK\_CONNECTION\_STATUS\_OPERATION to server and expects success.  
                                                                                                                                                 
                            3.  Client closes the file.                                                                                          |
| **Cleanup**              | N/A                                                                                                                 |

|                          |                                                                                                       |
|--------------------------|-------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_TunnelSRBStatusToSharedVHD                                                                       |
| **Description **         | Check if server supports handling tunnel operation RSVD\_TUNNEL\_SRB\_STATUS\_OPERATION.              |
| **Prerequisites**        |                                                                                                       |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk file successfully.                                             
                                                                                                                                   
                            2.  Read fail                                                                                          
                                                                                                                                   
                            3.  Client sends tunnel operation RSVD\_TUNNEL\_SRB\_STATUS\_OPERATION to server and expects success.  
                                                                                                                                   
                            4.  Client closes the file.                                                                            |
| **Cleanup**              | N/A                                                                                                   |

|                          |                                                                                                           |
|--------------------------|-----------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_TunnelGetDiskInfoToSharedVHD                                                                         |
| **Description **         | Check if server supports handling tunnel operation RSVD\_TUNNEL\_GET\_DISK\_INFO\_OPERATION.              |
| **Prerequisites**        |                                                                                                           |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk file successfully.                                                 
                                                                                                                                       
                            2.  Client sends tunnel operation RSVD\_TUNNEL\_GET\_DISK\_INFO\_OPERATION to server and expects success.  
                                                                                                                                       
                            3.  Client closes the file.                                                                                |
| **Cleanup**              | N/A                                                                                                       |

|                          |                                                                                                          |
|--------------------------|----------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_TunnelValidateDiskToSharedVHD                                                                       |
| **Description **         | Check if server supports handling tunnel operation RSVD\_TUNNEL\_VALIDATE\_DISK\_OPERATION.              |
| **Prerequisites**        |                                                                                                          |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk file successfully.                                                
                                                                                                                                      
                            2.  Client sends tunnel operation RSVD\_TUNNEL\_VALIDATE\_DISK\_OPERATION to server and expects success.  
                                                                                                                                      
                            3.  Client closes the file.                                                                               |
| **Cleanup**              | N/A                                                                                                      |

1.  ### <span id="_Toc381628349" class="anchor"><span id="_Toc381628618" class="anchor"><span id="_Toc381628367" class="anchor"><span id="_Toc381628636" class="anchor"><span id="_Toc381628385" class="anchor"><span id="_Toc381628654" class="anchor"><span id="_Toc381628403" class="anchor"><span id="_Toc381628672" class="anchor"><span id="_Toc381628421" class="anchor"><span id="_Toc381628690" class="anchor"><span id="_Toc381628439" class="anchor"><span id="_Toc381628708" class="anchor"><span id="_Toc427488203" class="anchor"></span></span></span></span></span></span></span></span></span></span></span></span></span>ReadWriteSharedVHD

    1.  #### Scenario

|                               |                                                                                     |
|-------------------------------|-------------------------------------------------------------------------------------|
| **Description**               | Check if server handles Read/Write request to a shared virtual disk file correctly. |
| **Message Sequence**          | OpenSharedVirtualDisk                                                               
                                                                                                                      
                                 ReadContent                                                                          
                                                                                                                      
                                 WriteContent                                                                         
                                                                                                                      
                                 CloseSharedVirtualDisk                                                               |
| **Cluster Involved Scenario** | YES                                                                                 |

#### Test Case

|                          |                                                                               |
|--------------------------|-------------------------------------------------------------------------------|
| **Test ID**              | BVT\_ReadSharedVHD                                                            |
| **Description **         | Check if server handles Read request to a shared virtual disk file correctly. |
| **Prerequisites**        |                                                                               |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk file successfully.                     
                                                                                                           
                            2.  Client reads file content successfully.                                    
                                                                                                           
                            3.  Client closes the file.                                                    |
| **Cleanup**              | N/A                                                                           |

|                          |                                                                                |
|--------------------------|--------------------------------------------------------------------------------|
| **Test ID**              | BVT\_WriteSharedVHD                                                            |
| **Description **         | Check if server handles Write request to a shared virtual disk file correctly. |
| **Prerequisites**        |                                                                                |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk file successfully.                      
                                                                                                            
                            2.  Client writes file content successfully.                                    
                                                                                                            
                            3.  Client closes the file.                                                     |
| **Cleanup**              | N/A                                                                            |

1.  ### QuerySharedVirtualDiskSupport

    1.  #### Scenario

|                               |                                                                                                         |
|-------------------------------|---------------------------------------------------------------------------------------------------------|
| **Description**               | Check if server handles SHARED\_VIRTUAL\_DISK\_SUPPORT request to a shared virtual disk file correctly. |
| **Message Sequence**          | OpenSharedVirtualDisk                                                                                   
                                                                                                                                          
                                 QuerySharedVirtualDiskSupport                                                                            
                                                                                                                                          
                                 CloseSharedVirtualDisk                                                                                   |
| **Cluster Involved Scenario** | YES                                                                                                     |

#### Test Case

|                          |                                                                                                         |
|--------------------------|---------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_QuerySharedVirtualDiskSupport                                                                      |
| **Description **         | Check if server handles SHARED\_VIRTUAL\_DISK\_SUPPORT request to a shared virtual disk file correctly. |
| **Prerequisites**        |                                                                                                         |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk file successfully.                                               
                                                                                                                                     
                            2.  Client sends SVHDX\_SHARED\_VIRTUAL\_DISK\_SUPPORT\_REQUEST to server and expects success.           
                                                                                                                                     
                            3.  Client closes the file.                                                                              |
| **Cleanup**              | N/A                                                                                                     |

1.  ### <span id="_Toc381628442" class="anchor"><span id="_Toc381628711" class="anchor"><span id="_Toc381628460" class="anchor"><span id="_Toc381628729" class="anchor"><span id="_Toc427488205" class="anchor"></span></span></span></span></span>TwoClientsAccessSameSharedVHD

    1.  #### Scenario

|                               |                                                                                                   |
|-------------------------------|---------------------------------------------------------------------------------------------------|
| **Description**               | Check if server handles requests to the same shared virtual disk file from two clients correctly. |
| **Message Sequence**          | The first client does some operation to the shared virtual disk file.                             
                                                                                                                                    
                                 The second client does some operation to the same shared virtual disk file.                        
                                                                                                                                    
                                 The two clients closes the shared virtual disk file.                                               |
| **Cluster Involved Scenario** | YES                                                                                               |

#### Test Case

|                          |                                                                                                |
|--------------------------|------------------------------------------------------------------------------------------------|
| **Test ID**              | TwoClientsReadSameSharedVHD                                                                    |
| **Description **         | Check if server handles Read request to a shared virtual disk file from two clients correctly. |
| **Prerequisites**        |                                                                                                |
| **Test Execution Steps** | 1.  The first client opens a shared virtual disk file successfully.                            
                                                                                                                            
                            2.  The first client reads file content successfully.                                           
                                                                                                                            
                            3.  The second client opens the same shared virtual disk file successfully.                     
                                                                                                                            
                            4.  The second client reads file content successfully.                                          
                                                                                                                            
                            5.  The first client closes the file.                                                           
                                                                                                                            
                            6.  The second client closes the file.                                                          |
| **Cleanup**              | N/A                                                                                            |

|                          |                                                                                                 |
|--------------------------|-------------------------------------------------------------------------------------------------|
| **Test ID**              | TwoClientsWriteSameSharedVHD                                                                    |
| **Description **         | Check if server handles Write request to a shared virtual disk file from two clients correctly. |
| **Prerequisites**        | N/A                                                                                             |
| **Test Execution Steps** | 1.  The first client opens a shared virtual disk file successfully.                             
                                                                                                                             
                            2.  The first client writes file content successfully.                                           
                                                                                                                             
                            3.  The second client opens the same shared virtual disk file successfully.                      
                                                                                                                             
                            4.  The second client writes file content successfully.                                          
                                                                                                                             
                            5.  The first client closes the file.                                                            
                                                                                                                             
                            6.  The second client closes the file.                                                           |
| **Cleanup**              | N/A                                                                                             |

1.  ### <span id="_Toc420661904" class="anchor"><span id="_Toc420661905" class="anchor"><span id="_Toc420661917" class="anchor"><span id="_Toc420661918" class="anchor"><span id="_Toc420071828" class="anchor"><span id="_Toc427488206" class="anchor"></span></span></span></span></span></span>ReconnectVHDWithoutDeviceContext

    1.  #### Scenario

|                               |                                                                                                                                   |
|-------------------------------|-----------------------------------------------------------------------------------------------------------------------------------|
| **Description**               | Check if server can reconnect the persistent handle to the shared virtual disk file without carrying device context successfully. |
| **Message Sequence**          | The client requests a persistent handle with device context and to the shared virtual disk file and expects success.              
                                                                                                                                                                    
                                 The client disconnects.                                                                                                            
                                                                                                                                                                    
                                 The client reconnects the persistent handle without carrying device context and expects success.                                   |
| **Cluster Involved Scenario** | YES                                                                                                                               |

#### Test Case

|                          |                                                                                                                                   |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ReconnectSharedVHDWithoutDeviceContext                                                                                            |
| **Description **         | Check if server can reconnect the persistent handle to the shared virtual disk file without carrying device context successfully. |
| **Prerequisites**        |                                                                                                                                   |
| **Test Execution Steps** | 1.  The client requests a persistent handle with device context successfully.                                                     
                                                                                                                                                               
                            2.  The client disconnects successfully.                                                                                           
                                                                                                                                                               
                            3.  The client reconnects the persistent handle without carrying device context and expects success.                               
                                                                                                                                                               
                            4.  The client closes the file.                                                                                                    |
| **Cleanup**              | N/A                                                                                                                               |

1.  ### QueryVHDSetFileInfo 

    1.  #### Scenario

|                               |                                                                                                                     |
|-------------------------------|---------------------------------------------------------------------------------------------------------------------|
| **Description**               | Check if server handles the tunnel operation request to query a shared virtual disk set file information correctly. |
| **Message Sequence**          | OpenSharedVirtualDisk                                                                                               
                                                                                                                                                      
                                 SvhdxTunnelVhdSetQueryInformation                                                                                    
                                                                                                                                                      
                                 CloseSharedVirtualDisk                                                                                               |
| **Cluster Involved Scenario** | YES                                                                                                                 |

#### Test Case

|                          |                                                                                                                                                                                              |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Query\_VHDSet\_FileInfo\_SnapshotList                                                                                                                                                   |
| **Description **         | Check if server supports handling tunnel operation SVHDX\_TUNNEL\_VHDSET\_FILE\_QUERY\_INFORMATION\_REQUEST while SetFileInfo is set to SvhdxVHDSetFileInformationTypeSnapshotList           |
| **Prerequisites**        |                                                                                                                                                                                              |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk set file successfully.                                                                                                                                
                                                                                                                                                                                                                          
                            2.  Client sends tunnel operation SVHDX\_TUNNEL\_VHDSET\_FILE\_QUERY\_INFORMATION\_REQUEST with SetFileInfo set to SvhdxVHDSetFileInformationTypeSnapshotList to server and expects success.  
                                                                                                                                                                                                                          
                            3.  Client closes the file.                                                                                                                                                                   |
| **Cleanup**              | N/A                                                                                                                                                                                          |

#### Test Case

|                          |                                                                                                                                                                                               |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Query\_VHDSet\_FileInfo\_SnapshotEntry                                                                                                                                                   |
| **Description **         | Check if server supports handling tunnel operation SVHDX\_TUNNEL\_VHDSET\_FILE\_QUERY\_INFORMATION\_REQUEST while SetFileInfo is set to SvhdxVHDSetFileInformationTypeSnapshotEntry           |
| **Prerequisites**        |                                                                                                                                                                                               |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk set file successfully.                                                                                                                                 
                                                                                                                                                                                                                           
                            2.  Client sends tunnel operation SVHDX\_TUNNEL\_VHDSET\_FILE\_QUERY\_INFORMATION\_REQUEST with SetFileInfo set to SvhdxVHDSetFileInformationTypeSnapshotEntry to server and expects success.  
                                                                                                                                                                                                                           
                            3.  Client closes the file.                                                                                                                                                                    |
| **Cleanup**              | N/A                                                                                                                                                                                           |

1.  ### <span id="_Toc420661938" class="anchor"><span id="_Toc420661956" class="anchor"><span id="_Toc427488208" class="anchor"></span></span></span>ConvertVHDtoVHDSet 

    1.  #### Scenario

|                               |                                                                                                                                           |
|-------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**               | Check if server handles the tunnel operation request to convert a shared virtual disk file into a shared virtual disk set file correctly. |
| **Message Sequence**          | OpenSharedVirtualDisk                                                                                                                     
                                                                                                                                                                            
                                 SvhdxMetaOperationStart                                                                                                                    
                                                                                                                                                                            
                                 CloseSharedVirtualDisk                                                                                                                     |
| **Cluster Involved Scenario** | YES                                                                                                                                       |

#### Test Case

|                          |                                                                                                                                                                                                                    |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Convert\_VHDFile\_to\_VHDSetFile                                                                                                                                                                              |
| **Description **         | Check if server supports handling tunnel operation SVHDX\_META\_OPERATION\_START\_REQUEST with SVHDX\_META\_OPERATION\_CONVERT\_TO\_VHDSET in the payload to convert the .vhdx file into the .vhds file correctly. |
| **Prerequisites**        |                                                                                                                                                                                                                    |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk set file successfully.                                                                                                                                                      
                                                                                                                                                                                                                                                
                            2.  Client sends tunnel operation SVHDX\_META\_OPERATION\_START\_REQUEST with SVHDX\_META\_OPERATION\_CONVERT\_TO\_VHDSET structure in the payload to server and expects success.                                   
                                                                                                                                                                                                                                                
                            3.  Client closes the file.                                                                                                                                                                                         |
| **Cleanup**              | N/A                                                                                                                                                                                                                |

1.  ### CreateDeleteCheckpoint 

    1.  #### Scenario

|                               |                                                                                                                                 |
|-------------------------------|---------------------------------------------------------------------------------------------------------------------------------|
| **Description**               | Check if server handles the tunnel operation request to take and delete checkpoint on a shared virtual disk set file correctly. |
| **Message Sequence**          | OpenSharedVirtualDisk                                                                                                           
                                                                                                                                                                  
                                 SvhdxMetaOperationStart                                                                                                          
                                                                                                                                                                  
                                 SvhdxMetaOperationStart                                                                                                          
                                                                                                                                                                  
                                 SvhdxTunnelDeleteSnapshot                                                                                                        
                                                                                                                                                                  
                                 CloseSharedVirtualDisk                                                                                                           |
| **Cluster Involved Scenario** | YES                                                                                                                             |

#### Test Case

|                          |                                                                                                                                                                                              |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Create\_Delete\_Checkpoint                                                                                                                                                              |
| **Description **         | Check if server supports handling tunnel operation to create and delete checkpoint on a shared virtual disk set file correctly.                                                              |
| **Prerequisites**        |                                                                                                                                                                                              |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk set file successfully.                                                                                                                                
                                                                                                                                                                                                                          
                            2.  Client sends the first SVHDX\_META\_OPERATION\_START\_REQUEST with SVHDX\_META\_OPERATION\_CREATE\_SNAPSHOT structure in the payload to server to do initialization and expects success.  
                                                                                                                                                                                                                          
                            3.  Client sends the second SVHDX\_META\_OPERATION\_START\_REQUEST with SVHDX\_META\_OPERATION\_CREATE\_SNAPSHOT structure in the payload to server to take a snapshot and expects success.   
                                                                                                                                                                                                                          
                            4.  Client sends the SVHDX\_TUNNEL\_DELETE\_SNAPSHOT\_REQUEST to server to delete the created snapshot and expects success.                                                                   
                                                                                                                                                                                                                          
                            5.  Client closes the file.                                                                                                                                                                   |
| **Cleanup**              | N/A                                                                                                                                                                                          |

1.  ### ExtractVHDSet 

    1.  #### Scenario

|                               |                                                                                                             |
|-------------------------------|-------------------------------------------------------------------------------------------------------------|
| **Description**               | Check if server handles the tunnel operation request to extract the shared virtual disk set file correctly. |
| **Message Sequence**          | OpenSharedVirtualDisk                                                                                       
                                                                                                                                              
                                 SvhdxMetaOperationStart                                                                                      
                                                                                                                                              
                                 CloseSharedVirtualDisk                                                                                       |
| **Cluster Involved Scenario** | YES                                                                                                         |

#### Test Case

|                          |                                                                                                                                                          |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | BVT\_Extract\_VHDSet                                                                                                                                     |
| **Description **         | Check if server supports handling tunnel operation to extract the shared virtual disk set file correctly.                                                |
| **Prerequisites**        |                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client opens a shared virtual disk set file successfully.                                                                                            
                                                                                                                                                                                      
                            2.  Client sends the SVHDX\_META\_OPERATION\_START\_REQUEST with SVHDX\_META\_OPERATION\_EXTRACT structure in the payload to server and expects success.  
                                                                                                                                                                                      
                            3.  Client closes the file.                                                                                                                               |
| **Cleanup**              | N/A                                                                                                                                                      |

|                                              |                |
|----------------------------------------------|----------------|
| **Scenario**                                 | **Test Cases** |
| **Domain\_referral\_to\_DC**                 | 5              |
| **DC\_referral\_to\_DC**                     | 6              |
| **Sysvol\_referral\_to\_DC**                 | 7              |
| **Root\_referral\_to\_DC**                   | 5              |
| **Link\_referral\_to\_DC**                   | 7              |
| **Root\_and\_Link\_referral\_to\_DFSServer** | 11             |
| **Path\_Normalization\_to\_DFSServer**       | 2              |

The test cases are designed with below assumptions, and these terms will be used in test case description or test steps:

-   **Domain name**: contoso.com

-   **DFS Server name**: node01

-   **Domain-based namespace**: DomainBased

-   **Stand-alone namespace**: Standalone

-   **DFS Link path**: DFSLink

-   **DFS interlink**: \\node01\\SMBDfs\\SMBDfsShare (This is another DFS link)

**The following scenarios are out of scope in DFSC test suite:**

-   The necessity of maintaining and sorting the root/link targets in the test environment and the metadata at the DFS server side is abstracted out and these are handled by the lower layer protocols. This includes the Client Target Failback feature.

-   Scenarios with domains in trusted forests in relationship to the client’s domain.

-   DFS referral target caches.

    1.  <span id="_Toc394424134" class="anchor"><span id="_Toc394493248" class="anchor"><span id="_Toc398111934" class="anchor"><span id="_Toc419731546" class="anchor"><span id="_Toc419796174" class="anchor"><span id="_Toc419970349" class="anchor"><span id="_Toc420069685" class="anchor"><span id="_Toc420071836" class="anchor"><span id="_Toc420661962" class="anchor"><span id="_Toc420669163" class="anchor"><span id="_Toc420669781" class="anchor"><span id="_Toc427488212" class="anchor"></span></span></span></span></span></span></span></span></span></span></span></span>

        1.  ### Domain\_referral\_to\_DC

            1.  #### Scenario

|                               |                                                             |
|-------------------------------|-------------------------------------------------------------|
| **Description**               | Check if server handles domain referral requests correctly. |
| **Message Sequence**          | Client establishes SMB2 connection to server.               
                                                                                              
                                 Client sends domain referral request to server.              
                                                                                              
                                 Check server responses correctly.                            
                                                                                              
                                 Disconnect and logoff SMB2 connection.                       |
| **Cluster Involved Scenario** | NO                                                          |

#### Test Case

| **Test ID**              | BVT\_DomainReferralV3ToDC                                                                                                     |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a version 3 Domain referral request to DC and expects positive response                                          |
| **Prerequisites**        | Common prerequisites                                                                                                          |
| **Test Execution Steps** | 1. Client establishes a SMB connection between client and DC server.                                                          
                                                                                                                                                           
                            2. Client sends a Domain referral v3 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is empty, MaxReferralLevel is 3) to DC.  
                                                                                                                                                           
                            3. Client expects STATUS == STATUS\_SUCCESS and verify the accuracy of the response.                                           
                                                                                                                                                           
                            4. Disconnect and logoff.                                                                                                      |
| **Cleanup**              | N/A                                                                                                                           |

| **Test ID**              | DomainReferralV1ToDC                                                                                                          |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v1 Domain referral request to DC, and expects negative response                                                |
| **Prerequisites**        | Common prerequisites                                                                                                          |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                         
                                                                                                                                                           
                            2. Client sends a Domain referral v1 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is empty, MaxReferralLevel is 1) to DC.  
                                                                                                                                                           
                            3. Client expects STATUS == STATUS\_UNSUCCESSFUL.                                                                              
                                                                                                                                                           
                            4. Disconnect and logoff.                                                                                                      |
| **Cleanup**              | N/A                                                                                                                           |

| **Test ID**              | DomainReferralV2ToDC                                                                                                          |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client send a v2 Domain referral request to DC, and expects negative response                                                 |
| **Prerequisites**        | Common prerequisites                                                                                                          |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                         
                                                                                                                                                           
                            2. Client sends a Domain referral v2 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is empty, MaxReferralLevel is 2) to DC.  
                                                                                                                                                           
                            3. Client expects STATUS == STATUS\_UNSUCCESSFUL.                                                                              
                                                                                                                                                           
                            4. Disconnect and logoff.                                                                                                      |
| **Cleanup**              | N/A                                                                                                                           |

| **Test ID**              | DomainReferralV4EXSiteToDC                                                                                                                              |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v4 Domain referral request EX to DC, and expects positive response                                                                       |
| **Prerequisites**        | Common prerequisites                                                                                                                                    |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                   
                                                                                                                                                                                     
                            2. Client sends a Domain referral v4 REQ\_GET\_DFS\_REFERRAL\_EX message (RequestFileName is empty, MaxReferralLevel is 4, SiteName flag is set) to DC.  
                                                                                                                                                                                     
                            3. Client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v3.                                                           
                                                                                                                                                                                     
                            4. Verify the accuracy of the response.                                                                                                                  
                                                                                                                                                                                     
                            5. Disconnect and logoff.                                                                                                                                |
| **Cleanup**              | N/A                                                                                                                                                     |

| **Test ID**              | DomainReferralV4EXToDC                                                                                                                                      |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends v4 Domain referral request EX to DC and expects positive response                                                                              |
| **Prerequisites**        | Common prerequisites                                                                                                                                        |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                       
                                                                                                                                                                                         
                            2. Client sends a Domain referral v4 REQ\_GET\_DFS\_REFERRAL\_EX message (RequestFileName is empty, MaxReferralLevel is 4, SiteName flag is not set) to DC.  
                                                                                                                                                                                         
                            3. Client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v4.                                                               
                                                                                                                                                                                         
                            4. Verify the accuracy of the response.                                                                                                                      
                                                                                                                                                                                         
                            5. Disconnect and logoff.                                                                                                                                    |
| **Cleanup**              | N/A                                                                                                                                                         |

1.  ### DC\_referral\_to\_DC

    1.  #### Scenario

|                               |                                                        |
|-------------------------------|--------------------------------------------------------|
| **Description**               | Check if server handles DC referral request correctly. |
| **Message Sequence**          | Client establishes SMB2 connection to server.          
                                                                                         
                                 Client sends DC referral request to server.             
                                                                                         
                                 Check server responses correctly.                       
                                                                                         
                                 Disconnect and logoff SMB2 connection.                  |
| **Cluster Involved Scenario** | NO                                                     |

#### Test Case

| **Test ID**              | BVT\_DCReferralV3ToDC                                                                                                               |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a version 3 DC referral request with a valid domain name(FQDN) to DC and expects positive response                     |
| **Prerequisites**        | Common prerequisites                                                                                                                |
| **Test Execution Steps** | 1. Client establishes a SMB connection between client and DC server.                                                                
                                                                                                                                                                 
                            2. Client sends a DC referral v3 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com”, MaxReferralLevel is 3) to DC.  
                                                                                                                                                                 
                            3. Client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v3.                                       
                                                                                                                                                                 
                            4. Verify the name format is FQDN in response.                                                                                       
                                                                                                                                                                 
                            5. Verify the response contains all DCs in the domain.                                                                               
                                                                                                                                                                 
                            6. Disconnect and logoff.                                                                                                            |
| **Cleanup**              | N/A                                                                                                                                 |

| **Test ID**              | DCReferralV1ToDC                                                                                                                    |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v1 DC referral request to DC and expects negative response                                                           |
| **Prerequisites**        | Common prerequisites                                                                                                                |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                               
                                                                                                                                                                 
                            2. Client sends a DC referral v1 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com”, MaxReferralLevel is 1) to DC.  
                                                                                                                                                                 
                            3. Client expects STATUS == STATUS\_UNSUCCESSFUL.                                                                                    
                                                                                                                                                                 
                            4. Disconnect and logoff.                                                                                                            |
| **Cleanup**              | N/A                                                                                                                                 |

| **Test ID**              | DCReferralV2ToDC                                                                                                                    |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v2 DC referral request to DC and expects negative response                                                           |
| **Prerequisites**        | Common prerequisites                                                                                                                |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                               
                                                                                                                                                                 
                            2. Client sends a DC referral v2 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com”, MaxReferralLevel is 2) to DC.  
                                                                                                                                                                 
                            3. Client expects STATUS == STATUS\_UNSUCCESSFUL                                                                                     
                                                                                                                                                                 
                            4. Disconnect and logoff.                                                                                                            |
| **Cleanup**              | N/A                                                                                                                                 |

| **Test ID**              | DCReferralV4EXNetbiosToDC                                                                                                                                     |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v4 DC referral request EX with a valid domain name(NETBIOS) to DC and expects positive response                                                |
| **Prerequisites**        | Common prerequisites                                                                                                                                          |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                         
                                                                                                                                                                                           
                            2. Client sends a DC referral v4 REQ\_GET\_DFS\_REFERRAL\_EX message (RequestFileName is “\\contoso”, MaxReferralLevel is 4, SiteName flag is not set) to DC.  
                                                                                                                                                                                           
                            3. Client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v3.                                                                 
                                                                                                                                                                                           
                            4. Verify the name format is NETBIOS in response.                                                                                                              
                                                                                                                                                                                           
                            5. Verify the response contains all DCs in the domain.                                                                                                         
                                                                                                                                                                                           
                            6. Disconnect and logoff.                                                                                                                                      |
| **Cleanup**              | N/A                                                                                                                                                           |

| **Test ID**              | DCReferralV4EXSiteToDC                                                                                                                                    |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v4 DC referral request EX with a site name to DC and expects positive response.                                                            |
| **Prerequisites**        | Common prerequisites                                                                                                                                      |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                     
                                                                                                                                                                                       
                            2. Client sends a DC referral v4 REQ\_GET\_DFS\_REFERRAL\_EX message (RequestFileName is “\\contoso”, MaxReferralLevel is 4, SiteName flag is set) to DC.  
                                                                                                                                                                                       
                            3. Client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v3.                                                             
                                                                                                                                                                                       
                            4. Verify the response.                                                                                                                                    
                                                                                                                                                                                       
                            5. Disconnect and logoff.                                                                                                                                  |
| **Cleanup**              | N/A                                                                                                                                                       |

| **Test ID**              | InvalidDCReferralToDC                                                                                                           |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v4 DC referral request with an invalid domain name(NETBIOS) to DC and expects negative response                  |
| **Prerequisites**        | Common prerequisites                                                                                                            |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                           
                                                                                                                                                             
                            2. Client sends a DC referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\Invalid”, MaxReferralLevel is 4) to DC.  
                                                                                                                                                             
                            3. Client expects STATUS == STATUS\_INVALID\_PARAMETER.                                                                          
                                                                                                                                                             
                            4. Disconnect and logoff.                                                                                                        |
| **Cleanup**              | N/A                                                                                                                             |

1.  ### Sysvol\_referral\_to\_DC

    1.  #### Scenario

|                               |                                                   |
|-------------------------------|---------------------------------------------------|
| **Description**               | Check if server handles Sysvol request correctly. |
| **Message Sequence**          | Client establishes SMB2 connection to server.     
                                                                                    
                                 Client sends Sysvol referral request to server.    
                                                                                    
                                 Check server responses correctly.                  
                                                                                    
                                 Disconnect and logoff SMB2 connection.             |
| **Cluster Involved Scenario** | NO                                                |

#### Test Case

| **Test ID**              | BVT\_SysvolReferralV3ToDCNetlogonPath                                                                                                         |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a version 3 sysvol referral request with NETLOGON directory to DC, and expects positive response                                 |
| **Prerequisites**        | Common prerequisites                                                                                                                          |
| **Test Execution Steps** | 1. Client establishes a SMB connection between client and DC server.                                                                          
                                                                                                                                                                           
                            2. Client sends a Sysvol referral v3 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso\\NETLOGON”, MaxReferralLevel is 3) to DC.  
                                                                                                                                                                           
                            3. Client expects STATUS == STATUS\_SUCCESS and verifies the accuracy of the response.                                                         
                                                                                                                                                                           
                            4. Disconnect and logoff.                                                                                                                      |
| **Cleanup**              | N/A                                                                                                                                           |

| **Test ID**              | BVT\_SysvolReferralV4ToDCSysvolPath                                                                                                                   |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v4 Sysvol referral request with SYSVOL directory to DC, and expects positive response                                                  |
| **Prerequisites**        | Common prerequisites                                                                                                                                  |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                 
                                                                                                                                                                                   
                            2. Client sends a Sysvol referral v4 REQ\_GET\_DFS\_REFERRAL\_EX message (RequestFileName is “\\contoso.com\\NETLOGON”, MaxReferralLevel is 4) to DC.  
                                                                                                                                                                                   
                            3. Client expects STATUS == STATUS\_SUCCESS and verify the accuracy of the response.                                                                   
                                                                                                                                                                                   
                            4. Disconnect and logoff.                                                                                                                              |
| **Cleanup**              | N/A                                                                                                                                                   |

| **Test ID**              | InvalidSysvolReferralToDC                                                                                                                   |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v1 Sysvol referral request with invalid Domain name to DC and expects negative response                                      |
| **Prerequisites**        | Common prerequisites                                                                                                                        |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                       
                                                                                                                                                                         
                            2. Client sends a Sysvol referral v1 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\Invalid\\SYSVOL”, MaxReferralLevel is 1) to DC.  
                                                                                                                                                                         
                            3. Client expects STATUS == STATUS\_NOT\_FOUND.                                                                                              
                                                                                                                                                                         
                            4. Disconnect and logoff.                                                                                                                    |
| **Cleanup**              | N/A                                                                                                                                         |

| **Test ID**              | SysvolReferralV1EXSiteToDCSysvolPath                                                                                                                                      |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v1 Sysvol referral request(EX) with SYSVOL directory to DC and expects positive response                                                                   |
| **Prerequisites**        | Common prerequisites                                                                                                                                                      |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                                     
                                                                                                                                                                                                       
                            2. Client sends a Sysvol referral v1 REQ\_GET\_DFS\_REFERRAL\_EX message (RequestFileName is “\\contoso.com\\SYSVOL”, MaxReferralLevel is 1, SiteName flag is set) to DC.  
                                                                                                                                                                                                       
                            3. Client expects STATUS == STATUS\_SUCCESS and verify the response.                                                                                                       
                                                                                                                                                                                                       
                            4. Disconnect and logoff.                                                                                                                                                  |
| **Cleanup**              | N/A                                                                                                                                                                       |

| **Test ID**              | SysvolReferralV1ToDCSysvolPath                                                                                                                  |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends v1 Sysvol referral request with SYSVOL directory to DC and expects positive response                                               |
| **Prerequisites**        | Common prerequisites                                                                                                                            |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                           
                                                                                                                                                                             
                            2. Client sends a Sysvol referral v1 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\SYSVOL”, MaxReferralLevel is 1) to DC.  
                                                                                                                                                                             
                            3. Client expects STATUS == STATUS\_SUCCESS and verify the response.                                                                             
                                                                                                                                                                             
                            4. Disconnect and logoff.                                                                                                                        |
| **Cleanup**              | N/A                                                                                                                                             |

| **Test ID**              | SysvolReferralV2ToDCNetlogonPath                                                                                                                  |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v2 Sysvol referral request with NETLOGON path to DC and expects positive response                                                  |
| **Prerequisites**        | Common prerequisites                                                                                                                              |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                             
                                                                                                                                                                               
                            2. Client sends a Sysvol referral v2 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\NETLOGON”, MaxReferralLevel is 2) to DC.  
                                                                                                                                                                               
                            3. Client expects STATUS == STATUS\_SUCCESS and verify the response.                                                                               
                                                                                                                                                                               
                            4. Disconnect and logoff.                                                                                                                          |
| **Cleanup**              | N/A                                                                                                                                               |

| **Test ID**              | SysvolReferralV2EXToDCNetlogonPath                                                                                                                                            |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v2 Sysvol referral request(EX) with NETLOGON directory to DC and expects positive response                                                                     |
| **Prerequisites**        | Common prerequisites                                                                                                                                                          |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                                         
                                                                                                                                                                                                           
                            2. Client sends a Sysvol referral v2 REQ\_GET\_DFS\_REFERRAL\_EX message (RequestFileName is “\\contoso.com\\SYSVOL”, MaxReferralLevel is 1, SiteName flag is not set) to DC.  
                                                                                                                                                                                                           
                            3. Client expects STATUS == STATUS\_SUCCESS and verify the response.                                                                                                           
                                                                                                                                                                                                           
                            4. Disconnect and logoff.                                                                                                                                                      |
| **Cleanup**              | N/A                                                                                                                                                                           |

1.  ### Root\_referral\_to\_DC

    1.  #### Scenario

|                               |                                                          |
|-------------------------------|----------------------------------------------------------|
| **Description**               | Check if server handles Root referral request correctly. |
| **Message Sequence**          | Client establishes SMB2 connection to server.            
                                                                                           
                                 Client sends Root referral request to server.             
                                                                                           
                                 Check server responses correctly.                         
                                                                                           
                                 Disconnect and logoff SMB2 connection.                    |
| **Cluster Involved Scenario** | NO                                                       |

#### Test Case

| **Test ID**              | BVT\_RootReferralV4ToDC                                                                                                                     |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v4 Root referral request to DC, and expects positive response                                                                |
| **Prerequisites**        | Common prerequisites                                                                                                                        |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                       
                                                                                                                                                                         
                            2. Client sends a Root referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\Root”, MaxReferralLevel is 4) to DC.  
                                                                                                                                                                         
                            3. Client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v4.                                               
                                                                                                                                                                         
                            4. Verify the response.                                                                                                                      
                                                                                                                                                                         
                            5. Disconnect and logoff.                                                                                                                    |
| **Cleanup**              | N/A                                                                                                                                         |

| **Test ID**              | RootReferralV1ToDC                                                                                                                                 |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v1 Root referral request to DC and expects positive response                                                                        |
| **Prerequisites**        | Common prerequisites                                                                                                                               |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                              
                                                                                                                                                                                
                            2. Client sends a Root referral v1 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\DomainBased”, MaxReferralLevel is 1) to DC.  
                                                                                                                                                                                
                            3. Client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v1.                                                      
                                                                                                                                                                                
                            4. Verify the response.                                                                                                                             
                                                                                                                                                                                
                            5. Disconnect and logoff.                                                                                                                           |
| **Cleanup**              | N/A                                                                                                                                                |

| **Test ID**              | RootReferralV2EXToDC                                                                                                                                                             |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v2 Root referral request to DC and expects positive response                                                                                                      |
| **Prerequisites**        | Common prerequisites                                                                                                                                                             |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                                            
                                                                                                                                                                                                              
                            2. Client sends a Root referral v2 REQ\_GET\_DFS\_REFERRAL\_EX message (RequestFileName is “\\contoso.com\\DomainBased”, MaxReferralLevel is 2, SiteName Flag is not set) to DC.  
                                                                                                                                                                                                              
                            3. Client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v2.                                                                                    
                                                                                                                                                                                                              
                            4. Verify the response.                                                                                                                                                           
                                                                                                                                                                                                              
                            5. Disconnect and logoff.                                                                                                                                                         |
| **Cleanup**              | N/A                                                                                                                                                                              |

| **Test ID**              | RootReferralV3EXSiteToDC                                                                                                                                                     |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v3 Root referral request to DC and expects positive response                                                                                                  |
| **Prerequisites**        | Common prerequisites                                                                                                                                                         |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                                        
                                                                                                                                                                                                          
                            2. Client sends a Root referral v3 REQ\_GET\_DFS\_REFERRAL\_EX message (RequestFileName is “\\contoso.com\\DomainBased”, MaxReferralLevel is 3, SiteName flag is set) to DC.  
                                                                                                                                                                                                          
                            3. Client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v3.                                                                                
                                                                                                                                                                                                          
                            4. Verify the response.                                                                                                                                                       
                                                                                                                                                                                                          
                            5. Disconnect and logoff.                                                                                                                                                     |
| **Cleanup**              | N/A                                                                                                                                                                          |

| **Test ID**              | InvalidRootReferralToDC                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends an invalid v4 Root referral request to DC and expects negative response                                                           |
| **Prerequisites**        | Common prerequisites                                                                                                                           |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                          
                                                                                                                                                                            
                            2. Client sends a Root referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\Invalid”, MaxReferralLevel is 4) to DC.  
                                                                                                                                                                            
                            3. Client expects STATUS == STATUS\_NO\_SUCH\_FILE.                                                                                             
                                                                                                                                                                            
                            4. Disconnect and logoff.                                                                                                                       |
| **Cleanup**              | N/A                                                                                                                                            |

1.  ### Link\_referral\_to\_DC

    1.  #### Scenario

|                               |                                                          |
|-------------------------------|----------------------------------------------------------|
| **Description**               | Check if server handles Link referral request correctly. |
| **Message Sequence**          | Client establishes SMB2 connection to server.            
                                                                                           
                                 Client sends Link referral request to server.             
                                                                                           
                                 Check server responses correctly.                         
                                                                                           
                                 Disconnect and logoff SMB2 connection.                    |
| **Cluster Involved Scenario** | NO                                                       |

#### Test Case

| **Test ID**              | LinkReferralV4ToDC                                                                                                                                                                     |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v4 Link referral request to DC, and expects positive response or STATUS\_NOT\_FOUND depends on if the DC is hosting DFS server.                                         |
| **Prerequisites**        | Common prerequisites                                                                                                                                                                   |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                                                  
                                                                                                                                                                                                                    
                            2. Client sends a Link referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\DomainBased\\DFSLink”, MaxReferralLevel is 4) to DC.                             
                                                                                                                                                                                                                    
                            3. If DC is hosting DFS server, then client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v4. Otherwise, client expects STATUS\_NOT\_FOUND from DC.  
                                                                                                                                                                                                                    
                            4. Verify the response if any.                                                                                                                                                          
                                                                                                                                                                                                                    
                            5. Disconnect and logoff.                                                                                                                                                               |
| **Cleanup**              | N/A                                                                                                                                                                                    |

| **Test ID**              | LinkReferralV1ToDC                                                                                                                                                                     |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v1 Link referral request to DC, and expects positive response or STATUS\_NOT\_FOUND depends on if the DC is hosting DFS server.                                         |
| **Prerequisites**        | Common prerequisites                                                                                                                                                                   |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                                                  
                                                                                                                                                                                                                    
                            2. Client sends a Link referral v1 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\DomainBased\\DFSLink”, MaxReferralLevel is 1) to DC.                             
                                                                                                                                                                                                                    
                            3. If DC is hosting DFS server, then client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v1. Otherwise, client expects STATUS\_NOT\_FOUND from DC.  
                                                                                                                                                                                                                    
                            4. Verify the response.                                                                                                                                                                 
                                                                                                                                                                                                                    
                            5. Disconnect and logoff.                                                                                                                                                               |
| **Cleanup**              | N/A                                                                                                                                                                                    |

| **Test ID**              | LinkReferralV2EXToDC                                                                                                                                                                      |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v2 Link referral request to DC, and expects positive response or STATUS\_NOT\_FOUND depends on if the DC is hosting DFS server.                                            |
| **Prerequisites**        | Common prerequisites                                                                                                                                                                      |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                                                     
                                                                                                                                                                                                                       
                            2. Client sends a Link referral v2 REQ\_GET\_DFS\_REFERRAL\_EX message (RequestFileName is “\\contoso.com\\DomainBased\\DFSLink”, MaxReferralLevel is 2, SiteName flag is not set) to DC.  
                                                                                                                                                                                                                       
                            3. If DC is hosting DFS server, then client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v2. Otherwise, client expects STATUS\_NOT\_FOUND from DC.     
                                                                                                                                                                                                                       
                            4. Verify the response.                                                                                                                                                                    
                                                                                                                                                                                                                       
                            5. Disconnect and logoff.                                                                                                                                                                  |
| **Cleanup**              | N/A                                                                                                                                                                                       |

| **Test ID**              | LinkReferralV3EXSiteToDC                                                                                                                                                               |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v3 Link referral request to DC, and expects positive response or STATUS\_NOT\_FOUND depends on if the DC is hosting DFS server.                                         |
| **Prerequisites**        | Common prerequisites                                                                                                                                                                   |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                                                  
                                                                                                                                                                                                                    
                            2. Client sends a Link referral v3 REQ\_GET\_DFS\_REFERRAL\_EX message (RequestFileName is “\\contoso.com\\DomainBased\\DFSLink”, MaxReferralLevel is 3, SiteName flag is set) to DC.   
                                                                                                                                                                                                                    
                            3. If DC is hosting DFS server, then client expects STATUS == STATUS\_SUCCESS and RESP GET\_DFS\_REFERRAL message version is v3. Otherwise, client expects STATUS\_NOT\_FOUND from DC.  
                                                                                                                                                                                                                    
                            4. Verify the response.                                                                                                                                                                 
                                                                                                                                                                                                                    
                            5. Disconnect and logoff.                                                                                                                                                               |
| **Cleanup**              | N/A                                                                                                                                                                                    |

| **Test ID**              | InvalidDomainNameLinkReferralToDC                                                                                                                                                |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v2 Link referral request with invalid Domain name to DC, expect negative response                                                                                 |
| **Prerequisites**        | Common prerequisites                                                                                                                                                             |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                                            
                                                                                                                                                                                                              
                            2. Client sends a Link referral v2 REQ\_GET\_DFS\_REFERRAL message with invalid domain name (RequestFileName is “\\Invalid\\DomainBased\\DFSLink”, MaxReferralLevel is 2) to DC.  
                                                                                                                                                                                                              
                            3. Client expects STATUS == STATUS\_NOT\_FOUND.                                                                                                                                   
                                                                                                                                                                                                              
                            4. Disconnect and logoff.                                                                                                                                                         |
| **Cleanup**              | N/A                                                                                                                                                                              |

| **Test ID**              | InvalidLinkNameLinkReferralToDC                                                                                                                             |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v3 Link referral request with invalid link name to DC, expect negative response                                                              |
| **Prerequisites**        | Common prerequisites                                                                                                                                        |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                       
                                                                                                                                                                                         
                            2. Client sends a Link referral v3 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\DomainBased\\Invalid”, MaxReferralLevel is 3) to DC.  
                                                                                                                                                                                         
                            3. Client expects STATUS == STATUS\_NOT\_FOUND.                                                                                                              
                                                                                                                                                                                         
                            4. Disconnect and logoff.                                                                                                                                    |
| **Cleanup**              | N/A                                                                                                                                                         |

| **Test ID**              | InvalidNamespaceLinkReferralToDC                                                                                                                        |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v4 Link referral request to DC with invalid namespace, expect negative response                                                          |
| **Prerequisites**        | Common prerequisites                                                                                                                                    |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DC server.                                                                                   
                                                                                                                                                                                     
                            2. Client sends a Link referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\Invalid\\DFSLink”, MaxReferralLevel is 4) to DC.  
                                                                                                                                                                                     
                            3. Client expects STATUS == STATUS\_NOT\_FOUND.                                                                                                          
                                                                                                                                                                                     
                            4. Disconnect and logoff.                                                                                                                                |
| **Cleanup**              | N/A                                                                                                                                                     |

1.  ### Root\_and\_Link\_referral\_to\_DFSServer

    1.  #### Scenario

|                               |                                                                   |
|-------------------------------|-------------------------------------------------------------------|
| **Description**               | Check if server handles root and link referral request correctly. |
| **Message Sequence**          | Client establishes SMB2 connection to server.                     
                                                                                                    
                                 Client sends root and link referral request to server.             
                                                                                                    
                                 Check server responses correctly.                                  
                                                                                                    
                                 Disconnect and logoff SMB2 connection.                             |
| **Cluster Involved Scenario** | NO                                                                |

#### Test Case

| **Test ID**              | BVT\_RootAndLinkReferralStandaloneV4ToDFSServer                                                                                                               |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a DFS root referral request v4 to DFS Server first, and then link referral request v4.                                                           |
| **Prerequisites**        | Common prerequisites                                                                                                                                          |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                                                        
                                                                                                                                                                                           
                            2. Client sends a Root referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\node01\\Standalone\\”, MaxReferralLevel is 4) to DFS server.         
                                                                                                                                                                                           
                            5. Client expects STATUS = STATUS\_SUCCESS and returns the same path.                                                                                          
                                                                                                                                                                                           
                            6. Client sends a Link referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\node01\\Standalone\\DFSLink”, MaxReferralLevel is 4) to DFS server.  
                                                                                                                                                                                           
                            7. Client expects STATUS == STATUS\_SUCCESS and verifies response.                                                                                             
                                                                                                                                                                                           
                            4. Disconnect and logoff.                                                                                                                                      |
| **Cleanup**              | N/A                                                                                                                                                           |

| **Test ID**              | BVT\_RootAndLinkReferralDomainV4ToDFSServer                                                                                                                    |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a DFS root referral request v4 to DFS Server first, and then link referral request v4.                                                            |
| **Prerequisites**        | Common prerequisites                                                                                                                                           |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                                                         
                                                                                                                                                                                            
                            2. Client sends a Root referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\DomainBased\\”, MaxReferralLevel is 4) to DFS server.    
                                                                                                                                                                                            
                            5. Client expects STATUS = STATUS\_SUCCESS and returns the same path.                                                                                           
                                                                                                                                                                                            
                            6. Client sends a Link referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\node01\\DomainBased\\DFSLink”, MaxReferralLevel is 4) to DFS server.  
                                                                                                                                                                                            
                            7. Client expects STATUS == STATUS\_SUCCESS and verifies response.                                                                                              
                                                                                                                                                                                            
                            4. Disconnect and logoff.                                                                                                                                       |
| **Cleanup**              | N/A                                                                                                                                                            |

| **Test ID**              | RootAndLinkReferralStandaloneV2ToDFSServer                                                                                                                    |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a DFS root referral request v2 to DFS Server first, and then link referral request v2.                                                           |
| **Prerequisites**        | Common prerequisites                                                                                                                                          |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                                                        
                                                                                                                                                                                           
                            2. Client sends a Root referral v2 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\node01\\Standalone\\”, MaxReferralLevel is 2) to DFS server.         
                                                                                                                                                                                           
                            5. Client expects STATUS = STATUS\_SUCCESS and returns the same path.                                                                                          
                                                                                                                                                                                           
                            6. Client sends a Link referral v2 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\node01\\Standalone\\DFSLink”, MaxReferralLevel is 2) to DFS server.  
                                                                                                                                                                                           
                            7. Client expects STATUS == STATUS\_SUCCESS and verifies the response.                                                                                         
                                                                                                                                                                                           
                            4. Disconnect and logoff.                                                                                                                                      |
| **Cleanup**              | N/A                                                                                                                                                           |

| **Test ID**              | RootAndLinkReferralEXStandaloneV1ToDFSServer                                                                                                                  |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a DFS root referral request v1 first, and then link referral request v1.                                                                         |
| **Prerequisites**        | Common prerequisites                                                                                                                                          |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                                                        
                                                                                                                                                                                           
                            2. Client sends a Root referral v1 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\node01\\Standalone\\”, MaxReferralLevel is 1) to DFS server.         
                                                                                                                                                                                           
                            5. Client expects STATUS = STATUS\_SUCCESS and returns the same path.                                                                                          
                                                                                                                                                                                           
                            6. Client sends a Link referral v1 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\node01\\Standalone\\DFSLink”, MaxReferralLevel is 1) to DFS server.  
                                                                                                                                                                                           
                            7. Client expects STATUS == STATUS\_SUCCESS and verifies the response.                                                                                         
                                                                                                                                                                                           
                            4. Disconnect and logoff.                                                                                                                                      |
| **Cleanup**              | N/A                                                                                                                                                           |

| **Test ID**              | LinkReferralStandaloneToDFSServerReturnRootTarget                                                                                                             |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a DFS link referral request v3 to DFS Server first and expects root target returned.                                                             |
| **Prerequisites**        | Common prerequisites                                                                                                                                          |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                                                        
                                                                                                                                                                                           
                            2. Client sends a Link referral v3 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\node01\\Standalone\\Invalid”, MaxReferralLevel is 3) to DFS server.  
                                                                                                                                                                                           
                            3. Client expects STATUS == STATUS\_SUCCESS and returns the root target (\\node01\\Standalone).                                                                
                                                                                                                                                                                           
                            4. Disconnect and logoff.                                                                                                                                      |
| **Cleanup**              | N/A                                                                                                                                                           |

| **Test ID**              | LinkReferralStandaloneToDFSServerReturnInterlink                                                                                                                |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a DFS link referral request v4 and expects interlink returned.                                                                                     |
| **Prerequisites**        | Common prerequisites                                                                                                                                            |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                                                          
                                                                                                                                                                                             
                            2. Client sends a Link referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\node01\\Standalone\\Interlink”, MaxReferralLevel is 4) to DFS server.  
                                                                                                                                                                                             
                            3. Client expects STATUS == STATUS\_SUCCESS and returns interlink (\\node01\\SMBDfs\\SMBDfsShare).                                                               
                                                                                                                                                                                             
                            4. Disconnect and logoff.                                                                                                                                        |
| **Cleanup**              | N/A                                                                                                                                                             |

| **Test ID**              | LinkReferralDomainV1ToDFSServer                                                                                                                                     |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a DFS link referral request v1 to DFS Server and expects positive response.                                                                            |
| **Prerequisites**        | Common prerequisites                                                                                                                                                |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                                                              
                                                                                                                                                                                                 
                            2. Client sends a Link referral v1 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\DomainBased\\DFSlink”, MaxReferralLevel is 1) to DFS server.  
                                                                                                                                                                                                 
                            3. Client expects STATUS == STATUS\_SUCCESS and verifies response.                                                                                                   
                                                                                                                                                                                                 
                            4. Disconnect and logoff.                                                                                                                                            |
| **Cleanup**              | N/A                                                                                                                                                                 |

| **Test ID**              | LinkReferralDomainToDFSServerReturnRootTarget                                                                                                                       |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a DFS link referral request v4 and expects root target returned.                                                                                       |
| **Prerequisites**        | Common prerequisites                                                                                                                                                |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                                                              
                                                                                                                                                                                                 
                            2. Client sends a Link referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\DomainBased\\Invalid”, MaxReferralLevel is 1) to DFS server.  
                                                                                                                                                                                                 
                            3. Client expects STATUS == STATUS\_SUCCESS and verifies returned root target.                                                                                       
                                                                                                                                                                                                 
                            4. Disconnect and logoff.                                                                                                                                            |
| **Cleanup**              | N/A                                                                                                                                                                 |

| **Test ID**              | LinkReferralDomainToDFSServerReturnInterlink                                                                                                                          |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a DFS link referral request v4 to DFS Server and expects interlink returned.                                                                             |
| **Prerequisites**        | Common prerequisites                                                                                                                                                  |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                                                                
                                                                                                                                                                                                   
                            2. Client sends a Link referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\DomainBased\\Interlink”, MaxReferralLevel is 4) to DFS server.  
                                                                                                                                                                                                   
                            3. Client expects STATUS == STATUS\_SUCCESS and returns interlink (\\node01\\SMBDfs\\SMBDfsShare).                                                                     
                                                                                                                                                                                                   
                            4. Disconnect and logoff.                                                                                                                                              |
| **Cleanup**              | N/A                                                                                                                                                                   |

| **Test ID**              | InvalidRootReferralStandaloneToDFSServer                                                                                                          |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v4 invalid Root referral request to DFS server and expects negative response                                                       |
| **Prerequisites**        | Common prerequisites                                                                                                                              |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                                            
                                                                                                                                                                               
                            2. Client sends a Root referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\node01\\Invalid”, MaxReferralLevel is 4) to DFS server.  
                                                                                                                                                                               
                            3. Client expects STATUS == STATUS\_NOT\_FOUND.                                                                                                    
                                                                                                                                                                               
                            4. Disconnect and logoff.                                                                                                                          |
| **Cleanup**              | N/A                                                                                                                                               |

| **Test ID**              | InvalidRootReferralDomainToDFSServer                                                                                                                   |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends a v4 invalid Root referral request to DFS server and expects negative response                                                            |
| **Prerequisites**        | Common prerequisites                                                                                                                                   |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                                                 
                                                                                                                                                                                    
                            2. Client sends a Root referral v4 REQ\_GET\_DFS\_REFERRAL message (RequestFileName is “\\contoso.com\\Invalid”, MaxReferralLevel is 4) to DFS server.  
                                                                                                                                                                                    
                            3. Client expects STATUS == STATUS\_NOT\_FOUND for non-windows platform and STATUS\_DFS\_UNAVAILABLE for windows platform.                              
                                                                                                                                                                                    
                            4. Disconnect and logoff.                                                                                                                               |
| **Cleanup**              | N/A                                                                                                                                                    |

1.  ### Path\_Normalization\_to\_DFSServer

    1.  #### Scenario

|                               |                                                               |
|-------------------------------|---------------------------------------------------------------|
| **Description**               | Check if server handles path normalization request correctly. |
| **Message Sequence**          | Client establishes SMB2 connection to server.                 
                                                                                                
                                 Client sends path normalization request to server.             
                                                                                                
                                 Check server responses correctly.                              
                                                                                                
                                 Disconnect and logoff SMB2 connection.                         |
| **Cluster Involved Scenario** | NO                                                            |

#### Test Case

| **Test ID**              | NormalizePathWithDFSLink                                                                                                    |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends SMB2 create request to open a file in a DFS path with DFS Link, verify if server normalize the path correctly. |
| **Prerequisites**        | Common prerequisites                                                                                                        |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                      
                                                                                                                                                         
                            2. Client sends a SMB2 CREATE message with DFS path containing DFSLink to DFS server.                                        
                                                                                                                                                         
                            3. Client expects STATUS = STATUS\_PATH\_NOT\_COVERED.                                                                       
                                                                                                                                                         
                            4. Disconnect and logoff.                                                                                                    |
| **Cleanup**              | N/A                                                                                                                         |

| **Test ID**              | NormalizePathWithoutDFSlink                                                                                                    |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------|
| **Description **         | Client sends SMB2 create request to open a file in a DFS path without DFS Link, verify if server normalize the path correctly. |
| **Prerequisites**        | Common prerequisites                                                                                                           |
| **Test Execution Steps** | 1. Client establishes an SMB connection between client and DFS server.                                                         
                                                                                                                                                            
                            2. Client sends a SMB2 CREATE with DFS path but not containing DFSLink to DFS server.                                           
                                                                                                                                                            
                            3. Client expects STATUS = STATUS\_SUCCESS.                                                                                     
                                                                                                                                                            
                            4. Disconnect and logoff.                                                                                                       |
| **Cleanup**              | N/A                                                                                                                            |
