| Kerberos                                                 
                                                           
 Test Suite Design Specification                           |
|----------------------------------------------------------|
| *Windows is built to be the most interoperable platform* |
| ![](./media/image1.png)                                  |

**
**

1.  Test Environment
    ================

    1.  KILE PAC Environment
        --------------------

1. DNS Server

2. Active Directory

3. Use IPv4 by default

4. All full DC, need RODC for P2 cases

KKDCP Environment
-----------------

1. Web Server (IIS)

2. KDC Proxy Server service (KPSSVC)

1.  Security Context Parameters
    ---------------------------

    1.  ### Client – \[MS-KILE\] section 3.2.1

        1.  #### GSS API Parameters

ChannelBinding

Confidentiality

DatagramStyle

DCE Style

Delegate

ExtendedError

Identify

Integrity

MessageBlockSize

MutualAuthentication

ReplayDetect

SequenceDetect

UseSessionKey

1.  ### KDC – \[MS-KILE\] section 3.3.1

    1.  #### Group Policy

Minimum lifetime

MaxClockSkew

MaxServiceTicketAge

MaxTicketAge

AuthenticationOptions

#### Registry Key

ClaimsCompIdFASTSupport

#### AD context

NetbiosServerName

NetbiosDomainName

DomainSid

Secret keys

KerbSupportedEncryptionTypes

AuthorizationDataNotRequired

AssignedPolicy

AssignedSilo

DelegationNotAllowed

Disabled

Expired

GroupMembership

Locked

LogonHours

PasswordMustChange

Pre-AuthenticationNotRequired

TrustedForDelegation

UseDESOnly

1.  ### Application Server – \[MS-KILE\] section 3.4.1

    1.  #### GSS API Parameters

<span id="OLE_LINK1" class="anchor"><span id="OLE_LINK2" class="anchor"></span></span>ChannelBinding

Confidentiality

DatagramStyle

DCE Style

Delegate

ExtendedError

Identify

Integrity

MessageBlockSize

MutualAuthentication

ReplayDetect

SequenceDetect

UseSessionKey

ApplicationRequiresCBT

ImpersonationAccessToken (public)

#### AD context

msDS-SupportedEncryptionTypes

1.  ### KKDCP – \[MS-KKDCP\] section 3.1.1

    1.  #### GSS API Parameters

KKDCPServerURL

KerberosMessage

Error

TargetDomain

Assumptions
-----------

One machine has only one KDC installed. (RFC4120, port 88)

Set all krbtgt account with the same password in the same domain. (\[MS-KILE\] section 3.3.3) + (\[RFC4120\] section 6.2)

Use timeout mechanism to fail AS\_REQ and TGS\_REQ. (\[MS-KILE\] section 3.2.6)

Test Scenarios Design
=====================

| Scenarios                                                                                       | Protocol                          | Test Cases | Description                                                                                                                                 |
|-------------------------------------------------------------------------------------------------|-----------------------------------|------------|---------------------------------------------------------------------------------------------------------------------------------------------|
| Interactive Logon Test – Basic                                                                  | RFC4120\\MS-KILE                  |            | A user log on to a client                                                                                                                   |
| Interactive Logon Test – FAST                                                                   | RFC4120\\RFC6113                  |            | A user log on to a client using FAST authentication                                                                                         |
| Network Logon Test – File Server Basic                                                          | RFC4120\\MS-KILE\\MS-PAC          |            | A user access a file server and invoke Kerberos-based authentication                                                                        |
| Network Logon Test – File Server Compound Identity                                              | RFC4120\\RFC6113\\MS-KILE\\MS-PAC |            | A user access a file server and invoke Compound Identity authentication                                                                     |
| Network Logon Test – File Server Claims                                                         | RFC4120\\RFC6113\\MS-KILE\\MS-PAC |            | A user access a file server and requires claims authorization data                                                                          |
| Network Logon Test – Web Server Basic                                                           | RFC4120\\MS-KILE\\MS-PAC          |            | A user access a web server and invoke Kerberos-based authentication                                                                         |
| Cross Forest Network Logon Test – File Server Basic                                             | RFC4120\\MS-KILE\\MS-PAC          |            | A user access a file server registered in another domain and invoke Kerberos-based authentication                                           |
| Cross Forest Network Logon Test – File Server Compound Identity with claims                     | RFC4120\\RFC6113\\MS-KILE\\MS-PAC |            | A user access a file server registered in another domain and invoke compound identity authentication and requires claims authorization data |
| MIT KDC interests – Cross Forest Network Logon Test – File Server Compound Identity with claims | RFC4120\\RFC6113\\MS-KILE\\MS-PAC |            | A user access a cross realm file server and invoke Kerberos-based authentication, SPN translation, authorization data understanding         |
| KRB\_ERROR Test                                                                                 | RFC4120\\RFC6113                  |            | Test different types of KRB\_ERROR                                                                                                          |
| KKDCP Test                                                                                      | RFC4120\\MS-KKDCP\\RFC3244        |            | A user uses KKDCP server to relay the Kerberos V5 and Kerberos change password messages between client and KDC                              |

1.  <span id="_Toc427329206" class="anchor"><span id="_Toc325720219" class="anchor"></span></span>Single Domain: Interactive Logon Test
    -----------------------------------------------------------------------------------------------------------------------------------

    1.  ### Basic

|                   |                                                              |
|-------------------|--------------------------------------------------------------|
| **Description**   | A user logs on a domain-joined local host using a basic KDC. |
| **Call Sequence** | AS Request for user (no pre-authentication)                  
                                                                                   
                     KRB Error (PA-ENC-TIMESTAMP)                                  
                                                                                   
                     AS Request for user                                           
                                                                                   
                     AS Response                                                   
                                                                                   
                     TGS Request                                                   
                                                                                   
                     TGS Response                                                  |

### FAST

|                   |                                                                        |
|-------------------|------------------------------------------------------------------------|
| **Description**   | A user logs on the domain-joined local host using a FAST supported KDC |
| **Call Sequence** | AS Request for device (no pre-authentication)                          
                                                                                             
                     KRB Error (PA-FX-FAST)                                                  
                                                                                             
                     AS Request for device                                                   
                                                                                             
                     AS Response                                                             
                                                                                             
                     FAST AS Request for user (no pre-authentication)                        
                                                                                             
                     KRB Error (PA-FX-FAST)                                                  
                                                                                             
                     FAST AS Request for user                                                
                                                                                             
                     FAST AS Response                                                        
                                                                                             
                     FAST TGS Request                                                        
                                                                                             
                     FAST TGS Response                                                       |

1.  ### Protected Users

    1.  #### Interactive Logon

|                   |                                             |
|-------------------|---------------------------------------------|
| **Description**   | Test protected users interactive log on     |
| **Call Sequence** | AS Request for user (no pre-authentication) 
                                                                  
                     KRB Error (PA-ENC-TIMESTAMP)                 
                                                                  
                     AS Request for user                          
                                                                  
                     AS Response                                  
                                                                  
                     TGS Request                                  
                                                                  
                     TGS Response                                 |

#### Down-level Protection

|                   |                                                                  |
|-------------------|------------------------------------------------------------------|
| **Description**   | Test Client and KDC behavior with down-level version of Windows. |
| **Call Sequence** | AS Request for user (no pre-authentication)                      
                                                                                       
                     KRB Error (PA-ENC-TIMESTAMP)                                      
                                                                                       
                     AS Request for user                                               
                                                                                       
                     AS Response                                                       
                                                                                       
                     TGS Request                                                       
                                                                                       
                     TGS Response                                                      |

1.  Single Domain: Network Logon Test
    ---------------------------------

    1.  ### Basic

|                   |                                                                     |
|-------------------|---------------------------------------------------------------------|
| **Description**   | A user logs on a domain-joined application server using a basic KDC |
| **Call Sequence** | AP Negotiate request                                                
                                                                                          
                     AP Negotiate response (use Kerberos)                                 
                                                                                          
                     AS Request for user (no pre-authentication)                          
                                                                                          
                     KRB Error (PA-ENC-TIMESTAMP)                                         
                                                                                          
                     AS Request for user                                                  
                                                                                          
                     AS Response                                                          
                                                                                          
                     TGS Request                                                          
                                                                                          
                     TGS Response                                                         
                                                                                          
                     AP Session setup request                                             
                                                                                          
                     AP Session setup response                                            |

### Claims

|                   |                                                                                |
|-------------------|--------------------------------------------------------------------------------|
| **Description**   | A user logs on a domain-joined CBAC-aware application server using a basic KDC |
| **Call Sequence** | AP Negotiate request                                                           
                                                                                                     
                     AP Negotiate response (use Kerberos)                                            
                                                                                                     
                     AS Request for device (no pre-authentication)                                   
                                                                                                     
                     KRB Error (PA-FX-FAST)                                                          
                                                                                                     
                     AS Request for device                                                           
                                                                                                     
                     AS Response (device claims, PA-SUPPORTED-ENCTYPES)                              
                                                                                                     
                     FAST AS Request for user (no pre-authentication)                                
                                                                                                     
                     KRB Error (PA-FX-FAST)                                                          
                                                                                                     
                     FAST AS Request for user                                                        
                                                                                                     
                     FAST AS Response (user claims, PA-SUPPORTED-ENCTYPES)                           
                                                                                                     
                     Compound Identity TGS Request                                                   
                                                                                                     
                     Compound Identity TGS Response (user and device claims)                         
                                                                                                     
                     AP Session setup request                                                        
                                                                                                     
                     AP Session setup response                                                       |

### Compound Identity

|                   |                                                                                                      |
|-------------------|------------------------------------------------------------------------------------------------------|
| **Description**   | A user logs on a domain-joined CBAC-aware application server using a Compound Identity supported KDC |
| **Call Sequence** | AP Negotiate request                                                                                 
                                                                                                                           
                     AP Negotiate response (use Kerberos)                                                                  
                                                                                                                           
                     AS Request for device (no pre-authentication)                                                         
                                                                                                                           
                     KRB Error (PA-FX-FAST)                                                                                
                                                                                                                           
                     AS Request for device                                                                                 
                                                                                                                           
                     AS Response (device claims, PA-SUPPORTED-ENCTYPES)                                                    
                                                                                                                           
                     FAST AS Request for user (no pre-authentication)                                                      
                                                                                                                           
                     KRB Error (PA-FX-FAST)                                                                                
                                                                                                                           
                     FAST AS Request for user                                                                              
                                                                                                                           
                     FAST AS Response (user claims, PA-SUPPORTED-ENCTYPES)                                                 
                                                                                                                           
                     Compound Identity TGS Request                                                                         
                                                                                                                           
                     Compound Identity TGS Response (user and device claims)                                               
                                                                                                                           
                     AP Session setup request                                                                              
                                                                                                                           
                     AP Session setup response                                                                             |

1.  ### Network Logon with Authentication Policy Silos

    1.  #### AllowedToAuthenticatedTo

|                   |                                                                                                                                                                              |
|-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Domain administrators will be able to restrict which devices a user can use their passwords and smartcards to successfully authenticate by their Authentication Policy Silo. |
| **Call Sequence** | AP Negotiate request                                                                                                                                                         
                                                                                                                                                                                                   
                     AP Negotiate response (use Kerberos)                                                                                                                                          
                                                                                                                                                                                                   
                     AS Request for user (no pre-authentication)                                                                                                                                   
                                                                                                                                                                                                   
                     KRB Error (PA-ENC-TIMESTAMP)                                                                                                                                                  
                                                                                                                                                                                                   
                     AS Request for user                                                                                                                                                           
                                                                                                                                                                                                   
                     AS Response                                                                                                                                                                   
                                                                                                                                                                                                   
                     TGS Request                                                                                                                                                                   
                                                                                                                                                                                                   
                     TGS Response                                                                                                                                                                  
                                                                                                                                                                                                   
                     AP Session setup request                                                                                                                                                      
                                                                                                                                                                                                   
                     AP Session setup response                                                                                                                                                     |

#### AllowedToAuthenticatedFrom

|                   |                                                                                                                                                                                      |
|-------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | Service administrators will be able to restrict user authentication using compound authentication to their service by configuring the Authentication Policy on the domain controller |
| **Call Sequence** | AP Negotiate request                                                                                                                                                                 
                                                                                                                                                                                                           
                     AP Negotiate response (use Kerberos)                                                                                                                                                  
                                                                                                                                                                                                           
                     AS Request for device (no pre-authentication)                                                                                                                                         
                                                                                                                                                                                                           
                     KRB Error (PA-FX-FAST)                                                                                                                                                                
                                                                                                                                                                                                           
                     AS Request for device                                                                                                                                                                 
                                                                                                                                                                                                           
                     AS Response (device claims, PA-SUPPORTED-ENCTYPES)                                                                                                                                    
                                                                                                                                                                                                           
                     FAST AS Request for user (no pre-authentication)                                                                                                                                      
                                                                                                                                                                                                           
                     KRB Error (PA-FX-FAST)                                                                                                                                                                
                                                                                                                                                                                                           
                     FAST AS Request for user                                                                                                                                                              
                                                                                                                                                                                                           
                     FAST AS Response (user claims, PA-SUPPORTED-ENCTYPES)                                                                                                                                 
                                                                                                                                                                                                           
                     Compound Identity TGS Request                                                                                                                                                         
                                                                                                                                                                                                           
                     Compound Identity TGS Response (user and device claims)                                                                                                                               
                                                                                                                                                                                                           
                     AP Session setup request                                                                                                                                                              
                                                                                                                                                                                                           
                     AP Session setup response                                                                                                                                                             |

1.  Multiple Domains: Network Logon Test
    ------------------------------------

    1.  ### Basic

|                   |                                                                                                                                                                           |
|-------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | A user logs on a domain-joined application server using basic KDCs in all domains (local host in domain A, user principal in domain B and application server in domain C) 
                                                                                                                                                                                                
                     Pre-requisite:                                                                                                                                                             
                                                                                                                                                                                                
                     1.  local host must join domain A                                                                                                                                          
                                                                                                                                                                                                
                     2.  must use email type user principal name                                                                                                                                |
| **Call Sequence** | AP Negotiate request                                                                                                                                                      
                                                                                                                                                                                                
                     AP Negotiate response                                                                                                                                                      
                                                                                                                                                                                                
                     AS Request to domain A for user (no pre-authentication)                                                                                                                    
                                                                                                                                                                                                
                     KRB Error (wrong realm)                                                                                                                                                    
                                                                                                                                                                                                
                     AS Request to domain B for user (no pre-authentication)                                                                                                                    
                                                                                                                                                                                                
                     KRB Error (PA-ENC-TIMESTAMP)                                                                                                                                               
                                                                                                                                                                                                
                     AS Request do domain B for user                                                                                                                                            
                                                                                                                                                                                                
                     AS Response                                                                                                                                                                
                                                                                                                                                                                                
                     TGS Request to domain B for service                                                                                                                                        
                                                                                                                                                                                                
                     TGS Response (referral TGT)                                                                                                                                                
                                                                                                                                                                                                
                     Referral TGS Request to domain C for service                                                                                                                               
                                                                                                                                                                                                
                     Referral TGS Response                                                                                                                                                      
                                                                                                                                                                                                
                     AP Session setup request                                                                                                                                                   
                                                                                                                                                                                                
                     AP Session setup response                                                                                                                                                  |

### FAST

|                   |                                                                                                                                                                                    |
|-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | A user logs on a domain-joined application server using FAST supported KDCs in all domains (local host in domain A, user principal in domain B and application server in domain C) |
| **Call Sequence** | AP Negotiate request                                                                                                                                                               
                                                                                                                                                                                                         
                     AP Negotiate response                                                                                                                                                               
                                                                                                                                                                                                         
                     AS Request to domain A for local host (no pre-authentication)                                                                                                                       
                                                                                                                                                                                                         
                     KRB Error (PA-FX-FAST)                                                                                                                                                              
                                                                                                                                                                                                         
                     AS Request to domain A for local host                                                                                                                                               
                                                                                                                                                                                                         
                     AS Response                                                                                                                                                                         
                                                                                                                                                                                                         
                     FAST AS Request to domain A for user (no pre-authentication)                                                                                                                        
                                                                                                                                                                                                         
                     KRB Error (wrong realm)                                                                                                                                                             
                                                                                                                                                                                                         
                     FAST AS Request to domain B for user (no pre-authentication)                                                                                                                        
                                                                                                                                                                                                         
                     KRB Error (PA-FX-FAST)                                                                                                                                                              
                                                                                                                                                                                                         
                     FAST AS Request to domain B for user                                                                                                                                                
                                                                                                                                                                                                         
                     FAST AS Response                                                                                                                                                                    
                                                                                                                                                                                                         
                     FAST TGS Request to domain B for service                                                                                                                                            
                                                                                                                                                                                                         
                     FAST TGS Response to domain B for service (referral TGT)                                                                                                                            
                                                                                                                                                                                                         
                     FAST Referral TGS Request to domain C for service                                                                                                                                   
                                                                                                                                                                                                         
                     FAST Referral TGS Response to domain C for service                                                                                                                                  
                                                                                                                                                                                                         
                     AP Session setup request                                                                                                                                                            
                                                                                                                                                                                                         
                     AP Session setup response                                                                                                                                                           |

### Compound Identity

|                   |                                                                                                                                                                                             |
|-------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Description**   | A user logs on a domain-joined CBAC-Aware application server using Compound Identity supported KDCs (local host in domain A, user principal in domain B and application server in domain C) |
| **Call Sequence** | AP Negotiate request                                                                                                                                                                        
                                                                                                                                                                                                                  
                     AP Negotiate response (use Kerberos)                                                                                                                                                         
                                                                                                                                                                                                                  
                     AS Request to domain A for local host (no pre-authentication)                                                                                                                                
                                                                                                                                                                                                                  
                     KRB Error (PA-FX-FAST)                                                                                                                                                                       
                                                                                                                                                                                                                  
                     AS Request to domain A for local host                                                                                                                                                        
                                                                                                                                                                                                                  
                     AS Response (device claims)                                                                                                                                                                  
                                                                                                                                                                                                                  
                     FAST AS Request to domain A for user (no pre-authentication)                                                                                                                                 
                                                                                                                                                                                                                  
                     KRB Error (wrong realm)                                                                                                                                                                      
                                                                                                                                                                                                                  
                     FAST AS Request to domain B for user (no pre-authentication)                                                                                                                                 
                                                                                                                                                                                                                  
                     KRB Error (PA-FX-FAST)                                                                                                                                                                       
                                                                                                                                                                                                                  
                     FAST AS Request to domain B for user                                                                                                                                                         
                                                                                                                                                                                                                  
                     FAST AS Response (user claims)                                                                                                                                                               
                                                                                                                                                                                                                  
                     Compound Identity TGS Request to domain B for service                                                                                                                                        
                                                                                                                                                                                                                  
                     Compound Identity TGS Response (referral TGT)                                                                                                                                                
                                                                                                                                                                                                                  
                     Referral Compound Identity TGS Request to domain C for service                                                                                                                               
                                                                                                                                                                                                                  
                     Referral Compound Identity TGS Response to domain C for service (user and device claims)                                                                                                     
                                                                                                                                                                                                                  
                     AP Session setup request                                                                                                                                                                     
                                                                                                                                                                                                                  
                     AP Session setup response                                                                                                                                                                    |

1.  KRB\_ERROR Test
    ---------------

    1.  ### KRB\_ERROR for AS Request Test

|                   |                                                       |
|-------------------|-------------------------------------------------------|
| **Description**   | Test different types of KRB\_ERROR during AS Exchange |
| **Call Sequence** | AS Request                                            
                                                                            
                     KRB Error                                              |

### KRB\_ERROR for TGS Request Test

|                   |                                                        |
|-------------------|--------------------------------------------------------|
| **Description**   | Test different types of KRB\_ERROR during TGS Exchange |
| **Call Sequence** | AS Request                                             
                                                                             
                     AS Response                                             
                                                                             
                     TGS Request                                             
                                                                             
                     KRB Error                                               |

### KRB\_ERROR for AP Request Test

|                   |                                                        |
|-------------------|--------------------------------------------------------|
| **Description**   | Test different types of KRB\_ERROR during TGS Exchange |
| **Call Sequence** | AS Request                                             
                                                                             
                     AS Response                                             
                                                                             
                     TGS Request                                             
                                                                             
                     TGS Response                                            
                                                                             
                     AP Request                                              
                                                                             
                     KRB Error                                               |

1.  KKDCP Test
    ----------

    1.  ### Basic

|                   |                                        |
|-------------------|----------------------------------------|
| **Description**   | Test existing cases using KKDCP Server 
                                                             
                     Pre-requisite:                          
                                                             
                     1. Set up KKDCP server                  
                                                             
                     2. Set UseProxy=true in ptfconfig file  |
| **Call Sequence** | SendProxyRequest                       
                                                             
                     GetProxyResponse                        |

### Negative

|                   |                                     |
|-------------------|-------------------------------------|
| **Description**   | Test different types of KKDCP Error |
| **Call Sequence** | AS Proxy Request                    
                                                          
                     KKDCP Error                          |

### Kpassword

|                   |                                                        |
|-------------------|--------------------------------------------------------|
| **Description**   | Test Kpassword when the password change succeeds/fails 
                                                                             
                     Pre-requisite:                                          
                                                                             
                     1. Set up KKDCP server                                  
                                                                             
                     2. Set UseProxy=true in ptfconfig file                  
                                                                             
                     3. Set password group policy MinimumPasswordAge=0       
                                                                             
                     4. Set password group policy PasswordHistorySize=0      |
| **Call Sequence** | Kpassword Request                                      
                                                                             
                     Kpassword Response                                      |

1.  Test Cases Design
    =================

    1.  Single Domain: Interactive Logon Test
        -------------------------------------

        1.  ### Basic

            1.  #### Normal

|                          |                                                                                                                                             |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Normal                                                                                                                                      |
| **Priority**             | P0 (BVT)                                                                                                                                    |
| **Description **         | This test case is designed to go through the whole process with default settings.                                                           |
| **Prerequisites**        |                                                                                                                                             |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                    
                                                                                                                                                                         
                                1.  kdc-options: RENEWABLE, FORWARDABLE, CANONICALIZE                                                                                    
                                                                                                                                                                         
                                    > cname: &lt;username&gt;                                                                                                            
                                                                                                                                                                         
                                    > realm: contoso.com                                                                                                                 
                                                                                                                                                                         
                                    > sname: krbtgt/contoso.com                                                                                                          
                                                                                                                                                                         
                            2.  KDC returns KRB\_ERROR                                                                                                                   
                                                                                                                                                                         
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                              
                                                                                                                                                                         
                                    > crealm: contoso.com                                                                                                                
                                                                                                                                                                         
                                    > realm: contoso.com                                                                                                                 
                                                                                                                                                                         
                                    > sname: krbtgt/contoso.com                                                                                                          
                                                                                                                                                                         
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                           
                                                                                                                                                                         
                            3.  Client sends AS\_REQ                                                                                                                     
                                                                                                                                                                         
                                1.  padata: PA-ENC-TIMESTAMP, PA-PAC-REQUEST, PA-PAC-OPTIONS(claims, forward to full DC)                                                 
                                                                                                                                                                         
                                    > kdc-options: RENEWABLE, FORWARDABLE, CANONICALIZE                                                                                  
                                                                                                                                                                         
                                    > cname: &lt;username&gt;                                                                                                            
                                                                                                                                                                         
                                    > realm: contoso.com                                                                                                                 
                                                                                                                                                                         
                                    > sname: krbtgt/contoso.com                                                                                                          
                                                                                                                                                                         
                            4.  KDC return AS\_REP                                                                                                                       
                                                                                                                                                                         
                                1.  crealm: contoso.com                                                                                                                  
                                                                                                                                                                         
                                    > ticket: user’s TGT (isCommon1)                                                                                                     
                                                                                                                                                                         
                                    > authorization-data: KERB\_VALIDATION\_INFO, PAC\_CLIENT\_INFO, PAC\_SIGNATURE\_DATA, UPN\_DNS\_INFO, PAC\_CLIENT\_CLAIMS\_INFO     
                                                                                                                                                                         
                                    > key: session key                                                                                                                   
                                                                                                                                                                         
                                    > flags: INITIAL, RENEWABLE, PRE-AUTHENT, FORWARDABLE, CANONICALIZE                                                                  
                                                                                                                                                                         
                                    > srealm: contoso.com                                                                                                                
                                                                                                                                                                         
                                    > sname: krbtgt/contoso.com                                                                                                          
                                                                                                                                                                         
                                    > enc-padata: PA-SUPPORTED-ENCTYPES                                                                                                  
                                                                                                                                                                         
                            5.  Client send TGS request                                                                                                                  
                                                                                                                                                                         
                                1.  padata: PA-TGS-REQ, PA-PAC-OPTIONS(branch aware)                                                                                     
                                                                                                                                                                         
                                    > ap-options: use-session-key, mutual authentication                                                                                 
                                                                                                                                                                         
                                    > ticket: user’s TGT                                                                                                                 
                                                                                                                                                                         
                                    > authenticator:                                                                                                                     
                                                                                                                                                                         
                                    > crealm: contoso.com                                                                                                                
                                                                                                                                                                         
                                    > cname: &lt;username&gt;                                                                                                            
                                                                                                                                                                         
                                    > authorization-data(authenticator): PAC                                                                                             
                                                                                                                                                                         
                                    > kdc-options: RENEWABLE, FORWARDABLE, CANONICALIZE                                                                                  
                                                                                                                                                                         
                                    > cname: &lt;username&gt;                                                                                                            
                                                                                                                                                                         
                                    > realm: contoso.com                                                                                                                 
                                                                                                                                                                         
                                    > sname: host/&lt;clientcomputername&gt;.contoso.com                                                                                 
                                                                                                                                                                         
                                    > enc-authorization-data: KERB-LOCAL                                                                                                 
                                                                                                                                                                         
                            6.  KDC returns TGS response                                                                                                                 
                                                                                                                                                                         
                            > crealm: contoso.com                                                                                                                        
                            >                                                                                                                                            
                            > cname: &lt;username&gt;                                                                                                                    
                            >                                                                                                                                            
                            > ticket: service ticket (isCommon2)                                                                                                         
                            >                                                                                                                                            
                            > realm: contoso.com                                                                                                                         
                            >                                                                                                                                            
                            > sname: host/&lt;clientcomputername&gt;.contoso.com                                                                                         
                            >                                                                                                                                            
                            > flags: RENEWABLE, FORWARDABLE, CANONICALIZE                                                                                                
                            >                                                                                                                                            
                            > key: session key                                                                                                                           
                            >                                                                                                                                            
                            > crealm: contoso.com                                                                                                                        
                            >                                                                                                                                            
                            > cname: &lt;username&gt;                                                                                                                    
                            >                                                                                                                                            
                            > authorization-data:KERB-LOCAL ,KERB\_VALIDATION\_INFO, PAC\_CLIENT\_INFO, PAC\_SIGNATURE\_DATA, UPN\_DNS\_INFO, PAC\_CLIENT\_CLAIMS\_INFO  
                            >                                                                                                                                            
                            > key: session key                                                                                                                           
                            >                                                                                                                                            
                            > flags: RENEWABLE, FORWARDABLE, CANONICALIZE                                                                                                
                            >                                                                                                                                            
                            > srealm: contoso.com                                                                                                                        
                            >                                                                                                                                            
                            > sname: host/&lt;clientcomputername&gt;.contoso.com                                                                                         
                            >                                                                                                                                            
                            > enc-padata: PA-SUPPORTED-ENCTYPES                                                                                                          |
| **Requirements covered** | Section                                                                                                                                     |
| **Cleanup**              |                                                                                                                                             |

#### IPv6 Addresses

|                          |                                                                        |
|--------------------------|------------------------------------------------------------------------|
| **Test ID**              | IPv6\_Addresses                                                        |
| **Priority**             | P1                                                                     |
| **Description **         | This test case is designed to verify if the KDC support IPv6.          |
| **Prerequisites**        | Change the client and KDC’s addresses to IPv6 type;                    |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                               
                                                                                                    
                            2.  KDC returns AS\_REP                                                 
                                                                                                    
                            3.  Client sends TGS\_REQ                                               
                                                                                                    
                            4.  KDC returns TGS\_REP                                                
                                                                                                    
                            > ticket: user TGT (isKile1)                                            |
| **Requirements covered** | isKile:                                                                
                                                                                                    
                            1.  KILE SHOULD support IPv6 addresses. (\[MS-KILE\] section 3.1.5.6);  |
| **Cleanup**              | Change the IP versions back.                                           |

#### Directional Addresses

|                          |                                                                                                                                                |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Directional\_Addresses                                                                                                                         |
| **Priority**             | P1                                                                                                                                             |
| **Description **         | This test case is designed to verify if the KDC support directional addresses.                                                                 |
| **Prerequisites**        | Change the client and KDC’s addresses to directional address type;                                                                             |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for user TGT                                                                                                          
                                                                                                                                                                            
                            2.  KDC return AS\_REP timeout (isKile1)                                                                                                        |
| **Requirements covered** | isKile:                                                                                                                                        
                                                                                                                                                                            
                            1.  KILE MUST NOT support directional addresses. If the directional addresses are present, they MUST be ignored.(\[MS-KILE\] section 3.1.5.6);  |
| **Cleanup**              | Change the IP versions back.                                                                                                                   |

#### UDP/IP transport

|                          |                                                                                                                                                                                                                                 |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | UDP\_IP\_transport                                                                                                                                                                                                              |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                        |
| **Description **         | This test case is designed to verify if the KDC support UDP/IP transport.                                                                                                                                                       |
| **Prerequisites**        |                                                                                                                                                                                                                                 |
| **Test Execution Steps** | 1.  Client locates a KDC using DNS SRV records.                                                                                                                                                                                 
                                                                                                                                                                                                                                                             
                            2.  KDC returns its own IP address (isKile1)                                                                                                                                                                                     
                                                                                                                                                                                                                                                             
                                1.  Client sends AS\_REQ for user over UDP port 88                                                                                                                                                                           
                                                                                                                                                                                                                                                             
                            3.  KDC returns KRB\_ERROR over UDP port 88 (isCommon1)                                                                                                                                                                          
                                                                                                                                                                                                                                                             
                            > error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                        
                            >                                                                                                                                                                                                                                
                            > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                       
                                                                                                                                                                                                                                                             
                            1.  Client sends AS\_REQ for user over UDP port 88                                                                                                                                                                               
                                                                                                                                                                                                                                                             
                            > padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                       
                                                                                                                                                                                                                                                             
                            1.  KDC return AS response over UDP port 88 (isCommon1)                                                                                                                                                                          |
| **Requirements covered** | isKile:                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                             
                            1.  KILE MUST have a working DNS infrastructure (\[MS-KILE\] Section 2.1);                                                                                                                                                       
                                                                                                                                                                                                                                                             
                                Kerberos client implementations MUST provide a means for the client to determine the location of the Kerberos KDCs. (*DNS is one of them.*) (\[RFC4120\] section 7.2.3)                                                      
                                                                                                                                                                                                                                                             
                            isCommon:                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                             
                            1.  Kerberos servers (KDCs) supporting IP transports MUST accept UDP requests and SHOULD listen for them on port 88 (decimal) unless specifically configured to listen on an alternative UDP port. (\[RFC4120\] section 7.2.1);  
                                                                                                                                                                                                                                                             
                                KILE SHOULD use UDP by default (\[MS-KILE\] section 2.1);                                                                                                                                                                    |
| **Cleanup**              |                                                                                                                                                                                                                                 |

#### TCP/IP transport

|                          |                                                                                                                                                                                                                                 |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | TCP\_IP\_transport                                                                                                                                                                                                              |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                        |
| **Description **         | This test case is designed to verify if the KDC support TCP/IP transport.                                                                                                                                                       |
| **Prerequisites**        |                                                                                                                                                                                                                                 |
| **Test Execution Steps** | 1.  Client locates a KDC using DNS SRV records.                                                                                                                                                                                 
                                                                                                                                                                                                                                                             
                            2.  KDC returns its own IP address (isKile1)                                                                                                                                                                                     
                                                                                                                                                                                                                                                             
                                1.  Client sends AS\_REQ for user over UDP port 88                                                                                                                                                                           
                                                                                                                                                                                                                                                             
                            3.  KDC returns KRB\_ERROR over TCP port 88 (isCommon1)                                                                                                                                                                          
                                                                                                                                                                                                                                                             
                            > error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                        
                            >                                                                                                                                                                                                                                
                            > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                       
                                                                                                                                                                                                                                                             
                            1.  Client sends AS\_REQ for user over UDP port 88                                                                                                                                                                               
                                                                                                                                                                                                                                                             
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                 
                                                                                                                                                                                                                                                             
                            2.  KDC return AS response over TCP port 88 (isCommon1)                                                                                                                                                                          |
| **Requirements covered** | isKile:                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                             
                            1.  KILE MUST have a working DNS infrastructure (\[MS-KILE\] Section 2.1);                                                                                                                                                       
                                                                                                                                                                                                                                                             
                                Kerberos client implementations MUST provide a means for the client to determine the location of the Kerberos KDCs. (*DNS is one of them.*) (\[RFC4120\] section 7.2.3)                                                      
                                                                                                                                                                                                                                                             
                            isCommon:                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                             
                            1.  Kerberos servers (KDCs) supporting IP transports MUST accept TCP requests and SHOULD listen for them on port 88 (decimal) unless specifically configured to listen on an alternative TCP port. (\[RFC4120\] section 7.2.1);  |
| **Cleanup**              |                                                                                                                                                                                                                                 |

#### UDP to TCP

|                          |                                                                                                                                                                                                                                                                                       |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | UDP\_to\_TCP                                                                                                                                                                                                                                                                          |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                              |
| **Description **         | This test case is designed to verify if the KDC can deal with too big response sent from client.                                                                                                                                                                                      |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                       |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for user over UDP port 88                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                   
                            2.  KDC returns KRB\_ERROR over UDP port 88                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                   
                            > error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                              
                            >                                                                                                                                                                                                                                                                                      
                            > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                   
                            1.  Client sends AS\_REQ for user over UDP port 88                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                   
                                1.  Make the PDU of the AS-REQ larger than 1465 bytes. (isKile1)                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                   
                                    > padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                   
                            2.  KDC returns KRB\_ERROR over UDP port 88                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                   
                                1.  error-code: KDC\_ERR\_RESPONSE\_TOO\_BIG (isCommon1)                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                   
                            3.  Client sends AS\_REQ for user over TCP port 88                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                   
                                1.  Make the PDU of the AS-REQ larger than 1465 bytes. (isKile1)                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                   
                                    > padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                   
                            4.  KDC return AS response over TCP port 88 (isCommon1)                                                                                                                                                                                                                                |
| **Requirements covered** | <span id="_Toc427329230" class="anchor"></span>Section <span id="_Toc367504362" class="anchor"></span>2.1 Transport<span id="za560d6fe358347bfa06e7fa3e66cde72" class="anchor"></span>                                                                                                
                                                                                                                                                                                                                                                                                                                   
                            isKile:                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                   
                            1.  If the message size exceeds a specific configurable value (message size threshold), TCP SHOULD be used. The threshold applies to AS and TGS messages. The do not apply to AP messages because the transport is controlled by the application protocol. (\[MS-KILE\] section 2.1);  
                                                                                                                                                                                                                                                                                                                   
                                The default value for the message size threshold for Windows Server 8 is 1465 bytes. (\[MS-KILE\] section 6 &lt;2&gt;);                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                   
                            isCommon:                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                   
                            1.  If the response cannot be handled using UDP (for example, because it is too large), the KDC MUST return KRB\_ERR\_RESPONSE\_TOO\_BIG, forcing the client to retry the request using the TCP transport. (\[RFC4120\] section 7.2.1);                                                
                                                                                                                                                                                                                                                                                                                   
                                KILE MUST support the KRB\_ERR\_RESPONSE\_TOO\_BIG error message. (\[MS-KILE\] section 3.1.5.5);                                                                                                                                                                                   |
| **Cleanup**              |                                                                                                                                                                                                                                                                                       |

#### Unknown Pre-authentication type

|                          |                                                                                                         |
|--------------------------|---------------------------------------------------------------------------------------------------------|
| **Test ID**              | Unknown\_Pre-authentication\_Type                                                                       |
| **Priority**             | P0                                                                                                      |
| **Description **         | This test case is designed to verify if the unknown pre-authentication types can be ignored by the KDC. |
| **Prerequisites**        |                                                                                                         |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                
                                                                                                                                     
                            > padata: no pre-authentication data, &lt;unknown pa-data&gt;                                            
                                                                                                                                     
                            1.  KDC returns KRB\_ERROR                                                                               
                                                                                                                                     
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                          
                                                                                                                                     
                                    > e-data: PA-ENC-TIMESTAMP                                                                       
                                                                                                                                     
                            2.  Client sends AS\_REQ                                                                                 
                                                                                                                                     
                                1.  padata: PA-ENC-TIMESTAMP (encrypted using the client’s password), &lt;unknown pa-data&gt;        
                                                                                                                                     
                            3.  KDC returns AS\_REP                                                                                  
                                                                                                                                     
                            > ticket: user TGT (check existence) (isKile1)                                                           
                                                                                                                                     
                            1.  Client sends TGS\_REQ                                                                                
                                                                                                                                     
                            2.  KDC returns TGS\_REP                                                                                 
                                                                                                                                     
                            > ticket: service ticket (check existence) (isKile1)                                                     |
| **Requirements covered** | isKile:                                                                                                 
                                                                                                                                     
                            1.  Unknown pre-authentication types MUST be ignored by KDCs. (\[MS-KILE\] section 3.1.5.1);             |
| **Cleanup**              |                                                                                                         |

#### Using Password with AES256

|                          |                                                                                                                                                                                                                                                                                 |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Using\_Password\_with\_AES256                                                                                                                                                                                                                                                   |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                        |
| **Description **         | This test case is designed to verify if the KDC supports client initiated password-based authentication and whether the KDC supports AES encryption type.                                                                                                                       |
| **Prerequisites**        | Set attribute msDS-SupportedEncryptionTypes to 0x1F for the krbtgt/contoso.com object in AD;                                                                                                                                                                                    |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                             
                            > etype: &lt;desired encryption algorithm to be used by the client including AES256&gt;                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                             
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                             
                                    > e-data:                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                             
                                    > padata\[0\]: PA-ENC-TIMESTAMP (isKile1)                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                             
                                    > padata\[1\]: PA-ETYPE-INFO2 (including AES)                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                             
                                    > etype: AES256 (isKile2)                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                             
                            2.  Client sends AS\_REQ                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                             
                            > padata: PA-ENC-TIMESTAMP (encrypted using AES256)                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                             
                            1.  KDC return AS\_REP                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                             
                            > ticket: user TGT (check existence) (isKile3)                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                                
                            > etype: AES256 (isKile2)                                                                                                                                                                                                                                                        
                            >                                                                                                                                                                                                                                                                                
                            > kvno: key version number (isCommon1)                                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                                                
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES = 0x1F (isKile3)                                                                                                                                                                                                                            |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                             
                            1.  kvno: This field contains the version number of the key under which data is encrypted. It is only present in messages encrypted under long lasting keys, such as principals’ secret keys. (\[RFC4120\] section 5.2.9)                                                        
                                                                                                                                                                                                                                                                                                             
                            isKile:                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                             
                            1.  When clients perform a password-based initial authentication, they MUST supply the PA-ENC-TIMESTAMP pre-authentication type when they construct the initial AS request.                                                                                                      
                                                                                                                                                                                                                                                                                                             
                                (\[MS-KILE\] section 3.1.5.2);                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                             
                            2.  KILE SHOULD support the Advanced Encryption Standard (AES) encryption types:                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                             
                                1.  AES256-CTS-HMAC-SHA1-96 \[18\]                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                             
                                2.  AES128-CTS-HMAC-SHA1-96 \[17\]                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                             
                                    (\[MS-KILE\] section 3.1.5.2);                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                             
                            3.  The KDC SHOULD return in the encrypted part of the AS-REP message PA-DATA with padata-type set to PA-SUPPORTED-ENCTYPES (165), to indicate what encryption types are supported by the KDC, and whether Claims or FAST are supported.                                         
                                                                                                                                                                                                                                                                                                             
                                If domainControllerFunctionality returns a value &gt;=3: the KDC SHOULD, in the encrypted pre-auth data part of the AS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), and the padata-value set to 0x1F.(\[MS-KILE\] section 3.3.5.3)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                 |

#### Using Password with AES128

|                          |                                                                                                                                                                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Using\_Password\_with\_AES128                                                                                                                                                                                                                                          |
| **Priority**             | P0                                                                                                                                                                                                                                                                     |
| **Description **         | This test case is designed to verify if the KDC supports client initiated password-based authentication and whether the KDC supports AES encryption type.                                                                                                              |
| **Prerequisites**        | Set attribute msDS-SupportedEncryptionTypes to 0xF for the krbtgt/contoso.com object in AD;                                                                                                                                                                            |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                    
                            > etype: &lt;desired encryption algorithm to be used by the client including AES128&gt;                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                    
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                    
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                    
                                    > e-data:                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                    
                                    > padata\[0\]: PA-ENC-TIMESTAMP (isKile1)                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                    
                                    > padata\[1\]: PA-ETYPE-INFO2 (including AES128)                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                    
                                    > etype: AES128 (isKile2)                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                    
                                    > salt: CONTOSO.COMtest01 or CONTOSO.COMhostendpoint01.contoso.com (isKile3)                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                    
                            2.  Client sends AS\_REQ                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                    
                                1.  padata: PA-ENC-TIMESTAMP (encrypted using AES128)                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                    
                            3.  KDC returns AS\_REP                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                    
                            > ticket: user TGT (check existence) (isKile4)                                                                                                                                                                                                                          
                            >                                                                                                                                                                                                                                                                       
                            > etype: AES128 (isKile2)                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                       
                            > kvno: key version number (isCommon1)                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                       
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES=0xF (isKile4)                                                                                                                                                                                                                      |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                    
                            1.  kvno: This field contains the version number of the key under which data is encrypted. It is only present in messages encrypted under long lasting keys, such as principals’ secret keys. (\[RFC4120\] section 5.2.9)                                               
                                                                                                                                                                                                                                                                                                    
                            isKile:                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                    
                            1.  When clients perform a password-based initial authentication, they MUST supply the PA-ENC-TIMESTAMP pre-authentication type when they construct the initial AS request.                                                                                             
                                                                                                                                                                                                                                                                                                    
                                (\[MS-KILE\] section 3.1.5.2);                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                    
                            2.  KILE SHOULD support the Advanced Encryption Standard (AES) encryption types:                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                    
                                1.  AES256-CTS-HMAC-SHA1-96 \[18\]                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                    
                                2.  AES128-CTS-HMAC-SHA1-96 \[17\]                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                    
                                    (\[MS-KILE\] section 3.1.5.2);                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                    
                            3.  When KILE creates an AES128 key, the password MUST be converted from a Unicode (UTF16) string to a UTF8 string (\[MS-KILE\] section 3.1.1.2);                                                                                                                       
                                                                                                                                                                                                                                                                                                    
                            4.  The KDC SHOULD return in the encrypted part of the AS-REP message PA-DATA with padata-type set to PA-SUPPORTED-ENCTYPES (165), to indicate what encryption types are supported by the KDC, and whether Claims or FAST are supported. (\[MS-KILE\] section 3.3.5.3)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                        |

#### Using Password with RC4

|                          |                                                                                                                                                                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Using\_Password\_with\_RC4                                                                                                                                                                                                                                             |
| **Priority**             | P1                                                                                                                                                                                                                                                                     |
| **Description **         | This test case is designed to verify if the KDC supports client initiated password-based authentication and whether the KDC supports RC4 encryption type.                                                                                                              |
| **Prerequisites**        | Set attribute msDS-SupportedEncryptionTypes to 0x7 for the krbtgt/contoso.com object in AD;                                                                                                                                                                            |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                    
                            > etype: &lt;desired encryption algorithm to be used by the client including RC4&gt;                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                    
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                    
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                    
                                    > e-data:                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                    
                                    > padata\[0\]: PA-ENC-TIMESTAMP (isKile1)                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                    
                                    > padata\[1\]: PA-ETYPE-INFO (including RC4) (isKile2)                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                    
                            2.  Client sends AS\_REQ                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                    
                                1.  padata: PA-ENC-TIMESTAMP (encrypted using RC4)                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                    
                            3.  KDC returns AS\_REP                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                    
                            > ticket: user TGT (check existence)                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                       
                            > etype: RC4 (isKile2)                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                       
                            > kvno: key version number (isCommon1)                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                       
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES=0x7 (isKile3)                                                                                                                                                                                                                      |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                    
                            1.  kvno: This field contains the version number of the key under which data is encrypted. It is only present in messages encrypted under long lasting keys, such as principals’ secret keys. (\[RFC4120\] section 5.2.9)                                               
                                                                                                                                                                                                                                                                                                    
                            isKile:                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                    
                            1.  When clients perform a password-based initial authentication, they MUST supply the PA-ENC-TIMESTAMP pre-authentication type when they construct the initial AS request.                                                                                             
                                                                                                                                                                                                                                                                                                    
                                (\[MS-KILE\] section 3.1.5.2);                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                    
                            2.  KILE MAY<span id="z71" class="anchor"></span> support the other following encryption types, which are listed in order of relative strength:                                                                                                                         
                                                                                                                                                                                                                                                                                                    
                            >  RC4-HMAC \[23\]                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                       
                            >  RC4-HMAC-EXP \[24\]                                                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                                                       
                            >  DES-CBC-MD5 \[3\]                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                       
                            >  DES-CBC-CRC \[1\]                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                       
                            > (\[MS-KILE\] section 3.1.5.2);                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                    
                            1.  The KDC SHOULD return in the encrypted part of the AS-REP message PA-DATA with padata-type set to PA-SUPPORTED-ENCTYPES (165), to indicate what encryption types are supported by the KDC, and whether Claims or FAST are supported. (\[MS-KILE\] section 3.3.5.3)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                        |

#### Using Password with DES

|                          |                                                                                                                                                                                                                                                     |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Using\_Password\_with\_DES                                                                                                                                                                                                                          |
| **Priority**             | P0                                                                                                                                                                                                                                                  |
| **Description **         | This test case is designed to verify if the KDC supports client initiated password-based authentication and whether the KDC supports DES encryption type.                                                                                           |
| **Prerequisites**        | Set UseDESOnly flag to the krbtgt account;                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                 
                            Or set attribute msDS-SupportedEncryptionTypes to 0x3 for the krbtgt/contoso.com object in AD;                                                                                                                                                       |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                 
                            > etype: &lt;desired encryption algorithm to be used by the client including DES&gt;                                                                                                                                                                 
                                                                                                                                                                                                                                                                                 
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                 
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                 
                                    > e-data:                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                 
                                    > padata\[0\]: PA-ENC-TIMESTAMP (isKile1)                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                 
                                    > padata\[1\]: PA-ETYPE-INFO (including DES) (isKile2)                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                 
                            2.  Client sends AS\_REQ                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                 
                                1.  padata: PA-ENC-TIMESTAMP (encrypted using DES)                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                 
                            3.  KDC returns AS\_REP                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                 
                            > ticket: user TGT (check existence)                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                                    
                            > etype: RC4 (isKile2)                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                    
                            > kvno: key version number (isCommon1)                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                    
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES = 0x3 (isKile3)                                                                                                                                                                                                 |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                 
                            1.  When clients perform a password-based initial authentication, they MUST supply the PA-ENC-TIMESTAMP pre-authentication type when they construct the initial AS request.                                                                          
                                                                                                                                                                                                                                                                                 
                                (\[MS-KILE\] section 3.1.5.2);                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                 
                            2.  KILE MAY support the other following encryption types, which are listed in order of relative strength:                                                                                                                                           
                                                                                                                                                                                                                                                                                 
                            >  RC4-HMAC \[23\]                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                    
                            >  RC4-HMAC-EXP \[24\]                                                                                                                                                                                                                              
                            >                                                                                                                                                                                                                                                    
                            >  DES-CBC-MD5 \[3\]                                                                                                                                                                                                                                
                            >                                                                                                                                                                                                                                                    
                            >  DES-CBC-CRC \[1\]                                                                                                                                                                                                                                
                            >                                                                                                                                                                                                                                                    
                            > (\[MS-KILE\] section 3.1.5.2);                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                 
                            1.  The KDC SHOULD return in the encrypted part of the AS-REP message PA-DATA with padata-type set to PA-SUPPORTED-ENCTYPES (165), to indicate what encryption types are supported by the KDC, and whether Claims or FAST are supported.             
                                                                                                                                                                                                                                                                                 
                            > If the UseDESOnly flag is set: the KDC SHOULD, in the encrypted pre-auth data part of the AS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), and the padata-value set to 0x3. (\[MS-KILE\] section 3.3.5.3)  |
| **Cleanup**              | Unset UseDESOnly flag to the krbtgt account;                                                                                                                                                                                                        |

#### Checksum

How to trigger other checksum?

#### INITIAL and PRE-AUTHENT Flag

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | INITIAL\_and\_PRE-AUTHENT\_Flag                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Description **         | This test case is designed to verify if the INITIAL and PRE-AUTHENT ticket flags are supported by the KDC.                                                                                                                                                                                                                                                                                                                                    |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > padata: no pre-authentication data                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            2.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                1.  padata: PA-ENC-TIMESTAMP (encrypted using the client’s password)                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            3.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > ticket: user TGT (check existence)                                                                                                                                                                                                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > flags: INITIAL (isCommon1) and PRE-AUTHENT (isCommon2)                                                                                                                                                                                                                                                                                                                                                                                       |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  The INITIAL flag indicates that a ticket was issued using the AS protocol, rather than issued based on a TGT. Application servers that want to require the demonstrated knowledge of a client’s secret key (e.g., a password-changing program) can insist that this flag be set in any tickets they accept, and can thus be assured that the client’s key was recently presented to the authentication server. (\[RFC4120\] section 2.1);  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            2.  The PRE-AUTHENT and HW-AUTHENT flags provide additional information about the initial authentication, regardless of whether the current ticket was issued directly (in which case INITIAL will also be set) or issued on the basis of a TGT (in which case the INITIAL flag is clear, but the PRE-AUTHENT and HW-AUTHENT flags are carried forward from the TGT). (\[RFC4120\] section 2.1);                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                The INITIAL and PRE-AUTHENT flags: By default, KDCs require pre-authentication when they issue tickets. Clients SHOULD pre-authenticate. KDCs MUST enforce pre-authentication. Therefore, unless the account has been explicitly set to not require Kerberos pre-authentication, the ticket will have the PRE-AUTHENT flag set. (\[MS-KILE\] section 3.1.5.4);                                                                             |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                               |

#### HW-AUTHENT Flag

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | HW-AUTHENT\_Flag                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Description **         | This test case is designed to verify if the HW-AUTHENT ticket flag is supported by the KDC.                                                                                                                                                                                                                                                                                                                                                   |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > padata: no pre-authentication data                                                                                                                                                                                                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > kdc-options: OPT-HARDWARE-AUTH option                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            2.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                1.  padata: PA-ENC-TIMESTAMP (encrypted using the client’s password)                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > kdc-options: OPT-HARDWARE-AUTH option                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > ticket: user TGT (check existence)                                                                                                                                                                                                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > flags: INITIAL (isCommon1) and HW-AUTHENT set (isCommon2) not set (isKile1)                                                                                                                                                                                                                                                                                                                                                                  |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  The INITIAL flag indicates that a ticket was issued using the AS protocol, rather than issued based on a TGT. Application servers that want to require the demonstrated knowledge of a client’s secret key (e.g., a password-changing program) can insist that this flag be set in any tickets they accept, and can thus be assured that the client’s key was recently presented to the authentication server. (\[RFC4120\] section 2.1);  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            2.  The PRE-AUTHENT and HW-AUTHENT flags provide additional information about the initial authentication, regardless of whether the current ticket was issued directly (in which case INITIAL will also be set) or issued on the basis of a TGT (in which case the INITIAL flag is clear, but the PRE-AUTHENT and HW-AUTHENT flags are carried forward from the TGT). (\[RFC4120\] section 2.1);                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            isKile:                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  The HW-AUTHENT flag: This flag was originally intended to indicate that hardware-supported authentication was used during pre-authentication. This flag is no longer recommended in the Kerberos V5 protocol. KDCs MUST NOT issue a ticket with this flag set. KDCs SHOULD NOT preserve this flag if it is set by another KDC. (\[MS-KILE\] section 3.1.5.4);                                                                              |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                               |

#### RENEWABLE Flag

|                          |                                                                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | RENEWABLE\_Flag                                                                                                                                                        |
| **Priority**             | P0                                                                                                                                                                     |
| **Description **         | This test case is designed to verify if the RENEWABLE ticket flag is supported by the KDC.                                                                             |
| **Prerequisites**        |                                                                                                                                                                        |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                               
                                                                                                                                                                                                    
                            > padata: no pre-authentication data                                                                                                                                    
                            >                                                                                                                                                                       
                            > kdc-options: RENEWABLE option                                                                                                                                         
                                                                                                                                                                                                    
                            1.  KDC returns KRB\_ERROR                                                                                                                                              
                                                                                                                                                                                                    
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                        
                                                                                                                                                                                                    
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                      
                                                                                                                                                                                                    
                            2.  Client sends AS\_REQ                                                                                                                                                
                                                                                                                                                                                                    
                                1.  padata: PA-ENC-TIMESTAMP (encrypted using the client’s password)                                                                                                
                                                                                                                                                                                                    
                            > kdc-options: RENEWABLE option                                                                                                                                         
                                                                                                                                                                                                    
                            1.  KDC returns AS\_REP                                                                                                                                                 
                                                                                                                                                                                                    
                            > ticket: user TGT (check existence)                                                                                                                                    
                            >                                                                                                                                                                       
                            > flags: RENEWABLE (isCommon1)                                                                                                                                          |
| **Requirements covered** | isCommon:                                                                                                                                                              
                                                                                                                                                                                                    
                            1.  The RENEWABLE flag is reset by default, but a client MAY request it be set by setting the RENEWABLE option in the KRB\_AS\_REQ message. (\[RFC4120\] section 2.3);  
                                                                                                                                                                                                    
                                The RENEWABLE flag: Renewable tickets SHOULD be supported in KILE. (\[MS-KILE\] section 3.1.5.4);                                                                   |
| **Cleanup**              |                                                                                                                                                                        |

#### MAY-POSTDATE/POSTDATED Flag

|                          |                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | MAYPOSTDATE\_POSTDATED\_Flag                                                                                                                     |
| **Priority**             | P0                                                                                                                                               |
| **Description **         | This test case is designed to verify if the postdated tickets can be supported by the KDC.                                                       |
| **Prerequisites**        |                                                                                                                                                  |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                      
                                                                                                                                                                              
                            > padata: no pre-authentication data                                                                                                              
                            >                                                                                                                                                 
                            > kdc-options: ALLOW-POSTDATE option                                                                                                              
                                                                                                                                                                              
                            1.  KDC returns KRB\_ERROR                                                                                                                        
                                                                                                                                                                              
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                  
                                                                                                                                                                              
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                
                                                                                                                                                                              
                            2.  Client sends AS request                                                                                                                       
                                                                                                                                                                              
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                  
                                                                                                                                                                              
                                    > kdc-options: ALLOW-POSTDATE option                                                                                                      
                                                                                                                                                                              
                            3.  KDC returns AS\_REP                                                                                                                           
                                                                                                                                                                              
                            > ticket: user TGT (check existence)                                                                                                              
                            >                                                                                                                                                 
                            > flags: MAY-POSTDATE set (isCommon1) not set (isKile1)                                                                                           
                                                                                                                                                                              
                            1.  Client send TGS\_REQ                                                                                                                          
                                                                                                                                                                              
                            > kdc-options: POSTDATED option                                                                                                                   
                                                                                                                                                                              
                            1.  KDC returns TGS\_REP                                                                                                                          
                                                                                                                                                                              
                            > ticket: service ticket (check existence)                                                                                                        
                            >                                                                                                                                                 
                            > flags: POSTDATED, INVALID set (isCommon2) not set (isKile1)                                                                                     |
| **Requirements covered** | isCommon:                                                                                                                                        
                                                                                                                                                                              
                            1.  It is reset by default; a client MAY request it by setting the ALLOW-POSTDATE option in the KRB\_AS\_REQ message. (\[RFC4120\] section 2.4);  
                                                                                                                                                                              
                            isKile:                                                                                                                                           
                                                                                                                                                                              
                            1.  The POSTDATED/MAY-POSTDATE flag: Postdated tickets SHOULD NOT be supported in KILE. (\[MS-KILE\] section 3.1.5.4)                             |
| **Cleanup**              |                                                                                                                                                  |

#### PROXIABLE/PROXY Flag

|                          |                                                                                                                                                                 |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | PROXIABLE\_PROXY\_Flag                                                                                                                                          |
| **Priority**             | P0                                                                                                                                                              |
| **Description **         | This test case is designed to verify if the proxy tickets can be supported by the KDC.                                                                          |
| **Prerequisites**        |                                                                                                                                                                 |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                                     
                                                                                                                                                                                             
                            > padata: no pre-authentication data                                                                                                                             
                            >                                                                                                                                                                
                            > kdc-options: PROXIABLE option                                                                                                                                  
                                                                                                                                                                                             
                            1.  KDC returns KRB\_ERROR                                                                                                                                       
                                                                                                                                                                                             
                            > error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                       
                            >                                                                                                                                                                
                            > e-data: PA-ENC-TIMESTAMP                                                                                                                                       
                                                                                                                                                                                             
                            1.  Client sends AS request                                                                                                                                      
                                                                                                                                                                                             
                            > padata: PA-ENC-TIMESTAMP                                                                                                                                       
                            >                                                                                                                                                                
                            > kdc-options: PROXIABLE option                                                                                                                                  
                                                                                                                                                                                             
                            1.  KDC returns AS\_REP                                                                                                                                          
                                                                                                                                                                                             
                            > ticket: user TGT (check existence)                                                                                                                             
                            >                                                                                                                                                                
                            > flags: PROXIABLE set (isCommon1) not set (isKile1)                                                                                                             
                                                                                                                                                                                             
                            1.  Client send TGS\_REQ                                                                                                                                         
                                                                                                                                                                                             
                            > kdc-options: PROXY option                                                                                                                                      
                                                                                                                                                                                             
                            1.  KDC returns TGS\_REP                                                                                                                                         
                                                                                                                                                                                             
                            > ticket: service ticket (check existence)                                                                                                                       
                            >                                                                                                                                                                
                            > flags: PROXY set (isCommon2) not set (isKile1)                                                                                                                 |
| **Requirements covered** | isCommon:                                                                                                                                                       
                                                                                                                                                                                             
                            1.  By default, the client will request that it be set when requesting a TGT, and that it be reset when requesting any other ticket. (\[RFC4120\] section 2.5);  
                                                                                                                                                                                             
                            isKile:                                                                                                                                                          
                                                                                                                                                                                             
                            1.  The PROXY/PROXIABLE flag: Proxiable tickets SHOULD NOT be supported in KILE. (\[MS-KILE\] section 3.1.5.4)                                                   |
| **Cleanup**              |                                                                                                                                                                 |

#### FORWARDABLE/FORWARDED Flag

|                          |                                                                                                                                                                                                                                                               |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | FORWARDABLE\_FORWARDED\_Flag                                                                                                                                                                                                                                  |
| **Priority**             | P0                                                                                                                                                                                                                                                            |
| **Description **         | This test case is designed to verify if the forwarded tickets can be supported by the KDC.                                                                                                                                                                    |
| **Prerequisites**        |                                                                                                                                                                                                                                                               |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                           
                            > padata: no pre-authentication data                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                              
                            > kdc-options: FORWARDABLE option                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                           
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                           
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                           
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                           
                            2.  Client sends AS request                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                           
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                           
                                    > kdc-options: FORWARDABLE option                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                           
                            3.  KDC returns AS\_REP                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                           
                            > ticket: user TGT (check existence)                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                              
                            > flags: FORWARDABLE set (isCommon1)                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                           
                            1.  Client send TGS\_REQ                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                           
                            > kdc-options: FORWARDED option                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                           
                            1.  KDC returns TGS\_REP                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                           
                            > ticket: service ticket (check existence)                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                              
                            > flags: FORWARDED set (isCommon2)                                                                                                                                                                                                                             |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                           
                            1.  This flag is reset by default, but users MAY request that it be set by setting the FORWARDABLE option in the AS request when they request their initial TGT. (\[RFC4120\] section 2.6);                                                                    
                                                                                                                                                                                                                                                                                           
                            2.  The FORWARDED flag is set by the TGS when a client presents a ticket with the FORWARDABLE flag set and requests a forwarded ticket by specifying the FORWARDED KDC option and supplying a set of addresses for the new ticket. (\[RFC4120\] section 2.6);  
                                                                                                                                                                                                                                                                                           
                                The FORWARDABLE/FORWARDED flag: Forwarded tickets SHOULD be supported in KILE. (\[MS-KILE\] section 3.1.5.4)                                                                                                                                               |
| **Cleanup**              |                                                                                                                                                                                                                                                               |

#### OK-AS-DELEGATE Flag

|                          |                                                                                                                                                                                                                                                                                                        |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | OK-AS-DELEGATE\_FLAG                                                                                                                                                                                                                                                                                   |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                     |
| **Description **         | This test case is designed to verify if the OK-AS-DELEGATE ticket flag can be supported by the KDC.                                                                                                                                                                                                    |
| **Prerequisites**        | Set local host account as trusted for delegation;                                                                                                                                                                                                                                                      |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                    
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                    
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                    
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                    
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                    
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                    
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                    
                            5.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                    
                            6.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                    
                                1.  flags: OK-AS-DELEGATE (isCommon1)                                                                                                                                                                                                                                                               |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                    
                            1.  The copy of the ticket flags in the encrypted part of the KDC reply may have the OK-AS-DELEGATE flag set to indicate to the client that the server specified in the ticket has been determined by the policy of the realm to be a suitable recipient of the delegation. (\[RFC4120\] section 2.8);  
                                                                                                                                                                                                                                                                                                                                    
                                The OK-AS-DELEGATE flag: The KDC MUST set the OK-AS-DELEGATE flag if the service account is trusted for delegation. (\[MS-KILE\] section 3.1.5.4)                                                                                                                                                   |
| **Cleanup**              | Unset local host account as trusted for delegation;                                                                                                                                                                                                                                                    |

#### Case Sensitive

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Case\_Sensitive                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Description **         | This test case is designed to verify if the KDC is case sensitive or not during the name comparisons, whether users or domains.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Prerequisites**        | Create a user with user name all lower case.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            Domain name in AD all lower case.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > cname: all upper case                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > realm: all upper case                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > sname: all upper case                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > crealm: all lower case (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > realm: all lower case                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > sname: all lower case                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            <!-- -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            2.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > crealm: all lower case (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > sname: all lower case                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > srealm: all lower case                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            1.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            2.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            1.  Name comparisons, whether for users or domains, MUST NOT be case sensitive in KILE. KILE MUST use UTF-8 encoding of these names. Normalization MUST NOT be performed and surrogates MUST NOT be supported. To match names, the GetWindowsSortKey algorithm with the following flags NORM\_IGNORECASE, NORM\_IGNOREKANATYPE, NORM\_IGNORENONSPACE, and NORM\_IGNOREWIDTH SHOULD be used then the CompareSortKey algorithm SHOULD be used to compare the names.Note that this applies only to names; passwords (and the transformation of a password to a key) are governed by the actual key generation specification. (\[MS-KILE\] section 3.1.5.7)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

#### Key Usage Numbers

How to test key usage numbers?

#### Request PAC in TGT

|                          |                                                                                                                                                                                                                                                                                                           |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Request\_PAC\_TGT                                                                                                                                                                                                                                                                                         |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                                                  |
| **Description **         | This test case is designed to verify if the PA-PAC-REQUEST can be supported by the KDC.                                                                                                                                                                                                                   |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                           |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                       
                                1.  padata: PA-PAC-REQUEST (true)                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                       
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                       
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                       
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                       
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                       
                                1.  padata: PA-ENC-TIMESTAMP, PA-PAC-REQUEST (true)                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                       
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                       
                                1.  ticket: user’s TGT                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                       
                                    > authorization-data: PAC (isKile1), initial set of group information (isKile2)                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                       
                            5.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                       
                            6.  KDC return TGS\_REP                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                       
                            > ticket: service ticket                                                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                                                          
                            > authorization-data: PAC (isKile3)                                                                                                                                                                                                                                                                        |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                       
                            1.  They SHOULD request, via the PA-PAC-REQUEST pre-authentication type, that a privilege attribute certificate (PAC) be included in issued tickets. (\[MS-KILE\] section 3.1.5.1);                                                                                                                        
                                                                                                                                                                                                                                                                                                                                       
                            2.  The PAC MUST be generated by the KDC under one of the following conditions:                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                       
                            -   During an Authentication Service (AS) request that has been validated with pre-authentication.                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                       
                            > The KDC MUST collect the user’s initial set of group information and add it to the PAC in the TGT.(\[MS-KILE\] section 3.1.5.11);                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                       
                            1.  The KILE KDC MUST copy the populated fields from the PAC in the TGT to the newly created PAC and, after processing all fields it supports, the KILE KDC MUST generate a new Server Signature and KDC Signature which replace the existing signature fields in the PAC. (\[MS-KILE\] section 3.3.5.4);  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                           |

#### Request no PAC in TGT

|                          |                                                                                                                                                                                                     |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Request\_No\_PAC\_TGT                                                                                                                                                                               |
| **Priority**             | P0                                                                                                                                                                                                  |
| **Description **         | This test case is designed to verify if the KDC can issue a TGT without a PAC explicitly requested by the client.                                                                                   |
| **Prerequisites**        |                                                                                                                                                                                                     |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                    
                                                                                                                                                                                                                                 
                                1.  padata: PA-PAC-REQUEST (false)                                                                                                                                                               
                                                                                                                                                                                                                                 
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                           
                                                                                                                                                                                                                                 
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                      
                                                                                                                                                                                                                                 
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                   
                                                                                                                                                                                                                                 
                            3.  Client sends AS\_REQ                                                                                                                                                                             
                                                                                                                                                                                                                                 
                                1.  padata: PA-PAC-REQUEST(false), PA-ENC-TIMESTAMP                                                                                                                                              
                                                                                                                                                                                                                                 
                            4.  KDC return AS\_REP                                                                                                                                                                               
                                                                                                                                                                                                                                 
                                1.  ticket: user’s TGT (no PAC)                                                                                                                                                                  
                                                                                                                                                                                                                                 
                            > authorization-data: no PAC generated (isKile1)                                                                                                                                                     |
| **Requirements covered** | isKile:                                                                                                                                                                                             
                                                                                                                                                                                                                                 
                            1.  By default, the KDC MUST generate a PAC. However, a client MAY explicitly request that a PAC be excluded through the use of a KERB-PA-PAC-REQUEST PA-DATA type. (\[MS-KILE\] section 3.1.5.11);  |
| **Cleanup**              |                                                                                                                                                                                                     |

#### PAC generation when no PAC in TGT

|                          |                                                                                                                                                                                                                                                                                              |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | PAC\_generation\_when\_noPAC\_in\_TGT                                                                                                                                                                                                                                                        |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                                     |
| **Description **         | This test case is designed to verify if the KDC can issue a service ticket when receiving a TGT with no PAC.                                                                                                                                                                                 |
| **Prerequisites**        | Principal attribute AuthorizationDataNotRequired set to False.                                                                                                                                                                                                                               |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                          
                                1.  padata: PA-PAC-REQUEST (false)                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                          
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                          
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                          
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                          
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                          
                                1.  padata: PA-PAC-REQUEST(false), PA-ENC-TIMESTAMP                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                          
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                          
                                1.  ticket: user’s TGT (no PAC)                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                          
                                    > authorization-data: no PAC generated                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                          
                            5.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                          
                            6.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                          
                            > ticket: service ticket                                                                                                                                                                                                                                                                      
                            >                                                                                                                                                                                                                                                                                             
                            > authorization-data: PAC (isKile1)                                                                                                                                                                                                                                                           |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                          
                            1.  If a TGS request includes a TGT without a PAC, the KDC SHOULD add a PAC before issuing the service ticket. This occurs when the TGT was issued by a pure realm that is trusted by the domain. The PAC MUST be inserted when there is a mapping to a domain user. (\[MS-KILE\] 3.3.5.4.2)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                              |

#### PAC generation when client has local groups

|                          |                                                                                                                                                                                               |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | PAC\_generation\_when\_client\_has\_local\_groups                                                                                                                                             |
| **Priority**             | P0 (BVT)                                                                                                                                                                                      |
| **Description **         | This test case is designed to verify if the KDC can generate a PAC in a service ticket when client has domain local groups.                                                                   |
| **Prerequisites**        | Principal attribute AuthorizationDataNotRequired set to False.                                                                                                                                |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                              
                                                                                                                                                                                                                           
                                1.  padata: PA-PAC-REQUEST (true)                                                                                                                                                          
                                                                                                                                                                                                                           
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                     
                                                                                                                                                                                                                           
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                
                                                                                                                                                                                                                           
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                             
                                                                                                                                                                                                                           
                            3.  Client sends AS\_REQ                                                                                                                                                                       
                                                                                                                                                                                                                           
                                1.  padata: PA-PAC-REQUEST(true), PA-ENC-TIMESTAMP                                                                                                                                         
                                                                                                                                                                                                                           
                            4.  KDC return AS\_REP                                                                                                                                                                         
                                                                                                                                                                                                                           
                                1.  ticket: user’s TGT (PAC)                                                                                                                                                               
                                                                                                                                                                                                                           
                                    > authorization-data: PAC generated, initial set of group information                                                                                                                  
                                                                                                                                                                                                                           
                            5.  Client sends TGS\_REQ                                                                                                                                                                      
                                                                                                                                                                                                                           
                            6.  KDC returns TGS\_REP                                                                                                                                                                       
                                                                                                                                                                                                                           
                            > ticket: service ticket                                                                                                                                                                       
                            >                                                                                                                                                                                              
                            > authorization-data: PAC updated comparing with the PAC received in user’s TGT, add domain local groups information in PAC (isKile1)                                                          |
| **Requirements covered** | isKile:                                                                                                                                                                                       
                                                                                                                                                                                                                           
                            1.  The PAC MUST be generated by the KDC under one of the following conditions:                                                                                                                
                                                                                                                                                                                                                           
                                During a TGS request when the client has domain local groups.                                                                                                                              
                                                                                                                                                                                                                           
                                The PAC MUST be subsequently updated when the client requests a service ticket to contain additional domain local groups that are specific to the server’s domain. (\[MS-KILE\] 3.1.5.11)  |
| **Cleanup**              |                                                                                                                                                                                               |

#### Locate a DS\_BEHAVIOR\_WIN8 DC

|                          |                                                                                                                          |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Locate a DS\_BEHAVIOR\_WIN8 DC                                                                                           |
| **Priority**             | P1                                                                                                                       |
| **Description **         | This test case is designed to verify if a Win8 KDC can be successfully reached.                                          |
| **Prerequisites**        |                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends DsrGetDcNameEx2 (                                                                                       
                                                                                                                                                      
                            > AccountName = client account name,                                                                                      
                            >                                                                                                                         
                            > AllowableAccountControlBits = A, B, C, D, E, F,                                                                         
                            >                                                                                                                         
                            > DomainName = client domain name,                                                                                        
                            >                                                                                                                         
                            > Flags = G, H, U,                                                                                                        
                            >                                                                                                                         
                            > All other fields = NULL,                                                                                                
                            >                                                                                                                         
                            > )                                                                                                                       
                                                                                                                                                      
                            1.  KDC returns IP address (isKile1)                                                                                      
                                                                                                                                                      
                            > in DomainControllerInfo.DomainControllerAddress                                                                         |
| **Requirements covered** | isKile:                                                                                                                  
                                                                                                                                                      
                            1.  When a DS\_BEHAVIOR\_WIN8 domain controller is required, DsrGetDcNameEx2 is called... (\[MS-KILE\] section 3.1.5.13)  |
| **Cleanup**              |                                                                                                                          |

#### DelegationNotAllowed

|                          |                                                                                                                                                                 |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | DelegationNotAllowed                                                                                                                                            |
| **Priority**             | P0                                                                                                                                                              |
| **Description **         |                                                                                                                                                                 |
| **Prerequisites**        | Set the user account as DelegationNotAllowed;                                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                                     
                                                                                                                                                                                             
                                1.  kdc-options: PROXIABLE and FORWARDABLE options                                                                                                           
                                                                                                                                                                                             
                            2.  KDC returns KRB\_ERROR                                                                                                                                       
                                                                                                                                                                                             
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                 
                                                                                                                                                                                             
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                               
                                                                                                                                                                                             
                            3.  Client sends AS request                                                                                                                                      
                                                                                                                                                                                             
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                 
                                                                                                                                                                                             
                                    > kdc-options: PROXIABLE or FORWARDABLE options                                                                                                          
                                                                                                                                                                                             
                            4.  KDC returns AS\_REP                                                                                                                                          
                                                                                                                                                                                             
                            > flags: PROXIABLE and FORWARDABLE not set (isKile1) set (isCommon1)                                                                                             |
| **Requirements covered** | isKile:                                                                                                                                                         
                                                                                                                                                                                             
                            1.  If DelegationNotAllowed is set to TRUE on the principal, the KILE KDC MUST NOT issue a PROXIALBE or FORWARDABLE ticket flags. (\[MS-KILE\] section 3.3.5.1)  |
| **Cleanup**              |                                                                                                                                                                 |

#### TrustedForDelegation

|                          |                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | TrustedForDelegation                                                                                                                             |
| **Priority**             | P0                                                                                                                                               |
| **Description **         |                                                                                                                                                  |
| **Prerequisites**        | Set the user account as TrustedForDelegation;                                                                                                    |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                      
                                                                                                                                                                              
                            2.  KDC returns KRB\_ERROR                                                                                                                        
                                                                                                                                                                              
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                  
                                                                                                                                                                              
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                
                                                                                                                                                                              
                            3.  Client sends AS request                                                                                                                       
                                                                                                                                                                              
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                  
                                                                                                                                                                              
                            4.  KDC returns AS\_REP                                                                                                                           
                                                                                                                                                                              
                            > flags: OK-AS-DELEGATE (isKile1)                                                                                                                 |
| **Requirements covered** | isKile:                                                                                                                                          
                                                                                                                                                                              
                            1.  If TrustedForDelegation is set to TRUE on the principal, the KILE KDC MUST set the OK-AS-DELEGATE ticket flag. (\[MS-KILE\] section 3.3.5.1)  |
| **Cleanup**              |                                                                                                                                                  |

#### WithoutUPN

|                          |                                                                                                                                                                                                                                                                                                    |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | WithoutUPN                                                                                                                                                                                                                                                                                         |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                 |
| **Description **         |                                                                                                                                                                                                                                                                                                    |
| **Prerequisites**        | Set the user account as no UPN;                                                                                                                                                                                                                                                                    |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                
                            3.  Client sends AS request                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                
                            > ticket: user TGT                                                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                                                   
                            > authorization-data: UPN\_DNS\_INFO with \*\*\*@\*\*\* constructed (isKile1)                                                                                                                                                                                                                       |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                
                            1.  If the user account object does not have the userPrincipalName attribute set, the KDC SHOULD send a UPN\_DNS\_INFO structure containing a user principal name (UPN), constructed by concatenating the user name, the "@" symbol, and the DNS name of the domain. (\[MS-KILE\] section 3.3.5.2)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                    |

#### Pre-AuthenticationNotRequired

|                          |                                                                                                                                                                                   |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Pre-AuthenticationNotRequired                                                                                                                                                     |
| **Priority**             | P0 (BVT)                                                                                                                                                                          |
| **Description **         |                                                                                                                                                                                   |
| **Prerequisites**        | Set Pre-AuthenticationNotRequired to TRUE for the user account;                                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                  
                                                                                                                                                                                                               
                            > padata: nothing                                                                                                                                                                  
                                                                                                                                                                                                               
                            1.  cname: &lt;username&gt;                                                                                                                                                        
                                                                                                                                                                                                               
                            <!-- -->                                                                                                                                                                           
                                                                                                                                                                                                               
                            1.  KDC return AS\_REP                                                                                                                                                             
                                                                                                                                                                                                               
                                1.  ticket: user’s TGT (verify existence) (isKile1)                                                                                                                            |
| **Requirements covered** | isKile:                                                                                                                                                                           
                                                                                                                                                                                                               
                            1.  If Pre-AuthenticationNotRequired is set to TRUE on the principal, the KDC MUST issue a TGT without validating pre-authentication data provided. (\[MS-KILE\] section 3.3.5.3)  |

#### KERB\_VALIDATION\_INFO

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | KERB\_VALIDATION\_INFO                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Description **         | This test case is designed to verify if the KDC supports a KERB\_VALIDATION\_INFO PAC data.                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                1.  padata: PA-PAC-REQUEST (true)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                1.  padata: PA-PAC-REQUEST(true), PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                1.  ticket: user’s TGT (PAC)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                    > authorization-data: KERB\_VALIDATION\_INFO (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            5.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            6.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            > ticket: service ticket                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > authorization-data: KERB\_VALIDATION\_INFO (isKile2)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            1.  For KILE implementations that use an Active Directory for the account database, KDCs SHOULD retrieve the following attributes from local directory service instance with the same processing rules as defined in …(\[MS-KILE\] 3.3.5.6.3.1);                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            2.  The KDC populates the returned KERB\_VALIDATION\_INFO structure fields as follows: …(\[MS-KILE\] 3.3.5.6.3.1);                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            > 1. Convert the local machine time into an offset from the beginning of the week (as defined in \[MS-SAMR\] section 2.2.7.5). This conversion must use the same granularity as the UnitsPerWeek field of the Buffer.SAMPR\_USER\_ALL\_INFORMATION.LogonHours field (\[MS-SAMR\] section 2.2.7.1) or the Buffer.SAMPR\_USER\_ALL\_INFORMATION.AccountExpires field (\[MS-SAMR\] section 2.2.7.1) of the SamrQueryInformationUser2 (\[MS-SAMR\] section 3.1.5.5.5) response message.                                                   
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > 2. Starting at the offset determined in step 1, examine the remaining entries in the Buffer.SAMPR\_USER\_ALL\_INFORMATION.LogonHours. If the value at the initial offset is disabled for authentication, the KDC MUST return Kerb Error KDC\_ERROR\_CLIENT\_REVOKED with status code STATUS\_INVALID\_LOGON\_HOURS. If none of the remaining entries are disabled, use the time stamp value 0x7FFFFFFFFFFFFFFF. Otherwise, compute a time stamp by adding the offset of the next disabled authentication unit to the current time.  
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > 3. Set the LogoffTime field to the lesser of the value determined in step 2 and the value of the Buffer.SAMPR\_USER\_ALL\_INFORMATION.AccountExpires field of the SamrQueryInformationUser2 (\[MS-SAMR\] section 3.1.5.5.5) response message.                                                                                                                                                                                                                                                                                       |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |

#### PAC\_CLIENT\_INFO

|                          |                                                                                                               |
|--------------------------|---------------------------------------------------------------------------------------------------------------|
| **Test ID**              | PAC\_CLIENT\_INFO                                                                                             |
| **Priority**             | P0                                                                                                            |
| **Description **         | This test case is designed to verify if the KDC supports a PAC\_CLIENT\_INFO PAC data.                        |
| **Prerequisites**        |                                                                                                               |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                              
                                                                                                                                           
                                1.  padata: PA-PAC-REQUEST (true)                                                                          
                                                                                                                                           
                            2.  KDC returns KRB\_ERROR                                                                                     
                                                                                                                                           
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                
                                                                                                                                           
                                    > e-data: PA-ENC-TIMESTAMP                                                                             
                                                                                                                                           
                            3.  Client sends AS\_REQ                                                                                       
                                                                                                                                           
                                1.  padata: PA-PAC-REQUEST(true), PA-ENC-TIMESTAMP                                                         
                                                                                                                                           
                            4.  KDC return AS\_REP                                                                                         
                                                                                                                                           
                                1.  ticket: user’s TGT (PAC)                                                                               
                                                                                                                                           
                                    > authorization-data: PAC\_CLIENT\_INFO (isKile1)                                                      
                                                                                                                                           
                            5.  Client sends TGS\_REQ                                                                                      
                                                                                                                                           
                            6.  KDC returns TGS\_REP                                                                                       
                                                                                                                                           
                            > ticket: service ticket                                                                                       
                            >                                                                                                              
                            > authorization-data: PAC\_CLIENT\_INFO (isKile1)                                                              |
| **Requirements covered** | isKile:                                                                                                       
                                                                                                                                           
                            1.  The KDC populates the returned PAC\_CLIENT\_INFO structure fields as follows: …(\[MS-KILE\] 3.3.5.3.2.2);  |
| **Cleanup**              |                                                                                                               |

#### Server Signature

|                          |                                                                                                                                                                                                                                                                                                                                        |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Server Signature                                                                                                                                                                                                                                                                                                                       |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                     |
| **Description **         | This test case is designed to verify if the KDC supports a PAC\_SIGNATURE\_DATA PAC data.                                                                                                                                                                                                                                              |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                                        |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                    
                                1.  padata: PA-PAC-REQUEST (true)                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                    
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                    
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                    
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                    
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                    
                                1.  padata: PA-PAC-REQUEST(true), PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                    
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                    
                                1.  ticket: user’s TGT (PAC)                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                    
                                    > authorization-data: PAC\_SIGNATURE\_DATA (isKile1)                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                    
                            5.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                    
                            6.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                    
                            > ticket: service ticket                                                                                                                                                                                                                                                                                                                
                            >                                                                                                                                                                                                                                                                                                                                       
                            > authorization-data: PAC\_SIGNATURE\_DATA (isKile2)                                                                                                                                                                                                                                                                                    |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                    
                            1.  The KDC creates a keyed has of the entire PAC message with the Signature fields of both PAC\_SIGNATURE\_DATA structures set to zero using the server account key with the strongest cryptography that the domain supports and populates the returned PAC\_SIGNATURE\_DATA structure fields as follows: …(\[MS-KILE\] 3.3.5.3.2.3);  
                                                                                                                                                                                                                                                                                                                                                                    
                            2.  The KILE KDC MUST copy the populated fields from the PAC in the TGT to the newly created PAC and, after processing all fields it supports, the KILE KDC MUST generate a new Server Signature and KDC Signature which replace the existing signature fields in the PAC. (\[MS-KILE\] section 3.3.5.4);                               |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                        |

#### KDC Signature

|                          |                                                                                                                                                                                                                                                                                                           |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | KDC Signature                                                                                                                                                                                                                                                                                             |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                        |
| **Description **         | This test case is designed to verify if the KDC supports a PAC\_SIGNATURE\_DATA PAC data.                                                                                                                                                                                                                 |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                           |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                       
                                1.  padata: PA-PAC-REQUEST (true)                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                       
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                       
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                       
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                       
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                       
                                1.  padata: PA-PAC-REQUEST(true), PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                       
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                       
                                1.  ticket: user’s TGT (PAC)                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                       
                                    > authorization-data: PAC\_SIGNATURE\_DATA (isKile1)                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                       
                            5.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                       
                            6.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                       
                            > ticket: service ticket                                                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                                                          
                            > authorization-data: PAC\_SIGNATURE\_DATA (isKile2)                                                                                                                                                                                                                                                       |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                       
                            1.  The KDC creates a keyed has of the Server Signature field using the strongest "krbtgt" account key and populates the returned PAC\_SIGNATURE\_DATA structure fields as follows: …(\[MS-KILE\] 3.3.5.3.2.4);                                                                                            
                                                                                                                                                                                                                                                                                                                                       
                            2.  The KILE KDC MUST copy the populated fields from the PAC in the TGT to the newly created PAC and, after processing all fields it supports, the KILE KDC MUST generate a new Server Signature and KDC Signature which replace the existing signature fields in the PAC. (\[MS-KILE\] section 3.3.5.4);  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                           |

#### UPN\_DNS\_INFO

|                          |                                                                                                                                                                                                                                                                                            |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | UPN\_DNS\_INFO                                                                                                                                                                                                                                                                             |
| **Priority**             | P0                                                                                                                                                                                                                                                                                         |
| **Description **         | This test case is designed to verify if the KDC supports a UPN\_DNS\_INFO PAC data.                                                                                                                                                                                                        |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                            |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                        
                                1.  padata: PA-PAC-REQUEST (true)                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                        
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                        
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                        
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                        
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                        
                                1.  padata: PA-PAC-REQUEST(true), PA-ENC-TIMESTAMP                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                        
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                        
                                1.  ticket: user’s TGT (PAC)                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                        
                                    > authorization-data: UPN\_DNS\_INFO (isKile1)                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                        
                            5.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                        
                            6.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                        
                            > ticket: service ticket                                                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                           
                            > authorization-data: UPN\_DNS\_INFO (isKile1)                                                                                                                                                                                                                                              |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                        
                            1.  The KDC populates the returned UPN\_DNS\_INFO structure field as follows: …(\[MS-KILE\] 3.3.5.3.2.5);                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                        
                                The KDC inserts the DNS and UPN information after the UPN\_DNS\_INFO structure following the header and starting with the corresponding offset in a consecutive buffer. The UPN and FQDN are encoded using a two-byte UTF16 scheme, in little-endian order. (\[MS-KILE\] 3.3.5.3.2.5);  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                            |

#### Account Disabled

|                          |                                                                                                                                                                                                                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Account\_Disabled                                                                                                                                                                                                                                                                                                                                |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                               |
| **Description **         | This test case is designed to verify if the KDC support checking the account policy for every ticket request.                                                                                                                                                                                                                                    |
| **Prerequisites**        | Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            Set POLICY\_KERBEROS\_VALIDATE\_CLIENT bit in the AuthenticationOptions.                                                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                              
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                              
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                              
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                              
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                              
                            5.  Disable user account (can we do this before getting the TGT?)                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                              
                            6.  Client sends TGS\_REP                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                              
                            7.  KDC returns KDC\_ERR\_CLIENT\_REVOKED (isKile1)                                                                                                                                                                                                                                                                                               |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              
                            1.  If the POLICY\_KERBEROS\_VALIDATE\_CLIENT bit is set in the AuthenticationOptions setting on the KDC then KILE will enforce revocation on the KDCs. When this property is set on the KDC for the client’s domain, and the TGT is older than an implementation specific time, the KDC MUST verify that the account is still in good standing.  
                                                                                                                                                                                                                                                                                                                                                                              
                            -   If Disable is TRUE, then the KDC MUST return KDC\_ERR\_CLIENT\_REVOKED.                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                              
                                (\[MS-KILE\] section3.3.5.4.1);                                                                                                                                                                                                                                                                                                               |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                  |

#### Account Expired

|                          |                                                                                                                                                                                                                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Account\_Expired                                                                                                                                                                                                                                                                                                                                 |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                               |
| **Description **         | This test case is designed to verify if the KDC support checking the account policy for every ticket request.                                                                                                                                                                                                                                    |
| **Prerequisites**        | Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            Set POLICY\_KERBEROS\_VALIDATE\_CLIENT bit in the AuthenticationOptions.                                                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                              
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                              
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                              
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                              
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                              
                            5.  Expire user account                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                              
                            6.  Client sends TGS\_REP                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                              
                            7.  KDC returns KDC\_ERR\_CLIENT\_REVOKED (isKile1)                                                                                                                                                                                                                                                                                               |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              
                            1.  If the POLICY\_KERBEROS\_VALIDATE\_CLIENT bit is set in the AuthenticationOptions setting on the KDC then KILE will enforce revocation on the KDCs. When this property is set on the KDC for the client’s domain, and the TGT is older than an implementation specific time, the KDC MUST verify that the account is still in good standing.  
                                                                                                                                                                                                                                                                                                                                                                              
                            -   If Expire is TRUE, then the KDC MUST return KDC\_ERR\_CLIENT\_REVOKED.                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                              
                                (\[MS-KILE\] section3.3.5.4.1);                                                                                                                                                                                                                                                                                                               |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                  |

#### Account Locked

|                          |                                                                                                                                                                                                                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Account\_Locked                                                                                                                                                                                                                                                                                                                                  |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                               |
| **Description **         | This test case is designed to verify if the KDC support checking the account policy for every ticket request.                                                                                                                                                                                                                                    |
| **Prerequisites**        | Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            Set POLICY\_KERBEROS\_VALIDATE\_CLIENT bit in the AuthenticationOptions.                                                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                              
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                              
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                              
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                              
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                              
                            5.  Lock user account                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                              
                            6.  Client sends TGS\_REP                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                              
                            7.  KDC returns KDC\_ERR\_CLIENT\_REVOKED (isKile1)                                                                                                                                                                                                                                                                                               |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              
                            1.  If the POLICY\_KERBEROS\_VALIDATE\_CLIENT bit is set in the AuthenticationOptions setting on the KDC then KILE will enforce revocation on the KDCs. When this property is set on the KDC for the client’s domain, and the TGT is older than an implementation specific time, the KDC MUST verify that the account is still in good standing.  
                                                                                                                                                                                                                                                                                                                                                                              
                            -   If Locked is TRUE, then the KDC MUST return KDC\_ERR\_CLIENT\_REVOKED.                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                              
                                (\[MS-KILE\] section3.3.5.4.1);                                                                                                                                                                                                                                                                                                               |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                  |

#### Account Out of Logon Hours

|                          |                                                                                                                                                                                                                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Account\_Out\_of\_Logon\_Hours                                                                                                                                                                                                                                                                                                                   |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                               |
| **Description **         | This test case is designed to verify if the KDC support checking the account policy for every ticket request.                                                                                                                                                                                                                                    |
| **Prerequisites**        | Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            Set POLICY\_KERBEROS\_VALIDATE\_CLIENT bit in the AuthenticationOptions.                                                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                              
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                              
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                              
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                              
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                              
                            5.  Set the LogonHours for user account not include the current time.                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                              
                            6.  Client sends TGS\_REP                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                              
                            7.  KDC returns KDC\_ERR\_CLIENT\_REVOKED (isKile1)                                                                                                                                                                                                                                                                                               |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              
                            1.  If the POLICY\_KERBEROS\_VALIDATE\_CLIENT bit is set in the AuthenticationOptions setting on the KDC then KILE will enforce revocation on the KDCs. When this property is set on the KDC for the client’s domain, and the TGT is older than an implementation specific time, the KDC MUST verify that the account is still in good standing.  
                                                                                                                                                                                                                                                                                                                                                                              
                            -   If current time is not within the LogonHours, then the KDC MUST return KDC\_ERR\_CLIENT\_REVOKED.                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                              
                                (\[MS-KILE\] section3.3.5.4.1);                                                                                                                                                                                                                                                                                                               |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                  |

#### Account PasswordMustChange - 1

|                          |                                                                                                                                                                                                                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Account\_PasswordMustChange\_1                                                                                                                                                                                                                                                                                                                   |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                               |
| **Description **         | This test case is designed to verify if the KDC support checking the account policy for every ticket request.                                                                                                                                                                                                                                    |
| **Prerequisites**        | Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            Set POLICY\_KERBEROS\_VALIDATE\_CLIENT bit in the AuthenticationOptions.                                                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                              
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                              
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                              
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                              
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                              
                            5.  Set PasswordMustChange time a time in the past                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            6.  Client sends TGS\_REP                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                              
                            7.  KDC returns KDC\_ERR\_KEY\_EXPIRED (isKile1)                                                                                                                                                                                                                                                                                                  |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              
                            1.  If the POLICY\_KERBEROS\_VALIDATE\_CLIENT bit is set in the AuthenticationOptions setting on the KDC then KILE will enforce revocation on the KDCs. When this property is set on the KDC for the client’s domain, and the TGT is older than an implementation specific time, the KDC MUST verify that the account is still in good standing.  
                                                                                                                                                                                                                                                                                                                                                                              
                            -   If the PasswordMustChange is in the past, then the KDC MUST return KDC\_ERR\_KEY\_EXPIRED.                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                              
                                (\[MS-KILE\] section3.3.5.4.1);                                                                                                                                                                                                                                                                                                               |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                  |

#### Account PasswordMustChange - 2

|                          |                                                                                                                                                                                                                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Account\_PasswordMustChange\_2                                                                                                                                                                                                                                                                                                                   |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                               |
| **Description **         | This test case is designed to verify if the KDC support checking the account policy for every ticket request.                                                                                                                                                                                                                                    |
| **Prerequisites**        | Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            Set POLICY\_KERBEROS\_VALIDATE\_CLIENT bit in the AuthenticationOptions.                                                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                              
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                              
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                              
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                              
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                              
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                              
                            5.  Set PasswordMustChange time to 0                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                              
                            6.  Client sends TGS\_REP                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                              
                            7.  KDC returns KDC\_ERR\_KEY\_EXPIRED (isKile1)                                                                                                                                                                                                                                                                                                  |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              
                            1.  If the POLICY\_KERBEROS\_VALIDATE\_CLIENT bit is set in the AuthenticationOptions setting on the KDC then KILE will enforce revocation on the KDCs. When this property is set on the KDC for the client’s domain, and the TGT is older than an implementation specific time, the KDC MUST verify that the account is still in good standing.  
                                                                                                                                                                                                                                                                                                                                                                              
                            -   If the PasswordMustChange is zero, then the KDC MUST return KDC\_ERR\_KEY\_EXPIRED.                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                              
                                (\[MS-KILE\] section3.3.5.4.1);                                                                                                                                                                                                                                                                                                               |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                  |

#### Mapping Users with Principals

|                          |                                                                                                                                                                                                                   |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Mapping\_Users\_with\_Principals                                                                                                                                                                                  |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                          |
| **Description **         |                                                                                                                                                                                                                   |
| **Prerequisites**        | Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                                 
                                                                                                                                                                                                                                               
                            Set AuthorizationDataNotRequired to FALSE for the application server (local host)’s account;                                                                                                                       
                                                                                                                                                                                                                                               
                            Map the &lt;username2&gt; user account with a principal host/&lt;hostname&gt;;                                                                                                                                     
                                                                                                                                                                                                                                               
                            (Need validate correction)                                                                                                                                                                                         |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                  
                                                                                                                                                                                                                                               
                                1.  padata: PA-PAC-REQUEST (false)                                                                                                                                                                             
                                                                                                                                                                                                                                               
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                         
                                                                                                                                                                                                                                               
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                    
                                                                                                                                                                                                                                               
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                 
                                                                                                                                                                                                                                               
                            3.  Client sends AS\_REQ                                                                                                                                                                                           
                                                                                                                                                                                                                                               
                                1.  padata: PA-PAC-REQUEST(false), PA-ENC-TIMESTAMP                                                                                                                                                            
                                                                                                                                                                                                                                               
                                    > cname: &lt;username1&gt;                                                                                                                                                                                 
                                                                                                                                                                                                                                               
                            4.  KDC return AS\_REP                                                                                                                                                                                             
                                                                                                                                                                                                                                               
                                1.  ticket: user’s TGT (no PAC)                                                                                                                                                                                
                                                                                                                                                                                                                                               
                                    > cname: &lt;username1&gt;                                                                                                                                                                                 
                                                                                                                                                                                                                                               
                                    > authorization-data: no PAC generated                                                                                                                                                                     
                                                                                                                                                                                                                                               
                            5.  Client sends TGS\_REQ                                                                                                                                                                                          
                                                                                                                                                                                                                                               
                            > cname: &lt;username1&gt;                                                                                                                                                                                         
                                                                                                                                                                                                                                               
                            1.  KDC returns TGS\_REP                                                                                                                                                                                           
                                                                                                                                                                                                                                               
                            > ticket: service ticket (include PAC)                                                                                                                                                                             
                            >                                                                                                                                                                                                                  
                            > cname: &lt;username2&gt; (isKile1)                                                                                                                                                                               
                            >                                                                                                                                                                                                                  
                            > authorization-data: PAC generated according to the mapped user account.                                                                                                                                          |
| **Requirements covered** | isKile:                                                                                                                                                                                                           
                                                                                                                                                                                                                                               
                            1.  If the KDC is configured locally to map principals in the realm to accounts based on name. In this case, the KDC MUST search the mapping for a principal with the same name. (\[MS-KILE\] section 3.3.5.4.2);  |
| **Cleanup**              |                                                                                                                                                                                                                   |

#### Domain Local Group Membership with Resource\_SID\_Compression

|                          |                                                                                                                                                                                                                                                                                                   |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Domain\_Local\_Group\_Membership\_with\_Resource\_SID\_Compression                                                                                                                                                                                                                                |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                |
| **Description **         |                                                                                                                                                                                                                                                                                                   |
| **Prerequisites**        | Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                               
                            Create a &lt;testgroup&gt; group in the “contoso.com” domain;                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                               
                            Add the &lt;username&gt; to &lt;testgroup&gt;;                                                                                                                                                                                                                                                     |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                               
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                               
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                               
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                               
                            3.  Client sends AS request                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                               
                            4.  KDC return AS response                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                               
                                1.  ticket: user’s TGT (no PAC)                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                               
                                    > authorization-data: PAC generated (no group membership information)                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                               
                            5.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                               
                            6.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                               
                            > ticket: service ticket (include PAC)                                                                                                                                                                                                                                                             
                            >                                                                                                                                                                                                                                                                                                  
                            > authorization-data: PAC generated (group membership information) (isKile1) (isKile2)                                                                                                                                                                                                             |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                               
                            1.  Groups can be created so that they are only visible to servers in the same domain. For every service ticket that is issued during a TGS request, except for cross-realm TGTs, the KDC MUST populate the PAC with domain local group membership for the user. (\[MS-KILE\] section 3.3.5.4.3);  
                                                                                                                                                                                                                                                                                                                               
                            2.  If the Resource SID compression disabled bit is NOT set in the Application Server’s service account’s KerbSupportedEncryptionTypes: … (\[MS-KILE\] section 3.3.5.4.3);                                                                                                                         |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                   |

#### Domain Local Group Membership with Disable Resource SID compression

|                          |                                                                                                                                                                                                                                                                                                   |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Domain\_Local\_Group\_Membership\_with\_Disable\_Resource\_SID\_Compression                                                                                                                                                                                                                       |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                |
| **Description **         |                                                                                                                                                                                                                                                                                                   |
| **Prerequisites**        | Join client computer to the “contoso.com” domain;                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                               
                            Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                               
                            Create a &lt;testgroup&gt; group in the “contoso.com” domain;                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                               
                            Add the &lt;username&gt; to &lt;testgroup&gt;;                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                               
                            Set attribute msDS-SupportedEncryptionTypes to 0x8001C for the host/&lt;clientcomputername&gt;.contoso.com object in AD;                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                               
                            (Set Resource SID compression disabled bit on AP’s service account.)                                                                                                                                                                                                                               |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                               
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                               
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                               
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                               
                                1.  ticket: user’s TGT (no PAC)                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                               
                                    > authorization-data: PAC generated (no group membership information)                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                               
                            5.  Client send TGS request                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                               
                            6.  KDC returns TGS response                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                               
                            > ticket: PAC, According to Resource SID compression disabled bit set (isKile1)                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                                  
                            > authorization-data: SidCount, ExtraSids, Attributes (isKile2)                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                                  
                            > enc-padata: PA-SUPPORTED-ENCTYPES =0x8001C                                                                                                                                                                                                                                                       |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                               
                            1.  Groups can be created so that they are only visible to servers in the same domain. For every service ticket that is issued during a TGS request, except for cross-realm TGTs, the KDC MUST populate the PAC with domain local group membership for the user. (\[MS-KILE\] section 3.3.5.4.3);  
                                                                                                                                                                                                                                                                                                                               
                            2.  If the Resource SID compression disabled bit is NOT set in the Application Server’s service account’s KerbSupportedEncryptionTypes: …                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                               
                                Otherwise: … (\[MS-KILE\] section 3.3.5.4.3);                                                                                                                                                                                                                                                  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                   |

#### User Preauthentication fail with DES as crypto

|                          |                                                                                                                                                                                                                                                             |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | UserAccount\_DES\_PreAuthentication\_Fail                                                                                                                                                                                                                   |
| **Priority**             | P0                                                                                                                                                                                                                                                          |
| **Description **         | By adding domain controller protection, weak authentication data is no longer usable. Test interactive logon behavior with Kerberos initial authentication with weak crypto                                                                                 |
| **Prerequisites**        | DC DFL&gt;=6                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                         
                            Domain user testsilo04                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                         
                            Not a member of Protected Users group                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                         
                            usedesonly= false                                                                                                                                                                                                                                            |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                         
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                         
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                         
                                    > e-data: AES256                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                         
                                    > padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                         
                            3.  client sends AS\_REQ                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                         
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                         
                            > pre-authentication used DES                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                         
                            1.  KDC returns KDC\_ERR\_ETYPE\_NOTSUPP                                                                                                                                                                                                                     |
| **Requirements covered** | 3.3.5.6 AS Exchange                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                            
                            > If domainControllerFunctionality returns a value &gt;= 6 (\[MS-ADTS\] section 3.1.1.3.2.25), the KDC MUST check whether the account is a member of PROTECTED\_USERS (\[MS-DTYP\] section 2.4.2.4). If it is a member of PROTECTED\_USERS, then:&lt;50&gt;  
                            >                                                                                                                                                                                                                                                            
                            >  If pre-authentication used DES or RC4, the KDC MUST return KDC\_ERR\_POLICY.                                                                                                                                                                             |
| **Cleanup**              |                                                                                                                                                                                                                                                             |

#### Computer Preauthentication fail with DES as crypto

|                          |                                                                                                                                                                                                                                                             |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ComputerAccount\_DES\_PreAuthentication\_Fail                                                                                                                                                                                                               |
| **Priority**             | P0                                                                                                                                                                                                                                                          |
| **Description **         | By adding domain controller protection, weak authentication data is no longer usable. Test interactive logon behavior with Kerberos initial authentication with weak crypto                                                                                 |
| **Prerequisites**        | DC DFL&gt;=6                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                         
                            Domain user testsilo04                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                         
                            Not a member of Protected Users group                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                         
                            usedesonly= false                                                                                                                                                                                                                                            |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                         
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                         
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                         
                                    > e-data: AES256                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                         
                                    > padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                         
                            3.  client sends AS\_REQ                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                         
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                         
                            > pre-authentication used DES                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                         
                            1.  KDC returns KDC\_ERR\_ETYPE\_NOTSUPP                                                                                                                                                                                                                     |
| **Requirements covered** | 3.3.5.6 AS Exchange                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                            
                            > If domainControllerFunctionality returns a value &gt;= 6 (\[MS-ADTS\] section 3.1.1.3.2.25), the KDC MUST check whether the account is a member of PROTECTED\_USERS (\[MS-DTYP\] section 2.4.2.4). If it is a member of PROTECTED\_USERS, then:&lt;50&gt;  
                            >                                                                                                                                                                                                                                                            
                            >  If pre-authentication used DES or RC4, the KDC MUST return KDC\_ERR\_POLICY.                                                                                                                                                                             |
| **Cleanup**              |                                                                                                                                                                                                                                                             |

1.  ### FAST

    1.  #### Normal

|                          |                                                                                                                          |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Normal                                                                                                                   |
| **Priority**             | P0 (BVT)                                                                                                                 |
| **Description **         | This test case is designed to go through the whole process with default settings.                                        |
| **Prerequisites**        | Join client computer to the “contoso.com” domain;                                                                        
                                                                                                                                                      
                            Create &lt;username&gt; user account in the “contoso.com” domain;                                                         
                                                                                                                                                      
                            Set registry key ClaimsCompIdFASTSupport to 2 on the KDC (don’t use group policy).                                        
                                                                                                                                                      
                            Set attribute msDS-SupportedEncryptionTypes to 0x1001C for the krbtgt/contoso.com object in AD;                           
                                                                                                                                                      
                            Set attribute msDS-SupportedEncryptionTypes to 0x1001C for the host/&lt;clientcomputername&gt;.contoso.com object in AD;  
                                                                                                                                                      
                            Purge ticket cache on client computer;                                                                                    |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                 
                                                                                                                                                      
                            2.  KDC returns KRB\_ERROR                                                                                                
                                                                                                                                                      
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                          
                                                                                                                                                      
                            3.  Client sends AS\_REQ                                                                                                  
                                                                                                                                                      
                            4.  KDC return AS\_REP                                                                                                    
                                                                                                                                                      
                                1.  ticket: computer’s TGT                                                                                            
                                                                                                                                                      
                                    > enc-padata: PA-SUPPORTED-ENCTYPES(FAST)                                                                         
                                                                                                                                                      
                            5.  Client sends FAST AS\_REQ                                                                                             
                                                                                                                                                      
                            6.  KDC returns KRB\_ERROR                                                                                                
                                                                                                                                                      
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                          
                                                                                                                                                      
                            7.  Client sends FAST AS\_REQ                                                                                             
                                                                                                                                                      
                            8.  KDC return FAST AS\_REP                                                                                               
                                                                                                                                                      
                                1.  ticket: user’s TGT                                                                                                
                                                                                                                                                      
                                    > enc-padata: PA-SUPPORTED-ENCTYPES(FAST)                                                                         
                                                                                                                                                      
                            9.  Client send FAST TGS request                                                                                          
                                                                                                                                                      
                            10. KDC returns FAST TGS response                                                                                         
                                                                                                                                                      
                            > ticket: service ticket                                                                                                  
                            >                                                                                                                         
                            > enc-padata: PA-SUPPORTED-ENCTYPES(FAST)                                                                                 |
| **Requirements covered** |                                                                                                                          |
| **Cleanup**              |                                                                                                                          |

#### PA-FX-FAST Advertise

|                          |                                                                                                                                                                                                                 |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | PA-FX-FAST\_Advertise                                                                                                                                                                                           |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                        |
| **Description **         | This test case is designed to test if the KDC supports advertising PA-FX-FAST in the KDC\_ERR\_PREAUTH\_REQUIRED message.                                                                                       |
| **Prerequisites**        | Set user’s realm support FAST.                                                                                                                                                                                  |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                        
                                                                                                                                                                                                                                             
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                       
                                                                                                                                                                                                                                             
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                  
                                                                                                                                                                                                                                             
                                    > e-data: PA-FX-FAST (isCommon1)                                                                                                                                                                         |
| **Requirements covered** | isCommon:                                                                                                                                                                                                       
                                                                                                                                                                                                                                             
                            1.  As with all pre-authentication types, the KDC SHOULD advertise PA-FX-FAST in a PREAUTH\_REQUIRED error. KDCs MUST send the advertisement of PA-FX-FAST with an empty pa-value. (\[RFC6113\] section 5.4.2);  |
| **Cleanup**              | Unset user’s realm support FAST.                                                                                                                                                                                |

#### Request Computer TGT

|                          |                                                                                                                                                                                                                                                                         |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Request\_Computer\_TGT                                                                                                                                                                                                                                                  |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                |
| **Description **         | This test case is designed to test if the client could request a computer TGT from the user principal’s domain.                                                                                                                                                         |
| **Prerequisites**        | Set user’s realm support FAST.                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                     
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                     
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                     
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                     
                                1.  cname: &lt;clientcomputername&gt;                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                     
                                    > realm: &lt;user’s realm&gt;                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                     
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                     
                            > ticket: computer’s TGT (isKile1)                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                     
                            1.  srealm: &lt;user’s realm&gt;                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                     
                                > enc-padata: PA-SUPPORTED-ENCTYPES = 0x10000 (isKile2)                                                                                                                                                                                                              |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                     
                            1.  If the client does not have a TGT for the realm and is creating a:                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                     
                            -   AS-REQ: the client SHOULD obtain a TGT for the computer principal from the user principal’s domain. (\[MS-KILE\] section 3.2.5.3);                                                                                                                                   
                                                                                                                                                                                                                                                                                                     
                            1.  In addition to the RFC behavior, the Kerberos client SHOULD use the PA-SUPPORTED-ENCTYPES from the TGT obtained from a realm to determine if a realm supports FAST. (\[MS-KILE\] section 3.2.5.3);                                                                   
                                                                                                                                                                                                                                                                                                     
                                The KDC SHOULD return in the encrypted part of the AS-REP message PA-DATA with padata-type set to PA-SUPPORTED-ENCTYPES (165), to indicate what encryption types are supported by the KDC, and whether Claims or FAST are supported. (\[MS-KILE\] section 3.3.5.3);  |
| **Cleanup**              | Unset user’s realm support FAST.                                                                                                                                                                                                                                        |

#### Request User TGT

|                          |                                                                                                                                                                                                                                                                                                               |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Request\_User\_TGT                                                                                                                                                                                                                                                                                            |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                                                      |
| **Description **         | This test case is designed to test if the client could request a user TGT from the user principal’s domain using FAST.                                                                                                                                                                                        |
| **Prerequisites**        | Set user’s realm support FAST.                                                                                                                                                                                                                                                                                |
| **Test Execution Steps** | 1.  Client sends FAST AS\_REQ                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                           
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                           
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                           
                            3.  Client sends FAST AS\_REQ                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                           
                                1.  cname: &lt;username&gt;                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                           
                                    > realm: &lt;user’s realm&gt;                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                           
                            4.  KDC return FAST AS\_REP                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                           
                            > ticket: user’s TGT (isKile1)                                                                                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                                                                                              
                            > srealm: &lt;user’s realm&gt;                                                                                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                                                                                              
                            > enc-padata: PA-SUPPORTED-ENCTYPES = 0x10000 (isKile2)                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                           
                            1.  Client sends FAST TGS\_REQ (isKile1)                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                           
                            2.  KDC return FAST TGS\_REP                                                                                                                                                                                                                                                                                   |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                           
                            1.  In addition to the RFC behavior, the Kerberos client SHOULD use the PA-SUPPORTED-ENCTYPES from the TGT obtained from a realm to determine if a realm supports FAST. (\[MS-KILE\] section 3.2.5.3);                                                                                                         
                                                                                                                                                                                                                                                                                                                                           
                                If the principal is not the computer account and the client is running on a domain-joined computer, the Kerberos client SHOULD use FAST when the principal’s Realm supports FAST. (\[MS-KILE\] section 3.2.5.4);                                                                                           
                                                                                                                                                                                                                                                                                                                                           
                            2.  The KDC SHOULD<span id="z140" class="anchor"></span> return in the encrypted part of the AS-REP message PA-DATA with padata-type set to PA-SUPPORTED-ENCTYPES (165), to indicate what encryption types are supported by the KDC, and whether Claims or FAST are supported. (\[MS-KILE\] section 3.3.5.3);  |
| **Cleanup**              | Unset user’s realm support FAST.                                                                                                                                                                                                                                                                              |

#### ClaimsCompIdFASTSupport = 0

|                          |                                                                                               |
|--------------------------|-----------------------------------------------------------------------------------------------|
| **Test ID**              | ClaimsCompIdFASTSupport = 0                                                                   |
| **Priority**             | P0                                                                                            |
| **Description **         | This test case is designed to test if the client could support FAST or not.                   |
| **Prerequisites**        | Set KDC’s ClaimsCompIdFASTSupport = 0;                                                        |
| **Test Execution Steps** | 1.  Client sends FAST AS\_REQ                                                                 
                                                                                                                           
                            2.  KDC returns KRB\_ERROR                                                                     
                                                                                                                           
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                
                                                                                                                           
                                    > e-data: no PA-FX-FAST (isKile1)                                                      
                                                                                                                           
                            3.  Client sends AS\_REQ                                                                       
                                                                                                                           
                            4.  KDC return AS\_REP                                                                         
                                                                                                                           
                                1.  pa-data: no PA-FX-FAST (isKile1)                                                       
                                                                                                                           
                                    > ticket: user TGT                                                                     
                                                                                                                           
                                    > authorization-data: no PAC-CLIENT\_CLAIMS\_INFO (isKile2)                            |
| **Requirements covered** | isKile:                                                                                       
                                                                                                                           
                            1.  If ClaimsCompIdFASTSupport is set to:<span id="z136" class="anchor"></span>                
                                                                                                                           
                            -   0: The KDC SHOULD respond as if it does not process FAST.                                  
                                                                                                                           
                            > (\[MS-KILE\] section 3.3.5.1);                                                               
                                                                                                                           
                            1.  If ClaimsCompIdFASTSupport is set to:                                                      
                                                                                                                           
                            -   0: The KDC SHOULD NOT insert into the returned PAC a PAC\_CLIENT\_CLAIMS\_INFO structure.  
                                                                                                                           
                            > (\[MS-KILE\] section 3.3.6.3.2.6);                                                           |
| **Cleanup**              | Unset KDC’s ClaimsCompIdFASTSupport.                                                          |

#### ClaimsCompIdFASTSupport = 1

|                          |                                                                                                                                                                                                                                   |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ClaimsCompIdFASTSupport = 1                                                                                                                                                                                                       |
| **Priority**             | P0                                                                                                                                                                                                                                |
| **Description **         | This test case is designed to test if the client could support FAST or not.                                                                                                                                                       |
| **Prerequisites**        | Set KDC’s ClaimsCompIdFASTSupport = 1;                                                                                                                                                                                            |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                            > error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                          
                            >                                                                                                                                                                                                                                  
                            > e-data: no PA-FX-FAST (isClaims1)                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                            1.  Client sends FAST AS\_REQ                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                            > pa-data: PA-PAC-OPTIONS (claims)                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                            1.  KDC return FAST AS\_REP (isClaims2)                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                            > ticket: user TGT                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                  
                            > authorization-data: PAC-CLIENT\_CLAIMS\_INFO (isClaims4)                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                            1.  Client sends AS\_REQ                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                            > pa-data: PA-PAC-OPTIONS (claims)                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                            1.  KDC return AS\_REP (isClaims3)                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                                1.  ticket: user TGT                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                            > authorization-data: PAC-CLIENT\_CLAIMS\_INFO (isClaims4)                                                                                                                                                                         |
| **Requirements covered** | isClaims:                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                            1.  If ClaimsCompIdFASTSupport is set to:                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                            -   1: … and a KDC\_ERR\_PREAUTH\_REQUIRED is returned in the KRB\_ERROR: The KDC SHOULD NOT return PA-FX-FAST in the KRB\_ERROR.                                                                                                  
                                                                                                                                                                                                                                                               
                            1.  If ClaimsCompIdFASTSupport is set to:                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                            -   1: and an armored AS-REQ is received: The KDC SHOULD process per FAST.                                                                                                                                                         
                                                                                                                                                                                                                                                               
                            1.  If ClaimsCompIdFASTSupport is set to:                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                            -   1: an unarmored AS-REQ is received: The KDC SHOULD continue without FAST.                                                                                                                                                      
                                                                                                                                                                                                                                                               
                            > (\[MS-KILE\] section 3.3.5.1);                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                            1.  If ClaimsCompIdFASTSupport is set to:                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                            -   1: If a PA-PAC-OPTIONS \[167\] PA-DATA type with the Claims bit set is in the AS REQ, the KDC SHOULD behave as noted in the next step, "2 or 3". Otherwise, the KDC SHOULD NOT provide a PAC\_CLIENT\_CLAIMS\_INFO structure.  
                                                                                                                                                                                                                                                               
                            > (\[MS-KILE\] section 3.3.6.3.2.6);                                                                                                                                                                                               |
| **Cleanup**              | Unset KDC’s ClaimsCompIdFASTSupport.                                                                                                                                                                                              |

#### ClaimsCompIdFASTSupport = 2

|                          |                                                                               |
|--------------------------|-------------------------------------------------------------------------------|
| **Test ID**              | ClaimsCompIdFASTSupport = 2                                                   |
| **Priority**             | P0                                                                            |
| **Description **         | This test case is designed to test if the client could support FAST or not.   |
| **Prerequisites**        | Set KDC’s ClaimsCompIdFASTSupport = 2;                                        |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                      
                                                                                                           
                            2.  KDC returns KRB\_ERROR                                                     
                                                                                                           
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                
                                                                                                           
                                    > e-data: PA-FX-FAST (???)                                             
                                                                                                           
                            3.  Client sends FAST AS\_REQ                                                  
                                                                                                           
                            4.  KDC return FAST AS\_REP (isClaims1)                                        
                                                                                                           
                                1.  ticket: user TGT                                                       
                                                                                                           
                            > authorization-data: PAC-CLIENT\_CLAIMS\_INFO (isClaims3)                     
                                                                                                           
                            1.  Client sends AS\_REQ                                                       
                                                                                                           
                            2.  KDC return AS\_REP (isClaims2)                                             
                                                                                                           
                                1.  ticket: user TGT                                                       
                                                                                                           
                                    > authorization-data: PAC-CLIENT\_CLAIMS\_INFO (isClaims3)             |
| **Requirements covered** | isClaims:                                                                     
                                                                                                           
                            1.  If ClaimsCompIdFASTSupport is set to:                                      
                                                                                                           
                            -   2: and an armored AS-REQ is received: The KDC SHOULD process per FAST.     
                                                                                                           
                            1.  If ClaimsCompIdFASTSupport is set to:                                      
                                                                                                           
                            -   2: an unarmored AS-REQ is received: The KDC SHOULD continue without FAST.  
                                                                                                           
                            > (\[MS-KILE\] section 3.3.5.1);                                               
                                                                                                           
                            1.  If ClaimsCompIdFASTSupport is set to:                                      
                                                                                                           
                            -   2: the KDC SHOULD …                                                        
                                                                                                           
                            > (\[MS-KILE\] section 3.3.6.3.2.6);                                           |
| **Cleanup**              | Unset KDC’s ClaimsCompIdFASTSupport.                                          |

#### ClaimsCompIdFASTSupport = 3

|                          |                                                                                                                                                                                                          |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | ClaimsCompIdFASTSupport = 3                                                                                                                                                                              |
| **Priority**             | P0                                                                                                                                                                                                       |
| **Description **         | This test case is designed to test if the client could support FAST or not.                                                                                                                              |
| **Prerequisites**        | Set KDC’s ClaimsCompIdFASTSupport = 3;                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                                                                                                            
                                                                                                                                                                                                                                      
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                
                                                                                                                                                                                                                                      
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                           
                                                                                                                                                                                                                                      
                            3.  Client sends AS\_REQ                                                                                                                                                                                  
                                                                                                                                                                                                                                      
                            4.  KDC return AS\_REP (isClaims2)                                                                                                                                                                        
                                                                                                                                                                                                                                      
                                1.  ticket: computer’s TGT                                                                                                                                                                            
                                                                                                                                                                                                                                      
                            > authorization-data: PAC-CLIENT\_CLAIMS\_INFO (isClaims3)                                                                                                                                                
                                                                                                                                                                                                                                      
                            1.  Client sends AS\_REQ for user account                                                                                                                                                                 
                                                                                                                                                                                                                                      
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                
                                                                                                                                                                                                                                      
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                           
                                                                                                                                                                                                                                      
                                    > e-data: PA-FX-FAST (isClaims1)                                                                                                                                                                  
                                                                                                                                                                                                                                      
                            3.  Client sends FAST AS\_REQ                                                                                                                                                                             
                                                                                                                                                                                                                                      
                            4.  KDC return FAST AS\_REP (isClaims1)                                                                                                                                                                   
                                                                                                                                                                                                                                      
                                1.  ticket: user’s TGT                                                                                                                                                                                
                                                                                                                                                                                                                                      
                            > authorization-data: PAC-CLIENT\_CLAIMS\_INFO (isClaims3)                                                                                                                                                |
| **Requirements covered** | isClaims:                                                                                                                                                                                                
                                                                                                                                                                                                                                      
                            1.  If ClaimsCompIdFASTSupport is set to:                                                                                                                                                                 
                                                                                                                                                                                                                                      
                            -   3: and an armored AS-REQ is received: The KDC SHOULD process per FAST.                                                                                                                                
                                                                                                                                                                                                                                      
                            1.  If ClaimsCompIdFASTSupport is set to:                                                                                                                                                                 
                                                                                                                                                                                                                                      
                            -   3: and an AS-REQ is received: If the principal is a computer account, then the KDC SHOULD continue without FAST. Otherwise, the KDC SHOULD return KDC\_ERR\_PREAUTH\_REQUIRED and return PA-FX-FAST.  
                                                                                                                                                                                                                                      
                            > (\[MS-KILE\] section 3.3.5.1);                                                                                                                                                                          
                                                                                                                                                                                                                                      
                            1.  If ClaimsCompIdFASTSupport is set to:                                                                                                                                                                 
                                                                                                                                                                                                                                      
                            -   2: the KDC SHOULD …                                                                                                                                                                                   
                                                                                                                                                                                                                                      
                            > (\[MS-KILE\] section 3.3.6.3.2.6);                                                                                                                                                                      |
| **Cleanup**              | Unset KDC’s ClaimsCompIdFASTSupport.                                                                                                                                                                     |

#### Fresh Armor Key

|                          |                                                                                                            |
|--------------------------|------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Fresh\_Armor\_Key                                                                                          |
| **Priority**             | P0                                                                                                         |
| **Description **         | This test case is designed to test if the client will provide a fresh armor key for each conversation.     |
| **Prerequisites**        | Set KDC’s ClaimsCompIdFASTSupport = 3;                                                                     |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                              
                                                                                                                                        
                            2.  KDC returns KRB\_ERROR                                                                                  
                                                                                                                                        
                            3.  Client sends AS\_REQ                                                                                    
                                                                                                                                        
                            4.  KDC return AS\_REP                                                                                      
                                                                                                                                        
                                1.  ticket: computer’s TGT                                                                              
                                                                                                                                        
                            5.  Client sends AS\_REQ for user account                                                                   
                                                                                                                                        
                            6.  KDC returns KRB\_ERROR                                                                                  
                                                                                                                                        
                            7.  Client sends FAST AS\_REQ                                                                               
                                                                                                                                        
                            > Armor-key: record this value.                                                                             
                                                                                                                                        
                            1.  KDC returns FAST AS\_REP                                                                                
                                                                                                                                        
                            2.  Client sends FAST AS\_REQ                                                                               
                                                                                                                                        
                            > Armor-key: different from last armor key (isCommon1)                                                      
                                                                                                                                        
                            1.  KDC returns FAST AS\_REP                                                                                |
| **Requirements covered** | isCommon:                                                                                                  
                                                                                                                                        
                            1.  Any FAST armor scheme MUST provide a fresh armor key for each conversation. (\[RFC6113\] section 5.4);  |
| **Cleanup**              |                                                                                                            |

#### FAST Armor Field Success

|                          |                                                                                                                             |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | FAST\_Armor\_Field\_Success                                                                                                 |
| **Priority**             | P0                                                                                                                          |
| **Description **         | This test case is designed to test if the KDC supports only one armor type and AP-REQ as armor value for each conversation. |
| **Prerequisites**        |                                                                                                                             |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                               
                                                                                                                                                         
                            2.  KDC returns KRB\_ERROR                                                                                                   
                                                                                                                                                         
                            3.  Client sends AS\_REQ                                                                                                     
                                                                                                                                                         
                            4.  KDC return AS\_REP                                                                                                       
                                                                                                                                                         
                                1.  ticket: computer’s TGT                                                                                               
                                                                                                                                                         
                            5.  Client sends AS\_REQ for user account                                                                                    
                                                                                                                                                         
                            6.  KDC returns KRB\_ERROR                                                                                                   
                                                                                                                                                         
                            7.  Client sends FAST AS\_REQ                                                                                                
                                                                                                                                                         
                            > Armor-type: FX\_FAST\_ARMOR\_AP\_REQUEST (1) (isCommon1)                                                                   
                            >                                                                                                                            
                            > Armor-value: AP-REQ (isCommon1)                                                                                            
                                                                                                                                                         
                            1.  KDC returns FAST AS\_REP                                                                                                 
                                                                                                                                                         
                            > ticket: user TGT (isCommon1)                                                                                               |
| **Requirements covered** | isCommon:                                                                                                                   
                                                                                                                                                         
                            1.  Only one armor type is defined in this document. (\[RFC6113\] section 5.4.1);                                            |
| **Cleanup**              |                                                                                                                             |

#### FAST Armor Type Failure

|                          |                                                                                                                                                                               |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | FAST\_Armor\_Type\_Failure                                                                                                                                                    |
| **Priority**             | P0                                                                                                                                                                            |
| **Description **         | This test case is designed to test if the KDC supports only one armor type for each conversation.                                                                             |
| **Prerequisites**        |                                                                                                                                                                               |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                                                                                 
                                                                                                                                                                                                           
                            2.  KDC returns KRB\_ERROR                                                                                                                                                     
                                                                                                                                                                                                           
                            3.  Client sends AS\_REQ                                                                                                                                                       
                                                                                                                                                                                                           
                            4.  KDC return AS\_REP                                                                                                                                                         
                                                                                                                                                                                                           
                                1.  ticket: computer’s TGT                                                                                                                                                 
                                                                                                                                                                                                           
                            5.  Client sends AS\_REQ for user account                                                                                                                                      
                                                                                                                                                                                                           
                            6.  KDC returns KRB\_ERROR                                                                                                                                                     
                                                                                                                                                                                                           
                            7.  Client sends FAST AS\_REQ                                                                                                                                                  
                                                                                                                                                                                                           
                            > Armor-type: unknown type (xxx) (isCommon1)                                                                                                                                   
                            >                                                                                                                                                                              
                            > Armor-value: AP-REQ                                                                                                                                                          
                                                                                                                                                                                                           
                            1.  KDC returns KDC\_ERR\_PREAUTH\_FAILED (isCommon1)                                                                                                                          |
| **Requirements covered** | isCommon:                                                                                                                                                                     
                                                                                                                                                                                                           
                            1.  Only one armor type is defined in this document…If a FAST KDC receives an unknown armor type it MUST respond with KDC\_ERR\_PREAUTH\_FAILED. (\[RFC6113\] section 5.4.1);  |
| **Cleanup**              |                                                                                                                                                                               |

#### FAST Armor Value Failure

|                          |                                                                                           |
|--------------------------|-------------------------------------------------------------------------------------------|
| **Test ID**              | FAST\_Armor\_Value\_Failure                                                               |
| **Priority**             | P0                                                                                        |
| **Description **         | This test case is designed to test if the KDC supports the AP\_REQ armor value.           |
| **Prerequisites**        |                                                                                           |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                             
                                                                                                                       
                            2.  KDC returns KRB\_ERROR                                                                 
                                                                                                                       
                            3.  Client sends AS\_REQ                                                                   
                                                                                                                       
                            4.  KDC return AS\_REP                                                                     
                                                                                                                       
                                1.  ticket: computer’s TGT                                                             
                                                                                                                       
                            5.  Client sends AS\_REQ for user account                                                  
                                                                                                                       
                            6.  KDC returns KRB\_ERROR                                                                 
                                                                                                                       
                            7.  Client sends FAST AS\_REQ                                                              
                                                                                                                       
                            > Armor-type: FX\_FAST\_ARMOR\_AP\_REQUEST (1) (isCommon1)                                 
                            >                                                                                          
                            > Armor-value: not AP-REQ (isCommon1)                                                      
                                                                                                                       
                            1.  KDC returns KDC\_ERR\_PREAUTH\_FAILED (isCommon1)                                      |
| **Requirements covered** | isCommon:                                                                                 
                                                                                                                       
                            1.  …the armor-value contains an ASN.1 DER encoded AP-REQ. (\[RFC6113\] section 5.4.1.1);  |
| **Cleanup**              |                                                                                           |

#### No Subkey

|                          |                                                                                    |
|--------------------------|------------------------------------------------------------------------------------|
| **Test ID**              | No\_Subkey                                                                         |
| **Priority**             | P0                                                                                 |
| **Description **         | This test case is designed to test if the KDC supports the AP\_REQ armor value.    |
| **Prerequisites**        |                                                                                    |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                      
                                                                                                                
                            2.  KDC returns KRB\_ERROR                                                          
                                                                                                                
                            3.  Client sends AS\_REQ                                                            
                                                                                                                
                            4.  KDC return AS\_REP                                                              
                                                                                                                
                                1.  ticket: computer’s TGT                                                      
                                                                                                                
                            5.  Client sends AS\_REQ for user account                                           
                                                                                                                
                            6.  KDC returns KRB\_ERROR                                                          
                                                                                                                
                            7.  Client sends FAST AS\_REQ                                                       
                                                                                                                
                            > Armor-type: FX\_FAST\_ARMOR\_AP\_REQUEST (1)                                      
                            >                                                                                   
                            > Armor-value: AP-REQ without a subkey field (isCommon1)                            
                                                                                                                
                            1.  KDC returns KDC\_ERR\_PREAUTH\_FAILED (isCommon1)                               |
| **Requirements covered** | isCommon:                                                                          
                                                                                                                
                            1.  The subkey field in the AP-REQ MUST be present. (\[RFC6113\] section 5.4.1.1);  |
| **Cleanup**              |                                                                                    |

#### Armor TGT sname

|                          |                                                                                                                         |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Armor\_TGT\_sname                                                                                                       |
| **Priority**             | P0                                                                                                                      |
| **Description **         |                                                                                                                         |
| **Prerequisites**        |                                                                                                                         |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                           
                                                                                                                                                     
                            2.  KDC returns KRB\_ERROR                                                                                               
                                                                                                                                                     
                            3.  Client sends AS\_REQ                                                                                                 
                                                                                                                                                     
                            4.  KDC return AS\_REP                                                                                                   
                                                                                                                                                     
                                1.  ticket: computer’s TGT                                                                                           
                                                                                                                                                     
                            5.  Client sends AS\_REQ for user account                                                                                
                                                                                                                                                     
                            6.  KDC returns KRB\_ERROR                                                                                               
                                                                                                                                                     
                            7.  Client sends FAST AS\_REQ                                                                                            
                                                                                                                                                     
                            > Armor-type: FX\_FAST\_ARMOR\_AP\_REQUEST (1)                                                                           
                            >                                                                                                                        
                            > Armor-value: AP-REQ:                                                                                                   
                            >                                                                                                                        
                            > Armor Ticket:                                                                                                          
                            >                                                                                                                        
                            > sname: target realm (isCommon1)                                                                                        
                                                                                                                                                     
                            1.  KDC returns FAST AS\_REP                                                                                             |
| **Requirements covered** | isCommon:                                                                                                               
                                                                                                                                                     
                            1.  The server name field of the armor ticket MUST identify the TGS of the target realm. (\[RFC6113\] section 5.4.1.1);  |
| **Cleanup**              |                                                                                                                         |

#### AD-FX-FAST-ARMOR in Authenticator

|                          |                                                                                                                                                              |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AD-FX-FAST-ARMOR\_in\_Authenticator                                                                                                                          |
| **Priority**             | P0                                                                                                                                                           |
| **Description **         |                                                                                                                                                              |
| **Prerequisites**        | This test case is designed to verify if the KDC can reject a AD-FX-FAST-ARMOR in authenticator.                                                              |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                                                                
                                                                                                                                                                                          
                            2.  KDC returns KRB\_ERROR                                                                                                                                    
                                                                                                                                                                                          
                            3.  Client sends AS\_REQ                                                                                                                                      
                                                                                                                                                                                          
                            4.  KDC return AS\_REP                                                                                                                                        
                                                                                                                                                                                          
                                1.  ticket: computer’s TGT                                                                                                                                
                                                                                                                                                                                          
                            5.  Client sends AS\_REQ for user account                                                                                                                     
                                                                                                                                                                                          
                            6.  KDC returns KRB\_ERROR                                                                                                                                    
                                                                                                                                                                                          
                            7.  Client sends FAST AS\_REQ                                                                                                                                 
                                                                                                                                                                                          
                            8.  KDC returns FAST AS\_REP                                                                                                                                  
                                                                                                                                                                                          
                            9.  Client sends FAST TGS\_REQ                                                                                                                                
                                                                                                                                                                                          
                            > pa-data: PA-TGS-REQ (1)                                                                                                                                     
                            >                                                                                                                                                             
                            > authenticator:                                                                                                                                              
                            >                                                                                                                                                             
                            > authorization-data: AD-FX-FAST-ARMOR (71) (isCommon1)                                                                                                       
                                                                                                                                                                                          
                            1.  KDC returns Failure                                                                                                                                       |
| **Requirements covered** | isCommon:                                                                                                                                                    
                                                                                                                                                                                          
                            1.  The TGS MUST reject a request if there is an AD-fx-fast-armor (71) element in the authenticator of the pa-tgs-req padata. (\[RFC6113\] section 5.4.1.1);  |
| **Cleanup**              |                                                                                                                                                              |

#### AD-FX-FAST-ARMOR in ticket

|                          |                                                                                                                                                                                       |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AD-FX-FAST-ARMOR\_in\_ticket                                                                                                                                                          |
| **Priority**             | P0                                                                                                                                                                                    |
| **Description **         |                                                                                                                                                                                       |
| **Prerequisites**        | This test case is designed to verify if the KDC can reject a AD-FX-FAST-ARMOR in ticket.                                                                                              |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                                                                                         
                                                                                                                                                                                                                   
                            2.  KDC returns KRB\_ERROR                                                                                                                                                             
                                                                                                                                                                                                                   
                            3.  Client sends AS\_REQ                                                                                                                                                               
                                                                                                                                                                                                                   
                            4.  KDC return AS\_REP                                                                                                                                                                 
                                                                                                                                                                                                                   
                                1.  ticket: computer’s TGT                                                                                                                                                         
                                                                                                                                                                                                                   
                            5.  Client sends AS\_REQ for user account                                                                                                                                              
                                                                                                                                                                                                                   
                            6.  KDC returns KRB\_ERROR                                                                                                                                                             
                                                                                                                                                                                                                   
                            7.  Client sends FAST AS\_REQ                                                                                                                                                          
                                                                                                                                                                                                                   
                            8.  KDC returns FAST AS\_REP                                                                                                                                                           
                                                                                                                                                                                                                   
                            9.  Client sends FAST TGS\_REQ                                                                                                                                                         
                                                                                                                                                                                                                   
                            > pa-data: PA-TGS-REQ (1)                                                                                                                                                              
                            >                                                                                                                                                                                      
                            > ticket:                                                                                                                                                                              
                            >                                                                                                                                                                                      
                            > authorization-data: AD-FX-FAST-ARMOR (71) (isCommon1)                                                                                                                                
                                                                                                                                                                                                                   
                            1.  KDC returns Failure                                                                                                                                                                |
| **Requirements covered** | isCommon:                                                                                                                                                                             
                                                                                                                                                                                                                   
                            1.  The TGS MUST reject a request if … or if the ticket in the authenticator of a pa-tgs-req contains the AD-fx-fast-armor authorization data element. (\[RFC6113\] section 5.4.1.1);  |
| **Cleanup**              |                                                                                                                                                                                       |

#### AD-FX-FAST-ARMOR in enc-authorization-data

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                               |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AD-FX-FAST-ARMOR\_in\_enc-authorization-data                                                                                                                                                                                                                                                                                                                                                                                  |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Description **         |                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Prerequisites**        | This test case is designed to verify if the KDC can support an AD-FX-FAST-ARMOR in enc-authorization-data.                                                                                                                                                                                                                                                                                                                    |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                1.  ticket: computer’s TGT                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            5.  Client sends AS\_REQ for user account                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            6.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            7.  Client sends FAST AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            8.  KDC returns FAST AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            9.  Client sends FAST TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > pa-data: PA-TGS-REQ (1)                                                                                                                                                                                                                                                                                                                                                                                                      
                            >                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > req-body:                                                                                                                                                                                                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > enc-authorization-data: AD-FX-FAST-ARMOR (71) (isCommon1)                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  KDC returns FAST TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > ticket: service ticket (isCommon1)                                                                                                                                                                                                                                                                                                                                                                                           |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  In order for the host process to ensure that the host ticket is not accidentally or intentionally misused, it MUST include a critical authorization data element of the type AD-fx-fast-armor when providing the authenticator or in the enc-authorization-data field of the TGS request used to obtain the TGT. The corresponding ad-data field of the AD-fx-fast-armor element is empty. (\[RFC6113\] section 5.4.1.1);  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                               |

#### AD-FX-FAST-USED in authenticator

|                          |                                                                                                                                                                                                                                                                                                                                |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AD-FX-FAST-USED\_in\_authenticator                                                                                                                                                                                                                                                                                             |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                             |
| **Description **         |                                                                                                                                                                                                                                                                                                                                |
| **Prerequisites**        | This test case is designed to verify if the KDC can support an AD-FX-FAST-USED in authenticator.                                                                                                                                                                                                                               |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                            
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                            
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                            
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                            
                                1.  ticket: computer’s TGT                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                            
                            5.  Client sends AS\_REQ for user account                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                            
                            6.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                            
                            7.  Client sends FAST AS\_REQ                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                            
                            8.  KDC returns FAST AS\_REP                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                            
                            9.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                            
                            > pa-data: do not include PA-FX-FAST                                                                                                                                                                                                                                                                                            
                            >                                                                                                                                                                                                                                                                                                                               
                            > pa-data: PA-TGS-REQ (1)                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                               
                            > authenticator: AD-FX-FAST-USED (71) (isCommon1)                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                            
                            1.  KDC returns KRB\_APP\_ERR\_MODIFIED (isCommon1)                                                                                                                                                                                                                                                                             |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                            
                            1.  In a TGS request, a client MAY include the AD-fx-fast-used authdata either in the pa-tgs-req authenticator or in the authorization data in the pa-tgs-req ticket. If the KDC receives this authorization data but does not find a FAST padata, then it MUST return KRB\_APP\_ERR\_MODIFIED. (\[RFC6113\] section 5.4.1.1);  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                |

#### AD-FX-FAST-USED in ticket

|                          |                                                                                                                                                                                                                                                                                                                                |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | AD-FX-FAST-USED\_in\_ticket                                                                                                                                                                                                                                                                                                    |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                             |
| **Description **         |                                                                                                                                                                                                                                                                                                                                |
| **Prerequisites**        | This test case is designed to verify if the KDC can support an AD-FX-FAST-USED in ticket authorization data.                                                                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                            
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                            
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                            
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                            
                                1.  ticket: computer’s TGT                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                            
                            5.  Client sends AS\_REQ for user account                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                            
                            6.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                            
                            7.  Client sends FAST AS\_REQ                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                            
                            8.  KDC returns FAST AS\_REP                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                            
                            9.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                            
                            > pa-data: do not include PA-FX-FAST                                                                                                                                                                                                                                                                                            
                            >                                                                                                                                                                                                                                                                                                                               
                            > pa-data: PA-TGS-REQ (1)                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                               
                            > ticket:                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                               
                            > authorization-data: AD-FX-FAST-USED (71) (isCommon1)                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                            
                            1.  KDC returns KRB\_APP\_ERR\_MODIFIED (isCommon1)                                                                                                                                                                                                                                                                             |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                            
                            1.  In a TGS request, a client MAY include the AD-fx-fast-used authdata either in the pa-tgs-req authenticator or in the authorization data in the pa-tgs-req ticket. If the KDC receives this authorization data but does not find a FAST padata, then it MUST return KRB\_APP\_ERR\_MODIFIED. (\[RFC6113\] section 5.4.1.1);  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                |

#### Armor TGS request with non-TGT

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Armor TGS request with non-TGT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Priority**             | P1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Description **         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Prerequisites**        | This test case is designed to verify if the KDC can support FAST armoring TGS request with a non TGT ticket.                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                1.  ticket: computer’s TGT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            5.  Client sends AS\_REQ for user account                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            6.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            7.  Client sends FAST AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            8.  KDC returns FAST AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            9.  Client sends FAST TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > Armor ticket: non TGT (isCommon1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  KDC returns FAST TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > ticket: service ticket (isCommon1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  Clients MAY present a non-TGT in the PA-TGS-REQ authenticator and omit the armor field, in which case the armor key is the same that would be computed if the authenticator were used in an FX\_FAST\_ARMOR\_AP\_REQUEST armor. This is the only case where a ticket other than a TGT can be used to establish an armor key; even though the armor key is computed the same as an FX\_FAST\_ARMOR\_AP\_REQUEST, a non-TGT cannot be used as an armor ticket in FX\_FAST\_ARMOR\_AP\_REQUEST. (\[RFC6113\] section 5.4.1.1);  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |

#### Armor TGS request with TGT

|                          |                                                                                                                                                                                                                                                                                                                                                                                                |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Request\_Service\_Ticket                                                                                                                                                                                                                                                                                                                                                                       |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                             |
| **Description **         | This test case is designed to test if the KDC supports a FAST TGS\_REQ.                                                                                                                                                                                                                                                                                                                        |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                                                                                                |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                            
                                1.  ticket: computer’s TGT                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            5.  Client sends AS\_REQ for user account                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            6.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            7.  Client sends FAST AS\_REQ                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            8.  KDC returns FAST AS\_REP                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            > ticket: user’s TGT (isCommon1)                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            1.  Client sends FAST TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            > Armor ticket: user’s TGT (isCommon1)                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            1.  KDC returns FAST TGS\_REP                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            > ticket: service ticket (isCommon1)                                                                                                                                                                                                                                                                                                                                                            |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            1.  TGS armor types MUST authenticate the client to the KDC, typically by binding the TGT sub-session key to the armor key. (\[RFC6113\] section 5.4.1);                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                            
                            2.  If the ticket presented in the PA-TGS-REQ authenticator is a TGT, then the client SHOULD NOT include the armor field in the Krbfastreq and a subkey MUST be included in the PA-TGS-REQ authenticator. In this case, the armor key is the same armor key that would be computed if the TGS-REQ authenticator was used in an FX\_FAST\_ARMOR\_AP\_REQUEST armor. (\[RFC6113\] section 5.4.2)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                |

#### Req-checksum

|                          |                                                                                                                                                                       |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Req-checksum\_for\_AS-REQ                                                                                                                                             |
| **Priority**             | P0                                                                                                                                                                    |
| **Description **         | This test case is designed to verify the Req-checksum field.                                                                                                          |
| **Prerequisites**        |                                                                                                                                                                       |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                                                                         
                                                                                                                                                                                                   
                            2.  KDC returns KRB\_ERROR                                                                                                                                             
                                                                                                                                                                                                   
                            3.  Client sends AS\_REQ                                                                                                                                               
                                                                                                                                                                                                   
                            4.  KDC return AS\_REP                                                                                                                                                 
                                                                                                                                                                                                   
                                1.  ticket: computer’s TGT                                                                                                                                         
                                                                                                                                                                                                   
                            5.  Client sends AS\_REQ for user account                                                                                                                              
                                                                                                                                                                                                   
                            6.  KDC returns KRB\_ERROR                                                                                                                                             
                                                                                                                                                                                                   
                            7.  Client sends FAST AS\_REQ                                                                                                                                          
                                                                                                                                                                                                   
                            > Req-checksum: over KDC-REQ-BODY (isKile1)                                                                                                                            
                                                                                                                                                                                                   
                            1.  KDC returns FAST AS\_REP                                                                                                                                           
                                                                                                                                                                                                   
                            2.  Client sends FAST TGS\_REQ                                                                                                                                         
                                                                                                                                                                                                   
                            > Req-checksum: over AP-REQ in the PA-TGS-REQ padata (isKile2)                                                                                                         
                                                                                                                                                                                                   
                            1.  KDC returns FAST TGS\_REP                                                                                                                                          |
| **Requirements covered** | isCommon:                                                                                                                                                             
                                                                                                                                                                                                   
                            1.  For an AS-REQ, it is performed over the type KDC-REQ-BODY for the req-body field of the KDC-REQ structure of the containing message; (\[RFC6113\] section 5.4.2);  
                                                                                                                                                                                                   
                            2.  For a TGS-REQ, it is performed over the type AP-REQ in the PA-TGS-REQ padata of the TGS request. (\[RFC6113\] section 5.4.2).                                      |
| **Cleanup**              |                                                                                                                                                                       |

#### FAST Fallback

|                          |                                                                                                                                                                       |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | FASTFallback                                                                                                                                                          |
| **Priority**             | P0 (BVT)                                                                                                                                                              |
| **Description **         | This test case is designed to verify if the client supports fast fallback.                                                                                            |
| **Prerequisites**        | Set KDC support FAST.                                                                                                                                                 |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                                           
                                                                                                                                                                                                   
                            2.  KDC returns KRB\_ERROR                                                                                                                                             
                                                                                                                                                                                                   
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                        
                                                                                                                                                                                                   
                                    > e-data: PA-FX-FAST (isCommon1)                                                                                                                               
                                                                                                                                                                                                   
                            3.  Client sends AS request                                                                                                                                            
                                                                                                                                                                                                   
                            4.  KDC return AS response (isCommon1)                                                                                                                                 
                                                                                                                                                                                                   
                            5.  Client send TGS request                                                                                                                                            
                                                                                                                                                                                                   
                            6.  KDC returns TGS response                                                                                                                                           |
| **Requirements covered** | isCommon:                                                                                                                                                             
                                                                                                                                                                                                   
                            1.  Clients MAY also support policies that fall back to other mechanisms or that do not use pre-authentication when FAST is unavailable. (\[RFC6113\] section 5.4.3).  |
| **Cleanup**              |                                                                                                                                                                       |

#### Pa-data in FAST

|                          |                                                                                                                                                                                                                                                                                                                                                |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Pa-data\_in\_FAST                                                                                                                                                                                                                                                                                                                              |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                                                                                       |
| **Description **         | This test case is designed to verify pa-data fields in FAST.                                                                                                                                                                                                                                                                                   |
| **Prerequisites**        | Set KDC support FAST.                                                                                                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                            
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                            
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                            
                                    > e-data: PA-FX-FAST (isCommon1)                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                            
                            3.  Client sends FAST AS\_REQ                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                            
                            > pa-data: PA-FX-FAST (isCommon2)                                                                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                                                                                               
                            > pa-data (in FAST): all the outer PA-DATA when FAST not used                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                            
                            1.  KDC return FAST AS\_REP                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                            
                            > pa-data: PA-FX-FAST                                                                                                                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                                                                                                               
                            > pa-data (in FAST): all the outer PA-DATA when FAST not used (isCommon1)                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                            
                            1.  Client send FAST TGS\_REQ                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                            
                            > pa-data: PA-FX-FAST (isCommon3)                                                                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                                                                                               
                            > pa-data (in FAST): all the outer PA-DATA when FAST not used                                                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                                                                                               
                            > padata: PA-TGS-REQ                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                            
                            1.  KDC returns FAST TGS\_REP                                                                                                                                                                                                                                                                                                                   |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                            
                            1.  Unless otherwise specified, the KDC MUST include any padata that are otherwise in the outer KDC-REP or KDC-ERROR structure into this field. The padata field in the KDC reply structure outside of the PA-FX-FAST-REPLY structure typically includes only the PA-FX-FAST-REPLY padata. (\[RFC6113\] section 5.4.3).                         
                                                                                                                                                                                                                                                                                                                                                                            
                            2.  The outer AS request typically only includes one pa-data item: PA-FX-FAST. The client MAY include additional pa-data, but the KDC MUST ignore the outer request body and any padata besides PA-FX-FAST if and only if PA-FX-FAST is processed. In the case of the TGS request, the outer request should include PA-FX-FAST and PA-TGS-REQ.  
                                                                                                                                                                                                                                                                                                                                                                            
                                When an AS generates a response, all padata besides PA-FX-FAST should be included in PA-FX-FAST. The client MUST ignore other padata outside of PA-FX-FAST. (\[RFC6113\] section 5.4.5).                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                            
                            3.  In the case of the TGS request, the outer request should include PA-FX-FAST and PA-TGS-REQ. (\[RFC6113\] section 5.4.5).                                                                                                                                                                                                                    |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                |

#### Strengthen Key

|                          |                                                                                                                                                                                                                                                                                                                                            |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Strengthen\_Key                                                                                                                                                                                                                                                                                                                            |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                         |
| **Description **         | This test case is designed to verify if KDC support strengthen key.                                                                                                                                                                                                                                                                        |
| **Prerequisites**        | Set KDC support strengthen key.                                                                                                                                                                                                                                                                                                            |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                        
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                        
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                        
                                    > no strengthen key (isCommon2)                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                        
                            3.  Client sends AS request                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                        
                            4.  KDC return AS response                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                        
                            > Strengthen key: used to generate the new reply key to decrypt reply encrypted part. (isCommon1)                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                        
                            1.  Client send TGS request                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                        
                            2.  KDC returns TGS response                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                        
                            > Strengthen key: used to generate the new reply key to decrypt reply encrypted part. (isCommon1)                                                                                                                                                                                                                                           |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                        
                            1.  The strengthen-key field provides a mechanism for the KDC to strengthen the reply key. If set, the strengthen-key value MUST be randomly generated to have the same etype as that of the reply keybefore being strengthened, and then the reply key is strengthened after all padata items are processed. (\[RFC6113\] section 5.4.3).  
                                                                                                                                                                                                                                                                                                                                                                        
                            2.  The strengthen-key field MAY be set in an AS reply; it MUST be set in a TGS reply; it must be absent in an error reply. (\[RFC6113\] section 5.4.3).                                                                                                                                                                                    |
| **Cleanup**              | Unset KDC support strengthen key.                                                                                                                                                                                                                                                                                                          |

#### KrbFastFinished

|                          |                                                                                                                                                                                                                                                                                 |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | KrbFastFinished                                                                                                                                                                                                                                                                 |
| **Priority**             | P0                                                                                                                                                                                                                                                                              |
| **Description **         | This test case is designed to verify if KDC support KrbFastFinished structure.                                                                                                                                                                                                  |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                 |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                             
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                             
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                             
                                    > no KrbFastFinished (isCommon1)                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                             
                            3.  Client sends AS request                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                             
                            4.  KDC return AS response                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                             
                            > Ticket: user TGT                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                                
                            > KrbFastFinished (isCommon1)                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                             
                            1.  Client send TGS request                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                             
                            2.  KDC returns TGS response                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                             
                            > Ticket: service ticket                                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                                                
                            > KrbFastFinished (isCommon1)                                                                                                                                                                                                                                                    |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                             
                            1.  The finished field contains a KrbFastFinished structure. It is filled by the KDC in the final message in the conversation. This field is present in an AS-REP or a TGS-REP when a ticket is returned, and it is not present in an error reply. (\[RFC6113\] section 5.4.3).  
                                                                                                                                                                                                                                                                                                             
                            2.  The strengthen-key field MAY be set in an AS reply; it MUST be set in a TGS reply; it must be absent in an error reply. (\[RFC6113\] section 5.4.3).                                                                                                                         |
| **Cleanup**              |                                                                                                                                                                                                                                                                                 |

#### FAST KRB-ERROR

|                          |                                                                                                                                                                                                                   |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | FAST\_KRB-ERROR                                                                                                                                                                                                   |
| **Priority**             | P0                                                                                                                                                                                                                |
| **Description **         | This test case is designed to verify if KDC support FAST KRB-ERROR.                                                                                                                                               |
| **Prerequisites**        |                                                                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                          
                                                                                                                                                                                                                                               
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                         
                                                                                                                                                                                                                                               
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                    
                                                                                                                                                                                                                                               
                            3.  Client sends FAST AS\_REQ (expect some error)                                                                                                                                                                  
                                                                                                                                                                                                                                               
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                         
                                                                                                                                                                                                                                               
                            > error-code:                                                                                                                                                                                                      
                            >                                                                                                                                                                                                                  
                            > e-data: PA-FX-FAST:                                                                                                                                                                                              
                            >                                                                                                                                                                                                                  
                            > KrbFastResponse:                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                  
                            > pa-data: PA-ETYPE-INFO2 (isCommon1)                                                                                                                                                                              
                            >                                                                                                                                                                                                                  
                            > pa-data: PA-FX-ERROR (isCommon2)                                                                                                                                                                                 
                            >                                                                                                                                                                                                                  
                            > edata: absent (isCommon3)                                                                                                                                                                                        |
| **Requirements covered** | isCommon:                                                                                                                                                                                                         
                                                                                                                                                                                                                                               
                            1.  The KDC MUST include all the padata elements such as PA-ETYPE-INFO2 and padata elements that indicate acceptable pre-authentication mechanisms in the KrbFastResponse structure. (\[RFC6113\] section 5.4.3).  
                                                                                                                                                                                                                                               
                            2.  The KDC MUST also include a PA-FX-ERROR padata item in the KRBFastResponse structure. (\[RFC6113\] section 5.4.3).                                                                                             
                                                                                                                                                                                                                                               
                            3.  The e-data field MUST be absent in the PA\_FX-ERROR padata. All other fields should be the same as the outer KRB-ERROR. (\[RFC6113\] section 5.4.3).                                                           |
| **Cleanup**              |                                                                                                                                                                                                                   |

#### FAST-options hide-client-names

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | FAST-options\_hide-client-names                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Description **         | This test case is designed to verify if KDC support FAST options.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            3.  Client sends FAST AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > Fast-options: hide-client-names (isCommon1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                            > Cname: can be anything you want (isCommon1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            1.  KDC return FAST AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > Ticket: user TGT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                            > cname: &lt;username&gt; (isCommon1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            1.  Client send TGS request                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > Fast-options: hide-client-names (isCommon1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                            > Cname: can be anything you want (isCommon1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            1.  KDC returns TGS response                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > Ticket: service ticket                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                            > Cname: &lt;username&gt; (isCommon1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            1.  The Kerberos response defined in \[RFC4120\] contains the client identity in clear text. This makes traffic analysis straightforward. The hide-client-names option is designed to complicate traffic analysis. If the hide-client-names option is set, the KDC implementing PA-FX-FAST MUST identify the client as the anonymous principal in the KDC reply and the error response. Hence, this option is set by the client if it wishes to conceal the client identity in the KDC response. A conforming KDC ignores the client principal name in the outer KDC-REQ-BODY field, and identifies the client using the cname and crealm fields in the req-body field of the KrbFastReq structure. (\[RFC6113\] section 5.4.2).  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

#### PA-FX-COOKIE

When FAST padata is included, the PA-FX-COOKIE padata as defined in section 5.2 MUST be included in the padata sequence in the KrbFastResponse sequence if the KDC expects at least one more message from the client in order to complete the authentication. (\[MS-KILE\] section 5.4.3)

1.  ### Protected Users

    1.  #### Interactive logon fail with DES crypto

|                          |                                                                                                                                                                                                                                                             |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Protected\_Users\_DES\_PreAuthentication\_Fail                                                                                                                                                                                                              |
| **Priority**             | P0                                                                                                                                                                                                                                                          |
| **Description **         | By adding domain controller protection, weak authentication data is no longer usable. Test interactive logon behavior with Kerberos initial authentication with weak crypto                                                                                 |
| **Prerequisites**        | DC DFL&gt;=6                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                         
                            Domain user testsilo01                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                         
                            a member of Protected Users group                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                         
                            use des only= false                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                         
                            msds-supportedEncryptiontypes: =3 (DES)                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                         
                            DC: network security: Configure encryption types allowed for Kerberos: Check DES, RC4 only                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                         
                            > etype: &lt;desired encryption algorithm to be used by the client including DES &gt;                                                                                                                                                                        
                            >                                                                                                                                                                                                                                                            
                            > pre-authentication used DES or RC4                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                         
                            1.  KDC returns KDC\_ERR\_ETYPE\_NOTSUPP                                                                                                                                                                                                                     |
| **Requirements covered** | 3.3.5.6 AS Exchange                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                            
                            > If domainControllerFunctionality returns a value &gt;= 6 (\[MS-ADTS\] section 3.1.1.3.2.25), the KDC MUST check whether the account is a member of PROTECTED\_USERS (\[MS-DTYP\] section 2.4.2.4). If it is a member of PROTECTED\_USERS, then:&lt;50&gt;  
                            >                                                                                                                                                                                                                                                            
                            >  If pre-authentication used DES or RC4, the KDC MUST return KDC\_ERR\_POLICY.                                                                                                                                                                             |
| **Cleanup**              |                                                                                                                                                                                                                                                             |

#### Interactive logon fail with RC4 crypto

|                          |                                                                                                                                                                                                                                                             |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Protected\_Users\_RC4\_PreAuthentication\_Fail                                                                                                                                                                                                              |
| **Priority**             | P0                                                                                                                                                                                                                                                          |
| **Description **         | By adding domain controller protection, weak authentication data is no longer usable. Test interactive logon behavior with Kerberos initial authentication with weak crypto                                                                                 |
| **Prerequisites**        | DC DFL&gt;=6                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                         
                            Domain user testsilo03                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                         
                            a member of Protected Users group                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                         
                            use des only= false                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                         
                            msds-supportedEncryptiontypes: =4(RC4)                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                         
                            DC: network security: Configure encryption types allowed for Kerberos: Check DES, RC4 only                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                         
                            > etype: &lt;desired encryption algorithm to be used by the client including RC4&gt;                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                            
                            > pre-authentication used DES or RC4                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                         
                            1.  KDC returns KDC\_ERR\_ETYPE\_NOTSUPP                                                                                                                                                                                                                     |
| **Requirements covered** | 3.3.5.6 AS Exchange                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                            
                            > If domainControllerFunctionality returns a value &gt;= 6 (\[MS-ADTS\] section 3.1.1.3.2.25), the KDC MUST check whether the account is a member of PROTECTED\_USERS (\[MS-DTYP\] section 2.4.2.4). If it is a member of PROTECTED\_USERS, then:&lt;50&gt;  
                            >                                                                                                                                                                                                                                                            
                            >  If pre-authentication used DES or RC4, the KDC MUST return KDC\_ERR\_POLICY.                                                                                                                                                                             |
| **Cleanup**              |                                                                                                                                                                                                                                                             |

#### Interactive logon succeed with user A2AF

|                          |                                                                                                                                                                                                                                                                                                                                                                                         |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Protected\_Users\_Interactive\_Logon\_Succeed                                                                                                                                                                                                                                                                                                                                           |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                      |
| **Description **         | Expect Testsilo02 logon to the Endpoint01 successfully. User’s A2AF is defined in UserDepartmentRestrictPolicy                                                                                                                                                                                                                                                                          |
| **Prerequisites**        | DC DFL&gt;=6                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            Krbtgt account has no UseDesOnly flag set                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            Domain user testsilo02                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > a member of Protected Users group                                                                                                                                                                                                                                                                                                                                                      
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > use des only= false                                                                                                                                                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > A2AF： User.Department==HR                                                                                                                                                                                                                                                                                                                                                             
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > A2A2=NULL                                                                                                                                                                                                                                                                                                                                                                              
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > Department: HR                                                                                                                                                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > Company: Contoso                                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > msds-supportedEncryptiontypes: =24, AES(If pre-authentication used AES)                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            Domain Computer Endpoint01                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > Company=Contoso                                                                                                                                                                                                                                                                                                                                                                        
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > Encbacandarmor=1                                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > Department=HR                                                                                                                                                                                                                                                                                                                                                                          
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > A2AF, A2A2 are null                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            Testsilo02 Interactive logon to Endpoint01                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            Policy:                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > User: A2AF=user.department==HR                                                                                                                                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > User TGT lifetime: 60 minutes                                                                                                                                                                                                                                                                                                                                                          
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > Computer: A2A2=NULL                                                                                                                                                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > Service: A2AF=NULL, A2A2=NULL                                                                                                                                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client computer sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                     
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            3.  Client computer sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                     
                                1.  ticket: computer’s TGT                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                     
                                    > enc-padata: PA-SUPPORTED-ENCTYPES(FAST)                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            5.  Client user sends FAST AS\_REQ                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            6.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                     
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            7.  Client user sends FAST AS\_REQ                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            8.  KDC returns FAST AS\_REP                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                     
                                1.  ticket: user’s TGT                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                     
                                    > enc-padata:                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                     
                                    > padata-type PA-SUPPORTED-ENCTYPES(FAST)                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                     
                                    > padata-value set to 0x1F                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > check TGT is non-renewable (PG document)                                                                                                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > Check TGT account cannot be delegated (PG document)                                                                                                                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > check PROXIABLE or FORWARDABLE ticket flags are not set (isKILE 1)                                                                                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > check MaxRenewAge and MaxTicketAge ==TGTLifeTime                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            1.  Client send FAST TGS request                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            2.  KDC returns FAST TGS response                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > ticket: service ticket                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            1.  padata-type PA-SUPPORTED-ENCTYPES(FAST)                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                     
                                > padata-value set to 0x1F                                                                                                                                                                                                                                                                                                                                                           |
| **Requirements covered** | isKILE 1                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > 3.3.5.1 Request Flag Ticket-issuing Behavior                                                                                                                                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > KILE KDCs use the following account variables to enforce TicketFlags:                                                                                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            >  If DelegationNotAllowed is set to TRUE on the principal, (or if domainControllerFunctionality returns a value &gt;= 6 (\[MS-ADTS\] section 3.1.1.3.2.25) and the principal is a member of PROTECTED\_USERS (\[MS-DTYP\] section 2.4.2.4)), the KILE KDC MUST NOT set the PROXIABLE or FORWARDABLE ticket flags (\[RFC4120\] sections 2.5 and 2.6).                                   
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            isKILE 2                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > 3.3.5.6 AS Exchange                                                                                                                                                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > If domainControllerFunctionality returns a value &gt;= 6 (\[MS-ADTS\] section 3.1.1.3.2.25), the KDC MUST check whether the account is a member of PROTECTED\_USERS (\[MS-DTYP\] section 2.4.2.4). If it is a member of PROTECTED\_USERS, then:&lt;50&gt;                                                                                                                              
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            >  If pre-authentication used DES or RC4, the KDC MUST return KDC\_ERR\_POLICY.                                                                                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > 3.3.5.6 as exchange                                                                                                                                                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                                                                                                                        
                            > If domainControllerFunctionality returns a value &gt;= 3: the KDC SHOULD, in the encrypted pre-auth data part ([\[Referrals-11\]](http://go.microsoft.com/fwlink/?LinkId=139781), Appendix A) of the AS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), and the padata-value set to 0x1F (section [2.2.6](#z6cfc7b5011ed4b4d846d6f08f0812919)).  
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            isKIle 3                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                     
                            If domainControllerFunctionality returns a value &gt;= 6, the KDC MUST determine whether an Authentication Policy is applied to the account (section [3.3.5.5](#z80f6b0ad18a44dadae7fa2b5da0c7e49)). If **Enforced** is TRUE, then:<span id="z158" class="anchor"></span>&lt;51&gt;                                                                                                      |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                         |

#### Interactive logon Failed with user A2AF

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                       |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Protected\_Users\_Interactive\_Logon\_User\_A2A2\_Fail                                                                                                                                                                                                                                                                                                                                                                |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Description **         | Expect testsilo02 logon to ap01 failed with error TGS\_REP: KDC\_ERR\_POLICY, because user’s A2AF access check failed.                                                                                                                                                                                                                                                                                                |
| **Prerequisites**        | DC DFL&gt;=6                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            Krbtgt account has no UseDesOnly flag set                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            Domain user testsilo02                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > a member of Protected Users group                                                                                                                                                                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > use des only= false                                                                                                                                                                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > A2AF： User.Department==HR                                                                                                                                                                                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > A2A2=NULL                                                                                                                                                                                                                                                                                                                                                                                                            
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > Department: HR                                                                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > Company: Contoso                                                                                                                                                                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > msds-supportedEncryptiontypes: =24, AES(If pre-authentication used AES)                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            Domain Computer AP01                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > Company=Contoso                                                                                                                                                                                                                                                                                                                                                                                                      
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > Encbacandarmor=1                                                                                                                                                                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > Department=Financial                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            Testsilo02 Interactive logon to AP01                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            Policy:                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > User: A2AF=user.department==HR                                                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > User TGT lifetime: 60 minutes                                                                                                                                                                                                                                                                                                                                                                                        
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > Computer: A2A2=NULL                                                                                                                                                                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > Service: A2AF=NULL, A2A2=NULL                                                                                                                                                                                                                                                                                                                                                                                        |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                1.  ticket: computer’s TGT                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                    > enc-padata: PA-SUPPORTED-ENCTYPES(FAST)                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            5.  Client sends FAST AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            6.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            7.  Client sends FAST AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            8.  KDC return FAST KDC\_ERR\_POLICY                                                                                                                                                                                                                                                                                                                                                                                   |
| **Requirements covered** | isKILE 1                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > 3.3.5.1 Request Flag Ticket-issuing Behavior                                                                                                                                                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > KILE KDCs use the following account variables to enforce TicketFlags:                                                                                                                                                                                                                                                                                                                                                
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            >  If DelegationNotAllowed is set to TRUE on the principal, (or if domainControllerFunctionality returns a value &gt;= 6 (\[MS-ADTS\] section 3.1.1.3.2.25) and the principal is a member of PROTECTED\_USERS (\[MS-DTYP\] section 2.4.2.4)), the KILE KDC MUST NOT set the PROXIABLE or FORWARDABLE ticket flags (\[RFC4120\] sections 2.5 and 2.6).                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            isKILE 2                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > 3.3.5.6 AS Exchange                                                                                                                                                                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > If domainControllerFunctionality returns a value &gt;= 6 (\[MS-ADTS\] section 3.1.1.3.2.25), the KDC MUST check whether the account is a member of PROTECTED\_USERS (\[MS-DTYP\] section 2.4.2.4). If it is a member of PROTECTED\_USERS, then:&lt;50&gt;                                                                                                                                                            
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            >  If pre-authentication used DES or RC4, the KDC MUST return KDC\_ERR\_POLICY.                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > 3.3.5.6 as exchange                                                                                                                                                                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > If domainControllerFunctionality returns a value &gt;= 3: the KDC SHOULD, in the encrypted pre-auth data part ([\[Referrals-11\]](http://go.microsoft.com/fwlink/?LinkId=139781), Appendix A) of the AS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), and the padata-value set to 0x1F (section [2.2.6](#z6cfc7b5011ed4b4d846d6f08f0812919)).                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            isKIle 3                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            If domainControllerFunctionality returns a value &gt;= 6 ([\[MS-ADTS\]](file:///E:\Enlist\ts_release\TestSuitesByFamily\Kerberos\Server\Docs\%5bMS-ADTS%5d.pdf) section 3.1.1.3.2.25), the KDC MUST determine whether an Authentication Policy is applied to the server or service (section [3.3.5.5](#z80f6b0ad18a44dadae7fa2b5da0c7e49)); if Enforced is TRUE then:<span id="z178" class="anchor"></span>&lt;61&gt;  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                       |

#### Interactive logon succeed with Computer A2A2

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Protected\_Users\_Interactive\_Logon\_Computer\_A2A2\_Succeed                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Description **         | Expect testsilo02 logon to endpiont01 succeed. Access check against A2A2 passed                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Prerequisites**        | DC DFL&gt;=6                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            Krbtgt account has no UseDesOnly flag set                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            Domain user testsilo02                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > a member of Protected Users group                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > use des only= false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > A2AF=NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > A2A2=NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > Department: HR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > Company: Contosos                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > msds-supportedEncryptiontypes: =24, AES(If pre-authentication used AES)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            Interactive logon to endpoint01 (in silo and policy applied)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            Endpoint01:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > Encbacandarmor=1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            Silo:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > testsilo01, testsilo02, Endpoint01                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            Policy:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > User: A2AF=NULL, A2A2=NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > User TGT lifetime: 60 minutes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > Computer: A2A2: User.Department==HR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > Service: A2AF=NULL, A2A2=NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > etype: &lt;desired encryption algorithm to be used by the client including AES&gt; isKILE 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                    > e-data:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                    > padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            2.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            3.  KDC returns AS\_REP(isKILE2, isKILE 3)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > check TGT is non-renewable (PG document)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > Check TGT account cannot be delegated (PG document)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > check PROXIABLE or FORWARDABLE ticket flags are not set (isKILE 1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > check MaxRenewAge and MaxTicketAge ==TGTLifeTime                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            1.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            2.  KDC returns TGS\_REP (isKILE4)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Requirements covered** | isKILE 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > 3.3.5.1 Request Flag Ticket-issuing Behavior                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > KILE KDCs use the following account variables to enforce TicketFlags:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            >  If DelegationNotAllowed is set to TRUE on the principal, (or if domainControllerFunctionality returns a value &gt;= 6 (\[MS-ADTS\] section 3.1.1.3.2.25) and the principal is a member of PROTECTED\_USERS (\[MS-DTYP\] section 2.4.2.4)), the KILE KDC MUST NOT set the PROXIABLE or FORWARDABLE ticket flags (\[RFC4120\] sections 2.5 and 2.6).                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            isKILE 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > 3.3.5.6 AS Exchange                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > If domainControllerFunctionality returns a value &gt;= 6 (\[MS-ADTS\] section 3.1.1.3.2.25), the KDC MUST check whether the account is a member of PROTECTED\_USERS (\[MS-DTYP\] section 2.4.2.4). If it is a member of PROTECTED\_USERS, then:&lt;50&gt;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            >  If pre-authentication used DES or RC4, the KDC MUST return KDC\_ERR\_POLICY.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > 3.3.5.6 as exchange                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > If domainControllerFunctionality returns a value &gt;= 3: the KDC SHOULD, in the encrypted pre-auth data part ([\[Referrals-11\]](http://go.microsoft.com/fwlink/?LinkId=139781), Appendix A) of the AS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), and the padata-value set to 0x1F (section [2.2.6](#z6cfc7b5011ed4b4d846d6f08f0812919)).                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            isKIle 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            If domainControllerFunctionality returns a value &gt;= 6, the KDC MUST determine whether an Authentication Policy is applied to the account (section [3.3.5.5](#z80f6b0ad18a44dadae7fa2b5da0c7e49)). If **Enforced** is TRUE, then:[&lt;51&gt;](#z159)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            isKILE 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            If domainControllerFunctionality returns a value &gt;= 6 ([\[MS-ADTS\]](file:///E:\Enlist\ts_release\TestSuitesByFamily\Kerberos\Server\Docs\%5bMS-ADTS%5d.pdf) section 3.1.1.3.2.25), the KDC MUST determine whether an Authentication Policy is applied to the server or service (section [3.3.5.5](#z80f6b0ad18a44dadae7fa2b5da0c7e49)); if Enforced is TRUE then:[&lt;61&gt;](#z179)                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            If there are no claims in the PAC and the PA-PAC-OPTIONS \[167\] (section [2.2.9](#z99721a01c85948d18310ec1bab9b2838)) PA-DATA type does not have the Claims bit set, then the KDC SHOULD NOT call the [TransformClaimsOnTrustTraversal](file:///E:\Enlist\ts_release\TestSuitesByFamily\Kerberos\Server\Docs\%5bMS-ADTS%5d.pdf) procedure ([\[MS-ADTS\]](file:///E:\Enlist\ts_release\TestSuitesByFamily\Kerberos\Server\Docs\%5bMS-ADTS%5d.pdf) section 3.1.1.11.2.11). Otherwise the KDC SHOULD call this procedure.<span id="z180" class="anchor"></span>&lt;62&gt;                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            When KERB-LOCAL data is present, the KDC SHOULD copy the authorization data field ([\[RFC4120\]](http://go.microsoft.com/fwlink/?LinkId=90458) section 5.2.6) with ad-type KERB-LOCAL (142) and ad-data containing KERB-LOCAL structure (section [2.2.3](#z2a01b297c47f45479268cf589aedd063)) as an AD-IF-RELEVANT to the end of authorization data in the service ticket.<span id="z182" class="anchor"></span>&lt;63&gt;                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            The KILE KDC MUST copy the populated fields from the PAC in the TGT to the newly created PAC and, after processing all fields it supports, the KILE KDC MUST generate a new [Server Signature (section ](#z962edb93fa3c48eaa0a6062f760eb69c)[3.3.5.6.3.3](#z962edb93fa3c48eaa0a6062f760eb69c)[)](#z962edb93fa3c48eaa0a6062f760eb69c) and [KDC Signature (section ](#z37bf87b91d56475ab2b2e3948b29194d)[3.3.5.6.3.4](#z37bf87b91d56475ab2b2e3948b29194d)[)](#z37bf87b91d56475ab2b2e3948b29194d) which replace the existing signature fields in the PAC. The KDC MUST ensure that the PAC structure specified in [\[MS-PAC\]](file:///E:\Enlist\ts_release\TestSuitesByFamily\Kerberos\Server\Docs\%5bMS-PAC%5d.pdf) does not end with a zero-length buffer.  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |

#### Interactive logon failed with computer A2A2

|                          |                                                                                                                                                                                                                                                                                         |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Protected\_Users\_Interactive\_Logon\_Computer\_A2A2\_Fail                                                                                                                                                                                                                              |
| **Priority**             | P0                                                                                                                                                                                                                                                                                      |
| **Description **         | Testsilo02 interactive logon to endpont01 and failed with KDC\_ERR\_POLICY because of A2AF access check failed.                                                                                                                                                                         |
| **Prerequisites**        | DC DFL&gt;=6                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                     
                            Krbtgt account has no UseDesOnly flag set                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                     
                            Domain user testsilo03                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
                            > a member of Protected Users group                                                                                                                                                                                                                                                      
                            >                                                                                                                                                                                                                                                                                        
                            > use des only= false                                                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                        
                            > A2AF= NULL                                                                                                                                                                                                                                                                             
                            >                                                                                                                                                                                                                                                                                        
                            > A2A2=NULL                                                                                                                                                                                                                                                                              
                            >                                                                                                                                                                                                                                                                                        
                            > msds-supportedEncryptiontypes: =24, AES(If pre-authentication used AES)                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                     
                            Interactive logon to endpoint01 (not in silo and policy applied)                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                     
                            Endpoint01:                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                     
                            > Encbacandarmor=1                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                     
                            Policy:                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                     
                            > User:NULL, A2A2=Null                                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                                        
                            > User TGT lifetime: 60 minutes                                                                                                                                                                                                                                                          
                            >                                                                                                                                                                                                                                                                                        
                            > Computer:: A2A2 User.department==HR                                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                        
                            > Service: A2AF=NULL, A2A2=NULL                                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                     
                            > etype: &lt;desired encryption algorithm to be used by the client including AES&gt; isKILE 2                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                     
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                     
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                     
                                    > e-data:                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                     
                                    > padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                     
                            2.  Client sends AS\_REQ                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                     
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                     
                            3.  KDC returns AS\_REP(isKILE2, isKILE 3)                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                     
                            > check TGT is non-renewable (PG document)                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                                        
                            > Check TGT account cannot be delegated (PG document)                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                        
                            > check PROXIABLE or FORWARDABLE ticket flags are not set (isKILE 1)                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                                        
                            > check MaxRenewAge and MaxTicketAge ==TGTLifeTime                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                     
                            1.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                     
                            2.  KDC returns KRB\_ERR\_POLICY isKILE 1                                                                                                                                                                                                                                                |
| **Requirements covered** | isKILE 1                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                     
                            3.3.5.6 AS Exchange                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                     
                            If domainControllerFunctionality returns a value &gt;= 6 (\[MS-ADTS\] section 3.1.1.3.2.25), the KDC MUST check whether the account is a member of PROTECTED\_USERS (\[MS-DTYP\] section 2.4.2.4). If it is a member of PROTECTED\_USERS, then:&lt;50&gt;                                
                                                                                                                                                                                                                                                                                                                     
                             If pre-authentication used DES or RC4, the KDC MUST return KDC\_ERR\_POLICY.                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                     
                            3.3.5.6 AS Exchange                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                     
                            If AllowedToAuthenticateFrom is not NULL, the PAC of the armor TGT MUST be used to perform an access check for the ACTRL\_DS\_CONTROL\_ACCESS right with additional rights GUID against the AllowedToAuthenticateFrom. If the access check fails, the KDC MUST return KDC\_ERR\_POLICY.  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                         |

1.  Single Domain: Network Logon Test
    ---------------------------------

    1.  ### Basic

        1.  #### Normal

|                          |                                                                                                                                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Normal                                                                                                                                                                                               |
| **Priority**             | P0 (BVT)                                                                                                                                                                                             |
| **Description **         | This test case is designed to go through the whole process with default settings.                                                                                                                    |
| **Prerequisites**        | Join client computer to the “contoso.com” domain;                                                                                                                                                    
                                                                                                                                                                                                                                  
                            Join file server to the “contoso.com” domain;                                                                                                                                                         
                                                                                                                                                                                                                                  
                            Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                     
                                                                                                                                                                                                                                  
                            Set Delegate=TRUE for client’s security context;                                                                                                                                                      
                                                                                                                                                                                                                                  
                            Set MutualAuthentication=TRUE for client’s security context;                                                                                                                                          
                                                                                                                                                                                                                                  
                            Set UseSessionKey=TRUE for client’s security context;                                                                                                                                                 
                                                                                                                                                                                                                                  
                            Set ChannelBinding=FALSE for client’s security context;                                                                                                                                               
                                                                                                                                                                                                                                  
                            Set ApplicationRequiresCBT=FALSE for server’s security context;                                                                                                                                       
                                                                                                                                                                                                                                  
                            Set registry key ClaimsCompIdFASTSupport to 0 on the KDC (don’t use group policy).                                                                                                                    
                                                                                                                                                                                                                                  
                            Set attribute msDS-SupportedEncryptionTypes to 0x1F for the krbtgt/contoso.com object in AD;                                                                                                          
                                                                                                                                                                                                                                  
                            Set attribute msDS-SupportedEncryptionTypes to 0x1F for the cifs/&lt;servername&gt;.contoso.com object in AD;                                                                                         
                                                                                                                                                                                                                                  
                            Purge ticket cache on client computer;                                                                                                                                                                |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                          
                                                                                                                                                                                                                                  
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                   
                                                                                                                                                                                                                                  
                            3.  Client sends AS \_REQ (no pre-authentication)                                                                                                                                                     
                                                                                                                                                                                                                                  
                                1.  kdc-options: RENEWABLE, FORWARDABLE, CANONICALIZE                                                                                                                                             
                                                                                                                                                                                                                                  
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                            
                                                                                                                                                                                                                                  
                                1.  e-data: PA-ENC-TIMESTAMP                                                                                                                                                                      
                                                                                                                                                                                                                                  
                            5.  Client sends AS\_REQ                                                                                                                                                                              
                                                                                                                                                                                                                                  
                            > padata: PA-ENC-TIMESTAMP, PA-PAC-REQUEST, PA-PAC-OPTIONS(forward to full DC)                                                                                                                        
                                                                                                                                                                                                                                  
                            1.  kdc-options: INITIAL, PRE-AUTHENT, RENEWABLE, FORWARDABLE, CANONICALIZE                                                                                                                           
                                                                                                                                                                                                                                  
                            <!-- -->                                                                                                                                                                                              
                                                                                                                                                                                                                                  
                            1.  KDC return AS\_REP                                                                                                                                                                                
                                                                                                                                                                                                                                  
                            > ticket: user TGT                                                                                                                                                                                    
                            >                                                                                                                                                                                                     
                            > flags: FORWARDABLE, RENEWABLE, PRE-AUTHENT                                                                                                                                                          
                            >                                                                                                                                                                                                     
                            > authorization-data: PAC, KERB\_VALIDATION\_INFO, PAC\_CLIENT\_INFO, PAC\_SIGNATURE\_DATA, UPN\_DNS\_INFO, PAC\_CLIENT\_CLAIMS\_INFO(should have no claims info, because ClaimsCompIdFASTSupport=0)  
                            >                                                                                                                                                                                                     
                            > enc-padata: PA-SUPPORTED-ENCTYPES (165) = 0x1F                                                                                                                                                      
                                                                                                                                                                                                                                  
                            1.  Client send TGS\_REQ                                                                                                                                                                              
                                                                                                                                                                                                                                  
                                1.  sname: cifs/ap01.contoso.com                                                                                                                                                                  
                                                                                                                                                                                                                                  
                                    > enc-authorization-data: KERB-LOCAL                                                                                                                                                          
                                                                                                                                                                                                                                  
                            2.  KDC returns TGS response                                                                                                                                                                          
                                                                                                                                                                                                                                  
                            > crealm: contoso.com                                                                                                                                                                                 
                            >                                                                                                                                                                                                     
                            > cname: &lt;username&gt;                                                                                                                                                                             
                            >                                                                                                                                                                                                     
                            > ticket: service ticket                                                                                                                                                                              
                            >                                                                                                                                                                                                     
                            > realm: contoso.com                                                                                                                                                                                  
                            >                                                                                                                                                                                                     
                            > sname: cifs/ap01.contoso.com                                                                                                                                                                        
                            >                                                                                                                                                                                                     
                            > flags: FORWARDABLE, RENEWABLE                                                                                                                                                                       
                            >                                                                                                                                                                                                     
                            > key: session key                                                                                                                                                                                    
                            >                                                                                                                                                                                                     
                            > crealm: contoso.com                                                                                                                                                                                 
                            >                                                                                                                                                                                                     
                            > cname: &lt;username&gt;                                                                                                                                                                             
                            >                                                                                                                                                                                                     
                            > authorization-data: KERB-LOCAL                                                                                                                                                                      
                            >                                                                                                                                                                                                     
                            > key: session key                                                                                                                                                                                    
                            >                                                                                                                                                                                                     
                            > flags: FORWARDABLE, RENEWABLE                                                                                                                                                                       
                            >                                                                                                                                                                                                     
                            > srealm: contoso.com                                                                                                                                                                                 
                            >                                                                                                                                                                                                     
                            > sname: cifs/ap01.contoso.com                                                                                                                                                                        
                            >                                                                                                                                                                                                     
                            > enc-padata: PA-SUPPORTED-ENCTYPES                                                                                                                                                                   
                                                                                                                                                                                                                                  
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                                                                                                          
                                                                                                                                                                                                                                  
                            > ap-options: use-session-key, mutual authentication                                                                                                                                                  
                            >                                                                                                                                                                                                     
                            > ticket: service ticket                                                                                                                                                                              
                            >                                                                                                                                                                                                     
                            > realm: contoso.com                                                                                                                                                                                  
                            >                                                                                                                                                                                                     
                            > sname: cifs/ap01.contoso.com                                                                                                                                                                        
                            >                                                                                                                                                                                                     
                            > flags:                                                                                                                                                                                              
                            >                                                                                                                                                                                                     
                            > key: session key                                                                                                                                                                                    
                            >                                                                                                                                                                                                     
                            > crealm: contoso.com                                                                                                                                                                                 
                            >                                                                                                                                                                                                     
                            > cname: &lt;username&gt;                                                                                                                                                                             
                            >                                                                                                                                                                                                     
                            > authorization-data: PAC                                                                                                                                                                             
                            >                                                                                                                                                                                                     
                            > authenticator: PAC info                                                                                                                                                                             
                            >                                                                                                                                                                                                     
                            > crealm: contoso.com                                                                                                                                                                                 
                            >                                                                                                                                                                                                     
                            > cname: &lt;username&gt;                                                                                                                                                                             
                            >                                                                                                                                                                                                     
                            > authorization-data(authenticator): PAC, KERB-LOCAL, KERB-AUTH-DATA-TOKEN-RESTRICTIONS                                                                                                               
                                                                                                                                                                                                                                  
                            1.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)                                                                                                                           |
| **Requirements covered** |                                                                                                                                                                                                      |
| **Cleanup**              |                                                                                                                                                                                                      |
| **Cleanup**              |                                                                                                                                                                                                      |

#### Export Key from Security Context

|                          |                                                                                                                                                                                                                                                                                                                                                                                      |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Export\_Key\_from\_Security\_Context                                                                                                                                                                                                                                                                                                                                                 |
| **Priority**             | P1                                                                                                                                                                                                                                                                                                                                                                                   |
| **Description **         | This test case is designed to verify if the key can be exported as an attribute of the completed security context in the SSPI API.                                                                                                                                                                                                                                                   |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                                                                                      |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                  
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                  
                            3.  Client sends AS \_REQ (no pre-authentication)                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                  
                                1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                  
                            4.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                  
                            5.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                  
                            6.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                  
                            7.  KDC returns TGS response                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                  
                            8.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                  
                            > ap-options: use-session-key                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                  
                            1.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                  
                            2.  Export key as an attribute of the complete security context in the SSPI API. (isKile1)                                                                                                                                                                                                                                                                                            |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                  
                            1.  Using KILE, application clients (for example, CIFS/SMB clients) MAY use the negotiated key directly. When an application client uses the session key, the application protocol MUST document the explicit use of the key in its protocol specification. The key MAY be exported as an attribute of the completed security context in the SSPI API. (\[MS-KILE\] section 3.1.1.2)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                      |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                      |

#### Server use AES when KerbSupportedEncryptionTypes set

|                          |                                                                                                                                                                                                                                                                                                                                                     |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Server\_use\_AES\_when\_KerbSupportedEncryptionTypes\_set                                                                                                                                                                                                                                                                                           |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                  |
| **Description **         | This test case is designed to verify if the KDC supports AES encryption for servers or services.                                                                                                                                                                                                                                                    |
| **Prerequisites**        | Set MutualAuthentication GSS API param on client and server;                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                 
                            Set attribute msDS-SupportedEncryptionTypes = 0x1F for the cifs/&lt;servername&gt;.contoso.com object in AD;                                                                                                                                                                                                                                         |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                 
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                 
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                 
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                 
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES (165)=0x1F (isKile1)                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                 
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                 
                            > ap-options: use-session-key, mutual authentication                                                                                                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                                                                                                                                    
                            > authenticator:                                                                                                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                                                                                                    
                            > subkey: record “subkey1”                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                 
                            1.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                 
                                1.  subkey: new “subkey2” != “subkey1” (isKile2)                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                 
                            > use subkey2 as sessionkey                                                                                                                                                                                                                                                                                                                          |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            1.  If the server or service has a KerbSupportedEncryptionTypes populated with supported encryption types, then the KDC SHOULD return in the encrypted part of TGS-REP message PA-DATA with padata-type set to PA-SUPPORTED-ENCTYPES (165), to indicate what encryption types are supported by the server or service. (\[MS-KILE\] section 3.3.5.4)  
                                                                                                                                                                                                                                                                                                                                                                                 
                            2.  The subkey in the EncAPRepPart of the KRB\_AP\_REP message SHOULD be used as the session key when MutualAuthentication is requested…; however when AES is used, the subkeys are different and the subkey in the KRB\_AP\_REP SHOULD be used. (\[MS-KILE\] section 3.1.1.2);                                                                      |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                     |

#### Server use RC4 when KerbSupportedEncryptionTypes set

|                          |                                                                                                                                                                                                                                                                                                                                                     |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Server\_use\_RC4\_when\_KerbSupportedEncryptionTypes\_set                                                                                                                                                                                                                                                                                           |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                  |
| **Description **         | This test case is designed to verify if the KDC supports RC4 encryption for servers or services.                                                                                                                                                                                                                                                    |
| **Prerequisites**        | Set MutualAuthentication GSS API param on client and server;                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                 
                            Set attribute msDS-SupportedEncryptionTypes = 0x7 for the cifs/&lt;servername&gt;.contoso.com object in AD;                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                 
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                 
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                 
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                 
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES (165)=0x7 (isKile1)                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                 
                            > ap-options: use-session-key, mutual authentication                                                                                                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                                                                                                                                    
                            > authenticator:                                                                                                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                                                                                                    
                            > subkey: record “subkey1”                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                 
                            1.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                 
                                1.  subkey: new “subkey2” = “subkey1” (isKile2)                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                 
                            > use either subkey1 or subkey2 as sessionkey                                                                                                                                                                                                                                                                                                        |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            1.  If the server or service has a KerbSupportedEncryptionTypes populated with supported encryption types, then the KDC SHOULD return in the encrypted part of TGS-REP message PA-DATA with padata-type set to PA-SUPPORTED-ENCTYPES (165), to indicate what encryption types are supported by the server or service. (\[MS-KILE\] section 3.3.5.4)  
                                                                                                                                                                                                                                                                                                                                                                                 
                            2.  The subkey in the EncAPRepPart of the KRB\_AP\_REP message SHOULD be used as the session key when MutualAuthentication is requested…; With DES and RC4, the subkey in the KRB\_AP\_REQ message can be used as the session key, as it is the same as the subkey in the KRB\_AP\_REP message. (\[MS-KILE\] section 3.1.1.2);                       |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                     |

#### Server use DES when KerbSupportedEncryptionTypes set

|                          |                                                                                                                                                                                                                                                                                                                                                     |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Server\_use\_DES\_when\_KerbSupportedEncryptionTypes\_set                                                                                                                                                                                                                                                                                           |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                  |
| **Description **         | This test case is designed to verify if the KDC supports DES encryption for servers or services.                                                                                                                                                                                                                                                    |
| **Prerequisites**        | Set MutualAuthentication GSS API param on client and server;                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                 
                            Set attribute msDS-SupportedEncryptionTypes = 0x3 for the cifs/&lt;servername&gt;.contoso.com object in AD;                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                 
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                 
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                 
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                 
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES (165)=0x3 (isKile1)                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                 
                            > ap-options: use-session-key, mutual authentication                                                                                                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                                                                                                                                    
                            > authenticator:                                                                                                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                                                                                                    
                            > subkey: record “subkey1”                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                 
                            1.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                 
                                1.  subkey: new “subkey2” = “subkey1” (isKile2)                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                 
                            > use either subkey1 or subkey2 as sessionkey                                                                                                                                                                                                                                                                                                        |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                 
                            1.  If the server or service has a KerbSupportedEncryptionTypes populated with supported encryption types, then the KDC SHOULD return in the encrypted part of TGS-REP message PA-DATA with padata-type set to PA-SUPPORTED-ENCTYPES (165), to indicate what encryption types are supported by the server or service. (\[MS-KILE\] section 3.3.5.4)  
                                                                                                                                                                                                                                                                                                                                                                                 
                            2.  The subkey in the EncAPRepPart of the KRB\_AP\_REP message SHOULD be used as the session key when MutualAuthentication is requested…; With DES and RC4, the subkey in the KRB\_AP\_REQ message can be used as the session key, as it is the same as the subkey in the KRB\_AP\_REP message. (\[MS-KILE\] section 3.1.1.2);                       |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                     |

#### Server use DES when KerbSupportedEncryptionTypes not set

|                          |                                                                                                                                                                                                                                               |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Server\_use\_DES\_when\_KerbSupportedEncryptionTypes\_not\_set                                                                                                                                                                                |
| **Priority**             | P0                                                                                                                                                                                                                                            |
| **Description **         | This test case is designed to verify if the KDC supports DES encryption for servers or services.                                                                                                                                              |
| **Prerequisites**        | Set MutualAuthentication GSS API param on client and server;                                                                                                                                                                                  
                                                                                                                                                                                                                                                                           
                            Set UseDESOnly = true to the server or service account;                                                                                                                                                                                        
                                                                                                                                                                                                                                                                           
                            Do not set attribute msDS-SupportedEncryptionTypes = 0x3 for the cifs/&lt;servername&gt;.contoso.com object in AD;                                                                                                                             |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                           
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                            
                                                                                                                                                                                                                                                                           
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                           
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                           
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                           
                            6.  KDC return AS\_REP                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                           
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                           
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                           
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES (165)=0x3 (isKile1)                                                                                                                                                                                       
                                                                                                                                                                                                                                                                           
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                  
                                                                                                                                                                                                                                                                           
                            2.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                   |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                           
                            1.  If UseDESOnly is set: the KDC SHOULD, in the encrypted pre-auth data part of the TGS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), and the padata-value set to 0x3. (\[MS-KILE\] section 3.3.5.4)  |
| **Cleanup**              |                                                                                                                                                                                                                                               |

#### Channel Binding Success

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Channel\_Binding\_Success                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Priority**             | P1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Description **         | This test case is designed to verify if the AP supports AD-AUTH-DATA-AP-OPTIONS authorization data.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Prerequisites**        | Set ChannelBinding to TRUE on client;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            Set ApplicationRequiresCBT to TRUE on server.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            9.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            > authenticator:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            > authorization-data: add AD-AUTH-DATA-AP-OPTIONS with value of KERB\_AP\_OPTIONS\_CBT (0x4000) (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            1.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            > Authentication success, not return GSS\_S\_BAD\_BINDINGS (isKile2)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            1.  If ChannelBinding is set to TRUE, the client SHOULD send AD-AUTH-DATA-AP-OPTIONS data in an AD-IF-RELEVANT element. The Authorization Data Type AD-AUTH-DATA-AP-OPTIONS has an ad-type of 143 and ad-data of KERB\_AP\_OPTIONS\_CBT (0x4000). The presence of this element indicates that the client expects the applications running on it to include channel binding information in AP requests whenever Kerberos authentication takes place over an “outer channel” such as TLS. Channel binding is provided using the ChannelBinding parameter specified in section 3.2.1. (\[MS-KILE\] section 3.2.5.7);  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            2.  If ApplicationRequiresCBT parameter is set to TRUE, the server, if so configured, MAY return GSS\_S\_BAD\_BINDINGS whenever the AP request message contains all-zero channel binding value and does not contain the AD-IF-RELEVANT element KERB\_AP\_OPTIONS\_CBT. (\[MS-KILE\] section 3.4.5)                                                                                                                                                                                                                                                                                                                 |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

#### Channel Binding Failure

|                          |                                                                                                                                                                                                                                                                                                    |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | NetworkLogon\_Basic\_ChannelBinding                                                                                                                                                                                                                                                                |
| **Priority**             | P1                                                                                                                                                                                                                                                                                                 |
| **Description **         | This test case is designed to verify if the AP supports AD-AUTH-DATA-AP-OPTIONS authorization data.                                                                                                                                                                                                |
| **Prerequisites**        | Set ChannelBinding to FALSE on client;                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                
                            Set ApplicationRequiresCBT to TRUE on server.                                                                                                                                                                                                                                                       |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                
                            9.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                
                            > all-zero channel binding value                                                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                                   
                            > authenticator:                                                                                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                                                                   
                            > authorization-data: no AD-AUTH-DATA-AP-OPTIONS                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                
                            1.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                
                            > return GSS\_S\_BAD\_BINDINGS (isKile1)                                                                                                                                                                                                                                                            |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                
                            1.  If ApplicationRequiresCBT parameter is set to TRUE, the server, if so configured, MAY return GSS\_S\_BAD\_BINDINGS whenever the AP request message contains all-zero channel binding value and does not contain the AD-IF-RELEVANT element KERB\_AP\_OPTIONS\_CBT. (\[MS-KILE\] section 3.4.5)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                    |

#### KERB\_AUTH\_DATA\_TOKEN\_RESTRICTIONS different MachineID

|                          |                                                                                                                                                                                                                                                        |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | KERB\_AUTH\_DATA\_TOKEN\_RESTRICTIONS\_different\_MachineID                                                                                                                                                                                            |
| **Priority**             | P1                                                                                                                                                                                                                                                     |
| **Description **         | This test case is designed to verify if the AP supports KERB-AD-RESTRICTION-ENTRY authorization data.                                                                                                                                                  |
| **Prerequisites**        | Don’t place AP on the client.                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                    
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                    
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                    
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                    
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                    
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                    
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                    
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                    
                            9.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                           
                                                                                                                                                                                                                                                                                    
                            > ticket:                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                       
                            > sname: not krbtgt/&lt;realm&gt;                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                       
                            > authenticator:                                                                                                                                                                                                                                        
                            >                                                                                                                                                                                                                                                       
                            > authorization-data: add KERB\_AUTH\_DATA\_TOKEN\_RESTRICTIONS (141) (isKile1)                                                                                                                                                                         
                                                                                                                                                                                                                                                                                    
                            1.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                            
                                                                                                                                                                                                                                                                                    
                            > Ignore the authorization data (isKile2)                                                                                                                                                                                                               |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                    
                            1.  When the server name is not Krbtgt, the client SHOULD send an AP request as an authorization data field, initialized as follows:                                                                                                                    
                                                                                                                                                                                                                                                                                    
                            > …                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                       
                            > KERB\_AUTH\_DATA\_TOKEN\_RESTRICTIONS (141), containing the KERB-AD-RESTRICTION-ENTRY structure. (\[MS-KILE\] section 3.2.5.7);                                                                                                                       
                                                                                                                                                                                                                                                                                    
                            1.  The server MUST check if KERB-AD-RESTRICTION-ENTRY.Restriction.MachineID is equal to Machine ID:                                                                                                                                                    
                                                                                                                                                                                                                                                                                    
                            -   If equal...                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                    
                            -   Otherwise, the server MUST ignore the KERB\_AUTH\_DATA\_TOKEN\_RESTRICTIONS \[141\] Authorization Data Type, the KERB-AD-RESTRICTION-ENTRY structure, the KERB-LOCAL (142), and the containing KERB-LOCAL structure. (\[MS-KILE\] section 3.4.5.3)  |
| **Cleanup**              |                                                                                                                                                                                                                                                        |

#### KERB\_AUTH\_DATA\_TOKEN\_RESTRICTIONS same MachineID

|                          |                                                                                                                                                                                                                                                     |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | KERB\_AUTH\_DATA\_TOKEN\_RESTRICTIONS\_same\_MachineID                                                                                                                                                                                              |
| **Priority**             | P1                                                                                                                                                                                                                                                  |
| **Description **         | This test case is designed to verify if the AP supports KERB-AD-RESTRICTION-ENTRY authorization data.                                                                                                                                               |
| **Prerequisites**        | Place AP on the client.                                                                                                                                                                                                                             |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                 
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                 
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                 
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                 
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                 
                            6.  KDC return AS\_REP                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                 
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                 
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                 
                            9.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                        
                                                                                                                                                                                                                                                                                 
                            > ticket:                                                                                                                                                                                                                                            
                            >                                                                                                                                                                                                                                                    
                            > sname: not krbtgt/&lt;realm&gt;                                                                                                                                                                                                                    
                            >                                                                                                                                                                                                                                                    
                            > authenticator:                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                    
                            > authorization-data: add KERB\_AUTH\_DATA\_TOKEN\_RESTRICTIONS (141) (isKile1)                                                                                                                                                                      
                                                                                                                                                                                                                                                                                 
                            1.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                         
                                                                                                                                                                                                                                                                                 
                            > Process authentication as a local one (isKile2)                                                                                                                                                                                                    |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                 
                            1.  When the server name is not Krbtgt, the client SHOULD send an AP request as an authorization data field, initialized as follows:                                                                                                                 
                                                                                                                                                                                                                                                                                 
                            > …                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                    
                            > KERB\_AUTH\_DATA\_TOKEN\_RESTRICTIONS (141), containing the KERB-AD-RESTRICTION-ENTRY structure. (\[MS-KILE\] section 3.2.5.7);                                                                                                                    
                                                                                                                                                                                                                                                                                 
                            1.  The server MUST check if KERB-AD-RESTRICTION-ENTRY.Restriction.MachineID is equal to Machine ID:                                                                                                                                                 
                                                                                                                                                                                                                                                                                 
                            -   If equal, the server SHOULD process the authentication as a local one, because the client and server are on the same machine, and MAY use the KERB-LOCAL AuthorizationData for any local implementation purposes. (\[MS-KILE\] section 3.4.5.3)  |
| **Cleanup**              |                                                                                                                                                                                                                                                     |

#### KERB-LOCAL different MachineID

|                          |                                                                                                                                                                                                                                                                             |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | KERB-LOCAL\_different\_MachineID                                                                                                                                                                                                                                            |
| **Priority**             | P0                                                                                                                                                                                                                                                                          |
| **Description **         | This test case is designed to verify if the KDC and AP supports KERB-LOCAL authorization data.                                                                                                                                                                              |
| **Prerequisites**        |                                                                                                                                                                                                                                                                             |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                         
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
                            > error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                         
                            1.  Client sends AS\_REQ                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                         
                            2.  KDC returns AS\_REP                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                         
                            3.  Client sends TGS\_REQ                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                         
                            > enc-authorization-data: KERB-LOCAL (142) (isKile1)                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                         
                            1.  KDC returns TGS\_REP                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                         
                            2.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                         
                            > authorization-data: KERB-LOCAL (142) (isKile2) (isKile3)                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
                            1.  AP sends AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
                            > Ignore the authorization data (isKile4)                                                                                                                                                                                                                                    |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                         
                            1.  When the server name is not krbtgt, the client SHOULD send an authorization data field with ad-type KERB-LOCAL (142) and ad-data containing KERB-LOCAL structure in an AD-IF-RELEVANT element in the enc-authorization-data field. (\[MS-KILE\] section 3.2.5.6);        
                                                                                                                                                                                                                                                                                                         
                            2.  When the server name is not Krbtgt, the client SHOULD send an AP request as an authorization data field, initialized as follows:                                                                                                                                         
                                                                                                                                                                                                                                                                                                         
                            -   Ad-type KERB-LOCAL (142) and ad-data containing KERB-LOCAL structure.                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                         
                                (\[MS-KILE\] section 3.2.5.7);                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                         
                            1.  When KERB-LOCAL data is present, the KDC SHOULD copy the authorization data field with ad-type KERB-LOCAL (142) and ad-data containing KERB-LOCAL structure as an AD-IF-RELEVANT to the end of authorization data in the service ticket. (\[MS-KILE\] section 3.3.5.4);  
                                                                                                                                                                                                                                                                                                         
                            <!-- -->                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                         
                            1.  The server MUST check if KERB-AD-RESTRICTION-ENTRY.Restriction.MachineID is equal to Machine ID:                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                         
                            -   If equal...                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                         
                            -   Otherwise, the server MUST ignore the KERB\_AUTH\_DATA\_TOKEN\_RESTRICTIONS \[141\] Authorization Data Type, the KERB-AD-RESTRICTION-ENTRY structure, the KERB-LOCAL (142), and the containing KERB-LOCAL structure. (\[MS-KILE\] section 3.4.5.3)                       |
| **Cleanup**              |                                                                                                                                                                                                                                                                             |

#### KERB-LOCAL same MachineID

|                          |                                                                                                                                                                                                                                                                             |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | KERB-LOCAL\_same\_MachineID                                                                                                                                                                                                                                                 |
| **Priority**             | P0                                                                                                                                                                                                                                                                          |
| **Description **         | This test case is designed to verify if the KDC and AP supports KERB-LOCAL authorization data.                                                                                                                                                                              |
| **Prerequisites**        |                                                                                                                                                                                                                                                                             |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                         
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
                            > error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                         
                            1.  Client sends AS\_REQ                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                         
                            2.  KDC returns AS\_REP                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                         
                            3.  Client sends TGS\_REQ                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                         
                            > enc-authorization-data: KERB-LOCAL (142) (isKile1)                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                         
                            1.  KDC returns TGS\_REP                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                         
                            2.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                         
                            > authorization-data: KERB-LOCAL (142) (isKile2) (isKile3)                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
                            1.  AP sends AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                         
                            > Process authentication as a local one (isKile4)                                                                                                                                                                                                                            |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                         
                            1.  When the server name is not krbtgt, the client SHOULD send an authorization data field with ad-type KERB-LOCAL (142) and ad-data containing KERB-LOCAL structure in an AD-IF-RELEVANT element in the enc-authorization-data field. (\[MS-KILE\] section 3.2.5.6);        
                                                                                                                                                                                                                                                                                                         
                            2.  When the server name is not Krbtgt, the client SHOULD send an AP request as an authorization data field, initialized as follows:                                                                                                                                         
                                                                                                                                                                                                                                                                                                         
                            -   Ad-type KERB-LOCAL (142) and ad-data containing KERB-LOCAL structure.                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                         
                                (\[MS-KILE\] section 3.2.5.7);                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                         
                            1.  When KERB-LOCAL data is present, the KDC SHOULD copy the authorization data field with ad-type KERB-LOCAL (142) and ad-data containing KERB-LOCAL structure as an AD-IF-RELEVANT to the end of authorization data in the service ticket. (\[MS-KILE\] section 3.3.5.4);  
                                                                                                                                                                                                                                                                                                         
                            2.  The server MUST check if KERB-AD-RESTRICTION-ENTRY.Restriction.MachineID is equal to Machine ID:                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                         
                            -   If equal, the server SHOULD process the authentication as a local one, because the client and server are on the same machine, and MAY use the KERB-LOCAL AuthorizationData for any local implementation purposes. (\[MS-KILE\] section 3.4.5.3)                          |
| **Cleanup**              |                                                                                                                                                                                                                                                                             |

#### Service Principal Names

|                          |                                                                                                                     |
|--------------------------|---------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Service\_Principal\_Names                                                                                           |
| **Priority**             | P0                                                                                                                  |
| **Description **         | This test case is designed to test if the KDC supports SPNs to identify server in TGS-REQs.                         |
| **Prerequisites**        | Set SPN attribute in the server computer account.                                                                   |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                         
                                                                                                                                                 
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                  
                                                                                                                                                 
                            3.  Client sends AS\_REQ (no pre-authentication)                                                                     
                                                                                                                                                 
                            4.  KDC returns KRB\_ERROR                                                                                           
                                                                                                                                                 
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                      
                                                                                                                                                 
                                    > e-data: PA-ENC-TIMESTAMP                                                                                   
                                                                                                                                                 
                            5.  Client sends AS request                                                                                          
                                                                                                                                                 
                            6.  KDC return AS response                                                                                           
                                                                                                                                                 
                            7.  Client sends TGS\_REQ                                                                                            
                                                                                                                                                 
                            > sname: serviceclass“/”hostname \[“:”port\] \[“/”servicename\]                                                      
                                                                                                                                                 
                            1.  KDC returns TGS\_REP                                                                                             
                                                                                                                                                 
                            > ticket: service ticket                                                                                             
                            >                                                                                                                    
                            > sname: serviceclass“/”hostname \[“:”port\] \[“/”servicename\] (isKile1)                                            |
| **Requirements covered** | isKile:                                                                                                             
                                                                                                                                                 
                            1.  Kerberos V5 specifies a variety of name types for specifying the name of the server during a TGS request.        
                                                                                                                                                 
                                KILE SHOULD use service principal names (SPNs) to identify servers in TGS\_REQs. (\[MS-KILE\] section 3.1.5.12)  |
| **Cleanup**              | Remove SPN attribute in the server computer account.                                                                |

#### RestrictedKrbHost

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | RestrictedKrbHost                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Description **         | <span id="z172" class="anchor"></span>This test case is designed to verify if the KDC and server supports the RestrictedKrbHost service class.                                                                                                                                                                                                                                                                                                                                       |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            3.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            5.  Client sends AS request                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            6.  KDC return AS response                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            7.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            > sname: &lt;a wrong service class&gt;/&lt;hostname&gt;                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            1.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            > ticket: service ticket (include PAC)                                                                                                                                                                                                                                                                                                                                                                                                                                                
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > sname: RestrictedKrbHost/&lt;hostname&gt; (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            > Use the service ticket with RestrictedKrbHost SPN.                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            1.  AP sends AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            > AP will decrypt the TGT with computer account’s key. And either create or use the session key – according to encryption type for “RestrictedKrbHost” SPN. (isKile2)                                                                                                                                                                                                                                                                                                                 |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            1.  An application can supply a name of the form “RestrictedKrbHost/&lt;hostname&gt;” when its callers have provided the hostname but not the correct SPN for the service. Applications SHOULD NOT use “RestrictedKrbHost/&lt;hostname&gt;” due to the security considerations in section 5.1.2. Applications calling GSS-API directly MUST provide a target name which SHOULD be an SPN for their service applications for Kerberos authentication. (\[MS-KILE\] section 3.1.5.12);  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                            2.  When the server receives AP requests for SPNs with the serviceclass string equal to “RestrictedKrbHost”, it will decrypt the ticket with the computer account’s key and either create or use the session key for the “RestrictedKrbHost”, regardless of the account the target service is running as. (\[MS-KILE\] section 3.4.5).                                                                                                                                                |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |

#### UseSessionKey

|                          |                                                                                                                                                                   |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | UseSessionKey                                                                                                                                                     |
| **Priority**             | P1                                                                                                                                                                |
| **Description **         | This test case is designed to verify if the KDC and server supports the UseSessionKey ap-option.                                                                  |
| **Prerequisites**        | Set UseSessionKey GSS-API parameter on client and server.                                                                                                         |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                       
                                                                                                                                                                                               
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                
                                                                                                                                                                                               
                            3.  Client sends AS\_REQ (no pre-authentication)                                                                                                                   
                                                                                                                                                                                               
                            4.  KDC returns KRB\_ERROR                                                                                                                                         
                                                                                                                                                                                               
                            5.  Client sends AS request                                                                                                                                        
                                                                                                                                                                                               
                            6.  KDC return AS response                                                                                                                                         
                                                                                                                                                                                               
                            7.  Client sends TGS\_REQ                                                                                                                                          
                                                                                                                                                                                               
                            8.  KDC returns TGS\_REP                                                                                                                                           
                                                                                                                                                                                               
                            9.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                      
                                                                                                                                                                                               
                            > ap-options: USE-SESSION-KEY (isKile1)                                                                                                                            
                                                                                                                                                                                               
                            1.  AP sends AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                         |
| **Requirements covered** | isKile:                                                                                                                                                           
                                                                                                                                                                                               
                            1.  If UseSessionKey is set to TRUE, the client SHOULD set the USE-SESSION-KEY flag to TRUE in the ap-options field of the AP-REQ. (\[MS-KILE\] section 3.2.5.7);  |
| **Cleanup**              |                                                                                                                                                                   |

#### Service ticket without PAC

|                          |                                                                                                                                                                                  |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | NetworkLogon\_Basic\_NoPAC                                                                                                                                                       |
| **Priority**             | P0                                                                                                                                                                               |
| **Description **         | This test case is set to verify if the KDC could issue a service ticket without PAC information in it.                                                                           |
| **Prerequisites**        | Set AuthorizationDataNotRequired to the service account.                                                                                                                         |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                      
                                                                                                                                                                                                              
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                               
                                                                                                                                                                                                              
                            3.  Client sends AS\_REQ                                                                                                                                                          
                                                                                                                                                                                                              
                            4.  KDC returns KRB\_ERROR                                                                                                                                                        
                                                                                                                                                                                                              
                            5.  Client sends AS\_REQ                                                                                                                                                          
                                                                                                                                                                                                              
                            6.  KDC return AS\_REP                                                                                                                                                            
                                                                                                                                                                                                              
                            7.  Client send TGS\_REQ                                                                                                                                                          
                                                                                                                                                                                                              
                            8.  KDC returns TGS\_REP                                                                                                                                                          
                                                                                                                                                                                                              
                            > ticket: service ticket with no PAC information (isKile1)                                                                                                                        
                                                                                                                                                                                                              
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                     
                                                                                                                                                                                                              
                            2.  AP sends AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                        |
| **Requirements covered** | isKile:                                                                                                                                                                          
                                                                                                                                                                                                              
                            1.  If the Application Server’s service account AuthorizationDataNotRequired is set to TRUE, the KDC MUST NOT include a PAC in the service ticket. (\[MS-KILE\] section 3.3.5.4)  |
| **Cleanup**              |                                                                                                                                                                                  |

#### KRB\_SAFE

KILE does not implement KRB\_SAFE messages.

#### KRB\_PRIV with a time stamp

KILE does not implement KRB\_PRIV messages with a time stamp.

#### KRB\_PRIV with a sequence number

KILE implement KRB\_PRIV messages with a sequence number.

#### Unknown AP\_REQ

|                          |                                                                                                                                                         |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Unknown\_AP-REQ                                                                                                                                         |
| **Priority**             | P0                                                                                                                                                      |
| **Description **         |                                                                                                                                                         |
| **Prerequisites**        | Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                       |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                             
                                                                                                                                                                                     
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                      
                                                                                                                                                                                     
                            3.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                            
                                                                                                                                                                                     
                            > Forge a faked and an ill-formed AP\_REQ                                                                                                                
                                                                                                                                                                                     
                            1.  AP returns AP session setup response                                                                                                                 
                                                                                                                                                                                     
                            > AP\_REP zero length (isKile1)                                                                                                                          |
| **Requirements covered** | isKile:                                                                                                                                                 
                                                                                                                                                                                     
                            1.  KILE will return a zero-length message whenever it receives a message that is either not well-formed or not supported. (\[MS-KILE\] section 3.4.5);  |
| **Cleanup**              |                                                                                                                                                         |

#### Key Cache

|                          |                                                                                                                                                                                                     |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Key\_Cache                                                                                                                                                                                          |
| **Priority**             | P0                                                                                                                                                                                                  |
| **Description **         |                                                                                                                                                                                                     |
| **Prerequisites**        |                                                                                                                                                                                                     |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                         
                                                                                                                                                                                                                                 
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                  
                                                                                                                                                                                                                                 
                            3.  Client sends AS\_REQ                                                                                                                                                                             
                                                                                                                                                                                                                                 
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                           
                                                                                                                                                                                                                                 
                            5.  Client sends AS\_REQ                                                                                                                                                                             
                                                                                                                                                                                                                                 
                            6.  KDC return AS\_REP                                                                                                                                                                               
                                                                                                                                                                                                                                 
                            7.  Client send TGS\_REQ                                                                                                                                                                             
                                                                                                                                                                                                                                 
                            8.  KDC returns TGS\_REP                                                                                                                                                                             
                                                                                                                                                                                                                                 
                            > ticket: service ticket with old key                                                                                                                                                                
                                                                                                                                                                                                                                 
                            1.  Change machine password from both AP and KDC side                                                                                                                                                
                                                                                                                                                                                                                                 
                            2.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                        
                                                                                                                                                                                                                                 
                            3.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                         
                                                                                                                                                                                                                                 
                            > Ticket can’t be decrypted by the new password, file server tries to use the old versions of passwords. (isKile1)                                                                                   |
| **Requirements covered** | isKile:                                                                                                                                                                                             
                                                                                                                                                                                                                                 
                            1.  If the decryption of the ticket fails and the KILE server has older versions of the server key, the server SHOULD retry decrypting the ticket with the older keys. (\[MS-KILE\] section 3.4.5);  |
| **Cleanup**              | Change machine password back from both AP and KDC side.                                                                                                                                             |

#### Detect Ticket Modification

|                          |                                                                                                                                                        |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Detect\_Ticket\_Modification                                                                                                                           |
| **Priority**             | P0                                                                                                                                                     |
| **Description **         |                                                                                                                                                        |
| **Prerequisites**        |                                                                                                                                                        |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                            
                                                                                                                                                                                    
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                     
                                                                                                                                                                                    
                            3.  Client sends AS\_REQ                                                                                                                                
                                                                                                                                                                                    
                            4.  KDC returns KRB\_ERROR                                                                                                                              
                                                                                                                                                                                    
                            5.  Client sends AS\_REQ                                                                                                                                
                                                                                                                                                                                    
                            6.  KDC return AS\_REP                                                                                                                                  
                                                                                                                                                                                    
                            7.  Client send TGS\_REQ                                                                                                                                
                                                                                                                                                                                    
                            8.  KDC returns TGS\_REP                                                                                                                                
                                                                                                                                                                                    
                            > ticket: service ticket                                                                                                                                
                                                                                                                                                                                    
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                           
                                                                                                                                                                                    
                            > Send a modified service ticket                                                                                                                        
                                                                                                                                                                                    
                            1.  AP returns KRB\_AP\_ERR\_MODIFIED (isKile1)                                                                                                         |
| **Requirements covered** | isKile:                                                                                                                                                
                                                                                                                                                                                    
                            1.  If the decryption routines detect a modification of the ticket, the KRB\_AP\_ERR\_MODIFIED error message is returned. (\[MS-KILE\] section 3.4.5);  |
| **Cleanup**              |                                                                                                                                                        |

#### Detect Authenticator Modification

|                          |                                                                                                                                                               |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Detect\_Authenticator\_Modification                                                                                                                           |
| **Priority**             | P0                                                                                                                                                            |
| **Description **         |                                                                                                                                                               |
| **Prerequisites**        | Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                             |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                   
                                                                                                                                                                                           
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                            
                                                                                                                                                                                           
                            3.  Client sends AS\_REQ                                                                                                                                       
                                                                                                                                                                                           
                            4.  KDC returns KRB\_ERROR                                                                                                                                     
                                                                                                                                                                                           
                            5.  Client sends AS\_REQ                                                                                                                                       
                                                                                                                                                                                           
                            6.  KDC return AS\_REP                                                                                                                                         
                                                                                                                                                                                           
                            7.  Client send TGS\_REQ                                                                                                                                       
                                                                                                                                                                                           
                            8.  KDC returns TGS\_REP                                                                                                                                       
                                                                                                                                                                                           
                            > ticket: service ticket                                                                                                                                       
                                                                                                                                                                                           
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                  
                                                                                                                                                                                           
                            > Send a modified authenticator                                                                                                                                
                                                                                                                                                                                           
                            1.  AP returns KRB\_AP\_ERR\_MODIFIED (isKile1)                                                                                                                |
| **Requirements covered** | isKile:                                                                                                                                                       
                                                                                                                                                                                           
                            1.  If the decryption routines detect a modification of the authenticator, the KRB\_AP\_ERR\_MODIFIED error message is returned. (\[MS-KILE\] section 3.4.5);  |
| **Cleanup**              |                                                                                                                                                               |

#### Three-Leg DCE-Style Mutual Authentication

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Three-Leg\_DCE-Style\_Mutual\_Authentication                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Description **         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Prerequisites**        | Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            Set MutualAuthentication=TRUE for client’s security context;                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            Set ChannelBinding=FALSE for client’s security context;                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            Set ApplicationRequiresCBT=FALSE for server’s security context;                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            5.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            6.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            7.  Client sends AP session setup request (AP\_REQ NOT wrapped in GSS formatting, AP\_REP not encapsulated.)                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > Header + AP\_REQ (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > Signature and encryption message without length of application data.                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            1.  AP sends AP session setup response (AP\_REP NOT wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > Header + AP\_REP (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            1.  Client sends SMB3 session setup request (AP\_REP NOT wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > Header + AP\_REP (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > Additional AP\_REP, the same as is received from the last message.                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                            > Set GSS\_C\_DCE\_STYLE flag to TRUE in the authenticator cksum field.                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            1.  An application protocol using the Kerberos protocol must exchange application protocol messages with Kerberos signing or encryption applied in order to verify mutual authentication. DCE, in the authn\_dce\_secret authentication service mandated that mutual authentication be verified before any RPC messages were exchanged. To accommodate that requirement, the DCE Kerberos implementation issued an additional AP\_REPLY message from the client to the server as part of the AP exchange subprotocol.  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > Kerberos V5 is not interoperable with the DCE authn\_dce\_secret security protocol. KILE MUST have compatible extensions for third-party extensions. KILE emulates this behavior as follows:                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            -   The AP-REQ message MUST NOT have GSS-API wrapping. It is sent as is without encapsulating it in a header.                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            -   The signature message and the encryption message MUST NOT include the length of the application data; they are no longer RFC 1964–compliant.                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            -   The client MUST generate an additional AP reply message exactly as the server would as the final message to send to the server. The client SHOULD set the GSS\_C\_DCE\_STYLE flag to TRUE in the authenticator's checksum field. In GSS terms, the client must return success and a message to the server. It is up to the application to deliver the message to the server.                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            -   The server MUST receive the additional AP reply message and verify that the message is constructed correctly.                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > The GSS\_Wrap() and GSS\_WrapEx() methods are not supported with DCE Style authentication. (\[MS-KILE\] section 3.4.5.1);                                                                                                                                                                                                                                                                                                                                                                                            |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

#### Datagram-Style Authentication

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Datagram-Style\_Mutual\_Authentication                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Description **         | Not very sure about this case.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Prerequisites**        | Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            Set MutualAuthentication=TRUE for client’s security context;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            Set UseSessionKey=TRUE for client’s security context;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            Set ChannelBinding=FALSE for client’s security context;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            Set ApplicationRequiresCBT=FALSE for server’s security context;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            Set registry key ClaimsCompIdFASTSupport to 0 on the KDC (don’t use group policy);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            Set attribute msDS-SupportedEncryptionTypes to 0x1C for the krbtgt/contoso.com object in AD;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            5.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            6.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > ticket: service ticket (include PAC)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  Client sends AP session setup request (AP\_REQ not wrapped in GSS formatting, AP\_REP not encapsulated.)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > Header + AP\_REQ (no authenticator)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > Signature and encryption message without length of application data.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  AP sends AP session setup response (Demand for authenticator)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > Header + AP\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  Client sends AP session setup request (AP\_REQ not wrapped in GSS formatting, AP\_REP not encapsulated.)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > Header + AP\_REQ (with authenticator)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > Signature and encryption message without length of application data.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  AP sends AP session setup response (AP\_REP not wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > Header + AP\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  Client decide what session key to use for next messages. Subkey not used anymore in this case. (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  Datagram-style authentication is another DCE RPC-inspired variation. In summary, datagram style initializes the security context but does not transmit the authentication message. Instead, the first application data packet is signed or encrypted as decided by the higher-level application protocol and sent to the server. The server, presented with a packet for which it has no security context, sends a demand for authentication back to the client. At that point, the client sends the authentication token previously obtained from the authentication mechanism. Authentication proceeds as normal.                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > When authentication is complete, the server verifies or decrypts the application packet. An application protocol that uses this datagram capability MUST have the means within the application protocol to indicate the nature of the security mechanism that is used (if mechanisms other than the Kerberos V5 protocol are possible), and the nature of the protection (signature or encryption) that is applied to the application protocol message. For DCE RPC the application packet is not retransmitted. Therefore, the session key that will be used MUST be decided by the client before any communication with the server. This precludes the sub-session key option of the Kerberos V5 protocol. (\[MS-KILE\] section 3.4.5.2);  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |

#### ImpersonationAccessToken

For KILE implementations that use a security identifier (SID)-based authorization model, the server SHOULD populate the User SID and Security Group SIDs in the ImpersonationAccessToken parameter as follows: … (\[MS-KILE\] section 3.4.5.3);

#### LDAP AP Without PAC

|                          |                                                                                   |
|--------------------------|-----------------------------------------------------------------------------------|
| **Test ID**              | Normal                                                                            |
| **Priority**             | P0 (BVT)                                                                          |
| **Description **         | This test case is designed to go through the whole process with default settings. |
| **Prerequisites**        |                                                                                   |
| **Test Execution Steps** | 1.  Client sends AS \_REQ (no pre-authentication)                                 
                                                                                                               
                                1.  kdc-options: RENEWABLE, FORWARDABLE, CANONICALIZE                          
                                                                                                               
                            2.  KDC returns KRB\_ERROR                                                         
                                                                                                               
                                1.  e-data: PA-ENC-TIMESTAMP                                                   
                                                                                                               
                            3.  Client sends AS\_REQ                                                           
                                                                                                               
                            > padata: PA-ENC-TIMESTAMP                                                         
                                                                                                               
                            1.  kdc-options: INITIAL, PRE-AUTHENT, RENEWABLE, FORWARDABLE, CANONICALIZE        
                                                                                                               
                            <!-- -->                                                                           
                                                                                                               
                            1.  KDC return AS\_REP                                                             
                                                                                                               
                            > ticket: user TGT                                                                 
                            >                                                                                  
                            > flags: FORWARDABLE, RENEWABLE, PRE-AUTHENT                                       
                                                                                                               
                            1.  Client send TGS\_REQ                                                           
                                                                                                               
                                1.  sname: ldap/ap01.contoso.com                                               
                                                                                                               
                            2.  KDC returns TGS response                                                       
                                                                                                               
                            > crealm: contoso.com                                                              
                            >                                                                                  
                            > cname: &lt;username&gt;                                                          
                            >                                                                                  
                            > ticket: service ticket                                                           
                            >                                                                                  
                            > realm: contoso.com                                                               
                            >                                                                                  
                            > sname: ldap/ap01.contoso.com                                                     
                            >                                                                                  
                            > flags: FORWARDABLE, RENEWABLE                                                    
                            >                                                                                  
                            > key: session key                                                                 
                            >                                                                                  
                            > crealm: contoso.com                                                              
                            >                                                                                  
                            > cname: &lt;username&gt;                                                          
                            >                                                                                  
                            > key: session key                                                                 
                            >                                                                                  
                            > flags: FORWARDABLE, RENEWABLE                                                    
                            >                                                                                  
                            > srealm: contoso.com                                                              
                            >                                                                                  
                            > sname: ldap/ap01.contoso.com                                                     
                                                                                                               
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)       
                                                                                                               
                            > ap-options: use-session-key, mutual authentication                               
                            >                                                                                  
                            > ticket: service ticket                                                           
                            >                                                                                  
                            > realm: contoso.com                                                               
                            >                                                                                  
                            > sname: ldap/ap01.contoso.com                                                     
                            >                                                                                  
                            > flags:                                                                           
                            >                                                                                  
                            > key: session key                                                                 
                            >                                                                                  
                            > crealm: contoso.com                                                              
                            >                                                                                  
                            > cname: &lt;username&gt;                                                          
                            >                                                                                  
                            > authenticator:                                                                   
                            >                                                                                  
                            > crealm: contoso.com                                                              
                            >                                                                                  
                            > cname: &lt;username&gt;                                                          
                                                                                                               
                            1.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)        |
| **Requirements covered** |                                                                                   |
| **Cleanup**              |                                                                                   |
| **Cleanup**              |                                                                                   |

#### LDAP AP with PAC

|                          |                                                                                                             |
|--------------------------|-------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Normal                                                                                                      |
| **Priority**             | P0 (BVT)                                                                                                    |
| **Description **         | This test case is designed to go through the whole process with default settings.                           |
| **Prerequisites**        |                                                                                                             |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                 
                                                                                                                                         
                            2.  AP returns AP Negotiate response (use Kerberos)                                                          
                                                                                                                                         
                            3.  Client sends AS \_REQ (no pre-authentication)                                                            
                                                                                                                                         
                                1.  kdc-options: RENEWABLE, FORWARDABLE, CANONICALIZE                                                    
                                                                                                                                         
                            4.  KDC returns KRB\_ERROR                                                                                   
                                                                                                                                         
                                1.  e-data: PA-ENC-TIMESTAMP                                                                             
                                                                                                                                         
                            5.  Client sends AS\_REQ                                                                                     
                                                                                                                                         
                            > padata: PA-ENC-TIMESTAMP, PA-PAC-REQUEST, PA-PAC-OPTIONS(forward to full DC)                               
                                                                                                                                         
                            1.  kdc-options: INITIAL, PRE-AUTHENT, RENEWABLE, FORWARDABLE, CANONICALIZE                                  
                                                                                                                                         
                            <!-- -->                                                                                                     
                                                                                                                                         
                            1.  KDC return AS\_REP                                                                                       
                                                                                                                                         
                            > ticket: user TGT                                                                                           
                            >                                                                                                            
                            > flags: FORWARDABLE, RENEWABLE, PRE-AUTHENT                                                                 
                            >                                                                                                            
                            > authorization-data: PAC, KERB\_VALIDATION\_INFO, PAC\_CLIENT\_INFO, PAC\_SIGNATURE\_DATA, UPN\_DNS\_INFO,  
                            >                                                                                                            
                            > enc-padata: PA-SUPPORTED-ENCTYPES (165) = 0x1F                                                             
                                                                                                                                         
                            1.  Client send TGS\_REQ                                                                                     
                                                                                                                                         
                                1.  sname: ldap/ap01.contoso.com                                                                         
                                                                                                                                         
                                    > enc-authorization-data: KERB-LOCAL                                                                 
                                                                                                                                         
                            2.  KDC returns TGS response                                                                                 
                                                                                                                                         
                            > crealm: contoso.com                                                                                        
                            >                                                                                                            
                            > cname: &lt;username&gt;                                                                                    
                            >                                                                                                            
                            > ticket: service ticket                                                                                     
                            >                                                                                                            
                            > realm: contoso.com                                                                                         
                            >                                                                                                            
                            > sname: ldap/ap01.contoso.com                                                                               
                            >                                                                                                            
                            > flags: FORWARDABLE, RENEWABLE                                                                              
                            >                                                                                                            
                            > key: session key                                                                                           
                            >                                                                                                            
                            > crealm: contoso.com                                                                                        
                            >                                                                                                            
                            > cname: &lt;username&gt;                                                                                    
                            >                                                                                                            
                            > authorization-data: KERB-LOCAL                                                                             
                            >                                                                                                            
                            > key: session key                                                                                           
                            >                                                                                                            
                            > flags: FORWARDABLE, RENEWABLE                                                                              
                            >                                                                                                            
                            > srealm: contoso.com                                                                                        
                            >                                                                                                            
                            > sname: ldap/ap01.contoso.com                                                                               
                            >                                                                                                            
                            > enc-padata: PA-SUPPORTED-ENCTYPES                                                                          
                                                                                                                                         
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                 
                                                                                                                                         
                            > ap-options: use-session-key, mutual authentication                                                         
                            >                                                                                                            
                            > ticket: service ticket                                                                                     
                            >                                                                                                            
                            > realm: contoso.com                                                                                         
                            >                                                                                                            
                            > sname: ldap/ap01.contoso.com                                                                               
                            >                                                                                                            
                            > flags:                                                                                                     
                            >                                                                                                            
                            > key: session key                                                                                           
                            >                                                                                                            
                            > crealm: contoso.com                                                                                        
                            >                                                                                                            
                            > cname: &lt;username&gt;                                                                                    
                            >                                                                                                            
                            > authorization-data: PAC                                                                                    
                            >                                                                                                            
                            > authenticator: PAC info                                                                                    
                            >                                                                                                            
                            > crealm: contoso.com                                                                                        
                            >                                                                                                            
                            > cname: &lt;username&gt;                                                                                    
                            >                                                                                                            
                            > authorization-data(authenticator): PAC, KERB-LOCAL, KERB-AUTH-DATA-TOKEN-RESTRICTIONS                      
                                                                                                                                         
                            1.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)                                  |
| **Requirements covered** |                                                                                                             |
| **Cleanup**              |                                                                                                             |
| **Cleanup**              |                                                                                                             |

#### LDAP AP with PAC and Claims

|                          |                                                                                                                                       |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Normal                                                                                                                                |
| **Priority**             | P0 (BVT)                                                                                                                              |
| **Description **         | This test case is designed to go through the whole process with default settings.                                                     |
| **Prerequisites**        |                                                                                                                                       |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                           
                                                                                                                                                                   
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                    
                                                                                                                                                                   
                            3.  Client sends AS \_REQ (no pre-authentication)                                                                                      
                                                                                                                                                                   
                                1.  kdc-options: RENEWABLE, FORWARDABLE, CANONICALIZE                                                                              
                                                                                                                                                                   
                            4.  KDC returns KRB\_ERROR                                                                                                             
                                                                                                                                                                   
                                1.  e-data: PA-ENC-TIMESTAMP                                                                                                       
                                                                                                                                                                   
                            5.  Client sends AS\_REQ                                                                                                               
                                                                                                                                                                   
                            > padata: PA-ENC-TIMESTAMP, PA-PAC-REQUEST, PA-PAC-OPTIONS(Claim, forward to full DC)                                                  
                                                                                                                                                                   
                            1.  kdc-options: INITIAL, PRE-AUTHENT, RENEWABLE, FORWARDABLE, CANONICALIZE                                                            
                                                                                                                                                                   
                            <!-- -->                                                                                                                               
                                                                                                                                                                   
                            1.  KDC return AS\_REP                                                                                                                 
                                                                                                                                                                   
                            > ticket: user TGT                                                                                                                     
                            >                                                                                                                                      
                            > flags: FORWARDABLE, RENEWABLE, PRE-AUTHENT                                                                                           
                            >                                                                                                                                      
                            > authorization-data: PAC, KERB\_VALIDATION\_INFO, PAC\_CLIENT\_INFO, PAC\_SIGNATURE\_DATA, UPN\_DNS\_INFO, PAC\_CLIENT\_CLAIMS\_INFO  
                            >                                                                                                                                      
                            > enc-padata: PA-SUPPORTED-ENCTYPES (165) = 0x1F                                                                                       
                                                                                                                                                                   
                            1.  Client send TGS\_REQ                                                                                                               
                                                                                                                                                                   
                                1.  sname: ldap/ap01.contoso.com                                                                                                   
                                                                                                                                                                   
                                    > enc-authorization-data: KERB-LOCAL                                                                                           
                                                                                                                                                                   
                            2.  KDC returns TGS response                                                                                                           
                                                                                                                                                                   
                            > crealm: contoso.com                                                                                                                  
                            >                                                                                                                                      
                            > cname: &lt;username&gt;                                                                                                              
                            >                                                                                                                                      
                            > ticket: service ticket                                                                                                               
                            >                                                                                                                                      
                            > realm: contoso.com                                                                                                                   
                            >                                                                                                                                      
                            > sname: ldap/ap01.contoso.com                                                                                                         
                            >                                                                                                                                      
                            > flags: FORWARDABLE, RENEWABLE                                                                                                        
                            >                                                                                                                                      
                            > key: session key                                                                                                                     
                            >                                                                                                                                      
                            > crealm: contoso.com                                                                                                                  
                            >                                                                                                                                      
                            > cname: &lt;username&gt;                                                                                                              
                            >                                                                                                                                      
                            > authorization-data: KERB-LOCAL                                                                                                       
                            >                                                                                                                                      
                            > key: session key                                                                                                                     
                            >                                                                                                                                      
                            > flags: FORWARDABLE, RENEWABLE                                                                                                        
                            >                                                                                                                                      
                            > srealm: contoso.com                                                                                                                  
                            >                                                                                                                                      
                            > sname: ldap/ap01.contoso.com                                                                                                         
                            >                                                                                                                                      
                            > enc-padata: PA-SUPPORTED-ENCTYPES                                                                                                    
                                                                                                                                                                   
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                                           
                                                                                                                                                                   
                            > ap-options: use-session-key, mutual authentication                                                                                   
                            >                                                                                                                                      
                            > ticket: service ticket                                                                                                               
                            >                                                                                                                                      
                            > realm: contoso.com                                                                                                                   
                            >                                                                                                                                      
                            > sname: ldap/ap01.contoso.com                                                                                                         
                            >                                                                                                                                      
                            > flags:                                                                                                                               
                            >                                                                                                                                      
                            > key: session key                                                                                                                     
                            >                                                                                                                                      
                            > crealm: contoso.com                                                                                                                  
                            >                                                                                                                                      
                            > cname: &lt;username&gt;                                                                                                              
                            >                                                                                                                                      
                            > authorization-data: PAC                                                                                                              
                            >                                                                                                                                      
                            > authenticator: PAC info                                                                                                              
                            >                                                                                                                                      
                            > crealm: contoso.com                                                                                                                  
                            >                                                                                                                                      
                            > cname: &lt;username&gt;                                                                                                              
                            >                                                                                                                                      
                            > authorization-data(authenticator): PAC, KERB-LOCAL, KERB-AUTH-DATA-TOKEN-RESTRICTIONS                                                
                                                                                                                                                                   
                            1.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)                                                            |
| **Requirements covered** |                                                                                                                                       |
| **Cleanup**              |                                                                                                                                       |
| **Cleanup**              |                                                                                                                                       |

1.  ### Claims

    1.  #### Normal

|                          |                                                                                                                  |
|--------------------------|------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Normal                                                                                                           |
| **Priority**             | P0 (BVT)                                                                                                         |
| **Description **         |                                                                                                                  |
| **Prerequisites**        | Join client computer to the “contoso.com” domain;                                                                
                                                                                                                                              
                            Join AP to the “contoso.com” domain;                                                                              
                                                                                                                                              
                            Create &lt;username&gt; user account in the “contoso.com” domain;                                                 
                                                                                                                                              
                            Add claims information to &lt;username&gt; account;                                                               
                                                                                                                                              
                            Set Delegate=TRUE for client’s security context;                                                                  
                                                                                                                                              
                            Set MutualAuthentication=TRUE for client’s security context;                                                      
                                                                                                                                              
                            Set UseSessionKey=TRUE for client’s security context;                                                             
                                                                                                                                              
                            Set ApplicationRequiresCBT=FALSE for server’s security context;                                                   
                                                                                                                                              
                            Set registry key ClaimsCompIdFASTSupport to 1 on the KDC (don’t use group policy).                                
                                                                                                                                              
                            Set attribute msDS-SupportedEncryptionTypes to 0x4001C for the krbtgt/contoso.com object in AD;                   
                                                                                                                                              
                            Set attribute msDS-SupportedEncryptionTypes to 0x4001C for the cifs/&lt;servername&gt;.contoso.com object in AD;  
                                                                                                                                              
                            Purge ticket cache on client computer;                                                                            |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                      
                                                                                                                                              
                            2.  AP returns AP Negotiate response (use Kerberos)                                                               
                                                                                                                                              
                            3.  Client sends AS \_REQ (no pre-authentication)                                                                 
                                                                                                                                              
                            4.  KDC returns KRB\_ERROR                                                                                        
                                                                                                                                              
                            5.  Client sends AS\_REQ                                                                                          
                                                                                                                                              
                            > padata: PA-PAC-REQUEST, PA-PAC-OPTIONS(claims, forward to full DC)                                              
                                                                                                                                              
                            1.  KDC return AS\_REP                                                                                            
                                                                                                                                              
                            > ticket: user TGT                                                                                                
                            >                                                                                                                 
                            > authorization-data: PAC\_CLIENT\_CLAIMS\_INFO                                                                   
                            >                                                                                                                 
                            > enc-padata: PA-SUPPORTED-ENCTYPES (claims)                                                                      
                                                                                                                                              
                            1.  Client send TGS\_REQ                                                                                          
                                                                                                                                              
                            2.  KDC returns TGS response                                                                                      
                                                                                                                                              
                            > ticket: service ticket                                                                                          
                            >                                                                                                                 
                            > authorization-data: PAC\_CLIENT\_CLAIMS\_INFO                                                                   
                            >                                                                                                                 
                            > enc-padata: PA-SUPPORTED-ENCTYPES (claims)                                                                      
                                                                                                                                              
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                      
                                                                                                                                              
                            2.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)                                       |
| **Requirements covered** |                                                                                                                  |
| **Cleanup**              |                                                                                                                  |

#### Request Claims for Computer

|                          |                                                                                                                                                                                                                                                                         |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Request\_Claims\_for\_Computer                                                                                                                                                                                                                                          |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                |
| **Description **         | This test case is designed to verify if the KDC supports claims request.                                                                                                                                                                                                |
| **Prerequisites**        |                                                                                                                                                                                                                                                                         |
| **Test Execution Steps** | 1.  Client sends AS \_REQ (no pre-authentication)                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                     
                            > padata: PA-PAC-REQUEST, PA-PAC-OPTIONS(claims) (isClaims1)                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                     
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                     
                                1.  e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                     
                            2.  Client sends AS\_REQ                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                     
                            > padata: PA-ENC-TIMESTAMP, PA-PAC-REQUEST, PA-PAC-OPTIONS(claims)                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                     
                            1.  KDC return AS\_REP                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                     
                            > ticket: computer TGT                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                        
                            > authorization-data: NOT SURE!! (isClaims1)                                                                                                                                                                                                                             
                            >                                                                                                                                                                                                                                                                        
                            > enc-padata: PA-SUPPORTED-ENCTYPES = 0x40000 (isClaims2)                                                                                                                                                                                                                |
| **Requirements covered** | isClaims:                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                     
                            1.  When sending the AS REQ, add a PA-PAC-OPTIONS \[167\] PA-DATA type with the Claims bit set in the AS REQ to request claims authorization data. (\[MS-KILE\] section 3.2.5.4);                                                                                        
                                                                                                                                                                                                                                                                                                     
                            2.  The KDC SHOULD return in the encrypted part of the AS-REP message PA-DATA with padata-type set to PA-SUPPORTED-ENCTYPES (165), to indicate what encryption types are supported by the KDC, and whether Claims or FAST are supported. (\[MS-KILE\] section 3.3.5.3);  |
| **Cleanup**              |                                                                                                                                                                                                                                                                         |

#### Request Claims for User

|                          |                                                                                                                                                                                                                                                                         |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Request\_Claims\_for\_User                                                                                                                                                                                                                                              |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                |
| **Description **         | This test case is designed to verify if the KDC supports claims request.                                                                                                                                                                                                |
| **Prerequisites**        |                                                                                                                                                                                                                                                                         |
| **Test Execution Steps** | 1.  Client sends AS \_REQ (no pre-authentication)                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                     
                            > padata: PA-PAC-REQUEST, PA-PAC-OPTIONS(claims) (isClaims1)                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                     
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                     
                                1.  e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                     
                            2.  Client sends AS\_REQ                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                     
                            > padata: PA-ENC-TIMESTAMP, PA-PAC-REQUEST, PA-PAC-OPTIONS(claims)                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                     
                            1.  KDC return AS\_REP                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                     
                            > ticket: user TGT                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                        
                            > authorization-data: PAC\_CLIENT\_CLAIMS\_INFO (isClaims1)                                                                                                                                                                                                              
                            >                                                                                                                                                                                                                                                                        
                            > enc-padata: PA-SUPPORTED-ENCTYPES = 0x40000 (isClaims2)                                                                                                                                                                                                                |
| **Requirements covered** | isClaims:                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                     
                            1.  When sending the AS REQ, add a PA-PAC-OPTIONS \[167\] PA-DATA type with the Claims bit set in the AS REQ to request claims authorization data. (\[MS-KILE\] section 3.2.5.4);                                                                                        
                                                                                                                                                                                                                                                                                                     
                            2.  The KDC SHOULD return in the encrypted part of the AS-REP message PA-DATA with padata-type set to PA-SUPPORTED-ENCTYPES (165), to indicate what encryption types are supported by the KDC, and whether Claims or FAST are supported. (\[MS-KILE\] section 3.3.5.3);  |
| **Cleanup**              |                                                                                                                                                                                                                                                                         |

#### Locate a DS\_BEHAVIOR\_WIN8 DC

|                          |                                                                                                                                                                                                                    |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Locate a DS\_BEHAVIOR\_WIN8 DC                                                                                                                                                                                     |
| **Priority**             | P0                                                                                                                                                                                                                 |
| **Description **         | This test case is designed to verify if the client can locate a Win8 DC.                                                                                                                                           |
| **Prerequisites**        |                                                                                                                                                                                                                    |
| **Test Execution Steps** | 1.  Client sends AS \_REQ (no pre-authentication)                                                                                                                                                                  
                                                                                                                                                                                                                                                
                            > padata: PA-PAC-REQUEST, PA-PAC-OPTIONS(claims)                                                                                                                                                                    
                                                                                                                                                                                                                                                
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                          
                                                                                                                                                                                                                                                
                                1.  e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                    
                                                                                                                                                                                                                                                
                            2.  Client sends AS\_REQ                                                                                                                                                                                            
                                                                                                                                                                                                                                                
                            > padata: PA-ENC-TIMESTAMP, PA-PAC-REQUEST, PA-PAC-OPTIONS(claims)                                                                                                                                                  
                                                                                                                                                                                                                                                
                            1.  KDC return AS\_REP                                                                                                                                                                                              
                                                                                                                                                                                                                                                
                            > Padata: PA-PAC-OPTIONS (claims not set) (isClaims1)                                                                                                                                                               
                            >                                                                                                                                                                                                                   
                            > ticket: user TGT                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                   
                            > authorization-data:                                                                                                                                                                                               
                            >                                                                                                                                                                                                                   
                            > enc-padata: PA-SUPPORTED-ENCTYPES = 0x40000 (isClaims1)                                                                                                                                                           
                                                                                                                                                                                                                                                
                            1.  Client locates a Win8 DC                                                                                                                                                                                        
                                                                                                                                                                                                                                                
                            2.  Client sends AS\_REQ                                                                                                                                                                                            
                                                                                                                                                                                                                                                
                            > padata: PA-ENC-TIMESTAMP, PA-PAC-REQUEST, PA-PAC-OPTIONS(claims)                                                                                                                                                  
                                                                                                                                                                                                                                                
                            1.  KDC return AS\_REP                                                                                                                                                                                              
                                                                                                                                                                                                                                                
                            > Padata: PA-PAC-OPTIONS (claims) (isClaims1)                                                                                                                                                                       
                            >                                                                                                                                                                                                                   
                            > ticket: user TGT                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                   
                            > authorization-data: PAC\_CLIENT\_CLAIMS\_INFO                                                                                                                                                                     
                            >                                                                                                                                                                                                                   
                            > enc-padata: PA-SUPPORTED-ENCTYPES = 0x40000 (isClaims1)                                                                                                                                                           |
| **Requirements covered** | isClaims:                                                                                                                                                                                                          
                                                                                                                                                                                                                                                
                            1.  When receiving the AS\_REP, if the Claims bit is set in PA-SUPPORTED-ENCTYPES \[165\], and not set in PA-PAC-OPTIONS \[167\], the client SHOULD locate a DS\_BEHAVIOR\_WIN8 DC. (\[MS-KILE\] section 3.2.5.4);  |
| **Cleanup**              |                                                                                                                                                                                                                    |

#### Using FAST

|                          |                                                                                                                                                                      |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Claims\_Using\_FAST                                                                                                                                                  |
| **Priority**             | P1                                                                                                                                                                   |
| **Description **         | This test case tests claims using FAST. This will result in authorization failure because no device claims information transmitted. Need Compound Identity support?? |
| **Prerequisites**        | Join client computer to the “contoso.com” domain;                                                                                                                    
                                                                                                                                                                                                  
                            Join file server to the “contoso.com” domain;                                                                                                                         
                                                                                                                                                                                                  
                            Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                     
                                                                                                                                                                                                  
                            Add claims information to &lt;username&gt; account;                                                                                                                   
                                                                                                                                                                                                  
                            Purge ticket cache on client computer;                                                                                                                                
                                                                                                                                                                                                  
                            Set registry key ClaimsCompIdFASTSupport = 2 on the KDC (don’t use group policy).                                                                                     
                                                                                                                                                                                                  
                            Set attribute msDS-SupportedEncryptionTypes to 0x5001C for the krbtgt/contoso.com object in AD;                                                                       
                                                                                                                                                                                                  
                            Set attribute msDS-SupportedEncryptionTypes to 0x5001C for the cifs/&lt;servername&gt;.contoso.com object in AD;                                                      |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                          
                                                                                                                                                                                                  
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                   
                                                                                                                                                                                                  
                            3.  Client sends AS \_REQ (no pre-authentication)                                                                                                                     
                                                                                                                                                                                                  
                            4.  KDC returns KRB\_ERROR                                                                                                                                            
                                                                                                                                                                                                  
                                1.  e-data: PA-FX-FAST                                                                                                                                            
                                                                                                                                                                                                  
                            5.  Client sends AS\_REQ                                                                                                                                              
                                                                                                                                                                                                  
                            6.  KDC return AS\_REP                                                                                                                                                
                                                                                                                                                                                                  
                            > ticket: computer TGT                                                                                                                                                
                            >                                                                                                                                                                     
                            > authorization-data: PAC\_DEVICE\_CLAIMS\_INFO??                                                                                                                     
                                                                                                                                                                                                  
                            1.  Client sends AS \_REQ (no pre-authentication)                                                                                                                     
                                                                                                                                                                                                  
                            2.  KDC returns KRB\_ERROR                                                                                                                                            
                                                                                                                                                                                                  
                                1.  e-data: PA-FX-FAST                                                                                                                                            
                                                                                                                                                                                                  
                            3.  Client sends FAST AS\_REQ                                                                                                                                         
                                                                                                                                                                                                  
                            > padata: PA-FX-FAST\[PA-PAC-REQUEST, PA-PAC-OPTIONS(claims)\]                                                                                                        
                                                                                                                                                                                                  
                            1.  KDC return FAST AS\_REP                                                                                                                                           
                                                                                                                                                                                                  
                            > ticket: user TGT                                                                                                                                                    
                            >                                                                                                                                                                     
                            > authorization-data: PAC\_CLIENT\_CLAIMS\_INFO                                                                                                                       
                            >                                                                                                                                                                     
                            > enc-padata: PA-SUPPORTED-ENCTYPES (claims)                                                                                                                          
                                                                                                                                                                                                  
                            1.  Client send FAST TGS\_REQ                                                                                                                                         
                                                                                                                                                                                                  
                            2.  KDC returns FAST TGS response                                                                                                                                     
                                                                                                                                                                                                  
                            > ticket: service ticket                                                                                                                                              
                            >                                                                                                                                                                     
                            > authorization-data: PAC\_CLIENT\_CLAIMS\_INFO, no PAC\_DEVICE\_CLAIMS\_INFO                                                                                         
                            >                                                                                                                                                                     
                            > enc-padata: PA-SUPPORTED-ENCTYPES (claims)                                                                                                                          
                                                                                                                                                                                                  
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                                                                          
                                                                                                                                                                                                  
                            2.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)                                                                                           |
| **Requirements covered** |                                                                                                                                                                      |
| **Cleanup**              |                                                                                                                                                                      |

1.  ### Compound Identity

    1.  #### Normal

|                          |                                                                                                 |
|--------------------------|-------------------------------------------------------------------------------------------------|
| **Test ID**              | CompId\_Normal                                                                                  |
| **Priority**             | P0 (BVT)                                                                                        |
| **Description **         |                                                                                                 |
| **Prerequisites**        | Join client computer to the “contoso.com” domain;                                               
                                                                                                                             
                            Join file server to the “contoso.com” domain;                                                    
                                                                                                                             
                            Create &lt;username&gt; user account in the “contoso.com” domain;                                
                                                                                                                             
                            Add claims information to &lt;username&gt; account;                                              
                                                                                                                             
                            Add claims information to &lt;clientcomputername&gt; accout;                                     
                                                                                                                             
                            Set Delegate=TRUE for client’s security context;                                                 
                                                                                                                             
                            Set MutualAuthentication=TRUE for client’s security context;                                     
                                                                                                                             
                            Set UseSessionKey=TRUE for client’s security context;                                            
                                                                                                                             
                            Set ApplicationRequiresCBT=FALSE for server’s security context;                                  
                                                                                                                             
                            Set registry key ClaimsCompIdFASTSupport to 3 on the KDC (don’t use group policy).               
                                                                                                                             
                            Set attribute msDS-SupportedEncryptionTypes to 0x7001C for the krbtgt/contoso.com object in AD;  
                                                                                                                             
                            Purge ticket cache on client computer;                                                           
                                                                                                                             
                            Create Share Folder on file server and configure CBAC.                                           |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                     
                                                                                                                             
                            2.  AP returns AP Negotiate response (use Kerberos)                                              
                                                                                                                             
                            3.  Client sends AS\_REQ for computer TGT                                                        
                                                                                                                             
                            4.  KDC returns KRB\_ERROR                                                                       
                                                                                                                             
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                 
                                                                                                                             
                            5.  Client sends AS\_REQ                                                                         
                                                                                                                             
                            6.  KDC return AS\_REP                                                                           
                                                                                                                             
                                1.  ticket: computer’s TGT                                                                   
                                                                                                                             
                                    > enc-padata: PA-SUPPORTED-ENCTYPES (compId)                                             
                                                                                                                             
                            7.  Client sends AS\_REQ                                                                         
                                                                                                                             
                            8.  KDC returns KRB\_ERROR                                                                       
                                                                                                                             
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                  
                                                                                                                             
                            9.  Client sends FAST AS\_REQ                                                                    
                                                                                                                             
                            10. KDC return FAST AS\_REP                                                                      
                                                                                                                             
                                1.  ticket: user’s TGT                                                                       
                                                                                                                             
                                    > enc-padata: PA-SUPPORTED-ENCTYPES(compId)                                              
                                                                                                                             
                            11. Client send Compound Identity TGS request                                                    
                                                                                                                             
                            12. KDC returns Compound Identity TGS response                                                   
                                                                                                                             
                            13. Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                     
                                                                                                                             
                            14. AP returns AP session setup response (AP-REP wrapped in GSS formatting)                      |
| **Requirements covered** |                                                                                                 |
| **Cleanup**              |                                                                                                 |

#### Request Computer TGT

|                          |                                                                                                                                                                         |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Request\_Computer\_TGT                                                                                                                                                  |
| **Priority**             | P0 (BVT)                                                                                                                                                                |
| **Description **         | This test case is designed to test if the client could request a computer TGT from the user principal’s domain.                                                         |
| **Prerequisites**        | Set user’s realm support FAST.                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                
                                                                                                                                                                                                     
                            2.  KDC returns KRB\_ERROR                                                                                                                                               
                                                                                                                                                                                                     
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                         
                                                                                                                                                                                                     
                            3.  Client sends AS\_REQ                                                                                                                                                 
                                                                                                                                                                                                     
                                1.  cname: &lt;clientcomputername&gt;                                                                                                                                
                                                                                                                                                                                                     
                                    > realm: &lt;user’s realm&gt;                                                                                                                                    
                                                                                                                                                                                                     
                            4.  KDC return AS\_REP                                                                                                                                                   
                                                                                                                                                                                                     
                            > ticket: computer’s TGT (isKile1)                                                                                                                                       
                                                                                                                                                                                                     
                            1.  srealm: &lt;user’s realm&gt;                                                                                                                                         
                                                                                                                                                                                                     
                                > enc-padata: PA-SUPPORTED-ENCTYPES = 0x70000 (isKile2)                                                                                                              |
| **Requirements covered** | isKile:                                                                                                                                                                 
                                                                                                                                                                                                     
                            1.  If the client does not have a TGT for the realm and is creating a:                                                                                                   
                                                                                                                                                                                                     
                            -   AS-REQ: the client SHOULD obtain a TGT for the computer principal from the user principal’s domain. (\[MS-KILE\] section 3.2.5.3);                                   
                                                                                                                                                                                                     
                            1.  In addition to the RFC behavior, the Kerberos client SHOULD use the PA-SUPPORTED-ENCTYPES from the TGT obtained from a realm to determine if a realm supports FAST.  |
| **Cleanup**              | Unset user’s realm support FAST.                                                                                                                                        |

#### Request User TGT

|                          |                                                                                                                                                                                                                                                                         |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Request\_User\_TGT                                                                                                                                                                                                                                                      |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                |
| **Description **         | This test case is designed to test if the client could request a user TGT from the user principal’s domain using FAST.                                                                                                                                                  |
| **Prerequisites**        | Set user’s realm support FAST.                                                                                                                                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer TGT                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                     
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                     
                            3.  Client sends AS\_REQ for computer TGT                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                     
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                     
                            5.  Client sends FAST AS\_REQ for user TGT                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                     
                            6.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                     
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                     
                            7.  Client sends FAST AS\_REQ for user TGT                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                     
                                1.  cname: &lt;username&gt;                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                     
                                    > realm: &lt;user’s realm&gt;                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                     
                            8.  KDC return FAST AS\_REP                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                     
                            > ticket: user’s TGT (isKile1)                                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                                        
                            > srealm: &lt;user’s realm&gt;                                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                                        
                            > enc-padata: PA-SUPPORTED-ENCTYPES = 0x70000 (isKile2)                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                     
                            1.  Client sends FAST TGS\_REQ (isKile1)                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                     
                            2.  KDC return FAST TGS\_REP                                                                                                                                                                                                                                             |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                     
                            1.  In addition to the RFC behavior, the Kerberos client SHOULD use the PA-SUPPORTED-ENCTYPES from the TGT obtained from a realm to determine if a realm supports FAST. (\[MS-KILE\] section 3.2.5.3);                                                                   
                                                                                                                                                                                                                                                                                                     
                                If the principal is not the computer account and the client is running on a domain-joined computer, the Kerberos client SHOULD use FAST when the principal’s Realm supports FAST. (\[MS-KILE\] section 3.2.5.4);                                                     
                                                                                                                                                                                                                                                                                                     
                            2.  The KDC SHOULD return in the encrypted part of the AS-REP message PA-DATA with padata-type set to PA-SUPPORTED-ENCTYPES (165), to indicate what encryption types are supported by the KDC, and whether Claims or FAST are supported. (\[MS-KILE\] section 3.3.5.3);  |
| **Cleanup**              | Unset user’s realm support FAST.                                                                                                                                                                                                                                        |

#### PAC\_DEVICE\_INFO

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | PAC\_DEVICE\_INFO                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Description **         | This test case is designed to test if the KDC supports PAC\_DEVICE\_INFO.                                                                                                                                                                                                                                                                                                                                                                               |
| **Prerequisites**        | Set attribute msDS-SupportedEncryptionTypes to 0x3001C for the krbtgt/contoso.com object in AD;                                                                                                                                                                                                                                                                                                                                                         |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer TGT                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            3.  Client sends AS\_REQ for computer TGT                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            5.  Client sends FAST AS\_REQ for user TGT                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            6.  KDC returns FAST AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            7.  Client sends Compound Identity TGS\_REQ for service ticket                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            8.  KDC returns Compound Identity TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > ticket: service ticket                                                                                                                                                                                                                                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > authorization-data: PAC\_DEVICE\_INFO (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            1.  If a compound identity TGS-REQ (FAST TGS-REQ explicitly armored with the computer’s ticket-granting ticket (TGT)) is received and a Compound Identity-supported bit is set in the application server's service account’s KerbSupportedEncryptionTypes, the KDC SHOULD add to the privilege attribute certificate (PAC) a PAC\_DEVICE\_INFO structure and PAC\_DEVICE\_CLAIMS\_INFO structure with the group membership and claims for the computer.  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

#### PAC\_DEVICE\_CLAIMS\_INFO

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | PAC\_DEVICE\_CLAIMS\_INFO                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Description **         | This test case is designed to test if the KDC supports PAC\_DEVICE\_CLAIMS\_INFO.                                                                                                                                                                                                                                                                                                                                                                       |
| **Prerequisites**        | Set attribute msDS-SupportedEncryptionTypes to 0x7001C for the krbtgt/contoso.com object in AD;                                                                                                                                                                                                                                                                                                                                                         |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer TGT                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            3.  Client sends AS\_REQ for computer TGT                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            5.  Client sends FAST AS\_REQ for user TGT                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            6.  KDC returns FAST AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            7.  Client sends Compound Identity TGS\_REQ for service ticket                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            8.  KDC returns Compound Identity TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            > ticket: service ticket                                                                                                                                                                                                                                                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                            > authorization-data: PAC\_DEVICE\_CLAIMS\_INFO (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                            1.  If a compound identity TGS-REQ (FAST TGS-REQ explicitly armored with the computer’s ticket-granting ticket (TGT)) is received and a Compound Identity-supported bit is set in the application server's service account’s KerbSupportedEncryptionTypes, the KDC SHOULD add to the privilege attribute certificate (PAC) a PAC\_DEVICE\_INFO structure and PAC\_DEVICE\_CLAIMS\_INFO structure with the group membership and claims for the computer.  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

1.  ### Authentication Silo

    1.  #### Network logon failed with computer A2A2

|                          |                                                                                                                                                                                                                                                                                           |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Protected\_Users\_Network\_Logon\_Computer\_A2A2\_Fail                                                                                                                                                                                                                                    |
| **Priority**             | P0                                                                                                                                                                                                                                                                                        |
| **Description **         | Access check the protected user with computerr’s AllowToAuthenticateTo policy set, and Enforced flag are set.                                                                                                                                                                             |
| **Prerequisites**        | All DC DFL&gt;=6                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                       
                            User is member of Protected users group                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                       
                            User is in the silo, with no policy linked                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                       
                            Enforced flag is true                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                       
                            Computer has authentication policy configured, and AllowedToAuthenticateTo is set                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                       
                            User doesn’t match the Computer’s A2A2 condition                                                                                                                                                                                                                                           |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                       
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                       
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                       
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                       
                                1.  ticket: computer’s TGT                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                       
                            5.  Client sends AS\_REQ for user account                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                       
                            6.  KDC returns KDC\_ERR\_POLICY                                                                                                                                                                                                                                                           |
| **Requirements covered** | 3.3.5.6 AS Exchange                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                       
                            If domainControllerFunctionality returns a value &gt;= 6, the KDC MUST determine whether an Authentication Policy is applied to the account (section 3.3.5.5). If Enforced is TRUE, then:&lt;51&gt;                                                                                        
                                                                                                                                                                                                                                                                                                                       
                             If TGTLifetime is not 0: MaxRenewAge for the TGT is TGTLifetime.                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                       
                             If TGTLifetime is not 0: MaxTicketAge for the TGT is TGTLifetime.                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                       
                             If AllowedToAuthenticateFrom is not NULL, the PAC of the armor TGT MUST be used to perform an access check for the ACTRL\_DS\_CONTROL\_ACCESS right with additional rights GUID against the AllowedToAuthenticateFrom. If the access check fails, the KDC MUST return KDC\_ERR\_POLICY.  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                           |

#### Network logon succeed with computer A2A2

|                          |                                                                                                                                                                                                                                                                                                               |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Protected\_Users\_Network\_Logon\_Computer\_A2A2\_Fail                                                                                                                                                                                                                                                        |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                            |
| **Description **         | Access check the protected user with computerr’s AllowToAuthenticateTo policy set, and Enforced flag are set.                                                                                                                                                                                                 |
| **Prerequisites**        | All DC DFL&gt;=6                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                           
                            User is member of Protected users group                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                           
                            User is in the silo, with no policy linked                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                           
                            Enforced flag is true                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                           
                            Computer has authentication policy configured, and AllowedToAuthenticateTo is set                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                           
                            User match the Computer’s A2A2 condition                                                                                                                                                                                                                                                                       |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                           
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                           
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                           
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                           
                                1.  ticket: computer’s TGT                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                           
                            5.  Client sends AS\_REQ for user account                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                           
                            6.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                           
                            7.  Client sends FAST AS\_REQ                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                           
                            8.  KDC returns FAST AS\_REP                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                           
                            > ticket: user’s TGT (isKile)                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                           
                            1.  Client sends FAST TGS\_REQ                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                           
                            > Armor ticket: user’s TGT (isKile)                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                           
                            1.  KDC returns TGS response(isKile)                                                                                                                                                                                                                                                                           |
| **Requirements covered** | isKile                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                           
                            3.3.5.6 AS Exchange                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                           
                            If domainControllerFunctionality returns a value &gt;= 6, the KDC MUST determine whether an Authentication Policy is applied to the account (section 3.3.5.5). If Enforced is TRUE, then:&lt;51&gt;                                                                                                            
                                                                                                                                                                                                                                                                                                                                           
                             If TGTLifetime is not 0: MaxRenewAge for the TGT is TGTLifetime.                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                           
                             If TGTLifetime is not 0: MaxTicketAge for the TGT is TGTLifetime.                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                           
                             If AllowedToAuthenticateFrom is not NULL, the PAC of the armor TGT MUST be used to perform an access check for the ACTRL\_DS\_CONTROL\_ACCESS right with additional rights GUID against the AllowedToAuthenticateFrom. If the access check fails, the KDC MUST return KDC\_ERR\_POLICY.                      
                                                                                                                                                                                                                                                                                                                                           
                            isKile                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                           
                            3.3.5.7 TGS Exchange                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                           
                            If domainControllerFunctionality returns a value &gt;= 6 (\[MS-ADTS\] section 3.1.1.3.2.25), the KDC MUST determine whether an Authentication Policy is applied to the server or service (section 3.3.5.5); if Enforced is TRUE then:&lt;61&gt;                                                                
                                                                                                                                                                                                                                                                                                                                           
                             If AllowedToAuthenticateTo is not NULL, the PAC of the user and the PAC of the armor TGT MUST be used to perform an access check for the ACTRL\_DS\_CONTROL\_ACCESS right with additional rights GUID against the AllowedToAuthenticateTo. If the access check fails, the KDC MUST return KDC\_ERR\_POLICY.  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                               |

1.  Multiple Domains: Network Logon Test
    ------------------------------------

    1.  ### Basic

        1.  #### Normal - User in another realm

|                          |                                                                              |
|--------------------------|------------------------------------------------------------------------------|
| **Test ID**              | Normal\_User\_in\_another\_realm                                             |
| **Priority**             | P0 (BVT)                                                                     |
| **Description **         |                                                                              |
| **Prerequisites**        | Create &lt;username&gt; user account in “kerb.com”;                          
                                                                                                          
                            Join client computer in “contoso.com” domain;                                 
                                                                                                          
                            Join File Server in “contoso.com” domain;                                     
                                                                                                          
                            Set Delegate=TRUE for client’s security context;                              
                                                                                                          
                            Set the service account as trusted for delegation;                            
                                                                                                          
                            Set domainControllerFunctionality &gt;= 3;                                    |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                  
                                                                                                          
                            2.  AP returns AP Negotiate response (use Kerberos)                           
                                                                                                          
                            3.  Client sends AS\_REQ                                                      
                                                                                                          
                            4.  KDC returns KRB\_ERROR                                                    
                                                                                                          
                            > Wrong realm                                                                 
                                                                                                          
                            1.  Client sends AS\_REQ                                                      
                                                                                                          
                            2.  KDC returns KRB\_ERROR                                                    
                                                                                                          
                            > Pre-authentication required                                                 
                                                                                                          
                            1.  Client sends AS\_REQ                                                      
                                                                                                          
                            2.  KDC return AS\_REP                                                        
                                                                                                          
                            > ticket: user TGT                                                            
                                                                                                          
                            1.  Client TGS\_REQ                                                           
                                                                                                          
                            2.  KDC TGS\_REP                                                              
                                                                                                          
                            > ticket: service ticket                                                      
                                                                                                          
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)  
                                                                                                          
                            2.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)   |
| **Requirements covered** |                                                                              |
| **Cleanup**              |                                                                              |

#### Normal - Resource in another realm

|                          |                                                                              |
|--------------------------|------------------------------------------------------------------------------|
| **Test ID**              | Normal\_Resource\_in\_another\_realm                                         
                                                                                                          
                            Case name: CrossRealmGetReferralTGT                                           |
| **Priority**             | P0 (BVT)                                                                     |
| **Description **         |                                                                              |
| **Prerequisites**        | Create &lt;username&gt; user account in “contoso.com”;                       
                                                                                                          
                            Join client computer in “contoso.com” domain;                                 
                                                                                                          
                            Join File Server in “kerb.com” domain;                                        
                                                                                                          
                            Set Delegate=TRUE for client’s security context;                              
                                                                                                          
                            Set the service account as trusted for delegation;                            
                                                                                                          
                            Set domainControllerFunctionality &gt;= 3;                                    |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                  
                                                                                                          
                            2.  AP returns AP Negotiate response (use Kerberos)                           
                                                                                                          
                            3.  Client sends AS\_REQ                                                      
                                                                                                          
                            4.  KDC returns KRB\_ERROR                                                    
                                                                                                          
                            5.  Client sends AS\_REQ                                                      
                                                                                                          
                            6.  KDC return AS\_REP                                                        
                                                                                                          
                            > ticket: user TGT                                                            
                                                                                                          
                            1.  Client send TGS\_REQ                                                      
                                                                                                          
                            > Flag: canonicalize                                                          
                                                                                                          
                            1.  KDC returns TGS\_REP                                                      
                                                                                                          
                            > ticket: referral user TGT to the resource’s domain                          
                            >                                                                             
                            > Realm: CONTOSO.COM                                                          
                            >                                                                             
                            > sname: krbtgt/KERB.COM                                                      
                            >                                                                             
                            > EncTicketPart:                                                              
                            >                                                                             
                            > Flags: forwardable(1) ?                                                     
                            >                                                                             
                            > Key: inter-key                                                              
                            >                                                                             
                            > crealm: contoso.com                                                         
                            >                                                                             
                            > cname: &lt;username&gt;                                                     
                            >                                                                             
                            > authorization-data:                                                         
                            >                                                                             
                            > PA-SVR-REFERRAL-INFO 20                                                     
                                                                                                          
                            PA-SVR-REFERRAL-DATA ::= SEQUENCE {                                           
                                                                                                          
                            > referred-name \[1\] PrincipalName OPTIONAL,                                 
                            >                                                                             
                            > referred-realm \[0\] Realm                                                  
                            >                                                                             
                            > }                                                                           
                                                                                                          
                            1.  Client send referral TGS\_REQ                                             
                                                                                                          
                            2.  KDC returns referral TGS\_REP                                             
                                                                                                          
                            > ticket: service ticket                                                      
                                                                                                          
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)  
                                                                                                          
                            2.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)   |
| **Requirements covered** |                                                                              |
| **Cleanup**              |                                                                              |

#### CANONICALIZE Flag

|                          |                                                                                                                                                                                                                                                                                                                                             |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | CANONICALIZE\_Flag                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                         
                            CanonicalizeSpnInReferralTgt                                                                                                                                                                                                                                                                                                                 |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                          |
| **Description **         | This test case is designed to verify if the CANONICALIZE ticket flag can be supported by the KDC.                                                                                                                                                                                                                                           |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                                             |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                         
                            > padata: no pre-authentication data                                                                                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                                                                                                            
                            > kdc-options: CANONICALIZE option                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                         
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                         
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                         
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                         
                            2.  Client sends AS request                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                         
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                         
                            > kdc-options: CANONICALIZE option                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                         
                            1.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                         
                            > ticket: user TGT (check existence)                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                         
                            1.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                         
                            > kdc-options: CANONICALIZE option                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                         
                            1.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                         
                            2.  Client sends referral TGS\_REQ                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                         
                            > kdc-options: CANONICALIZE option                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                         
                            1.  KDC returns referral TGS\_REP                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                         
                            > ticket: service ticket (check existence)                                                                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                                                                                            
                            > spn: check spn is canonicalized                                                                                                                                                                                                                                                                                                            |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                         
                            1.  In order to request referrals as defined in later sections, the Kerberos client MUST explicitly request the canonicalize KDC option for the AS-REQ or TGS-REQ. This flag indicates to the KDC that the client is prepared to receive a reply that contains a principal name other than the one requested. (\[Referrals-11\] section 3);  
                                                                                                                                                                                                                                                                                                                                                                         
                                Clients SHOULD set the canonicalize flag. For non-KILE realms, if RealmCanonicalize is not set for th realm, the client SHOULD NOT set the canonicalize flag. (\[MS-KILE\] section 3.2.5.1);                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                         
                                If the canonicalize flag is set, KILE KDCs SHOULD return the krbtgt/FQDN for the domain.                                                                                                                                                                                                                                                 |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                             |

#### CANONICALIZE Flag – kadmin/changepw

|                          |                                                                                                   |
|--------------------------|---------------------------------------------------------------------------------------------------|
| **Test ID**              | CANONICALIZE\_Flag – kadmin/changepw                                                              |
| **Priority**             | P0                                                                                                |
| **Description **         | This test case is designed to verify if the CANONICALIZE ticket flag can be supported by the KDC. |
| **Prerequisites**        |                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AS request                                                                       
                                                                                                                               
                            > padata: no pre-authentication data                                                               
                            >                                                                                                  
                            > kdc-options: CANONICALIZE option                                                                 
                                                                                                                               
                            1.  KDC returns KRB\_ERROR                                                                         
                                                                                                                               
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                   
                                                                                                                               
                                    > e-data: PA-ENC-TIMESTAMP                                                                 
                                                                                                                               
                            2.  Client sends AS request                                                                        
                                                                                                                               
                                1.  padata: PA-ENC-TIMESTAMP                                                                   
                                                                                                                               
                            3.  KDC returns AS\_REP                                                                            
                                                                                                                               
                            > ticket: user TGT (check existence)                                                               
                                                                                                                               
                            1.  Client sends TGS\_REQ                                                                          
                                                                                                                               
                            > kdc-options: CANONICALIZE option                                                                 
                            >                                                                                                  
                            > sname: kadmin/changepw                                                                           
                                                                                                                               
                            1.  KDC returns TGS\_REP                                                                           
                                                                                                                               
                            > flags: CANONICALIZE not set (isCommon1)                                                          |
| **Requirements covered** | isKile:                                                                                           
                                                                                                                               
                            1.  KILE KDCs SHOULD canonicalize principals unless:                                               
                                                                                                                               
                            -   …                                                                                              
                                                                                                                               
                            -   The server principal is kadmin/changepw.                                                       
                                                                                                                               
                                (\[MS-KILE\] section 3.3.5.1);                                                                 |
| **Cleanup**              |                                                                                                   |

#### CANONICALIZE Flag – account UseDESOnly

|                          |                                                                                                   |
|--------------------------|---------------------------------------------------------------------------------------------------|
| **Test ID**              | CANONICALIZE\_Flag – UseDESOnly                                                                   |
| **Priority**             | P0                                                                                                |
| **Description **         | This test case is designed to verify if the CANONICALIZE ticket flag can be supported by the KDC. |
| **Prerequisites**        | Set server or service account as UseDESOnly.                                                      |
| **Test Execution Steps** | 1.  Client sends AS request                                                                       
                                                                                                                               
                            > padata: no pre-authentication data                                                               
                            >                                                                                                  
                            > kdc-options: CANONICALIZE option                                                                 
                                                                                                                               
                            1.  KDC returns KRB\_ERROR                                                                         
                                                                                                                               
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                   
                                                                                                                               
                                    > e-data: PA-ENC-TIMESTAMP                                                                 
                                                                                                                               
                            2.  Client sends AS request                                                                        
                                                                                                                               
                                1.  padata: PA-ENC-TIMESTAMP                                                                   
                                                                                                                               
                            3.  KDC returns AS\_REP                                                                            
                                                                                                                               
                            > ticket: user TGT (check existence)                                                               
                                                                                                                               
                            1.  Client sends TGS\_REQ                                                                          
                                                                                                                               
                            > kdc-options: CANONICALIZE option                                                                 
                                                                                                                               
                            1.  KDC returns TGS\_REP                                                                           
                                                                                                                               
                            > flags: CANONICALIZE not set (isKile1)                                                            |
| **Requirements covered** | isKile:                                                                                           
                                                                                                                               
                            1.  KILE KDCs SHOULD canonicalize principals unless:                                               
                                                                                                                               
                            -   …                                                                                              
                                                                                                                               
                            -   …                                                                                              
                                                                                                                               
                            -   The account is marked as DES only.                                                             
                                                                                                                               
                                (\[MS-KILE\] section 3.3.5.1);                                                                 |
| **Cleanup**              |                                                                                                   |

#### TRANSITED-POLICY-CHECKED Flag

|                          |                                                                                                                                                                                                                           |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | TRANSITED-POLICY-CHECKED\_Flag                                                                                                                                                                                            |
| **Priority**             | P1                                                                                                                                                                                                                        |
| **Description **         | This test case is designed to verify if the TRANSITED-POLICY-CHECKED ticket flag can be supported by the KDC.                                                                                                             |
| **Prerequisites**        |                                                                                                                                                                                                                           |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                                                                                               
                                                                                                                                                                                                                                                       
                            > padata: no pre-authentication data                                                                                                                                                                                       
                                                                                                                                                                                                                                                       
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                 
                                                                                                                                                                                                                                                       
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                           
                                                                                                                                                                                                                                                       
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                         
                                                                                                                                                                                                                                                       
                            2.  Client sends AS request                                                                                                                                                                                                
                                                                                                                                                                                                                                                       
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                           
                                                                                                                                                                                                                                                       
                            3.  KDC returns AS\_REP                                                                                                                                                                                                    
                                                                                                                                                                                                                                                       
                            > ticket: user TGT (check existence)                                                                                                                                                                                       
                                                                                                                                                                                                                                                       
                            1.  Client sends TGS\_REQ                                                                                                                                                                                                  
                                                                                                                                                                                                                                                       
                            2.  KDC returns TGS\_REP                                                                                                                                                                                                   
                                                                                                                                                                                                                                                       
                            3.  Client sends referral TGS\_REQ                                                                                                                                                                                         
                                                                                                                                                                                                                                                       
                            > kdc-options: DISABLE-TRANSITED-CHECK option not set                                                                                                                                                                      
                                                                                                                                                                                                                                                       
                            1.  KDC returns referral TGS\_REP                                                                                                                                                                                          
                                                                                                                                                                                                                                                       
                            > ticket: service ticket (check existence)                                                                                                                                                                                 
                            >                                                                                                                                                                                                                          
                            > flags: TRANSITED-POLICY-CHECKED set (isCommon1) not set (isKile1)                                                                                                                                                        |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                       
                            1.  When the KDC applies such checks and accepts such cross-realm authentication, it will set the TRANSITED-POLICY-CHECKED flag in the service tickets it issues based on the cross-realm TGT. (\[RFC4120\] section 2.7);  
                                                                                                                                                                                                                                                       
                            isKile:                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                       
                            1.  The TRANSITED-POLICY-CHECKED flag: KILE MUST NOT check for transited domains on servers or a KDC. Application servers MUST ignore the TRANSITED-POLICY-CHECKED setting. (\[MS-KILE\] section 3.1.5.4)                  |
| **Cleanup**              |                                                                                                                                                                                                                           |

#### TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION\_NO\_TGT\_DELEGATION Flag

|                          |                                                                                                                                                                                                                                   |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION\_NO\_TGT\_DELEGATION Flag                                                                                                                                                                   |
| **Priority**             | P1                                                                                                                                                                                                                                |
| **Description **         | This test case is designed to verify if the TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION\_NO\_TGT\_DELEGATION flag can be supported by the KDC.                                                                                          |
| **Prerequisites**        | Trusted realm dc has                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION\_NO\_TGT\_DELEGATION flag set                                                                                                                                                                |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                            > padata: no pre-authentication data                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                            2.  Client sends AS request                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                            3.  KDC returns AS\_REP                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                            > ticket: user TGT (check existence)                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                            1.  Client sends TGS\_REQ                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                            2.  KDC returns TGS\_REP                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                            3.  Client sends referral TGS\_REQ                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                            4.  KDC returns referral TGS\_REP                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                            > ticket: service ticket (check existence)                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                  
                            > flags: the KDC MUST return a ticket with the ok-as-delegate flag not set in TicketFlags.                                                                                                                                         
                            >                                                                                                                                                                                                                                  
                            > (isKile1)                                                                                                                                                                                                                        |
| **Requirements covered** | isKile:                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                            1.  If the TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION\_NO\_TGT\_DELEGATION flag is set in the trustAttributes field (\[MS-ADTS\] section 6.1.6.7.9), the KDC MUST return a ticket with the ok-as-delegate flag not set in TicketFlags.  |
| **Cleanup**              |                                                                                                                                                                                                                                   |

#### Forwardable ticket

|                          |                                                                                                                                                                                                                                                                                                                                                                                                       |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Forwardable\_ticket                                                                                                                                                                                                                                                                                                                                                                                   |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Description **         | This test case is designed to verify if the FORWARDABLE ticket flag can be supported by the KDC.                                                                                                                                                                                                                                                                                                      |
| **Prerequisites**        | Set Delegate = TRUE on client;                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            Set local host account as trusted for delegation;                                                                                                                                                                                                                                                                                                                                                      |
| **Test Execution Steps** | 1.  Client sends AS request                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > padata: no pre-authentication data                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            2.  Client sends AS request                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            3.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > ticket: user TGT (check existence)                                                                                                                                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                                                                                                                                                      
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES = encrypt types supported by user’s domain(isKile2)                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            1.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > kdc-options: FORWARDABLE option                                                                                                                                                                                                                                                                                                                                                                      
                            >                                                                                                                                                                                                                                                                                                                                                                                                      
                            > etype: ? (isKile1)                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            1.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > flags: FORWARDABLE, OK-AS-DELEGATE (isCommon1)                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                                      
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES = encrypt types supported by target domain(isKile2)                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            1.  Client sends referral TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > kdc-options: FOWARDABLE, FORWARDED option                                                                                                                                                                                                                                                                                                                                                            
                            >                                                                                                                                                                                                                                                                                                                                                                                                      
                            > etype: keytype field of previous TGS-REP (isKile1)                                                                                                                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                                                                                                                                                      
                            > pa-data: PA-SUPPORTED-ENCTYPES = mutually supported by KDC (AS-REP) and application server (previous TGS-REP) (isKile2)                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            1.  KDC returns referral TGS\_REP                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            > ticket: service ticket (check existence)                                                                                                                                                                                                                                                                                                                                                             
                            >                                                                                                                                                                                                                                                                                                                                                                                                      
                            > flags: FORWARDABLE, FORWARDED, OK-AS-DELEGATE (isCommon2)                                                                                                                                                                                                                                                                                                                                            
                            >                                                                                                                                                                                                                                                                                                                                                                                                      
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES = encrypt types supported by server or service                                                                                                                                                                                                                                                                                                                    |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            1.  This flag is reset by default, but users MAY request that it be set by setting the FORWARDABLE option in the AS request when they request their initial TGT. (\[RFC4120\] section 2.6);                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                If Delegate is set to TRUE, the client SHOULD set the FORWARDABLE option in the TGS request. When the client receives a forwardable ticket, it puts the ticket in a KRB\_CRED structure. The client SHOULD NOT forward the ticket unless the TGT is marked OK-AS-DELEGATE. (\[MS-KILE\] section 3.2.5.1)                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            2.  The FORWARDED flag is set by the TGS when a client presents a ticket with the FORWARDABLE flag set and requests a forwarded ticket by specifying the FORWARDED KDC option and supplying a set of addresses for the new ticket. (\[RFC4120\] section 2.6);                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                The FORWARDABLE/FORWARDED flag: Forwarded tickets SHOULD be supported in KILE. (\[MS-KILE\] section 3.1.5.4)                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            isKile:                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            1.  When the client requests a forwardable TGT for the application server, the client SHOULD:                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            -   Set the etype field of the TGS-REQ to the contents of the keytype field in the previous TGS-REP to specify the common encryption type. (\[MS-KILE\] section 3.2.5.5)                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            1.  When the client requests a forwardable TGT for the application server, the client SHOULD:                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                            -   Provide a PA-SUPPORTED-ENCTYPES value for padata, based on the encryption types mutually supported by the KDC and the application server for the session key with the delegated TGT. The client uses the KDC encryption types provided in the AS-REP from the KDC and the application server encryption types provided in the previous TGS-REP for the application. (\[MS-KILE\] section 3.2.5.5)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                       |

#### Target Realm use AES

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Target\_Realm\_use\_AES                                                                                                                                                                                                                                                                                                                                                                                                |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Description **         | This test case is designed to verify if the KDC supports AES encryption for servers or services.                                                                                                                                                                                                                                                                                                                       |
| **Prerequisites**        | Set attribute msDS-SupportedEncryptionTypes to 0x1F for the krbtgt/&lt;targetrealm&gt; object in AD;                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            Set domainControllerFunctionality &gt;= 3;                                                                                                                                                                                                                                                                                                                                                                              |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            > ticket: referral ticket                                                                                                                                                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                                                                                                                                                                       
                            > sname: krbtgt/&lt;target realm&gt; (isKile1)                                                                                                                                                                                                                                                                                                                                                                          
                            >                                                                                                                                                                                                                                                                                                                                                                                                                       
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES (165)=0x1F (isKile1)                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            1.  Client send referral TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            2.  KDC returns referral TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            3.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            4.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                            |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            1.  Otherwise:                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                If the account is krbtgt, and domainControllerFunctionality returns greater than or equal to 3: the KDC SHOULD, in the encrypted pre-auth data part of the TGS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), the padata-value set to 0x1F, the Claims-supported bit if claims is supported, and the FAST-supported bit if FAST is supported. (\[MS-KILE\] section 3.3.5.4)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                        |

#### Target Realm use RC4

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Target\_Realm\_use\_RC4                                                                                                                                                                                                                                                                                                                                                                                                |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Description **         | This test case is designed to verify if the KDC supports RC4 encryption for servers or services.                                                                                                                                                                                                                                                                                                                       |
| **Prerequisites**        | Set attribute msDS-SupportedEncryptionTypes to 0x7 for the krbtgt/&lt;targetrealm&gt; object in AD;                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            Set domainControllerFunctionality &gt;= 3;                                                                                                                                                                                                                                                                                                                                                                              |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            > ticket: referral ticket                                                                                                                                                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                                                                                                                                                                       
                            > sname: krbtgt/&lt;target realm&gt; (isKile1)                                                                                                                                                                                                                                                                                                                                                                          
                            >                                                                                                                                                                                                                                                                                                                                                                                                                       
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES (165)=0x7 (isKile1)                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            1.  Client send referral TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            2.  KDC returns referral TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            3.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            4.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                            |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            1.  Otherwise:                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                If the account is krbtgt, and domainControllerFunctionality returns greater than or equal to 3: the KDC SHOULD, in the encrypted pre-auth data part of the TGS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), the padata-value set to 0x1F, the Claims-supported bit if claims is supported, and the FAST-supported bit if FAST is supported. (\[MS-KILE\] section 3.3.5.4)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                        |

#### Target Realm use DES

|                          |                                                                                                                                                                                                                                               |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Target\_Realm\_use\_DES                                                                                                                                                                                                                       |
| **Priority**             | P0                                                                                                                                                                                                                                            |
| **Description **         | This test case is designed to verify if the KDC supports DES encryption for servers or services.                                                                                                                                              |
| **Prerequisites**        | Set UseDESOnly = true on the krbtgt/&lt;targetrealm&gt; account and do not                                                                                                                                                                    
                                                                                                                                                                                                                                                                           
                            set attribute msDS-SupportedEncryptionTypes to 0x3 for the krbtgt/&lt;targetrealm&gt; object in AD;                                                                                                                                            
                                                                                                                                                                                                                                                                           
                            Set domainControllerFunctionality &gt;= 3;                                                                                                                                                                                                     |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                           
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                            
                                                                                                                                                                                                                                                                           
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                           
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                           
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                           
                            6.  KDC return AS\_REP                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                           
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                           
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                           
                            > ticket: referral ticket                                                                                                                                                                                                                      
                            >                                                                                                                                                                                                                                              
                            > sname: krbtgt/&lt;target realm&gt; (isKile1)                                                                                                                                                                                                 
                            >                                                                                                                                                                                                                                              
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES (165)=0x3 (isKile1, isKILE2)                                                                                                                                                                              
                                                                                                                                                                                                                                                                           
                            1.  Client send referral TGS\_REQ                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                           
                            2.  KDC returns referral TGS\_REP                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                           
                            3.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                  
                                                                                                                                                                                                                                                                           
                            4.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                   |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                           
                            1.  If UseDESOnly is set: the KDC SHOULD, in the encrypted pre-auth data part of the TGS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), and the padata-value set to 0x3. (\[MS-KILE\] section 3.3.5.4)  
                                                                                                                                                                                                                                                                           
                            2.  DFL&gt;=6: DES MUST NOT be used unless no other etype is supported.&lt;67&gt;                                                                                                                                                              |
| **Cleanup**              |                                                                                                                                                                                                                                               |

#### Target Realm support Claims

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Target\_Realm\_support\_Claims                                                                                                                                                                                                                                                                                                                                                                                         |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Description **         | This test case is designed to verify if the KDC supports AES encryption for servers or services.                                                                                                                                                                                                                                                                                                                       |
| **Prerequisites**        | Set attribute msDS-SupportedEncryptionTypes to 0x4001F for the krbtgt/&lt;targetrealm&gt; object in AD;                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            Set domainControllerFunctionality &gt;= 3;                                                                                                                                                                                                                                                                                                                                                                              |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            > ticket: referral ticket                                                                                                                                                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                                                                                                                                                                       
                            > sname: krbtgt/&lt;target realm&gt; (isKile1)                                                                                                                                                                                                                                                                                                                                                                          
                            >                                                                                                                                                                                                                                                                                                                                                                                                                       
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES (165)=0x4001F (isKile1)                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            1.  Client send referral TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            2.  KDC returns referral TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            3.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            4.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                            |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            1.  Otherwise:                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                If the account is krbtgt, and domainControllerFunctionality returns greater than or equal to 3: the KDC SHOULD, in the encrypted pre-auth data part of the TGS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), the padata-value set to 0x1F, the Claims-supported bit if claims is supported, and the FAST-supported bit if FAST is supported. (\[MS-KILE\] section 3.3.5.4)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                        |

#### PAC generation when no PAC in TGT

|                          |                                                                                                                                                                                        |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | PAC\_generation\_when\_no\_PAC\_in\_TGT                                                                                                                                                |
| **Priority**             | P0                                                                                                                                                                                     |
| **Description **         | This test case is designed to verify if the KDC supports PAC generation when no PAC TGT is received.                                                                                   |
| **Prerequisites**        |                                                                                                                                                                                        |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                            
                                                                                                                                                                                                                    
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                     
                                                                                                                                                                                                                    
                            3.  Client sends AS\_REQ                                                                                                                                                                
                                                                                                                                                                                                                    
                                1.  padata: PA-PAC-REQUEST (false)                                                                                                                                                  
                                                                                                                                                                                                                    
                            4.  KDC returns KRB\_ERROR                                                                                                                                                              
                                                                                                                                                                                                                    
                            5.  Client sends AS\_REQ                                                                                                                                                                
                                                                                                                                                                                                                    
                            > padata: PA-PAC-REQUEST (false)                                                                                                                                                        
                                                                                                                                                                                                                    
                            1.  KDC return AS\_REP                                                                                                                                                                  
                                                                                                                                                                                                                    
                            > ticket: user TGT without PAC                                                                                                                                                          
                                                                                                                                                                                                                    
                            1.  Client send TGS\_REQ                                                                                                                                                                
                                                                                                                                                                                                                    
                            2.  KDC returns TGS\_REP                                                                                                                                                                
                                                                                                                                                                                                                    
                            > ticket: referral ticket                                                                                                                                                               
                            >                                                                                                                                                                                       
                            > authorization-data: PAC generated (isKile1)                                                                                                                                           
                                                                                                                                                                                                                    
                            1.  Client send referral TGS\_REQ                                                                                                                                                       
                                                                                                                                                                                                                    
                            2.  KDC returns referral TGS\_REP                                                                                                                                                       
                                                                                                                                                                                                                    
                            3.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                           
                                                                                                                                                                                                                    
                            4.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                            |
| **Requirements covered** | isKile:                                                                                                                                                                                
                                                                                                                                                                                                                    
                            1.  The PAC MUST be generated by the KDC under one of the following conditions:                                                                                                         
                                                                                                                                                                                                                    
                                During a TGS request when the TGT for the client in the request does not contain a PAC and the ticket to be returned is a cross-realm referral TGT. (\[MS-KILE\] section 3.1.5.11)  |
| **Cleanup**              |                                                                                                                                                                                        |

#### Other Organization SID in PAC Success

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Other\_Organization\_SID\_in\_PAC\_Success                                                                                                                                                                                                                                                                                                                                                                     |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Description **         | This test case is designed to verify if KDC supports Other Organization SID in PAC.                                                                                                                                                                                                                                                                                                                            |
| **Prerequisites**        | Set the TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION flag in the TrustAttributes field;                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            Set:                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            Security descriptor = server AD account object;                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            Client principal = Client user;                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            Requested access = ACTRL\_DS\_CONTROL\_ACCESS;                                                                                                                                                                                                                                                                                                                                                                  |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                1.  cname: &lt;username&gt;                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            > ticket: user TGT                                                                                                                                                                                                                                                                                                                                                                                              
                            >                                                                                                                                                                                                                                                                                                                                                                                                               
                            > authorization-data: PAC, SID S-1-5-1000 (isKile2)                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            1.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            2.  KDC perform an access check for the Allowed-To-Authenticate right (ACL check)                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            3.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            > ticket: service ticket (isKile1)                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            1.  Else: KDC\_ERR\_POLICY                                                                                                                                                                                                                                                                                                                                                                                      |
| **Requirements covered** | isKile1:                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            1.  If the PAC contains the SID S-1-5-1000 (Other Organization), the PAC MUST be used to perform an access check for the Allowed –To-Authenticate right against the Active Directory object of the account for which the service ticket request is being made. If the access check succeeds, the service ticket MUST be issued; otherwise, the KDC MUST return KDC\_ERR\_POLICY. (\[MS-KILE\] section 3.3.5.4)  
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                            2.  If the TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION flag is set in the TrustAttributes field, the OTHER\_ORGANIZATION SID MUST be added to the user’s PAC. (\[MS-KILE\] section 3.3.5.4.5);                                                                                                                                                                                                                        |
| **Cleanup**              | Unset SID information.                                                                                                                                                                                                                                                                                                                                                                                         |

#### Other Organization SID in PAC Failure - 1

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                 |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Other\_Organization\_SID\_in\_PAC\_Failure\_1                                                                                                                                                                                                                                                                                                                                                                   |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Description **         | This test case is designed to verify if KDC supports Other Organization SID in PAC.                                                                                                                                                                                                                                                                                                                             |
| **Prerequisites**        | Set SID information to the user account;                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            Set the TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION flag in the TrustAttributes field.                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            Set:                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            Security descriptor != server AD account object;                                                                                                                                                                                                                                                                                                                                                                 |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                1.  cname: &lt;username&gt;                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > ticket: user TGT                                                                                                                                                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                                                                                                                                                                
                            > authorization-data: PAC, SID S-1-5-1000 (isKile2)                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  KDC perform an access check for the Allowed-To-Authenticate right (ACL check failed)                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > Security descriptor != server AD account object (isKile3)                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  KDC returns KDC\_ERR\_POLICY (isKile1)                                                                                                                                                                                                                                                                                                                                                                       |
| **Requirements covered** | isKile1:                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  If the PAC contains the SID S-1-5-1000 (Other Organization), the PAC MUST be used to perform an access check for the Allowed –To-Authenticate right against the Active Directory object of the account for which the service ticket request is being made. If the access check succeeds, the service ticket MUST be issued; otherwise, the KDC MUST return KDC\_ERR\_POLICY. (\[MS-KILE\] section 3.3.5.4);  
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  If the TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION flag is set in the TrustAttributes field, the OTHER\_ORGANIZATION SID MUST be added to the user’s PAC. (\[MS-KILE\] section 3.3.5.4.5);                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            3.  The KDC MUST perform an ACL check while processing the TGS request as follows:                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            -   The security descriptor MUST be that of the server AD account object,                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            -   The client principal MUST be that of the client user,                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            -   And the requested access MUST be ACTRL\_DS\_CONTROL\_ACCESS.                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                If there is a failure in the check, the KDC MUST reject the authentication request with KDC\_ERROR\_POLICY. (\[MS-KILE\] section 3.3.5.4.5);                                                                                                                                                                                                                                                                 |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                 |

#### Other Organization SID in PAC Failure - 2

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                 |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Other\_Organization\_SID\_in\_PAC\_Failure\_2                                                                                                                                                                                                                                                                                                                                                                   |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Description **         | This test case is designed to verify if KDC supports Other Organization SID in PAC.                                                                                                                                                                                                                                                                                                                             |
| **Prerequisites**        | Set SID information to the user account;                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            Set the TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION flag in the TrustAttributes field.                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            Set:                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            Client principal != client user;                                                                                                                                                                                                                                                                                                                                                                                 |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                1.  cname: &lt;username&gt;                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > ticket: user TGT                                                                                                                                                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                                                                                                                                                                
                            > authorization-data: PAC, SID S-1-5-1000 (isKile2)                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  KDC perform an access check for the Allowed-To-Authenticate right (ACL check failed)                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > Client principal != client user (isKile3)                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  KDC returns KDC\_ERR\_POLICY (isKile1)                                                                                                                                                                                                                                                                                                                                                                       |
| **Requirements covered** | isKile1:                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  If the PAC contains the SID S-1-5-1000 (Other Organization), the PAC MUST be used to perform an access check for the Allowed –To-Authenticate right against the Active Directory object of the account for which the service ticket request is being made. If the access check succeeds, the service ticket MUST be issued; otherwise, the KDC MUST return KDC\_ERR\_POLICY. (\[MS-KILE\] section 3.3.5.4);  
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  If the TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION flag is set in the TrustAttributes field, the OTHER\_ORGANIZATION SID MUST be added to the user’s PAC. (\[MS-KILE\] section 3.3.5.4.5);                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            3.  The KDC MUST perform an ACL check while processing the TGS request as follows:                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            -   The security descriptor MUST be that of the server AD account object,                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            -   The client principal MUST be that of the client user,                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            -   And the requested access MUST be ACTRL\_DS\_CONTROL\_ACCESS.                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                If there is a failure in the check, the KDC MUST reject the authentication request with KDC\_ERROR\_POLICY. (\[MS-KILE\] section 3.3.5.4.5);                                                                                                                                                                                                                                                                 |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                 |

#### Other Organization SID in PAC Failure - 3

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                 |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Other\_Organization\_SID\_in\_PAC\_Failure\_1                                                                                                                                                                                                                                                                                                                                                                   |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Description **         | This test case is designed to verify if KDC supports Other Organization SID in PAC.                                                                                                                                                                                                                                                                                                                             |
| **Prerequisites**        | Set SID information to the user account;                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            Set the TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION flag in the TrustAttributes field.                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            Set:                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            requested access != ACTRL\_DS\_CONTROL\_ACCESS;                                                                                                                                                                                                                                                                                                                                                                  |
| **Test Execution Steps** | 1.  Client sends AS\_REQ (no pre-authentication)                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                1.  cname: &lt;username&gt;                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > ticket: user TGT                                                                                                                                                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                                                                                                                                                                
                            > authorization-data: PAC, SID S-1-5-1000 (isKile2)                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  Client sends TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  KDC perform an access check for the Allowed-To-Authenticate right (ACL check failed)                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > requested access != ACTRL\_DS\_CONTROL\_ACCESS (isKile3)                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  KDC returns KDC\_ERR\_POLICY (isKile1)                                                                                                                                                                                                                                                                                                                                                                       |
| **Requirements covered** | isKile1:                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  If the PAC contains the SID S-1-5-1000 (Other Organization), the PAC MUST be used to perform an access check for the Allowed –To-Authenticate right against the Active Directory object of the account for which the service ticket request is being made. If the access check succeeds, the service ticket MUST be issued; otherwise, the KDC MUST return KDC\_ERR\_POLICY. (\[MS-KILE\] section 3.3.5.4);  
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  If the TRUST\_ATTRIBUTE\_CROSS\_ORGANIZATION flag is set in the TrustAttributes field, the OTHER\_ORGANIZATION SID MUST be added to the user’s PAC. (\[MS-KILE\] section 3.3.5.4.5);                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            3.  The KDC MUST perform an ACL check while processing the TGS request as follows:                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            -   The security descriptor MUST be that of the server AD account object,                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            -   The client principal MUST be that of the client user,                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            -   And the requested access MUST be ACTRL\_DS\_CONTROL\_ACCESS.                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                If there is a failure in the check, the KDC MUST reject the authentication request with KDC\_ERROR\_POLICY. (\[MS-KILE\] section 3.3.5.4.5);                                                                                                                                                                                                                                                                 |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                 |

#### Forwarded TGT etype

|                          |                                                                                                                                                                                                                                                                                                                                                                                                               |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Forwarded\_TGT\_Etype                                                                                                                                                                                                                                                                                                                                                                                         |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Description **         |                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > kdc-options: forwardable                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > flags: forwardable                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  Client send referral TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > kdc-options: forwarded                                                                                                                                                                                                                                                                                                                                                                                       
                            >                                                                                                                                                                                                                                                                                                                                                                                                              
                            > ticket: user’s referral TGT                                                                                                                                                                                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                                                                                                                                                                              
                            > etype: not supported by the referred KDC                                                                                                                                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                                                                                                                                                              
                            > enc-padata: PA-SUPPORTED-ENCTYPES (???)                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  KDC returns referral TGS\_REP                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > flags: forwarded (isKile1)                                                                                                                                                                                                                                                                                                                                                                                   
                            >                                                                                                                                                                                                                                                                                                                                                                                                              
                            > ticket:                                                                                                                                                                                                                                                                                                                                                                                                      
                            >                                                                                                                                                                                                                                                                                                                                                                                                              
                            > etype: generated by the etype in referral TGT and the PA-SUPPORTED-ENCTYPES (isKile1)                                                                                                                                                                                                                                                                                                                        
                            >                                                                                                                                                                                                                                                                                                                                                                                                              
                            > enc-padata: PA-SUPPORTED-ENCTYPES (etype supported by this KDC)                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            2.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                    |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  If a TGS-REQ message requesting a FORWARDED TGT provides an etype value that is not supported by the KDC, and the client provides a PA\_SUPPORTED-ENCTYPES with encryption types the KDC supports, then the KDC MAY select the strongest encryption type that is both included in the PA-SUPPORTED-ENCTYPES and supported by the KDC to generate the random session key. (\[MS-KILE\] section 3.3.5.4.6);  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                               |

#### Cross realm –pa-srv-referral-info

|                          |                                                                                                                  |
|--------------------------|------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Normal\_Resource\_in\_another\_realm                                                                             |
| **Priority**             | P0 (BVT)                                                                                                         |
| **Description **         |                                                                                                                  |
| **Prerequisites**        | Create &lt;username&gt; user account in “contoso.com”;                                                           
                                                                                                                                              
                            Join client computer in “contoso.com” domain;                                                                     
                                                                                                                                              
                            Join File Server in “kerb.com” domain;                                                                            |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                      
                                                                                                                                              
                            2.  AP returns AP Negotiate response (use Kerberos)                                                               
                                                                                                                                              
                            3.  Client sends AS\_REQ                                                                                          
                                                                                                                                              
                            4.  KDC returns KRB\_ERROR                                                                                        
                                                                                                                                              
                            5.  Client sends AS\_REQ                                                                                          
                                                                                                                                              
                            6.  KDC return AS\_REP                                                                                            
                                                                                                                                              
                            > ticket: user TGT                                                                                                
                                                                                                                                              
                            1.  Client send TGS\_REQ with Canonicalize option                                                                 
                                                                                                                                              
                            2.  KDC returns TGS\_REP                                                                                          
                                                                                                                                              
                            > ticket: referral user TGT to the resource’s domain                                                              
                            >                                                                                                                 
                            > (windows)padata: principal name and target realm in encrypted part: pa-srv-referral-info(type 20)               
                            >                                                                                                                 
                            > (rfc) padata: principal name and target realm in padata part: pa-server-referral (type 25, keyusage number 26)  
                                                                                                                                              
                            1.  Client send referral TGS\_REQ                                                                                 
                                                                                                                                              
                            2.  KDC returns referral TGS\_REP                                                                                 
                                                                                                                                              
                            > ticket: service ticket                                                                                          
                                                                                                                                              
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                      
                                                                                                                                              
                            2.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)                                       |
| **Requirements covered** |                                                                                                                  |
| **Cleanup**              |                                                                                                                  |

#### Cross realm – Reject to referral if canonicalize not set

|                          |                                                                                                                  |
|--------------------------|------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Normal\_Resource\_in\_another\_realm                                                                             |
| **Priority**             | P0 (BVT)                                                                                                         |
| **Description **         |                                                                                                                  |
| **Prerequisites**        | Create &lt;username&gt; user account in “contoso.com”;                                                           
                                                                                                                                              
                            Join client computer in “contoso.com” domain;                                                                     
                                                                                                                                              
                            Join File Server in “kerb.com” domain;                                                                            |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                      
                                                                                                                                              
                            2.  AP returns AP Negotiate response (use Kerberos)                                                               
                                                                                                                                              
                            3.  Client sends AS\_REQ                                                                                          
                                                                                                                                              
                            4.  KDC returns KRB\_ERROR                                                                                        
                                                                                                                                              
                            5.  Client sends AS\_REQ                                                                                          
                                                                                                                                              
                            6.  KDC return AS\_REP                                                                                            
                                                                                                                                              
                            > ticket: user TGT                                                                                                
                                                                                                                                              
                            1.  Client send TGS\_REQ without Canonicalize option                                                              
                                                                                                                                              
                            2.  KDC returns TGS\_REP                                                                                          
                                                                                                                                              
                            > ticket: referral user TGT to the resource’s domain                                                              
                            >                                                                                                                 
                            > (windows)padata: principal name and target realm in encrypted part: pa-srv-referral-info(type 20)               
                            >                                                                                                                 
                            > (rfc) padata: principal name and target realm in padata part: pa-server-referral (type 25, keyusage number 26)  
                                                                                                                                              
                            1.  Client send referral TGS\_REQ                                                                                 
                                                                                                                                              
                            2.  KDC returns referral TGS\_REP                                                                                 
                                                                                                                                              
                            > ticket: service ticket                                                                                          
                                                                                                                                              
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                      
                                                                                                                                              
                            2.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)                                       |
| **Requirements covered** |                                                                                                                  |
| **Cleanup**              |                                                                                                                  |

#### Cross realm without PAC

|                          |                                                                              |
|--------------------------|------------------------------------------------------------------------------|
| **Test ID**              |                                                                              |
| **Priority**             | P0 (BVT)                                                                     |
| **Description **         |                                                                              |
| **Prerequisites**        | Create &lt;username&gt; user account in “contoso.com”;                       
                                                                                                          
                            Join client computer in “contoso.com” domain;                                 
                                                                                                          
                            Join File Server in “kerb.com” domain;                                        |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                  
                                                                                                          
                            2.  AP returns AP Negotiate response (use Kerberos)                           
                                                                                                          
                            3.  Client sends AS\_REQ                                                      
                                                                                                          
                            4.  KDC returns KRB\_ERROR                                                    
                                                                                                          
                            5.  Client sends AS\_REQ                                                      
                                                                                                          
                            6.  KDC return AS\_REP                                                        
                                                                                                          
                            > ticket: user TGT                                                            
                                                                                                          
                            1.  Client send TGS\_REQ with Canonicalize option,                            
                                                                                                          
                            2.  KDC returns TGS\_REP                                                      
                                                                                                          
                            3.  Client send referral TGS\_REQ                                             
                                                                                                          
                            4.  KDC returns referral TGS\_REP                                             
                                                                                                          
                            > ticket: service ticket                                                      
                                                                                                          
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)  
                                                                                                          
                            2.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)   |
| **Requirements covered** |                                                                              |
| **Cleanup**              |                                                                              |

#### Cross realm with PAC

|                          |                                                                              |
|--------------------------|------------------------------------------------------------------------------|
| **Test ID**              |                                                                              |
| **Priority**             | P0 (BVT)                                                                     |
| **Description **         |                                                                              |
| **Prerequisites**        | Create &lt;username&gt; user account in “contoso.com”;                       
                                                                                                          
                            Join client computer in “contoso.com” domain;                                 
                                                                                                          
                            Join File Server in “kerb.com” domain;                                        |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                  
                                                                                                          
                            2.  AP returns AP Negotiate response (use Kerberos)                           
                                                                                                          
                            3.  Client sends AS\_REQ                                                      
                                                                                                          
                            4.  KDC returns KRB\_ERROR                                                    
                                                                                                          
                            5.  Client sends AS\_REQ                                                      
                                                                                                          
                            6.  KDC return AS\_REP                                                        
                                                                                                          
                            > ticket: user TGT                                                            
                                                                                                          
                            1.  Client send TGS\_REQ with PA\_PAC\_REQUEST, with Canonicalize option      
                                                                                                          
                            2.  KDC returns TGS\_REP                                                      
                                                                                                          
                            3.  Client send referral TGS\_REQ                                             
                                                                                                          
                            4.  KDC returns referral TGS\_REP                                             
                                                                                                          
                            > ticket: service ticket with PAC                                             
                                                                                                          
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)  
                                                                                                          
                            2.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)   |
| **Requirements covered** |                                                                              |
| **Cleanup**              |                                                                              |

#### Cross realm with PAC and claim

|                          |                                                                                                                         |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              |                                                                                                                         |
| **Priority**             | P0 (BVT)                                                                                                                |
| **Description **         |                                                                                                                         |
| **Prerequisites**        | Create &lt;username&gt; user account in “contoso.com”;                                                                  
                                                                                                                                                     
                            Join client computer in “contoso.com” domain;                                                                            
                                                                                                                                                     
                            Join File Server in “kerb.com” domain;                                                                                   |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                             
                                                                                                                                                     
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                      
                                                                                                                                                     
                            3.  Client sends AS\_REQ                                                                                                 
                                                                                                                                                     
                            4.  KDC returns KRB\_ERROR                                                                                               
                                                                                                                                                     
                            5.  Client sends AS\_REQ                                                                                                 
                                                                                                                                                     
                            6.  KDC return AS\_REP                                                                                                   
                                                                                                                                                     
                            > ticket: user TGT                                                                                                       
                                                                                                                                                     
                            1.  Client send TGS\_REQ with PA\_PAC\_REQUEST, PA\_PAC\_OPTIONS (claim, forward to full dc), with Canonicalize option,  
                                                                                                                                                     
                            2.  KDC returns TGS\_REP                                                                                                 
                                                                                                                                                     
                            3.  Client send referral TGS\_REQ                                                                                        
                                                                                                                                                     
                            4.  KDC returns referral TGS\_REP                                                                                        
                                                                                                                                                     
                            > ticket: service ticket with PAC and claim                                                                              
                                                                                                                                                     
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                             
                                                                                                                                                     
                            2.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)                                              |
| **Requirements covered** |                                                                                                                         |
| **Cleanup**              |                                                                                                                         |

1.  ### FAST

    1.  #### Target Realm support FAST

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Target\_Realm\_support\_FAST                                                                                                                                                                                                                                                                                                                                                                                           |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Description **         | This test case is designed to verify if the KDC supports AES encryption for servers or services.                                                                                                                                                                                                                                                                                                                       |
| **Prerequisites**        | Set attribute msDS-SupportedEncryptionTypes to 0x1001F for the krbtgt/&lt;targetrealm&gt; object in AD;                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            Set domainControllerFunctionality &gt;= 3;                                                                                                                                                                                                                                                                                                                                                                              |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            > ticket: referral ticket                                                                                                                                                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                                                                                                                                                                       
                            > sname: krbtgt/&lt;target realm&gt; (isKile1)                                                                                                                                                                                                                                                                                                                                                                          
                            >                                                                                                                                                                                                                                                                                                                                                                                                                       
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES (165)=0x1001F (isKile1)                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            1.  Client send referral TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            2.  KDC returns referral TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            3.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            4.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                            |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                            1.  Otherwise:                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                If the account is krbtgt, and domainControllerFunctionality returns greater than or equal to 3: the KDC SHOULD, in the encrypted pre-auth data part of the TGS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), the padata-value set to 0x1F, the Claims-supported bit if claims is supported, and the FAST-supported bit if FAST is supported. (\[MS-KILE\] section 3.3.5.4)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                        |

#### Armor TGT sname

|                          |                                                                                                                         |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Armor\_TGT\_sname                                                                                                       |
| **Priority**             | P0                                                                                                                      |
| **Description **         |                                                                                                                         |
| **Prerequisites**        |                                                                                                                         |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for computer account                                                                           
                                                                                                                                                     
                            2.  KDC returns KRB\_ERROR                                                                                               
                                                                                                                                                     
                            3.  Client sends AS\_REQ                                                                                                 
                                                                                                                                                     
                            4.  KDC return AS\_REP                                                                                                   
                                                                                                                                                     
                                1.  ticket: computer’s TGT                                                                                           
                                                                                                                                                     
                            5.  Client sends AS\_REQ to the user’s realm                                                                             
                                                                                                                                                     
                            6.  KDC return AS\_REP                                                                                                   
                                                                                                                                                     
                            > ticket: computer’s referral TGT to the user’s realm                                                                    
                                                                                                                                                     
                            1.  Client sends AS\_REQ for user account                                                                                
                                                                                                                                                     
                            2.  KDC returns KRB\_ERROR                                                                                               
                                                                                                                                                     
                            3.  Client sends FAST AS\_REQ                                                                                            
                                                                                                                                                     
                            > Armor-type: FX\_FAST\_ARMOR\_AP\_REQUEST (1)                                                                           
                            >                                                                                                                        
                            > Armor-value: AP-REQ:                                                                                                   
                            >                                                                                                                        
                            > Armor Ticket: the ticket obtained in step 6                                                                            
                            >                                                                                                                        
                            > sname: target realm (isCommon1)                                                                                        
                                                                                                                                                     
                            1.  KDC returns FAST AS\_REP                                                                                             |
| **Requirements covered** | isCommon:                                                                                                               
                                                                                                                                                     
                            1.  The server name field of the armor ticket MUST identify the TGS of the target realm. (\[RFC6113\] section 5.4.1.1);  |
| **Cleanup**              |                                                                                                                         |

#### User in another domain

|                          |                                                                                                                                          |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | User\_in\_another\_domain                                                                                                                |
| **Priority**             | P0 (BVT)                                                                                                                                 |
| **Description **         |                                                                                                                                          |
| **Prerequisites**        | Join client computer to the “contoso.com” domain;                                                                                        
                                                                                                                                                                      
                            Create &lt;username&gt; user account in the “kerb.com” domain;                                                                            
                                                                                                                                                                      
                            Join AP to the “kerb.com” domain;                                                                                                         
                                                                                                                                                                      
                            Set Delegate=TRUE for client’s security context;                                                                                          
                                                                                                                                                                      
                            Set the service account as trusted for delegation.                                                                                        
                                                                                                                                                                      
                            Set attribute msDS-SupportedEncryptionTypes to 0x7001C for the krbtgt/contoso.com object in AD;                                           
                                                                                                                                                                      
                            Set attribute msDS-SupportedEncryptionTypes to 0x7001C for the krbtgt/kerb.com object in AD;                                              
                                                                                                                                                                      
                            Set registry key ClaimsCompIdFASTSupport to 2 on all the KDCs (don’t use group policy).                                                   |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                              
                                                                                                                                                                      
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                       
                                                                                                                                                                      
                            3.  Client sends AS\_REQ for device TGT to user’s domain                                                                                  
                                                                                                                                                                      
                            4.  KDC returns KRB\_ERROR                                                                                                                
                                                                                                                                                                      
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                          
                                                                                                                                                                      
                                    > e-data: PA-FX-FAST                                                                                                              
                                                                                                                                                                      
                            5.  Client sends AS\_REQ for device TGT to user’s domain                                                                                  
                                                                                                                                                                      
                            6.  KDC return AS\_REP                                                                                                                    
                                                                                                                                                                      
                                1.  ticket: referral computer’s TGT (isKile1)                                                                                         
                                                                                                                                                                      
                            7.  Client sends FAST AS\_REQ for user TGT to user’s domain                                                                               
                                                                                                                                                                      
                            8.  KDC returns KRB\_ERROR                                                                                                                
                                                                                                                                                                      
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                          
                                                                                                                                                                      
                            > e-data: PA-FX-FAST\[PA-ENC-TIMESTAMP, PA-ETYPE-INFO2, PA-PK-AS-REQ, PA-PK-AS-REP\_OLD\]                                                 
                                                                                                                                                                      
                            1.  Client sends FAST AS\_REQ                                                                                                             
                                                                                                                                                                      
                            > armor ticket: referral computer’s TGT                                                                                                   
                                                                                                                                                                      
                            1.  KDC return FAST AS\_REP                                                                                                               
                                                                                                                                                                      
                                1.  ticket: user’s TGT                                                                                                                
                                                                                                                                                                      
                            2.  Client send FAST TGS\_REQ                                                                                                             
                                                                                                                                                                      
                            3.  KDC returns FAST TGS\_REP                                                                                                             
                                                                                                                                                                      
                            4.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                                              
                                                                                                                                                                      
                            5.  AP returns AP session setup response (AP-REP wrapped in GSS formatting)                                                               |
| **Requirements covered** | isKile:                                                                                                                                  
                                                                                                                                                                      
                            1.  If the client does not have a TGT for the realm and is creating a:                                                                    
                                                                                                                                                                      
                                AS-REQ: the client SHOULD obtain a TGT for the computer principal from the user’s principal’s domain. (\[MS-KILE\] section 3.2.5.3);  |
| **Cleanup**              |                                                                                                                                          |

#### Resource in another domain

|                          |                                                                                                                                                                                                     |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Resource\_in\_another\_domain                                                                                                                                                                       |
| **Priority**             | P0 (BVT)                                                                                                                                                                                            |
| **Description **         |                                                                                                                                                                                                     |
| **Prerequisites**        | Join client computer to the “contoso.com” domain;                                                                                                                                                   
                                                                                                                                                                                                                                 
                            Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                    
                                                                                                                                                                                                                                 
                            Join AP to the “kerb.com” domain;                                                                                                                                                                    
                                                                                                                                                                                                                                 
                            Set Delegate=TRUE for client’s security context;                                                                                                                                                     
                                                                                                                                                                                                                                 
                            Set the service account as trusted for delegation.                                                                                                                                                   
                                                                                                                                                                                                                                 
                            Set attribute msDS-SupportedEncryptionTypes to 0x7001C for the krbtgt/contoso.com object in AD;                                                                                                      
                                                                                                                                                                                                                                 
                            Set attribute msDS-SupportedEncryptionTypes to 0x7001C for the krbtgt/kerb.com object in AD;                                                                                                         
                                                                                                                                                                                                                                 
                            Purge ticket cache on client computer;                                                                                                                                                               
                                                                                                                                                                                                                                 
                            Set registry key ClaimsCompIdFASTSupport to 2 on all the KDCs (don’t use group policy).                                                                                                              |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                         
                                                                                                                                                                                                                                 
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                  
                                                                                                                                                                                                                                 
                            3.  Client sends AS\_REQ for device to user’s domain                                                                                                                                                 
                                                                                                                                                                                                                                 
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                           
                                                                                                                                                                                                                                 
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                      
                                                                                                                                                                                                                                 
                            5.  Client sends AS\_REQ for device to user’s domain                                                                                                                                                 
                                                                                                                                                                                                                                 
                            6.  KDC return AS\_REP                                                                                                                                                                               
                                                                                                                                                                                                                                 
                                1.  ticket: computer’s TGT                                                                                                                                                                       
                                                                                                                                                                                                                                 
                            7.  Client sends FAST AS\_REQ for user                                                                                                                                                               
                                                                                                                                                                                                                                 
                            8.  KDC returns KRB\_ERROR                                                                                                                                                                           
                                                                                                                                                                                                                                 
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                     
                                                                                                                                                                                                                                 
                            9.  Client sends FAST AS\_REQ for user                                                                                                                                                               
                                                                                                                                                                                                                                 
                            10. KDC return FAST AS\_REP                                                                                                                                                                          
                                                                                                                                                                                                                                 
                                1.  ticket: user’s TGT                                                                                                                                                                           
                                                                                                                                                                                                                                 
                            11. Client sends AS\_REQ for device to resource’s domain                                                                                                                                             
                                                                                                                                                                                                                                 
                            12. KDC returns KRB\_ERROR                                                                                                                                                                           
                                                                                                                                                                                                                                 
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                      
                                                                                                                                                                                                                                 
                            13. Client sends AS\_REQ for device to resource’s domain                                                                                                                                             
                                                                                                                                                                                                                                 
                            14. KDC return AS\_REP                                                                                                                                                                               
                                                                                                                                                                                                                                 
                            > ticket: referral computer’s TGT                                                                                                                                                                    
                                                                                                                                                                                                                                 
                            1.  Client send FAST AS\_REQ for referral user TGT to resource’s domain                                                                                                                              
                                                                                                                                                                                                                                 
                            2.  KDC returns FAST AS\_REP                                                                                                                                                                         
                                                                                                                                                                                                                                 
                            > ticket: referral user TGT to resource’s domain (isKile1)                                                                                                                                           
                                                                                                                                                                                                                                 
                            1.  Client send FAST TGS\_REQ for service ticket to resource’s domain                                                                                                                                
                                                                                                                                                                                                                                 
                            > Armor field: no                                                                                                                                                                                    
                            >                                                                                                                                                                                                    
                            > Ticket in PA-TGS-REQ: referral user TGT (implicit armor)                                                                                                                                           
                                                                                                                                                                                                                                 
                            1.  KDC returns FAST TGS\_REP                                                                                                                                                                        
                                                                                                                                                                                                                                 
                            > ticket: service ticket                                                                                                                                                                             
                                                                                                                                                                                                                                 
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                                                                                                         
                                                                                                                                                                                                                                 
                            2.  File server returns SMB3 session setup response (AP-REP wrapped in GSS formatting)                                                                                                               |
| **Requirements covered** | isKile:                                                                                                                                                                                             
                                                                                                                                                                                                                                 
                            1.  If the client does not have a TGT for the realm and is creating a TGS-REQ, the client SHOULD obtain a referral TGT for the user principal for the target domain. (\[MS-KILE\] section 3.2.5.3);  |
| **Cleanup**              |                                                                                                                                                                                                     |

1.  ### Compound Identity

    1.  #### Resource in another domain

|                          |                                                                                                                                                                                                                                                           |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Resource\_in\_another\_domain                                                                                                                                                                                                                             |
| **Priority**             | P0 (BVT)                                                                                                                                                                                                                                                  |
| **Description **         |                                                                                                                                                                                                                                                           |
| **Prerequisites**        | Join client computer to the “contoso.com” domain;                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                       
                            Create &lt;username&gt; user account in the “contoso.com” domain;                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                       
                            Join AP to the “kerb.com” domain;                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                       
                            Set Delegate=TRUE for client’s security context;                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                       
                            Set the service account as trusted for delegation.                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                       
                            Set attribute msDS-SupportedEncryptionTypes to 0x7001C for the krbtgt/contoso.com object in AD;                                                                                                                                                            
                                                                                                                                                                                                                                                                                       
                            Set attribute msDS-SupportedEncryptionTypes to 0x7001C for the krbtgt/kerb.com object in AD;                                                                                                                                                               
                                                                                                                                                                                                                                                                                       
                            Purge ticket cache on client computer;                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                       
                            Set registry key ClaimsCompIdFASTSupport to 2 on all the KDCs (don’t use group policy).                                                                                                                                                                    |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                       
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                       
                            3.  Client sends AS\_REQ for device to user’s domain                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                       
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                       
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                       
                            5.  Client sends AS\_REQ for device to user’s domain                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                       
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                       
                                1.  ticket: computer’s TGT                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                       
                            7.  Client sends FAST AS\_REQ for user                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                       
                            8.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                       
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                       
                            9.  Client sends FAST AS\_REQ for user                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                       
                            10. KDC return FAST AS\_REP                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                       
                                1.  ticket: user’s TGT                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                       
                            11. Client sends AS\_REQ for device to resource’s domain                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                       
                            12. KDC returns KRB\_ERROR                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                       
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                       
                            13. Client sends AS\_REQ for device to resource’s domain                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                       
                            14. KDC return AS\_REP                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                       
                            > ticket: referral computer’s TGT (isKile1)                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                       
                            1.  Client send FAST AS\_REQ for referral user TGT to resource’s domain                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                       
                            2.  KDC returns FAST AS\_REP                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                       
                            > ticket: referral user TGT to resource’s domain (isKile1)                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                       
                            1.  enc-pa-data: PA-SUPPORTED-ENCTYPES (Compound Identity bit set) (isKile2)                                                                                                                                                                               
                                                                                                                                                                                                                                                                                       
                            <!-- -->                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                       
                            1.  Client send Compound Identity TGS\_REQ for service ticket to resource’s domain                                                                                                                                                                         
                                                                                                                                                                                                                                                                                       
                            > Armor ticket: referral computer TGT (explicit armor)                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                          
                            > Ticket in PA-TGS-REQ: referral user TGT                                                                                                                                                                                                                  
                            >                                                                                                                                                                                                                                                          
                            > With same key version numbers                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                       
                            1.  KDC returns FAST TGS\_REP                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                       
                            > ticket: service ticket                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                       
                            1.  Client sends AP session setup request (AP-REQ wrapped in GSS formatting)                                                                                                                                                                               
                                                                                                                                                                                                                                                                                       
                            2.  File server returns SMB3 session setup response (AP-REP wrapped in GSS formatting)                                                                                                                                                                     |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                       
                            1.  If the client does not have a TGT for the realm and is creating a Compound identity TGS-REQ, the client SHOULD obtain a user and computer principal TGT for the target domain with the same key version numbers. (\[MS-KILE\] section 3.2.5.3);        
                                                                                                                                                                                                                                                                                       
                            2.  If the application server’s realm TGT's PA-SUPPORTED-ENCTYPES Compound Identity bit is set, the Kerberos client SHOULD send a compound identity TGS-REQ by using FAST with explicit armoring, using the computer’s TGT. (\[MS-KILE\] section 3.2.5.6)  |
| **Cleanup**              |                                                                                                                                                                                                                                                           |

1.  KRB\_ERROR Test
    ---------------

    1.  ### KRB\_ERROR for AS\_REQ Test

        1.  #### KDC\_ERR\_C\_PRINCIPAL\_UNKNOWN

|                          |                                                                                                                                                                                                                                       |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_client\_principal\_unknown                                                                                                                                                                                                     |
| **Priority**             | P1                                                                                                                                                                                                                                    |
| **Description **         | This test case is designed to test KDC when it cannot find the requested principal in its database.                                                                                                                                   |
| **Prerequisites**        |                                                                                                                                                                                                                                       |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                   
                            > cname: use a principal name that does not exist in the KDC’s database                                                                                                                                                                
                                                                                                                                                                                                                                                                   
                            1.  KDC returns KDC\_ERR\_C\_PRINCIPAL\_UNKNOWN (isCommon1)                                                                                                                                                                            |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                   
                            1.  If the requested client principal named in the request is unknown because it doesn’t exist in the KDC’s principal database, then an error message with a KDC\_ERR\_C\_PRINCIPAL\_UNKNOWN is returned. (\[RFC4120\] section 3.1.3)  |
| **Cleanup**              |                                                                                                                                                                                                                                       |

#### KDC\_ERR\_PREAUTH\_REQUIRED

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                               |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_preauthentication\_required                                                                                                                                                                                                                                                                                                                                                                                            |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Description **         | This test case is designed to test KDC when pre-authentication is required.                                                                                                                                                                                                                                                                                                                                                   |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > padata: no pre-authentication data                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  KDC returns KDC\_ERR\_PREAUTH\_REQUIRED (isCommon1)                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > e-data:                                                                                                                                                                                                                                                                                                                                                                                                                      
                            >                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > padata\[\]: check existence (possibly, PA-ETYPE-INFO/PA-ETYPE-INFO2)                                                                                                                                                                                                                                                                                                                                                         |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  If pre-authentication is required, but was not present in the request, an error message with the code KDC\_ERR\_PREAUTH\_REQUIRED is returned, and a METHOD-DATA object will be stored in the e-data field of the KRB-ERROR message to specify which pre-authentication mechanisms are acceptable. Usually this will include PA-ETYPE-INFO and/or PA-ETYPE-INFO2 elements as described below. (\[RFC4120\] section 3.1.3)  
                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                If the KDC does not receive the required pre-authentication message in the AS exchange, an error MUST be returned to the client. The exact error depends on what pre-authentication types were supplied. (\[MS-KILE\] section 3.1.5.1)                                                                                                                                                                                     |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                               |

#### KDC\_ERR\_PREAUTH\_FAILED

|                          |                                                                                                                                                                                                                  |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_preauthentication\_failed                                                                                                                                                                                 |
| **Priority**             | P1                                                                                                                                                                                                               |
| **Description **         | This test case is designed to test KDC when pre-authentication is required and failed.                                                                                                                           |
| **Prerequisites**        |                                                                                                                                                                                                                  |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                         
                                                                                                                                                                                                                                              
                            > padata: no pre-authentication data                                                                                                                                                                              
                                                                                                                                                                                                                                              
                            1.  KDC returns KDC\_ERR\_PREAUTH\_REQUIRED (isCommon1)                                                                                                                                                           
                                                                                                                                                                                                                                              
                            > e-data:                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                 
                            > padata\[\]: PA-ENC-TIMESTAMP, PA-ETYPE-INFO/PA-ETYPE-INFO2                                                                                                                                                      
                                                                                                                                                                                                                                              
                            1.  Client sends AS\_REQ                                                                                                                                                                                          
                                                                                                                                                                                                                                              
                            > padata: PA-ENC-TIMESTAMP (encrypted in wrong password)                                                                                                                                                          
                                                                                                                                                                                                                                              
                            1.  KDC returns KDC\_ERR\_PREAUTH\_FAILED (isCommon1)                                                                                                                                                             |
| **Requirements covered** | isCommon:                                                                                                                                                                                                        
                                                                                                                                                                                                                                              
                            1.  If required to do so, the server pre-authenticates the request, and if the pre-authentication check fails, an error message with the code KDC\_ERR\_PREAUTH\_FAILED is returned. (\[RFC4120\] section 3.1.3)  |
| **Cleanup**              |                                                                                                                                                                                                                  |

#### KDC\_ERR\_ETYPE\_NOSUPP

|                          |                                                                                                                                                                                   |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_encryption\_type\_not\_supported                                                                                                                                           |
| **Priority**             | P1                                                                                                                                                                                |
| **Description **         | This test case is designed to test KDC when encryption type requested by the client is not supported by the KDC.                                                                  |
| **Prerequisites**        |                                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                          
                                                                                                                                                                                                               
                            > padata: no pre-authentication data                                                                                                                                               
                            >                                                                                                                                                                                  
                            > etype: a list of encryption types the KDC does not support                                                                                                                       
                                                                                                                                                                                                               
                            1.  KDC returns KDC\_ERR\_ETYPE\_NOSUPP (isCommon1)                                                                                                                                |
| **Requirements covered** | isCommon:                                                                                                                                                                         
                                                                                                                                                                                                               
                            1.  If the server cannot accommodate any encryption type requested by the client, an error message with the code KDC\_ERR\_ETYPE\_NOSUPP is returned. (\[RFC4120\] section 3.1.3)  |
| **Cleanup**              |                                                                                                                                                                                   |

1.  ### KRB\_ERROR for TGS\_REQ Test

2.  ### KRB\_ERROR for AP\_REQ Test

    1.  #### KRB\_AP\_ERR\_MSG\_TYPE

|                          |                                                                                                                                |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_Message\_Type                                                                                                           |
| **Priority**             | P1                                                                                                                             |
| **Description **         | This test case is designed to test the AP when it is receiving a Kerberos message that is not a KRB\_AP\_REQ type.             |
| **Prerequisites**        |                                                                                                                                |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to Application Server                                                                    
                                                                                                                                                            
                            2.  Application server returns AP Negotiate response (use Kerberos)                                                             
                                                                                                                                                            
                            3.  Client sends AS\_REQ                                                                                                        
                                                                                                                                                            
                            4.  KDC returns KRB\_ERROR                                                                                                      
                                                                                                                                                            
                            5.  Client sends AS\_REQ                                                                                                        
                                                                                                                                                            
                            6.  KDC return AS\_REP                                                                                                          
                                                                                                                                                            
                            7.  Client send TGS\_REQ                                                                                                        
                                                                                                                                                            
                            8.  KDC returns TGS\_REP                                                                                                        
                                                                                                                                                            
                            9.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                   
                                                                                                                                                            
                            > Don’t send KRB\_AP\_REQ message type in AP\_REQ message, send another type of message.                                        
                                                                                                                                                            
                            1.  Application server returns KRB\_AP\_ERR\_MSG\_TYPE (isCommon1)                                                              |
| **Requirements covered** | isCommon:                                                                                                                      
                                                                                                                                                            
                            1.  If the message type is not KRB\_AP\_REQ, the server returns the KRB\_AP\_ERR\_MSG\_TYPE error. (\[RFC4120\] section 3.2.3)  |
| **Cleanup**              |                                                                                                                                |

#### KRB\_AP\_ERR\_BADKEYVER

|                          |                                                                                                                                                                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_Bad \_Key\_Version                                                                                                                                                                                                                                              |
| **Priority**             | P1                                                                                                                                                                                                                                                                     |
| **Description **         | This test case is designed to test the AP when it cannot use the key with the key version number indicated by the ticket to decrypt this ticket in the KRB\_AP\_REQ.                                                                                                   |
| **Prerequisites**        |                                                                                                                                                                                                                                                                        |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to Application Server                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                    
                            2.  Application server returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                    
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                    
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                    
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                    
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                    
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                    
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                    
                            > ticket:                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                       
                            > enc-part:                                                                                                                                                                                                                                                             
                            >                                                                                                                                                                                                                                                                       
                            > kvno: record this kvno                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                    
                            1.  Change the Application server’s key and delete the old key with this kvno on the Application server. (this can be done by limiting the maximum keys that an application server can possess)                                                                         
                                                                                                                                                                                                                                                                                                    
                            2.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                    
                            > ticket:                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                       
                            > enc-part:                                                                                                                                                                                                                                                             
                            >                                                                                                                                                                                                                                                                       
                            > kvno: the same with the recorded kvno                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                    
                            1.  Application server returns KRB\_AP\_ERR\_BADKEYVER (isCommon1)                                                                                                                                                                                                      |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                    
                            1.  If the key version indicated by the Ticket in the KRB\_AP\_REQ is not one the server can use (e.g., it indicates an old key, and the server no longer possesses a copy of the old key), the KRB\_AP\_KRR\_BADKEYVER error is returned. (\[RFC4120\] section 3.2.3)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                        |

#### KRB\_AP\_ERR\_NOKEY

|                          |                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_No\_Key                                                                                                                                   |
| **Priority**             | P1                                                                                                                                               |
| **Description **         | This test case is designed to test the AP when it cannot decrypt the ticket in the KRB\_AP\_REQ.                                                 |
| **Prerequisites**        |                                                                                                                                                  |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to Application Server                                                                                      
                                                                                                                                                                              
                            2.  Application server returns AP Negotiate response (use Kerberos)                                                                               
                                                                                                                                                                              
                            3.  Client sends AS\_REQ                                                                                                                          
                                                                                                                                                                              
                            4.  KDC returns KRB\_ERROR                                                                                                                        
                                                                                                                                                                              
                            5.  Client sends AS\_REQ                                                                                                                          
                                                                                                                                                                              
                            6.  KDC return AS\_REP                                                                                                                            
                                                                                                                                                                              
                            7.  Client send TGS\_REQ                                                                                                                          
                                                                                                                                                                              
                            8.  KDC returns TGS\_REP                                                                                                                          
                                                                                                                                                                              
                            > ticket:                                                                                                                                         
                            >                                                                                                                                                 
                            > realm: record this srealm                                                                                                                       
                                                                                                                                                                              
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                     
                                                                                                                                                                              
                            > ticket:                                                                                                                                         
                            >                                                                                                                                                 
                            > realm: use a different realm name                                                                                                               
                                                                                                                                                                              
                            10. Application server returns KRB\_AP\_ERR\_NOKEY (isCommon1)                                                                                    |
| **Requirements covered** | isCommon:                                                                                                                                        
                                                                                                                                                                              
                            1.  The KRB\_AP\_ERR\_NOKEY error code is returned if the server doesn’t have the proper key to decipher the ticket. (\[RFC4120\] section 3.2.3)  |
| **Cleanup**              |                                                                                                                                                  |

#### KRB\_AP\_ERR\_BADINTEGRITY-ticket

|                          |                                                                                                                                                                                                                                                                                                             |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_Bad\_Integrity-ticket                                                                                                                                                                                                                                                                                |
| **Priority**             | P1                                                                                                                                                                                                                                                                                                          |
| **Description **         | This test case is designed to test the AP when it finds out that the ticket has been modified in the KRB\_AP\_REQ.                                                                                                                                                                                          |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                             |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to Application Server                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                         
                            2.  Application server returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                         
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                         
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                         
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                         
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                         
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                         
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                         
                            > ticket:                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                         
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                         
                            > ticket: make some changes to the ticket’s encryption part.                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                         
                            10. Application server returns KRB\_AP\_ERR\_BAD\_INTEGRITY (isCommon1)                                                                                                                                                                                                                                      |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                         
                            1.  If the decryption routines detect a modification of the ticket (each encryption system MUST provide safeguards to detect modified cipher text), the KRB\_AP\_ERR\_BAD\_INTEGRITY error is returned (chances are good that different keys were used to encrypt and decrypt). (\[RFC4120\] section 3.2.3)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                             |

#### KRB\_AP\_ERR\_BADINTEGRITY-authenticator

|                          |                                                                                                                                                                                                                              |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_Bad\_Integrity-authenticator                                                                                                                                                                                          |
| **Priority**             | P1                                                                                                                                                                                                                           |
| **Description **         | This test case is designed to test the AP when it finds out that the authenticator has been modified in the KRB\_AP\_REQ.                                                                                                    |
| **Prerequisites**        |                                                                                                                                                                                                                              |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to Application Server                                                                                                                                                                  
                                                                                                                                                                                                                                                          
                            2.  Application server returns AP Negotiate response (use Kerberos)                                                                                                                                                           
                                                                                                                                                                                                                                                          
                            3.  Client sends AS\_REQ                                                                                                                                                                                                      
                                                                                                                                                                                                                                                          
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                    
                                                                                                                                                                                                                                                          
                            5.  Client sends AS\_REQ                                                                                                                                                                                                      
                                                                                                                                                                                                                                                          
                            6.  KDC return AS\_REP                                                                                                                                                                                                        
                                                                                                                                                                                                                                                          
                            7.  Client send TGS\_REQ                                                                                                                                                                                                      
                                                                                                                                                                                                                                                          
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                      
                                                                                                                                                                                                                                                          
                            9.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                 
                                                                                                                                                                                                                                                          
                            > authenticator: make some changes to the athenticator’s encryption part.                                                                                                                                                     
                                                                                                                                                                                                                                                          
                            10. Application server returns KRB\_AP\_ERR\_BAD\_INTEGRITY (isCommon1)                                                                                                                                                       |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                          
                            1.  The authenticator is decrypted using the session key extracted from the decrypted ticket. If decryption shows that it has been modified, the KRB\_AP\_ERR\_BAD\_INTEGRITY error is returned. (\[RFC4120\] section 3.2.3)  |
| **Cleanup**              |                                                                                                                                                                                                                              |

#### KRB\_AP\_ERR\_BADMATCH

|                          |                                                                                                                                                                                                                                                                                |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_Bad\_Match                                                                                                                                                                                                                                                              |
| **Priority**             | P1                                                                                                                                                                                                                                                                             |
| **Description **         | This test case is designed to test the AP when it finds out that the name and realm of the client from the ticket are not the same with those from the authenticator in the KRB\_AP\_REQ.                                                                                      |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to Application Server                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                            
                            2.  Application server returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                            
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                            
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                            
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                            
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                            
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                            
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                            
                            9.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                            
                            > ticket: change crealm and cname in the encrypted part.                                                                                                                                                                                                                        
                            >                                                                                                                                                                                                                                                                               
                            > authenticator: change crealm and cname in the encrypted part.                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                            
                            1.  Application server returns KRB\_AP\_ERR\_BADMATCH (isCommon1)                                                                                                                                                                                                               |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                            
                            1.  The name and realm of the client from the ticket are compared against the same fields in the authenticator. If they don’t match, the KRB\_AP\_ERR\_BADMATCH error is returned; normally this is caused by a client error or an attempt attack. (\[RFC4120\] section 3.2.3)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                |

#### KRB\_AP\_ERR\_BADADDR – address not found

|                          |                                                                                                                                                                                                                                                                                                                   |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_Bad\_Address                                                                                                                                                                                                                                                                                               |
| **Priority**             | P1                                                                                                                                                                                                                                                                                                                |
| **Description **         | This test case is designed to test the AP when it finds out that the address provided in the ticket in the AP\_REQ could not be found.                                                                                                                                                                            |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to Application Server                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                               
                            2.  Application server returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                               
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                               
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                               
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                               
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                               
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                               
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                               
                            9.  Change client’s IP address.                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                               
                            10. Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                               
                            11. Application server returns KRB\_AP\_ERR\_BADADDR (isCommon1)                                                                                                                                                                                                                                                   |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                               
                            1.  The addresses in the ticket (if any) are then searched for an address matching the operating-system reported address of the client. If no match is found or the server insists on ticket address but none are present in the ticket, the KRB\_AP\_ERR\_BADADDR error is returned. (\[RFC4120\] section 3.2.3)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                   |

#### KRB\_AP\_ERR\_BADADDR – server insist address but none in ticket

|                          |                                                                                                                                                                                                                                                                                                                   |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_Bad\_Address                                                                                                                                                                                                                                                                                               |
| **Priority**             | P1                                                                                                                                                                                                                                                                                                                |
| **Description **         | This test case is designed to test the AP when it finds out that no addresses are provided in the ticket in the AP\_REQ when application server insists on ticket addresses.                                                                                                                                      |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to Application Server                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                               
                            2.  Application server returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                               
                            > Set application server to insist on client addresses.                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                               
                            1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                               
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                               
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                               
                            4.  KDC return AS\_REP                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                               
                            5.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                               
                            6.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                               
                            > ticket:                                                                                                                                                                                                                                                                                                          
                            >                                                                                                                                                                                                                                                                                                                  
                            > enc-part:                                                                                                                                                                                                                                                                                                        
                            >                                                                                                                                                                                                                                                                                                                  
                            > caddr: no caddr                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                               
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                               
                            2.  Application server returns KRB\_AP\_ERR\_BADADDR (isCommon1)                                                                                                                                                                                                                                                   |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                               
                            1.  The addresses in the ticket (if any) are then searched for an address matching the operating-system reported address of the client. If no match is found or the server insists on ticket address but none are present in the ticket, the KRB\_AP\_ERR\_BADADDR error is returned. (\[RFC4120\] section 3.2.3)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                   |

#### KRB\_AP\_ERR\_SKEW

|                          |                                                                                                                                                                                                                                                                               |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_Clock\_Skew                                                                                                                                                                                                                                                            |
| **Priority**             | P0                                                                                                                                                                                                                                                                            |
| **Description **         | This test case is designed to test the AP when it finds out that the local (server) time is out of the allowable time skew comparing to the client time represented in by the authenticator.                                                                                  |
| **Prerequisites**        | Need Client, KDC, Application Server synchronize time;                                                                                                                                                                                                                        |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to Application Server                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                           
                            2.  Application server returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                           
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                           
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                           
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                           
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                           
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                           
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                           
                            9.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                           
                            > authenticator:                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                              
                            > ctime: current time + MaxClockSkew + 1 or current time – MaxClockskew – 1                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                           
                            1.  Application server returns KRB\_AP\_ERR\_SKEW (isCommon1)                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                           
                            > e-data:                                                                                                                                                                                                                                                                      
                            >                                                                                                                                                                                                                                                                              
                            > data-type: KERB\_AP\_ERR\_TYPE\_SKEW\_RECOVERY                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                              
                            > data-value: NULL (isKile1)                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                           
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                           
                            > authenticator:                                                                                                                                                                                                                                                               
                            >                                                                                                                                                                                                                                                                              
                            > ctime: use the time in KRB-ERROR message                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                           
                            1.  Application Server returns AP\_REP                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                           
                            > Session setup success. (isKile1)                                                                                                                                                                                                                                             |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                           
                            1.  When the client receives a KRB\_AP\_ERR\_SKEW error with a KERB-ERROR-DATA structure in the e-data field of the KRB-ERROR message, the client SHOULD retry the AP-REQ using the time in the KRB-ERROR message to create the authenticator. (\[MS-KILE\] section 3.2.5.7);  
                                                                                                                                                                                                                                                                                                           
                                When clock skew errors occur during AP exchanges, the application server SHOULD attempt a clock skew recovery by returning a KRB\_AP\_ERR\_SKEW error containing a KERB-ERROR-DATA structure in the e-data field of the KRB-ERROR message. (\[MS-KILE\] section 3.4.5)     
                                                                                                                                                                                                                                                                                                           
                                isCommon:                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                           
                            <!-- -->                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                           
                            1.  If the local (server) time and the client time in the authenticator differ by more than the allowable clock skew (e.g., 5 minutes), the KRB\_AP\_ERR\_SKEW error is returned. (\[RFC4120\] section 3.2.3)                                                                  |
| **Cleanup**              |                                                                                                                                                                                                                                                                               |

#### KRB\_AP\_ERR\_REPEAT

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Error\_repeated\_authenticator                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Description **         | This test case is designed to test if AP supports replay cache.                                                                                                                                                                                                                                                                                                                                                                                               |
| **Prerequisites**        | Client local variable ReplayDetect enabled;                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to Application Server                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            2.  Application server returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            9.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > authenticator: record this authenticator                                                                                                                                                                                                                                                                                                                                                                                                                     
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > GSS\_C\_REPLAY\_FLAG                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  Application Server returns AP\_REP                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > Session setup success. (isCommon1)                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            > authenticator: send the same authenticator as step 9                                                                                                                                                                                                                                                                                                                                                                                                         
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                            > GSS\_C\_REPLAY\_FLAG                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  Application Server returns KRB\_AP\_ERR\_REPEAT (isCommon1)                                                                                                                                                                                                                                                                                                                                                                                                |
| **Requirements covered** | isCommon:                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                            1.  Unless the application server provides its own suitable means to protect against replay (for example, a challenge-response sequence initiated by the server after authentication, or use of a server-generated encryption subkey), the server MUST utilize a replay cache to remember any authenticator presented within the allowable clock skew… if a matching tuple is found, the KRB\_AP\_ERR\_REPEAT error is returned. (\[RFC4120\] section 3.2.3);  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                KILE MUST implement a replay cache regardless of the application server replay functionality. (\[MS-KILE\] section 3.1.1.1);                                                                                                                                                                                                                                                                                                                               |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                               |

#### KRB\_AP\_ERR\_MODIFIED

|                          |                                                                                                                                                                                 |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | KRB\_AP\_ERR\_MODIFIED                                                                                                                                                          |
| **Priority**             | P1                                                                                                                                                                              |
| **Description **         | This test case is designed to test the AP when it is receiving a service ticket for a computer's principal encrypted with DES.                                                  |
| **Prerequisites**        |                                                                                                                                                                                 |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to Application Server                                                                                                                     
                                                                                                                                                                                                             
                            2.  Application server returns AP Negotiate response (use Kerberos)                                                                                                              
                                                                                                                                                                                                             
                            3.  Client sends AS\_REQ                                                                                                                                                         
                                                                                                                                                                                                             
                            4.  KDC returns KRB\_ERROR                                                                                                                                                       
                                                                                                                                                                                                             
                            5.  Client sends AS\_REQ                                                                                                                                                         
                                                                                                                                                                                                             
                            6.  KDC return AS\_REP                                                                                                                                                           
                                                                                                                                                                                                             
                            7.  Client send TGS\_REQ                                                                                                                                                         
                                                                                                                                                                                                             
                            8.  KDC returns TGS\_REP                                                                                                                                                         
                                                                                                                                                                                                             
                            9.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                    
                                                                                                                                                                                                             
                            > Don’t send KRB\_AP\_REQ message type in AP\_REQ message, send another type of message.                                                                                         
                                                                                                                                                                                                             
                            1.  Application server returns KRB\_AP\_ERR\_MODIFIED (isKile1)                                                                                                                  |
| **Requirements covered** | isKile:                                                                                                                                                                         
                                                                                                                                                                                                             
                            > If the service ticket received for the computer's principal is encrypted with DES, the KILE server MUST return KRB\_AP\_ERR\_MODIFIED regardless of supporting DES.&lt;74&gt;  |
| **Cleanup**              |                                                                                                                                                                                 |

1.  KKDCP Test
    ----------

    1.  ### Negative

        1.  #### Target domain not present

|                          |                                                                                                                                                                                                                                                                        |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Target\_Domain\_not\_present                                                                                                                                                                                                                                           |
| **Priority**             | P1                                                                                                                                                                                                                                                                     |
| **Description **         | This test case is designed to test KPS when Target Domain is not present.                                                                                                                                                                                              |
| **Prerequisites**        |                                                                                                                                                                                                                                                                        |
| **Test Execution Steps** | 1. Client sends AS\_REQ using KKDCPClient                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                    
                            TargetDomain = null                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                    
                            2. KKDCPError.STATUS\_NO\_LOGON\_SERVERS returned(isKKDCP1)                                                                                                                                                                                                             |
| **Requirements covered** | isKKDCP:                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                    
                            1.  If target-domain is not present, return ERROR\_BAD\_FORMAT. Validate that the **KDC\_PROXY\_MESSAGE.kerb-message** is a well-formed Kerberos message. If not, then the KKDCP server SHOULD drop the connection and stop processing. (\[MS-KKDCP\] section 3.2.5.1)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                        |

#### Target domain not valid

|                          |                                                                                                                                                                                                                                                                     |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Target\_Domain\_not\_valid                                                                                                                                                                                                                                          |
| **Priority**             | P1                                                                                                                                                                                                                                                                  |
| **Description **         | This test case is designed to test KPS when Target Domain is not valid.                                                                                                                                                                                             |
| **Prerequisites**        |                                                                                                                                                                                                                                                                     |
| **Test Execution Steps** | 1. Client sends AS\_REQ using KKDCPClient                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                 
                            TargetDomain = InvalidDomain                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                 
                            2. KKDCPError.STATUS\_NO\_LOGON\_SERVERS returned(isKKDCP1)                                                                                                                                                                                                          |
| **Requirements covered** | isKKDCP:                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                 
                            1.  Before the KKDCP server can send a Kerberos message, it MUST discover the KDC to which the message will be sent. The KKDCP server SHOULD perform the equivalent of calling DsrGetDcNameEx2 where *DomainName* is *TargetDomain*. (\[MS-KKDCP\] section 3.2.5.1)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                     |

1.  ### Kpassword

    1.  #### ChangePasswordSuccess

|                          |                                                                                    |
|--------------------------|------------------------------------------------------------------------------------|
| **Test ID**              | Change\_Password\_Success                                                          |
| **Priority**             | P1                                                                                 |
| **Description **         | This test case is designed to verify Kpassword when the password change succeeds.  |
| **Prerequisites**        | 1. Set up KKDCP server                                                             
                                                                                                                
                            2. Set UseProxy=true in ptfconfig file                                              
                                                                                                                
                            3. Set password group policy MinimumPasswordAge=0                                   
                                                                                                                
                            4. Set password group policy PasswordHistorySize=0                                  |
| **Test Execution Steps** | 1. Client sends Kpassword Request                                                  
                                                                                                                
                            port:464                                                                            
                                                                                                                
                            sname: kadmin/changepw                                                              
                                                                                                                
                            version: 0x0001                                                                     
                                                                                                                
                            2. KKDCP returns Kpassword Response with the Result Code as KRB5\_KPASSWD\_SUCCESS  |
| **Requirements covered** | \[RFC-3244\] section 2                                                             |
| **Cleanup**              |                                                                                    |

#### ChangePasswordError

|                          |                                                                                                                |
|--------------------------|----------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Change\_Password\_Error                                                                                        |
| **Priority**             | P1                                                                                                             |
| **Description **         | This test case is designed to verify Kpassword when the password change fails.                                 |
| **Prerequisites**        | 1. Set up KKDCP server                                                                                         
                                                                                                                                            
                            2. Set UseProxy=true in ptfconfig file                                                                          
                                                                                                                                            
                            3. Set password group policy MinimumPasswordAge=0                                                               
                                                                                                                                            
                            4. Set password group policy PasswordHistorySize=0                                                              |
| **Test Execution Steps** | 1. Client sends Kpassword Request with new password to be “123” which doesn’t meet the complexity requirements 
                                                                                                                                            
                            port:464                                                                                                        
                                                                                                                                            
                            sname: kadmin/changepw                                                                                          
                                                                                                                                            
                            version: 0x0001                                                                                                 
                                                                                                                                            
                            2. KKDCP returns Kpassword Response with the Result Code as KRB5\_KPASSWD\_SOFTERROR                            
                                                                                                                                            
                            3. Client sends malformed Kpassword Request with protocol version to be 0xff80                                  
                                                                                                                                            
                            port:464                                                                                                        
                                                                                                                                            
                            sname: kadmin/changepw                                                                                          
                                                                                                                                            
                            version: 0xff80                                                                                                 
                                                                                                                                            
                            4. KKDCP returns Kpassword Response with the Result Code as KRB5\_KPASSWD\_MALFORMED                            
                                                                                                                                            
                            5. Client sends Kpassword Request with KRB\_PRIV encrypted wrongly                                              
                                                                                                                                            
                            port:464                                                                                                        
                                                                                                                                            
                            sname: kadmin/changepw                                                                                          
                                                                                                                                            
                            version: 0x0001                                                                                                 
                                                                                                                                            
                            6. KKDCP returns Kpassword Response with the Result Code as KRB5\_KPASSWD\_AUTHERROR                            
                                                                                                                                            
                            7. Client sends Kpassword Request with user who has no access to change the password                            
                                                                                                                                            
                            port:464                                                                                                        
                                                                                                                                            
                            sname: kadmin/changepw                                                                                          
                                                                                                                                            
                            version: 0x0001                                                                                                 
                                                                                                                                            
                            8. KKDCP returns Kpassword Response with the Result Code as KRB5\_KPASSWD\_ACCESSDENIED                         |
| **Requirements covered** | \[RFC-3244\] section 2                                                                                         |
| **Cleanup**              |                                                                                                                |

1.  Change Network Topology
    -----------------------

    1.  ### RODC

        1.  #### Key Version Number for RODC

|                          |                                                                                                                                                                                                                                                    |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Key\_Version\_Number\_RODC                                                                                                                                                                                                                         |
| **Priority**             | P2                                                                                                                                                                                                                                                 |
| **Description **         | This test case is designed to test if key version numbers are supported for RODCs.                                                                                                                                                                 |
| **Prerequisites**        | Setup 2 RODC in one domain;                                                                                                                                                                                                                        |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for user TGT (no pre-authentication)                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                
                            > error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                   
                            > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                
                            1.  Client sends AS\_REQ for user TGT (RODC 1)                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                
                            2.  KDC returns AS\_REP                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                
                                1.  ticket: user’s TGT                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                
                                    > key: session key                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                
                                    > kvno: kvno1 (isKile1)                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                
                            3.  Client sends AS\_REQ for user TGT (RODC 2)                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                
                                1.  ticket: user’s TGT                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                
                                    > key: session key                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                
                            5.  kvno: kvno2 (isKile1)                                                                                                                                                                                                                           |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                
                            1.  KILE supports key version numbers for RODC. Each RODC will have a different key version number. This allows the domain controller to distinguish between keys that are issued to different RODCs.                                               
                                                                                                                                                                                                                                                                                
                                The kvno consists of 32 bits. The first 16 bits, including the most significant bit, are an unsigned 16-bit number which SHOULD identify the RODC. The remaning 16 bits SHOULD be the version number of the key. (\[MS-KILE\] section 3.1.5.8)  |
| **Cleanup**              |                                                                                                                                                                                                                                                    |

#### Branch Aware and Forward to Full DC

|                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Branch\_Aware\_and\_Forward\_to\_Full\_DC                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Priority**             | P2                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Description **         | This test case is designed to verify if the KDC supports Branch Aware.                                                                                                                                                                                                                                                                                                                                                                          |
| **Prerequisites**        |                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Test Execution Steps** | 1.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            4.  KDC returns AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            5.  Client sends TGS\_REQ to a RODC                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > pa-data: PA-PAC-OPTIONS (branch aware) (isKile1)                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > error-code: KDC\_ERR\_S\_PRINCIPAL\_UNKNOWN (7)                                                                                                                                                                                                                                                                                                                                                                                                
                            >                                                                                                                                                                                                                                                                                                                                                                                                                                                
                            > substatus: NTSTATUS\_STATUS\_NO\_SECRETS (isKile2)                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  Client sends AS\_REQ to a RODC                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > pa-data: PA-PAC-OPTIONS (forward to full DC) (isKile1)                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  RODC forward the AS\_REQ to a Full DC                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  KDC (RODC) returns AS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > ticket: user TGT (check existence) (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  Client sends TGS\_REQ to Full DC                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            > ticket: service ticket (isKile1)                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            1.  The Kerberos client SHOULD add a PA-PAC-OPTIONS \[167\] PA-DATA type with the Branch Aware bit set to the TGS REQ. If a server principal unknown with a substatus of NTSTATUS STATUS\_NO\_SECRETS message is returned, the client SHOULD send an AS-REQ adding a PA-PAC-OPTIONS PA-DATA type, with the Forward to Full DC bit set, to a full DC, and then send a new TGS\_REQ using this TGT to the full DC. (\[MS-KILE\] section 3.2.5.6);  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                            2.  When a Key Distribution Center (KDC) which is a read-only domain controller (RODC) receives:                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                An AS-REQ message with a PA-PAC-OPTIONS PA-DATA type with the forward to full DC bit set, the RODC SHOULD forward the AS-REQ to a full DC.                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                A TGS-REQ message with a PA-PAC-OPTIONS PA-DATA type with the Branch Aware bit set, and the application server (SNAME) is not in its database, the RODC SHOULD return server principal unknown with the substatus message of NTSTATUS STATUS\_NO\_SECRETS. (\[MS-KILE\] section 3.3.5.4.7);                                                                                                                                                  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                                                                                                                                                                 |

1.  ### Proxy

    1.  #### Proxy

|                          |                                                                                                                                                                           |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Proxy                                                                                                                                                                     |
| **Priority**             | P2                                                                                                                                                                        |
| **Description **         | This test case is designed to verify if the system supports proxy;                                                                                                        |
| **Prerequisites**        | Setup 1 KDC in “contoso.com” but client could not reach;                                                                                                                  
                                                                                                                                                                                                       
                            Setup 1 proxy computer that client can reach;                                                                                                                              
                                                                                                                                                                                                       
                            Create a &lt;username&gt; user account in the “contoso.com” domain;                                                                                                        |
| **Test Execution Steps** | 1.  Client sends AS\_REQ for user TGT (no pre-authentication) using ProxyMessage()                                                                                        
                                                                                                                                                                                                       
                            2.  KDC returns KRB\_ERROR using ProxyMessage()                                                                                                                            
                                                                                                                                                                                                       
                            > error-code: KDC\_ERR\_PREAUTH\_REQUIRED                                                                                                                                  
                            >                                                                                                                                                                          
                            > e-data: PA-ENC-TIMESTAMP                                                                                                                                                 
                                                                                                                                                                                                       
                            1.  Client sends AS\_REQ for user TGT using ProxyMessage()                                                                                                                 
                                                                                                                                                                                                       
                                1.  padata: PA-ENC-TIMESTAMP                                                                                                                                           
                                                                                                                                                                                                       
                            2.  KDC returns AS\_REP using ProxyMessage()                                                                                                                               
                                                                                                                                                                                                       
                                1.  ticket: user’s TGT                                                                                                                                                 
                                                                                                                                                                                                       
                            3.  Client sends TGS\_REQ for service ticket using ProxyMessage()                                                                                                          
                                                                                                                                                                                                       
                            4.  KDC returns TGS\_REP using ProxyMessage()                                                                                                                              |
| **Requirements covered** | isKile:                                                                                                                                                                   
                                                                                                                                                                                                       
                            1.  If the Kerberos client does not have network access to the KDC and KKDCP is supported, the Kerberos client SHOULD call ProxyMessage(). (\[MS-KILE\] section 3.2.5.1);  |
| **Cleanup**              |                                                                                                                                                                           |

1.  ### Pre Win8 KDC

    1.  ##### KDC does not support Claims

|                          |                                                                                                                                                                                                           |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | NetworkLogon\_Claims\_KDCNotSuppClaims                                                                                                                                                                    |
| **Priority**             | P2                                                                                                                                                                                                        |
| **Description **         |                                                                                                                                                                                                           |
| **Prerequisites**        | Setup 2 KDCs in one domain, 1 Win8, 1 pre Win8, let client talk to the preWin8 first;                                                                                                                     
                                                                                                                                                                                                                                       
                            Set registry key ClaimsCompIdFASTSupport = 1 on the KDC (don’t use group policy).                                                                                                                          |
| **Test Execution Steps** | 1.  Client sends SMB3 Negotiate request to application server                                                                                                                                             
                                                                                                                                                                                                                                       
                            2.  Application server returns SMB3 Negotiate response (use Kerberos)                                                                                                                                      
                                                                                                                                                                                                                                       
                            3.  Client sends AS\_REQ                                                                                                                                                                                   
                                                                                                                                                                                                                                       
                                1.  padata: PA-PAC-REQUEST, PA-PAC-OPTIONS (claims)                                                                                                                                                    
                                                                                                                                                                                                                                       
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                 
                                                                                                                                                                                                                                       
                                1.  error-code: KDC\_ERR\_PREAUTH\_REQUIRED;                                                                                                                                                           
                                                                                                                                                                                                                                       
                                    > e-data: PA-ENC-TIMESTAMP                                                                                                                                                                         
                                                                                                                                                                                                                                       
                            5.  Client sends AS\_REQ                                                                                                                                                                                   
                                                                                                                                                                                                                                       
                                1.  padata: PA-ENC-TIMESTAMP, PA-PAC-REQUEST, PA-PAC-OPTIONS (claims)                                                                                                                                  
                                                                                                                                                                                                                                       
                            6.  KDC return AS\_REP                                                                                                                                                                                     
                                                                                                                                                                                                                                       
                            > padata: PA-PAC-OPTIONS (claims not set) (isKile1)                                                                                                                                                        
                                                                                                                                                                                                                                       
                            1.  enc-padata: PA-SUPPORTED-ENCTYPES (claims set) (isKile1)                                                                                                                                               
                                                                                                                                                                                                                                       
                            <!-- -->                                                                                                                                                                                                   
                                                                                                                                                                                                                                       
                            1.  Client should locate a Win8 KDC                                                                                                                                                                        
                                                                                                                                                                                                                                       
                            2.  Client sends AS\_REQ                                                                                                                                                                                   
                                                                                                                                                                                                                                       
                                1.  padata: PA-ENC-TIMESTAMP, PA-PAC-REQUEST, PA-PAC-OPTIONS (claims)                                                                                                                                  
                                                                                                                                                                                                                                       
                            3.  KDC rturn AS\_REP                                                                                                                                                                                      
                                                                                                                                                                                                                                       
                            > padata: PA-PAC-OPTIONS (claims set) (isKile1)                                                                                                                                                            
                                                                                                                                                                                                                                       
                            1.  ticket: user’s TGT                                                                                                                                                                                     
                                                                                                                                                                                                                                       
                                > authorization-data: PAC\_CLIENT\_CLAIMS\_INFO(isKile1)                                                                                                                                               
                                                                                                                                                                                                                                       
                            <!-- -->                                                                                                                                                                                                   
                                                                                                                                                                                                                                       
                            1.  enc-padata: PA-SUPPORTED-ENCTYPES (claims set) (isKile1)                                                                                                                                               |
| **Requirements covered** | isKile:                                                                                                                                                                                                   
                                                                                                                                                                                                                                       
                            1.  The client will always include a PAC request Padata type when generating an AS-REQ message.                                                                                                            
                                                                                                                                                                                                                                       
                            -   When sending the AS REQ, add a PA-PAC-OPTIONS \[167\] PADATA type with the Claims bit set in the AS REQ to request claims authorization data                                                           
                                                                                                                                                                                                                                       
                            -   When receiving the AS\_REP, if the Claims bit is set in PA-SUPPORTED-ENCTYPES \[165\], and not set in PA-PAC-OPTIONS \[167\], the client SHOULD locate a DS\_BEHAVIOR\_WIN8 DC and go back to step 1.  
                                                                                                                                                                                                                                       
                            > (\[MS-KILE\] section 3.2.5.4)                                                                                                                                                                            |
| **Cleanup**              |                                                                                                                                                                                                           |

##### Single Realm use RC4

|                          |                                                                                                                                                                                                                                                                                |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Single Realm use RC4                                                                                                                                                                                                                                                           |
| **Priority**             | P2                                                                                                                                                                                                                                                                             |
| **Description **         |                                                                                                                                                                                                                                                                                |
| **Prerequisites**        | Set domainControllerFunctionality &lt; 3.                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                            
                            Do not set ms-SupportedEncryptionTypes for the server or service’s account in AD;                                                                                                                                                                                               |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to application server                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                            
                            2.  Application server returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                            
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                            
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                            
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                            
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                            
                            > enc-padata: PA-SUPPORTED-ENCTYPES (165) = 0x7 (isKile1)                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                            
                            1.  Client send TGS\_REQ                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                            
                            2.  KDC returns TGS\_REP                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                            
                            3.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                            
                            4.  File server returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                           |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                            
                            1.  (If UseDESOnly flag is not set):                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                            
                                If domainControllerFunctionality returns a value &lt; 3: the KDC SHOULD, in the encrypted pa-auth data part of the AS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), and the padata-value set to 0x7. (\[MS-KILE\] section 3.3.5.3)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                |

##### Cross Realm use RC4

|                          |                                                                                                                                                                                                                                                                                                         |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Test ID**              | Target\_Realm\_use\_RC4                                                                                                                                                                                                                                                                                 |
| **Priority**             | P0                                                                                                                                                                                                                                                                                                      |
| **Description **         | This test case is designed to verify if the KDC supports RC4 encryption for servers or services.                                                                                                                                                                                                        |
| **Prerequisites**        | Do not set attribute msDS-SupportedEncryptionTypes for the krbtgt/&lt;targetrealm&gt; object in AD;                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                     
                            Set domainControllerFunctionality &lt; 3;                                                                                                                                                                                                                                                                |
| **Test Execution Steps** | 1.  Client sends AP Negotiate request to AP                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                     
                            2.  AP returns AP Negotiate response (use Kerberos)                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                     
                            3.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                     
                            4.  KDC returns KRB\_ERROR                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                     
                            5.  Client sends AS\_REQ                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                     
                            6.  KDC return AS\_REP                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                     
                            7.  Client send TGS\_REQ                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                     
                            8.  KDC returns TGS\_REP                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                     
                            > ticket: referral ticket                                                                                                                                                                                                                                                                                
                            >                                                                                                                                                                                                                                                                                                        
                            > sname: krbtgt/&lt;target realm&gt; (isKile1)                                                                                                                                                                                                                                                           
                            >                                                                                                                                                                                                                                                                                                        
                            > enc-pa-data: PA-SUPPORTED-ENCTYPES (165)=0x7 (isKile1)                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                     
                            1.  Client send referral TGS\_REQ                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                     
                            2.  KDC returns referral TGS\_REP                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                     
                            3.  Client sends AP session setup request (AP\_REQ wrapped in GSS formatting)                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                     
                            4.  AP returns AP session setup response (AP\_REP wrapped in GSS formatting)                                                                                                                                                                                                                             |
| **Requirements covered** | isKile:                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                     
                            1.  Otherwise:                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                     
                                If the account is krbtgt, and domainControllerFunctionality returns a value &lt; 3: the KDC SHOULD, in the encrypted pre-auth data part of the TGS-REP message, include PA-DATA with the padata-type set to PA-SUPPORTED-ENCTYPES (165), the padata-value set to 0x7. (\[MS-KILE\] section 3.3.5.4)  |
| **Cleanup**              |                                                                                                                                                                                                                                                                                                         |

1.  ### <span id="_Toc427329253" class="anchor"><span id="OLE_LINK7" class="anchor"><span id="OLE_LINK8" class="anchor"></span></span></span>AZOD\_Synthetic\_Test 

    1.  #### <span id="OLE_LINK9" class="anchor"><span id="OLE_LINK10" class="anchor"></span></span>DAC\_Smb2\_Possitive\_AccessFile 

|                               |
|-------------------------------|
| **S9\_AZOD\_Synthetic\_Test** |
| **Test ID**                   |
| **Priority**                  |
| **Description **              |
| **Prerequisites**             |
| **Test Execution Steps**      |
| **Requirements covered**      |
| **Cleanup**                   |

#### DAC\_Smb2\_Negative\_AccessFile

|                               |
|-------------------------------|
| **S9\_AZOD\_Synthetic\_Test** |
| **Test ID**                   |
| **Priority**                  |
| **Description **              |
| **Prerequisites**             |
| **Test Execution Steps**      |
| **Requirements covered**      |
| **Cleanup**                   |

#### CBAC\_Smb2\_Possitive\_AccessFile

|                               |
|-------------------------------|
| **S9\_AZOD\_Synthetic\_Test** |
| **Test ID**                   |
| **Priority**                  |
| **Description **              |
| **Prerequisites**             |
| **Test Execution Steps**      |
| **Requirements covered**      |
| **Cleanup**                   |

#### CBAC\_Smb2\_Negative\_AccessFile

|                               |
|-------------------------------|
| **S9\_AZOD\_Synthetic\_Test** |
| **Test ID**                   |
| **Priority**                  |
| **Description **              |
| **Prerequisites**             |
| **Test Execution Steps**      |
| **Requirements covered**      |
| **Cleanup**                   |

#### <span id="OLE_LINK20" class="anchor"><span id="OLE_LINK21" class="anchor"></span></span>CrossRealm\_Smb2\_Possitive\_AccessFile 

|                               |
|-------------------------------|
| **S9\_AZOD\_Synthetic\_Test** |
| **Test ID**                   |
| **Priority**                  |
| **Description **              |
| **Prerequisites**             |
| **Test Execution Steps**      |
| **Requirements covered**      |
| **Cleanup**                   |

#### CrossRealm\_Smb2\_Negative\_AccessFile 

|                               |
|-------------------------------|
| **S9\_AZOD\_Synthetic\_Test** |
| **Test ID**                   |
| **Priority**                  |
| **Description **              |
| **Prerequisites**             |
| **Test Execution Steps**      |
| **Requirements covered**      |
| **Cleanup**                   |

MIT KDC interests
-----------------
